<!DOCTYPE html>
<html>

<head>
	<title>sudedu - u≈æduotys</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
	<link rel="icon" href="../images/favicon.ico" type="image/x-icon">
	<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Andika:wght@400;700&family=Josefin+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
	<link rel="stylesheet" type="text/css" href="../summary.css">
    <link rel="stylesheet" type="text/css" href="../index.css">
    <link rel="stylesheet" href="../main-nav-bar.css">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-96Q83PW8XY"></script>
    <script>
    //window.dataLayer = window.dataLayer || [];
    //function gtag(){dataLayer.push(arguments);}
    //gtag('js', new Date());

    //gtag('config', 'G-96Q83PW8XY');
    </script>
    <script src="../refresh-token.js"></script>

    <style>
        * {
            box-sizing: border-box;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        html {
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: linear-gradient(to top, #ffbf9c, #ffbf92, #ffbf89, #ffbf7e, #ffc074);
            width: 100vw;
            height: 100svh;
            overflow: hidden;
            user-select: none;         /* Standard */
            -webkit-user-select: none; /* Chrome, Safari, Edge */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE/older Edge */
        }

        body {
            margin: 0;
            font-family: 'SFpro', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(6px);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(6px);
            border-radius: 10px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            background-clip: content-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.6);
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.4) transparent;
        }

        body {
            display: flex;
            flex-direction: column;
            padding: 0;
            height: 100svh;
            width: 100vw;
        }

        .row {
            width: 100%;
            min-width: 100%;
            --bs-gutter-x: 0; 
        }

        #template-container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            max-width: none;
            display: flex;
            align-items: start;
            justify-content: center;
        }
        
        #content-container {
            flex: 1;
            max-height: calc(100% - 80px - 16px - 16px);
            min-height: calc(100% - 80px - 16px - 16px);
            width: calc(100% - (2 * 16px));
            display: flex;
            justify-content: start;
            background: rgba(255, 255, 255, 0.08);
            margin: 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.1);
        }

        .task-info-holder > :not(:empty),
        .task-info-holder-student > :not(:empty) {
        margin-top: 5px;
        }

        #inner-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #teacher-gui {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
            flex-direction: row;
        }

        .left-side-bar {
            height: 100%;
            padding: 15px;
            flex: 1 1 35%;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.15);
            border-top-left-radius: 20px;
            border-bottom-left-radius: 20px;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        #dynamic-teacher-content {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .initial-button-div {
            min-width: 250px;
            margin-bottom: 15px;
        }

        .teacher-button {
            width: 100%;
        }

        #timer-input-div,
        #question-number-input-div {
            margin-top: 10px;
        }

        .teacher-button:disabled {
            background-color: #40c9a9;
            border-color: #40c9a9;
            color: black;
            filter: grayscale(25%);
        }

        .confirmation-button-div {
            min-width: 150px;
            margin: 0 0 15px 15px;
        }

        #confirm-delete-task-button,
        #confirm-delete-student-button {
            width: 100%;
        }

        #teacher-message-line-2 {
            text-align: center;
            margin: 15px 0;
            min-height: 48px;
        }
        
        #teacher-message-line,
        #teacher-data-retrieval-message,
        #student-message {
            text-align: center;
            margin-right: 4vw;
        }

        #task-group-sorting {
            width: 100%;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            color: #212529;
            padding: 12px 16px;
            transition: all 0.3s ease;
            box-shadow: none;
            text-align: center;
        }
        
        .left-side-bar-inner {
            height: 100%;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        #student-details-for-teachers {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        #outer-student-list-container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 20px;
            overflow: hidden;
            flex: 1 0 60svh;
            display: flex;
            flex-direction: column;
        }

        #student-list-header {
            background: rgba(255, 255, 255, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding: 15px;
            display: flex;
            justify-content: space-between;
        }

        #student-list-header-checkbox-container,
        #student-list-title-container {
            padding: 10px 0 10px 0;
            font-weight: bold;
            text-transform: uppercase;
        }

        #student-list-title-container {
            margin-left: 10px;
        }

        #select-all-checkbox {
            margin-right: 10px;
        }

        #student-list-container {
            overflow: auto;
            flex: 1;
        }

        #student-list {
            background: transparent;
            padding: 15px 15px 20px 15px;
        }

        .student-checkbox,
        .task-checkbox {
            margin-right: 10px;
        }

        #student-list ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .outer-student-list-entry-item {
            display: flex;
            flex-direction: column;
            align-items: start;
            justify-content: center;
        }

        .student-li-item {
            display: flex;
            align-items: center;
            justify-content: start;
            font-weight: bold;
            text-transform: uppercase;
        }

        .task-li-item {
            margin-left: 20px;
            display: flex;
            align-items: center;
            justify-content: start;
        }

        .student-li-item,
        .task-container {
            width: 100%;
        }

        .task-li-item {
            width: calc(100% - 20px);
        }

        .student-li-item .selection-option {
            width: 80%;
            transition: box-shadow 0.3s ease; /* Smooth transition for highlighting */
        }

        .task-li-item .selection-option {
            width: calc(80% - 5px);
            transition: box-shadow 0.3s ease; /* Smooth transition for highlighting */
            white-space: normal;
            overflow-wrap: break-word;
        }

        #student-task-list-container .task-li-item .selection-option {
            width: calc(100% - 15px);
        }

        .selected-option {
            background: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.5); /* Adds a glow effect around the selected element */
        }

        #student-list li { 
            padding: 10px 0 0 0; 
        }

        #new-task-options-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            max-width: 500px;
            flex: 1;
            justify-content: center;
        }

        #group_name,
        #mode_choice,
        #mode_choice_1,
        #mode_choice_2,
        #mode_choice_3,
        #mode_choice_4,
        #mode_choice_5,
        #mode_choice_6,
        #mode_choice_7,
        #mode_choice_8,
        #mode_choice_9,
        #mode_choice_10,
        #mode_choice_13,
        #mode_choice_14,
        #mode_choice_15,
        #class_choice {
            width: 100%;
            box-sizing: border-box;
            text-align: center;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            font-size: 1.3rem;
            padding: 7px;
            margin: 10px 0;
        }

        #mode_choice_11_div {
            box-sizing: border-box;
        }

        #mode_choice_12 {
            width: auto;
        }

        .remainder-div {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #remainder-option {
            font-weight: 600;
        }

        .selected_numbers_inner_div {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .number-choice-label-iki,
        .number-choice-label-nuo {
            font-weight: 600;
            font-size: 1.75rem;
        }

        .timer-question-number-div,
        .timer-input-div,
        .question-number-input-div {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #timer-input,
        #question-number-input {
            padding: 0.5rem;
            font-size: 1.3rem;
            width: 55px;
            border: 0;
            margin: 0;
            outline: none;
            border-radius: 20px;
            background: transparent;
            text-align: center;
        }

        #timer-input:focus,
        #question-number-input:focus,
        #timer-input:active,
        #question-number-input:active {
            border: 0;
            margin: 0;
            outline: none;
        }

        .timer-choice-label,
        .answer-number-label {
            font-size: 1.75rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 0;
            width: 130px;
        }

        #new-task-options-container > * {
            width: 100%;;
        }

        #text-distractor {
            margin-bottom: 15px;
        }

        .new-task-input-holder {
            width: 100%;
        }

        #group_name {
            border: 0;
            outline: 0;
            font-size: 1.3rem;
            text-align: start;
            padding-left: 15px;
        }

        #group_name:focus,
        #group_name:active,
        #group_name:hover {
            border: 0;
            outline: none;
        }

        .modeChoice4_div {
            width: 100%;
            padding: 0;
        }
        
        .empty-placeholder-between-options {
            padding: 0;
            width: 100%;
        }

        .timer-choice-label,
        .answer-number-label {
            margin-left: 10px;
        }

        #student-task-info-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex: 1;
            min-width: 0;
        }

        #student-task-info-container-inner {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            min-width: 0;
        }

        .summary-inner-container:not(:empty) {
            margin-top: 10px;
            margin-bottom: 10px;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 20px;
        }

        table {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
            border-color: rgba(255, 255, 255, 0.2);
            overflow: hidden;
            margin: 0 !important;
            table-layout: fixed;
            border-radius: 20px;
        }

        th,
        td {
            padding: 5px 5px 5px 5px;
            background-color: rgba(255, 255, 255, 0.2);
            font-size: 1rem;
        }

        th:first-child, th:nth-child(2) {
            text-align: center;
        }

        td:first-child, td:nth-child(2) {
            text-align: center;
        }

        tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        tbody td:hover:before {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            top: -9999px;
            bottom: -9999px;
            background-color: rgba(255, 255, 255, 0.2);
            z-index: 2;
        }

        tbody td {
            position: relative;
        }

        .bar {
            height: 20px;
            border-radius: 8px;
            max-width: 100%;
        }

        #student-task-student-name {
            font-weight: 800;
            text-transform: uppercase;
            font-size: 1.5rem;
            margin-bottom: 0;
            display: flex;
            align-items: center;
        }
        
        #student-task-group-and-status-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        #frequent-mistakes-container {
            display: none;
        }

        #frequent-mistakes-container .clickable-word {
            cursor: default;
        }

        #frequent-mistakes-container .clickable-word:hover,
        #frequent-mistakes-container .clickable-word:active {
            text-decoration: none;
        }

        #student-task-group,
        #student-task-group-for-student {
            max-width: 95%;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 1.25rem;
            white-space: normal;
            overflow-wrap: break-word;
        }

        #student-task-group-for-student {
            max-width: 95%;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 1.5rem;
            white-space: normal;
            overflow-wrap: break-word;
        }

        .student-list-task-indicatior {
            display: inline-block;
            margin-left: 5px;
            width: 10px;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
        }

        .mistakes-summary-forstudents-title {
            width: 100%;
            text-align: start;
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 15px;
            margin-top: 5px;
            text-transform: uppercase;
        }

        #student-task-status-indicator,
        #student-task-status-indicator-for-student {
            width: 20px;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
        }

        #task-description-title,
        #task-description-title-for-student {
            margin-top: 10px;
        }

        #task-description-for-student {
            margin-top: 10px;
        }

        .reset-button-div {
            margin-top: 40px;
        }

        .task-description-list {
            margin-bottom: 0;
            margin-top: 5px;
            padding: 0;
        }

        .task-description-list-item {
            text-transform: lowercase;
            margin-left: 2rem;
        }

        #change-teacher-input {
            margin-bottom: 5px;
        }

        #teacher-name {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        #change-teacher-toggle-button {
            text-decoration: underline;
            cursor: pointer;
            text-align: start;
            color: #32ac93;
            background-color: transparent;
            border: none;
            padding: 0;
        }

        #change-teacher-toggle-button:disabled {
            color: gray;
        }

        #add-change-teacher-buttons {
            height: 38px;
            margin: 10px 0;
        }

        #student-gui {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
            flex-direction: row;
        }

        #student-task-for-students-title-container {
            background: rgba(255, 255, 255, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding: 15px;
            display: flex;
            justify-content: space-between;
        }

        #student-task-list-container {
            overflow: auto;
            flex: 1;
            padding-top: 10px;
        }

        #student-tasks-list {
            background-color: transparent;
            padding: 0 0 10px 0;
        }

        .task-li-item-for-students {
            padding-top: 10px;
            margin-left: 15px;
        }

        #task-info-container-for-students {
            height: 100%;
            width: 100%;
        }

        .grammar-params-list {
            margin-left: 15px;
            padding: 0;
        }

        .grammar-view-selector {
            position: relative;
            border: none;
            border-radius: 4px;
            background-color: transparent;
            text-align: center;
            font-weight: bold;
            z-index: 10;
            pointer-events: auto;
            font-size: 1rem;
        }

        .task-info-subtitle {
            font-style: italic;
        }

        .student-statistics-title {
            font-size: 1.35rem;
            margin: 10px 0 5px 0;
            font-weight: 600;
            text-decoration: underline;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }

        .student-statistics-subtitle {
            font-size: 1.15rem;
            font-weight: 600;
        }

        .btn:disabled {
            background-color: #40c9a9;
            border-color: #40c9a9;
            color: black;
            filter: grayscale(25%);
        }

        .dropdown:disabled {
            filter: grayscale(25%);
            background-color: #FAF1E6;
            border-color: #6c757d;
        }

        .invalid-submition {
        animation: shake 0.2s ease-in-out 0s 2 !important;
        }

        #expand-student-info-button {
            background-color: transparent;
            border: none;
            font-size: 1.5rem;
        }

        .complete-task-holder {
            display: flex;
            justify-content: end;
            margin-top: 10px;
            gap: 5px;
        }

        #complete-task-button {
            position: relative;
            display: flex;
            align-items: center;
            padding: 12px 18px 12px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0;
            background: linear-gradient(135deg, #3288AC, #286D8A);
            border: none;
            /*border: 1px solid #286D8A;*/
            color: #F5F5F7;
            letter-spacing: 0.01em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            /*box-shadow: 
                0 1px 2px rgba(0, 0, 0, 0.2),
                0 4px 12px rgba(50, 136, 172, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);*/
        }

        #complete-task-button::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
        border-radius: 20px;
        pointer-events: none;
        transition: background 0.3s ease;
        }

        #complete-task-button::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 20px;
        padding: 1px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        pointer-events: none;
        }

        #complete-task-button:hover::before {
        background: rgba(255, 255, 255, 0.15);
        }


#student-task-student-knowledge-level,
#student-task-student-performance-mean,
#student-task-student-consistency-mean {
    flex: 1 1 auto;
}

.categories-dropdown-holder,
.student-points-holder {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: start;
    gap: 5px;
}

.knowledge-level-select-text, 
.student-points-label,
.student-consistency-label,
.student-statistics-label {
    text-transform: uppercase;
    font-weight: 600;
}

.student-points {
    font-size: 1.5rem;
    font-weight: 700;
}

#student-statistics-completed-tasks {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid rgba(255, 255, 255, 0.3);
    text-transform: uppercase;
    font-weight: 600;
    font-size: 1.25rem;
}

#student-statistics-completed-tasks .task-info-subtitle {
    font-style: normal;
}
        
.student-statistic-top-section {
    display: flex;
    align-items: start;
    margin-top: 20px !important;
    flex-wrap: wrap;
    width: 100%;
    gap: 15px;
}

/* Form and button styles */
.form-control {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
}

#student-statistics-komponavimas-completed-texts ol,
#text-comprehension-mistakes-summary ol {
    margin: 0 0 5px 0;
}

#student-statistics-komponavimas-completed-texts:not(:empty) {
    margin-top: 5px;
}


.task-info-holder,
.task-info-holder-student {
    flex-direction: column;
}


#task-list-title-for-students {
    font-weight: 700;
}

        @keyframes shake {
        0% { margin-left: 0rem; }
        25% { margin-left: 0.5rem; }
        75% { margin-left: -0.5rem; }
        100% { margin-left: 0rem; }
        }

        .clickable-word {
            cursor: pointer;
            position: relative;
            z-index: 1000;
        }

        .clickable-word:hover {
            text-decoration: underline;
        }

        .student-name,
        .selection-option {
            user-select: none;       /* Standard */
            -webkit-user-select: none; /* Chrome/Safari */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE/Edge */
        }


        .incorrect-part {
            pointer-events: none;
            padding: 0;
            font-weight: bold;
            padding: 2px 1px;
            border-radius: 3px;
            color: #32ac93;
        }

        .user-incorrect-answer {
            color: #D57E7E;
            font-weight: bold;
        }


        #student-tasks-list-outer-container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            overflow: hidden;
            flex: 1 0 60svh;
            display: flex;
            flex-direction: column;
        }


           .container {
      display: flex;
      min-height: 0;
    }

    /* Sidebar wrapper */
    .sidebar-wrapper {
      position: relative;
      flex: 1 1 65%;
      height: 100%;
      margin-right: 10px;
      min-width: 0;
    }

    /* Sidebar content */
    .sidebar {
        position: relative;
        padding: 16px;
        height: 100%;
        width: 100%;
        overflow-y: auto;
        margin-right: 15px;
        min-width: 0;
    }
    
    #knowledge-level-select {
        padding: 6px 8px;
        font-size: 1rem;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        width: 150px;
        text-align: center;
        cursor: pointer;
        width: auto;
    }

    #knowledge-level-select:focus,
    #knowledge-level-select:active {
        outline: none;
    }

    .sidebar-content {
      min-height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    /* Toggle tab - always visible */
    .toggle-tab {
      position: absolute;
      right: -34px;
      top: 0;
      border: none;
      width: 34px;
      height: 62px;
      border-radius: 0 20px 20px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    -webkit-backdrop-filter: blur(15px);
    backdrop-filter: blur(15px);
    background: rgba(255, 255, 255, 0.5);
    padding: 0;
    }

    .toggle-tab svg {
      width: 24px;
      height: 24px;
      transition: transform 0.3s ease;
    }

    /* Main content */
    .main-content {
      flex: 1;
      padding: 2rem;
      background: #f5f5f5;
    }

    .main-content h1 {
      color: #2c3e50;
      margin-bottom: 1rem;
    }

    .main-content p {
      line-height: 1.6;
      color: #555;
      margin-bottom: 1rem;
    }

      #action-buttons-container,
    #confirmation-buttons-container {
        display: flex;
        flex-direction: row;
        gap: 5px;
        height: 60px;
    }

    #confirmation-buttons-container {
        display: none;
    }


#student-action-buttons-container {
    display: flex;
    justify-content: end;
    margin-bottom: 10px;
    height: 60px;
}

#text-message {
    margin-top: 10px;
}

.student-action-btn {
    flex: 0 0 auto;
    width: 150px;
}

.teacher-action-btn,
.confirm-btn,
.new-search-btn,
.cancel-btn {
    flex: 1;
}

.teacher-action-btn,
.student-action-btn,
.confirm-btn,
.new-search-btn,
.cancel-btn {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  border: none;
  /*border: #286D8A 1px solid;*/
  background: linear-gradient(135deg, #3288AC, #286D8A);
  border-radius: 20px;
  cursor: pointer;
  font-size: 1rem;
  color: #F5F5F7;
  overflow: hidden;
  min-width: 0;
  padding: 16px 15px;
  font-weight: 500;
  letter-spacing: 0.01em;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  /*box-shadow: 
        0 1px 2px rgba(0, 0, 0, 0.2),
        0 4px 12px rgba(50, 136, 172, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);*/
}

.teacher-action-btn::before,
.student-action-btn::before,
.confirm-btn::before,
.new-search-btn::before,
.cancel-btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
  border-radius: 20px;
  pointer-events: none;
  transition: background 0.3s ease;
}

.teacher-action-btn::after,
.student-action-btn::after,
.confirm-btn::after,
.new-search-btn::after,
.cancel-btn::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 20px;
  padding: 1px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
}

.teacher-action-btn:hover::before,
.student-action-btn:hover::before,
.confirm-btn:hover::before,
.new-search-btn:hover::before,
.cancel-btn:hover::before {
  background: rgba(255, 255, 255, 0.15);
}


.confirm-btn {
    background: linear-gradient(135deg, #A0C58F, #32ac93);
    border: none;
    /*border: 1px solid #32ac93;*/
}

.new-search-btn {
    background: linear-gradient(135deg, #3288AC, #286D8A);
    border: none;
    /*border: 1px solid #32ac93;*/
}

.cancel-btn {
    background: linear-gradient(135deg, #ff8073, #e74c3c);
    border: none;
    /*border: 1px solid #e74c3c;*/
}

#confirm-button:disabled,
#new-search-button:disabled,
#new-search-button:disabled,
#cancel-button:disabled,
#new-task-button:disabled,
#delete-task-button:disabled,
#delete-student-button:disabled {
    opacity: 0.6;
    background: linear-gradient(135deg, #95a5a6, #aeb4b5);
    cursor: not-allowed;   
}

button:disabled.teacher-action-btn::before,
button:disabled.student-action-btn::before,
button:disabled.confirm-btn::before,
button:disabled.new-search-btn::before,
button:disabled.new-search-btn::before,
button:disabled.cancel-btn::before {
    background: transparent !important;
    pointer-events: none; /* ensures no interaction with pseudo-element */
}

#confirmation-buttons-container {
    animation: slideIn 0.3s ease-out;
}

.active-summary-button {
  position: relative;
  letter-spacing: 0.01em;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  /*box-shadow: 
    0 1px 2px rgba(0, 0, 0, 0.2),
    0 4px 12px rgba(50, 136, 172, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);*/
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-5px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#student-stats-graph-holder {
    flex-wrap: wrap;
    width: 100%;
    flex-direction: column;
    min-width: 0;
}

 .input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            overflow: hidden;
        }

        .control-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #333;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: #f0e5d6;
        }

        .control-btn:active {
            background: #e6dbc6;
        }

        .timer-input, .question-number-input {
            padding: 0.5rem;
            font-size: 1rem;
            width: 55px;
            border: 0;
            margin: 0;
            outline: none;
            background: #FAF1E6;
            text-align: center;
            -moz-appearance: textfield;
        }

        /* Hide number input spinners */
        .timer-input::-webkit-outer-spin-button,
        .timer-input::-webkit-inner-spin-button,
        .question-number-input::-webkit-outer-spin-button,
        .question-number-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .timer-label {
            font-size: 1rem;
            color: #333;
            margin: 0;
            font-weight: 500;
        }
   
#delete-task-button-label,
#create-task-button-label,
#delete-student-button-label {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
}

.two-rows-button-label {
    flex-direction: column !important;
    gap: 0 !important;
    flex-wrap: nowrap !important;
}

.btn-label span {
    display: block;
}


    .filter-section {
        padding-bottom: 10px;
        display: flex;
        flex-wrap: wrap;
    }

    .filter-label {
        font-weight: 600;
        color: #4a4a4a;
        margin-bottom: 12px;
        display: block;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .button-group-metrics {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }

    .btn-subject {
        position: relative;
        padding: 10px 20px;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 14px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
        color: #333;
        text-transform: uppercase;
    }

    .btn-subject::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
    border-radius: 14px;
    pointer-events: none;
    transition: background 0.3s ease;
    }

    .btn-subject::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 14px;
    padding: 1px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
    }

    .btn-subject:hover:not(:disabled):not(.active) {
        background: rgba(255, 255, 255, 0.4);
    }

    .btn-subject.active {
        color: #F5F5F7;
        background: linear-gradient(135deg, #A0C58F, #32ac93);
    }

    .btn-metric {
        position: relative;
        padding: 10px 20px;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.3s ease;
        color: #333;
        text-transform: capitalize;
    }

    .btn-metric::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
    border-radius: 20px;
    pointer-events: none;
    transition: background 0.3s ease;
    }

    .btn-metric::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 20px;
    padding: 1px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
    }

    .btn-metric:hover:not(:disabled):not(.active) {
        background: rgba(255, 255, 255, 0.4);
    }

    .btn-metric:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    button[data-metric-id="0"].active {
        background-color: #286D8A;
        color: #F5F5F7;
    }

    button[data-metric-id="1"].active {
        background-color: #32ac93;
        color: #F5F5F7;
    }

    button[data-metric-id="2"].active {
        background-color: #e74c3c;
        color: #F5F5F7;
    }

    button[data-metric-id="3"].active {
        background-color: #F28C28;
        color: #F5F5F7;
    }

    button[data-metric-id="4"].active {
        background-color: #8b5cf6;
        color: #F5F5F7;
    }

    button[data-metric-id="5"].active {
        background-color: #ec4899;
        color: #F5F5F7;
    }

    button[data-metric-id="6"].active {
        background-color: #06b6d4;
        color: #F5F5F7;
    }

    button[data-metric-id="7"].active {
        background-color: #84cc16;
        color: #F5F5F7;
    }

    /* Enhanced chart container with fixed header */
    .chart-container {
        position: relative;
        height: 350px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 20px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        width: 100%;
    }

    .chart-body {
        flex: 1;
        position: relative;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        width: 100%;
    }

    .chart-scrollable {
        position: relative;
        height: 100%;
    }
    
    #statsChart {
        width: 100% !important;
        height: 100% !important;
    }

    .chart-scroll-indicator.hidden {
        opacity: 0;
    }

    .info-box {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 15px;
        margin-top: 20px;
        border-radius: 20px;
    }

    .info-box p {
        color: #1a1a1a;
        font-size: 13px;
        line-height: 1.6;
    }

    .student-name-id-holder {
        display: inline-block;   /* or block if needed */
        min-width: 0;
        max-width: 100%;         /* stay within parent */
        word-wrap: break-word;   /* wrap long text */
        white-space: normal;     /* allow wrapping */
        width: auto;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        flex: 1 1 auto;
    }

    .edit-name-button{
        flex: 0 0 auto;
        cursor: pointer;
    }

    .student-name-id-holder span {
        display: inline;         /* keep inline for name and ID */
    }

    #student-name {
        margin-right: 5px;
        display: flex;
        min-width: 0;
        white-space: normal;
        word-break: break-word;
    }

    .student-name-field {
        font-weight: 800;
        text-transform: uppercase;
        font-size: 1.5rem;
        border: none;
        width: auto;
        min-width: 3ch;
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 20px;
        border: none;
        padding: 0 8px;
        max-width: 100%;
        margin-right: 5px;
        flex: 1 1 auto;
    }

    #student-id {
        flex: 1 0 auto;
        min-width: 0;
        white-space: normal;
        word-break: break-word;
    }

    .student-name-field:focus,
    .student-name-field:active {
        border: none;
        outline: none;
    }

    .selected-text-task-info-for-teachers-item {
        text-transform: uppercase;
        cursor: pointer;
    }

    .selected-text-task-info-for-teachers-item:hover {
        text-decoration: underline;
    }


    @media (max-width: 1999px) {
        #teacher-message-line,
        #teacher-data-retrieval-message,
        #student-message {
            margin-right: 8vw;
        }
    }

    @media (max-width: 992px) {
        .sidebar-wrapper,
        .left-side-bar {
            flex: 1 1 50%;
        }
    }

    /* Desktop: sidebar always visible, hide toggle */
    @media (min-width: 769px) {
      .toggle-tab {
        display: none;
      }
    }

    /* Mobile: collapsible sidebar */
    @media (max-width: 768px) {

        #content-container {
            max-height: none;
            min-height: none;
        }


        #student-task-info-container {
                padding-left: 0;
            }

            #teacher-button-holder-outer {
                display: flex;
                justify-content: end;
            }

            .teacher-button-holder {
                width: 92%;
            }

            #action-buttons-container, 
            #confirmation-buttons-container {
                gap: 8px;
            }

            #student-task-info-container-inner {
                padding: 15px;
            }
            
            #content-container {
                margin: 0;
                flex: 1;
                width: 100vw;
                justify-content: start;
                background: transparent;
                border: none;
                box-shadow: none
            }

            #teacher-gui {
                align-items: center;
            }

            .left-side-bar {
                height: 100%;
                background: transparent;
                border-right: none;
                border-radius: 0;
            }

            .dropdown {
                margin: 7px 0;
            }

            #dynamic-student-content {
                padding-left: 0;
            }

            #timer-input,
            #question-number-input {
                font-size: 1.1rem;
            }

            .timer-choice-label, 
            .answer-number-label {
                font-size: 1.25rem;
            }

      .sidebar {
        padding: 16px;
        height: 100%;
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        background: rgba(255, 255, 255, 0.5);
        border-bottom-right-radius: 8px;
        margin: 0;
        margin-top: 0;
      }

      .sidebar-wrapper {
        position: fixed;
        left: 0;
        top: 95px;
        height: calc(100% - 80px - 30px);
        width: calc(100vw - 34px - 5px);
        z-index: 100;
        transition: transform 0.3s ease;
        transform: translateX(calc(-1*(100vw - 34px - 5px)));
        padding-left: 0;
      }

      .sidebar-wrapper.open {
        transform: translateX(0);
      }

      .sidebar-wrapper.open .toggle-tab svg {
        transform: rotate(180deg);
      }

      .main-content {
        padding: 1.5rem;
        width: 100%;
      }

      /* Overlay */
      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99;
      }

      .overlay.active {
        display: block;
      }

    .timer-input, .question-number-input {
            pointer-events: none;
        }
        
    /* Re-enable for buttons */
    .control-btn {
        pointer-events: auto;
    }

    #complete-task-button {
        padding: 10px 16px;
    }

    #summary-table-frequent-mistakes table {
        border-color: transparent;
    }

    th,
    td {
        background-color: rgba(255, 255, 255, 0.8);
    }

    .summary-table-frequent-mistakes-outer-div th,
    .summary-table-frequent-mistakes-outer-div td {
        background-color: transparent;
    }

    .summary-table-frequent-mistakes-outer-div .table-container {
        box-shadow: none;
    }

    .summary-table-frequent-mistakes-outer-div td:first-child {
        padding-left: 0;
        padding-right: 0;
    }

    #knowledge-level-select {
        background: rgba(255, 255, 255, 0.8);
    }

    .student-statistics-title {
        border-top: 2px solid rgba(255, 255, 255, 1);
    }

    #student-statistics-completed-tasks {
        border-top: 2px solid rgba(255, 255, 255, 1);
        font-size: 1.15rem;
    }

    tr:last-child td {
    padding-bottom: 10px;
    }

    .filter-section {
                padding-bottom: 15px;
            }
            
            .button-group {
                gap: 8px;
            }
            
            .chart-container {
                height: 400px;
                padding: 15px;
                border-radius: 15px;
            }
            
            .info-box {
                padding: 12px;
                margin-top: 15px;
            }
            
            .info-box p {
                font-size: 12px;
            }
            
            .chart-scroll-indicator {
                display: none;
            }

    .btn-metric,
    .btn-subject {
        background: rgba(255, 255, 255, 0.8);
    }

    .chart-container {
        background: rgba(255, 255, 255, 0.8);
        padding: 10px 3px;
    }

    .chart-container {
        height: 300px;
    }
}

    @media (max-width: 578px) {
            html,
            body {
                width: 100vw;
            }

            #group_name,
            #mode_choice,
            #mode_choice_1,
            #mode_choice_2,
            #mode_choice_3,
            #mode_choice_4,
            #mode_choice_5,
            #mode_choice_6,
            #mode_choice_7,
            #mode_choice_8,
            #mode_choice_9,
            #mode_choice_10,
            #mode_choice_13,
            #mode_choice_14,
            #mode_choice_15,
            #class_choice {
                font-size: 1.1rem;
            }

            .initial-button-div {
                width: 100%;
            }

            .confirmation-button-div {
                width: 100%;
                margin: 0;
            }

            #confirm-delete-task-button {
                margin-bottom: 15px;
            }

            #confirm-delete-student-button {
                margin-bottom: 15px;
            }

            .teacher-button-line {
                flex-direction: column;
            }

            #teacher-message-line,
            #teacher-data-retrieval-message {
                margin-bottom: 15px;
            }

        #student-task-group-for-student {
            font-size: 1.25rem;
        }

         .mistakes-summary-forstudents-title {
            font-size: 1.25rem;
        }
        .student-points {
            font-size: 1.25rem;
            padding-top: 0.25rem;
        }

        .btn-subject {
            font-size: 0.75rem;
        }

        .btn-metric {
            font-size: 0.8rem;
        }

        .chart-container {
            height: 200px;
        }

        #knowledge-level-select {
            width: 100px;
        }
    }


    @media (min-device-width: 768px) and (max-device-width: 1200px) and (orientation: portrait)  {
        #content-container {
            max-height: none;
            min-height: none;
        }

        .left-side-bar {
            padding: 35px;
        }


        body {
            font-size: 1.5rem;
        }

        #new-task-button,
        #delete-task-button,
        #delete-student-button,
        #confirm-delete-task-button,
        #confirm-delete-student-button,
        #submitButton,
        #add-teacher,
        #change-teacher,
        #confirm-button,
        #new-search-button,
        #cancel-button,
        #frequent-mistakes-btn,
        .display-summary-button {
            font-size: 1.5rem;
        }

        #add-change-teacher-buttons {
            margin: 10px 0 30px 0;
        }

        #complete-task-button {
            font-size: 1.4rem;
        }

        #student-message {
            margin-right: 0;
        }

        #teacher-name {
            font-size: 1.75rem;
        }

        .form-control {
            font-size: 1.75rem;
        }

        .menu ul li a {
            font-size: 1.75rem;
        }

        .menu {
            width: 160px;
        }

        .reset-button {
            width: 6rem;
            height: 6rem;
        }

        .sidebar {
        padding: 16px;
        height: 100%;
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        background: rgba(255, 255, 255, 0.5);
        border-bottom-right-radius: 8px;
        margin: 0;
      }

      .sidebar-wrapper {
        position: fixed;
        left: 0;
        top: 134px;
        height: calc(100% - 100px - 70px);
        width: calc(100vw - 34px - 5px);
        z-index: 100;
        transition: transform 0.3s ease;
        transform: translateX(calc(-1*(100vw - 34px - 5px)));
        padding-left: 0;
      }

      .sidebar-wrapper.open {
        transform: translateX(0);
      }

      .sidebar-wrapper.open .toggle-tab svg {
        transform: rotate(180deg);
      }

      .main-content {
        padding: 1.5rem;
        width: 100%;
      }

    .toggle-tab {
        display: flex;
      }

       #student-task-info-container {
                padding-left: 0;
            }

            #teacher-button-holder-outer {
                display: flex;
                justify-content: end;
            }

            .teacher-button-holder {
                width: 92%;
            }

            #action-buttons-container, 
            #confirmation-buttons-container {
                gap: 8px;
            }

            #student-task-info-container-inner {
                padding: 15px;
            }
            
            #content-container {
                margin: 0;
                flex: 1;
                width: 100vw;
                justify-content: start;
                background: transparent;
                border: none;
                box-shadow: none
            }

            #teacher-gui {
                align-items: center;
            }

            #text-browser-button {
                font-size: 1.5rem;
            }

            table * {
                font-size: 1.5rem;
            }

            .grammar-view-selector {
                font-size: 1.5rem;
            }

            th,
            td {
                background-color: rgba(255, 255, 255, 0.8);
            }

            .student-action-btn {
                flex: 0 0 auto;
                width: auto;
            }

            #knowledge-level-select {
                background: rgba(255, 255, 255, 0.8);
                font-size: 1.5rem;
            }

    .student-statistics-title {
        border-top: 2px solid rgba(255, 255, 255, 1);
    }

    #student-statistics-completed-tasks {
        border-top: 2px solid rgba(255, 255, 255, 1);
    }

    .student-name-field,
    #student-task-student-name {
        font-size: 2rem;
    }

    .edit-icon img {
        height: 24px;
        width: 24px;
    }
    }

.text-comprehenstion-text-id:hover {
    text-decoration: underline;
    cursor: pointer;
}

.txt-browser-wrapper {
    max-width: 1200px;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 20px;
    overflow: hidden;
    margin-top: 16px;
    width: 100%;
}

.txt-browser-main-header {
    background: rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    padding: 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
    transition: background 0.2s;
}

.txt-browser-main-title {
    font-size: 1.5rem;
    font-weight: 600;
    text-transform: uppercase;
    margin: 0;
}

.txt-browser-main-icon {
    transition: transform 0.3s;
    font-size: 1.5rem;
    display: flex;
}

.txt-browser-main-icon svg {
    height: 30px;
    width: 30px;
}

.txt-browser-main-icon:not(.collapsed) {
    transform: rotate(180deg);
}


.txt-browser-content {
    height: 0;
    overflow: hidden;
    transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: none;
    width: 100%; /* Prevent width changes */
}

.txt-browser-content.expanded {
    display: block;
}

.txt-viewer-container {
    background: transparent;
    border-radius: 0;
    box-shadow: none;
    overflow: visible;
    display: flex;
    flex-direction: column;
    min-height: 0;
}

.txt-viewer-sticky-header {
    z-index: 100;
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
    padding: 15px;
    flex: 0 0 auto;
}

.txt-viewer-selected-ids-container {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    padding: 12px;
    display: none;
    height: 90px;
    min-height: 90px;
    overflow-y: auto;
}

.txt-viewer-selected-ids-container-outer {
    margin: 15px;
}

.txt-viewer-selected-ids-container.txt-viewer-visible {
    display: block;
}

.txt-viewer-selected-ids-label {
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 14px;
    text-transform: uppercase;
}

.txt-viewer-selected-ids-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.txt-viewer-selected-id-chip {
    background: #3288AC;
    color: white;
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 13px;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}


.txt-viewer-selected-id-chip .txt-viewer-remove {
    font-weight: bold;
    font-size: 16px;
}

.txt-viewer-search-input {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    font-size: 16px;
    transition: border-color 0.2s;
    margin-bottom: 15px;
}

.txt-viewer-search-input:focus,
.txt-viewer-search-input:active {
    outline: none;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

/* Unified filters section */
.txt-viewer-all-filters-wrapper {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    overflow: hidden;
}

.txt-viewer-all-filters-header {
    padding: 12px 16px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    user-select: none;
    transition: background 0.2s;
}

.txt-viewer-all-filters-icon svg {
    height: 24px;
    width: 24px;
}

.txt-viewer-all-filters-icon {
    transition: transform 0.3s;
    display: flex;
}

.txt-viewer-all-filters-icon.txt-viewer-collapsed {
    transform: rotate(-180deg);
}

.txt-viewer-all-filters-content {
    max-height: 500px;
    overflow: hidden;
    transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    padding: 16px;
    display: flex;
    flex-wrap: wrap;
}

.txt-viewer-all-filters-content.txt-viewer-collapsed {
    max-height: 0;
    padding: 0 16px;
}

.txt-viewer-filter-group {
    margin-bottom: 15px;
    flex: 1 1 auto;
}

.txt-viewer-filter-group:last-child {
    margin-bottom: 0;
}

.txt-viewer-filter-label {
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.txt-viewer-filter-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.txt-viewer-filter-option {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 6px;
    border-radius: 8px;
    transition: background 0.2s;
}

.txt-viewer-filter-option:hover {
    background: rgba(255, 255, 255, 0.5);
}

.txt-viewer-filter-option input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.txt-viewer-filter-option label {
    cursor: pointer;
    font-size: 14px;
    flex: 1;
}

.txt-viewer-texts-list {
    padding: 15px;
    flex: 1 1 auto;
    min-height: 0;
    overflow: auto;
    border-top: 2px solid rgba(255, 255, 255, 0.3);
}

.txt-viewer-text-item {
    margin-bottom: 12px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 20px;
}

.text-item-expanded {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.txt-viewer-text-item-header {
    padding: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: background 0.2s;
}

.txt-viewer-text-item-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.txt-viewer-text-item-main {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
}

.txt-viewer-text-item-info {
    flex: 1;
}

.txt-viewer-text-item-id {
    color: #3288AC;
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
}

.txt-viewer-text-item-title {
    font-weight: 500;
    font-size: 16px;
}

.txt-viewer-text-item-expand-icon {
    transition: transform 0.3s;
    color: #666;
    display: flex;
}

.txt-viewer-text-item-expand-icon svg {
    height: 24px;
    width: 24px;
}

.txt-viewer-text-item-expand-icon.txt-viewer-expanded {
    transform: rotate(180deg);
}

.txt-viewer-text-item-details {
    padding: 0 16px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, padding 0.3s ease-out;
}

.txt-viewer-text-item-details.txt-viewer-expanded {
    max-height: 2000px;
    padding: 16px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    flex: 1 1 auto;
    overflow: auto;
}

.text-detail-row {
    margin-bottom: 16px;
}

.text-detail-label {
    font-weight: 600;
    color: #666;
    font-size: 13px;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.text-detail-content {
    font-size: 15px;
    line-height: 1.6;
}

.text-section {
    margin-bottom: 12px;
}

.text-section-title {
    font-weight: 600;
    color: #3288AC;
    font-size: 14px;
}

.text-section-paragraph {
    margin-bottom: 8px;
    white-space: pre-line;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 8px;
    padding: 5px 10px;
}

.text-section-paragraph:last-child {
    margin-bottom: 0;
}

.txt-viewer-no-results {
    text-align: center;
    padding: 40px;
    color: #666;
    font-size: 16px;
}

.badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    margin-right: 6px;
    margin-bottom: 6px;
}

.badge-class-lower {
    background: #e1f5fe;
    color: #A0C58F;
}

.badge-class-higher {
    background: #e1f5fe;
    color: #01579b;
}

.badge-struktura {
    background: #f3e5f5;
    color: #4a148c;
}

.badge-komponavimas {
    background: #fff3e0;
    color: #e65100;
}

@media (max-width: 768px) {
    .txt-viewer-sticky-header {
        padding: 15px;
    }

    .txt-viewer-texts-list {
        padding: 15px;
    }

    .txt-viewer-filter-options {
        grid-template-columns: 1fr;
    }


    .txt-viewer-search-input,
    .txt-viewer-all-filters-wrapper,
    .txt-viewer-selected-ids-container,
    .txt-viewer-text-item {
        background: rgba(255, 255, 255, 0);
        border: 1px solid rgba(255, 255, 255, 1);
    }

    .txt-viewer-sticky-header {
        border-bottom: 2px solid rgba(255, 255, 255, 1);
    }

    .txt-viewer-texts-list {
        border-top: 2px solid rgba(255, 255, 255, 1);
    }

    .text-section-paragraph {
        background: rgba(255, 255, 255, 1);
        border: 1px solid rgba(255, 255, 255, 1);
    }

    .txt-browser-main-header {
        background: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.7);
        padding: 15px;
    }

    .txt-browser-main-title {
        font-size: 1.25rem;
    }
}
    </style>
</head>

<body>
    <div id="customConfirmModal" class="modal">
    <div class="modal-content">
        <p id="customModalText"></p>
        <div class="modal-buttons">
        <button id="customConfirmYes" class="btn btn-confirm">Taip</button>
        <button id="customConfirmNo" class="btn btn-cancel">Ne</button>
        </div>
    </div>
    </div>

    <div id="object-popup" class="object-popup-overlay" style="display:none;">
    <div class="object-popup-panel">
        <button class="object-popup-close">&times;</button>
        <div class="title-subtitle-inline-button-wrapper">
        <div class="object-popup-title-subtitle-wrapper">
        <div class="object-popup-title" id="object-popup-title"></div>
        <div class="object-popup-subtitle" id="object-popup-subtitle"></div>
        </div>
        </div>
        <div class="object-popup-content" id="object-popup-content">
        <!-- Dynamic content goes here -->
        </div>
    </div>
    </div>

   <nav class="main-navbar" id="mainNavbar">
        <div class="main-nav-container">
            <!-- Logo -->
            <a href="#" class="main-nav-logo">
                <div class="main-nav-logo-icon">
                 <img id="sudedu-main-nav-bar-logo" src="../images/sudedu_logo.png" alt="sudEdu">
                </div>
            </a>

            <!-- Desktop Navigation -->
            <div class="main-nav-links invisible">
                <a href="index.html" class="main-nav-link">Praktika</a>
                <a href="uzduotys.html" class="main-nav-link main-nav-link-active">U≈æduotys</a>
                <a href="klase.html" class="main-nav-link">Klasƒó</a>
                <a href="augintiniai.html" class="main-nav-link">Augintiniai</a>
                <a href="apie.html" class="main-nav-link">Apie Sudedu</a>
                
                <div class="main-nav-language-dropdown" id="languageDropdown">
                    <button class="main-nav-language-btn" id="languageBtn">
                        <span id="currentLanguage">LT</span>
                        <span class="main-nav-language-arrow"></span>
                    </button>
                    <div class="main-nav-language-menu">
                        <button class="main-nav-language-option selected" data-lang="LT">LT</button>
                        <button class="main-nav-language-option" data-lang="EN">EN</button>
                    </div>
                </div>
                
                
                <div class="main-nav-connect-wrapper">
                    <div class="main-nav-connect-glow"></div>
                    <button class="main-nav-log-out-btn">
                        <span class="main-nav-connect-text">Atsijungti</span>
                    </button>

                    <button class="main-nav-log-in-btn">
                        <span class="main-nav-connect-text">Prisijungti</span>
                    </button>
                </div>
            </div>

            <!-- Mobile Button -->
            <button class="main-nav-mobile-btn" id="mainNavMobileBtn">
                <span class="main-nav-hamburger"></span>
                <span class="main-nav-hamburger"></span>
                <span class="main-nav-hamburger"></span>
            </button>

            <!-- Mobile Menu -->
            <div class="main-nav-mobile-menu" id="mainNavMobileMenu">
                <a href="index.html" class="main-nav-mobile-link">Praktika</a>
                <a href="uzduotys.html" class="main-nav-mobile-link active">U≈æduotys</a>
                <a href="klase.html" class="main-nav-mobile-link">Klasƒó</a>
                <a href="augintiniai.html" class="main-nav-mobile-link">Augintiniai</a>
                <a href="apie.html" class="main-nav-mobile-link">Apie Sudedu</a>
                
                <div class="main-nav-mobile-language">
                    <button class="language-option language-option-LT selected" onclick="setLanguage('LT')">LT</button>
                    <span class="language-separator">/</span>
                    <button class="language-option language-option-EN" onclick="setLanguage('EN')">EN</button>
                </div>
                
                <button class="main-nav-mobile-log-out-btn">
                    <span class="main-nav-connect-text">Atsijungti</span>
                </button>
                <button class="main-nav-mobile-log-in-btn">
                    <span class="main-nav-connect-text">Prisijungti</span>
                </button>
            </div>
        </div>
    </nav>

    <div id="content-container">
	<div class="container" id="template-container">
        <div id="inner-container">
            <!-- TEACHER GUI -->
<div id="teacher-gui" style="display: none;">

    <!-- LEFT SIDE: Student List (always visible) -->
    <div class="left-side-bar">
        <div class="left-side-bar-inner">
                <!-- Button and Message Section (stays on top, full width) -->
        <div id="teacher-button-holder-outer">
                <div class="teacher-button-holder">
                    <!-- Action buttons that transform -->
                    <div id="action-buttons-container">
                        <button id="new-task-button" class="teacher-action-btn" data-action="new-task">
                            <span id="create-task-button-label" class="btn-label"><span>Kurti</span><span>u≈æduotƒØ</span></span>
                        </button>
                        
                        <button id="delete-task-button" class="teacher-action-btn" data-action="delete-task">
                            <span id="delete-task-button-label"  class="btn-label"><span>Trinti</span><span>u≈æduotis</span></span>
                        </button>
                        
                        <button id="delete-student-button" class="teacher-action-btn" data-action="delete-student">
                            <span id="delete-student-button-label"  class="btn-label"><span>≈†alinti</span><span>mokinius</span></span>
                        </button>

                        <button id="browse-task-history-button" class="teacher-action-btn" data-action="browse-history">
                            <span id="browse-task-history-label"  class="btn-label"><span>Rezultat≈≥</span><span>istorija</span></span>
                        </button>
                    </div>
                    
                    <!-- Confirmation buttons (hidden by default) -->
                    <div id="confirmation-buttons-container">
                        <button id="confirm-button" class="confirm-btn">
                            <span id="confirm-label">Patvirtinti</span>
                        </button>
                        <button id="new-search-button" class="new-search-btn"  style="display: none;" disabled>
                            <span id="new-search-label">Nauja paie≈°ka</span>
                        </button>
                        <button id="cancel-button" class="cancel-btn">
                            <span id="cancel-label">At≈°aukti</span>
                        </button>
                    </div>
                </div>
        </div>


            <div id="student-details-for-teachers">
                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" id="task-group-sorting"></select>
                <div id="outer-student-list-container">
                    <div class="d-flex justify-content-between" id="student-list-header">
                        <div class="align-items-center justify-content-start" id="student-list-header-checkbox-container" style="display: none;">
                            <input type="checkbox" id="select-all-checkbox">
                            <div>pasirinkti visus</div>
                        </div>
                        <div class="align-items-center justify-content-start" id="student-list-title-container">
                            <div>Mokini≈≥ sƒÖra≈°as:</div>
                        </div>
                        <button type="button" id="expand-student-info-button" style="margin-left: auto;">&#x2212;</button>
                    </div>
                    <div id="student-list-container">
                    <div id="student-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- RIGHT SIDE: Collapsible Sidebar with Task Options and Info -->
        <div class="sidebar-wrapper" id="sidebarWrapper">
            <aside class="sidebar hide-scrollbar-mobile" id="sidebar">
                <div class="sidebar-content" id="sidebarContent">
                    <div id="dynamic-teacher-content">
                        <!-- New Task Options Container -->
                        <div id="new-task-options-container" style="display: none;">
                            <div class="new-task-input-holder">
                                <input type="text" id="group_name" placeholder="U≈æduoƒçi≈≥ grupƒós pavadinimas" class="form-control">
                            </div>

                            <div class="ode_choice_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice" id="mode_choice">
                                    <option value="math">MATEMATIKƒÑ</option>
                                    <option value="lang">LIETUVI≈≤ KALBƒÑ</option>
                                </select>
                            </div>

                            <div class="mode_choice_1_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_1" id="mode_choice_1">
                                    <option value="C1">SUDƒñTƒÆ</option>
                                    <option value="C2">ATIMTƒÆ</option>
                                    <option value="C3">SUDƒñTƒÆ IR ATIMTƒÆ</option>
                                    <option value="C4">DAUGYBƒÑ</option>
                                    <option value="C5">DALYBƒÑ</option>
                                    <option value="C6">DAUGYBƒÑ IR DALYBƒÑ</option>
                                    <option value="C7">ƒÆVAIRIUS VEIKSMUS</option>
                                </select>
                            </div>

                            <div class="mode_choice_2_div">
                                <div class="col-12 d-flex justify-content-center align-items-center mode_choice_2_div text-center" id="mode_choice_2_div">
                                    <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_2" id="mode_choice_2">
                                        <option value="C8">VIENA≈ΩENKLI≈≤ SKAIƒåI≈≤ IKI 10</option>
                                        <option value="C9">VIENA≈ΩENKLI≈≤ SKAIƒåI≈≤ IKI 20 (LENTELINƒñ SUDƒñTIS)</option>
                                        <option value="C10">DVI≈ΩENKLIO IR VIENA≈ΩENKLIO SKAIƒåI≈≤ IKI 20</option>
                                        <option value="C11">DVI≈ΩENKLIO IR VIENA≈ΩENKLIO SKAIƒåI≈≤ IKI 100</option>
                                        <option value="C12">DVI≈ΩENKLI≈≤ SKAIƒåI≈≤ IKI 100</option>
                                        <option value="C13">SKAIƒåI≈≤ IKI 1 000</option>
                                        <option value="C14">SKAIƒåI≈≤ IKI 10 000</option>
                                        <option value="C15">SKAIƒåI≈≤ IKI 1 000 000</option>
                                    </select>
                                </div>
                            </div>

                            <div class="selected_numbers_div">
                                <div class="selected_numbers_inner_div">
                                    <label class="number-choice-label-nuo" for="selected_number" id="number_label" style="display: none;">NUO</label>
                                    <select class="btn btn-secondary dropdown-toggle dropdown text-center" name="selected_number" id="selected_number" style="display: none;">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                    </select>
                                    <label class="number-choice-label-iki" for="selected_number_2" id="number_label_2" style="display: none;">IKI</label>
                                    <select class="btn btn-secondary dropdown-toggle dropdown text-center" name="selected_number_2" id="selected_number_2" style="display: none;">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                    </select>
                                </div>
                            </div>

                            <div class="remainder-div">
                                <label id="remainder-option" style="display: none;">
                                    <input id="remainder-input" type="checkbox" name="myCheckbox"> DALYBA SU LIEKANA
                                </label>
                            </div>

                            <div class="mode_choice_3_div">
                                <div class="col-12 d-flex justify-content-center align-items-center text-center mode_choice_3_div" id="mode_choice_3_div">
                                    <select class="btn btn-secondary dropdown-toggle dropdown text-center" name="mode_choice_3" id="mode_choice_3">
                                        <option value="C37">NEPER≈ΩENGIANT DE≈†IMTIES</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mode_choice_5_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_5" id="mode_choice_5">
                                    <option value="C41">SKAITINƒñ LYGYBƒñ</option>
                                    <option value="C42">SKAITINƒñ LYGYBƒñ SU NE≈ΩINOMUOJU</option>
                                </select>
                            </div>

                            <div class="mode_choice_6_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_6" id="mode_choice_6" style="display: none;">
                                    <option value="C43">NE≈ΩINOMAS DƒñMUO</option>
                                </select>
                            </div>

                            <div class="mode_choice_7_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_7" id="mode_choice_7" style="display: block;">
                                    <option value="C47">EILUTE</option>
                                    <option value="C48">STULPELIU / KAMPU</option>
                                </select>
                            </div>

                            <div class="mode_choice_8_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_8" id="mode_choice_8" style="display: none;">
                                    <option value="C49">TEKSTO SUPRATIMƒÑ</option>
                                    <option value="C83">GRAMATIKƒÑ</option>
                                </select>
                            </div>

                            <div class="mode_choice_9_div">
                                <div class="col-12 d-flex justify-content-center align-items-center mode_choice_9_div text-center" id="mode_choice_9_div">
                                    <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_9" id="mode_choice_9" style="display: none;">
                                        <option value="C51">TURINIO KOMPONAVIMƒÑ</option>
                                        <option value="C52">STRUKT≈™ROS I≈†DƒñSTYMƒÑ</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mode_choice_15_div">
                                <div class="col-12 d-flex justify-content-center align-items-center mode_choice_15_div text-center" id="mode_choice_15_div">
                                    <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_15" id="mode_choice_15" style="display: none;">
                                        <option value="C82">ATSITIKTINIAI TEKSTAI</option>
                                        <option value="C84">PARINKTI TEKSTUS</option>
                                    </select>
                                </div>
                            </div>

                            <div class="class_choice_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="class_choice" id="class_choice" style="display: none;">
                                    <option value="C75">1-2 KLASƒñ</option>
                                    <option value="C76">3-4 KLASƒñ</option>
                                </select>
                            </div>

                            <div class="mode_choice_10_div">
                                <div class="col-12 d-flex justify-content-center align-items-center mode_choice_10_div text-center" id="mode_choice_10_div">
                                    <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_10" id="mode_choice_10" style="display: none;">
                                        <option value="C58">LENGVAS</option>
                                        <option value="C59">VIDUTINIS</option>
                                        <option value="C60">SUNKUS</option>
                                    </select>
                                </div>
                            </div>

                            <div class="rasyba-options-row">
                                <div class="mode_choice_11_div" id="mode_choice_11_div" style="display: none;">
                                    <label class="rasyba-options-label">
                                        <input type="checkbox" class="r" name="r" value='GAL≈™NƒñS' checked><span class="rasyba-options-label-text" id="rasyba-options-label-text-galune">≈ΩOD≈ΩIO PABAIGA:</span>
                                    </label>
                                    <br>
                                    <div id="galuniu-div">
                                        <label class="rasyba-options-label" style="display: none;">
                                            <input type="checkbox" class="rasyba-options options-for-first-second-classes-input" id="first-second-class-endings" name="rasyba-option" value='{"C61": []}' checked><span class="rasyba-options-label-text">DAIKTAVARDIS</span>
                                            <br>
                                        </label>
                                        <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                            <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C62": []}'><span class="rasyba-options-label-text">DAIKTAVARD≈ΩIAI</span>
                                            <br>
                                        </label>
                                        <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                            <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C63": [], "C64": []}'><span class="rasyba-options-label-text">B≈™DVARD≈ΩIAI IR PRIEVEIKSMIAI</span>
                                            <br>
                                        </label>
                                        <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                            <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C65": []}'><span class="rasyba-options-label-text">VEIKSMA≈ΩOD≈ΩIAI</span>
                                            <br>
                                        </label>
                                        <div class="mode_choice_12_div" id="mode_choice_12_div">
                                            <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_12" id="mode_choice_12">
                                                <option value="C73">LENGVESNƒñS KOMBINACIJOS</option>
                                                <option value="C74">SUNKESNƒñS KOMBINACIJOS</option>
                                            </select>
                                        </div>
                                    </div>
                                    <label class="rasyba-options-label">
                                        <input id="C66" type="checkbox" class="rasyba-options" name="rasyba-option" value='{"C66": []}' checked><span class="rasyba-options-label-text">ƒÆSIDƒñMƒñTINA RA≈†YBA</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                        <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C71": []}'><span class="rasyba-options-label-text">PRIEBALSI≈≤ SUPANA≈†ƒñJIMAS</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-first-second-classes" style="display: block;">
                                        <input type="checkbox" class="rasyba-options options-for-first-second-classes-input" name="rasyba-option" value='{"C67": []}'checked><span class="rasyba-options-label-text">PANA≈†IAI SKAMBANƒåIOS PRIEBALSƒñS</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label" style="display: block;">
                                        <input type="checkbox" class="rasyba-options" name="rasyba-option" value='{"C68": []}' checked><span class="rasyba-options-label-text">BALSƒñS IR DVIBALSƒñS</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                        <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C72": []}'><span class="rasyba-options-label-text">MI≈†RIEJI DVIGARSIAI</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                        <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C69": []}'><span class="rasyba-options-label-text">PRIE≈†DƒñLIAI</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                        <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C70": []}'><span class="rasyba-options-label-text">PRIESAGOS</span>
                                        <br>
                                    </label>
                                </div>

                                <div class="mode_choice_13_div">
                                    <div class="row"></div>
                                    <div class="col-12 d-flex justify-content-center align-items-center mode_choice_13_div text-center" id="mode_choice_13_div">
                                        <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_13" id="mode_choice_13" style="display: none;">
                                            <option value="3">RETESNI ATVEJAI</option>
                                            <option value="1">DA≈ΩNESNI ATVEJAI</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="mode_choice_14_div">
                                <div class="col-12 d-flex justify-content-center align-items-center mode_choice_14_div text-center" id="mode_choice_14_div">
                                    <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_14" id="mode_choice_14" style="display: none;">
                                        <option value="C80">BE DISTRAKTORIAUS</option>
                                        <option value="C81">SU DISTRAKTORIUMI</option>
                                    </select>
                                </div>
                            </div>

                            <div class="modeChoice4_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="modeChoice4" id="mode_choice_4" style="display: block;">
                                    <option value="C40">NUSTATYTI VEIKSM≈≤ KIEKƒÆ</option>
                                    <option value="C39">NUSTATYTI LAIKO TRUKMƒò</option>
                                </select>
                            </div>

                            <div class="timer-question-number-div">
                                <div class="timer-input-div" id="timer-input-div" style="display: none;">
                                    <div class="input-group">
                                        <div class="input-wrapper">
                                            <button class="control-btn" 
                                                    onmousedown="startHold('timer-input', 1, 60, false)"
                                                    onmouseup="stopHold()"
                                                    onmouseleave="stopHold()"
                                                    ontouchstart="event.preventDefault(); startHold('timer-input', 1, 60, false)"
                                                    ontouchend="stopHold()"
                                                    ontouchcancel="stopHold()">‚àí</button>
                                            <input type="number" class="timer-input" id="timer-input" min="1" max="60" step="1" value="5" readonly>
                                            <button class="control-btn" 
                                                    onmousedown="startHold('timer-input', 1, 60, true)"
                                                    onmouseup="stopHold()"
                                                    onmouseleave="stopHold()"
                                                    ontouchstart="event.preventDefault(); startHold('timer-input', 1, 60, true)"
                                                    ontouchend="stopHold()"
                                                    ontouchcancel="stopHold()">+</button>
                                        </div>
                                        <h3 class="timer-choice-label">minutes</h3>
                                    </div>
                                </div>
                                <div class="question-number-input-div" id="question-number-input-div">
                                    <div class="input-group">
                                        <div class="input-wrapper">
                                            <button class="control-btn" 
                                                    onmousedown="startHold('question-number-input', 1, 200, false)"
                                                    onmouseup="stopHold()"
                                                    onmouseleave="stopHold()"
                                                    ontouchstart="event.preventDefault(); startHold('question-number-input', 1, 200, false)"
                                                    ontouchend="stopHold()"
                                                    ontouchcancel="stopHold()">‚àí</button>
                                            <input type="number" class="question-number-input" id="question-number-input" min="1" max="200" step="1" value="20" readonly>
                                            <button class="control-btn" 
                                                    onmousedown="startHold('question-number-input', 1, 200, true)"
                                                    onmouseup="stopHold()"
                                                    onmouseleave="stopHold()"
                                                    ontouchstart="event.preventDefault(); startHold('question-number-input', 1, 200, true)"
                                                    ontouchend="stopHold()"
                                                    ontouchcancel="stopHold()">+</button>
                                        </div>
                                        <h3 class="answer-number-label">veiksm≈≥</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="student-task-history-container" style="display: none;">
                            <div class="task-history-container">
                                <div class="task-history-controls">
                                    <div class="task-history-metrics" id="taskHistoryMetrics">
                                        <!-- Buttons will be added dynamically -->
                                    </div>
                                    
                                    <div class="task-history-date-selector">
                                        <div class="task-history-date-group">
                                            <label class="task-history-date-label">Prad≈æios data</label>
                                            <input type="date" class="task-history-date-input" id="taskHistoryStartDate">
                                        </div>
                                        <div class="task-history-date-group">
                                            <label class="task-history-date-label">Pabaigos data</label>
                                            <input type="date" class="task-history-date-input" id="taskHistoryEndDate">
                                        </div>
                                    </div>
                                </div>

                                <div class="task-history-chart-wrapper">
                                    <canvas id="taskHistoryChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Student Task Info Container -->
                        <div id="student-task-info-container">
                            <div id="student-task-info-container-inner">
                                <div class="task-info-holder">
                                    <div id="student-task-student-name"></div>
                                    <div id="student-task-student-email"></div>
                                    <div class="student-statistic-top-section">
                                    <div id="student-task-student-knowledge-level"></div>
                                    <div id="student-task-student-performance-mean"></div>
                                    <div id="student-task-student-consistency-mean"></div>
                                    <div id="student-stats-graph-holder" style="display: none;">
                                        <div class="student-statistics-label">Mokinio ilgalaikƒó statistika</div>
                                        <div class="filter-section">
                                            <div class="button-group" id="subjectButtons"></div>
                                        </div>
                                        
                                        <div class="filter-section-metrics">
                                            <div class="button-group-metrics" id="metricButtons"></div>
                                        </div>
                                        
                                        <div class="chart-container">
                                            <div class="chart-body scroll-indicators-horizontal" id="chartBody">
                                                <div class="chart-scrollable">
                                                    <canvas id="statsChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                    <div id="student-task-group-and-status-indicator">
                                        <div id="student-task-group"></div>
                                        <div id="student-task-status-indicator"></div>
                                    </div>
                                    <div class="col-12" id="student-task-completion-date"></div>
                                    <div class="col-12" id="student-statistics-completed-tasks" style="display: none;"></div>

                                    <div id="student-statistics-math" style="display: none;">
                                        <div class="student-statistics-title">Matematika</div>
                                        <div class="col-12" id="student-statistics-math-error-frequency"></div>
                                    </div>

                                    <div class="col-12" id="student-score-duration"></div>
                                    <div class="col-12" id="student-score-asnwer-number"></div>
                                    <div class="col-12" id="student-score-mistake-number"></div>
                                    <div class="col-12" id="text-comprehension-mistakes-summary"></div>

                                    <div id="mistakes-summary-math" style="display: none;">
                                        <div id="mistakes-table-title-math" class="task-info-subtitle">Da≈æniausios skaiƒçiavimo klaidos:</div>
                                        <div class="summary-inner-container">
                                            <div class="col-12 table-container">
                                                <div id="summary-table"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="student-statistics-lang-grammar" style="display: none;">
                                        <div class="student-statistics-title">Lietuvi≈≥ kalba</div>
                                        <div class="student-statistics-subtitle">Ra≈°yba</div>
                                        <div class="col-12" id="student-statistics-grammar-error-frequency"></div>
                                    </div>

                                    <div id="mistakes-summary-grammar" style="display: none;">
                                        <div id="mistakes-table-title-grammar" class="task-info-subtitle">Da≈æniausios ra≈°ybos klaidos:</div>
                                        <div class="summary-inner-container">
                                            <div class="col-12 table-container">
                                                <div id="summary-table-grammar"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="sentence-with-mistake-field"></div>

                                    <div id="student-statistics-lang-text-comprahension" style="display: none;">
                                        <div class="student-statistics-subtitle" id="student-statistics-lang-text-comprahension-komponavimas" style="display: none;">Turinio komponavimas</div>
                                        <div class="col-12" id="student-statistics-komponavimas-error-frequency"></div>
                                        <div class="col-12" id="student-statistics-komponavimas-completed-texts"></div>
                                        <div class="student-statistics-subtitle" id="student-statistics-lang-text-comprahension-isdestymas" style="display: none;">Strukt≈´ros i≈°dƒóstymas</div>
                                        <div class="col-12" id="student-statistics-isdestymas-error-frequency"></div>
                                        <div class="col-12" id="student-statistics-isdestymas-completed-texts"></div>
                                    </div>

                                    <div id="task-description-outer-container">
                                        <div id="task-description-title" class="task-info-subtitle" style="display: none;">U≈æduoties apra≈°ymas:</div>
                                        <div id="task-description"></div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="txt-browser-wrapper">
        <div class="txt-browser-main-header" id="mainBrowserHeader">
            <h2 class="txt-browser-main-title">Tekst≈≥ Nar≈°yklƒó</h2>
            <span class="txt-browser-main-icon collapsed" id="mainBrowserIcon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
                    <path d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"/>
                </svg>
            </span>
        </div>
        
        <div class="txt-browser-content" id="mainBrowserContent">
            <div>
            <div class="txt-viewer-container">
                <div class="txt-viewer-sticky-header">
                    <input 
                        type="text" 
                        class="txt-viewer-search-input" 
                        id="searchInput" 
                        placeholder="Ie≈°koti pagal ID, pavadinimƒÖ, autori≈≥ ar tekstƒÖ..."
                        autocomplete="off"
                    >

                    <div class="txt-viewer-all-filters-wrapper">
                        <div class="txt-viewer-all-filters-header" id="allFiltersHeader">
                            <span>Filtrai</span>
                            <span class="txt-viewer-all-filters-icon" id="allFiltersIcon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
                                <path d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"/>
                            </svg>                            
                        </span>
                        </div>
                        <div class="txt-viewer-all-filters-content txt-viewer-collapsed" id="allFiltersContent">
                            <div class="txt-viewer-filter-group">
                                <div class="txt-viewer-filter-label">Klasƒó</div>
                                <div class="txt-viewer-filter-options">
                                    <div class="txt-viewer-filter-option">
                                        <input type="checkbox" id="class_1_2" checked onchange="applyFilters()">
                                        <label for="class_1_2">1-2 klasƒó</label>
                                    </div>
                                    <div class="txt-viewer-filter-option">
                                        <input type="checkbox" id="class_3_4" checked onchange="applyFilters()">
                                        <label for="class_3_4">3-4 klasƒó</label>
                                    </div>
                                </div>
                            </div>

                            <div class="txt-viewer-filter-group">
                                <div class="txt-viewer-filter-label">U≈æduoties tipas</div>
                                <div class="txt-viewer-filter-options">
                                    <div class="txt-viewer-filter-option">
                                        <input type="checkbox" id="task_struktura" checked onchange="applyFilters()">
                                        <label for="task_struktura">Strukt≈´ros i≈°dƒóstymas</label>
                                    </div>
                                    <div class="txt-viewer-filter-option">
                                        <input type="checkbox" id="task_komponavimas" checked onchange="applyFilters()">
                                        <label for="task_komponavimas">Turinio komponavimas</label>
                                    </div>
                                </div>
                            </div>

                            <div class="txt-viewer-filter-group">
                                <div class="txt-viewer-filter-label">Sudƒótingumas</div>
                                <div class="txt-viewer-filter-options">
                                    <div class="txt-viewer-filter-option">
                                        <input type="checkbox" id="diff_lengvas" checked onchange="applyFilters()">
                                        <label for="diff_lengvas">Lengvas</label>
                                    </div>
                                    <div class="txt-viewer-filter-option">
                                        <input type="checkbox" id="diff_vidutinis" checked onchange="applyFilters()">
                                        <label for="diff_vidutinis">Vidutinis</label>
                                    </div>
                                    <div class="txt-viewer-filter-option">
                                        <input type="checkbox" id="diff_sunkus" checked onchange="applyFilters()">
                                        <label for="diff_sunkus">Sunkus</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="txt-viewer-selected-ids-container-outer">
                <div class="txt-viewer-selected-ids-container hide-scrollbar scroll-indicators" id="selectedIdsContainer">
                    <div class="txt-viewer-selected-ids-label">Pasirinkti tekstai:</div>
                    <div class="txt-viewer-selected-ids-list" id="selectedIdsList"></div>
                </div>
                </div>

                <div class="txt-viewer-texts-list" id="textsList">
                    <div class="txt-viewer-no-results">Kraunama...</div>
                </div>
            </div>
            </div>
        </div>
    </div>


                    </div>
                </div>
            </aside>

            <button class="toggle-tab" id="toggleTab" aria-label="Toggle sidebar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </button>
        </div>
    </div>

<!-- STUDENT GUI -->
<div id="student-gui" style="display: none;">

        <!-- LEFT SIDE: Student List (always visible) -->
    <div class="left-side-bar">
        <div class="left-side-bar-inner">
                <div id="student-button-holder-outer">
                <div class="student-button-holder">
                    <!-- Action buttons that transform -->
                    <div id="student-action-buttons-container">
                        <button id="frequent-mistakes-btn" class="student-action-btn" onclick="displayFrequentMistakes()">
                            <span class="btn-label">Paskutinƒós klaidos</span>
                        </button>
                    </div>
                </div>
        </div>

        <div class="" id="student-tasks-list-outer-container">
            <div class="align-items-center justify-content-start" id="student-task-for-students-title-container">
                <div id="task-list-title-for-students"></div>
            </div>
            <div id="student-task-list-container">
            <div id="student-tasks-list"></div>
            </div>
        </div>

        </div>
    </div>


<div class="sidebar-wrapper" id="sidebarWrapperStudent">
    <aside class="sidebar hide-scrollbar-mobile" id="sidebarStudent">
        <div class="sidebar-content" id="sidebarContentStudent">

        <!-- RIGHT SIDE: Task Info (collapsible on mobile) -->
        <div class="" id="dynamic-student-content">
            <div id="task-info-container-for-students">
                <div id="student-task-info-container-inner">
                    <div class="task-info-holder-student">
                        <div id="student-task-group-and-status-indicator">
                            <div id="student-task-group-for-student"></div>
                            <div id="student-task-status-indicator-for-student"></div>
                        </div>
                        <div class="col-12" id="student-task-completion-date-for-students"></div>
                        <div class="col-12" id="student-score-duration-for-student"></div>
                        <div class="col-12" id="student-score-asnwer-number-for-student"></div>
                        <div class="col-12" id="student-score-mistake-number-for-student"></div>

                        <div id="mistakes-summary-math-for-student" style="display: none;">
                            <div id="mistakes-table-title-math-for-students" class="task-info-subtitle">Da≈æniausios skaiƒçiavimo klaidos:</div>
                            <div class="summary-inner-container">
                                <div class="table-container">
                                    <div id="summary-table-for-student"></div>
                                </div>
                            </div>
                        </div>

                        <div id="mistakes-summary-grammar-for-student" style="display: none;">
                            <div id="mistakes-table-title-grammar-for-student" class="task-info-subtitle">Da≈æniausios ra≈°ybos klaidos:</div>
                            <div class="summary-inner-container">
                                <div class="table-container">
                                    <div id="summary-table-grammar-for-student"></div>
                                </div>
                            </div>
                            <div id="sentence-with-mistake-field-for-student"></div>
                        </div>

                        <div id="task-description-outer-container-for-student">
                            <div id="task-description-title-for-student" class="task-info-subtitle" style="display: none;">U≈æduoties apra≈°ymas:</div>
                            <div id="task-description-for-student"></div>
                        </div>
                    </div>
                    <div class="complete-task-holder" style="display: none;">
                        <div class="coin-display-holder"></div>
                        <button id="complete-task-button" class="" onclick="completeTask()">Atlikti u≈æduotƒØ</button>
                    </div>

                    <div id="frequent-mistakes-container" style="flex-direction: column; justify-content: space-between;" hidden>
                    <div class="row d-flex align-items-start">
                        <div class="mistakes-summary-forstudents-title">
                            Paskutinƒós klaidos
                        </div>
                    </div>

                    <div id="mistakes-summary-math">
                    <div class="summary-choices-button-holder">
                    <button class="display-summary-button active-summary-button" onclick="displayMathSummary()" id="display-math-summary-button">Matematika</button>
                    <button class="display-summary-button" onclick="displayGrammarSummary()" id="display-grammar-summary-button">Ra≈°yba</button>
                    </div>
                    <div class="summary-table-frequent-mistakes-outer-div">
                        <div id="summary-table-outer-div" class="">
                            <div class="table-container" id="table-container-math">
                                <div id="summary-table-frequent-mistakes"></div>
                            </div>
                        </div>
                        </div>

                        <div id="mistakes-summary-grammar" class="summary-table-frequent-mistakes-outer-div">
                        <div id="summary-table-grammar-outer-div" class="" style="display: none;">
                            <div class="table-container" id="table-container-grammar">
                                <div id="summary-table-grammar-frequent-mistakes"></div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
                </div>










            </div>
        </div>
        </div>
        </aside>
                    <button class="toggle-tab" id="toggleTabStudent" aria-label="Toggle sidebar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </button>
        </div>
        
</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="../mental-arithmetic.js"></script>
	<script src="../mental-arithmetic-combinations.js"></script>
    <script src="../parameter_dictionary.js"></script>
    <script src="../main-nav-bar.js"></script>
    <script src="matematika_options.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

	<script>
        const redCircleColorCode = '#D57E7E';
        const greenCircleColorCode = '#40c9a9';

        if (!userData) {
            window.location.href = './';
        }

        let chart = null;

        let studentList;
        let tasksList;
        let currentTaskId;
        let currentTaskInstructions;
        let currentTaskDuration;
        let studentListDiv = document.getElementById('student-list')
        let addingNewTask = false;
        let deletingTask = false;
        let deletingStudent = false;
        let browsingHistory = false;
        let showingSelectAllCheckbox = false;
        let taskContainerVisible = true;
        let changingTeacher = false;
        let classScoreMedian;
        let classConsistencyMedian;
        const teacherGUI = document.getElementById('teacher-gui');
        const studentGUI = document.getElementById('student-gui');
        let studentTasksList = document.getElementById('student-tasks-list')
        let taskInfoContainerForStudents = document.getElementById('task-info-container-for-students')
        const newTaskButton = document.getElementById('new-task-button');
        const deleteTaskButton = document.getElementById('delete-task-button');
        const teacherMessageLine = document.getElementById('teacher-message-line');
        const teacherDataRetrievalMessage = document.getElementById('teacher-data-retrieval-message');
        const teacherMessageLine2 = document.getElementById('teacher-message-line-2');
        const newTaskOptions = document.getElementById('new-task-options-container');
        const studentTaskInfoContainer = document.getElementById('student-task-info-container');
        const studentTaskStudentName = document.getElementById('student-task-student-name');
        const studentTaskStudentEmail = document.getElementById('student-task-student-email');
        const studentTaskGroup = document.getElementById('student-task-group');

        const studentTaskStatus = document.getElementById('student-task-status');
        const studentScoreAnswerNumber = document.getElementById('student-score-asnwer-number');
        const studentScoreMistakeNumber = document.getElementById('student-score-mistake-number');

        const textComprehensionMistakesSummary = document.getElementById('text-comprehension-mistakes-summary');

        const studentScoreDuration= document.getElementById('student-score-duration');
        const studentScoreDurationForStudent = document.getElementById('student-score-duration-for-student');

        let dynamicStudentContent = document.getElementById('dynamic-student-content');

        let taskGroupForStudents = document.getElementById('task-group-for-students');
        let taskStatusForStudents = document.getElementById('task-status-for-students');

        const deleteStudentButton = document.getElementById('delete-student-button');
        const confirmDeleteStudentButton = document.getElementById('confirm-delete-student-button');

        const taskHistoryBrowserButton = document.getElementById('browse-task-history-button');

        const studentListTitle = document.getElementById('student-list-title-container');
        const studentListSelectAllCheckbox = document.getElementById('student-list-header-checkbox-container');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');

        const teacherDispalyStudentTaskIndicator = document.getElementById('student-task-status-indicator');
        const mistakesSummaryTable = document.querySelector('#summary-table');

        const taskDescriptionTitle = document.querySelector('#task-description-title');
        const taskDescription = document.querySelector('#task-description');

        const studentTaskGroupForStudent = document.getElementById('student-task-group-for-student');
        const studentScoreAnswerNumberForStudent = document.getElementById('student-score-asnwer-number-for-student');
        const studentScoreMistakeNumberForStudent = document.getElementById('student-score-mistake-number-for-student');
        const taskDescriptionForStudent = document.querySelector('#task-description-for-student');
        const teacherDispalyStudentTaskIndicatorForStudent = document.getElementById('student-task-status-indicator-for-student');
        const taskListTitleForStudents = document.getElementById('task-list-title-for-students');
        const expandStudentInfoButton = document.getElementById('expand-student-info-button')

        const completeTaskButton = document.getElementById('complete-task-button');
        const completeTaskButtonHolder = document.querySelector('.complete-task-holder');

        const frequentMistakeContainerElement = document.getElementById("frequent-mistakes-container");

        enableTeacherControlPannel();
        enableNewTaskContainer();
        document.querySelectorAll('.item-to-be-disabled-while-talking-to-server').forEach(el => el.disabled = false);

        function toggleStudentListLabel() {
            showingSelectAllCheckbox = !showingSelectAllCheckbox
            const dropdown = document.getElementById("task-group-sorting");
            if (showingSelectAllCheckbox && ! browsingHistory) {
                studentListTitle.style.display = "none"
                studentListSelectAllCheckbox.style.display = "flex"
                selectAllCheckbox.checked = false
            } else {
                studentListTitle.style.display = "flex"
                studentListSelectAllCheckbox.style.display = "none"
                selectAllCheckbox.checked = false
            }
        }

        document.getElementById('select-all-checkbox').addEventListener('change', function () {
            const checkboxes = document.querySelectorAll('#student-list input[type="checkbox"]');

            checkboxes.forEach(checkbox => {
                if (getComputedStyle(checkbox).visibility !== 'hidden') {
                    checkbox.checked = this.checked;
                }
            });
        });

        function toggleDeleteStudent() {
            deletingStudent = !deletingStudent
            const dropdown = document.getElementById("task-group-sorting");
            toggleStudentListLabel();
            clearTaskInfoContainer();
            if (deletingStudent) {
                // Set the selected option to "Visos u≈æduoƒçi≈≥ grupƒós"
                dropdown.value = "Visos u≈æduoƒçi≈≥ grupƒós";
                // Manually trigger the change event
                dropdown.dispatchEvent(new Event("change"));
                dropdown.disabled = true;
                taskContainerVisible = true;
                toggleTaskVisibility()

                document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                checkbox.style.visibility = "visible";
                checkbox.disabled = false;
            });
            } else {
                taskContainerVisible = false;
                toggleTaskVisibility()
                document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                checkbox.style.visibility = "hidden";
                checkbox.checked = false;
            });
                dropdown.disabled = false;
            }
        }

        async function deleteStudents() {
            let studentsToRemove = [];
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                if (checkbox.checked) {
                    studentsToRemove.push(parseInt(checkbox.value));
                }
            });
            
            if (studentsToRemove.length === 0) {
                messageToTheUser("Pasirinkite bent vienƒÖ mokinƒØ pa≈°alinimui!");
                return
            }

            const studentIdsBeingRemoved = studentsToRemove.map(id => parseInt(id));
    
            // Find matching students and collect assignmentIds
            const assignmentIds = [];
            
            studentList.forEach(student => {
                if (studentIdsBeingRemoved.includes(student.id)) {
                    student.tasks.forEach(task => {
                        assignmentIds.push(task.assignmentId);
                    });
                }
            });

            disableTeacherControlPannel();

            deletingTask = true
            await deleteTasks(assignmentIds)

            disableConfirmationButtons();
            try {
                // Prepare the list of tasks to delete (assuming tasksToTemove is already populated)
                const studentsToDelete = studentsToRemove;  // Ensure this array holds task IDs to be deleted

                const response = await apiFetch(apiBase + 'students', {
                    method: 'DELETE',  // Change to DELETE method
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ studentIds: studentsToDelete })  // Send the list as JSON in the body
                });

                if (!response) {
                    return;
                }

                if (!response.ok) {
                    const errorData  = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }

                // Optionally, handle the response if needed (e.g., confirm deletion or update the UI)
                const result = await response.json().catch(() => ({}));
                if (result.message === "Student removal successful.") {
                    fetchDataForTeachers()
                    messageToTheUser("Mokini≈≥ ≈°alinimas sƒókmingas.", false);
                } 

            } catch (error) {
                console.log('Error deleting tasks:', error);
                if (error.message === "Unauthorized") {
                    clearUserData();
                    window.location.href = "prisijungimas";
                } else {
                    messageToTheUser('Nepavyko pa≈°alinti mokini≈≥. Bandykite vƒól vƒóliau.');
                }
            } finally {
                enableTeacherControlPannel();
                showingSelectAllCheckbox = true;
                toggleDeleteStudent() 
                clearTaskInfoContainer();
                hideConfirmationButtons();
            }
        }


        function clearTaskInfoContainer() {
            studentTaskStudentName.innerHTML = '';
            studentTaskStudentEmail.innerHTML = '';
            studentTaskGroup.innerHTML = '';
            studentScoreAnswerNumber.innerHTML = '';
            studentScoreMistakeNumber.innerHTML = '';
            mistakesSummaryTable.innerHTML = '';
            taskDescription.innerHTML = '';
            taskDescriptionTitle.style.display = "none"
            teacherDispalyStudentTaskIndicator.style.display = "none"
            studentStatisticsCompletedTasks.innerHTML = '';
            studentStatisticsCompletedTasks.style.display = "none";
            studentStatisticsKnowledgeLevel.innerHTML = '';
            studentStatisticsKnowledgeLevel.style.display = "none";
            studentStatisticsPerformanceMean.innerHTML = '';
            studentStatisticsPerformanceMean.style.display = "none";
            studentStatisticsConsistencyMean.innerHTML = '';
            studentStatisticsConsistencyMean.style.display = "none";
            studentStatisticsMathDiv.style.display = "none";
            studentStatisticsMathErrorFrequency.innerHTML = '';
            studentStatisticsLangDiv.style.display = "none";
            studentStatisticsGrammarErrorFrequency.innerHTML = '';
            studentStatisticsTextComprahensionDiv.style.display = "none";
            studentStatisticsKomponavimasErrorFrequency.innerHTML = '';
            studentStatisticsIsdestymasErrorFrequency.innerHTML = '';
            document.querySelector("#mistakes-summary-math").style.display = "none";
            document.querySelector("#mistakes-summary-grammar").style.display = "none";
            studentStatisticsTextComprahensionIsdestymasTitle.style.display = "none";
            studentStatisticsTextComprahensionKomponavimasTitle.style.display = "none";
            studentTaskCompletionDate.innerHTML = '';
            document.querySelector("#summary-table-grammar").innerHTML = "";
            document.querySelector("#summary-table").innerHTML = "";
            document.querySelector("#sentence-with-mistake-field").innerHTML = "";
            textComprehensionMistakesSummary.innerHTML = "";
            studentScoreDuration.innerHTML = "";
            studentStatisticsIsdestymasCompletedTexts.innerHTML = "";
            studentStatisticsKomponavimasCompletedTexts.innerHTML = "";
            document.querySelector("#subjectButtons").innerHTML = '';
            document.querySelector("#metricButtons").innerHTML = '';
            document.querySelector("#student-stats-graph-holder").style.display = "none";
            if (chart) {
                chart.destroy();
            }
        }

        function clearTaskInfoContainerForStudents() {
            studentTaskGroupForStudent.innerHTML = '';
            studentScoreAnswerNumberForStudent.innerHTML = '';
            studentScoreMistakeNumberForStudent.innerHTML = '';
            document.querySelector("#summary-table-for-student").innerHTML = '';
            taskDescriptionForStudent.innerHTML = '';
            teacherDispalyStudentTaskIndicatorForStudent.style.display = "none"
            studentTaskCompletionDateForStudents.innerHTML = '';
            document.querySelector("#summary-table-grammar-for-student").innerHTML = "";
            document.querySelector("#summary-table-for-student").innerHTML = "";
            document.querySelector("#sentence-with-mistake-field-for-student").innerHTML = "";
            document.querySelector("#mistakes-table-title-grammar-for-student").innerHTML = "";
            document.querySelector("#mistakes-table-title-math-for-students").innerHTML = "";
            document.querySelector("#mistakes-summary-math-for-student").style.display = "none";
            document.querySelector("#mistakes-summary-grammar-for-student").style.display = "none";
            studentScoreDurationForStudent.innerHTML = "";
            document.querySelector("#frequent-mistakes-container").style.display = "none";
            document.querySelector('.task-info-holder-student').style.display = "none";
            completeTaskButtonHolder.style.display = "none";
        }

        let studentStatisticsCompletedTasks = document.querySelector("#student-statistics-completed-tasks");

        let studentStatisticsPerformanceMean = document.querySelector("#student-task-student-performance-mean");
        let studentStatisticsConsistencyMean = document.querySelector("#student-task-student-consistency-mean");
        let studentStatisticsKnowledgeLevel = document.querySelector("#student-task-student-knowledge-level");
        const studentStatisticsMathDiv = document.querySelector("#student-statistics-math");
        const studentStatisticsMathErrorFrequency = document.querySelector("#student-statistics-math-error-frequency");
        const studentStatisticsLangDiv = document.querySelector("#student-statistics-lang-grammar") 
        const studentStatisticsGrammarErrorFrequency = document.querySelector("#student-statistics-grammar-error-frequency");
        const studentStatisticsTextComprahensionDiv = document.querySelector("#student-statistics-lang-text-comprahension")
        const studentStatisticsKomponavimasErrorFrequency = document.querySelector("#student-statistics-komponavimas-error-frequency"); 
        const studentStatisticsIsdestymasErrorFrequency = document.querySelector("#student-statistics-isdestymas-error-frequency"); 

        const studentStatisticsKomponavimasCompletedTexts = document.querySelector("#student-statistics-komponavimas-completed-texts"); 
        const studentStatisticsIsdestymasCompletedTexts = document.querySelector("#student-statistics-isdestymas-completed-texts"); 

        const studentStatisticsTextComprahensionIsdestymasTitle = document.querySelector("#student-statistics-lang-text-comprahension-isdestymas")
        const studentStatisticsTextComprahensionKomponavimasTitle = document.querySelector("#student-statistics-lang-text-comprahension-komponavimas")

        const studentTaskCompletionDate = document.querySelector("#student-task-completion-date")
        const studentTaskCompletionDateForStudents = document.querySelector("#student-task-completion-date-for-students")
        
        function calculateAverageStudentsConsistency(stats) {
            if (!stats.c || stats.c.length === 0) return 0;

            const avg = stats.c.reduce((sum, val) => sum + val, 0) / stats.c.length;
            return +(avg * 100).toFixed(2);
        }

        function calculateAverageStudentScore(stats) {
            const validKeys = Object.keys(stats).filter(k => !['c', 'd'].includes(k));
            let ratios = [];

            for (const key of validKeys) {
                for (const sub of stats[key]) {
                if (Array.isArray(sub) && sub.length >= 4) {
                    const points = sub[0];
                    ratios.push(points);
                }
                }
            }

            if (ratios.length === 0) return 0;
            return (ratios.reduce((a, b) => a + b, 0) / ratios.length).toFixed(2);
        }

        const statTypesKeys = {
            "c": "nuoseklumas",
            "m": "matematika",
            "t": "teksto suvokimas",
            "g": "ra≈°yba",
        }

        const statKeys = {
            0: "ta≈°kai",
            1: "teisingi atsakymai",
            2: "klaidos",
            3: "atsakyti klausimai"
        }

        const statsToBeExpressedAsPercetnge = [1, 2];

function transformStudentStats(stats) {
  const result = {};

    if (stats.d) {
        studentStatisticsLastRecord = stats.d
    }

  // Handle "c" as a list of percentages
  if (stats.c) {
    result.c = {
      title: statTypesKeys.c,
      values: stats.c.map(val => +(val * 100).toFixed(2))
    };
  }

  // Handle other keys
  for (const [key, sublists] of Object.entries(stats)) {
    if (key === "c" || key === "d") continue;

    const subjectTitle = statTypesKeys[key] || key;
    const valuesObj = {};

    // Initialize entries for each metric
    Object.entries(statKeys).forEach(([i, metricTitle]) => {
      valuesObj[i] = { title: metricTitle, values: [] };
    });

    // Fill in values from sublists
    sublists.forEach((sub) => {
      const total = sub[3] ?? 0;

      sub.forEach((val, i) => {
        let value;

        if (i === 0 || i === 3) {
          // Absolute number, no division
          value = val;
        } else {
          // Calculate ratio (safe for 0 total)
          const ratio = total === 0 ? 0 : val / total;

          // Convert to percentage if needed
          value = statsToBeExpressedAsPercetnge.includes(Number(i))
            ? +(ratio * 100).toFixed(2)
            : +ratio.toFixed(2);
        }

        valuesObj[i].values.push(value);
      });
    });

    result[key] = { title: subjectTitle, values: valuesObj };
  }

  return result;
}

let studentStatisticsLastRecord;

        function displayStudentStatistics(student, studentTasks) {
            const processedStudentStats = transformStudentStats(student[3]);
            const averageStudentScore = calculateAverageStudentScore(student[3]);
            const averageStudentConsistency = calculateAverageStudentsConsistency(student[3]);
            function processStudentTasks(studentTasks) {
                // Initialize the result objects
                const mathTasks = [[0, 0], []];
                const grammarTasks = [[0, 0], []];
                const komponavimasTasks = [[0, 0], []];
                const isdestymasTasks = [[0, 0], []];

                // Filter tasks with status true
                const filteredTasks = studentTasks.filter(task => task.status);

                for (const task of filteredTasks) {
                    try {
                        const taskDesc = JSON.parse(task.taskDescription);
                        const result = JSON.parse(task.result);

                        if (taskDesc[0] === "math") {
                            // Process math tasks
                            mathTasks[0][0] += result[0][0];
                            mathTasks[0][1] += result[0][1];
                            mathTasks[1].push(...result[1]);
                        } else if (taskDesc[0] === "lang") {
                            if (taskDesc[1] === "C83") {
                                // Process grammar tasks
                                grammarTasks[0][0] += result[0][0];
                                grammarTasks[0][1] += result[0][1];
                                grammarTasks[1].push(...result[1]);
                            } else if (taskDesc[1] === "C49") {
                                if (taskDesc[2] === "C51") {
                                    // Process komponavimas tasks
                                    komponavimasTasks[0][0] += result[0][0];
                                    komponavimasTasks[0][1] += result[0][1];
                                    komponavimasTasks[1].push([[...result[1]], task.completionDate.split("T")[0]]);
                                } else if (taskDesc[2] === "C52") {
                                    // Process isdestymas tasks
                                    isdestymasTasks[0][0] += result[0][0];
                                    isdestymasTasks[0][1] += result[0][1];
                                    isdestymasTasks[1].push([[...result[1]], task.completionDate.split("T")[0]]);
                                }
                            }
                        }
                    } catch (error) {
                        // Skip tasks with invalid taskDescription or result format
                        console.error("Error processing task:", error);
                        continue;
                    }
                }

                    return {
                        math: mathTasks,
                        grammar: grammarTasks,
                        komponavimas: komponavimasTasks,
                        isdestymas: isdestymasTasks
                    };
            }

            function countTaskStatuses(studentTasks, category = null) {
                let trueCount = 0;
                let falseCount = 0;
                let filteredTasks = studentTasks;

                if (category) {
                    filteredTasks = studentTasks.filter(task => {
                        try {
                            const taskDesc = JSON.parse(task.taskDescription);
                            // Check for different possible category locations
                            return taskDesc.some(item => item === category);
                        } catch (e) {
                            console.error("Error parsing taskDescription:", e);
                            return false;
                        }
                    });
                }

                const total = filteredTasks.length;

                for (const task of filteredTasks) {
                    if (task.status === true) {
                        trueCount++;
                    } else if (task.status === false) {
                        falseCount++;
                    }
                }

                return {
                    total: total,
                    completed: trueCount,
                    pending: falseCount,
                };
            }

        clearTaskInfoContainer();
        studentTaskStudentName.innerHTML = `
            <span class="student-name-id-holder"><span id="student-name">${student[1]}</span><span id='student-id'>(ID: ${student[0]})</span></span>
            <button class="edit-name-button" onclick="editStudentName('${student[0]}', this)">
                <span class="edit-icon">
                <img src="../images/icons/icon-edit.svg">
                </span>
            </button>
            `;
        studentTaskStudentEmail.innerHTML = student[4];

        const knowledgeOptions = [
            { value: -1, label: "Nustatykite lygƒØ", hidden: true }, // placeholder, shown only if -1
            { value: 0, label: "Prie≈°mokyklinis" },
            { value: 1, label: "1 klasƒó" },
            { value: 2, label: "2 klasƒó" },
            { value: 3, label: "3 klasƒó" },
            { value: 4, label: "4 klasƒó" },
            { value: 5, label: "Auk≈°tesnis" },
        ];

        // Build the dropdown
        let selectHTML = `<div class="categories-dropdown-holder">
            <div class="knowledge-level-select-text">≈Ωini≈≥ lygis</div>
            <select id="knowledge-level-select">
                ${knowledgeOptions.map(opt => `
                    <option value="${opt.value}" ${opt.hidden ? "hidden" : ""}>${opt.label}</option>
                `).join("")}
            </select>
        </div>`;

        studentStatisticsKnowledgeLevel.innerHTML = selectHTML;
        studentStatisticsKnowledgeLevel.style.display = "block";

        studentStatisticsPerformanceMean.innerHTML = `<div class="student-points-holder"><div class="student-points-label">Ta≈°kai</div> <div class="student-points">${averageStudentScore} (${classScoreMedian})</div></div>`;
        studentStatisticsPerformanceMean.style.display = "block";

        studentStatisticsConsistencyMean.innerHTML = `<div class="student-points-holder"><div class="student-consistency-label">Nuoseklumas</div> <div class="student-points">${averageStudentConsistency}% (${classConsistencyMedian}%)</div></div>`;
        studentStatisticsConsistencyMean.style.display = "block";

        const knowledgeSelect = document.getElementById("knowledge-level-select");

        // Preselect based on DB value
        if (student[2] !== undefined) {
            knowledgeSelect.value = student[2];
        }

        // Event listener to update when changed
        knowledgeSelect.addEventListener("change", async (e) => {
            const newValue = parseInt(e.target.value, 10);
            if (newValue !== student[2]) {
                try {
                    const response = await apiFetch(apiBase + `students/knowledge-level`, {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            studentId: Number(student[0]),
                            knowledgeLvl: Number(newValue)
                        })
                    });

                    if (!response) {
                        return;
                    }

                    if (!response.ok) {
                        throw new Error("Nepavyko atnaujinti lygio");
                    }

                    const data = await response.json();
                    student[2] = data.knowledgeLvl; // update local student object
                    messageToTheUser("≈Ωini≈≥ lygis sƒókmingai atnaujintas!", false);
                } catch (error) {
                    console.error("Error updating knowledge level:", error);
                    messageToTheUser("Nepavyko atnaujinti ≈æini≈≥ lygio. Bandykite vƒóliau vƒól");
                }
            }
        });

        // STATS PART START

        var lithuanianMonths = ['Saus.', 'Vas.', 'Kov.', 'Bal.', 'Geg.', 'Bir≈æ.', 'Liep.', 'Rugp.', 'Rugs.', 'Spal.', 'Lap.', 'Gruod.'];
        
        var metricColors = ['#286D8A', '#32ac93', '#e74c3c', '#F28C28', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
        
        var selectedSubject = null;
        var selectedMetrics = [];
        var availableMetrics = [];
        var previousDatasets = [];

        function getPreviousMonday(date) {
            var d = new Date(date);
            var day = d.getDay();
            var diff = day === 0 ? 6 : day - 1;
            d.setDate(d.getDate() - diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function generateMondayDates(count) {
            var dates = [];
            var today = new Date();

            var currentMonday = getPreviousMonday(today);

            if (studentStatisticsLastRecord) {
                var lastDataDate = new Date((studentStatisticsLastRecord) * 24 * 60 * 60 * 1000);
                var lastDataMonday = getPreviousMonday(lastDataDate);
                currentMonday = lastDataMonday;
            }
            
            for (var i = 0; i < count; i++) {
                dates.push(formatLithuanianDate(currentMonday));
                currentMonday.setDate(currentMonday.getDate() - 7);
            }
            
            return dates.reverse();
        }

        function formatLithuanianDate(date) {
            var day = date.getDate();
            var month = lithuanianMonths[date.getMonth()];
            return month + ' ' + day;
        }

        function isPercentageMetric(metricTitle) {
            var lower = metricTitle.toLowerCase();
            return lower.indexOf('atsakym') !== -1 || lower.indexOf('klaid') !== -1 || lower.indexOf('nuosekl') !== -1;
        }

        function extractMetricsFromData() {
            var metrics = [];
            var keys = Object.keys(processedStudentStats);
            
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                if (key === 'c') continue;
                
                var subjectValues = processedStudentStats[key].values;
                if (typeof subjectValues === 'object' && !Array.isArray(subjectValues)) {
                    var metricKeys = Object.keys(subjectValues);
                    for (var j = 0; j < metricKeys.length; j++) {
                        var metricKey = metricKeys[j];
                        var metricData = subjectValues[metricKey];
                        var isPercent = isPercentageMetric(metricData.title);
                        
                        var existing = false;
                        for (var k = 0; k < metrics.length; k++) {
                            if (metrics[k].id === metricKey && metrics[k].title === metricData.title) {
                                existing = true;
                                break;
                            }
                        }
                        
                        if (!existing) {
                            metrics.push({
                                id: metricKey,
                                title: metricData.title,
                                type: isPercent ? 'percentage' : 'absolute',
                                color: metricColors[metrics.length % metricColors.length],
                                yAxisID: isPercent ? 'y-percent' : 'y-absolute-' + metricKey
                            });
                        }
                    }
                    break;
                }
            }
            
            return metrics;
        }

        function getAxisIdForAbsoluteMetric(metricId, allSelectedMetrics, subjectData) {
            if (!subjectData || !subjectData.values || !subjectData.values[metricId]) {
                return 'y-absolute-' + metricId;
            }
            
            var currentValues = subjectData.values[metricId].values;
            var currentMax = Math.max.apply(null, currentValues);
            
            for (var i = 0; i < allSelectedMetrics.length; i++) {
                var otherId = allSelectedMetrics[i];
                if (otherId === metricId) continue;
                
                var otherMetric = null;
                for (var j = 0; j < availableMetrics.length; j++) {
                    if (availableMetrics[j].id === otherId && availableMetrics[j].type === 'absolute') {
                        otherMetric = availableMetrics[j];
                        break;
                    }
                }
                
                if (!otherMetric || !subjectData.values[otherId]) continue;
                
                var otherValues = subjectData.values[otherId].values;
                var otherMax = Math.max.apply(null, otherValues);
                
                var maxDiff = Math.abs(currentMax - otherMax);
                var largerMax = Math.max(currentMax, otherMax);
                var threshold = largerMax * 0.15;
                
                if (maxDiff <= threshold) {
                    var sharedId = parseInt(metricId) < parseInt(otherId) ? metricId : otherId;
                    return 'y-absolute-shared-' + sharedId;
                }
            }
            
            return 'y-absolute-' + metricId;
        }

        function selectSubject(key) {
            selectedSubject = key;
            
            if (key === 'c') {
                selectedMetrics = [];
            } else {
                if (selectedMetrics.length === 0 && availableMetrics.length > 0) {
                    selectedMetrics = [availableMetrics[0].id];
                }
            }
            
            var buttons = document.querySelectorAll('.btn-subject');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
                if (buttons[i].getAttribute('data-subject-key') === key) {
                    buttons[i].classList.add('active');
                }
            }
            
            updateMetricButtonsState();
            updateChart();
        }

        function updateMetricButtonsState() {
            var buttons = document.querySelectorAll('#metricButtons .btn-metric');
            var isConsistency = selectedSubject === 'c';
            
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].disabled = isConsistency;
                if (isConsistency) {
                    buttons[i].classList.remove('active');
                } else {
                    var metricId = buttons[i].getAttribute('data-metric-id');
                    if (selectedMetrics.indexOf(metricId) !== -1) {
                        buttons[i].classList.add('active');
                    } else {
                        buttons[i].classList.remove('active');
                    }
                }
            }

            var metricContainer = document.getElementById('metricButtons');
            var chartOuterContainer = document.querySelector('.chart-scrollable');
            var isMobile = window.matchMedia('(max-width: 578px)').matches;

            if (selectedSubject === 'c' && isMobile) {
                metricContainer.style.display = 'none';
                chartOuterContainer.style.minWidth = "0";
            } else {
                metricContainer.style.display = 'flex';
                chartOuterContainer.style.minWidth = "500px";
            }
        }

        function toggleMetric(id) {
            if (selectedSubject === 'c') return;
            
            var index = selectedMetrics.indexOf(id);
            if (index !== -1) {
                selectedMetrics.splice(index, 1);
            } else {
                selectedMetrics.push(id);
            }
            
            updateMetricButtonsState();
            updateChart();
        }

        function initializeButtons() {
            var subjectContainer = document.getElementById('subjectButtons');
            var metricContainer = document.getElementById('metricButtons');

            subjectContainer.innerHTML = '';
            metricContainer.innerHTML = '';
            
            availableMetrics = extractMetricsFromData();

            var keys = Object.keys(processedStudentStats);
            var firstKey = keys[0];
            
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                var data = processedStudentStats[key];
                var btn = document.createElement('button');
                btn.className = 'btn-subject';
                btn.textContent = data.title;
                btn.setAttribute('data-subject-key', key);
                btn.onclick = (function(k) {
                    return function() { selectSubject(k); };
                })(key);
                subjectContainer.appendChild(btn);
            }

            for (var j = 0; j < availableMetrics.length; j++) {
                var metric = availableMetrics[j];
                var btn2 = document.createElement('button');
                btn2.className = 'btn-metric';
                var badge = document.createElement('span');
                btn2.textContent = metric.title + ' ';
                btn2.setAttribute('data-metric-id', metric.id);
                btn2.onclick = (function(mid) {
                    return function() { toggleMetric(mid); };
                })(metric.id);
                metricContainer.appendChild(btn2);
            }
            
            if (firstKey) {
                selectSubject(firstKey);
            }
        }

        function getDataForSubject() {
            if (!selectedSubject) return null;
            
            var subject = processedStudentStats[selectedSubject];
            if (selectedSubject === 'c') {
                return { 
                    dates: generateMondayDates(subject.values.length), 
                    values: subject.values,
                    isConsistency: true
                };
            } else {
                var firstMetricKey = Object.keys(subject.values)[0];
                var firstMetric = subject.values[firstMetricKey];
                return { 
                    dates: generateMondayDates(firstMetric.values.length),
                    values: subject.values,
                    isConsistency: false
                };
            }
        }

        function updateChart() {
            if (chart) {
                chart.destroy();
                chart = null;
            }

            var subjectData = getDataForSubject();
            if (!subjectData) return;
            
            var datasets = [];
            var newDatasetLabels = [];

            if (subjectData.isConsistency) {
                var label = processedStudentStats.c.title;
                newDatasetLabels.push(label);
                
                var wasAlreadyShown = false;
                for (var p = 0; p < previousDatasets.length; p++) {
                    if (previousDatasets[p] === label) {
                        wasAlreadyShown = true;
                        break;
                    }
                }
                
                datasets.push({
                    label: label,
                    data: subjectData.values,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.3,
                    borderWidth: 3,
                    borderDash: [],
                    pointRadius: 4, // Smaller points for mobile
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 0,
                    pointHoverBorderWidth: 3,
                    pointStyle: 'circle',
                    yAxisID: 'y-percent',
                    animation: wasAlreadyShown ? false : {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    }
                });
            } else {
                for (var i = 0; i < selectedMetrics.length; i++) {
                    var metricId = selectedMetrics[i];
                    var metric = null;
                    for (var j = 0; j < availableMetrics.length; j++) {
                        if (availableMetrics[j].id === metricId) {
                            metric = availableMetrics[j];
                            break;
                        }
                    }
                    var metricData = subjectData.values[metricId];
                    
                    if (metric && metricData) {
                        var datasetLabel = metricData.title;
                        newDatasetLabels.push(datasetLabel);
                        
                        var wasShown = false;
                        for (var p = 0; p < previousDatasets.length; p++) {
                            if (previousDatasets[p] === datasetLabel) {
                                wasShown = true;
                                break;
                            }
                        }
                        
                        var yAxisId = metric.type === 'percentage' ? metric.yAxisID : getAxisIdForAbsoluteMetric(metricId, selectedMetrics, subjectData);
                        
                        datasets.push({
                            label: datasetLabel,
                            data: metricData.values,
                            borderColor: metric.color,
                            backgroundColor: metric.color + '20',
                            tension: 0.3,
                            borderWidth: 3,
                            borderDash: [],
                            pointRadius: 4, // Smaller points for mobile
                            pointHoverRadius: 6,
                            pointBackgroundColor: metric.color,
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 0,
                            pointHoverBorderWidth: 3,
                            pointStyle: 'circle',
                            yAxisID: yAxisId,
                            animation: wasShown ? false : {
                                duration: 750,
                                easing: 'easeInOutQuart'
                            }
                        });
                    }
                }
            }

            var dashPatterns = [
                [5, 5],
                [10, 5],
                [15, 3, 3, 3],
                [2, 8],
                [20, 5, 5, 5],
                [8, 3, 2, 3]
            ];

            var pointStyles = ['circle', 'rectRot', 'triangle', 'rect', 'star', 'cross'];

            if (datasets.length > 1) {
                var datasetsNeedDashes = new Array(datasets.length).fill(false);
                
                for (var i = 0; i < datasets.length; i++) {
                    for (var j = i + 1; j < datasets.length; j++) {
                        if (doDatasetsOverlap(datasets[i], datasets[j])) {
                            datasetsNeedDashes[i] = true;
                            datasetsNeedDashes[j] = true;
                        }
                    }
                }
                
                var dashIndex = 0;
                var pointStyleIndex = 0;
                
                for (var i = 0; i < datasets.length; i++) {
                    if (datasetsNeedDashes[i]) {
                        datasets[i].borderDash = dashPatterns[dashIndex % dashPatterns.length];
                        datasets[i].pointStyle = pointStyles[pointStyleIndex % pointStyles.length];
                        dashIndex++;
                        pointStyleIndex++;
                    } else {
                        datasets[i].borderDash = [];
                        datasets[i].pointStyle = 'circle';
                    }
                }
                
                if (datasetsNeedDashes[0] && datasets.length > 1) {
                    datasets[0].borderDash = dashPatterns[0];
                    datasets[0].pointStyle = pointStyles[0];
                }
            }

            function doDatasetsOverlap(dataset1, dataset2) {
                var data1 = dataset1.data;
                var data2 = dataset2.data;
                
                if (data1.length !== data2.length) return false;
                
                var overlapThreshold = 5;
                var overlapCount = 0;
                var totalPoints = data1.length;
                
                for (var k = 0; k < data1.length; k++) {
                    var diff = Math.abs(data1[k] - data2[k]);
                    
                    if (diff <= overlapThreshold) {
                        overlapCount++;
                    }
                }
                
                var overlapRatio = overlapCount / totalPoints;
                return overlapRatio > 0.3;
            }

            previousDatasets = newDatasetLabels;

            var usedAxisTypes = {};
            var percentageMetrics = [];
            var over100Metrics = [];
            
            if (subjectData.isConsistency) {
                percentageMetrics.push({ title: processedStudentStats.c.title, maxValue: Math.max.apply(null, subjectData.values), color: '#10b981' });
            }
            
            for (var i = 0; i < selectedMetrics.length; i++) {
                var metricId = selectedMetrics[i];
                for (var j = 0; j < availableMetrics.length; j++) {
                    if (availableMetrics[j].id === metricId) {
                        var metric = availableMetrics[j];
                        var yAxisId = metric.type === 'percentage' ? metric.yAxisID : getAxisIdForAbsoluteMetric(metricId, selectedMetrics, subjectData);
                        
                        if (!usedAxisTypes[yAxisId]) {
                            usedAxisTypes[yAxisId] = [];
                        }
                        usedAxisTypes[yAxisId].push(metric);
                        
                        if (metric.type === 'percentage') {
                            var metricData = subjectData.values[metricId];
                            var maxVal = Math.max.apply(null, metricData.values);
                            var metricInfo = { 
                                title: metric.title, 
                                maxValue: maxVal,
                                id: metricId,
                                metric: metric,
                                color: metric.color
                            };
                            
                            if (maxVal > 100) {
                                over100Metrics.push(metricInfo);
                            } else {
                                percentageMetrics.push(metricInfo);
                            }
                        }
                        break;
                    }
                }
            }

            for (var i = 0; i < datasets.length; i++) {
                var dataset = datasets[i];
                if (dataset.yAxisID === 'y-percent') {
                    var maxInDataset = Math.max.apply(null, dataset.data);
                    if (maxInDataset > 100) {
                        for (var j = 0; j < over100Metrics.length; j++) {
                            if (dataset.label.indexOf(over100Metrics[j].title) !== -1) {
                                dataset.yAxisID = 'y-percent-' + over100Metrics[j].id;
                                break;
                            }
                        }
                    }
                }
            }

            var yAxes = {};
            var axisColorInfo = {};
            
            if (percentageMetrics.length > 0) {
                var percentColors = [];
                for (var i = 0; i < percentageMetrics.length; i++) {
                    percentColors.push(percentageMetrics[i].color);
                }
                
                axisColorInfo['y-percent'] = percentColors;
                if (selectedSubject === 'c') { // only for nuoseklumas
                    yAxes['y-percent'] = {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: false },
                        min: 0,
                        max: 100,
                        ticks: { 
                            stepSize: 10, // ticks every 10
                            callback: function(value) { return value <= 100 ? value.toFixed(0) + '%' : ''; },
                            color: '#666'
                        },
                        grid: {
                            drawOnChartArea: true,
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        border: { display: false }
                    };
                } else {
                    yAxes['y-percent'] = {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { 
                            display: false
                        },
                        min: 0,
                        max: 100,
                        ticks: { 
                            callback: function(value) { return value.toFixed(0) + '%'; },
                            color: '#666'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        border: {
                            display: false
                        }
                    };
                }
            }

            for (var i = 0; i < over100Metrics.length; i++) {
                var metric = over100Metrics[i];
                var axisId = 'y-percent-' + metric.id;
                axisColorInfo[axisId] = [metric.color];
                
                yAxes[axisId] = {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { 
                        display: false
                    },
                    min: 0,
                    ticks: { 
                        callback: function(value) { return value.toFixed(0) + '%'; },
                        color: '#666'
                    },
                    grid: { 
                        drawOnChartArea: true,
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    border: {
                        display: false
                    }
                };
            }

            var rightAxisCount = 0;
            var axisKeys = Object.keys(usedAxisTypes);
            for (var i = 0; i < axisKeys.length; i++) {
                var axisId = axisKeys[i];
                if (axisId !== 'y-percent' && !axisId.startsWith('y-percent-')) {
                    var metricsOnAxis = usedAxisTypes[axisId];
                    var axisColors = metricsOnAxis.map(function(m) { return m.color; });
                    
                    axisColorInfo[axisId] = axisColors;
                    
                    yAxes[axisId] = {
                        type: 'linear',
                        display: true,
                        min: 0,
                        position: percentageMetrics.length > 0 || over100Metrics.length > 0 || rightAxisCount > 0 ? 'right' : 'left',
                        title: { 
                            display: false
                        },
                        ticks: {
                            callback: function(value) { return value.toFixed(1); },
                            color: '#666'
                        },
                        grid: { 
                            drawOnChartArea: rightAxisCount === 0 && percentageMetrics.length === 0 && over100Metrics.length === 0,
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        border: {
                            display: false
                        }
                    };
                    rightAxisCount = rightAxisCount + 1;
                }
            }

            var ctx = document.getElementById('statsChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: subjectData.dates,
                    datasets: datasets
                },
                options: {
                    clip: false, 
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: false // We're using our custom legend
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    var yAxisId = context.dataset.yAxisID;
                                    if (yAxisId === 'y-percent' || yAxisId.indexOf('y-percent-') === 0) {
                                        label += context.parsed.y + '%';
                                    } else {
                                        label += context.parsed.y;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: yAxes
                },
                plugins: [{
                    id: 'coloredAxisLines',
                    afterDatasetsDraw: function(chart) {
                        var ctx = chart.ctx;
                        var chartArea = chart.chartArea;
                        
                        Object.keys(axisColorInfo).forEach(function(scaleId) {
                            var scale = chart.scales[scaleId];
                            if (!scale) return;
                            
                            var colors = axisColorInfo[scaleId];
                            if (!colors || colors.length === 0) return;
                            
                            var lineWidth = 3;
                            var spacing = 1;
                            
                            var isLeft = scale.position === 'left';
                            var x = isLeft ? scale.left : scale.right;
                            var y1 = chartArea.top;
                            var y2 = chartArea.bottom;

                            var axisFullWidth = scale.width;
                            
                            let secondaryLineShift;
                            for (var i = 0; i < colors.length; i++) {
                                secondaryLineShift = i * lineWidth;
                                ctx.save();
                                ctx.strokeStyle = hexToRgba(colors[i], 0.6);
                                ctx.lineWidth = lineWidth;
                                ctx.beginPath();
                                
                                var offset = i * (lineWidth + spacing);
                                var xPos = isLeft ? x + axisFullWidth - secondaryLineShift : x - axisFullWidth + secondaryLineShift;
                                
                                ctx.moveTo(xPos, y1);
                                ctx.lineTo(xPos, y2);
                                ctx.stroke();
                                ctx.restore();
                            }
                        });
                    }
                }]
            });
            addHideScrollbarForTouch();
        }

        if (processedStudentStats?.c?.values?.length > 2) {
            initializeButtons();
            document.querySelector("#student-stats-graph-holder").style.display = "flex";
        } else {
            document.querySelector("#student-stats-graph-holder").style.display = "none";
        }

        function hexToRgba(hex, opacity) {
            // Remove the hash if it exists
            hex = hex.replace('#', '');
            
            // Parse the hex values
            var r = parseInt(hex.substring(0, 2), 16);
            var g = parseInt(hex.substring(2, 4), 16);
            var b = parseInt(hex.substring(4, 6), 16);
            
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }

        // STATS PART END







        const taskStatusSummary = countTaskStatuses(studentTasks)

        if (taskStatusSummary.total > 0) {
            studentStatisticsCompletedTasks.style.display = "block";
            studentStatisticsCompletedTasks.innerHTML = `<span class="task-info-subtitle">Baigtos u≈æduotys:</span> ${taskStatusSummary.completed}/${taskStatusSummary.total}`
        }

        const categorizedStudentTasks = processStudentTasks(studentTasks)

        if (countTaskStatuses(studentTasks, "math").completed > 0)
            studentStatisticsMathDiv.style.display = "block";
            mistakeFrequency = Math.round(categorizedStudentTasks.math[0][1]/categorizedStudentTasks.math[0][0]*100)
            if (!isNaN(mistakeFrequency)) {
            studentStatisticsMathErrorFrequency.innerHTML = `<span class="task-info-subtitle">Klaid≈≥ da≈ænis:</span> ${categorizedStudentTasks.math[0][1]}/${categorizedStudentTasks.math[0][0]} (${mistakeFrequency}%)`;
            }

        if (countTaskStatuses(studentTasks, "C83").completed > 0) {
            studentStatisticsLangDiv.style.display = "block";
            mistakeFrequency = Math.round(categorizedStudentTasks.grammar[0][1]/categorizedStudentTasks.grammar[0][0]*100)
            if (!isNaN(mistakeFrequency)) {
                studentStatisticsGrammarErrorFrequency.innerHTML = `<span class="task-info-subtitle">Klaid≈≥ da≈ænis:</span> ${categorizedStudentTasks.grammar[0][1]}/${categorizedStudentTasks.grammar[0][0]} (${mistakeFrequency}%)`;
            }
        }

        if (countTaskStatuses(studentTasks, "C51").completed > 0 || countTaskStatuses(studentTasks, "C52").completed > 0) {
            studentStatisticsTextComprahensionDiv.style.display = "block";
        }

        if (countTaskStatuses(studentTasks, "C51").completed > 0) {
            mistakeFrequency = Math.round(categorizedStudentTasks.komponavimas[0][1]/categorizedStudentTasks.komponavimas[0][0]*100)
            if (!isNaN(mistakeFrequency)) {
                studentStatisticsKomponavimasErrorFrequency.innerHTML = `<span class="task-info-subtitle">Klaid≈≥ da≈ænis:</span> ${categorizedStudentTasks.komponavimas[0][1]}/${categorizedStudentTasks.komponavimas[0][0]} (${mistakeFrequency}%)`;
                studentStatisticsTextComprahensionKomponavimasTitle.style.display = "block";
            }
        }

        if (countTaskStatuses(studentTasks, "C52").completed > 0) {
            mistakeFrequency = Math.round(categorizedStudentTasks.isdestymas[0][1]/categorizedStudentTasks.isdestymas[0][0]*100)
            if (!isNaN(mistakeFrequency)) {
                studentStatisticsIsdestymasErrorFrequency.innerHTML = `<span class="task-info-subtitle">Klaid≈≥ da≈ænis:</span> ${categorizedStudentTasks.isdestymas[0][1]}/${categorizedStudentTasks.isdestymas[0][0]} (${mistakeFrequency}%)`;
                studentStatisticsTextComprahensionIsdestymasTitle.style.display = "block";
            }
        }


        const combinedMathAndGrammarMistakes = [...categorizedStudentTasks.math[1], ...categorizedStudentTasks.grammar[1]]

        if (combinedMathAndGrammarMistakes.length > 0) {
            generateSummaryTable("custom", combinedMathAndGrammarMistakes, "summary-table", "summary-table-grammar") 
        }


        document.querySelector("#mistakes-summary-math").style.display = "block";
        document.querySelector("#mistakes-summary-grammar").style.display = "block";
        if (document.querySelector("#summary-table").innerHTML === "Klaid≈≥ nƒóra!" || document.querySelector("#summary-table").innerHTML === '') {
            document.querySelector("#mistakes-summary-math").style.display = "none";
        }

        if (document.querySelector("#summary-table-grammar").innerHTML === "Klaid≈≥ nƒóra!" || document.querySelector("#summary-table-grammar").innerHTML === '') {
            document.querySelector("#mistakes-summary-grammar").style.display = "none";
        }

        function displayComletedTextIdsForTextComp(textInfo, htmlContainer) {
            const ul = document.createElement("ol");
            const textComprehensionTextsTitle = document.createElement("div");
            textComprehensionTextsTitle.innerHTML = "Sudƒólioti tekstai:";
            textComprehensionTextsTitle.classList.add("task-info-subtitle");

            // 1. Extract all [textId, mistakes, date] triples
            const allEntries = [];
            const entries = textInfo.slice(1)[0]; // Skip metadata (e.g., [2, 1])

            for (const entry of entries) {
                const [texts, date] = entry; // each entry is [texts, taskDate]

                for (const text of texts) { // texts is an array of [textId, textMistakes]
                    const [textId, textMistakes] = text;
                    allEntries.push({ textId, textMistakes, date });
                }
            }

            // 2. Sort by textId (ascending, converted to number)
            allEntries.sort((a, b) => Number(a.textId) - Number(b.textId));

            // 3. Display sorted entries
            for (const { textId, textMistakes, date } of allEntries) {
                const li = document.createElement("li");
                const textIdSpan = document.createElement("span");
                const mistakesNumberSpan = document.createElement("span");
                const completionDataSpan = document.createElement("span");

                textIdSpan.innerHTML = `ID${textId}`;
                textIdSpan.classList.add("text-comprehenstion-text-id");

                // Lithuanian pluralization
                let numberLabel;
                const mistakesNum = Number(textMistakes);
                if (mistakesNum === 0 || (mistakesNum > 9 && mistakesNum < 21)) {
                    numberLabel = "klaid≈≥";
                } else if (mistakesNum === 1 || String(mistakesNum).endsWith("1")) {
                    numberLabel = "klaida";
                } else {
                    numberLabel = "klaidos";
                }

                mistakesNumberSpan.innerHTML = `: ${textMistakes} ${numberLabel}`;
                completionDataSpan.innerHTML = ` (${date})`;
                textIdSpan.dataset.textId = textId;

                textIdSpan.addEventListener("click", () => {
                    const id = event.currentTarget.dataset.textId;
                    openTextBrowser(id);
                });

                li.appendChild(textIdSpan);
                li.appendChild(mistakesNumberSpan);
                li.appendChild(completionDataSpan);
                ul.appendChild(li);
            }

            htmlContainer.appendChild(textComprehensionTextsTitle);
            htmlContainer.appendChild(ul);
        }

        if (categorizedStudentTasks.isdestymas[1].length > 0) {
            displayComletedTextIdsForTextComp(categorizedStudentTasks.isdestymas, studentStatisticsIsdestymasCompletedTexts)
        }
        if (categorizedStudentTasks.komponavimas[1].length > 0) {
            displayComletedTextIdsForTextComp(categorizedStudentTasks.komponavimas, studentStatisticsKomponavimasCompletedTexts)
        }
    }
                

        function displayTaskInfo(student, task) {
            clearTaskInfoContainer();

            taskDescriptionTitle.style.display = "block"
            teacherDispalyStudentTaskIndicator.style.display = "block"

            currentTaskInstructions = task.taskDescription;
            currentTaskDuration = JSON.parse(task.duration);

            const parsedTaskDescription = JSON.parse(currentTaskInstructions);
            const formattedTaskDescription = getOptionTextFromValues(parsedTaskDescription, currentTaskDuration, forTeacher=true);
            studentTaskStudentName.innerHTML = `
                <span class="student-name-id-holder"><span id="student-name">${student[1]}</span><span id='student-id'>(ID: ${student[0]})</span></span>
                <button class="edit-name-button" onclick="editStudentName('${student[0]}', this)">
                    <span class="edit-icon">
                    <img src="../images/icons/icon-edit.svg">
                    </span>
                </button>
                `;
            studentTaskStudentEmail.innerHTML = student[2];

            studentTaskGroup.innerHTML = `U≈æduotis: ${task.group}`;
            teacherDispalyStudentTaskIndicator.style.backgroundColor = task.status ? greenCircleColorCode : redCircleColorCode;
            if (task.status) {
                studentTaskCompletionDate.innerHTML = `<span class="task-info-subtitle">Data</span>: ${task.completionDate.split('T')[0]}`
            }
            if (task.result !== '') {
                const parsedTaskResult = JSON.parse(task.result)
                const score = parsedTaskResult[0]
                const textComprehensionrResults = parsedTaskResult[1]

                if (JSON.parse(task.taskDescription)[1] === "C49") {
                    const ul = document.createElement("ol");
                    const textComprehensionTextsTitle = document.createElement("div");
                    textComprehensionTextsTitle.innerHTML = "Sudƒólioti tekstai:";
                    textComprehensionTextsTitle.classList.add("task-info-subtitle");

                    textComprehensionrResults.forEach(([outerKey, value]) => {
                        const li = document.createElement("li");
                        const textIdSpan = document.createElement("span");
                        const mistakesNumberSpan = document.createElement("span");
                        textIdSpan.innerHTML = `ID${outerKey}`;
                        textIdSpan.classList.add("text-comprehenstion-text-id");
                        let numberLabel = ''
                        if (Number(value) === 0 || (Number(value) > 9 && Number(value) < 21)) {
                            numberLabel = "klaid≈≥";
                        } else if (Number(value) === 1 || Number(value.toString().slice(-1)) === 1) {
                            numberLabel = "klaida";
                        } else if (Number(value) < 10 || Number(value) > 21) {
                            numberLabel = "klaidos";
                        }
                        mistakesNumberSpan.innerHTML = `: ${value} ${numberLabel}`;
                        textIdSpan.dataset.textId = outerKey;

                        li.appendChild(textIdSpan)
                        li.appendChild(mistakesNumberSpan)

                        textIdSpan.addEventListener("click", () => {
                            const id = event.currentTarget.dataset.textId;
                            openTextBrowser(id);
                        });

                        ul.appendChild(li);
                    });
                    textComprehensionMistakesSummary.appendChild(textComprehensionTextsTitle);
                    textComprehensionMistakesSummary.appendChild(ul);
                }

                const taskInfo = JSON.parse(task.taskDescription)
                if ((taskInfo[0] === "math" && currentTaskDuration[0] === "C40") || (taskInfo[0] === "lang" && currentTaskDuration[0]  === "C40")) {
                    studentScoreDuration.innerHTML = `<span class="task-info-subtitle">Trukmƒó:</span> ${JSON.parse(task.result)[2]}`
                }

                if (parsedTaskDescription[0] === "math") {
                    studentScoreAnswerNumber.innerHTML = `<span class="task-info-subtitle">Atlikti veiksmai:</span> ${score[0]}`;
                    studentScoreMistakeNumber.innerHTML = `<span class="task-info-subtitle">Klaidos:</span> ${score[1]}`;
                } else if (parsedTaskDescription[0] === "lang") {
                    if (parsedTaskDescription[1] === "C83") {
                        if (parsedTaskDescription[2] === "C50") {
                            studentScoreAnswerNumber.innerHTML = `<span class="task-info-subtitle">ƒÆra≈°ytos raidƒós:</span> ${score[0]}`;
                            studentScoreMistakeNumber.innerHTML = `<span class="task-info-subtitle">Klaidos:</span> ${score[1]}`;
                        }
                    } else if (parsedTaskDescription[1] === "C49") {
                        studentScoreAnswerNumber.innerHTML = `<span class="task-info-subtitle">Sudƒóliot≈≥ tekst≈≥ skaiƒçius:</span> ${score[0]}`;
                        studentScoreMistakeNumber.innerHTML = `<span class="task-info-subtitle">Klaidos:</span> ${score[1]}`;
                    }
                }

                if (taskInfo[0] === "math" || (taskInfo[0] === "lang" && taskInfo[1] === "C83")) {
                    let mistakesList = [];
                    mistakesList = JSON.parse(task.result)[1]
                    if (mistakesList.length > 0) {
                        generateSummaryTable("custom", mistakesList) 
                    }
                }

                if (parsedTaskDescription[0] === "math") {
                    document.querySelector("#mistakes-summary-math").style.display = "block";
                    document.querySelector("#mistakes-summary-grammar").style.display = "none";
                } else if (parsedTaskDescription[0] === "lang" && parsedTaskDescription[1] === "C83") {
                    document.querySelector("#mistakes-summary-math").style.display = "none";
                    document.querySelector("#mistakes-summary-grammar").style.display = "block";
                } else {
                    document.querySelector("#mistakes-summary-math").style.display = "none";
                    document.querySelector("#mistakes-summary-grammar").style.display = "none";
                }

                if (document.querySelector("#summary-table").innerHTML === "Klaid≈≥ nƒóra!" || document.querySelector("#summary-table").innerHTML === '') {
                    document.querySelector("#mistakes-summary-math").style.display = "none";
                }
                if (document.querySelector("#summary-table-grammar").innerHTML === "Klaid≈≥ nƒóra!" || document.querySelector("#summary-table-grammar").innerHTML === '') {
                    document.querySelector("#mistakes-summary-grammar").style.display = "none";
                }
            }

            taskDescriptionList = document.createElement('ul');
            taskDescriptionList.classList.add("task-description-list");

            formattedTaskDescription.forEach(item => {
                if (item) {  // Ensure empty values are not added
                    let listItem = document.createElement('li');
                    
                    // Check if item contains an HTML tag, then use innerHTML
                    if (item.includes("<")) {
                        listItem.innerHTML = item; // Render HTML properly
                    } else {
                        listItem.textContent = item; // Use textContent for plain text
                    }
                    
                    listItem.classList.add("task-description-list-item");
                    taskDescriptionList.appendChild(listItem);
                }
            });

            taskDescription.appendChild(taskDescriptionList);

        }

        async function displayStudentTaskInfo(task) {
            clearTaskInfoContainerForStudents()
            document.querySelector('.task-info-holder-student').style.display = "flex";
            currentTaskId = task.assignmentId
            currentTaskInstructions = task.taskInstructions
            const parsedTaskDescription = JSON.parse(currentTaskInstructions);

            currentTaskDuration = JSON.parse(task.duration);

            const formattedTaskDescription = getOptionTextFromValues(parsedTaskDescription, currentTaskDuration);

            studentTaskGroupForStudent.innerHTML = `U≈æduotis: ${task.group}`;

            teacherDispalyStudentTaskIndicatorForStudent.style.display = "block";
            teacherDispalyStudentTaskIndicatorForStudent.style.backgroundColor = task.status ? greenCircleColorCode : redCircleColorCode;
            if (task.status) {
                studentTaskCompletionDateForStudents.innerHTML = `<span class="task-info-subtitle">Data</span>: ${task.completionDate.split('T')[0]}`
            }

            if (task.status) {
                completeTaskButtonHolder.style.display = "none";
            } else {
                completeTaskButtonHolder.style.display = "flex";

                let numberOfQuestions;
                let answeringMode;
                let earningsDiplay = "";

                answeringMode = currentTaskDuration[0]
                numberOfQuestions = currentTaskDuration[1]

                let potentialEarnings;
                if (answeringMode === "C39" || parsedTaskDescription[1] === "C83") {
                    potentialEarnings = await calculateTasksPerCorrectAnswerPoints(JSON.parse(task.taskInstructions));
                    if (potentialEarnings) {
                        potentialEarnings = Number(potentialEarnings.toFixed(2))
                    }
                    earningsDiplay = `
                        <div class="earnings-estimation-outer">
                            <button class="earnings-estimation-display info-button"
                                onclick="openObjectPopup(infoMessages['coin-amount-custom-timer'].content, infoMessages['coin-amount-custom-timer'].title, infoMessages['coin-amount-custom-timer'].subtitle)">
                                <div class="potetnital-earnings-amount-and-info-holder">
                                    <span class="potetnital-earnings-coin-icon-and-amount-holder">
                                    <span class="earnings-iki-holder">
                                        x
                                    </span>
                                    <span class="coin-icon">
                                            <img src="../images/icons/icon-sudedu-coin.png">
                                    </span>
                                    <span class="coin-amount">${potentialEarnings}</span>
                                    </span>
                                    <div 
                                        class="info-icon"
                                        >
                                    <svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 256 256" xml:space="preserve">
                                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">
                                        <path d="M 49.083 71.489 l 5.776 -21.96 l 4.186 -15.247 c 3.497 -16.18 -32.704 -2.439 -38.002 1.695 l 0.425 4.853 c 4.824 -3.395 23.091 -7.744 19.449 4.275 l -1.634 6.135 l 0 0 l -8.329 31.071 c -3.497 16.18 32.704 2.439 38.002 -1.695 l -0.425 -4.853 C 63.708 79.159 45.441 83.508 49.083 71.489 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/>
                                        <circle cx="53.871" cy="11.201" r="11.201" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>
                                    </g>
                                    </svg>
                                    </div>
                                </div>
                            </button>
                        </div>
                        `
                } else if (answeringMode === "C40") {
                    let parsedTaskInfo = JSON.parse(task.taskInstructions)
                    if (parsedTaskInfo[0] === "lang" && parsedTaskInfo[1] === "C49" && parsedTaskInfo[4] === "C84") {
                        potentialEarnings = await calculateTasksPerCorrectAnswerPoints("selectedTexts", selectedTextInfo=[parsedTaskInfo,numberOfQuestions]);
                        if (potentialEarnings) {
                            potentialEarnings = Number(potentialEarnings.toFixed(2))
                        }
                    } else {
                        potentialEarnings = await calculateTasksPerCorrectAnswerPoints(JSON.parse(task.taskInstructions));
                        if (potentialEarnings) {
                            potentialEarnings = Number((potentialEarnings * numberOfQuestions).toFixed(2))
                        }
                    }
                    earningsDiplay = `
                        <div class="earnings-estimation-outer">
                            <button class="earnings-estimation-display info-button"
                                onclick="openObjectPopup(infoMessages['coin-amount-custom-question-number'].content, infoMessages['coin-amount-custom-question-number'].title, infoMessages['coin-amount-custom-question-number'].subtitle)">
                                <div class="potetnital-earnings-amount-and-info-holder">
                                    <span class="potetnital-earnings-coin-icon-and-amount-holder">
                                    <span class="earnings-iki-holder">
                                        IKI
                                    </span>
                                    <span class="coin-icon">
                                            <img src="../images/icons/icon-sudedu-coin.png">
                                    </span>
                                    <span class="coin-amount">${potentialEarnings}</span>
                                    </span>
                                    <div 
                                        class="info-icon"
                                        >
                                    <svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 256 256" xml:space="preserve">
                                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">
                                        <path d="M 49.083 71.489 l 5.776 -21.96 l 4.186 -15.247 c 3.497 -16.18 -32.704 -2.439 -38.002 1.695 l 0.425 4.853 c 4.824 -3.395 23.091 -7.744 19.449 4.275 l -1.634 6.135 l 0 0 l -8.329 31.071 c -3.497 16.18 32.704 2.439 38.002 -1.695 l -0.425 -4.853 C 63.708 79.159 45.441 83.508 49.083 71.489 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/>
                                        <circle cx="53.871" cy="11.201" r="11.201" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>
                                    </g>
                                    </svg>
                                    </div>
                                </div>
                            </button>
                        </div>
                        `
                }

                document.querySelector(".coin-display-holder").innerHTML = earningsDiplay
            }

            if (task.result !== '') {
                const parsedTaskResult = JSON.parse(task.result)
                const score = parsedTaskResult[0]
                const textComprehensionrResults = parsedTaskResult[1]

                const taskInfo = JSON.parse(task.taskInstructions)
                if ((taskInfo[0] === "math" && currentTaskDuration[0] === "C40") || (taskInfo[0] === "lang" && currentTaskDuration[0] === "C40")) {
                    studentScoreDurationForStudent.innerHTML = `<span class="task-info-subtitle">Trukmƒó:</span> ${JSON.parse(task.result)[2]}`
                }

 
                if (parsedTaskDescription[0] === "math") {
                    studentScoreAnswerNumberForStudent.innerHTML = `<span class="task-info-subtitle">Atlikti veiksmai:</span> ${score[0]}`;
                    studentScoreMistakeNumberForStudent.innerHTML = `<span class="task-info-subtitle">Klaidos</span>: ${score[1]}`;
                } else if (parsedTaskDescription[0] === "lang") {
                    if (parsedTaskDescription[1] === "C83") {
                        studentScoreAnswerNumberForStudent.innerHTML = `<span class="task-info-subtitle">Ira≈°ytos raidƒós:</span> ${score[0]}`;
                        studentScoreMistakeNumberForStudent.innerHTML = `<span class="task-info-subtitle">Klaidos:</span> ${score[1]}`;
                    } else if (parsedTaskDescription[1] === "C49") {
                        studentScoreAnswerNumberForStudent.innerHTML = `<span class="task-info-subtitle">Sudƒóliot≈≥ tekst≈≥ skaiƒçius:</span> ${score[0]}`;
                        studentScoreMistakeNumberForStudent.innerHTML = `<span class="task-info-subtitle">Klaidos:</span> ${score[1]}`;
                    }
                }

                if (taskInfo[0] === "math" || (taskInfo[0] === "lang" && taskInfo[1] === "C83")) {
                    let mistakesList = [];
                    mistakesList = JSON.parse(task.result)[1]

                    if (mistakesList.length > 0) {
                        generateSummaryTable("custom", mistakesList, "summary-table-for-student", "summary-table-grammar-for-student") 
                    }
                }

                if (parsedTaskDescription[0] === "math") {
                    document.querySelector("#mistakes-summary-math-for-student").style.display = "block";
                    document.querySelector("#mistakes-summary-grammar-for-student").style.display = "none";
                } else if (parsedTaskDescription[0] === "lang" && parsedTaskDescription[1] === "C83") {
                    document.querySelector("#mistakes-summary-math-for-student").style.display = "none";
                    document.querySelector("#mistakes-summary-grammar-for-student").style.display = "block";
                } else {
                    document.querySelector("#mistakes-summary-math-for-student").style.display = "none";
                    document.querySelector("#mistakes-summary-grammar-for-student").style.display = "none";
                }

                if (document.querySelector("#summary-table-for-student").innerHTML === "Klaid≈≥ nƒóra!" || document.querySelector("#summary-table-for-student").innerHTML === "") {
                    document.querySelector("#mistakes-summary-math-for-student").style.display = "none";
                }
                if (document.querySelector("#summary-table-grammar-for-student").innerHTML === "Klaid≈≥ nƒóra!" || document.querySelector("#summary-table-grammar-for-student").innerHTML === "") {
                    document.querySelector("#mistakes-summary-grammar-for-student").style.display = "none";
                }

                if (taskInfo[0] === "math" || (taskInfo[0] === "lang" && taskInfo[1] === "C83")) {
                    let mistakesList = [];
                    mistakesList = JSON.parse(task.result)[1]
                    if (mistakesList.length > 0) {
                        generateSummaryTable("custom", mistakesList, "summary-table-for-student") 
                    }
                }
            }

            taskDescriptionList = document.createElement('ul');
            taskDescriptionList.classList.add("task-description-list")
            formattedTaskDescription.forEach(item => {
                if (item) {  // Ensure empty values are not added
                    if (!item.includes("KLASƒñ")) {
                        let listItem = document.createElement('li');
                        
                        // Check if item contains an HTML tag, then use innerHTML
                        if (item.includes("<")) {
                            listItem.innerHTML = item; // Render HTML properly
                        } else {
                            listItem.textContent = item; // Use textContent for plain text
                        }
                        
                        listItem.classList.add("task-description-list-item");
                        taskDescriptionList.appendChild(listItem);
                    }
                }
            });
            let description = document.createElement('div');
            description.innerHTML = '<span class="task-info-subtitle">U≈æduoties apra≈°ymas:</span>'

            taskDescriptionForStudent.appendChild(description);
            taskDescriptionForStudent.appendChild(taskDescriptionList);
        }

        function populateTaskGroupDropdown() {
            const dropdown = document.getElementById("task-group-sorting");
            dropdown.innerHTML = ''; // Clear existing options

            // Create a Set to store unique task groups
            const taskGroups = new Set();

            // Iterate through students and collect unique task group names
            studentList.forEach(student => {
                student.tasks.forEach(task => {
                    taskGroups.add(task.group);
                });
            });

            // Convert Set to sorted array
            const sortedGroups = ["Visos u≈æduoƒçi≈≥ grupƒós", ...Array.from(taskGroups).sort()];

            // Populate dropdown with options
            sortedGroups.forEach(group => {
                const option = document.createElement("option");
                option.value = group;
                option.textContent = group;
                dropdown.appendChild(option);
            });
        }

        function handleTaskGroupChange() {
            const dropdown = document.getElementById("task-group-sorting");
            
            dropdown.addEventListener("change", () => {
                const selectedGroup = dropdown.value;

                // Filter students based on the selected task group
                const filteredStudents = selectedGroup === "Visos u≈æduoƒçi≈≥ grupƒós"
                    ? studentList
                    : studentList
                        .map(student => ({
                            ...student,
                            tasks: student.tasks.filter(task => task.group === selectedGroup)
                        }))
                        .filter(student => student.tasks.length > 0); // Remove students with no tasks after filtering

                // Re-render with the filtered student list
                taskContainerVisible = false;
                toggleTaskVisibility();
                renderDataForTeachers(filteredStudents);
            });
        }

        // Ensure the function runs after populating the dropdown
        handleTaskGroupChange();

        function medianStudentScore(students) {
        const studentAverages = students.map(student => {
            const stats = student.stats;
            const validKeys = Object.keys(stats).filter(k => !['c', 'd'].includes(k));

            let allRatios = [];

            for (const key of validKeys) {
            const statArray = stats[key];
            if (Array.isArray(statArray)) {
                for (const sub of statArray) {
                if (Array.isArray(sub) && sub.length >= 4) {
                    const points = sub[0];
                    allRatios.push(points);
                }
                }
            }
            }

            if (allRatios.length === 0) return 0;
            const avg = allRatios.reduce((a, b) => a + b, 0) / allRatios.length;
            return avg;
        });

        // Sort for median
        const sorted = studentAverages.sort((a, b) => a - b);
        const mid = Math.floor(sorted.length / 2);

        const median =
            sorted.length % 2 === 0
            ? (sorted[mid - 1] + sorted[mid]) / 2
            : sorted[mid];

        // Express as percentage, rounded to 2 digits
        return +median.toFixed(2);
        }
        

        function medianStudentConsistency(students) {
            // Compute average consistency for each student
            const studentConsistencies = students.map(student => {
                const c = student.stats.c || [];
                if (c.length === 0) return 0;
                const avg = c.reduce((sum, val) => sum + val, 0) / c.length;
                return avg; // fraction 0-1
            });

            // Sort to calculate median
            const sorted = studentConsistencies.sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);

            const median =
                sorted.length % 2 === 0
                ? (sorted[mid - 1] + sorted[mid]) / 2
                : sorted[mid];

            // Express as percentage, rounded to 2 decimals
            return +(median * 100).toFixed(2);
        }


        
        function renderDataForTeachers(filteredList = studentList) {
        studentListDiv.innerHTML = '';

        // Sort students alphabetically by nickname
        const sortedStudents = [...filteredList].sort((a, b) => a.nickname.localeCompare(b.nickname));

        classScoreMedian = medianStudentScore(sortedStudents);

        classConsistencyMedian = medianStudentConsistency(sortedStudents);

        const listContainer = document.createElement('ul');

        sortedStudents.forEach((student, studentIndex) => {
        const studentElement = document.createElement('li');
        studentElement.classList.add('student-li-item');

        // Student checkbox
        const studentCheckbox = document.createElement('input');
        studentCheckbox.type = 'checkbox';
        studentCheckbox.id = `student-${student.id}`;
        studentCheckbox.value = student.id;
        studentCheckbox.classList.add('student-checkbox');
        studentCheckbox.style.visibility = 'hidden';

        // Student label with numbering
        const studentName = document.createElement('div');
        studentName.classList.add('student-name');
        studentName.classList.add('selection-option');
        studentName.style.cursor = 'pointer';
        studentName.dataset.studentId = student.id
        studentName.innerHTML = `${studentIndex + 1}. ${student.nickname} (ID: ${student.id})`;

        studentName.addEventListener('click', async () => {
            if (document.querySelector(`#tasks-${student.id}`).style.display === "none") {
                if (!browsingHistory) {
                    document.querySelector(`#tasks-${student.id}`).style.display = "block";
                } else {
                    if (taskHistoryCurrentTask) {
                        await retrieveTaskHistoryInformation(student.id, taskHistoryCurrentTask)
                    }
                }
            } else {
                if (!browsingHistory) {
                    if (studentName.classList.contains("selected-option"))
                    document.querySelector(`#tasks-${student.id}`).style.display = "none";
                } else {
                    if (taskHistoryCurrentTask) {
                        await retrieveTaskHistoryInformation(student.id, taskHistoryCurrentTask);
                    }
                }
            }

            // Remove 'selected-option' class from all task names
            document.querySelectorAll('.selection-option').forEach(name => {
                name.classList.remove('selected-option');
            });

            // Add 'selected-option' class to the clicked task
            studentName.classList.add('selected-option');

            // Display task info
            displayStudentStatistics([student.id, student.nickname, student.knowledgeLvl, student.stats, student.username], student.tasks);

            if (currentAction !== "new-task") {
                openSidebar();
            }

            toggleMainBrowser(true);
            const sidebar = document.querySelector('.sidebar');
            sidebar.scrollTo({
            top: 0,
            behavior: 'smooth'
            });
        });

        // Student-level task status circles
        const studentCircleContainer = document.createElement('div');
        studentCircleContainer.classList.add('student-li-entry-tasks-indicatior');

        // Tasks container
        const tasksContainer = document.createElement('ul');
        tasksContainer.id = `tasks-${student.id}`;
        tasksContainer.classList.add('task-container');

        student.tasks.forEach((task, taskIndex) => {
            const taskWrapper = document.createElement('li');
            taskWrapper.classList.add('task-li-item');

            // Task checkbox
            const taskCheckbox = document.createElement('input');
            taskCheckbox.type = 'checkbox';
            taskCheckbox.id = `task-${task.assignmentId}`;
            taskCheckbox.value = task.assignmentId;
            taskCheckbox.classList.add('task-checkbox');
            taskCheckbox.style.visibility = "hidden";
            taskCheckbox.disabled = true;

            // Task label with numbering
            const taskName = document.createElement('div');
            taskName.innerHTML = `${taskIndex + 1}. ${task.group}`;
            taskName.style.cursor = 'pointer';
            taskName.classList.add('task-name');
            taskName.classList.add('selection-option');
            taskName.addEventListener('click', () => {
                // Remove 'selected-option' class from all task names
                document.querySelectorAll('.selection-option').forEach(task => {
                    task.classList.remove('selected-option');
                });

                // Add 'selected-option' class to the clicked task
                taskName.classList.add('selected-option');

                // Display task info
                displayTaskInfo([student.id, student.nickname, student.username], task);

                if (currentAction !== "new-task") {
                    openSidebar();
                }

                toggleMainBrowser(true);
                const sidebar = document.querySelector('.sidebar');
                sidebar.scrollTo({
                top: 0,
                behavior: 'smooth'
                });
            });

            // Task status circle
            const taskCircle = document.createElement('div');
            taskCircle.classList.add('student-list-task-indicatior');
            taskCircle.style.backgroundColor = task.status ? greenCircleColorCode : redCircleColorCode;

            // Append elements to task wrapper
            taskWrapper.appendChild(taskCheckbox);
            taskName.appendChild(taskCircle);
            taskWrapper.appendChild(taskName);

            // Append task to tasks container
            tasksContainer.appendChild(taskWrapper);
        });

        // Append elements to student element
        studentElement.appendChild(studentCheckbox);
        studentElement.appendChild(studentName);

        const outerStudentListItem = document.createElement('div');
        outerStudentListItem.classList.add('outer-student-list-entry-item');
        outerStudentListItem.appendChild(studentElement);
        outerStudentListItem.appendChild(tasksContainer);

        // Append student element to main list
        listContainer.appendChild(outerStudentListItem);
    });

    studentListDiv.appendChild(listContainer);

    if (deletingTask) {  
        document.querySelectorAll('.task-checkbox').forEach(checkbox => {
        checkbox.style.visibility = "visible";
        checkbox.disabled = false;
        });
    }
}

        document.getElementById('expand-student-info-button').addEventListener('click', () => {
            if (browsingHistory) return;
            toggleTaskVisibility();
        });


        function toggleTaskVisibility() {
            taskContainerVisible = !taskContainerVisible;
            if (taskContainerVisible) {
                expandStudentInfoButton.innerHTML = '&#x2212;';
                document.querySelectorAll('.task-container').forEach(container => {
                    container.style.display = 'block';
                });
            } else {
                expandStudentInfoButton.innerHTML = '+';
                document.querySelectorAll('.task-container').forEach(container => {
                    container.style.display = 'none';
                });
            }
        }

        function renderDataForStudents() {

            tasksList.forEach((task, taskIndex) => {
                const taskWrapper = document.createElement('li');
                taskWrapper.classList.add('task-li-item');
                taskWrapper.classList.add('task-li-item-for-students');

                // Task checkbox
                const taskCheckbox = document.createElement('input');
                taskCheckbox.type = 'checkbox';
                taskCheckbox.id = `task-${task.assignmentId}`;
                taskCheckbox.value = task.assignmentId;
                taskCheckbox.classList.add('task-checkbox');
                taskCheckbox.style.visibility = "hidden";
                taskCheckbox.disabled = true;

                // Task label with numbering
                const taskName = document.createElement('div');
                taskName.innerHTML = `${taskIndex + 1}. ${task.group}`;
                taskName.style.cursor = 'pointer';
                taskName.classList.add('task-name');
                taskName.classList.add('selection-option');
                taskName.addEventListener('click', () => {
                    // Remove 'selected-option' class from all task names
                    document.querySelectorAll('.selection-option').forEach(task => {
                        task.classList.remove('selected-option');
                    });

                    // Add 'selected-option' class to the clicked task
                    taskName.classList.add('selected-option');

                    // Display task info
                    displayStudentTaskInfo(task);
                    openSidebarStudent();
                });

                // Task status circle
                const taskCircle = document.createElement('div');
                taskCircle.classList.add('student-list-task-indicatior');
                taskCircle.style.backgroundColor = task.status ? greenCircleColorCode : redCircleColorCode;

                // Append elements to task wrapper
                //taskWrapper.appendChild(taskCheckbox);
                taskName.appendChild(taskCircle);
                taskWrapper.appendChild(taskName);

                // Append task to tasks container
                studentTasksList.appendChild(taskWrapper);
            });

            const totalTasks = tasksList.length;
            const completedTasks = tasksList.filter(task => task.status === true).length;
            if (totalTasks.length === 0) {
                taskListTitleForStudents.innerHTML = "U≈æduotys:"
            } else {
                taskListTitleForStudents.innerHTML = `U≈æduotys (atlikta ${completedTasks}/${totalTasks}):`
            }
        }

        async function fetchDataForTeachers() {
            let success = false;
            let showMessageTimeout;
            let closer;

            // Schedule showing the message after 500ms
            showMessageTimeout = setTimeout(() => {
                closer = messageToTheUser("Mokini≈≥ ir u≈æduoƒçi≈≥ informacija ie≈°koma duomen≈≥ bazƒóje. Procesas gali u≈ætrukti kelias minutes.", false, true);
            }, 500);

            newTaskButton.disabled = true
            deleteTaskButton.disabled = true
            deleteStudentButton.disabled = true
            taskHistoryBrowserButton.disabled = true

            try {
                const response = await apiFetch(apiBase + 'students', {
                    method: 'GET'
                });

                if (!response) {
                    return;
                }

                if (!response.ok) {
                    const errorData  = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }

                studentList = await response.json().catch(() => ({}));
                success = true;

                populateTaskGroupDropdown();
                renderDataForTeachers();
            } catch (error) {
                console.log('Error fetching data:', error);
                if (error.message === "Unauthorized") {
                    clearUserData();
                    window.location.href = "prisijungimas";
                } else {
                    messageToTheUser('Nepavyko pasiekti duomen≈≥. Bandykite vƒól vƒóliau.');
                }
            } finally {
                 // Cancel showing the message if not yet displayed
                clearTimeout(showMessageTimeout);

                // Close message if it was displayed
                if (closer) {
                    setTimeout(() => closer(), 0); // close after 0.5s
                }
            }
            if (success) {
                newTaskButton.disabled = false
                deleteTaskButton.disabled = false
                deleteStudentButton.disabled = false
                taskHistoryBrowserButton.disabled = false
            }
        }


        async function fetchDataForStudents() {
            let success = false;
            let showMessageTimeout;
            let closer;

            // Schedule showing the message after 500ms
            showMessageTimeout = setTimeout(() => {
                closer = messageToTheUser( 'U≈æduoƒçi≈≥ informacija ie≈°koma duomen≈≥ bazƒóje. Procesas gali u≈ætrukti kelias minutes.', false, true);
            }, 500);

            try {
                const response = await apiFetch(apiBase + 'tasks', {
                    method: 'GET'
                });

                if (!response) {
                    return;
                }

                if (!response.ok) {
                    const errorData  = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }

                tasksList = await response.json().catch(() => ({}));
                success = true;
                renderDataForStudents();

            } catch (error) {
                console.log('Error fetching data:', error);
                if (error.message === "Unauthorized") {
                    clearUserData();
                    window.location.href = "prisijungimas";
                } else {
                    messageToTheUser('Nepavyko pasiekti duomen≈≥. Bandykite vƒól vƒóliau.')
                }
            }
            if (success) {
                 // Cancel showing the message if not yet displayed
                clearTimeout(showMessageTimeout);

                // Close message if it was displayed
                if (closer) {
                    setTimeout(() => closer(), 0); // close after 0.5s
                }
            }
        }
    

    function toggleAddNewTask() {
        addingNewTask = !addingNewTask
        toggleStudentListLabel();
        const dropdown = document.getElementById("task-group-sorting");
        if (addingNewTask) {
            // Set the selected option to "Visos u≈æduoƒçi≈≥ grupƒós"
            dropdown.value = "Visos u≈æduoƒçi≈≥ grupƒós";
            // Manually trigger the change event
            dropdown.dispatchEvent(new Event("change"));
            dropdown.disabled = true;
            
            taskContainerVisible = true;
            toggleTaskVisibility();
            studentTaskInfoContainer.style.display = 'none'; 
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
            checkbox.style.visibility = 'visible';

            const modeChoice15Element = document.getElementById('mode_choice_15');

            if (modeChoice15Element && modeChoice15Element.options.length < 2) {
                modeChoice15Element.innerHTML = '';
                modeChoice15Element.innerHTML += '<option value="C82">ATSITIKTINIAI TEKSTAI</option>'
                modeChoice15Element.innerHTML += '<option value="C84">PARINKTI TEKSTUS</option>'
            }

            let changeEvent = new Event('change');
            modeChoice15Element.value = 'C82';
            modeChoice15Element.dispatchEvent(changeEvent);

            const modeChoice15Selection = modeChoice15Element.value;

            if (modeChoice15Selection === "C82") {
                isSelectionModeEnabled = false;
            } else if (modeChoice15Selection === "C84") {
                isSelectionModeEnabled = true;
            }

            refilterTexts();

            const taskGroup = document.querySelector('#task-group-sorting');
            const groupName = document.querySelector('#group_name');

            openSidebar();

            toggleMainBrowser(true);
            const sidebar = document.querySelector('.sidebar');
            sidebar.scrollTo({
            top: 0,
            behavior: 'smooth'
            });
        });
            newTaskOptions.style.display = 'flex';
            document.querySelector("#group_name").style.display = "block";
            document.querySelector("#mode_choice_4").style.display = "block";
            document.querySelector(".timer-question-number-div").style.display = "block";

        } else {
            taskContainerVisible = false;
            toggleTaskVisibility();
            studentTaskInfoContainer.style.display = 'flex'; 
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
            checkbox.style.visibility = 'hidden';
            checkbox.checked = false;
        });
            newTaskOptions.style.display = 'none';
            dropdown.disabled = false;
            toggleMainBrowser(closeMainBrowser=true);
            isSelectionModeEnabled = false;
            refilterTexts();
        }
    }

    function toggleBrowseHistory() {
        browsingHistory = !browsingHistory
        toggleStudentListLabel();
        const dropdown = document.getElementById("task-group-sorting");
        if (browsingHistory) {
            // Set the selected option to "Visos u≈æduoƒçi≈≥ grupƒós"
            dropdown.value = "Visos u≈æduoƒçi≈≥ grupƒós";
            // Manually trigger the change event
            dropdown.dispatchEvent(new Event("change"));
            dropdown.disabled = true;
            
            taskContainerVisible = true;
            toggleTaskVisibility();

            document.querySelector(".txt-browser-wrapper").style.display = 'none'; 
            studentTaskInfoContainer.style.display = 'none'; 
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
            checkbox.style.visibility = 'hidden';

            const modeChoice15Element = document.getElementById('mode_choice_15');

            if (modeChoice15Element && modeChoice15Element.options.length > 1) {
                modeChoice15Element.innerHTML = '';
                modeChoice15Element.innerHTML += '<option value="C82">ATSITIKTINIAI TEKSTAI</option>'
            }

            let changeEvent = new Event('change');
            modeChoice15Element.value = 'C82';
            modeChoice15Element.dispatchEvent(changeEvent);

            openSidebar();

            toggleMainBrowser(true);
            const sidebar = document.querySelector('.sidebar');
            sidebar.scrollTo({
            top: 0,
            behavior: 'smooth'
            });
        });
            newTaskOptions.style.display = 'flex';
            document.querySelector("#group_name").style.display = "none";
            document.querySelector("#mode_choice_4").style.display = "none";
            document.querySelector(".timer-question-number-div").style.display = "none";

        } else {
            taskHistoryCurrentTask = null;
            taskContainerVisible = false;
            toggleTaskVisibility();
            document.querySelector(".txt-browser-wrapper").style.display = 'block'; 
            studentTaskInfoContainer.style.display = 'flex'; 
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                checkbox.style.visibility = 'hidden';
                checkbox.checked = false;
            });
            newTaskOptions.style.display = 'none';
            document.querySelector("#student-task-history-container").style.display = "none";
            dropdown.disabled = false;
            toggleMainBrowser(closeMainBrowser=true);
            isSelectionModeEnabled = false;
            refilterTexts();
        }
    }

    document.getElementById("new-search-button").addEventListener("click", () => {
        startNewTaskHistorySearch();
    });

    function startNewTaskHistorySearch () {
        enableConfirmationButtons();
        enableTeacherControlPannel();
        enableNewTaskContainer();

        document.getElementById('confirm-button').disabled = false;
        document.getElementById("new-search-button").disabled = true;
        newTaskOptions.style.display = 'flex';
        document.querySelector("#student-task-history-container").style.display = "none";
    }

    function toggleDeleteTask() {
        deletingTask = !deletingTask
        toggleStudentListLabel();
        if (deletingTask) {
            taskContainerVisible = false;
            toggleTaskVisibility();
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
            checkbox.style.visibility = "visible";
            checkbox.disabled = false;
        });
        } else {
            taskContainerVisible = false;
            toggleTaskVisibility();
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
            checkbox.style.visibility = "hidden";
            checkbox.checked = false;
            checkbox.disabled = true;
        });
        }
    }

    function deleteSelectedTasks() {
        let tasksToRemove = [];
        document.querySelectorAll('.task-checkbox').forEach(checkbox => {
            if (checkbox.checked) {
                tasksToRemove.push(parseInt(checkbox.value));
            }
        });

        if (tasksToRemove.length === 0) {
            messageToTheUser( "Pasirinkite bent vienƒÖ u≈æduotƒØ i≈°trynimui!")
            return
        }

        deleteTasks(tasksToRemove)
    }

    async function deleteAllTasks() {
        try {
                const response = await apiFetch(apiBase + 'tasks', {
                    method: 'GET'
                });

                if (!response) {
                    return;
                }

                if (!response.ok) {
                    const errorData  = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }

                const allStudentsTasks = await response.json().catch(() => ({}));
                const assignmentIds = allStudentsTasks.map(task => task.assignmentId);
                deleteTasks(assignmentIds)
                
            } catch (error) {
                console.log('Error fetching tasks:', error);
                if (error.message === "Unauthorized") {
                    clearUserData();
                    window.location.href = "prisijungimas";
                } else {
                    teacherMessageLine.innerHTML = 'Nepavyko pasiekti duomen≈≥. Bandykite vƒól vƒóliau.'
                }
            }
    }


    async function deleteTasks(tasksToRemove) {
        disableConfirmationButtons();
        try {
            // Prepare the list of tasks to delete (assuming tasksToTemove is already populated)
            const tasksToDelete = tasksToRemove;  // Ensure this array holds task IDs to be deleted

            disableTeacherControlPannel()
            const response = await apiFetch(apiBase + 'tasks', {
                method: 'DELETE',  // Change to DELETE method
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ tasks: tasksToDelete })  // Send the list as JSON in the body
            });

            if (!response) {
                return;
            }

            if (!response.ok) {
                const errorData  = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
            }

            // Optionally, handle the response if needed (e.g., confirm deletion or update the UI)
            const result = await response.json().catch(() => ({}));
            if (result.message === "Tasks and their associated assignments deleted successfully.") {
                messageToTheUser("U≈æduotys pa≈°alintos sƒókmingai!", false)
                fetchDataForTeachers()
            }

        } catch (error) {
            console.log('Error fetching tasks:', error);
            if (error.message === "Unauthorized") {
                clearUserData();
                window.location.href = "prisijungimas";
            } else {
                messageToTheUser("Nepavyko pa≈°alinti u≈æduoƒçi≈≥. Bandykite vƒól vƒóliau.")
            }
        } finally {
            enableTeacherControlPannel();
            clearTaskInfoContainer();
            hideConfirmationButtons();
            toggleDeleteTask()
        }
    }
    
    async function setTask() {
        function removeError(element) { 
            element.classList.remove('invalid-submition'); 
        };

        const selectedStudents = Array.from(document.querySelectorAll('.student-checkbox'))
            .filter(checkbox => checkbox.checked)
            .map(checkbox => parseInt(checkbox.value))

        if (selectedStudents.length === 0) {
            messageToTheUser("Pasirinkite bent vienƒÖ mokinƒØ!");
            return
        }

        const groupName = document.getElementById('group_name').value.trim();
        let modeChoice1 = document.getElementById('mode_choice_1').value
        let modeChoice2 = document.getElementById('mode_choice_2').value
        let modeChoice3 = document.getElementById('mode_choice_3').value
        const modeChoice4 = document.getElementById('mode_choice_4').value
        let modeChoice5 = document.getElementById('mode_choice_5').value
        const modeChoice6 = document.getElementById('mode_choice_6').value
        const modeChoice7 = document.getElementById('mode_choice_7').value
        const classChoiceSelection = document.querySelector('#class_choice').value;
        const timerInput = document.getElementById('timer-input').value
        const questionNumberInput = document.getElementById('question-number-input').value
        const remainderInput = document.getElementById('remainder-input').checked

        const selectedNumberElement = document.querySelector('#selected_number');
        const selectedNumber2Element = document.querySelector('#selected_number_2');
        let selectedNumbers = [selectedNumberElement.value, selectedNumber2Element.value].sort();

        let modeChoiceSelection = document.querySelector('#mode_choice').value;
        let mode = modeChoiceSelection;

        if (groupName.length === 0) {
            messageToTheUser("ƒÆveskite grupƒós pavadinimƒÖ!")
            return
        } else if (groupName.length >= 60) {
            messageToTheUser("Maksimalus grupƒós pavadinimo ilgis yra 60 simboli≈≥.")
            return
        }

        let durationType;
        if (modeChoice4 === "C39") {
            durationType = timerInput;
        } else if (modeChoice4 === "C40") {
            durationType = questionNumberInput;
        }

        if (modeChoice3 === "") modeChoice3 = "C37"

        const modeChoiceElementSelection = document.querySelector('#mode_choice').value;
        let task = [];
        let taskDuration = [];
        if (mode === "math") {
            task = [
                mode, modeChoice1, modeChoice2, modeChoice3, 
                modeChoice5, modeChoice6, modeChoice7, selectedNumbers, 
                remainderInput, "C79"
            ];
            taskDuration = [
                modeChoice4, durationType
            ]
        } else if (mode === "lang") {
            const classChoiceSelection = document.querySelector('#class_choice').value;
            classChoice = classChoiceSelection;

            let modeChoice8Selection = document.querySelector('#mode_choice_8').value;
            modeChoice1 = modeChoice8Selection;

            const modeChoice9Selection = document.querySelector('#mode_choice_9').value;

            modeChoice2 = modeChoice9Selection;

            const selectedOptions = getSelectedRasybaConditions();

            const sortedModeChoice3 = Object.fromEntries(
            Object.entries(selectedOptions).sort(([a], [b]) => {
                const numA = parseInt(a.slice(1));
                const numB = parseInt(b.slice(1));
                return numA - numB;
            })
            );

            modeChoice3 = sortedModeChoice3;

            const modeChoice12Selection = document.querySelector('#mode_choice_12').value;
            modeChoice5 = modeChoice12Selection;

            const modeChoiceLtDifficulty = document.getElementById('mode_choice_10').value;

            const modeChoice14Selection = document.getElementById('mode_choice_14').value;
            const modeChoice15Selection = document.getElementById('mode_choice_15').value;

            let questionFrequency;
            if (classChoice === "C75") {
                let modeChoice13Selection = document.querySelector('#mode_choice_13').value;
                questionFrequency = Number(modeChoice13Selection);
            } else {
                questionFrequency = 1;
            }
            
            if (modeChoice1 === "C49") {
                if (modeChoice15Selection === "C82") {
                    task = [
                        mode, modeChoice1, modeChoice2, modeChoice14Selection, modeChoice15Selection, classChoiceSelection, modeChoiceLtDifficulty
                    ];
                    taskDuration = [modeChoice4, durationType]
                } else if (modeChoice15Selection === "C84") {
                    task = [
                        mode, modeChoice1, modeChoice2, modeChoice14Selection, modeChoice15Selection
                    ];
                    taskDuration = ["C40", selectedIds]
                }
            } else if (modeChoice1 === "C83") {
                if (modeChoice2 === "C50") {
                    task = [
                        mode, modeChoice1, modeChoice2, classChoiceSelection, modeChoice3,
                        modeChoice5, questionFrequency
                    ];
                    taskDuration = [modeChoice4, durationType]
                }
            }
        }

        const normalizedTask = JSON.stringify(task);
        const normalizedDuration = JSON.stringify(taskDuration);

        const taskData = {
            students: selectedStudents,
            group_name: groupName,
            task: normalizedTask,
            taskDuration: normalizedDuration
        }

        disableNewTaskContainer();
        disableTeacherControlPannel();
        disableConfirmationButtons();
        try {
            console.log(JSON.parse(taskData.task))
        const response = await apiFetch(apiBase + 'tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(taskData)
        });

        if (!response) {
            return;
        }

        // First parse the response as JSON
        const responseData = await response.json().catch(() => ({}));
        

        if (responseData.message === 'Task set successfully') {
            messageToTheUser('U≈æduotis sukurta sƒókmingai!', false)
            fetchDataForTeachers()
        } else if (responseData.message === 'Some students already have the maximum allowed tasks per student.') {
            messageToTheUser('Galima sukurti tik 6 u≈æduotis per mokinƒØ. I≈°strinkite senƒÖ u≈æduotƒØ, kad galƒótumƒóte sukurti naujƒÖ.')
        } else {
            throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
        }
        } catch (error) {
            console.log('Error fetching tasks:', error);
            if (error.message === "Unauthorized") {
                clearUserData();
                window.location.href = "prisijungimas";
            } else {            
                messageToTheUser('Nepavyko pridƒóti u≈æduoties. Bandykite vƒól vƒóliau.');
        }
        } finally {
            toggleAddNewTask();
            enableTeacherControlPannel();
            enableNewTaskContainer();
            hideConfirmationButtons();
        }
    }

    function completeTask() {
        const parsedCurrentTaskInstructions = JSON.parse(currentTaskInstructions);

            if (localStorage.getItem('controller') !== null) {
				controller = JSON.parse(localStorage.getItem('controller'))
			}

			var checkbox = document.getElementById("remainder-input");
            controller.language = "LT";
            if (parsedCurrentTaskInstructions[0] === "math") {
                controller.mode = 'math';
                controller.modeChoice1 = parsedCurrentTaskInstructions[1];
                controller.modeChoice2 = parsedCurrentTaskInstructions[2];
                if (parsedCurrentTaskInstructions[3] === "C37") {
                    controller.modeChoice3 = true;
                } else if (parsedCurrentTaskInstructions[3] === "C38") {
                    controller.modeChoice3 = false;
                }
                controller.modeChoice5 = parsedCurrentTaskInstructions[4];
                controller.modeChoice6 = parsedCurrentTaskInstructions[5];
                controller.modeChoice7 = parsedCurrentTaskInstructions[6];
                controller.selectedNumbers = parsedCurrentTaskInstructions[7];
                controller.withRemainder = parsedCurrentTaskInstructions[8];
                controller.modeChoice8 = parsedCurrentTaskInstructions[9];
                controller.task = ["setTask", currentTaskId];
                controller.taskCompleted = false;
                controller.taskRecorded = false;

                controller.modeChoice4 = currentTaskDuration[0];
                controller.setTaskDuration = currentTaskDuration[1];
            } else if (parsedCurrentTaskInstructions[0] === "lang") {
                controller.mode = 'lang';
                if (parsedCurrentTaskInstructions[1] === "C49") {
                    controller.modeChoice1 = parsedCurrentTaskInstructions[1];
                    controller.modeChoice2 = parsedCurrentTaskInstructions[2];
                    controller.modeChoice6 = parsedCurrentTaskInstructions[3];
                    controller.modeChoice7 = parsedCurrentTaskInstructions[4];

                    if (controller.modeChoice7 === "C82") {
                        controller.classChoice = parsedCurrentTaskInstructions[5];
                        controller.modeChoiceLtDifficulty = parsedCurrentTaskInstructions[6];
                        controller.modeChoice4 = currentTaskDuration[0];
                        controller.setTaskDuration = currentTaskDuration[1];
                    } else if (controller.modeChoice7 === "C84") {
                        controller.modeChoice4 = currentTaskDuration[0];
                        controller.modeChoice8 = currentTaskDuration[1];
                        controller.setTaskDuration = controller.modeChoice8.length;
                    }

                    controller.task = ["setTask", currentTaskId];
                    controller.taskCompleted = false;
                    controller.taskRecorded = false;

                } else if (parsedCurrentTaskInstructions[1] === "C83") {
                    if (parsedCurrentTaskInstructions[2] === "C50") {
                        controller.modeChoice1 = parsedCurrentTaskInstructions[1];
                        controller.modeChoice2 = parsedCurrentTaskInstructions[2];
                        controller.classChoice = parsedCurrentTaskInstructions[3];
                        controller.modeChoice3 = parsedCurrentTaskInstructions[4];
                        controller.modeChoice5 = parsedCurrentTaskInstructions[5];
                        controller.questionFrequency = parsedCurrentTaskInstructions[6];
                        
                        controller.task = ["setTask", currentTaskId];
                        controller.taskCompleted = false;
	                    controller.taskRecorded = false;

                        controller.modeChoice4 = currentTaskDuration[0];
                        controller.setTaskDuration = currentTaskDuration[1];
                    }
                }
            }

			localStorage.setItem('controller', JSON.stringify(controller))

            startQuestions();
    }

    function arraysEqual(a, b) {
        if (!Array.isArray(a) || !Array.isArray(b)) return false;
        if (a.length !== b.length) return false;

        for (let i = 0; i < a.length; i++) {
            const valA = a[i];
            const valB = b[i];

            // If elements are arrays/objects, compare recursively
            const bothArrays = Array.isArray(valA) && Array.isArray(valB);
            const bothObjects = valA && valB && typeof valA === 'object' && typeof valB === 'object';

            if (bothArrays && !arraysEqual(valA, valB)) return false;
            else if (bothObjects && JSON.stringify(valA) !== JSON.stringify(valB)) return false;
            else if (!bothArrays && !bothObjects && valA !== valB) return false;
        }

        return true;
    }


    let taskHistoryCurrentTask = null;
    
    async function setTaskHistoryQuery() {
        let modeChoice1 = document.getElementById('mode_choice_1').value
        let modeChoice2 = document.getElementById('mode_choice_2').value
        let modeChoice3 = document.getElementById('mode_choice_3').value
        const modeChoice4 = document.getElementById('mode_choice_4').value
        let modeChoice5 = document.getElementById('mode_choice_5').value
        const modeChoice6 = document.getElementById('mode_choice_6').value
        const modeChoice7 = document.getElementById('mode_choice_7').value
        const classChoiceSelection = document.querySelector('#class_choice').value;
        const timerInput = document.getElementById('timer-input').value
        const questionNumberInput = document.getElementById('question-number-input').value
        const remainderInput = document.getElementById('remainder-input').checked

        const selectedNumberElement = document.querySelector('#selected_number');
        const selectedNumber2Element = document.querySelector('#selected_number_2');
        let selectedNumbers = [selectedNumberElement.value, selectedNumber2Element.value].sort();

        let modeChoiceSelection = document.querySelector('#mode_choice').value;
        let mode = modeChoiceSelection;

        if (modeChoice3 === "") modeChoice3 = "C37"

        const modeChoiceElementSelection = document.querySelector('#mode_choice').value;
        
        let task = [];

        if (mode === "math") {
            task = [
                mode, modeChoice1, modeChoice2, modeChoice3, 
                modeChoice5, modeChoice6, modeChoice7, selectedNumbers, 
                remainderInput, "C79"
            ];
        } else if (mode === "lang") {
            const classChoiceSelection = document.querySelector('#class_choice').value;
            classChoice = classChoiceSelection;

            let modeChoice8Selection = document.querySelector('#mode_choice_8').value;
            modeChoice1 = modeChoice8Selection;

            const modeChoice9Selection = document.querySelector('#mode_choice_9').value;

            modeChoice2 = modeChoice9Selection;

            const selectedOptions = getSelectedRasybaConditions();

            const sortedModeChoice3 = Object.fromEntries(
            Object.entries(selectedOptions).sort(([a], [b]) => {
                const numA = parseInt(a.slice(1));
                const numB = parseInt(b.slice(1));
                return numA - numB;
            })
            );

            modeChoice3 = sortedModeChoice3;

            const modeChoice12Selection = document.querySelector('#mode_choice_12').value;
            modeChoice5 = modeChoice12Selection;

            const modeChoiceLtDifficulty = document.getElementById('mode_choice_10').value;

            const modeChoice14Selection = document.getElementById('mode_choice_14').value;
            const modeChoice15Selection = document.getElementById('mode_choice_15').value;

            let questionFrequency;
            if (classChoice === "C75") {
                let modeChoice13Selection = document.querySelector('#mode_choice_13').value;
                questionFrequency = Number(modeChoice13Selection);
            } else {
                questionFrequency = 1;
            }
            
            if (modeChoice1 === "C49") {
                task = [
                    mode, modeChoice1, modeChoice2, modeChoice14Selection, modeChoice15Selection, classChoiceSelection, modeChoiceLtDifficulty
                ];
            } else if (modeChoice1 === "C83") {
                if (modeChoice2 === "C50") {
                    task = [
                        mode, modeChoice1, modeChoice2, classChoiceSelection, modeChoice3,
                        modeChoice5, questionFrequency
                    ];
                }
            }
        }

        if (taskHistoryCurrentTask) {
        if (!arraysEqual(taskHistoryCurrentTask, task)) {
            clearTaskAverageCache();
            taskHistoryCurrentTask = JSON.parse(JSON.stringify(task));
        }
        } else {
            taskHistoryCurrentTask = JSON.parse(JSON.stringify(task));
        }

        let selectedStudent = document.querySelector(".outer-student-list-entry-item .student-name.selected-option");
        if (!selectedStudent) {
            selectedStudent = document.querySelector(".outer-student-list-entry-item .student-name");
        }

        const selectedStudentId = Number(selectedStudent.dataset.studentId)

        retrieveTaskHistoryInformation(selectedStudentId, task);
    }

    async function retrieveTaskHistoryInformation (studentId, task) {
        disableNewTaskContainer();
        disableTeacherControlPannel();
        disableConfirmationButtons();
        document.querySelectorAll(".student-name").forEach(el => {
            el.style.pointerEvents = "none"; // stops clicks
            el.style.opacity = "0.7";        // visual cue
            el.style.cursor = "default";     // change cursor
        });

        let retrievedDataInstance = await fetchTaskStats(studentId, task);

        if (retrievedDataInstance) {
            enableConfirmationButtons();
            enableTeacherControlPannel();
            document.getElementById("task-group-sorting").disabled = true;
            enableNewTaskContainer();
            document.querySelector(`.student-name[data-student-id="${studentId}"]`).classList.add("selected-option");;

            document.querySelectorAll(".student-name").forEach(el => {
                el.style.pointerEvents = "auto"; // restore clicks
                el.style.opacity = "1";
                el.style.cursor = "pointer";
            });

            initTaskHistoryGraph(retrievedDataInstance);
            document.getElementById('confirm-button').disabled = true;
            newTaskOptions.style.display = 'none';
            document.querySelector("#student-task-history-container").style.display = "flex";
            document.getElementById("new-search-button").disabled = false;
        } else {
            toggleBrowseHistory();
            taskContainerVisible = true;
            toggleTaskVisibility();
            hideConfirmationButtons();
            document.getElementById("task-group-sorting").disabled = true;
            fetchDataForTeachers();
        }
    }

    async function displayRetrievedTaskHistoryData () {
        return
    }

    // TASK HISTORY GRAPH START

    // Graph state management
        const taskHistoryState = {
            selectedMetrics: ['mistakeFrequency'], // Default: show mistake frequency
            startDate: null,
            endDate: null,
            chart: null,
            rawData: null
        };

        // Available metrics configuration
        const taskHistoryMetrics = [
            {
                id: 'mistakeFrequency',
                label: 'Klaid≈≥ da≈ænis',
                color: '#ef4444',
                yAxisID: 'y-percent',
                isPercent: true
            },
            {
                id: 'answerRate',
                label: 'Atsakym≈≥ greitis',
                color: '#3b82f6',
                yAxisID: 'y-rate',
                isPercent: false
            }
        ];

        // Initialize metric buttons
        function initTaskHistoryButtons() {
            const container = document.getElementById('taskHistoryMetrics');
            container.innerHTML = '';

            taskHistoryMetrics.forEach(metric => {
                const btn = document.createElement('button');
                btn.className = 'task-history-btn-metric';
                btn.textContent = metric.label;
                btn.setAttribute('data-metric-id', metric.id);
                
                if (taskHistoryState.selectedMetrics.includes(metric.id)) {
                    btn.classList.add('active');
                }

                btn.onclick = () => toggleTaskHistoryMetric(metric.id);
                container.appendChild(btn);
            });
        }

        // Toggle metric selection
        function toggleTaskHistoryMetric(metricId) {
            const index = taskHistoryState.selectedMetrics.indexOf(metricId);
            
            if (index !== -1) {
                taskHistoryState.selectedMetrics.splice(index, 1);
            } else {
                taskHistoryState.selectedMetrics.push(metricId);
            }

            updateTaskHistoryButtons();
            renderTaskHistoryGraph();
        }

        // Update button states
        function updateTaskHistoryButtons() {
            const buttons = document.querySelectorAll('.task-history-btn-metric');
            buttons.forEach(btn => {
                const metricId = btn.getAttribute('data-metric-id');
                if (taskHistoryState.selectedMetrics.includes(metricId)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Initialize date inputs
        function initTaskHistoryDateInputs(data) {
            if (!data || !data.studentDates || data.studentDates.length === 0) {
                return;
            }

            const startInput = document.getElementById('taskHistoryStartDate');
            const endInput = document.getElementById('taskHistoryEndDate');

            const minDate = data.studentDates[0];
            const maxDate = data.studentDates[data.studentDates.length - 1];

            // Set default range if not already set
            if (!taskHistoryState.startDate) {
                taskHistoryState.startDate = minDate;
            }
            if (!taskHistoryState.endDate) {
                taskHistoryState.endDate = maxDate;
            }

            startInput.value = taskHistoryState.startDate;
            endInput.value = taskHistoryState.endDate;

            startInput.onchange = (e) => {
                taskHistoryState.startDate = e.target.value;
                renderTaskHistoryGraph();
            };

            endInput.onchange = (e) => {
                taskHistoryState.endDate = e.target.value;
                renderTaskHistoryGraph();
            };
        }

        // Filter data by date range
        function filterTaskHistoryData(data) {
            if (!taskHistoryState.startDate || !taskHistoryState.endDate) {
                return data;
            }

            const start = new Date(taskHistoryState.startDate);
            const end = new Date(taskHistoryState.endDate);

            // Filter student data
            const filteredStudentIndices = [];
            const filteredStudentDates = [];
            const filteredMistakeFreq = [];
            const filteredAnswerRate = [];

            data.studentDates.forEach((date, i) => {
                const d = new Date(date);
                if (d >= start && d <= end) {
                    filteredStudentIndices.push(i);
                    filteredStudentDates.push(date);
                    filteredMistakeFreq.push(data.mistakeFrequency[i]);
                    filteredAnswerRate.push(data.answerRate[i]);
                }
            });

            // Filter average data
            const filteredAverageIndices = [];
            const filteredAverageDates = [];
            const filteredAvgMistakeFreq = [];
            const filteredAvgAnswerRate = [];

            data.averageDates.forEach((date, i) => {
                const d = new Date(date);
                if (d >= start && d <= end) {
                    filteredAverageIndices.push(i);
                    filteredAverageDates.push(date);
                    filteredAvgMistakeFreq.push(data.averageMistakeFrequency[i]);
                    filteredAvgAnswerRate.push(data.averageAnswerRate[i]);
                }
            });

            return {
                studentDates: filteredStudentDates,
                mistakeFrequency: filteredMistakeFreq,
                answerRate: filteredAnswerRate,
                averageDates: filteredAverageDates,
                averageMistakeFrequency: filteredAvgMistakeFreq,
                averageAnswerRate: filteredAvgAnswerRate
            };
        }

        // Generate nice x-axis labels
        function generateXAxisLabels(dates) {
            if (!dates || dates.length === 0) return [];

            const sortedDates = [...dates].sort();
            const firstDate = new Date(sortedDates[0]);
            const lastDate = new Date(sortedDates[sortedDates.length - 1]);
            const daysDiff = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24));

            let interval;
            if (daysDiff <= 7) {
                interval = 1; // Daily
            } else if (daysDiff <= 30) {
                interval = 3; // Every 3 days
            } else if (daysDiff <= 90) {
                interval = 7; // Weekly
            } else if (daysDiff <= 180) {
                interval = 14; // Bi-weekly
            } else {
                interval = 30; // Monthly
            }

            const labels = [];
            const currentDate = new Date(firstDate);
            
            while (currentDate <= lastDate) {
                labels.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + interval);
            }

            return labels;
        }

        // Render the graph
        function renderTaskHistoryGraph() {
            if (taskHistoryState.chart) {
                taskHistoryState.chart.destroy();
                taskHistoryState.chart = null;
            }

            if (!taskHistoryState.rawData) {
                document.querySelector('.task-history-chart-wrapper').innerHTML = 
                    '<div class="task-history-empty">Nƒóra duomen≈≥</div>';
                return;
            }

            const filteredData = filterTaskHistoryData(taskHistoryState.rawData);

            if (filteredData.studentDates.length === 0) {
                document.querySelector('.task-history-chart-wrapper').innerHTML = 
                    '<div class="task-history-empty">Nƒóra duomen≈≥ pasirinktam laikotarpiui</div>';
                return;
            }

            // Ensure canvas exists
            let canvas = document.getElementById('taskHistoryChart');
            if (!canvas) {
                document.querySelector('.task-history-chart-wrapper').innerHTML = 
                    '<canvas id="taskHistoryChart"></canvas>';
                canvas = document.getElementById('taskHistoryChart');
            }

            const datasets = [];

            // Add student data
            taskHistoryState.selectedMetrics.forEach(metricId => {
                const metric = taskHistoryMetrics.find(m => m.id === metricId);
                if (!metric) return;

                const dataKey = metricId;
                const studentData = filteredData[dataKey];

                if (studentData && studentData.length > 0) {
                    datasets.push({
                        label: metric.label,
                        data: filteredData.studentDates.map((date, i) => ({
                            x: date,
                            y: studentData[i]
                        })),
                        borderColor: metric.color,
                        backgroundColor: metric.color + '20',
                        borderWidth: 3,
                        tension: 0.3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        yAxisID: metric.yAxisID
                    });

                    // Add average line
                    const avgDataKey = 'average' + metricId.charAt(0).toUpperCase() + metricId.slice(1);
                    const avgData = filteredData[avgDataKey];

                    if (avgData && avgData.length > 0) {
                        datasets.push({
                            label: metric.label + ' (klasƒós vid.)',
                            data: filteredData.averageDates.map((date, i) => ({
                                x: date,
                                y: avgData[i]
                            })),
                            borderColor: metric.color,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            yAxisID: metric.yAxisID,
                            opacity: 0.6
                        });
                    }
                }
            });

            const allDates = [...new Set([...filteredData.studentDates, ...filteredData.averageDates])].sort();
            const xLabels = generateXAxisLabels(allDates);

            const yAxes = {};

            // Add percentage axis if needed
            if (taskHistoryState.selectedMetrics.includes('mistakeFrequency')) {
                yAxes['y-percent'] = {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    min: 0,
                    max: 100,
                    ticks: {
                        callback: (value) => value + '%',
                        color: '#666'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    border: { display: false }
                };
            }

            // Add rate axis if needed
            if (taskHistoryState.selectedMetrics.includes('answerRate')) {
                yAxes['y-rate'] = {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    min: 0,
                    ticks: {
                        callback: (value) => value.toFixed(1),
                        color: '#666'
                    },
                    grid: {
                        drawOnChartArea: !taskHistoryState.selectedMetrics.includes('mistakeFrequency'),
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    border: { display: false }
                };
            }

            const ctx = canvas.getContext('2d');
            taskHistoryState.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: xLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const yAxisId = context.dataset.yAxisID;
                                    if (yAxisId === 'y-percent') {
                                        label += context.parsed.y + '%';
                                    } else {
                                        label += context.parsed.y.toFixed(1);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: yAxes
                }
            });
        }

        // Main initialization function
        function initTaskHistoryGraph(data) {
            taskHistoryState.rawData = data;
            initTaskHistoryButtons();
            initTaskHistoryDateInputs(data);
            renderTaskHistoryGraph();
        }

    // TASK HISTORY GRAPH END
    

    if (userData) {
        if (userData.accType === 'teacher') {
            teacherGUI.style.display = 'flex';
            fetchDataForTeachers();
            initTxtViewer();
            window.openTextBrowser = openTextBrowser;
        } else if (userData.accType === 'student') {
            studentGUI.style.display = 'flex';
            fetchDataForStudents();
        }
    }

function disableTeacherControlPannel() {
    const parentDiv = document.getElementById('student-details-for-teachers');
    const children = parentDiv.querySelectorAll('button, input, select, textarea');  // Add more form elements if needed
    children.forEach(child => child.disabled = true);
}

function enableTeacherControlPannel() {
    const parentDiv = document.getElementById('student-details-for-teachers');
    const children = parentDiv.querySelectorAll('button, input, select, textarea');
    children.forEach(child => child.disabled = false);
}

function disableNewTaskContainer() {
    const parentDiv = document.getElementById('new-task-options-container');
    const children = parentDiv.querySelectorAll('button, input, select, textarea');  // Add more form elements if needed
    children.forEach(child => child.disabled = true);
}

function enableNewTaskContainer() {
    const parentDiv = document.getElementById('new-task-options-container');
    const children = parentDiv.querySelectorAll('button, input, select, textarea');
    children.forEach(child => child.disabled = false);
}



document.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        event.preventDefault(); // Optional: prevent form submission or other default behavior
        document.getElementById("submitButton").click();
    }
});












const sidebarWrapper = document.getElementById('sidebarWrapper');
const toggleTab = document.getElementById('toggleTab');
const sidebarContent = document.getElementById('sidebarContent');

// Toggle sidebar function
function toggleSidebar() {
    // Only works on mobile
    sidebarWrapper.classList.toggle('open');
}

// Open sidebar function
function openSidebar() {
    sidebarWrapper.classList.add('open');
}

// Close sidebar function
function closeSidebar() {
    sidebarWrapper.classList.remove('open');
}

// Event listeners
toggleTab.addEventListener('click', toggleSidebar);

// Handle escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && sidebarWrapper.classList.contains('open')) {
    closeSidebar();
    }
});

// Close sidebar on window resize if it becomes desktop size
window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
    closeSidebar();
    }
});


const sidebarWrapperStudent = document.getElementById('sidebarWrapperStudent');
const toggleTabStudent = document.getElementById('toggleTabStudent');
const sidebarContentStudent = document.getElementById('sidebarContentStudent');

// Toggle sidebar function
function toggleSidebarStudent() {
    sidebarWrapperStudent.classList.toggle('open');
}

// Open sidebar function
function openSidebarStudent() {
    sidebarWrapperStudent.classList.add('open');
}

// Close sidebar function
function closeSidebarStudent() {
    sidebarWrapperStudent.classList.remove('open');
}

// Event listeners
toggleTabStudent.addEventListener('click', toggleSidebarStudent);

// Handle escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && sidebarWrapperStudent.classList.contains('open')) {
        closeSidebarStudent();
    }
});

// Close sidebar on window resize if it becomes desktop size
window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
        closeSidebarStudent();
    }
});







// Initialize button state
let currentAction = null;


function showConfirmationButtons(action) {
    currentAction = action;
    
    // Update confirm button label based on action
    const confirmLabel = document.getElementById('confirm-label');
    const cancelLabel = document.getElementById('cancel-label');

    switch(action) {
        case 'new-task':
            confirmLabel.textContent = 'Sukurti u≈æduotƒØ';
            cancelLabel.textContent = 'At≈°aukti';
            toggleAddNewTask();
            break;
        case 'delete-task':
            confirmLabel.textContent = 'Trinti u≈æduotis';
            cancelLabel.textContent = 'At≈°aukti';
            toggleDeleteTask();
            break;
        case 'delete-student':
            confirmLabel.textContent = '≈†alinti mokinius';
            cancelLabel.textContent = 'At≈°aukti';
            toggleDeleteStudent();
            break;
        case 'browse-history':
            confirmLabel.textContent = 'Ie≈°koti';
            cancelLabel.textContent = 'U≈ædaryti istorijƒÖ';
            toggleBrowseHistory();
            break;
    }
    
    document.getElementById('action-buttons-container').style.display = 'none';
    document.getElementById('confirmation-buttons-container').style.display = 'flex';
    if (action === "browse-history") {
        document.getElementById('new-search-button').style.display = 'flex';
    }
}

function hideConfirmationButtons() {
    document.getElementById('confirm-button').disabled = false;
    document.getElementById('cancel-button').disabled = false;
    document.getElementById('confirmation-buttons-container').style.display = 'none';
    document.getElementById('new-search-button').disabled = false;
    document.getElementById('new-search-button').style.display = 'none';
    document.getElementById('action-buttons-container').style.display = 'flex';
    currentAction = null;
}

function disableConfirmationButtons() {
    document.getElementById('confirm-button').disabled = true;
    document.getElementById('cancel-button').disabled = true;
    document.getElementById('new-search-button').disabled = true;
}

function enableConfirmationButtons() {
    document.getElementById('confirm-button').disabled = false;
    document.getElementById('cancel-button').disabled = false;
    document.getElementById('new-search-button').disabled = false;
}

// Set up button click handlers
document.addEventListener('DOMContentLoaded', () => {
    // Action buttons
    document.getElementById('new-task-button').addEventListener('click', () => {
        showConfirmationButtons('new-task');
    });
    
    document.getElementById('delete-task-button').addEventListener('click', () => {
        showConfirmationButtons('delete-task');
    });
    
    document.getElementById('delete-student-button').addEventListener('click', () => {
        showConfirmationButtons('delete-student');
    });

     document.getElementById('browse-task-history-button').addEventListener('click', () => {
        showConfirmationButtons('browse-history');
    });
    
    // Confirmation buttons
    document.getElementById('confirm-button').addEventListener('click', () => {
        if (currentAction === 'new-task') {
            setTask();
        } else if (currentAction === 'delete-task') {
            deleteSelectedTasks();
        } else if (currentAction === 'delete-student') {
            deleteStudents();
        } else if (currentAction === 'browse-history') {
            setTaskHistoryQuery();
        }
    });
    
    document.getElementById('cancel-button').addEventListener('click', () => {
         if (currentAction === 'new-task') {
            toggleAddNewTask();
        } else if (currentAction === 'delete-task') {
            toggleDeleteTask();
        } else if (currentAction === 'delete-student') {
            toggleDeleteStudent();
        } else if (currentAction === 'browse-history') {
            toggleBrowseHistory();
        }
        hideConfirmationButtons();
    });
});

function incrementValue(inputId, min, max) {
    const input = document.getElementById(inputId);
    let value = parseInt(input.value) || min;
    if (value < max) {
        input.value = value + 1;
    }
    setLabelEndingForDuration();
    setLabelEndingForQuestionNumber();
}

function decrementValue(inputId, min, max) {
    const input = document.getElementById(inputId);
    let value = parseInt(input.value) || min;
    if (value > min) {
        input.value = value - 1;
    }
    setLabelEndingForDuration();
    setLabelEndingForQuestionNumber();
}

// Validate input on change
document.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('change', function() {
        const min = parseInt(this.min);
        const max = parseInt(this.max);
        let value = parseInt(this.value);
        
        if (isNaN(value) || value < min) {
            this.value = min;
        } else if (value > max) {
            this.value = max;
        }
    });
});

function displayFrequentMistakes () {
    generateSummaryTable('total', null, "summary-table-frequent-mistakes", "summary-table-grammar-frequent-mistakes");
    clearTaskInfoContainerForStudents();
    frequentMistakeContainerElement.style.display = "flex";
    openSidebarStudent();
}

    function displayMathSummary () {
            document.querySelector("#display-math-summary-button").classList.add("active-summary-button")
            document.querySelector("#display-grammar-summary-button").classList.remove("active-summary-button")
            document.querySelector("#summary-table-outer-div").style.display = "flex";
            document.querySelector("#summary-table-grammar-outer-div").style.display = "none";
            if (document.querySelector("#summary-table").innerHTML === "Klaid≈≥ nƒóra!") {
                document.querySelector("#table-container-math").style.boxShadow = "none";
                document.querySelector("#mistakes-summary-math").style.fontSize = "2rem";
                document.querySelector("#summary-table").style.height = "200px";
            }
        }

    function displayGrammarSummary () {
        document.querySelector("#display-math-summary-button").classList.remove("active-summary-button")
        document.querySelector("#display-grammar-summary-button").classList.add("active-summary-button")
        document.querySelector("#summary-table-outer-div").style.display = "none";
        document.querySelector("#summary-table-grammar-outer-div").style.display = "flex";

        if ((document.querySelector("#summary-table-grammar").innerHTML === "Klaid≈≥ nƒóra!")) {
                document.querySelector("#table-container-grammar").style.boxShadow = "none";
                document.querySelector("#mistakes-summary-grammar").style.fontSize = "2rem";
                document.querySelector("#summary-table-grammar").style.height = "200px";
        }
    }

function editStudentName(studentId, buttonEl) {
    const studentNameSpan = document.getElementById('student-name');

    const input = document.createElement('input');
    input.type = 'text';
    input.value = studentNameSpan.textContent;
    input.maxLength = 30;
    input.className = 'student-name-field';

    studentNameSpan.replaceWith(input);
    input.focus();

    input.addEventListener('input', () => {
        input.style.width = Math.max(input.value.length + 1.5) + 'ch';
    });

    input.dispatchEvent(new Event('input'));

    buttonEl.innerHTML = '<span class="edit-icon"><img src="../images/icons/icon-check-black.svg"></span>';
    buttonEl.setAttribute('onclick', `saveStudentName('${studentId}', this)`);
}

// Add this function to your script section in uzduotys.html

async function saveStudentName(studentId, buttonEl) {
    const input = document.querySelector('.student-name-field');
    const newName = input.value.trim();
    
    // Validation
    if (newName.length === 0) {
        messageToTheUser("Vardas negali b≈´ti tu≈°ƒçias!");
        // Revert to edit mode
        editStudentName(studentId, buttonEl);
        return;
    }
    
    if (newName.length > 30) {
        messageToTheUser("Maksimalus vardo ilgis yra 30 simboli≈≥.");
        return;
    }
    
    // Find the student in studentList
    const student = studentList.find(s => s.id === parseInt(studentId));
    if (!student) {
        messageToTheUser("Mokinys nerastas!");
        return;
    }
    
    // Check if name actually changed
    if (newName === student.nickname) {
        // No change, just revert to display mode
        const span = document.createElement('span');
        span.id = 'student-name';
        span.textContent = newName;
        input.replaceWith(span);
        
        buttonEl.innerHTML = '<span class="edit-icon"><img src="../images/icons/icon-edit.svg"></span>';
        buttonEl.setAttribute('onclick', `editStudentName('${studentId}', this)`);
        return;
    }
    
    // Disable button during save
    buttonEl.disabled = true;
    input.disabled = true;
    
    try {
        const response = await apiFetch(apiBase + 'students/update-nickname', {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                studentId: parseInt(studentId),
                nickname: newName
            })
        });
        
        if (!response) {
            return;
        }
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.message === "Nickname updated successfully") {
            // Update the student in studentList
            student.nickname = newName;
            
            // Update all instances in the UI
            updateStudentNameInUI(studentId, newName);
            
            messageToTheUser("Vardas sƒókmingai atnaujintas!", false);
        }
        
    } catch (error) {
        console.error('Error updating student name:', error);
        if (error.message === "Unauthorized") {
            clearUserData();
            window.location.href = "prisijungimas";
        } else {
            messageToTheUser('Nepavyko atnaujinti vardo. Bandykite vƒól vƒóliau.');
        }
    } finally {
        // Revert to display mode
        const span = document.createElement('span');
        span.id = 'student-name';
        span.textContent = newName;
        input.replaceWith(span);
        
        buttonEl.disabled = false;
        buttonEl.innerHTML = '<span class="edit-icon"><img src="../images/icons/icon-edit.svg"></span>';
        buttonEl.setAttribute('onclick', `editStudentName('${studentId}', this)`);
    }
}

function updateStudentNameInUI(studentId, newName) {
    // Update in the student list sidebar
    const studentListItems = document.querySelectorAll('.student-name');
    studentListItems.forEach(item => {
        const text = item.textContent;
        // Match pattern: "number. oldName (ID: studentId)"
        const regex = new RegExp(`(\\d+\\.\\s+).+?\\(ID:\\s*${studentId}\\)`);
        if (regex.test(text)) {
            const match = text.match(/^(\d+\.)\s+/);
            if (match) {
                item.textContent = `${match[1]} ${newName} (ID: ${studentId})`;
            }
        }
    });
    
    // Update in the main display area if this student is currently selected
    const displayedStudentId = document.getElementById('student-id');
    if (displayedStudentId && displayedStudentId.textContent.includes(studentId)) {
        const studentNameSpan = document.getElementById('student-name');
        if (studentNameSpan) {
            studentNameSpan.textContent = newName;
        }
    }
}


   
function updateButtonLayout() {
  const container = document.getElementById('action-buttons-container');
  const buttons = Array.from(container.querySelectorAll('.teacher-action-btn'));
  const labels = container.querySelectorAll('.btn-label');
  
  // Remove two-row class from all
  labels.forEach(label => label.classList.remove('two-rows-button-label'));
  
  // Force reflow
  container.offsetHeight;
  
  setTimeout(() => {
    // Check if ANY label has wrapped internally (height > one line)
    let anyLabelWrapped = false;
    
    labels.forEach(label => {
      const spans = label.querySelectorAll('span');
      if (spans.length >= 2) {
        const firstSpanTop = spans[0].getBoundingClientRect().top;
        const secondSpanTop = spans[1].getBoundingClientRect().top;
        
        // If spans are on different lines, this label wrapped
        if (Math.abs(secondSpanTop - firstSpanTop) > 5) {
          anyLabelWrapped = true;
        }
      }
    });
    
    // If ANY label wrapped, make ALL labels two-row
    if (anyLabelWrapped) {
      labels.forEach(label => label.classList.add('two-rows-button-label'));
    }
  }, 50);
}

window.addEventListener('load', updateButtonLayout);
window.addEventListener('resize', updateButtonLayout);

window.onload = function () {
    const savedController = localStorage.getItem('controller');
    if (savedController) {
        controller = JSON.parse(savedController);
        redirectToAppropriateLanguage(controller.language);
        resetControllerTaskSettings();
    } else {
        controller.language = "LT";
        localStorage.setItem('controller', JSON.stringify(controller));
    }
}

function addHideScrollbarForTouch() {
    // Check if device is touchscreen
    const isTouchDevice = ('ontouchstart' in window) || 
                          (navigator.maxTouchPoints > 0) || 
                          (navigator.msMaxTouchPoints > 0);

    if (!isTouchDevice) { 
        document.querySelector(".chart-container .scroll-indicator-line-horizontal.bottom").style.bottom = "36px";
        return;
    }

    if (window.matchMedia('(max-width: 578px)').matches) {
        document.querySelector(".chart-container .scroll-indicator-line-horizontal.bottom").style.bottom = "16px";
    } else {
        document.querySelector(".chart-container .scroll-indicator-line-horizontal.bottom").style.bottom = "26px";
    }

    // Select all chart-body elements
    const chartBodies = document.querySelectorAll('.chart-body');

    chartBodies.forEach(el => {
        el.classList.add('hide-scrollbar');
    });
}

window.addEventListener('load', addHideScrollbarForTouch);
window.addEventListener('resize', addHideScrollbarForTouch);


// TEXT VIEWER START
// Global variables
let prefilteredTexts = [];
let allTexts = [];
let selectedIds = [];
let isSelectionModeEnabled = false;
let expandedTextIds = new Set();
let isMainBrowserExpanded = false;

// Cache for pre-processed search data
let textSearchCache = new Map();

// Debounce timer
let searchDebounceTimer = null;

async function initTxtViewer() {
    try {
        const response = await fetch('../databases/sudedu_duomenu_baze.json');
        prefilteredTexts = await response.json();

        // Apply initial filtering
        refilterTexts();

        // Attach listeners with debouncing for search
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                applyFilters();
            }, 150); // 150ms debounce
        });

        document.getElementById('mainBrowserHeader').addEventListener('click', () => toggleMainBrowser(false));
        document.getElementById('allFiltersHeader').addEventListener('click', () => toggleAllFilters(false));

        // Dropdown change triggers re-filtering only
        document.getElementById('mode_choice_9').addEventListener('change', () => {
            refilterTexts();
            applyFilters();
        });

        updateSelectionModeVisibility();
        applyFilters();

    } catch (err) {
        console.error('Error loading texts:', err);
        document.getElementById('textsList').innerHTML =
            '<div class="txt-viewer-no-results">Klaida ƒØkeliant tekstus</div>';
    }
}

function refilterTexts() {
    if (!prefilteredTexts.length) return;

    if (isSelectionModeEnabled) {
        const mode = document.getElementById('mode_choice_9').value;

        allTexts = prefilteredTexts.filter(entry => {
            const s = entry['suitable-for'];
            if (!s) return false;
            if (mode === 'C51') return s.komponavimas;
            if (mode === 'C52') return s.struktura;
            return false;
        });

    } else {
        allTexts = prefilteredTexts.filter(entry => {
            const s = entry['suitable-for'];
            return s && (s.komponavimas || s.struktura);
        });
    }

    // Rebuild search cache when allTexts changes
    buildSearchCache();

    selectedIds = [];
    updateSelectionModeVisibility();
    updateSelectedIdsDisplay();
    applyFilters();
}

// Pre-build searchable text for each item
function buildSearchCache() {
    textSearchCache.clear();
    
    allTexts.forEach(text => {
        const searchableText = [
            text.id.toString(),
            text.title,
            text.author,
            ...text.text.start,
            ...text.text.middle,
            ...text.text.end,
            ...text.text.distractor
        ].join(' ').toLowerCase();
        
        textSearchCache.set(text.id, searchableText);
    });
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

    // Check if search term is only a number
    const isNumericSearch = /^\d+$/.test(searchTerm);

    // Cache DOM queries
    const classFilters = {
        '1_2_klase': document.getElementById('class_1_2').checked,
        '3_4_klase': document.getElementById('class_3_4').checked
    };

    const taskTypes = {
        struktura: document.getElementById('task_struktura').checked,
        komponavimas: document.getElementById('task_komponavimas').checked
    };

    const difficulties = {
        lengvas: document.getElementById('diff_lengvas').checked,
        vidutinis: document.getElementById('diff_vidutinis').checked,
        sunkus: document.getElementById('diff_sunkus').checked
    };

    const filteredTexts = allTexts.filter(text => {
        // If numeric search, match ID exactly - early exit
        if (isNumericSearch) {
            return text.id.toString() === searchTerm;
        }

        const textClass = text['class-choice'][0];
        if (!classFilters[textClass]) return false;

        const strukturaDiff = text['suitable-for'].struktura;
        const komponavimasDiff = text['suitable-for'].komponavimas;

        const strukturaMatch = taskTypes.struktura && difficulties[strukturaDiff];
        const komponavimasMatch = taskTypes.komponavimas && difficulties[komponavimasDiff];

        if (!strukturaMatch && !komponavimasMatch) return false;

        // Use cached searchable text
        if (searchTerm) {
            const searchableText = textSearchCache.get(text.id);
            if (!searchableText || !searchableText.includes(searchTerm)) return false;
        }

        return true;
    });

    renderTexts(filteredTexts);
}

function renderTexts(texts) {
    const container = document.getElementById('textsList');

    if (texts.length === 0) {
        container.innerHTML = '<div class="txt-viewer-no-results">Tekst≈≥ nerasta</div>';
        return;
    }

    // Use DocumentFragment for better performance
    const fragment = document.createDocumentFragment();
    const tempDiv = document.createElement('div');
    
    // Build HTML string (faster than creating elements one by one)
    tempDiv.innerHTML = texts.map(text => {
        const isExpanded = expandedTextIds.has(text.id);
        const isSelected = selectedIds.includes(text.id);

        return `
            <div class="txt-viewer-text-item ${isExpanded ? 'text-item-expanded' : ''}" id="text-item-${text.id}">
                <div class="txt-viewer-text-item-header">
                    ${isSelectionModeEnabled ? `
                        <input type="checkbox" class="txt-viewer-text-item-checkbox" data-text-id="${text.id}" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleTextSelection(${text.id}, this.checked)">
                    ` : ''}
                    <div class="txt-viewer-text-item-main" onclick="toggleTextExpand(${text.id})">
                        <div class="txt-viewer-text-item-info">
                            <div class="txt-viewer-text-item-id">ID: ${text.id}</div>
                            <div class="txt-viewer-text-item-title">${text.title}</div>
                        </div>
                        <div class="txt-viewer-text-item-expand-icon ${isExpanded ? 'txt-viewer-expanded' : ''}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
                        <path d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"/>
                        </svg>
                        </div>
                    </div>
                </div>
                <div class="hide-scrollbar txt-viewer-text-item-details ${isExpanded ? 'txt-viewer-expanded scroll-indicators' : ''}" id="text-details-${text.id}">
                    ${isExpanded ? renderTextDetails(text) : ''}
                </div>
            </div>
        `;
    }).join('');

    // Replace all content at once
    container.innerHTML = '';
    while (tempDiv.firstChild) {
        container.appendChild(tempDiv.firstChild);
    }
}

function renderTextDetails(text) {
    // Classes - cache the replace operations
    const lowerClasses = text['class-choice']
        .filter(cls => cls.startsWith('1') || cls.startsWith('2'))
        .map(cls => cls.replace(/_(?=[^_]+$)/, ' ').replace('_', '-').replace('klase', 'klasƒó'))
        .join(', ');

    const higherClasses = text['class-choice']
        .filter(cls => cls.startsWith('3') || cls.startsWith('4'))
        .map(cls => cls.replace(/_(?=[^_]+$)/, ' ').replace('_', '-').replace('klase', 'klasƒó'))
        .join(', ');

    // Determine which sections exist
    const startEmpty = !text.text.start || text.text.start.length === 0;
    const middleEmpty = !text.text.middle || text.text.middle.length === 0;
    const endEmpty = !text.text.end || text.text.end.length === 0;

    // Build sections
    let textSections = '';

    if (!startEmpty && !middleEmpty && !endEmpty) {
        textSections += `
        <div class="text-section">
            <div class="text-section-title">Prad≈æia</div>
            ${text.text.start.map(p => `<div class="text-section-paragraph">${p}</div>`).join('')}
        </div>
        <div class="text-section">
            <div class="text-section-title">ƒÆvykio raida</div>
            ${text.text.middle.map(p => `<div class="text-section-paragraph">${p}</div>`).join('')}
        </div>
        <div class="text-section">
            <div class="text-section-title">Pabaiga</div>
            ${text.text.end.map(p => `<div class="text-section-paragraph">${p}</div>`).join('')}
        </div>`;
    } else {
        const combinedText = [
            ...(text.text.start || []),
            ...(text.text.middle || []),
            ...(text.text.end || [])
        ].filter(p => p && p.trim() !== '')
         .join(' ');

        if (combinedText) {
            textSections += `
            <div class="text-section">
                <div class="text-section-title">Tekstas</div>
                <div class="text-section-paragraph">${combinedText}</div>
            </div>`;
        }
    }

    const distractorSection = (text.text.distractor && text.text.distractor.length > 0)
        ? `<div class="text-section">
               <div class="text-section-title">Distraktorius</div>
               ${text.text.distractor.map(p => `<div class="text-section-paragraph">${p}</div>`).join('')}
           </div>`
        : '';

    return `
    <div class="text-detail-row">
        <div class="text-detail-content">
            ${lowerClasses ? `<span class="badge badge-class-lower">${lowerClasses}</span>` : ''}
            ${higherClasses ? `<span class="badge badge-class-higher">${higherClasses}</span>` : ''}

            ${text['suitable-for'].struktura ? `<span class="badge badge-struktura">Strukt≈´ros i≈°dƒóstymas: ${text['suitable-for'].struktura}</span>` : ''}
            ${text['suitable-for'].komponavimas ? `<span class="badge badge-komponavimas">Turinio komponavimas: ${text['suitable-for'].komponavimas}</span>` : ''}
        </div>
    </div>

    <div class="text-detail-row">
        <div class="text-detail-content">
            ${textSections}
        </div>
    </div>

    ${distractorSection ? `
    <div class="text-detail-row">
        <div class="text-detail-content">
            ${distractorSection}
        </div>
    </div>` : ''}

    <div class="text-detail-row">
        <div class="text-detail-label">Autorius</div>
        <div class="text-detail-content">${text.author}</div>
    </div>
    `;
}

function toggleMainBrowser(closeMainBrowser=false) {
    const content = document.getElementById('mainBrowserContent');
    const icon = document.getElementById('mainBrowserIcon');
    const viewer = document.querySelector(".txt-viewer-container");
    isMainBrowserExpanded = !isMainBrowserExpanded;

    if (isMainBrowserExpanded && !closeMainBrowser) {
        viewer.style.height = `${parseFloat(getComputedStyle(document.querySelector('.left-side-bar')).height)}px`;
        
        content.style.display = 'block';
        content.style.height = 'auto';
        const height = content.offsetHeight;
        content.style.height = '0px';
        
        requestAnimationFrame(() => {
            content.classList.add('expanded');
            content.style.height = height + 'px';
            icon.classList.remove('collapsed');
        });
        
        content.addEventListener('transitionend', () => {
            if (isMainBrowserExpanded) {
                content.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }
        }, { once: true });
    } else {
        content.style.height = content.scrollHeight + 'px';
        icon.classList.add('collapsed');
        
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                content.classList.remove('expanded');
                content.style.height = '0px';
            });
        });
        
        content.addEventListener('transitionend', () => {
            if (!isMainBrowserExpanded) {
                content.style.display = 'none';
            }
        }, { once: true });
        
        viewer.style.height = '';

        isMainBrowserExpanded = false;
    }
}

function toggleAllFilters(closeFilters=false) {
    const content = document.getElementById('allFiltersContent');
    const icon = document.getElementById('allFiltersIcon');
    const mainBrowser = document.getElementById('mainBrowserContent');
    const isExpanding = content.classList.contains('txt-viewer-collapsed');
    
    if (closeFilters) {
        if (!content.classList.contains('txt-viewer-collapsed')) {
            content.classList.add('txt-viewer-collapsed');
            icon.classList.add('txt-viewer-collapsed');
        } 
    } else {
        content.classList.toggle('txt-viewer-collapsed');
        icon.classList.toggle('txt-viewer-collapsed');
    }
    
    if (isExpanding) {
        content.addEventListener('transitionend', () => {
            mainBrowser.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }, { once: true });
    }
}

function updateSelectionModeVisibility() {
    const container = document.getElementById('selectedIdsContainer');
    if (isSelectionModeEnabled) {
        container.classList.add('txt-viewer-visible');
        updateSelectedIdsDisplay();
    } else {
        container.classList.remove('txt-viewer-visible');
    }
}

function updateSelectedIdsDisplay() {
    const list = document.getElementById('selectedIdsList');
    list.innerHTML = selectedIds.map(id => `
        <div class="txt-viewer-selected-id-chip" onclick="scrollToText(${id})">
            <span>ID: ${id}</span>
        </div>
    `).join('');
}

function removeSelectedId(id) {
    selectedIds = selectedIds.filter(selectedId => selectedId !== id);
    const checkbox = document.querySelector(`input[data-text-id="${id}"]`);
    if (checkbox) checkbox.checked = false;
    updateSelectionModeVisibility();
}

function toggleTextSelection(id, checked) {
    if (checked) {
        if (!selectedIds.includes(id)) {
            selectedIds.push(id);
        }
    } else {
        selectedIds = selectedIds.filter(selectedId => selectedId !== id);
    }
    updateSelectionModeVisibility();
}

function scrollToText(id) {
    const text = allTexts.find(t => t.id === id);
    if (!text) return;

    const classValue = text['class-choice'][0];
    
    if (classValue === '1_2_klase') {
        document.getElementById('class_1_2').checked = true;
    } else if (classValue === '3_4_klase') {
        document.getElementById('class_3_4').checked = true;
    }

    document.getElementById('task_struktura').checked = true;
    document.getElementById('task_komponavimas').checked = true;
    document.getElementById('diff_lengvas').checked = true;
    document.getElementById('diff_vidutinis').checked = true;
    document.getElementById('diff_sunkus').checked = true;
    document.getElementById('searchInput').value = '';

    applyFilters();

    setTimeout(() => {
        const element = document.getElementById(`text-item-${id}`);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            if (!expandedTextIds.has(id)) {
                toggleTextExpand(id);
            }

            element.style.boxShadow = '0 0 0 3px #1976d2';
            setTimeout(() => {
                element.style.boxShadow = '';
            }, 2000);
        }
    }, 100);
}

function openTextBrowser(textId) {
    console.log(isMainBrowserExpanded)
    if (!isMainBrowserExpanded) {
        toggleMainBrowser();
    }

    setTimeout(() => {
        document.getElementById('searchInput').value = textId.toString();
        applyFilters();

        setTimeout(() => {
            const element = document.getElementById(`text-item-${textId}`);
            if (element) {
                if (!element.classList.contains("text-item-expanded")) {
                    setTimeout(() => {
                        if (!expandedTextIds.has(textId)) {
                            const rerenderedElement = document.querySelector(`#text-item-${textId} .txt-viewer-text-item-main:not(.text-item-expanded)`);
                            if (rerenderedElement) {
                                rerenderedElement.click();
                            }
                        }
                    }, 100);
                } else {
                    setTimeout(() => {
                        const element = document.getElementById(`text-item-${textId}`);
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            if (!expandedTextIds.has(textId)) {
                                toggleTextExpand(textId);
                            }

                            element.style.boxShadow = '0 0 0 3px #286D8A';
                            setTimeout(() => {
                                element.style.boxShadow = '';
                            }, 2000);
                        }
                    }, 100);
                }
            } else {
                messageToTheUser("Tekstas nerastas!")
            }
        }, 100);
    }, 300);
}

function toggleTextExpand(id) {
    if (expandedTextIds.has(id)) {
        expandedTextIds.delete(id);
    } else {
        toggleAllFilters(true);
        expandedTextIds.add(id);

        setTimeout(() => {
            const element = document.getElementById(`text-item-${id}`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                if (!expandedTextIds.has(id)) {
                    toggleTextExpand(id);
                }

                element.style.boxShadow = '0 0 0 3px #286D8A';
                setTimeout(() => {
                    element.style.boxShadow = '';
                }, 2000);
            }
        }, 100);
    }

    applyFilters();
}

	</script>
</body>

</html>
