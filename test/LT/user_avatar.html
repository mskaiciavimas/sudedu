<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Avatar â€” feature selector with palettes</title>
  <style>
    :root{--bg1:#667eea;--bg2:#764ba2}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--bg1),var(--bg2));padding:20px}
    .card{background:#fff;border-radius:14px;padding:22px;max-width:920px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.18);display:grid;grid-template-columns:360px 1fr;gap:20px}
    h1{font-size:1.1rem;margin:0 0 8px}
    .left{display:flex;flex-direction:column;align-items:center;gap:12px}
    .avatarWrap{width:300px;height:300px;border-radius:50%;overflow:hidden;border:4px solid var(--bg1);display:flex;align-items:center;justify-content:center;background:#f7f9fb}
    .avatarWrap svg{width:100%;height:100%}
    .controls{display:flex;align-items:center;gap:8px}
    .arrow{width:44px;height:44px;border-radius:50%;border:0;background:var(--bg1);color:#fff;font-size:18px;cursor:pointer}
    .arrow:hover{background:#5568d3}
    select{padding:8px 10px;border-radius:8px;border:1px solid #ddd}
    .palette{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:12px}
    .swatch{width:26px;height:26px;border-radius:50%;border:2px solid #e6e6e6;cursor:pointer}
    .swatch.selected{outline:3px solid rgba(0,0,0,.12);transform:scale(1.06)}
    .right{padding:6px 4px}
    label{font-size:.78rem;color:#444;display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:.6px}
    .controlRow{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
    pre{background:#fafafa;padding:10px;border-radius:8px;overflow:auto}
    @media (max-width:880px){.card{grid-template-columns:1fr}.avatarWrap{width:220px;height:220px}}
  </style>
</head>
<body>
  <div class="card">
    <div class="left">
      <h1>ðŸŽ¨ Avatar â€” feature selector</h1>

      <div class="controls">
        <button id="prev" class="arrow" aria-label="previous">âŸ¨</button>
        <select id="featureSelect" aria-label="feature"></select>
        <button id="next" class="arrow" aria-label="next">âŸ©</button>
      </div>

      <div class="avatarWrap" id="avatarPreview" aria-live="polite"></div>

      <div class="palette" id="colorPalette" aria-hidden="false"></div>
    </div>

    <div class="right">
      <div style="margin-bottom:10px">
        <label>current settings</label>
        <pre id="settingsOutput"></pre>
      </div>

      <div style="margin-bottom:10px">
        <label>compact storage (copy this!)</label>
        <pre id="encodedOutput" style="cursor:pointer;user-select:all" title="Click to copy"></pre>
        <div style="font-size:0.75rem;color:#666;margin-top:4px">
          Base36 encoded â€¢ <span id="byteCount"></span> bytes â€¢ 
          <a href="#" onclick="showComparison(); return false;" style="color:#667eea">see comparison</a>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:10px">
        <button onclick="copyEncoded()" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;background:#f8f8f8;cursor:pointer">ðŸ“‹ Copy Code</button>
        <button onclick="loadEncoded()" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;background:#f8f8f8;cursor:pointer">ðŸ“¥ Load Code</button>
      </div>

      <div style="font-size:.9rem;color:#444">Notes:
        <ul>
          <li>seed is fixed (deterministic)</li>
          <li>facial hair removed as requested</li>
        </ul>
      </div>
    </div>
  </div>

  <script type="module">
    import { createAvatar } from 'https://esm.sh/@dicebear/core@9.2.2';
    import { avataaars } from 'https://esm.sh/@dicebear/collection@9.2.2';

    const OPTIONS = {
      top: ["bigHair","bob","bun","curly","curvy","dreads","dreads01","dreads02","frida","frizzle","fro","froBand","hat","hijab","longButNotTooLong","miaWallace","shaggy","shaggyMullet","shavedSides","shortCurly","shortFlat","shortRound","shortWaved","sides","straight01","straight02","straightAndStrand","theCaesar","theCaesarAndSidePart","turban","winterHat1","winterHat02","winterHat03","winterHat04"],
      clothing: ["blazerAndShirt","blazerAndSweater","collarAndSweater","graphicShirt","hoodie","overall","shirtCrewNeck","shirtScoopNeck","shirtVNeck"],
      eyes: ["closed","default","eyeRoll","happy","hearts","side","squint","surprised","wink","winkWacky"],
      eyebrows: ["default","defaultNatural","flatNatural","frownNatural","raisedExcited","raisedExcitedNatural","unibrowNatural","upDown","upDownNatural"],
      mouth: ["concerned","default","disbelief","eating","grimace","serious","smile","tongue","twinkle"]
    };

    const PALETTES = {
      hairColor: ["2c1b18","4a312c","724133","a55728","b58143","c93305","d6b370","e8e1e1","ecdcbf","f59797"],
      hatColor: ["262e33","2f4f4f","3c4f5c","5199e4","65c9ff","929598","a7ffc4","b1e2ff","d6b370","e6e6e6","ff5c5c","ff488e","ffafb9","ffffb1"],
      clothesColor: ["3c4f5c","65c9ff","262e33","5199e4","25557c","929598","a7ffc4","b1e2ff","e6e6e6","ff5c5c","ff488e","ffafb9","ffffb1","ffffff"],
      skinColor: ["614335","ae5d29","d08b5b","edb98a","f8d25c","fd9841","ffdbb4"]
    };

    const hatStyles = ['hat','turban','winterHat1','winterHat02','winterHat03','winterHat04','hijab'];

    const featureConfig = {
      top: { options: OPTIONS.top, colorKey: 'hairColor' },
      clothing: { options: OPTIONS.clothing, colorKey: 'clothesColor' },
      eyes: { options: OPTIONS.eyes, colorKey: null },
      eyebrows: { options: OPTIONS.eyebrows, colorKey: null },
      mouth: { options: OPTIONS.mouth, colorKey: null },
      skin: { options: null, colorKey: 'skinColor' }
    };

    const indices = {};
    Object.keys(featureConfig).forEach(k => { indices[k] = 0; });
    Object.keys(PALETTES).forEach(k => { indices[k] = 0; });

    const avatarSettings = {
      top: ["winterHat03"],
      clothing: [OPTIONS.clothing[6]],
      eyes: [OPTIONS.eyes[3]],
      eyebrows: [OPTIONS.eyebrows[0]],
      mouth: [OPTIONS.mouth[6]],
      hairColor: [PALETTES.hairColor[0]],
      hatColor: [PALETTES.hatColor[0]],
      clothesColor: [PALETTES.clothesColor[0]],
      skinColor: [PALETTES.skinColor[3]],
      backgroundColor: ['b6e3f4','c0aede','d1d4f9']
    };

    const featureSelect = document.getElementById('featureSelect');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const avatarPreview = document.getElementById('avatarPreview');
    const colorPalette = document.getElementById('colorPalette');
    const settingsOutput = document.getElementById('settingsOutput');
    const encodedOutput = document.getElementById('encodedOutput');
    const byteCount = document.getElementById('byteCount');

    function prettyLabel(camel) {
      return camel.replace(/([A-Z])/g, ' $1').trim().toLowerCase();
    }

    Object.keys(featureConfig).forEach(key => {
      const opt = document.createElement('option');
      opt.value = key;
      opt.textContent = prettyLabel(key);
      featureSelect.appendChild(opt);
    });

    let currentFeature = featureSelect.value;

    function renderPalette() {
      colorPalette.innerHTML = '';
      const cfg = featureConfig[currentFeature];
      if (!cfg) return;
      
      // Check if current top is a hat and switch to hatColor palette
      const isHat = currentFeature === 'top' && hatStyles.includes(avatarSettings.top[0]);
      const colorKey = isHat ? 'hatColor' : cfg.colorKey;
      
      if (!colorKey || !PALETTES[colorKey]) return;

      PALETTES[colorKey].forEach((hex, i) => {
        const sw = document.createElement('div');
        sw.className = 'swatch' + ((avatarSettings[colorKey] && avatarSettings[colorKey][0] === hex) ? ' selected' : '');
        sw.style.background = `#${hex}`;
        sw.title = `#${hex}`;
        sw.addEventListener('click', () => {
          avatarSettings[colorKey] = [hex];
          indices[colorKey] = i;
          renderPalette();
          renderAvatar();
        });
        colorPalette.appendChild(sw);
      });
    }

    function renderAvatar() {
      const options = {
        seed: 'avatar-creator',
        top: avatarSettings.top,
        clothing: avatarSettings.clothing,
        eyes: avatarSettings.eyes,
        eyebrows: avatarSettings.eyebrows,
        mouth: avatarSettings.mouth,
        hairColor: avatarSettings.hairColor,
        hatColor: avatarSettings.hatColor,
        clothesColor: avatarSettings.clothesColor,
        skinColor: avatarSettings.skinColor,
        backgroundColor: avatarSettings.backgroundColor
      };

      try {
        const svg = createAvatar(avataaars, options);
        avatarPreview.innerHTML = svg.toString();
      } catch (err) {
        avatarPreview.innerHTML = `<div style="padding:16px;color:#900">failed to render avatar â€” check console</div>`;
        console.error(err);
      }

      const shown = {
        top: options.top[0],
        clothing: options.clothing[0],
        eyes: options.eyes[0],
        eyebrows: options.eyebrows[0],
        mouth: options.mouth[0],
        hairColor: options.hairColor[0],
        hatColor: options.hatColor[0],
        clothesColor: options.clothesColor[0],
        skinColor: options.skinColor[0]
      };
      settingsOutput.textContent = JSON.stringify(shown, null, 2);
      
      // Update encoded output
      const encoded = encodeSettings();
      encodedOutput.textContent = encoded;
      encodedOutput.onclick = copyEncoded;
      byteCount.textContent = encoded.length;
    }

    // Show compression comparison
    function showComparison() {
      const encoded = encodeSettings();
      const jsonStr = JSON.stringify({
        top: avatarSettings.top[0],
        clothing: avatarSettings.clothing[0],
        eyes: avatarSettings.eyes[0],
        eyebrows: avatarSettings.eyebrows[0],
        mouth: avatarSettings.mouth[0],
        hairColor: avatarSettings.hairColor[0],
        hatColor: avatarSettings.hatColor[0],
        clothesColor: avatarSettings.clothesColor[0],
        skinColor: avatarSettings.skinColor[0]
      });
      
      const savings = Math.round((1 - encoded.length / jsonStr.length) * 100);
      
      alert(
        `ðŸ“Š COMPRESSION COMPARISON\n\n` +
        `JSON format: ${jsonStr.length} bytes\n` +
        `${jsonStr}\n\n` +
        `Base36 format: ${encoded.length} bytes\n` +
        `${encoded}\n\n` +
        `ðŸ’¾ Space saved: ${savings}% smaller!`
      );
    }
    
    window.showComparison = showComparison;

    function cycleFeature(dir) {
      const cfg = featureConfig[currentFeature];
      if (!cfg) return;

      if (cfg.options && cfg.options.length) {
        indices[currentFeature] = (indices[currentFeature] + dir + cfg.options.length) % cfg.options.length;
        avatarSettings[currentFeature] = [cfg.options[indices[currentFeature]]];
        renderAvatar();
        renderPalette();
      } else if (cfg.colorKey && PALETTES[cfg.colorKey]) {
        const key = cfg.colorKey;
        indices[key] = (indices[key] + dir + PALETTES[key].length) % PALETTES[key].length;
        avatarSettings[key] = [PALETTES[key][indices[key]]];
        renderPalette();
        renderAvatar();
      }
    }

    featureSelect.addEventListener('change', () => {
      currentFeature = featureSelect.value;
      renderPalette();
    });

    prevBtn.addEventListener('click', () => cycleFeature(-1));
    nextBtn.addEventListener('click', () => cycleFeature(1));

    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') cycleFeature(-1);
      if (e.key === 'ArrowRight') cycleFeature(1);
    });

    
    function syncIndicesFromSettings(){
    const order = ['top','clothing','eyes','eyebrows','mouth','hairColor','hatColor','clothesColor','skinColor'];
    order.forEach(key => {
        const val = avatarSettings[key] && avatarSettings[key][0];
        if (val == null) { indices[key] = 0; return; }

        if (PALETTES[key]) {
        const idx = PALETTES[key].indexOf(val);
        indices[key] = idx >= 0 ? idx : 0;
        } else if (OPTIONS[key]) {
        const idx = OPTIONS[key].indexOf(val);
        indices[key] = idx >= 0 ? idx : 0;
        } else {
        // fallback to keep things safe
        indices[key] = typeof indices[key] === 'number' ? indices[key] : 0;
        }
    });
    }
        
    function encodeSettings(){
    const order = ['top','clothing','eyes','eyebrows','mouth','hairColor','hatColor','clothesColor','skinColor'];
    const values = order.map(key => {
        const val = avatarSettings[key] && avatarSettings[key][0];

        if (PALETTES[key]) {
        const idx = PALETTES[key].indexOf(val);
        return idx >= 0 ? idx : 0;
        } else if (OPTIONS[key]) {
        const idx = OPTIONS[key].indexOf(val);
        return idx >= 0 ? idx : 0;
        } else {
        // final fallback to the indices array
        return typeof indices[key] === 'number' ? indices[key] : 0;
        }
    });

    return values.map(v => v.toString(36)).join('');
    }

    // Decode compact string to settings
    function decodeSettings(encoded) {
      const order = ['top', 'clothing', 'eyes', 'eyebrows', 'mouth', 'hairColor', 'hatColor', 'clothesColor', 'skinColor'];
      
      // Support both formats: comma-separated "0,2,5,1,3" or base36 "025r3"
      let values;
      if (encoded.includes(',')) {
        // Old format: comma-separated
        values = encoded.split(',').map(v => parseInt(v, 10));
      } else {
        // New format: base36 compressed
        values = encoded.split('').map(v => parseInt(v, 36));
      }
      
      values.forEach((val, i) => {
        const key = order[i];
        if (isNaN(val)) return; // Skip invalid values
        
        indices[key] = val;
        
        if (key === 'hairColor' || key === 'hatColor' || key === 'clothesColor' || key === 'skinColor') {
          if (PALETTES[key] && PALETTES[key][val]) {
            avatarSettings[key] = [PALETTES[key][val]];
          }
        } else {
          if (OPTIONS[key] && OPTIONS[key][val]) {
            avatarSettings[key] = [OPTIONS[key][val]];
          }
        }
      });
      
      renderPalette();
      renderAvatar();
    }

    // Copy encoded settings to clipboard
    function copyEncoded() {
      const encoded = encodeSettings();
      navigator.clipboard.writeText(encoded).then(() => {
        alert(`Copied: ${encoded}\n\nOnly ${encoded.length} characters!`);
      });
    }

    // Load from encoded string
    function loadEncoded() {
      const encoded = prompt('Paste encoded avatar settings:');
      if (encoded) {
        try {
          decodeSettings(encoded);
        } catch (err) {
          alert('Invalid encoded string!');
        }
      }
    }

    window.copyEncoded = copyEncoded;
    window.loadEncoded = loadEncoded;
    
    renderPalette();
    renderAvatar();
    syncIndicesFromSettings();
  </script>
</body>
</html>