<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="../refresh-token.js"></script>
    <link rel="stylesheet" href="../main-nav-bar.css">
    <link rel="stylesheet" type="text/css" href="../index.css">
    <link rel="stylesheet" href="../pet-game-pets.css">
    <link rel="stylesheet" href="../pet-game-items.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        font-family: 'SFpro', sans-serif;
        background-image: linear-gradient(to top, #ffbf9c, #ffbf92, #ffbf89, #ffbf7e, #ffc074);
        min-height: 100vh;
        color: #212529;
        height: 100svh;
        width: 100vw;
    }

    .container {
        flex: 1;
        height: calc(100% - 80px - (2*16px));
        width: calc(100% - (2*16px));
        display: flex;
        background: rgba(255, 255, 255, 0.08);
        margin: 16px;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.1);
        flex-direction: column;
        padding: 25px;
        overflow: auto;
        min-height: 0;
    }

    .header {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }

    .header h1 {
        color: rgba(0, 0, 0, 0.85);
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
    }

    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .tab-btn {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 15px 30px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        color: rgba(0, 0, 0, 0.8);
        transition: all 0.3s ease;
        font-family: 'SFpro', sans-serif;
    }

    .tab-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .tab-btn.active {
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.5);
        color: rgba(0, 0, 0, 0.9);
    }

    .tab-content {
        display: none;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 25px;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 20px;
        border-radius: 15px;
    }

    .stat-card h3 {
        color: rgba(0, 0, 0, 0.85);
        margin-bottom: 15px;
        font-size: 1.2rem;
        font-weight: 700;
    }

    .stat-items {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 8px;
    }

    .stat-label {
        color: rgba(0, 0, 0, 0.7);
        font-weight: 600;
    }

    .stat-value {
        color: rgba(0, 0, 0, 0.9);
        font-weight: 700;
    }

    .save-changes-button {
        margin-top: 15px;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: rgba(0, 0, 0, 0.8);
    }

    input, select, textarea {
        width: 100%;
        padding: 12px 15px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        font-size: 15px;
        transition: all 0.3s ease;
        font-family: 'SFpro', sans-serif;
        color: rgba(0, 0, 0, 0.9);
    }

    input:focus, select:focus, textarea:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }

    input::placeholder {
        color: rgba(0, 0, 0, 0.5);
    }

    .btn {
        position: relative;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: rgba(0, 0, 0, 0.85);
        padding: 12px 30px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        font-family: 'SFpro', sans-serif;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
        border-radius: 20px;
        pointer-events: none;
        transition: background 0.3s ease;
    }

    .btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .btn:hover::before {
        background: rgba(255, 255, 255, 0.15);
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .btn-danger {
        background: rgba(245, 87, 108, 0.2);
        border: 1px solid rgba(245, 87, 108, 0.3);
        color: #721c24;
    }

    .btn-danger:hover {
        background: rgba(245, 87, 108, 0.3);
    }

    .btn-secondary {
        background: rgba(168, 237, 234, 0.2);
        border: 1px solid rgba(168, 237, 234, 0.3);
        color: rgba(0, 0, 0, 0.85);
    }

    .btn-secondary:hover {
        background: rgba(168, 237, 234, 0.3);
    }

    .message {
        padding: 15px;
        border-radius: 15px;
        margin-bottom: 20px;
        font-weight: 500;
        backdrop-filter: blur(10px);
    }

    .message.success {
        background: rgba(34, 197, 94, 0.2);
        color: #155724;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .message.error {
        background: rgba(220, 38, 38, 0.2);
        color: #721c24;
        border: 1px solid rgba(220, 38, 38, 0.3);
    }

    .message.info {
        background: rgba(59, 130, 246, 0.2);
        color: #0c5460;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .user-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
    }

    .send-gifts-title {
        margin-bottom: 15px;
    }

    .user-card h3 {
        color: rgba(0, 0, 0, 0.85);
        margin-bottom: 15px;
        font-weight: 700;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }

    .info-grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(40%, 1fr));
        gap: 15px;
    }

    .info-item {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(5px);
        padding: 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .info-item strong {
        display: block;
        color: rgba(0, 0, 0, 0.7);
        margin-bottom: 5px;
        font-size: 12px;
        text-transform: uppercase;
        font-weight: 600;
    }

    .search-bar {
        display: flex;
        gap: 15px;
        margin: 15px 0;
        flex-wrap: wrap;
    }

    .search-bar input {
        flex: 1;
        min-width: 200px;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: rgba(0, 0, 0, 0.7);
        font-size: 18px;
    }

    #inactive-days {
        margin-top: 10px;
    }

    .json-display {
        background: rgba(0, 0, 0, 0.6);
        color: #48bb78;
        padding: 15px;
        border-radius: 10px;
        overflow-x: auto;
        font-family: 'SFMono', 'Courier New', monospace;
        font-size: 13px;
        max-height: 400px;
        overflow-y: auto;
        backdrop-filter: blur(10px);
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: wrap;
    }

    .asset-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.05);
    }

    .asset-item, .student-item, .task-item, .message-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        margin-bottom: 5px;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .asset-item:hover, .student-item:hover, .task-item:hover, .message-item:hover {
        background: rgba(255, 255, 255, 0.15);
    }

    .performace-statistics {
        margin-top: 15px;
    }

    .inline-form {
        display: flex;
        gap: 10px;
        align-items: flex-end;
        margin-bottom: 15px;
    }

    .inline-form .form-group {
        margin-bottom: 0;
        flex: 1;
    }

    .small-btn {
        padding: 6px 12px;
        font-size: 14px;
    }

    .bulk-operations {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .operation-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 20px;
        border-radius: 15px;
    }

    .operation-card h3 {
        color: rgba(0, 0, 0, 0.85);
        margin-bottom: 15px;
        font-size: 1.2rem;
        font-weight: 700;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: rgba(0, 0, 0, 0.8);
        cursor: pointer;
        user-select: none;
    }

    .checkbox-label input[type="checkbox"] {
        width: auto;
        cursor: pointer;
    }

    .recipient-tag {
        display: inline-block;
        background: rgba(102, 126, 234, 0.3);
        border: 1px solid rgba(102, 126, 234, 0.5);
        padding: 5px 10px;
        border-radius: 12px;
        margin: 4px;
        font-size: 13px;
    }

    .recipient-tag button {
        background: none;
        border: none;
        color: #721c24;
        cursor: pointer;
        margin-left: 5px;
        font-weight: bold;
    }

    /* Stats Chart Styles */
    .stats-chart-container {
        margin-top: 20px;
    }

    .chart-wrapper {
        position: relative;
        height: 400px;
        margin-top: 15px;
    }

    .stats-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }

    .btn-subject, .btn-metric {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 8px 16px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: rgba(0, 0, 0, 0.8);
        transition: all 0.3s ease;
        font-family: 'SFpro', sans-serif;
    }

    .btn-subject:hover, .btn-metric:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .btn-subject.active, .btn-metric.active {
        background: rgba(102, 126, 234, 0.3);
        border: 1px solid rgba(102, 126, 234, 0.5);
        color: rgba(0, 0, 0, 0.9);
    }

    .btn-metric:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none;
    }

    /* Item Preview Styles */
    .item-preview-holder {
        display: inline-block;
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }

    .item-preview:not(.pet) {
        width: 100% !important;
        height: 100% !important;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
    }

    .item-preview.pet {
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
    }

    .item-detail-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 20px;
        border-radius: 15px;
    }

    .item-search-results-list {
    margin-top: 20px;
    max-height: 400px;
    overflow-y: auto;
}

.item-result-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.item-result-header {
    display: flex;
    gap: 15px;
    align-items: center;
}

.item-result-details {
    display: none;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    animation: expandIn 0.3s ease;
}

@keyframes expandIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.item-result-card.expanded {
    background: rgba(255, 255, 255, 0.2);
}

.item-result-card.expanded .item-result-details {
    display: block;
}

.item-result-card:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.item-result-card.selected {
    background: rgba(102, 126, 234, 0.3);
    border: 2px solid rgba(102, 126, 234, 0.6);
}

.item-result-preview {
    flex-shrink: 0;
}

.item-result-info {
    flex: 1;
    min-width: 0;
}

.item-result-title {
    font-weight: 700;
    font-size: 16px;
    color: rgba(0, 0, 0, 0.9);
    margin-bottom: 5px;
}

.item-result-meta {
    font-size: 13px;
    color: rgba(0, 0, 0, 0.7);
}

.item-result-id {
    display: inline-block;
    background: rgba(102, 126, 234, 0.2);
    padding: 2px 8px;
    border-radius: 6px;
    font-weight: 600;
    margin-right: 8px;
}

.search-list-and-item-details-holder {
    max-height: 70vh;
    overflow-y: auto;
}

    .item-header {
        display: flex;
        gap: 20px;
        align-items: flex-start;
        margin-bottom: 20px;
    }

    .item-preview-large {
        width: 100px;
        height: 100px;
    }

    .item-info-section {
        flex: 1;
    }

    .item-properties {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }

    .item-property {
        background: rgba(255, 255, 255, 0.15);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 14px;
    }

    .item-property strong {
        color: rgba(0, 0, 0, 0.7);
        font-weight: 600;
    }

    .item-category-tags {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
    }

    .item-category-tag {
        background: rgba(102, 126, 234, 0.3);
        border: 1px solid rgba(102, 126, 234, 0.5);
        padding: 4px 10px;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
    }

    /* Chrome, Edge, Safari */
    ::-webkit-scrollbar {
        width: 12px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(6px);
        border-radius: 20px;
    }

    ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(6px);
        border-radius: 10px;
        border: 3px solid rgba(255, 255, 255, 0.2);
        background-clip: content-box;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
    }

    #teacher-name {
        display: flex;
        justify-content: space-between;
    }

    @media (max-width: 767px) {
        .main-navbar {
            box-shadow: none;
        }

        .user-card {
            padding: 15px;
        }

        .container {
            height: calc(100% - 81px);
            width: 100%;
            background: transparent;
            margin: 0;
            border-radius: 0;
            border: none;
            box-shadow: none;
            padding: 15px;
        }

        .tab-content {
            padding: 15px;
        }

        .tab-btn,
        .btn {
            font-size: 14px;
            padding: 12px 20px;
        }

        .small-btn {
            max-width: 65px;
            min-width: 65px;
            padding: 4px 6px;
            font-size: 12px;
        }

        .small-btn-with-text {
            padding: 6px 12px;
            font-size: 12px;
        }

        .add-skin-btn {
            margin-top: 15px;
        }

        .equipped-selection-checkbox {
            width: auto;
        }

        .info-grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .bulk-operations {
            grid-template-columns: 1fr;
        }

        #lookup-tab {
            padding: 0;
            background: transparent;
            border: none;
        }

        .inline-form {
            display: block;
        }

        .inline-form .form-group {
            margin-bottom: 10px;
        }
    }
</style>
</head>
<body>
    <div id="customConfirmModal" class="modal">
    <div class="modal-content">
        <p id="customModalText"></p>
        <div class="modal-buttons">
        <button id="customConfirmYes" class="btn-confirm">Taip</button>
        <button id="customConfirmNo" class="btn-cancel">Ne</button>
        </div>
    </div>
    </div>

    <div id="object-popup" class="object-popup-overlay" style="display:none;">
    <div class="object-popup-panel">
        <button class="object-popup-close">&times;</button>
        <div class="title-subtitle-inline-button-wrapper">
        <div class="object-popup-title-subtitle-wrapper">
        <div class="object-popup-title" id="object-popup-title"></div>
        <div class="object-popup-subtitle" id="object-popup-subtitle"></div>
        </div>
        </div>
        <div class="object-popup-content" id="object-popup-content">
        <!-- Dynamic content goes here -->
        </div>
    </div>
    </div>

    <nav class="main-navbar" id="mainNavbar">
        <div class="main-nav-container">
            <!-- Logo -->
            <a href="#" class="main-nav-logo">
                <div class="main-nav-logo-icon">
                 <img id="sudedu-main-nav-bar-logo" src="../images/sudedu_logo.png" alt="sudEdu">
                </div>
            </a>

            <!-- Desktop Navigation -->
            <div class="main-nav-links invisible">
                <a href="admin.html" class="main-nav-link main-nav-link-active">Admin Panel</a>

                <div class="main-nav-connect-wrapper">
                    <div class="main-nav-connect-glow"></div>
                    <button class="main-nav-log-out-btn">
                        <span class="main-nav-connect-text">Atsijungti</span>
                    </button>

                    <button class="main-nav-log-in-btn">
                        <span class="main-nav-connect-text">Prisijungti</span>
                    </button>
                </div>
            </div>

            <!-- Mobile Button -->
            <button class="main-nav-mobile-btn" id="mainNavMobileBtn">
                <span class="main-nav-hamburger"></span>
                <span class="main-nav-hamburger"></span>
                <span class="main-nav-hamburger"></span>
            </button>

            <!-- Mobile Menu -->
            <div class="main-nav-mobile-menu" id="mainNavMobileMenu">
                <a href="admin.html" class="main-nav-mobile-link active">Admin Panel</a>
                
                <button class="main-nav-mobile-log-out-btn">
                    <span class="main-nav-connect-text">Atsijungti</span>
                </button>
                <button class="main-nav-mobile-log-in-btn">
                    <span class="main-nav-connect-text">Prisijungti</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('lookup', event)">üë§ User Lookup</button>
            <button class="tab-btn" onclick="showTab('bulk', event)">‚ö° Bulk Operations</button>
            <button class="tab-btn" onclick="showTab('messages', event)">üíå Send Gifts</button>
            <button class="tab-btn" onclick="showTab('itemlookup', event)">üîç Item Lookup</button>
            <button class="tab-btn" onclick="showTab('statistics', event)">üìä Statistics</button>
            <button class="tab-btn" onclick="showTab('taskstorage', event)">üíæ Task Storage</button>
        </div>

        <!-- User Lookup Tab -->
        <div id="lookup-tab" class="tab-content active">
            <h2>Search Users</h2>
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search by ID or email adress" autocomplete="off">
                <button class="btn" onclick="searchUsers()">Search</button>
            </div>
            <div id="lookup-results"></div>
        </div>

        <!-- Bulk Operations Tab -->
        <div id="bulk-tab" class="tab-content">
            <div class="bulk-operations">
                <!-- Manage Items for All -->
                <div class="operation-card">
                    <h3>üì¶ Manage Items for All</h3>
                    <div class="form-group">
                        <label>Action</label>
                        <select id="item-action">
                            <option value="add">Add Item</option>
                            <option value="remove">Remove Item</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulk-item-id">Item Game Index ID</label>
                        <input type="number" id="bulk-item-id" placeholder="e.g., 42">
                    </div>
                    <div class="form-group" id="item-coords-group">
                        <label for="bulk-item-coords">Coordinates (X,Y)</label>
                        <input type="text" id="bulk-item-coords" placeholder="e.g., 10,5 (optional)">
                    </div>
                    <div class="form-group" id="item-compensation-group" style="display: none;">
                        <label for="bulk-item-compensation">Compensation (per item)</label>
                        <input type="number" id="bulk-item-compensation" placeholder="e.g., 100 (optional)" min="0">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Money to add per removed item
                        </small>
                    </div>
                    <div id="bulk-item-message"></div>
                    <button class="btn" id="bulk-item-btn" onclick="manageItemsForAll()">Add Item</button>
                </div>

                <!-- Manage Consumables for All -->
                <div class="operation-card">
                    <h3>üéí Manage Consumables for All</h3>
                    <div class="form-group">
                        <label>Action</label>
                        <select id="consumable-action">
                            <option value="add">Add Consumable</option>
                            <option value="remove">Remove Consumable</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulk-consumable-item-id">Item Game Index ID</label>
                        <input type="number" id="bulk-consumable-item-id" placeholder="e.g., 13">
                    </div>
                    <div class="form-group" id="consumable-qty-group">
                        <label for="bulk-consumable-item-qty">Quantity</label>
                        <input type="number" id="bulk-consumable-item-qty" placeholder="e.g., 5" value="1" min="1">
                    </div>
                    <div class="form-group" id="consumable-compensation-group" style="display: none;">
                        <label for="bulk-consumable-item-compensation">Compensation (per item)</label>
                        <input type="number" id="bulk-consumable-item-compensation" placeholder="e.g., 50 (optional)" min="0">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Money to add per removed item
                        </small>
                    </div>
                    <div id="bulk-consumable-item-message"></div>
                    <button class="btn" id="bulk-consumable-btn" onclick="manageConsumablesForAll()">Add Consumable</button>
                </div>

                <div class="operation-card">
                    <h3>üêæ Manage Pets for All Students</h3>
                    <div class="form-group">
                        <label>Action</label>
                        <select id="pet-action">
                            <option value="add">Add Pet</option>
                            <option value="remove">Remove Pet</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulk-pet-id">Pet ID (NOT GAME INDEX ID)</label>
                        <input type="text" id="bulk-pet-id" placeholder="e.g., cat-1">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            First class in the "css-class" list in the Game Index for the pet item.
                        </small>
                    </div>
                    <div class="form-group" id="pet-name-group">
                        <label for="bulk-pet-name">Pet Name</label>
                           <input type="text" id="bulk-pet-name" placeholder="e.g., Fluffy">
                    </div>
                    <div class="form-group" id="pet-skin-id-group">
                        <label for="bulk-pet-skin-id">Default Skin ID (NOT GAME INDEX ID)</label>
                        <input type="text" id="bulk-pet-skin-id" placeholder="e.g., default-cat">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Second class in the "css-class" list in the Game Index for the pet or skin item. Default is ${pet ID}-1, i.e. cat-1-1.
                        </small>
                    </div>
                    <div class="form-group" id="pet-skin-index-group">
                        <label for="bulk-pet-skin-index">Default Skin Index</label>
                        <input type="number" id="bulk-pet-skin-index" placeholder="e.g., 100">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Game Index ID for pet or skin item.
                        </small>
                    </div>
                    <div class="form-group" id="pet-compensation-group" style="display: none;">
                        <label for="bulk-pet-compensation">Compensation (per pet)</label>
                        <input type="number" id="bulk-pet-compensation" placeholder="e.g., 100 (optional)" min="0">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Money to add per removed pet
                        </small>
                    </div>
                    <div id="bulk-pet-message"></div>
                    <button class="btn" id="bulk-pet-btn" onclick="managePetsForAll()">Add Pet</button>
                </div>

                <!-- Manage Skins for All -->
                <div class="operation-card">
                    <h3>üëï Manage Skins for All</h3>
                    <div class="form-group">
                        <label>Action</label>
                        <select id="skin-action">
                            <option value="add">Add Skin</option>
                            <option value="remove">Remove Skin</option>
                        </select>
                    </div>
                    <div class="form-group" id="target-pet-group">
                        <label for="bulk-target-pet-id">Target Pet ID (NOT GAME INDEX ID)</label>
                        <input type="text" id="bulk-target-pet-id" placeholder="e.g., cat-1">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            First class in pet's "css-class" list in the Game Index.
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="bulk-skin-id">Skin ID (NOT GAME INDEX ID)</label>
                        <input type="text" id="bulk-skin-id" placeholder="e.g., cat-skin-1">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Second class in "css-class" list in the Game Index for pet or skin items. Default is ${pet's first class}-1.
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="bulk-skin-index">Skin Game Index ID</label>
                        <input type="number" id="bulk-skin-index" placeholder="e.g., 100">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Skin's ID in Game Index. Default is pet's ID in Game Index.
                        </small>
                    </div>
                    <div class="form-group" id="skin-equipped-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="bulk-skin-equipped">
                            Equipped
                        </label>
                    </div>
                    <div class="form-group" id="skin-compensation-group" style="display: none;">
                        <label for="bulk-skin-compensation">Compensation (per skin)</label>
                        <input type="number" id="bulk-skin-compensation" placeholder="e.g., 50 (optional)" min="0">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Money to add per removed skin
                        </small>
                    </div>
                    <div id="skin-backup-section" style="display: none;">
                        <h4 style="margin-top: 15px; margin-bottom: 10px; color: #667eea;">Backup Skin (if pet left with no skins)</h4>
                        <div class="form-group">
                            <label for="backup-skin-id">Backup Skin ID</label>
                            <input type="text" id="backup-skin-id" placeholder="e.g., default-cat">
                        </div>
                        <div class="form-group">
                            <label for="backup-skin-index">Backup Skin Index</label>
                            <input type="number" id="backup-skin-index" placeholder="e.g., 100">
                        </div>
                        <small style="color: #666; display: block; margin-bottom: 10px;">
                            If removing a skin leaves a pet with no skins, this backup will be added and equipped
                        </small>
                    </div>
                    <div id="bulk-skin-message"></div>
                    <button class="btn" id="bulk-skin-btn" onclick="manageSkinsForAll()">Add Skin</button>
                </div>

                                <!-- Add/Subtract Money -->
                <div class="operation-card">
                    <h3>üí∞ Modify Money for All</h3>
                    <div class="form-group">
                        <label for="money-amount">Amount</label>
                        <input type="number" id="money-amount" placeholder="e.g., 1000 or -500">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Use positive to add, negative to subtract (won't go below 0)
                        </small>
                    </div>
                    <div id="money-message"></div>
                    <button class="btn" onclick="modifyMoneyAll()">Apply</button>
                </div>

                <div class="operation-card">
                    <h3>‚è∞ Delete Inactive Users</h3>
                    <div class="form-group">
                        <label for="inactive-months">Months of Inactivity</label>
                        <input type="number" id="inactive-months" placeholder="e.g., 6" min="1">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Users who haven't logged in for this many months (or never logged in) will be deleted. Admin accounts will not be deleted.
                        </small>
                    </div>
                    <div id="inactive-message"></div>
                    <button class="btn btn-danger" onclick="deleteInactiveUsers()">Delete Inactive Users</button>
                </div>

                <div class="operation-card">
                    <h3>‚öôÔ∏è Logout All Users</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        This will invalidate all refresh tokens and increment tokenVersion for all users, forcing them to log in again.
                    </p>
                    <div id="system-message"></div>
                    <button class="btn btn-danger" onclick="logoutAllUsers()">Logout All Users</button>
                </div>
            </div>
        </div>

        <!-- Messages Tab -->
        <div id="messages-tab" class="tab-content">
            <h2 class="send-gifts-title">Send Gifts or Messages</h2>
            
            <!-- Create Message Section -->
            <div class="user-card">
                <h3>Create New Entry</h3>
                <div class="form-group">
                    <label for="msg-message">Message Text</label>
                    <textarea id="msg-message" rows="3" placeholder="Enter message for students..."></textarea>
                </div>
                <div class="form-group">
                    <label for="msg-expiration">Expiration Date</label>
                    <input type="date" id="msg-expiration">
                </div>
                <div class="form-group">
                    <label for="msg-giftid">Gift ID (optional)</label>
                    <input type="number" id="msg-giftid" placeholder="e.g., 42">
                </div>
                <div class="form-group">
                    <label for="msg-quantity">Quantity</label>
                    <input type="number" id="msg-quantity" placeholder="e.g., 1" value="1" min="1">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="msg-sendtoall" onchange="toggleRecipients()">
                        Send to all users in Pet Game
                    </label>
                </div>
                <div id="recipient-section" class="form-group">
                    <label for="msg-recipient-input">Recipients (User ID or Username)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="msg-recipient-input" placeholder="Enter user ID, username, or comma-separated list">
                        <button class="btn small-btn" onclick="addRecipient()">Add</button>
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        You can enter multiple recipients separated by commas (e.g., "123, john, 456, mary")
                    </small>
                    <div id="recipient-tags" style="margin-top: 10px;"></div>
                </div>
                <div id="msg-create-message"></div>
                <button class="btn" onclick="createMessageGift()">Create Entry</button>
            </div>

            <!-- List Messages Section -->
            <div class="user-card" style="margin-top: 20px;">
                <h3>Existing Gifts/Messages</h3>
                <button class="btn btn-secondary" onclick="loadMessages()">üîÑ Refresh List</button>
                <div id="messages-list" style="margin-top: 15px;"></div>
            </div>


            <div class="user-card" style="margin-top: 20px;">
                <h3>Clear Expired Gifts/Messages</h3>
                <button class="btn btn-danger" onclick="triggerGlobalMessageCleanup()">Delete</button>
                <div id="messages-list" style="margin-top: 15px;"></div>
            </div>
        </div>

        <!-- Item Lookup Tab -->
        <div id="itemlookup-tab" class="tab-content">
            <h2>Item Lookup</h2>
            <div class="search-bar">
                <input type="text" id="item-search-input" placeholder="Enter item ID, title, category, css-class, or description..." min="0" autocomplete="off">
                <button class="btn" onclick="searchItem()">Search</button>
            </div>
            <div id="message-info"></div>
            <div class="search-list-and-item-details-holder">
                <div id="item-search-results-list"></div>
            </div>
        </div>

        <!-- Statistics Tab -->
        <div id="statistics-tab" class="tab-content">
            <h2>Database Statistics</h2>
            <div id="statistics-content"></div>
        </div>

        <div id="taskstorage-tab" class="tab-content">
            <h2>Task Result Archive Storage</h2>
            <div id="task-storage-content">
                <div class="loading">Loading storage information...</div>
            </div>
        </div>
    </div>

    <script src="../mental-arithmetic.js"></script>
    <script src="../main-nav-bar.js"></script>
    <script src="../parameter_dictionary.js"></script>
    <script>
        // Global variables
        let gameAssetIndex = null;
        let gameAssetIndexPromise = null;
        let isGameAssetIndexLoading = false;

        // Lazy load game asset index only when needed
        function loadGameAssetIndex() {
            // If already loaded, return immediately
            if (gameAssetIndex !== null) {
                return Promise.resolve(gameAssetIndex);
            }
            
            // If currently loading, return existing promise
            if (gameAssetIndexPromise !== null) {
                return gameAssetIndexPromise;
            }
            
            // Start loading
            isGameAssetIndexLoading = true;
            gameAssetIndexPromise = fetch("gameAssetIndex.json")
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch game asset index');
                    }
                    return response.json();
                })
                .then(data => {
                    gameAssetIndex = data;
                    isGameAssetIndexLoading = false;
                    console.log('Game asset index loaded:', Object.keys(data).length, 'items');
                    return data;
                })
                .catch(error => {
                    isGameAssetIndexLoading = false;
                    gameAssetIndexPromise = null; // Reset so it can be retried
                    console.error('Failed to load game asset index:', error);
                    throw error;
                });
            
            return gameAssetIndexPromise;
        }

        // Check if game asset index is available
        function isGameAssetIndexAvailable() {
            return gameAssetIndex !== null;
        }

        // Helper function to create item preview
        function createItemPreview(itemId, size = 'normal') {
            // If game asset index is not loaded yet, return loading placeholder
            if (!isGameAssetIndexAvailable()) {
                return '<span style="color: #999;">Loading...</span>';
            }
            
            const item = gameAssetIndex[itemId];
            if (!item) {
                return '<span style="color: #999;">Unknown item</span>';
            }

            const previewDiv = document.createElement('div');
            previewDiv.className = `item-preview ${item['css-class']}`;
            const previewHolder = document.createElement('div');
            previewHolder.className = `item-preview-holder ${size === 'large' ? 'item-preview-large' : ''}`;
            previewHolder.appendChild(previewDiv);
            
            return previewHolder.outerHTML;
        }

        function getItemName(itemId) {
            if (!isGameAssetIndexAvailable()) {
                return `Item ${itemId}`;
            }
            const item = gameAssetIndex[itemId];
            return item ? item.title : `Item ${itemId}`;
        }

        async function findMatchinItems(query) {
            // Admin check is removed or replaced ‚Äî frontend cannot check server-side admin
            // But we keep the exact variable name and return format
            if (!query) {
                return { status: 400, json: { message: 'Search query required' } };
            }

            try {
                // Load game asset index (replace with actual fetch)
                const response = await fetch('/gameAssetIndex.json');
                if (!response.ok) {
                    return { status: 500, json: { message: 'Game asset index not found' } };
                }

                const gameAssetIndex = await response.json();

                // If query is only numbers, return specific item by ID
                if (/^\d+$/.test(query)) {
                    const itemId = query;
                    const item = gameAssetIndex[itemId];

                    if (!item) {
                        return { status: 404, json: { message: 'Item not found' } };
                    }

                    return {
                        status: 200,
                        json: {
                            results: [{ id: itemId, ...item }],
                            searchType: 'exact'
                        }
                    };
                }

                // Search by category, title, css-class, or description
                const queryLower = query.toLowerCase();
                const results = [];

                for (const [itemId, item] of Object.entries(gameAssetIndex)) {
                    let matches = false;

                    // Check title
                    if (item.title && item.title.toLowerCase().includes(queryLower)) {
                        matches = true;
                    }

                    // Check css-class
                    if (item['css-class'] && item['css-class'].toLowerCase().includes(queryLower)) {
                        matches = true;
                    }

                    // Check description
                    if (item.description && item.description.toLowerCase().includes(queryLower)) {
                        matches = true;
                    }

                    // Check categories
                    if (item.category && Array.isArray(item.category)) {
                        if (item.category.some(cat => cat.toLowerCase().includes(queryLower))) {
                            matches = true;
                        }
                    }

                    if (matches) {
                        results.push({ id: itemId, ...item });
                    }
                }

                if (results.length === 0) {
                    return { status: 404, json: { message: 'No items found' } };
                }

                return {
                    status: 200,
                    json: {
                        results,
                        searchType: 'multiple',
                        count: results.length
                    }
                };

            } catch (err) {
                console.error('Error searching items:', err);
                return { status: 500, json: { message: 'Internal server error' } };
            }
        }







        async function searchItem() {
            const query = document.getElementById('item-search-input').value.trim();
            const messageDiv = document.getElementById('message-info');
            const resultsDiv = document.getElementById('item-search-results-list');

            // Clear previous results
            resultsDiv.innerHTML = '';

            if (!query) {
                messageDiv.innerHTML = '<div class="message error">Please enter a search term</div>';
                return;
            }

            // Show searching status
            messageDiv.innerHTML = '<div class="loading">Loading game data and searching...</div>';

            try {
                // Ensure game asset index is loaded before searching
                await loadGameAssetIndex();
                
                messageDiv.innerHTML = '<div class="loading">Searching...</div>';
                
                const data = await findMatchingItems(query);

                if (data.searchType === 'exact') {
                    messageDiv.innerHTML = ''; // Clear message
                    displaySingleItemExpanded(data.results[0].id, data.results[0]);
                } else {
                    displayItemSearchResults(data.results);
                }

            } catch (error) {
                messageDiv.innerHTML = `<div class="message error">${error.message}</div>`;
            }
        }

        // Display single item immediately (for ID-only searches)
        function displaySingleItemExpanded(itemId, item) {
            const resultsDiv = document.getElementById('item-search-results-list');
            const categories = item.category?.length ? item.category.join(', ') : 'No category';
            
            resultsDiv.innerHTML = `
                <div class="item-result-card expanded" data-item-id="${itemId}">
                    <div class="item-result-header">
                        <div class="item-result-preview">${createItemPreview(itemId)}</div>
                        <div class="item-result-info">
                            <div class="item-result-title">
                                <span class="item-result-id">ID: ${itemId}</span>
                                ${item.title || 'Unnamed Item'}
                            </div>
                            <div class="item-result-meta">
                                ${categories}${item.description ? ' ‚Ä¢ ' + item.description.substring(0, 80) + (item.description.length > 80 ? '...' : '') : ''}
                            </div>
                        </div>
                    </div>
                    <div class="item-result-details">
                        ${generateItemDetailsHTML(itemId, item)}
                    </div>
                </div>
            `;
        }



        async function findMatchingItems(query) {
            // Ensure game asset index is loaded
            if (!isGameAssetIndexAvailable()) {
                throw new Error('Game asset index not loaded');
            }
            
            // EXACT NUMBER SEARCH
            if (/^\d+$/.test(query)) {
                const itemId = query;
                const item = gameAssetIndex[itemId];

                if (!item) {
                    throw new Error('Item not found');
                }

                return {
                    results: [{ id: itemId, ...item }],
                    searchType: 'exact'
                };
            }

            // TEXT SEARCH
            const queryLower = query.toLowerCase();
            const results = [];

            for (const [itemId, item] of Object.entries(gameAssetIndex)) {
                let matches = false;

                if (item.title?.toLowerCase().includes(queryLower)) matches = true;
                if (item['css-class']?.toLowerCase().includes(queryLower)) matches = true;
                if (item.description?.toLowerCase().includes(queryLower)) matches = true;

                if (Array.isArray(item.category)) {
                    if (item.category.some(cat => cat.toLowerCase().includes(queryLower))) {
                        matches = true;
                    }
                }

                if (matches) {
                    results.push({ id: itemId, ...item });
                }
            }

            if (results.length === 0) {
                throw new Error('No items found');
            }

            return {
                results,
                searchType: 'multiple',
                count: results.length
            };
        }



        // ===================== MESSAGE HELPER =====================
        function showItemMessage(message, type) {
            const resultsDiv = document.getElementById('message-info');
            resultsDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
        }



        // ===================== SEARCH RESULTS RENDERER =====================
        function displayItemSearchResults(results) {
            // Show summary/status in message-info
            const messageDiv = document.getElementById('message-info');
            messageDiv.innerHTML = `Found ${results.length} item${results.length !== 1 ? 's' : ''}. Click to expand details.`;

            // Render actual results in results list
            const resultsDiv = document.getElementById('item-search-results-list');
            let html = '';

            results.forEach(item => {
                const categories = item.category?.length ? item.category.join(', ') : 'No category';
                html += `
                    <div class="item-result-card" onclick="toggleItemExpansion('${item.id}')" data-item-id="${item.id}">
                        <div class="item-result-header">
                            <div class="item-result-preview">${createItemPreview(item.id)}</div>
                            <div class="item-result-info">
                                <div class="item-result-title">
                                    <span class="item-result-id">ID: ${item.id}</span>
                                    ${item.title || 'Unnamed Item'}
                                </div>
                                <div class="item-result-meta">
                                    ${categories}${item.description ? ' ‚Ä¢ ' + item.description.substring(0, 80) + (item.description.length > 80 ? '...' : '') : ''}
                                </div>
                            </div>
                        </div>
                        <div class="item-result-details">
                            ${generateItemDetailsHTML(item.id, item)}
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        // Toggle item expansion
        function toggleItemExpansion(itemId) {
            const card = document.querySelector(`[data-item-id="${itemId}"]`);
            if (!card) return;
            
            // Close all other expanded cards
            document.querySelectorAll('.item-result-card.expanded').forEach(otherCard => {
                if (otherCard !== card) {
                    otherCard.classList.remove('expanded');
                }
            });
            
            // Toggle this card
            card.classList.toggle('expanded');
        }

        // Generate item details HTML
        function generateItemDetailsHTML(itemId, item) {
            let html = `
                <div style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 15px;">
                    <div class="item-preview-holder item-preview-large">${createItemPreview(itemId, 'large')}</div>
                    <div style="flex: 1;">
                        <h3 style="margin-bottom: 10px;">${item.title || 'Unnamed Item'}</h3>
                        <p style="color: rgba(0, 0, 0, 0.7);">${item.description || 'No description available'}</p>
                        ${item.category?.length ? `
                            <div class="item-category-tags" style="margin-top: 10px;">
                                ${item.category.map(cat => `<span class="item-category-tag">${cat}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>

                <div class="item-properties">
                    <div class="item-property"><strong>ID:</strong> ${itemId}</div>
                    ${item.cost !== undefined 
                        ? `<div class="item-property"><strong>Cost:</strong> ${item.cost} üí∞</div>` 
                        : ''}
                    <div class="item-property"><strong>Passable:</strong> ${item.passable ? '‚úÖ' : '‚ùå'}</div>
                    <div class="item-property"><strong>Steppable:</strong> ${item.steppable ? '‚úÖ' : '‚ùå'}</div>
                    <div class="item-property"><strong>One of Kind:</strong> ${item.oneOfKind ? '‚úÖ' : '‚ùå'}</div>
                    <div class="item-property"><strong>Stackable:</strong> ${item.stackable ? '‚úÖ' : '‚ùå'}</div>
                    <div class="item-property"><strong>Purchasable:</strong> ${item.purchasable ? '‚úÖ' : '‚ùå'}</div>
                </div>

                ${item.placingIndex != null 
                    ? `<div style="margin-top: 15px"><strong>Placing Index:</strong> ${item.placingIndex}</div>` 
                    : ''}

                ${item.canBePlacedOn?.length 
                    ? `<div style="margin-top: 15px"><strong>Can Be Placed On:</strong> ${item.canBePlacedOn.join(', ')}</div>` 
                    : ''}

                ${item.requires?.length 
                    ? `<div style="margin-top: 15px"><strong>Requires:</strong> ${item.requires.join(', ')}</div>` 
                    : ''}

                ${item.provides?.length 
                    ? `<div style="margin-top: 15px"><strong>Provides:</strong> ${item.provides.join(', ')}</div>` 
                    : ''}

                ${item['interactive-spot']?.length 
                    ? `<div style="margin-top: 15px"><strong>Interactive Spot:</strong> ${item['interactive-spot']}</div>`
                    : ''}

                <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <strong>CSS Class:</strong> 
                    <code>${item['css-class']}</code>
                </div>
            `;
            
            return html;
        }












        // Recipients management for messages
        let recipients = [];

        function toggleRecipients() {
            const sendToAll = document.getElementById('msg-sendtoall').checked;
            document.getElementById('recipient-section').style.display = sendToAll ? 'none' : 'block';
            if (sendToAll) {
                recipients = [];
                document.getElementById('recipient-tags').innerHTML = '';
            }
        }

        function addRecipient() {
            const input = document.getElementById('msg-recipient-input');
            const recipientInput = input.value.trim();
            
            if (!recipientInput) return;
            
            // Split by comma and process each recipient
            const recipientList = recipientInput.split(',').map(r => r.trim()).filter(r => r);
            
            recipientList.forEach(recipient => {
                if (!recipients.includes(recipient)) {
                    recipients.push(recipient);
                }
            });
            
            updateRecipientTags();
            input.value = '';
        }

        function removeRecipient(recipient) {
            recipients = recipients.filter(r => r !== recipient);
            updateRecipientTags();
        }

        function updateRecipientTags() {
            const container = document.getElementById('recipient-tags');
            container.innerHTML = recipients.map(r => 
                `<span class="recipient-tag">${r}<button onclick="removeRecipient('${r}')">√ó</button></span>`
            ).join('');
        }

        // Display message
        function showMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        function showTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Preload game asset index when switching to item lookup tab
            if (tabName === 'itemlookup' && !isGameAssetIndexAvailable() && !isGameAssetIndexLoading) {
                console.log('Preloading game asset index...');
                loadGameAssetIndex().catch(err => {
                    console.error('Failed to preload game asset index:', err);
                });
            }
            
            // Load messages when switching to messages tab
            if (tabName === 'messages') {
                loadMessages();
            } else if (tabName === 'statistics') {
                loadStatistics();
            } else if (tabName === 'taskstorage') {
                loadTaskStorage();
            }
        }

        // Enter key handlers
        document.addEventListener('DOMContentLoaded', function() {
            // User lookup enter key
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const activeTab = document.querySelector('.tab-content.active');
                        if (activeTab && activeTab.id === 'lookup-tab') {
                            searchUsers();
                        }
                    }
                });
            }
            
            // Item lookup enter key
            const itemSearchInput = document.getElementById('item-search-input');
            if (itemSearchInput) {
                itemSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const activeTab = document.querySelector('.tab-content.active');
                        if (activeTab && activeTab.id === 'itemlookup-tab') {
                            searchItem();
                        }
                    }
                });
            }
        });

        // Search users
        async function searchUsers() {
            const search = document.getElementById('search-input').value.trim();
            const accType = "";
            
            if (!search) {
                showMessage('lookup-results', 'Please enter a search term', 'error');
                return;
            }

            const resultsDiv = document.getElementById('lookup-results');
            resultsDiv.innerHTML = '<div class="loading">Searching...</div>';

            try {
                const params = new URLSearchParams();
                params.append('search', search);
                if (accType) params.append('accType', accType);

                const response = await apiFetch(`${apiBase}admin/user?${params}`);
                
                if (!response) {
                    resultsDiv.innerHTML = '<div class="message error">Failed to search users</div>';
                    return;
                }

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to search users');
                }

                if (!data.user) {
                    resultsDiv.innerHTML = '<div class="message info">No user found</div>';
                    return;
                }

                displayUserDetails(data.user);
            } catch (error) {
                resultsDiv.innerHTML = `<div class="message error">${error.message}</div>`;
            }
        }

        // Display user details with edit form
        function displayUserDetails(user) {
            const resultsDiv = document.getElementById('lookup-results');
            
            let html = `
                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="deleteUser(${user.id}, '${user.username}')">üóëÔ∏è Delete User</button>
                    <button class="btn" onclick="logoutUser(${user.id}, '${user.username}')">üö™ Logout User</button>
                </div>
                <div class="user-card">
                    <h3>User email: ${user.username}</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>ID</strong>
                            ${user.id}
                        </div>

                        <div class="info-item">
                            <strong>Nickname</strong>
                            <input type="text" id="edit-nickname" value="${user.nickname}">
                        </div>

                        <div class="info-item">
                            <strong>Account Type</strong>
                            <select id="edit-acctype">
                                <option value="student" ${user.accType === 'student' ? 'selected' : ''}>Student</option>
                                <option value="teacher" ${user.accType === 'teacher' ? 'selected' : ''}>Teacher</option>
                                <option value="admin" ${user.accType === 'admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </div>

                        <div class="info-item">
                            <strong>Last Login</strong>
                            ${user.lastLogIn ? new Date(user.lastLogIn).toLocaleString() : 'Never'}
                        </div>
                        <div class="info-item">
                            <strong>Email Verified</strong>
                            ${user.emailVerified ? '‚úÖ Yes' : '‚ùå No'}
                        </div>
                    </div>

                    <div id="edit-message"></div>
                    <button class="btn btn-secondary save-changes-button" onclick="updateUser(${user.id})">üíæ Save Changes</button>
                </div>
            `;

            // Student Info
            if (user.studentInfo) {
            const stats = JSON.parse(user.studentInfo.stats);
            html += `
                <div class="user-card">
                    <h3>Student Information</h3>
                    <div class="info-grid-2">
                        <div class="info-item">
                            <strong>Knowledge Level</strong>
                            <select id="edit-knowledge">
                                ${[0, 1, 2, 3, 4, 5].map(level => 
                                    `<option value="${level}" ${Number(user.studentInfo.knowledgeLvl) === level ? 'selected' : ''}>Class ${level}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="info-item">
                            <strong>Teacher</strong>
                            <div id="teacher-name">
                                ${user.teacherStudentsAsStudent ? `
                                    <span>${user.teacherStudentsAsStudent.teacher.username} (ID: ${user.teacherStudentsAsStudent.teacher.id})</span>
                                    <button class="btn btn-danger small-btn" onclick="removeTeacherRelation(${user.id})">Remove</button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="info-item">
                            <strong>Week Challenge Score</strong>
                            ${user.studentInfo.weekChlScore}
                        </div>
                        <div class="info-item">
                            <strong>Last Week Challenge Place</strong>
                            ${user.studentInfo.weekChlWinner}
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="updateStudentInfo(${user.id})" style="margin-top: 15px;">üíæ Save Changes</button>
                    <h3 class="performace-statistics">Performance Statistics</h3>
                    <div id="subjectButtons" class="stats-buttons"></div>
                    <div id="metricButtons" class="stats-buttons"></div>
                    <div class="chart-wrapper">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>
            `;

            // Initialize stats chart after HTML is rendered
            setTimeout(() => initializeStatsChart(stats), 100);
        }


            // Student's Tasks
            if (user.assignedTasksAsStudent && user.assignedTasksAsStudent.length > 0) {
                html += `
                    <div class="user-card">
                        <h3>Assigned Tasks (${user.assignedTasksAsStudent.length})</h3>
                        <div class="asset-list">
                `;
                user.assignedTasksAsStudent.forEach(assignment => {
                    let taskDescription = '';
                    try {
                        const parsedTask = JSON.parse(assignment.task.task);
                        const parsedDuration = JSON.parse(assignment.task.duration);
                        const formattedTask = getOptionTextFromValues(parsedTask, parsedDuration);
                        taskDescription = '<ul style="margin: 5px 0; padding-left: 20px;">';
                        formattedTask.forEach(item => {
                            if (item) {
                                if (item.includes("<")) {
                                    taskDescription += `<li>${item}</li>`;
                                } else {
                                    taskDescription += `<li>${item}</li>`;
                                }
                            }
                        });
                        taskDescription += '</ul>';
                    } catch (e) {
                        taskDescription = `<strong>${assignment.task.task}</strong>`;
                    }
                    
                    html += `
                        <div class="task-item">
                            <div>
                                ${taskDescription}
                                <small>Group: ${assignment.task.group} | Status: ${assignment.status ? '‚úÖ Complete' : '‚è≥ Pending'}</small>
                                ${assignment.completionDate ? `<br><small>Completed: ${new Date(assignment.completionDate).toLocaleString()}</small>` : ''}
                            </div>
                            <button class="btn btn-danger small-btn" onclick="deleteTaskAssignment(${assignment.id})">Delete</button>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }

            // Teacher's Students
            if (user.teacherStudentsAsTeacher && user.teacherStudentsAsTeacher.length > 0) {
                html += `
                    <div class="user-card">
                        <h3>Students (${user.teacherStudentsAsTeacher.length})</h3>
                        <div class="inline-form">
                            <div class="form-group">
                                <label for="add-student-id">Add Student by ID</label>
                                <input type="number" id="add-student-id" placeholder="Student ID">
                            </div>
                            <button class="btn small-btn" onclick="addStudentToTeacher(${user.id})">‚ûï Add</button>
                        </div>
                        <div class="asset-list">
                `;
                user.teacherStudentsAsTeacher.forEach(ts => {
                    html += `
                        <div class="student-item">
                            <span>${ts.student.username} (${ts.student.nickname}) - ID: ${ts.student.id}</span>
                            <button class="btn btn-danger small-btn" onclick="removeStudentFromTeacher(${ts.id})">Remove</button>
                        </div>
                    `;
                });
                html += `</div></div>`;
            } else if (user.accType === 'teacher') {
                html += `
                    <div class="user-card">
                        <h3>Students (0)</h3>
                        <div class="inline-form">
                            <div class="form-group">
                                <label for="add-student-id">Add Student by ID</label>
                                <input type="number" id="add-student-id" placeholder="Student ID">
                            </div>
                            <button class="btn small-btn" onclick="addStudentToTeacher(${user.id})">‚ûï Add</button>
                        </div>
                    </div>
                `;
            }

            // Teacher's Tasks
            if (user.assignedTasksAsTeacher && user.assignedTasksAsTeacher.length > 0) {
                html += `
                    <div class="user-card">
                        <h3>Created Tasks (${user.assignedTasksAsTeacher.length})</h3>
                        <div class="asset-list">
                `;
                user.assignedTasksAsTeacher.forEach(task => {
                    const assignedCount = task.studentTasks ? task.studentTasks.length : 0;
                    let taskDescription = '';
                    try {
                        const parsedTask = JSON.parse(task.task);
                        const parsedDuration = JSON.parse(task.duration);
                        const formattedTask = getOptionTextFromValues(parsedTask, parsedDuration);
                        taskDescription = '<ul style="margin: 5px 0; padding-left: 20px;">';
                        formattedTask.forEach(item => {
                            if (item) {
                                if (item.includes("<")) {
                                    taskDescription += `<li>${item}</li>`;
                                } else {
                                    taskDescription += `<li>${item}</li>`;
                                }
                            }
                        });
                        taskDescription += '</ul>';
                    } catch (e) {
                        taskDescription = `<small>Task: ${task.task}</small>`;
                    }
                    
                    html += `
                        <div class="task-item">
                            <div>
                                ${taskDescription}
                                <small>Group: ${task.group} | Assigned to: ${assignedCount} students</small>
                            </div>
                            <button class="btn btn-danger small-btn" onclick="deleteTeacherTask(${task.id})">Delete</button>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }

            // Pet Game
            if (user.petGame) {
                const assets = JSON.parse(user.petGame.objectAssets);
                const petAssets = JSON.parse(user.petGame.petAssets);
                const pets = petAssets[0] || [];
                const consumables = petAssets[1] || [];
                
                html += `
                    <div class="user-card">
                        <h3>Pet Game Data</h3>
                        <div class="info-grid">
                        <div class="info-item">
                            <strong>Money</strong>
                            <input type="number" id="edit-money" value="${user.petGame.money}" min="0">
                        </div>
                        <div class="info-item">
                            <strong>Pet on Walk</strong>
                            ${user.petGame.petOnWalk || 'None'}
                        </div>
                        </div>
                        <button class="btn btn-secondary save-changes-button"" onclick="updatePetGame(${user.id})">üíæ Save Changes</button>

                        <h3 style="margin-top: 20px; margin-bottom: 10px; color: #667eea;">Object Assets</h3>
                        
                        <div class="inline-form">
                            <div class="form-group">
                                <label for="add-asset-id">Item ID</label>
                                <input type="number" id="add-asset-id" placeholder="e.g., 42">
                            </div>
                            <div class="form-group">
                                <label for="add-asset-coords">Coordinates (X,Y)</label>
                                <input type="text" id="add-asset-coords" placeholder="e.g., 10,5 (optional)">
                            </div>
                            <button class="btn small-btn-with-text" onclick="addAsset(${user.id})">‚ûï Add</button>
                        </div>

                        <div class="asset-list">
                            ${assets.map((asset, index) => {
                                const [itemId, coords] = asset;
                                return `
                                    <div class="asset-item">
                                        <span>Item ID: ${itemId}${coords && coords.length ? ` | Coords: [${coords.join(', ')}]` : ''}</span>
                                        <span>${createItemPreview(itemId)}</span>
                                        <button class="btn btn-danger small-btn" onclick="removeAsset(${user.id}, ${index})">Remove</button>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <h3 style="margin-top: 20px; margin-bottom: 10px; color: #667eea;">Pet Assets</h3>
                        <h4 style="margin-top: 20px; margin-bottom: 10px; color: #667eea;">Pets</h4>
                        
                        <div class="inline-form">
                            <div class="form-group">
                                <label for="add-pet-id">Pet ID</label>
                                <input type="text" id="add-pet-id" placeholder="e.g., cat-1">
                            </div>
                            <div class="form-group">
                                <label for="add-pet-name">Pet Name</label>
                                <input type="text" id="add-pet-name" placeholder="e.g., Fluffy">
                            </div>
                            <div class="form-group">
                                <label for="add-pet-skin-id">Default Skin ID</label>
                                <input type="text" id="add-pet-skin-id" placeholder="e.g., cat-1-1">
                            </div>
                            <div class="form-group">
                                <label for="add-pet-skin-index">Default Skin Game Index ID</label>
                                <input type="number" id="add-pet-skin-index" placeholder="e.g., 100">
                            </div>
                            <button class="btn small-btn-with-text" onclick="addPet(${user.id})">‚ûï Add Pet</button>
                        </div>

                        <div class="asset-list">
                            ${pets.map(pet => {
                                const [petId, petData] = pet;
                                const [petName, skins] = petData;
                                return `
                                    <div style="background: rgba(255, 255, 255, 0.25); padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <div>
                                                <strong>${petName}</strong> (${petId})
                                            </div>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="btn btn-secondary small-btn" onclick="renamePet(${user.id}, '${petId}', '${petName}')">‚úèÔ∏è Rename</button>
                                                <button class="btn btn-danger small-btn" onclick="removePet(${user.id}, '${petId}')">Remove</button>
                                            </div>
                                        </div>
                                        <div style="margin-left: 20px;">
                                            <strong style="font-size: 12px; color: #667eea;">Skins:</strong>
                                            ${skins.length === 0 ? '<div style="color: #999; font-size: 12px;">No skins</div>' : ''}
                                            ${skins.map(skin => {
                                                const [skinId, skinIndex, equipped] = skin;
                                                return `
                                                    <div class="asset-item" style="margin-top: 5px;">
                                                        <span style="font-size: 13px;">${skinId} (Index: ${skinIndex}) ${equipped ? '‚úÖ Equipped' : ''}</span>
                                                        <span>${createItemPreview(skinIndex)}</span>
                                                        <button class="btn btn-danger small-btn" onclick="removePetSkin(${user.id}, '${petId}', '${skinId}')">Remove</button>
                                                    </div>
                                                `;
                                            }).join('')}
                                            <div class="inline-form" style="margin-top: 10px;">
                                                <div class="form-group">
                                                    <input type="text" id="skin-id-${petId}" placeholder="Skin Name" style="font-size: 13px; padding: 8px;">
                                                </div>
                                                <div class="form-group">
                                                    <input type="number" id="skin-index-${petId}" placeholder="Skin Index" style="font-size: 13px; padding: 8px;">
                                                </div>
                                                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                                    <input class="equipped-selection-checkbox" type="checkbox" id="skin-equipped-${petId}"> Equipped
                                                </label>
                                                <button class="btn small-btn-with-text add-skin-btn" onclick="addPetSkin(${user.id}, '${petId}')" style="font-size: 13px; padding: 8px 15px;">‚ûï Add Skin</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <small style="color: #666; display: block; margin-top: 5px;">
                            Pet ID is the first class in the "css-class" list in the Game Index for the pet item.
                            Skin ID is the second class in the "css-class" list in the Game Index for the pet or skin items. 
                            Game Index ID is the ID of the pet/skin item in the GameAssetIndex.json
                        </small>

                        <h4 style="margin-top: 20px; margin-bottom: 10px; color: #667eea;">Consumables</h4>
                        
                        <div class="inline-form">
                            <div class="form-group">
                                <label for="add-consumable-id">Item ID</label>
                                <input type="number" id="add-consumable-id" placeholder="e.g., 13">
                            </div>
                            <div class="form-group">
                                <label for="add-consumable-qty">Quantity</label>
                                <input type="number" id="add-consumable-qty" placeholder="e.g., 5" value="1" min="1">
                            </div>
                            <button class="btn small-btn-with-text" onclick="addConsumable(${user.id})">‚ûï Add</button>
                        </div>

                        <div class="asset-list">
                            ${consumables.map(item => {
                                const [itemId, quantity] = item;
                                return `
                                    <div class="asset-item">
                                        <span>Item ID: ${itemId} | Quantity: ${quantity}</span>
                                        <span>${createItemPreview(itemId)}</span>
                                        <button class="btn btn-danger small-btn" onclick="removeConsumable(${user.id}, ${itemId})">Remove</button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;
        }

        // Clear search
        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('lookup-results').innerHTML = '';
        }

        // Update user basic info
        async function updateUser(userId) {
            const updates = {
                nickname: document.getElementById('edit-nickname').value,
                accType: document.getElementById('edit-acctype').value
            };

            try {
                const response = await apiFetch(`${apiBase}admin/user/${userId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                if (!response) {
                    showMessage('edit-message', 'Failed to update user', 'error');
                    return;
                }

                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Failed to update user');

                showMessage('edit-message', 'User updated successfully!', 'success');
                setTimeout(() => searchUsers(), 1500);
            } catch (error) {
                showMessage('edit-message', error.message, 'error');
            }
        }

        // Update student info
        async function updateStudentInfo(userId) {
            const knowledgeLvl = parseInt(document.getElementById('edit-knowledge').value);

            try {
                const response = await apiFetch(`${apiBase}admin/user/${userId}/student`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ knowledgeLvl })
                });

                if (!response || !response.ok) throw new Error('Failed to update student info');
                alert('Student info updated successfully!');
            } catch (error) {
                alert(error.message);
            }
        }

        // Update pet game
        async function updatePetGame(userId) {
            const money = parseInt(document.getElementById('edit-money').value);

            try {
                const response = await apiFetch(`${apiBase}admin/user/${userId}/petgame`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ money })
                });

                if (!response || !response.ok) throw new Error('Failed to update pet game');
                alert('Pet game updated successfully!');
            } catch (error) {
                alert(error.message);
            }
        }

        // Add asset
        async function addAsset(userId) {
            const itemId = parseInt(document.getElementById('add-asset-id').value);
            const coordsInput = document.getElementById('add-asset-coords').value.trim();

            if (isNaN(itemId)) {
                alert('Please enter a valid item ID');
                return;
            }

            let coordinates = [];
            if (coordsInput) {
                const parts = coordsInput.split(',').map(x => parseInt(x.trim()));
                if (parts.length === 2 && !parts.some(isNaN)) {
                    coordinates = parts;
                } else {
                    alert('Invalid coordinates format. Use X,Y');
                    return;
                }
            }

            try {
                const response = await apiFetch(`${apiBase}admin/user/${userId}/asset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemId, coordinates })
                });

                if (!response || !response.ok) throw new Error('Failed to add asset');
                
                document.getElementById('add-asset-id').value = '';
                document.getElementById('add-asset-coords').value = '';
                searchUsers();
            } catch (error) {
                alert(error.message);
            }
        }

        // Remove asset
        async function removeAsset(userId, index) {
            // Ask for confirmation first
            const confirmed = confirm('Are you sure you want to remove this asset?');
            if (!confirmed) return; // Exit if user cancels

            try {
                const response = await apiFetch(`${apiBase}admin/user/${userId}/asset/${index}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response || !response.ok) {
                    throw new Error('Failed to remove asset');
                }

                alert('Asset removed successfully!');
                searchUsers(); // Refresh the user list or UI
            } catch (error) {
                alert(error.message);
            }
        }


        // Delete user
        async function deleteUser(userId, username) {
            if (!confirm(`Are you sure you want to delete user: ${username}?`)) return;

            try {
                const response = await apiFetch(`${apiBase}admin/user/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response || !response.ok) throw new Error('Failed to delete user');
                
                const data = await response.json();
                alert(data.message);
                clearSearch();
            } catch (error) {
                alert(error.message);
            }
        }

        // Add student to teacher
        async function addStudentToTeacher(teacherId) {
            const studentId = parseInt(document.getElementById('add-student-id').value);
            
            if (isNaN(studentId)) {
                alert('Please enter a valid student ID');
                return;
            }

            try {
                const response = await apiFetch(`${apiBase}admin/teacher/${teacherId}/student`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId })
                });

                if (!response || !response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Failed to add student');
                }

                document.getElementById('add-student-id').value = '';
                alert('Student added successfully!');
                searchUsers();
            } catch (error) {
                alert(error.message);
            }
        }

        // Remove student from teacher
        async function removeStudentFromTeacher(relationId) {
            if (!confirm('Remove this student relationship?')) return;

            try {
                const response = await apiFetch(`${apiBase}admin/teacher-student/${relationId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response || !response.ok) throw new Error('Failed to remove student');
                
                alert('Student removed successfully!');
                searchUsers();
            } catch (error) {
                alert(error.message);
            }
        }

        // Remove teacher relation (from student side)
        async function removeTeacherRelation(studentId) {
            // Ask for confirmation first
            const confirmed = confirm('Are you sure you want to remove the teacher relationship?');
            if (!confirmed) return; // Exit if user cancels

            try {
                const response = await apiFetch(`${apiBase}admin/student/${studentId}/teacher`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response || !response.ok) {
                    throw new Error('Failed to remove teacher');
                }

                alert('Teacher removed successfully!');
                searchUsers(); // Refresh the user list or UI
            } catch (error) {
                alert(error.message);
            }
        }


        // Delete task assignment
        async function deleteTaskAssignment(assignmentId) {
            if (!confirm('Delete this task assignment?')) return;

            try {
                const response = await apiFetch(`${apiBase}admin/task-assignment/${assignmentId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response || !response.ok) throw new Error('Failed to delete task assignment');
                
                alert('Task assignment deleted successfully!');
                searchUsers();
            } catch (error) {
                alert(error.message);
            }
        }

        // Delete teacher task
        async function deleteTeacherTask(taskId) {
            if (!confirm('Delete this task? This will also delete all student assignments for this task.')) return;

            try {
                const response = await apiFetch(`${apiBase}admin/teacher-task/${taskId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response || !response.ok) throw new Error('Failed to delete task');
                
                alert('Task deleted successfully!');
                searchUsers();
            } catch (error) {
                alert(error.message);
            }
        }

        // Delete inactive users
        async function deleteInactiveUsers() {
            const months = document.getElementById('inactive-months').value;
            if (!months || months < 1) {
                showMessage('inactive-message', 'Please enter a valid number of months', 'error');
                return;
            }

            if (!confirm(`Delete all users inactive for ${months}+ months (including users who never logged in)?\n\nAdmin accounts will not be deleted.`)) return;

            try {
                const response = await apiFetch(`${apiBase}admin/inactive?inactivePeriod=${months}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response || !response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Failed to delete inactive users');
                }

                const data = await response.json();
                showMessage('inactive-message', 
                    `${data.message}<br>Deleted ${data.deletedCount} users<br>Threshold: ${data.inactiveThresholdMonths} months`, 
                    'success'
                );
            } catch (error) {
                showMessage('inactive-message', error.message, 'error');
            }
        }

        // Send gift
        async function sendGift() {
            const itemId = parseInt(document.getElementById('gift-itemid').value);
            const coordsInput = document.getElementById('gift-coords').value.trim();
            
            if (isNaN(itemId)) {
                showMessage('gift-message', 'Please enter a valid item ID', 'error');
                return;
            }

            let coordinates = [];
            if (coordsInput) {
                const parts = coordsInput.split(',').map(x => parseInt(x.trim()));
                if (parts.length === 2 && !parts.some(isNaN)) {
                    coordinates = parts;
                } else {
                    showMessage('gift-message', 'Invalid coordinates format. Use X,Y or leave empty', 'error');
                    return;
                }
            }

            if (!confirm(`Send item ${itemId} to all users?`)) return;

            try {
                const response = await apiFetch(`${apiBase}admin/gift`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemId, coordinates })
                });

                if (!response || !response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Failed to send gift');
                }

                const data = await response.json();
                showMessage('gift-message', 
                    `${data.message}<br>Updated ${data.updatedCount} users`, 
                    'success'
                );
                document.getElementById('gift-itemid').value = '';
                document.getElementById('gift-coords').value = '';
            } catch (error) {
                showMessage('gift-message', error.message, 'error');
            }
        }

        // Modify money for all
        async function modifyMoneyAll() {
            const amount = parseInt(document.getElementById('money-amount').value);
            
            if (isNaN(amount) || amount === 0) {
                showMessage('money-message', 'Please enter a valid non-zero amount', 'error');
                return;
            }

            const action = amount > 0 ? 'add' : 'subtract';
            if (!confirm(`${action === 'add' ? 'Add' : 'Subtract'} ${Math.abs(amount)} money ${action === 'add' ? 'to' : 'from'} all students?`)) return;

            try {
                const response = await apiFetch(`${apiBase}admin/modify-money`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount })
                });

                if (!response || !response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Failed to modify money');
                }

                const data = await response.json();
                showMessage('money-message', 
                    `${data.message}<br>Updated ${data.updatedCount} users`, 
                    'success'
                );
                document.getElementById('money-amount').value = '';
            } catch (error) {
                showMessage('money-message', error.message, 'error');
            }
        }

        // Remove item from all users
        async function removeItemFromAll() {
            const itemId = parseInt(document.getElementById('remove-itemid').value);
            const compensation = parseInt(document.getElementById('remove-compensation').value) || 0;
            
            if (isNaN(itemId)) {
                showMessage('remove-message', 'Please enter a valid item ID', 'error');
                return;
            }

            let confirmMsg = `Remove all instances of item ${itemId} from all users?`;
            if (compensation > 0) {
                confirmMsg += `\n\nCompensation: ${compensation} money per item removed`;
            }
            
            if (!confirm(confirmMsg)) return;

            try {
                const response = await apiFetch(`${apiBase}admin/remove-item/${itemId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ compensation })
                });

                if (!response || !response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Failed to remove item');
                }

                const data = await response.json();
                showMessage('remove-message', 
                    `${data.message}<br>Users affected: ${data.usersAffected}<br>Items removed: ${data.itemsRemoved}${data.totalCompensation > 0 ? `<br>Total compensation: ${data.totalCompensation}` : ''}`, 
                    'success'
                );
                document.getElementById('remove-itemid').value = '';
                document.getElementById('remove-compensation').value = '';
            } catch (error) {
                showMessage('remove-message', error.message, 'error');
            }
        }

        // Logout user
        async function logoutUser(userId, username) {
            if (!confirm(`Are you sure you want to logout user: ${username}? They will need to log in again.`)) return;

            try {
                const response = await apiFetch(`${apiBase}admin/logout-user/${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response || !response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Failed to logout user');
                }
                
                const data = await response.json();
                alert(`${data.message}\nTokens deleted: ${data.tokensDeleted}`);
            } catch (error) {
                alert(error.message);
            }
        }

        // Logout all users
        async function logoutAllUsers() {
            if (!confirm('Are you sure you want to logout ALL users? They will need to log in again.')) return;

            try {
                const response = await apiFetch(`${apiBase}admin/logout-all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response || !response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Failed to logout users');
                }

                const data = await response.json();
                showMessage('system-message', 
                    `${data.message}<br>Users affected: ${data.usersAffected}<br>Tokens deleted: ${data.tokensDeleted}`, 
                    'success'
                );
            } catch (error) {
                showMessage('system-message', error.message, 'error');
            }
        }

        // Pet management functions
        async function addPet(userId) {
            const petId = document.getElementById('add-pet-id').value.trim();
            const petName = document.getElementById('add-pet-name').value.trim();
            const defaultSkinId = document.getElementById('add-pet-skin-id').value.trim();
            const defaultSkinIndex = document.getElementById('add-pet-skin-index').value.trim();

            if (!petId || !petName) {
                alert('Please enter both pet ID and name');
                return;
            }

            if (!defaultSkinId || !defaultSkinIndex) {
                alert('Please enter default skin ID and index');
                return;
            }

            try {
                const response = await apiFetch(`${apiBase}admin/user/${userId}/pet`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        petId, 
                        petName,
                        defaultSkinId,
                        defaultSkinIndex: parseInt(defaultSkinIndex)
                    })
                });

                if (!response || !response.ok) throw new Error('Failed to add pet');
                
                document.getElementById('add-pet-id').value = '';
                document.getElementById('add-pet-name').value = '';
                document.getElementById('add-pet-skin-id').value = '';
                document.getElementById('add-pet-skin-index').value = '';
                searchUsers();
            } catch (error) {
                alert(error.message);
            }
        }

        async function removePet(userId, petId) {
            if (!confirm(`Remove pet ${petId}?`)) return;

            try {
                const response = await apiFetch(`${apiBase}admin/user/${userId}/pet/${petId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response || !response.ok) throw new Error('Failed to remove pet');
                searchUsers();
            } catch (error) {
                alert(error.message);
            }
        }

        async function renamePet(userId, petId, currentName) {
            const newName = prompt('Enter new pet name:', currentName);
            if (!newName || newName === currentName) return;

            try {
                const response = await apiFetch(`${apiBase}admin/user/${userId}/pet-name`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ petId, newName })
                });

                if (!response || !response.ok) throw new Error('Failed to rename pet');
                searchUsers();
            } catch (error) {
                alert(error.message);
            }
        }

        async function addPetSkin(userId, petId) {
            const skinId = document.getElementById(`skin-id-${petId}`).value.trim();
            const skinIndex = parseInt(document.getElementById(`skin-index-${petId}`).value);
            const equipped = document.getElementById(`skin-equipped-${petId}`).checked;

            if (!skinId || isNaN(skinIndex)) {
                alert('Please enter skin ID and index');
                return;
            }

            try {
                const response = await apiFetch(`${apiBase}admin/user/${userId}/pet-skin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ petId, skinId, skinIndex, equipped })
                });

                if (!response || !response.ok) throw new Error('Failed to add pet skin');
                
                document.getElementById(`skin-id-${petId}`).value = '';
                document.getElementById(`skin-index-${petId}`).value = '';
                document.getElementById(`skin-equipped-${petId}`).checked = false;
                searchUsers();
            } catch (error) {
                alert(error.message);
            }
        }

        async function removePetSkin(userId, petId, skinId) {
            if (!confirm(`Remove skin ${skinId}?`)) return;

            try {
                const response = await apiFetch(`${apiBase}admin/user/${userId}/pet-skin`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ petId, skinId })
                });

                if (!response || !response.ok) throw new Error('Failed to remove pet skin');
                searchUsers();
            } catch (error) {
                alert(error.message);
            }
        }

        async function addConsumable(userId) {
            const itemId = parseInt(document.getElementById('add-consumable-id').value);
            const quantity = parseInt(document.getElementById('add-consumable-qty').value);

            if (isNaN(itemId) || isNaN(quantity) || quantity < 1) {
                alert('Please enter valid item ID and quantity');
                return;
            }

            try {
                const response = await apiFetch(`${apiBase}admin/user/${userId}/consumable`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemId, quantity })
                });

                if (!response || !response.ok) throw new Error('Failed to add consumable');
                
                document.getElementById('add-consumable-id').value = '';
                document.getElementById('add-consumable-qty').value = '1';
                searchUsers();
            } catch (error) {
                alert(error.message);
            }
        }

        async function removeConsumable(userId, itemId) {
            if (!confirm(`Remove consumable ${itemId}?`)) return;

            try {
                const response = await apiFetch(`${apiBase}admin/user/${userId}/consumable/${itemId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response || !response.ok) throw new Error('Failed to remove consumable');
                searchUsers();
            } catch (error) {
                alert(error.message);
            }
        }

        // Bulk consumable operations
        async function addConsumableToAll() {
            const itemId = parseInt(document.getElementById('bulk-consumable-id').value);
            const quantity = parseInt(document.getElementById('bulk-consumable-qty').value);

            if (isNaN(itemId) || isNaN(quantity) || quantity < 1) {
                showMessage('bulk-consumable-message', 'Please enter valid item ID and quantity', 'error');
                return;
            }

            if (!confirm(`Add consumable ${itemId} (qty: ${quantity}) to all users?`)) return;

            try {
                const response = await apiFetch(`${apiBase}admin/bulk/consumable`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemId, quantity })
                });

                if (!response || !response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Failed to add consumable');
                }

                const data = await response.json();
                showMessage('bulk-consumable-message', 
                    `${data.message}<br>Updated ${data.updatedCount} users`, 
                    'success'
                );
                document.getElementById('bulk-consumable-id').value = '';
                document.getElementById('bulk-consumable-qty').value = '1';
            } catch (error) {
                showMessage('bulk-consumable-message', error.message, 'error');
            }
        }

        async function removeConsumableFromAll() {
            const itemId = parseInt(document.getElementById('bulk-remove-consumable-id').value);
            const compensation = parseInt(document.getElementById('bulk-remove-compensation').value) || 0;

            if (isNaN(itemId)) {
                showMessage('bulk-remove-consumable-message', 'Please enter a valid item ID', 'error');
                return;
            }

            let confirmMsg = `Remove consumable ${itemId} from all users?`;
            if (compensation > 0) {
                confirmMsg += `\n\nCompensation: ${compensation} money per item removed`;
            }

            if (!confirm(confirmMsg)) return;

            try {
                const response = await apiFetch(`${apiBase}admin/bulk/consumable/${itemId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ compensation })
                });

                if (!response || !response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Failed to remove consumable');
                }

                const data = await response.json();
                showMessage('bulk-remove-consumable-message', 
                    `${data.message}<br>Users affected: ${data.usersAffected}${data.totalCompensation > 0 ? `<br>Total items removed: ${data.totalItemsRemoved}<br>Total compensation: ${data.totalCompensation}` : ''}`, 
                    'success'
                );
                document.getElementById('bulk-remove-consumable-id').value = '';
                document.getElementById('bulk-remove-compensation').value = '';
            } catch (error) {
                showMessage('bulk-remove-consumable-message', error.message, 'error');
            }
        }

        // MESSAGE GIFT FUNCTIONS

        async function loadMessages() {
            const listDiv = document.getElementById('messages-list');
            listDiv.innerHTML = '<div class="loading">Loading messages...</div>';

            try {
                const response = await apiFetch(`${apiBase}admin/messages`);
                
                if (!response || !response.ok) {
                    throw new Error('Failed to load messages');
                }

                const data = await response.json();
                
                if (data.messages.length === 0) {
                    listDiv.innerHTML = '<div class="message info">No messages found</div>';
                    return;
                }

                let html = '';
                data.messages.forEach(msg => {
                    const recipientCount = msg.petGames.length;
                    const expirationDate = new Date(msg.giftExpiration);
                    const isExpired = expirationDate < new Date();
                    
                    html += `
                        <div class="message-item">
                            <div style="flex: 1;">
                                <strong>ID ${msg.id}:</strong> ${msg.message}<br>
                                <small>
                                    ${msg.giftId ? `Gift ID: ${msg.giftId} | Qty: ${msg.quantity} | ` : ''}
                                    Expires: ${expirationDate.toLocaleString()} ${isExpired ? '‚ö†Ô∏è EXPIRED' : ''}<br>
                                    Recipients: ${recipientCount} users
                                </small>
                            </div>
                            <button class="btn btn-danger small-btn" onclick="deleteMessage(${msg.id})">Delete</button>
                        </div>
                    `;
                });

                listDiv.innerHTML = html;

            } catch (error) {
                listDiv.innerHTML = `<div class="message error">${error.message}</div>`;
            }
        }

        async function createMessageGift() {
            const message = document.getElementById('msg-message').value.trim();
            const expirationDate = document.getElementById('msg-expiration').value;
            const giftId = document.getElementById('msg-giftid').value.trim();
            const quantity = parseInt(document.getElementById('msg-quantity').value);
            const sendToAll = document.getElementById('msg-sendtoall').checked;

            if (!message) {
                showMessage('msg-create-message', 'Please enter a message', 'error');
                return;
            }

            if (!expirationDate) {
                showMessage('msg-create-message', 'Please select an expiration date', 'error');
                return;
            }

            if (!sendToAll && recipients.length === 0) {
                showMessage('msg-create-message', 'Please add at least one recipient or select "Send to all"', 'error');
                return;
            }

            try {
                const body = {
                    message,
                    expirationDate: new Date(expirationDate).toISOString(),
                    quantity: quantity || 1,
                    sendToAll
                };

                if (giftId) {
                    body.giftId = parseInt(giftId);
                }

                if (!sendToAll) {
                    body.recipients = recipients;
                }

                const response = await apiFetch(`${apiBase}admin/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response || !response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Failed to create message gift');
                }

                const data = await response.json();
                showMessage('msg-create-message', 
                    `${data.message}<br>Recipients: ${data.recipientCount} users`, 
                    'success'
                );

                // Clear form
                document.getElementById('msg-message').value = '';
                document.getElementById('msg-expiration').value = '';
                document.getElementById('msg-giftid').value = '';
                document.getElementById('msg-quantity').value = '1';
                document.getElementById('msg-sendtoall').checked = false;
                recipients = [];
                updateRecipientTags();
                toggleRecipients();

                // Reload messages list
                loadMessages();

            } catch (error) {
                showMessage('msg-create-message', error.message, 'error');
            }
        }

        async function deleteMessage(messageId) {
            if (!confirm('Delete this message gift? This will remove it from all users.')) return;

            try {
                const response = await apiFetch(`${apiBase}admin/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response || !response.ok) {
                    throw new Error('Failed to delete message');
                }

                alert('Message deleted successfully!');
                loadMessages();

            } catch (error) {
                alert(error.message);
            }
        }

        // Set minimum date for expiration to today
        window.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('msg-expiration').setAttribute('min', today);
        });

        // STATS CHART SYSTEM
        let statsChart = null;
        let processedStudentStats = null;
        let selectedSubject = null;
        let selectedMetrics = [];
        let availableMetrics = [];
        let previousDatasets = [];

        const lithuanianMonths = ['Saus.', 'Vas.', 'Kov.', 'Bal.', 'Geg.', 'Bir≈æ.', 'Liep.', 'Rugp.', 'Rugs.', 'Spal.', 'Lap.', 'Gruod.'];
        const metricColors = ['#286D8A', '#32ac93', '#e74c3c', '#F28C28', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

        function processStatsData(rawStats) {
            const processed = {};
            
            // Consistency
            if (rawStats.c && rawStats.c.length > 0) {
                processed.c = {
                    title: 'Nuoseklumas',
                    values: rawStats.c.map(v => Math.round(v * 100))
                };
            }
            
            // Mathematics
            if (rawStats.m && rawStats.m.length > 0) {
                processed.m = {
                    title: 'Matematika',
                    values: {
                        '0': { title: 'Ta≈°kai', values: rawStats.m.map(w => w[0]) },
                        '1': { title: 'Teisingi Atsakymai', values: rawStats.m.map(w => w[1]) },
                        '2': { title: 'Klaidos', values: rawStats.m.map(w => w[2]) },
                        '3': { title: 'Atsakyti Klausimai', values: rawStats.m.map(w => w[3]) }
                    }
                };
            }
            
            // Technology
            if (rawStats.t && rawStats.t.length > 0) {
                processed.t = {
                    title: 'Teksto Suvokimas',
                    values: {
                        '0': { title: 'Ta≈°kai', values: rawStats.t.map(w => w[0]) },
                        '1': { title: 'Teisingi atsakymai', values: rawStats.t.map(w => w[1]) },
                        '2': { title: 'Klaidos', values: rawStats.t.map(w => w[2]) },
                        '3': { title: 'Atsakyti Klausimai', values: rawStats.t.map(w => w[3]) }
                    }
                };
            }
            
            // Geography
            if (rawStats.g && rawStats.g.length > 0) {
                processed.g = {
                    title: 'Gramatika',
                    values: {
                        '0': { title: 'Ta≈°kai', values: rawStats.g.map(w => w[0]) },
                        '1': { title: 'Teisingi atsakymai', values: rawStats.g.map(w => w[1]) },
                        '2': { title: 'Klaidos', values: rawStats.g.map(w => w[2]) },
                        '3': { title: 'Atsakyti Klausimai', values: rawStats.g.map(w => w[3]) }
                    }
                };
            }
            
            return processed;
        }

        function getPreviousMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = day === 0 ? 6 : day - 1;
            d.setDate(d.getDate() - diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function generateMondayDates(count) {
            const dates = [];
            const today = new Date();
            let currentMonday = getPreviousMonday(today);
            
            for (let i = 0; i < count; i++) {
                dates.push(formatLithuanianDate(currentMonday));
                currentMonday.setDate(currentMonday.getDate() - 7);
            }
            
            return dates.reverse();
        }

        function formatLithuanianDate(date) {
            const day = date.getDate();
            const month = lithuanianMonths[date.getMonth()];
            return month + ' ' + day;
        }

        function isPercentageMetric(metricTitle) {
            const lower = metricTitle.toLowerCase();
            return lower.includes('atsakym') || lower.includes('klaid') || lower.includes('nuosekl');
        }

        function extractMetricsFromData() {
            const metrics = [];
            const keys = Object.keys(processedStudentStats);
            
            for (const key of keys) {
                if (key === 'c') continue;
                
                const subjectValues = processedStudentStats[key].values;
                if (typeof subjectValues === 'object' && !Array.isArray(subjectValues)) {
                    for (const metricKey of Object.keys(subjectValues)) {
                        const metricData = subjectValues[metricKey];
                        const isPercent = isPercentageMetric(metricData.title);
                        
                        if (!metrics.some(m => m.id === metricKey && m.title === metricData.title)) {
                            metrics.push({
                                id: metricKey,
                                title: metricData.title,
                                type: isPercent ? 'percentage' : 'absolute',
                                color: metricColors[metrics.length % metricColors.length],
                                yAxisID: isPercent ? 'y-percent' : 'y-absolute-' + metricKey
                            });
                        }
                    }
                    break;
                }
            }
            
            return metrics;
        }

        function selectSubject(key) {
            selectedSubject = key;
            
            if (key === 'c') {
                selectedMetrics = [];
            } else {
                if (selectedMetrics.length === 0 && availableMetrics.length > 0) {
                    selectedMetrics = [availableMetrics[0].id];
                }
            }
            
            document.querySelectorAll('.btn-subject').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-subject-key') === key) {
                    btn.classList.add('active');
                }
            });
            
            updateMetricButtonsState();
            updateStatsChart();
        }

        function updateMetricButtonsState() {
            const buttons = document.querySelectorAll('#metricButtons .btn-metric');
            const isConsistency = selectedSubject === 'c';
            
            buttons.forEach(btn => {
                btn.disabled = isConsistency;
                if (isConsistency) {
                    btn.classList.remove('active');
                } else {
                    const metricId = btn.getAttribute('data-metric-id');
                    if (selectedMetrics.includes(metricId)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            });
        }

        function toggleMetric(id) {
            if (selectedSubject === 'c') return;
            
            const index = selectedMetrics.indexOf(id);
            if (index !== -1) {
                selectedMetrics.splice(index, 1);
            } else {
                selectedMetrics.push(id);
            }
            
            updateMetricButtonsState();
            updateStatsChart();
        }

        function initializeStatsButtons() {
            const subjectContainer = document.getElementById('subjectButtons');
            const metricContainer = document.getElementById('metricButtons');

            subjectContainer.innerHTML = '';
            metricContainer.innerHTML = '';
            
            availableMetrics = extractMetricsFromData();

            const keys = Object.keys(processedStudentStats);
            const firstKey = keys[0];
            
            for (const key of keys) {
                const data = processedStudentStats[key];
                const btn = document.createElement('button');
                btn.className = 'btn-subject';
                btn.textContent = data.title;
                btn.setAttribute('data-subject-key', key);
                btn.onclick = () => selectSubject(key);
                subjectContainer.appendChild(btn);
            }

            for (const metric of availableMetrics) {
                const btn = document.createElement('button');
                btn.className = 'btn-metric';
                btn.textContent = metric.title;
                btn.setAttribute('data-metric-id', metric.id);
                btn.onclick = () => toggleMetric(metric.id);
                metricContainer.appendChild(btn);
            }
            
            if (firstKey) {
                selectSubject(firstKey);
            }
        }

        function getDataForSubject() {
            if (!selectedSubject) return null;
            
            const subject = processedStudentStats[selectedSubject];
            if (selectedSubject === 'c') {
                return { 
                    dates: generateMondayDates(subject.values.length), 
                    values: subject.values,
                    isConsistency: true
                };
            } else {
                const firstMetricKey = Object.keys(subject.values)[0];
                const firstMetric = subject.values[firstMetricKey];
                return { 
                    dates: generateMondayDates(firstMetric.values.length),
                    values: subject.values,
                    isConsistency: false
                };
            }
        }

        function updateStatsChart() {
            if (statsChart) {
                statsChart.destroy();
                statsChart = null;
            }

            const subjectData = getDataForSubject();
            if (!subjectData) return;
            
            const datasets = [];

            if (subjectData.isConsistency) {
                datasets.push({
                    label: processedStudentStats.c.title,
                    data: subjectData.values,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.3,
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    yAxisID: 'y-percent'
                });
            } else {
                for (const metricId of selectedMetrics) {
                    const metric = availableMetrics.find(m => m.id === metricId);
                    const metricData = subjectData.values[metricId];
                    
                    if (metric && metricData) {
                        datasets.push({
                            label: metricData.title,
                            data: metricData.values,
                            borderColor: metric.color,
                            backgroundColor: metric.color + '20',
                            tension: 0.3,
                            borderWidth: 3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: metric.color,
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            yAxisID: metric.yAxisID
                        });
                    }
                }
            }

            const yAxes = {};
            
            // Check if we need percentage axis
            const hasPercentage = datasets.some(d => d.yAxisID === 'y-percent' || d.yAxisID.startsWith('y-percent-'));
            
            if (hasPercentage) {
                yAxes['y-percent'] = {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    min: 0,
                    max: selectedSubject === 'c' ? 100 : undefined,
                    ticks: { 
                        callback: (value) => value.toFixed(0) + '%',
                        color: '#666'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                };
            }

            // Add axes for absolute metrics
            const absoluteMetrics = datasets.filter(d => !d.yAxisID.includes('percent'));
            absoluteMetrics.forEach((dataset, index) => {
                if (!yAxes[dataset.yAxisID]) {
                    yAxes[dataset.yAxisID] = {
                        type: 'linear',
                        display: true,
                        position: hasPercentage || index > 0 ? 'right' : 'left',
                        min: 0,
                        ticks: {
                            callback: (value) => value.toFixed(1),
                            color: '#666'
                        },
                        grid: { 
                            drawOnChartArea: index === 0 && !hasPercentage,
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    };
                }
            });

            const ctx = document.getElementById('statsChart').getContext('2d');
            statsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: subjectData.dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    const yAxisId = context.dataset.yAxisID;
                                    if (yAxisId === 'y-percent' || yAxisId.startsWith('y-percent-')) {
                                        label += context.parsed.y + '%';
                                    } else {
                                        label += context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: yAxes
                }
            });
        }

        function initializeStatsChart(rawStats) {
            // Check if stats has enough data
            if (!rawStats || !rawStats.c || rawStats.c.length < 3) {
                return;
            }

            processedStudentStats = processStatsData(rawStats);
            selectedSubject = null;
            selectedMetrics = [];
            previousDatasets = [];
            
            initializeStatsButtons();
        }

        async function triggerGlobalMessageCleanup() {
            try {
                const response = await apiFetch(`${apiBase}admin/cleanExpiredMessages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                    // no body needed
                });

                if (!response) {
                    console.warn('Cleanup request did not return a response');
                    return;
                }

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to run cleanup');
                }

                // success
                const removed = typeof data.removed === 'number' ? data.removed : 0;
                alert(`Cleanup succeeded: ${removed} expired messages removed.`);
                // optional user-visible notification:
                // messageToTheUser(`I≈°trinta ${removed} pasibaigusi≈≥ ≈æinuƒçi≈≥.`, 'info');
            } catch (error) {
                alert('Cleanup failed:', error);
            }
        }

        // Load statistics
async function loadStatistics() {
    const statsDiv = document.getElementById('statistics-content');
    statsDiv.innerHTML = '<div class="loading">Loading statistics...</div>';

    try {
        const response = await apiFetch(`${apiBase}admin/statistics`);
        
        if (!response || !response.ok) {
            throw new Error('Failed to load statistics');
        }

        const stats = await response.json();
        displayStatistics(stats);
    } catch (error) {
        statsDiv.innerHTML = `<div class="message error">${error.message}</div>`;
    }
}

function displayStatistics(stats) {
    const statsDiv = document.getElementById('statistics-content');
    
    const calcPercentage = (value, total) => {
        return total > 0 ? Math.round((value / total) * 100) : 0;
    };
    
    let html = `
        <div class="stats-grid">
            <div class="stat-card">
                <h3>üë• User Statistics</h3>
                <div class="stat-items">
                    <div class="stat-item">
                        <span class="stat-label">Total Users:</span>
                        <span class="stat-value">${stats.users.total}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Students:</span>
                        <span class="stat-value">${stats.users.students}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Teachers:</span>
                        <span class="stat-value">${stats.users.teachers}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Admins:</span>
                        <span class="stat-value">${stats.users.admins}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Unverified:</span>
                        <span class="stat-value">${stats.users.unverified} (${calcPercentage(stats.users.unverified, stats.users.unverified + stats.users.verified)}%)</span>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üìä User Activity</h3>
                <div class="stat-items">
                    <div class="stat-item">
                        <span class="stat-label">Never Logged In:</span>
                        <span class="stat-value">${stats.activity.neverLoggedIn} (${calcPercentage(stats.activity.neverLoggedIn, stats.users.total)}%)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active Last Day:</span>
                        <span class="stat-value">${stats.activity.activeLastDay} (${calcPercentage(stats.activity.activeLastDay, stats.users.total)}%)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active Last Week:</span>
                        <span class="stat-value">${stats.activity.activeLastWeek} (${calcPercentage(stats.activity.activeLastWeek, stats.users.total)}%)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active Last Month:</span>
                        <span class="stat-value">${stats.activity.activeLastMonth} (${calcPercentage(stats.activity.activeLastMonth, stats.users.total)}%)</span>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üéÆ Pet Game Activity</h3>
                <div class="stat-items">
                    <div class="stat-item">
                        <span class="stat-label">Total Games:</span>
                        <span class="stat-value">${stats.petGame.totalGames}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Average Money:</span>
                        <span class="stat-value">${Number(stats.petGame.averageMoney).toFixed(0)} üí∞</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active Last Day:</span>
                        <span class="stat-value">${stats.petGame.activeLastDay} (${calcPercentage(stats.petGame.activeLastDay, stats.petGame.totalGames)}%)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active Last Week:</span>
                        <span class="stat-value">${stats.petGame.activeLastWeek} (${calcPercentage(stats.petGame.activeLastWeek, stats.petGame.totalGames)}%)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active Last Month:</span>
                        <span class="stat-value">${stats.petGame.activeLastMonth} (${calcPercentage(stats.petGame.activeLastMonth, stats.petGame.totalGames)}%)</span>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üìù Task Assignment</h3>
                <div class="stat-items">
                    <div class="stat-item">
                        <span class="stat-label">Teachers with Tasks:</span>
                        <span class="stat-value">${stats.tasks.teachersWithTasks} (${calcPercentage(stats.tasks.teachersWithTasks, stats.tasks.totalTeachers)}%)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Avg Tasks per Teacher:</span>
                        <span class="stat-value">${stats.tasks.avgTasksPerTeacher}</span>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üë®‚Äçüè´ Classrooms</h3>
                <div class="stat-items">
                    <div class="stat-item">
                        <span class="stat-label">Total Classrooms:</span>
                        <span class="stat-value">${stats.challenges.totalClasses}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Students without Teacher:</span>
                        <span class="stat-value">${stats.relationships.studentsWithoutTeachers} (${calcPercentage(stats.relationships.studentsWithoutTeachers, stats.relationships.totalStudents)}%)</span>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üèÜ Week Challenge Participation</h3>
                <div class="stat-items">
                    <div class="stat-item">
                        <span class="stat-label">Classes Participating:</span>
                        <span class="stat-value">${stats.challenges.classesParticipating} (${calcPercentage(stats.challenges.classesParticipating, stats.challenges.totalClasses)}%)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Avg Students per Class:</span>
                        <span class="stat-value">${stats.challenges.avgStudentsPerClass}</span>
                    </div>
                </div>
            </div>

            <div class="stat-card">
            <h3>üìö Knowledge Level Distribution</h3>
                <div class="stat-items">
                    ${stats.knowledgeLevels.map(kl => `
                        <div class="stat-item">
                            <span class="stat-label">Class ${kl.level}:</span>
                            <span class="stat-value">${kl.count} (${kl.percentage}%)</span>
                        </div>
                    `).join('')}
                    <div class="stat-item">
                        <span class="stat-label">Class Unassigned Active After 14/12/2025:</span>
                        <span class="stat-value">${stats.unassignedClass.recentlyActive} (${stats.unassignedClass.recentlyActivePercentage}%)</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    statsDiv.innerHTML = html;
}

// Add the getOptionTextFromValues function
function getOptionTextFromValues(values, duration) {
    function determineQuestionNumberTimeLabelEnding(type, string) {
        if (type === "C39") {
            let durationTypeTag = '';
            if (parseInt(string) === 1 || (parseInt(string.toString().slice(-1)[0]) === 1 && parseInt(string) !== 11)) {
                durationTypeTag = 'MINUTƒò';
            } else if ((parseInt(string) > 1 && parseInt(string) < 10) || (parseInt(string) > 20 && parseInt(string.toString().slice(-1)[0]) !== 0)) {
                durationTypeTag = 'MINUTES';
            } else if (parseInt(string) >= 10) {
                durationTypeTag = 'MINUƒåI≈≤';
            }
            return ("PRAKTIKUOTIS " + string + " " + durationTypeTag);
        } else {
            if (values[0] === "math") {
                let durationTypeTag = '';
                if (parseInt(string) === 1 || (parseInt(string.toString().slice(-1)[0]) === 1 && parseInt(string) !== 11)) {
                    durationTypeTag = 'VEIKSMƒÑ';
                } else if ((parseInt(string) > 1 && parseInt(string) < 10) || (parseInt(string) > 20 && parseInt(string.toString().slice(-1)[0]) !== 0)) {
                    durationTypeTag = 'VEIKSMUS';
                } else if (parseInt(string) >= 10) {
                    durationTypeTag = 'VEIKSM≈≤';
                }
                return ("ATLIKTI " + string + " " + durationTypeTag);
            } else if (values[0] === "lang") {
                if (values[2] === "C49") {
                    let durationTypeTag = '';
                    if (parseInt(string) === 1 || (parseInt(string.toString().slice(-1)[0]) === 1 && parseInt(string) !== 11)) {
                        durationTypeTag = 'TEKSTƒÑ';
                    } else if ((parseInt(string) > 1 && parseInt(string) < 10) || (parseInt(string) > 20 && parseInt(string.toString().slice(-1)[0]) !== 0)) {
                        durationTypeTag = 'TEKSTUS';
                    } else if (parseInt(string) >= 10) {
                        durationTypeTag = 'TEKST≈≤';
                    }
                    return ("SUDƒñLIOTI " + string + " " + durationTypeTag);
                } else if (values[2] === "C83") {
                    let durationTypeTag = '';
                    if (parseInt(string) === 1 || (parseInt(string.toString().slice(-1)[0]) === 1 && parseInt(string) !== 11)) {
                        durationTypeTag = 'SAKINYS';
                    } else if ((parseInt(string) > 1 && parseInt(string) < 10) || (parseInt(string) > 20 && parseInt(string.toString().slice(-1)[0]) !== 0)) {
                        durationTypeTag = 'SAKINIAI';
                    } else if (parseInt(string) >= 10) {
                        durationTypeTag = 'SAKINI≈≤';
                    }
                    return (string + " " + durationTypeTag);
                }
            }
        }
    }

    let result = [];
    let final_results = [];

    if (values[0] === "math") {
        result.push(parameterDictionary[values[1]]?.["decodedParameterText"] || "");
        result.push(parameterDictionary[values[2]]?.["decodedParameterText"] || "");
        result.push(parameterDictionary[values[3]]?.["decodedParameterText"] || "");
        result.push(parameterDictionary[values[4]]?.["decodedParameterText"] || "");
        
        if (values[4] === "C42") {
            if (values[1] === "C1") {
                result.push("NE≈ΩINOMAS DƒñMUO");
            } else if (values[1] === "C2") {
                if (values[5] === "C43") {
                    result.push("NE≈ΩINOMAS TURINYS");
                } else if (values[5] === "C44") {
                    result.push("NE≈ΩINOMAS ATƒñMINYS");
                }
            } else if (values[1] === "C3") {
                result.push("NE≈ΩINOMAS DƒñMUO / TURINYS / ATƒñMINYS");
            } else if (values[1] === "C4") {
                result.push("NE≈ΩINOMAS DAUGINAMASIS");
            } else if (values[1] === "C5") {
                if (values[5] === "C45") {
                    result.push("NE≈ΩINOMAS DALINYS");
                } else if (values[5] === "C46") {
                    result.push("NE≈ΩINOMAS DALIKLIS");
                }
            } else if (values[1] === "C6") {
                result.push("NE≈ΩINOMAS DAUGINAMASIS / DALINYS / DALIKLIS");
            } else if (values[1] === "C7") {
                result.push("NE≈ΩINOMAS DƒñMUO / TURINYS / ATƒñMINYS / DAUGINAMASIS / DALINYS / DALIKLIS");
            }
        } else {
            result.push(parameterDictionary[values[5]]?.["decodedParameterText"] || "");
        }

        result.push(parameterDictionary[values[6]]?.["decodedParameterText"] || "");
        result.push(values[7]);
        result.push(values[8] ? "DALYBA SU LIEKANA" : "DALYBA BE LIEKANOS");
        result.push(values[9]);

        final_results.push(result[0]);

        if (result[0] === "SUDƒñTIS" || result[0] === "ATIMTIS" || result[0] === "SUDƒñTIS IR ATIMTIS") {
            final_results.push(result[1]);
            final_results.push(result[2]);
            final_results.push(result[3]);
            if (result[4] === "SKAITINƒñ LYGYBƒñ") {
                final_results.push(result[5]);
            } else if (result[4] === "SKAITINƒñ LYGYBƒñ SU NE≈ΩINOMUOJU") {
                final_results.push(result[4]);
            }
            final_results.push(result[5]);
            final_results.push(determineQuestionNumberTimeLabelEnding(duration[0], duration[1]));
        } else if (result[0] === "DAUGYBA") {
            final_results.push(result[1]);
            if (result[1] === "DAUGYBOS LENTELƒñ") {
                final_results.push(`NUO ${result[6][0]} IKI ${result[6][1]}`);
            }
            final_results.push(result[3]);
            if (result[4] === "SKAITINƒñ LYGYBƒñ SU NE≈ΩINOMUOJU") {
                final_results.push(result[5]);
            }
            final_results.push(result[5]);
            final_results.push(determineQuestionNumberTimeLabelEnding(duration[0], duration[1]));
        } else if (result[0] === "DALYBA" || result[0] === "DAUGYBA IR DALYBA") {
            final_results.push(result[1]);
            if (result[1] === "DAUGYBOS LENTELƒñ") {
                final_results.push(`NUO ${result[6][0]} IKI ${result[6][1]}`);
            }
            final_results.push(result[7]);
            final_results.push(result[3]);
            if (result[4] === "SKAITINƒñ LYGYBƒñ SU NE≈ΩINOMUOJU") {
                final_results.push(result[4]);
            }
            final_results.push(result[5]);
            final_results.push(determineQuestionNumberTimeLabelEnding(duration[0], duration[1]));
        } else if (result[0] === "ƒÆVAIR≈™S VEIKSMAI") {
            final_results.push(result[1]);
            final_results.push(result[3]);
            if (result[4] === "SKAITINƒñ LYGYBƒñ SU NE≈ΩINOMUOJU") {
                final_results.push(result[4]);
            }
            final_results.push(result[5]);
            final_results.push(determineQuestionNumberTimeLabelEnding(duration[0], duration[1]));
        }
    } else if (values[0] === "lang") {
            result.push(parameterDictionary[values[1]]["decodedParameterText"])
            result.push(parameterDictionary[values[2]]["decodedParameterText"])
            
            result.push(parameterDictionary[values[3]]["decodedParameterText"])  

            if (values[3]  === "C50") {
                let outerLiItem = document.createElement('li');
                outerLiItem.textContent = "RA≈†YBOS NUSTATYMAI:"; // Add a label for the outer <li>

                let grammarParamsList = document.createElement('ul');
                grammarParamsList.classList.add('grammar-params-list');
                
                Object.keys(values[4]).forEach(key => {
                    let listItem = document.createElement('li');
                    listItem.innerHTML = parameterDictionary[key]["decodedParameterText"]; // Use innerHTML instead of textContent
                    grammarParamsList.appendChild(listItem);
                });

                outerLiItem.appendChild(grammarParamsList);


                // Store as an HTML string
                result.push(outerLiItem.outerHTML);

                result.push(parameterDictionary[values[5]]["decodedParameterText"])

                if (values[6] === 1) {
                    result.push("DA≈ΩNESNI NE≈ΩINOM≈≤ ≈ΩOD≈ΩI≈≤ ATVEJAI")
                } else {
                    result.push("RETESNI NE≈ΩINOM≈≤ ≈ΩOD≈ΩI≈≤ ATVEJAI")
                }
            }

            final_results.push(result[0])
            final_results.push(result[1])
            final_results.push(result[2])
            if (result[1] === "TEKSTO SUPRATIMAS") {
                final_results.push(parameterDictionary[values[4]]["decodedParameterText"])
                final_results.push(determineQuestionNumberTimeLabelEnding(duration[0], duration[1])) 
            } else if (result[1] === "GRAMATIKA") {
                if (result[2] === "RA≈†YBA") {
                    final_results.push(result[3])
                }

                if (result[0] === "3-4 KLASƒñ") {
                    if ("C62" in values[4] || "C63" in values[4] || "C65" in values[4]) {
                            final_results.push(result[4])
                        } 
                    } else {
                        final_results.push(result[5])
                    }
                final_results.push(determineQuestionNumberTimeLabelEnding(duration[0], duration[1])) 
            }
        }
    
    return final_results;
}

window.onload = function () {
    if (userData?.accType !== "admin") {
        window.location.href = getIndexPage();
    }
}

// TASK STORAGE FUNCTIONS
let storageChart = null;

async function loadTaskStorage() {
    const contentDiv = document.getElementById('task-storage-content');
    contentDiv.innerHTML = '<div class="loading">Loading storage information...</div>';

    try {
        // Load both archive stats and library stats
        const [archiveResponse, libraryResponse] = await Promise.all([
            apiFetch(`${apiBase}admin/task-archives/stats`),
            apiFetch(`${apiBase}admin/task-library/stats`)
        ]);
        
        if (!archiveResponse || !archiveResponse.ok) {
            throw new Error('Failed to load task storage stats');
        }
        
        if (!libraryResponse || !libraryResponse.ok) {
            throw new Error('Failed to load task library stats');
        }

        const archiveStats = await archiveResponse.json();
        const libraryStats = await libraryResponse.json();
        
        displayTaskStorage(archiveStats, libraryStats);
    } catch (error) {
        contentDiv.innerHTML = `<div class="message error">${error.message}</div>`;
    }
}

function displayTaskStorage(stats, libraryStats) {
    const contentDiv = document.getElementById('task-storage-content');
    
    if (stats.totalRecords === 0) {
        contentDiv.innerHTML = '<div class="message info">No task result archives found</div>';
        return;
    }
    
    const earliestDate = new Date(stats.earliestDate).toLocaleDateString();
    
    let html = `
        <div class="stats-grid">
            <div class="stat-card">
                <h3>üìä Storage Overview</h3>
                <div class="stat-items">
                    <div class="stat-item">
                        <span class="stat-label">Total Records:</span>
                        <span class="stat-value">${stats.totalRecords.toLocaleString()}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Earliest Record:</span>
                        <span class="stat-value">${earliestDate}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Estimated Size:</span>
                        <span class="stat-value">${stats.sizeInMB} MB (${stats.sizeInKB} KB)</span>
                    </div>
                </div>
            </div>
            
            <div class="stat-card">
                <h3>üìà Distribution Chart</h3>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="taskStorageChart"></canvas>
                </div>
                <small style="color: #666; display: block; margin-top: 5px;">
                    Percentage of all tasks recorder within no. of months counting from today.
                </small>
            </div>
        </div>
        
        <div class="user-card" style="margin-top: 20px;">
            <h3>üóëÔ∏è Cleanup Old Records</h3>
            <p style="color: #666; margin-bottom: 15px;">
                Delete task result archives older than the specified number of months.
            </p>
            <div class="inline-form">
                <div class="form-group">
                    <label for="months-to-keep">Months to Keep</label>
                    <input type="number" id="months-to-keep" placeholder="e.g., 12" min="1" value="12">
                </div>
                <button class="btn btn-danger" onclick="cleanupTaskArchives()">Delete Old Records</button>
            </div>
            <div id="cleanup-message"></div>
        </div>

        <div class="user-card" style="margin-top: 20px;">
            <h3>üìö Task Library Overview</h3>
            <p style="color: #666; margin-bottom: 15px;">
                Collection of different tasks in TaskLibrary database table for referencing by other tables.
            </p>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Library Statistics</h3>
                    <div class="stat-items">
                        <div class="stat-item">
                            <span class="stat-label">Total Tasks in Library:</span>
                            <span class="stat-value" id="total-library-tasks">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Unused Tasks:</span>
                            <span class="stat-value" id="unused-library-tasks">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn btn-danger" onclick="cleanupUnusedLibraryTasks()" style="margin-top: 15px;">Delete Unused Tasks</button>
            <div id="library-cleanup-message"></div>
        </div>
    `;
    
    contentDiv.innerHTML = html;

    contentDiv.innerHTML = html;
    
    // Update library stats in the UI AFTER the HTML is rendered
    document.getElementById('total-library-tasks').textContent = libraryStats.totalTasks.toLocaleString();
    document.getElementById('unused-library-tasks').textContent = `${libraryStats.unusedTasks.toLocaleString()} (${libraryStats.totalTasks === 0 ? 0 : Math.round((libraryStats.unusedTasks / libraryStats.totalTasks) * 100).toLocaleString()}%)`
    
    // Initialize chart
    setTimeout(() => initializeTaskStorageChart(stats.distribution), 100);
}

function initializeTaskStorageChart(distribution) {
    if (storageChart) {
        storageChart.destroy();
    }
    
    const ctx = document.getElementById('taskStorageChart').getContext('2d');
    
    const labels = distribution.map(d => `${d.months}`);
    const percentages = distribution.map(d => d.percentage);
    
    storageChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Records within period (%)',
                data: percentages,
                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: (value) => value + '%'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const dataPoint = distribution[context.dataIndex];
                            return [
                                `${dataPoint.percentage}% of all records`,
                                `${dataPoint.count.toLocaleString()} records`
                            ];
                        }
                    }
                }
            }
        }
    });
}

async function cleanupTaskArchives() {
    const monthsInput = document.getElementById('months-to-keep');
    const months = parseInt(monthsInput.value);
    
    if (!months || months < 1) {
        showMessage('cleanup-message', 'Please enter a valid number of months (minimum 1)', 'error');
        return;
    }
    
    if (!confirm(`Delete all task archives older than ${months} months?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await apiFetch(`${apiBase}admin/task-archives/cleanup`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ monthsToKeep: months })
        });
        
        if (!response || !response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Failed to cleanup task archives');
        }
        
        const data = await response.json();
        showMessage('cleanup-message', 
            `${data.message}<br>Deleted ${data.deletedCount.toLocaleString()} records<br>Keeping records from ${new Date(data.cutoffDate).toLocaleDateString()} onwards`, 
            'success'
        );
                
    } catch (error) {
        showMessage('cleanup-message', error.message, 'error');
    }
}

// Remove pet from all users
async function removePetFromAll() {
    const petId = document.getElementById('bulk-remove-pet-id').value.trim();
    const compensation = parseInt(document.getElementById('bulk-remove-pet-compensation').value) || 0;

    if (!petId) {
        showMessage('bulk-remove-pet-message', 'Please enter a pet ID', 'error');
        return;
    }

    let confirmMsg = `Remove pet "${petId}" from all users?\n\nThis will remove the pet even if it's the only pet a user has.`;
    if (compensation > 0) {
        confirmMsg += `\n\nCompensation: ${compensation} money per pet removed`;
    }

    if (!confirm(confirmMsg)) return;

    try {
        const response = await apiFetch(`${apiBase}admin/bulk/pet/${encodeURIComponent(petId)}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ compensation })
        });

        if (!response || !response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Failed to remove pet');
        }

        const data = await response.json();
        showMessage('bulk-remove-pet-message', 
            `${data.message}<br>Users affected: ${data.usersAffected}<br>Pets removed: ${data.petsRemoved}${data.totalCompensation > 0 ? `<br>Total compensation: ${data.totalCompensation}` : ''}`, 
            'success'
        );
        document.getElementById('bulk-remove-pet-id').value = '';
        document.getElementById('bulk-remove-pet-compensation').value = '';
    } catch (error) {
        showMessage('bulk-remove-pet-message', error.message, 'error');
    }
}

// Remove skin from all users
async function removeSkinFromAll() {
    const skinId = document.getElementById('bulk-remove-skin-id').value.trim();
    const compensation = parseInt(document.getElementById('bulk-remove-skin-compensation').value) || 0;
    const backupSkinId = document.getElementById('backup-skin-id').value.trim();
    const backupSkinIndex = document.getElementById('backup-skin-index').value.trim();

    if (!skinId) {
        showMessage('bulk-remove-skin-message', 'Please enter a skin ID', 'error');
        return;
    }

    const hasBackup = backupSkinId && backupSkinIndex;

    let confirmMsg = `Remove skin "${skinId}" from all pets across all users?`;
    if (hasBackup) {
        confirmMsg += `\n\nIf a pet is left with no skins, backup skin "${backupSkinId}" (index ${backupSkinIndex}) will be added.`;
    } else {
        confirmMsg += `\n\nWARNING: No backup skin provided. Pets may be left with no skins!`;
    }
    if (compensation > 0) {
        confirmMsg += `\n\nCompensation: ${compensation} money per skin removed`;
    }

    if (!confirm(confirmMsg)) return;

    try {
        const body = { compensation };
        if (hasBackup) {
            body.backupSkinId = backupSkinId;
            body.backupSkinIndex = parseInt(backupSkinIndex);
        }

        const response = await apiFetch(`${apiBase}admin/bulk/skin/${encodeURIComponent(skinId)}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (!response || !response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Failed to remove skin');
        }

        const data = await response.json();
        let message = `${data.message}<br>Users affected: ${data.usersAffected}<br>Skins removed: ${data.skinsRemoved}`;
        if (data.backupsAdded > 0) {
            message += `<br>Backup skins added: ${data.backupsAdded}`;
        }
        if (data.totalCompensation > 0) {
            message += `<br>Total compensation: ${data.totalCompensation}`;
        }
        
        showMessage('bulk-remove-skin-message', message, 'success');
        document.getElementById('bulk-remove-skin-id').value = '';
        document.getElementById('bulk-remove-skin-compensation').value = '';
        document.getElementById('backup-skin-id').value = '';
        document.getElementById('backup-skin-index').value = '';
    } catch (error) {
        showMessage('bulk-remove-skin-message', error.message, 'error');
    }
}

// Toggle pet action UI
document.addEventListener('DOMContentLoaded', function() {
    const petActionSelect = document.getElementById('pet-action');
    const skinActionSelect = document.getElementById('skin-action');
    
    if (petActionSelect) {
    petActionSelect.addEventListener('change', function() {
        const action = this.value;
        const nameGroup = document.getElementById('pet-name-group');
        const skinIdGroup = document.getElementById('pet-skin-id-group');
        const skinIndexGroup = document.getElementById('pet-skin-index-group');
        const compensationGroup = document.getElementById('pet-compensation-group');
        const btn = document.getElementById('bulk-pet-btn');
        
        if (action === 'add') {
            nameGroup.style.display = 'block';
            skinIdGroup.style.display = 'block';
            skinIndexGroup.style.display = 'block';
            compensationGroup.style.display = 'none';
            btn.textContent = 'Add Pet';
            btn.className = 'btn';
        } else {
            nameGroup.style.display = 'none';
            skinIdGroup.style.display = 'none';
            skinIndexGroup.style.display = 'none';
            compensationGroup.style.display = 'block';
            btn.textContent = 'Remove Pet';
            btn.className = 'btn btn-danger';
        }
    });
}
    
    if (skinActionSelect) {
        skinActionSelect.addEventListener('change', function() {
            const action = this.value;
            const targetPetGroup = document.getElementById('target-pet-group');
            const equippedGroup = document.getElementById('skin-equipped-group');
            const compensationGroup = document.getElementById('skin-compensation-group');
            const backupSection = document.getElementById('skin-backup-section');
            const btn = document.getElementById('bulk-skin-btn');
            
            if (action === 'add') {
                targetPetGroup.style.display = 'block';
                equippedGroup.style.display = 'block';
                compensationGroup.style.display = 'none';
                backupSection.style.display = 'none';
                btn.textContent = 'Add Skin';
                btn.className = 'btn';
            } else {
                targetPetGroup.style.display = 'none';
                equippedGroup.style.display = 'none';
                compensationGroup.style.display = 'block';
                backupSection.style.display = 'block';
                btn.textContent = 'Remove Skin';
                btn.className = 'btn btn-danger';
            }
        });
    }
});

// Manage pets for all users
async function managePetsForAll() {
    const action = document.getElementById('pet-action').value;
    const petId = document.getElementById('bulk-pet-id').value.trim();
    
    if (!petId) {
        showMessage('bulk-pet-message', 'Please enter a pet ID', 'error');
        return;
    }
    
    if (action === 'add') {
        await addPetToAll(petId);
    } else {
        await removePetFromAll(petId);
    }
}

// Add pet to all users
async function addPetToAll(petId) {
    const petName = document.getElementById('bulk-pet-name').value.trim();
    const defaultSkinId = document.getElementById('bulk-pet-skin-id').value.trim();
    const defaultSkinIndex = document.getElementById('bulk-pet-skin-index').value.trim();
    
    if (!petName) {
        showMessage('bulk-pet-message', 'Please enter a pet name', 'error');
        return;
    }
    
    if (!defaultSkinId || !defaultSkinIndex) {
        showMessage('bulk-pet-message', 'Please enter default skin ID and index', 'error');
        return;
    }
    
    if (!confirm(`Add pet "${petId}" (${petName}) with default skin "${defaultSkinId}" to all students?`)) return;
    
    try {
        const response = await apiFetch(`${apiBase}admin/bulk/pet`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                petId, 
                petName,
                defaultSkinId,
                defaultSkinIndex: parseInt(defaultSkinIndex)
            })
        });
        
        if (!response || !response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Failed to add pet');
        }
        
        const data = await response.json();
        let message = `${data.message}<br>Users affected: ${data.usersAffected}<br>Pets added: ${data.petsAdded}`;
        if (data.skippedDuplicates > 0) {
            message += `<br>Skipped (already existed): ${data.skippedDuplicates}`;
        }
        
        showMessage('bulk-pet-message', message, 'success');
        document.getElementById('bulk-pet-id').value = '';
        document.getElementById('bulk-pet-name').value = '';
        document.getElementById('bulk-pet-skin-id').value = '';
        document.getElementById('bulk-pet-skin-index').value = '';
    } catch (error) {
        showMessage('bulk-pet-message', error.message, 'error');
    }
}

// Remove pet from all users
async function removePetFromAll(petId) {
    const compensation = parseInt(document.getElementById('bulk-pet-compensation').value) || 0;
    
    let confirmMsg = `Remove pet "${petId}" from all users?\n\nThis will remove the pet even if it's the only pet a user has.`;
    if (compensation > 0) {
        confirmMsg += `\n\nCompensation: ${compensation} money per pet removed`;
    }
    
    if (!confirm(confirmMsg)) return;
    
    try {
        const response = await apiFetch(`${apiBase}admin/bulk/pet/${encodeURIComponent(petId)}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ compensation })
        });
        
        if (!response || !response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Failed to remove pet');
        }
        
        const data = await response.json();
        showMessage('bulk-pet-message', 
            `${data.message}<br>Users affected: ${data.usersAffected}<br>Pets removed: ${data.petsRemoved}${data.totalCompensation > 0 ? `<br>Total compensation: ${data.totalCompensation}` : ''}`, 
            'success'
        );
        document.getElementById('bulk-pet-id').value = '';
        document.getElementById('bulk-pet-compensation').value = '';
    } catch (error) {
        showMessage('bulk-pet-message', error.message, 'error');
    }
}

// Manage skins for all users
async function manageSkinsForAll() {
    const action = document.getElementById('skin-action').value;
    const skinId = document.getElementById('bulk-skin-id').value.trim();
    const skinIndex = document.getElementById('bulk-skin-index').value.trim();
    
    if (!skinId || !skinIndex) {
        showMessage('bulk-skin-message', 'Please enter skin ID and index', 'error');
        return;
    }
    
    if (action === 'add') {
        await addSkinToAll(skinId, skinIndex);
    } else {
        await removeSkinFromAll(skinId);
    }
}

// Add skin to all users
async function addSkinToAll(skinId, skinIndex) {
    const targetPetId = document.getElementById('bulk-target-pet-id').value.trim();
    const equipped = document.getElementById('bulk-skin-equipped').checked;
    
    if (!targetPetId) {
        showMessage('bulk-skin-message', 'Please enter target pet ID', 'error');
        return;
    }
    
    if (!confirm(`Add skin "${skinId}" to all pets with ID "${targetPetId}"?`)) return;
    
    try {
        const response = await apiFetch(`${apiBase}admin/bulk/skin`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                targetPetId, 
                skinId, 
                skinIndex: parseInt(skinIndex), 
                equipped 
            })
        });
        
        if (!response || !response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Failed to add skin');
        }
        
        const data = await response.json();
        let message = `${data.message}<br>Users affected: ${data.usersAffected}<br>Skins added: ${data.skinsAdded}`;
        if (data.skippedDuplicates > 0) {
            message += `<br>Skipped (already existed): ${data.skippedDuplicates}`;
        }
        if (data.petsNotFound > 0) {
            message += `<br>Users without target pet: ${data.petsNotFound}`;
        }
        
        showMessage('bulk-skin-message', message, 'success');
        document.getElementById('bulk-target-pet-id').value = '';
        document.getElementById('bulk-skin-id').value = '';
        document.getElementById('bulk-skin-index').value = '';
        document.getElementById('bulk-skin-equipped').checked = false;
    } catch (error) {
        showMessage('bulk-skin-message', error.message, 'error');
    }
}

// Remove skin from all users
async function removeSkinFromAll(skinId) {
    const compensation = parseInt(document.getElementById('bulk-skin-compensation').value) || 0;
    const backupSkinId = document.getElementById('backup-skin-id').value.trim();
    const backupSkinIndex = document.getElementById('backup-skin-index').value.trim();
    
    const hasBackup = backupSkinId && backupSkinIndex;
    
    let confirmMsg = `Remove skin "${skinId}" from all pets across all users?`;
    if (hasBackup) {
        confirmMsg += `\n\nIf a pet is left with no skins, backup skin "${backupSkinId}" (index ${backupSkinIndex}) will be added.`;
    } else {
        confirmMsg += `\n\nWARNING: No backup skin provided. Pets may be left with no skins!`;
    }
    if (compensation > 0) {
        confirmMsg += `\n\nCompensation: ${compensation} money per skin removed`;
    }
    
    if (!confirm(confirmMsg)) return;
    
    try {
        const body = { compensation };
        if (hasBackup) {
            body.backupSkinId = backupSkinId;
            body.backupSkinIndex = parseInt(backupSkinIndex);
        }
        
        const response = await apiFetch(`${apiBase}admin/bulk/skin/${encodeURIComponent(skinId)}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        
        if (!response || !response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Failed to remove skin');
        }
        
        const data = await response.json();
        let message = `${data.message}<br>Users affected: ${data.usersAffected}<br>Skins removed: ${data.skinsRemoved}`;
        if (data.backupsAdded > 0) {
            message += `<br>Backup skins added: ${data.backupsAdded}`;
        }
        if (data.totalCompensation > 0) {
            message += `<br>Total compensation: ${data.totalCompensation}`;
        }
        
        showMessage('bulk-skin-message', message, 'success');
        document.getElementById('bulk-skin-id').value = '';
        document.getElementById('bulk-skin-index').value = '';
        document.getElementById('bulk-skin-compensation').value = '';
        document.getElementById('backup-skin-id').value = '';
        document.getElementById('backup-skin-index').value = '';
    } catch (error) {
        showMessage('bulk-skin-message', error.message, 'error');
    }
}

// Add to the DOMContentLoaded event listener (find it and add these inside):
const itemActionSelect = document.getElementById('item-action');
const consumableActionSelect = document.getElementById('consumable-action');

if (itemActionSelect) {
    itemActionSelect.addEventListener('change', function() {
        const action = this.value;
        const coordsGroup = document.getElementById('item-coords-group');
        const compensationGroup = document.getElementById('item-compensation-group');
        const btn = document.getElementById('bulk-item-btn');
        
        if (action === 'add') {
            coordsGroup.style.display = 'block';
            compensationGroup.style.display = 'none';
            btn.textContent = 'Add Item';
            btn.className = 'btn';
        } else {
            coordsGroup.style.display = 'none';
            compensationGroup.style.display = 'block';
            btn.textContent = 'Remove Item';
            btn.className = 'btn btn-danger';
        }
    });
}

if (consumableActionSelect) {
    consumableActionSelect.addEventListener('change', function() {
        const action = this.value;
        const qtyGroup = document.getElementById('consumable-qty-group');
        const compensationGroup = document.getElementById('consumable-compensation-group');
        const btn = document.getElementById('bulk-consumable-btn');
        
        if (action === 'add') {
            qtyGroup.style.display = 'block';
            compensationGroup.style.display = 'none';
            btn.textContent = 'Add Consumable';
            btn.className = 'btn';
        } else {
            qtyGroup.style.display = 'none';
            compensationGroup.style.display = 'block';
            btn.textContent = 'Remove Consumable';
            btn.className = 'btn btn-danger';
        }
    });
}

// Manage items for all users
async function manageItemsForAll() {
    const action = document.getElementById('item-action').value;
    const itemId = parseInt(document.getElementById('bulk-item-id').value);
    
    if (isNaN(itemId)) {
        showMessage('bulk-item-message', 'Please enter a valid item ID', 'error');
        return;
    }
    
    if (action === 'add') {
        await addItemToAll(itemId);
    } else {
        await removeItemFromAll(itemId);
    }
}

// Add item to all users (previously sendGift)
async function addItemToAll(itemId) {
    const coordsInput = document.getElementById('bulk-item-coords').value.trim();
    
    let coordinates = [];
    if (coordsInput) {
        const parts = coordsInput.split(',').map(x => parseInt(x.trim()));
        if (parts.length === 2 && !parts.some(isNaN)) {
            coordinates = parts;
        } else {
            showMessage('bulk-item-message', 'Invalid coordinates format. Use X,Y or leave empty', 'error');
            return;
        }
    }
    
    if (!confirm(`Add item ${itemId} to all users?`)) return;
    
    try {
        const response = await apiFetch(`${apiBase}admin/gift`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ itemId, coordinates })
        });
        
        if (!response || !response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Failed to add item');
        }
        
        const data = await response.json();
        showMessage('bulk-item-message', 
            `${data.message}<br>Updated ${data.updatedCount} users`, 
            'success'
        );
        document.getElementById('bulk-item-id').value = '';
        document.getElementById('bulk-item-coords').value = '';
    } catch (error) {
        showMessage('bulk-item-message', error.message, 'error');
    }
}

// Remove item from all users (updated to use new element IDs)
async function removeItemFromAll(itemId) {
    const compensation = parseInt(document.getElementById('bulk-item-compensation').value) || 0;
    
    let confirmMsg = `Remove all instances of item ${itemId} from all users?`;
    if (compensation > 0) {
        confirmMsg += `\n\nCompensation: ${compensation} money per item removed`;
    }
    
    if (!confirm(confirmMsg)) return;
    
    try {
        const response = await apiFetch(`${apiBase}admin/remove-item/${itemId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ compensation })
        });
        
        if (!response || !response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Failed to remove item');
        }
        
        const data = await response.json();
        showMessage('bulk-item-message', 
            `${data.message}<br>Users affected: ${data.usersAffected}<br>Items removed: ${data.itemsRemoved}${data.totalCompensation > 0 ? `<br>Total compensation: ${data.totalCompensation}` : ''}`, 
            'success'
        );
        document.getElementById('bulk-item-id').value = '';
        document.getElementById('bulk-item-compensation').value = '';
    } catch (error) {
        showMessage('bulk-item-message', error.message, 'error');
    }
}

// Manage consumables for all users
async function manageConsumablesForAll() {
    const action = document.getElementById('consumable-action').value;
    const itemId = parseInt(document.getElementById('bulk-consumable-item-id').value);
    
    if (isNaN(itemId)) {
        showMessage('bulk-consumable-item-message', 'Please enter a valid item ID', 'error');
        return;
    }
    
    if (action === 'add') {
        await addConsumableToAllUsers(itemId);
    } else {
        await removeConsumableFromAllUsers(itemId);
    }
}

// Add consumable to all users (updated to use new element IDs)
async function addConsumableToAllUsers(itemId) {
    const quantity = parseInt(document.getElementById('bulk-consumable-item-qty').value);
    
    if (isNaN(quantity) || quantity < 1) {
        showMessage('bulk-consumable-item-message', 'Please enter a valid quantity', 'error');
        return;
    }
    
    if (!confirm(`Add consumable ${itemId} (qty: ${quantity}) to all users?`)) return;
    
    try {
        const response = await apiFetch(`${apiBase}admin/bulk/consumable`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ itemId, quantity })
        });
        
        if (!response || !response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Failed to add consumable');
        }
        
        const data = await response.json();
        showMessage('bulk-consumable-item-message', 
            `${data.message}<br>Updated ${data.updatedCount} users`, 
            'success'
        );
        document.getElementById('bulk-consumable-item-id').value = '';
        document.getElementById('bulk-consumable-item-qty').value = '1';
    } catch (error) {
        showMessage('bulk-consumable-item-message', error.message, 'error');
    }
}

// Remove consumable from all users (updated to use new element IDs)
async function removeConsumableFromAllUsers(itemId) {
    const compensation = parseInt(document.getElementById('bulk-consumable-item-compensation').value) || 0;
    
    let confirmMsg = `Remove consumable ${itemId} from all users?`;
    if (compensation > 0) {
        confirmMsg += `\n\nCompensation: ${compensation} money per item removed`;
    }
    
    if (!confirm(confirmMsg)) return;
    
    try {
        const response = await apiFetch(`${apiBase}admin/bulk/consumable/${itemId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ compensation })
        });
        
        if (!response || !response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Failed to remove consumable');
        }
        
        const data = await response.json();
        showMessage('bulk-consumable-item-message', 
            `${data.message}<br>Users affected: ${data.usersAffected}${data.totalCompensation > 0 ? `<br>Total items removed: ${data.totalItemsRemoved}<br>Total compensation: ${data.totalCompensation}` : ''}`, 
            'success'
        );
        document.getElementById('bulk-consumable-item-id').value = '';
        document.getElementById('bulk-consumable-item-compensation').value = '';
    } catch (error) {
        showMessage('bulk-consumable-item-message', error.message, 'error');
    }
}

// Cleanup unused library tasks
async function cleanupUnusedLibraryTasks() {
    try {
        // First get the count
        const statsResponse = await apiFetch(`${apiBase}admin/task-library/stats`);
        if (!statsResponse || !statsResponse.ok) {
            throw new Error('Failed to fetch library stats');
        }
        
        const stats = await statsResponse.json();
        
        if (stats.unusedTasks === 0) {
            showMessage('library-cleanup-message', 'No unused tasks to delete', 'info');
            return;
        }
        
        if (!confirm(`Delete ${stats.unusedTasks} unused task(s) from the Task Library?\n\nThis action cannot be undone.`)) {
            return;
        }
        
        const response = await apiFetch(`${apiBase}admin/task-library/cleanup`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response || !response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Failed to cleanup task library');
        }
        
        const data = await response.json();
        showMessage('library-cleanup-message', 
            `${data.message}<br>Deleted ${data.deletedCount.toLocaleString()} unused tasks`, 
            'success'
        );
        
        // Reload the task storage tab to update stats
        setTimeout(() => loadTaskStorage(), 1500);
        
    } catch (error) {
        showMessage('library-cleanup-message', error.message, 'error');
    }
}

    </script>
</body>
</html>