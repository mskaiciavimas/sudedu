<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>sudEdu duomenų bazė</title>
  <link rel="stylesheet" type="text/css" href="../../index.css">

  <style>
    * {
      box-sizing: border-box;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    html {
      display: flex;
      justify-content: center;
      align-items: center;
      background-image: linear-gradient(to top, #ffbf9c, #ffbf92, #ffbf89, #ffbf7e, #ffc074);
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    body {
      margin: 0;
      font-family: 'SFpro', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 12px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(6px);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(6px);
      border-radius: 10px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      background-clip: content-box;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.6);
    }

    * {
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.4) transparent;
    }

    /* Login modal styles */
    #login-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #login-modal > div {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 40px;
      border-radius: 20px;
      width: 450px;
      max-width: 90%;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.2);
    }

    #login-modal h2 {
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
      color: #333;
    }

    #login-modal p {
      margin-bottom: 20px;
      text-align: center;
      color: #666;
    }

    #login-message {
      margin-bottom: 15px;
      color: #e74c3c;
      text-align: center;
      display: none;
      padding: 10px;
      background: rgba(231, 76, 60, 0.1);
      border-radius: 8px;
    }

    #login-password {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 15px;
      font-size: 16px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.8);
      transition: border-color 0.3s;
    }

    #login-password:focus {
      outline: none;
      border-color: #3288AC;
    }

    #login-submit {
      width: 100%;
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      background: linear-gradient(135deg, #3288AC, #286D8A);
      color: white;
      font-size: 16px;
      font-weight: 500;
      transition: transform 0.2s;
    }

    #login-submit:hover {
      transform: translateY(-2px);
    }

    #login-spinner {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }

    /* Main container */
    #main-app {
      width: 100%;
      height: 100%;
      display: none;
      overflow: hidden;
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
      gap: 20px;
      padding: 20px;
    }

    /* Left sidebar - text list */
    .text-list-sidebar {
      display: flex;
      flex-direction: column;
      gap: 15px;
      height: 100%;
    }

    .new-entry-button {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 500;
      margin: 0;
      background: linear-gradient(135deg, #A0C58F, #32ac93);
      border: none;
      color: #F5F5F7;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(50, 172, 147, 0.3);
    }

    .new-entry-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(50, 172, 147, 0.4);
    }

    .search-container {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      padding: 12px 16px;
    }

    .search-input {
      width: 100%;
      border: none;
      background: transparent;
      font-size: 1rem;
      color: #333;
      outline: none;
    }

    .search-input::placeholder {
      color: rgba(0, 0, 0, 0.4);
    }

    /* Filter section */
    .filter-wrapper {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      overflow: hidden;
    }

    .filter-header {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      user-select: none;
      transition: background 0.2s;
    }

    .filter-header:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .filter-icon {
      transition: transform 0.3s;
      display: flex;
    }

    .filter-icon.collapsed {
      transform: rotate(-180deg);
    }

    .filter-icon svg {
      width: 24px;
      height: 24px;
    }

    .filter-content {
      max-height: 400px;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out;
      padding: 0 16px 16px;
    }

    .filter-content.collapsed {
      max-height: 0;
      padding: 0 16px;
    }

    .filter-group {
      margin-bottom: 15px;
    }

    .filter-group:last-child {
      margin-bottom: 0;
    }

    label {
      font-size: 1rem !important;
    }

    .filter-label {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #4a4a4a;
    }

    .filter-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .filter-chip {
      padding: 6px 12px;
      border: 1px solid rgba(0, 0, 0, 0.2);
      background: rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      user-select: none;
    }

    .filter-chip:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    .filter-chip.active {
      background: linear-gradient(135deg, #3288AC, #286D8A);
      color: white;
      border-color: transparent;
    }

    .entries-list-container {
      flex: 1;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 20px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .entries-list-header {
      background: rgba(255, 255, 255, 0.2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      padding: 15px;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.95rem;
    }

    .entries-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .entry-item {
      padding: 12px 15px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .entry-item:hover {
      background: rgba(255, 255, 255, 0.5);
      transform: translateX(4px);
    }

    .entry-item.selected {
      background: linear-gradient(135deg, rgba(50, 136, 172, 0.3), rgba(40, 109, 138, 0.3));
      border-left: 4px solid #3288AC;
      font-weight: 600;
    }

    .entry-id {
      font-weight: 600;
      color: #3288AC;
      min-width: 40px;
    }

    .entry-title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Right form section */
    .form-section {
      flex: 1 1 60%;
      display: flex;
      flex-direction: column;
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .header-buttons {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      position: relative;
      padding: 10px 16px;
      border-radius: 16px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      border: none;
      background: linear-gradient(135deg, #3288AC, #286D8A);
      color: #F5F5F7;
      transition: all 0.3s;
    }

    .action-btn:hover:not(:disabled) {
      transform: translateY(-2px);
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .action-btn.success {
      background: linear-gradient(135deg, #A0C58F, #32ac93);
    }

    .action-btn.danger {
      background: linear-gradient(135deg, #ff8073, #e74c3c);
    }

    .action-btn.secondary {
      background: rgba(255, 255, 255, 0.3);
      color: #333;
    }

    .message-container {
      min-height: 50px;
    }

    .message-field {
      padding: 12px 16px;
      border-radius: 12px;
      display: none;
      text-align: center;
      font-weight: 500;
    }

    .message-field.success {
      background-color: rgba(160, 197, 143, 0.2);
      color: #32ac93;
      border: 1px solid #32ac93;
    }

    .message-field.error {
      background-color: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
      border: 1px solid #e74c3c;
    }

    .message-field.info {
      background-color: rgba(50, 136, 172, 0.2);
      color: #3288AC;
      border: 1px solid #3288AC;
    }

    #suitable-for-options,
    #class-options {
      flex-direction: column;
    }

    #class-options .checkbox-item {
      padding: 14px 12px;
    }

    .form-content {
      flex: 1;
      overflow-y: auto;
      padding-right: 10px;
    }

    .form-content.edit-mode {
      background: rgba(241, 180, 106, 0.1);
      border-radius: 20px;
      padding: 20px;
    }

    textarea {
      font-family: 'SFpro', sans-serif !important;
    }

    .form-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 30px;
      color: #333;
      font-family: 'SFpro', sans-serif !important;
      font-weight: 700;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      color: #333;
      text-transform: uppercase;
    }

    .difficulty-level {
      padding: 6px 8px !important;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s;
      resize: vertical;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: #3288AC;
      background: rgba(255, 255, 255, 0.6);
    }

    .form-input:disabled,
    .form-textarea:disabled,
    .form-select:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .single-line-input {
      min-height: 44px;
      height: 44px;
      resize: none;
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .checkbox-item:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .checkbox-item input[type="checkbox"],
    .checkbox-item input[type="radio"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      margin: 0;
    }

    .checkbox-item label {
      cursor: pointer;
      margin: 0;
      user-select: none;
    }

    .option-with-select {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .option-with-select select {
      width: auto;
      min-width: 100px;
    }

    .input-with-button {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .input-with-button input {
      flex: 1;
    }

    .input-with-button button {
      white-space: nowrap;
    }

    .text-section {
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
    }

    .text-section-title {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 12px;
      color: #333;
    }

    .text-add-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
      margin-bottom: 12px;
    }

    .no-split-checkbox {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      background: rgba(255, 152, 0, 0.2);
      border: 2px solid #ff9800;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .no-split-checkbox input {
      width: auto;
      margin: 0;
    }

    .no-split-checkbox label {
      margin: 0;
      cursor: pointer;
    }

    #start-no-split,
    #middle-no-split,
    #end-no-split {
      cursor: pointer;
    }

    .text-list {
      min-height: 60px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .text-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: rgba(50, 136, 172, 0.2);
      border: 1px solid rgba(50, 136, 172, 0.3);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      max-width: 100%;
      word-break: break-word;
    }

    .text-chip:hover {
      background: rgba(50, 136, 172, 0.3);
      transform: translateY(-2px);
    }

    .no-split-indicator {
      display: inline-block;
      background-color: #ff9800;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: bold;
      margin-left: 4px;
    }

    .save-button {
      margin-top: 20px;
      padding: 14px 24px;
      font-size: 1.1rem;
    }

    .header-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 15px;
}

    /* Sidebar content */
.sidebar-wrapper {
    position: static;
    flex: 1 1 25%;
    height: 100%;
    z-index: 100;
    transition: transform 0.3s ease;
    padding-left: 0;
    z-index: 9000;
}

.sidebar {
    position: static;
    width: 100%;
    padding: 0;
    height: 100%;
    margin: 0;
    z-index: 10;
}

.sidebar-wrapper.open {
    transform: translateX(-10px) !important;
}

.sidebar-wrapper.open .toggle-tab svg {
    transform: rotate(180deg);
}

.sidebar-content {
    min-height: 100%;
    width: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100%;
}

#dynamic-content,
.edit-mode-object-sidebar {
    height: 100%;
    overflow: hidden;
}

.edit-mode-object-sidebar {
    display: flex;
    flex-direction: column;
}

.object-sidebar-assets {
    flex: 1 1 auto;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.object-sidebar-categories-dropdown-holder {
    margin-bottom: 15px;
    flex: 0 1 auto;
}

/* Toggle tab - always visible */
.toggle-tab {
    position: absolute;
    right: -34px;
    top: 0;
    border: none;
    width: 34px;
    height: 62px;
    border-radius: 0 20px 20px 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    -webkit-backdrop-filter: blur(15px);
    backdrop-filter: blur(15px);
    background: rgba(255, 255, 255, 0.5);
    padding: 0;
    margin: 0;
}

.toggle-tab svg {
    width: 24px;
    height: 24px;
    transition: transform 0.3s ease;
}

@media (min-width: 769px) {
    .toggle-tab {
        display: none;
    }
}

    @media (max-width: 768px) {
      .sidebar-wrapper {
        position: absolute;
        top: 95px;
        height: calc(100vh - 20px);
        width: calc(100vw - 35px);
        transform: translateX(calc(-100vw + 25px));
        border-bottom-right-radius: 8px;
        top: 10px;
    }

    .sidebar-wrapper.container-expanded {
        top: 5px;
        height: calc(100% - 20px);
        width: calc(100vw - 35px - 5px);
        transform: translateX(calc(-100vw + 35px));
        border-bottom-right-radius: 8px;
        margin: 0;
        margin-top: 0;
    }

    .sidebar {
        padding: 16px;
        height: 100%;
        border-bottom-right-radius: 8px;
        margin: 0;
        margin-top: 0;
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        background: rgba(255, 255, 255, 0.5);
    }


      .app-container {
        padding: 10px;
        gap: 10px;
      }

      .form-title {
        font-size: 1.5rem;
      }

      .header-buttons {
        width: 100%;
      }

      .action-btn {
        width: 100%;
      }

        .form-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .header-buttons {
        width: 100%;
      }
      
      .action-btn {
        flex: 1;
      }
    }
  </style>
</head>
<body>

<div id="login-modal" style="display: none;">
  <div>
    <h2>sudEdu tekstų duomenų bazė</h2>
    <p>Įveskite slaptažodį</p>
    
    <div id="login-message"></div>
    
    <input type="password" id="login-password" placeholder="Slaptažodis">
    
    <button id="login-submit">Prisijungti</button>
    
    <div id="login-spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Kraunama...</span>
      </div>
      <span>Tikrinamas slaptažodis...</span>
    </div>
  </div>
</div>

<div id="main-app">
  <div class="app-container">
  <div class="sidebar-wrapper" id="sidebarWrapper">
  <aside class="sidebar" id="sidebar">
      <div class="sidebar-content" id="sidebarContent">

    <!-- Left Sidebar -->
    <div class="text-list-sidebar">
      <button id="new-entry-btn" class="new-entry-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        <span>Naujas įrašas</span>
      </button>

      <div class="search-container">
        <input type="text" id="search-bar" class="search-input" placeholder="Ieškoti pagal ID, pavadinimą, autorių...">
      </div>

      <!-- Filter Section -->
      <div class="filter-wrapper">
        <div class="filter-header" id="filter-header">
          <span>Filtrai</span>
          <div class="filter-icon" id="filter-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
              <path d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"/>
            </svg>
          </div>
        </div>
        <div class="filter-content collapsed" id="filter-content">
          <div class="filter-group" id="class-filter-group">
            <div class="filter-label">Klasės</div>
            <div class="filter-options" id="class-filters"></div>
          </div>
          <div class="filter-group">
            <div class="filter-label">Užduoties tipas</div>
            <div class="filter-options" id="type-filters"></div>
          </div>
          <div class="filter-group" id="difficulty-filter-group" style="display: none;">
            <div class="filter-label">Sudėtingumas</div>
            <div class="filter-options" id="difficulty-filters"></div>
          </div>
        </div>
      </div>

      <div class="entries-list-container">
        <div class="entries-list-header">
          Tekstai (<span id="entry-count">0</span>)
        </div>
        <div class="entries-list" id="database-entries"></div>
      </div>
    </div>

    </aside>
        <button class="toggle-tab" id="toggleTab" aria-label="Toggle sidebar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M9 18l6-6-6-6"/>
            </svg>
        </button>
    </div>

    <!-- Right Form Section -->
    <div class="form-section">
      <div class="form-header">
        <div class="header-buttons">
          <button class="action-btn success" id="edit-toggle-btn" disabled>Redaguoti</button>
          <button id="save-btn" class="action-btn success" onclick="saveEntry()" disabled>Išsaugoti tekstą</button>
          <button class="action-btn danger" id="delete-btn" disabled>Ištrinti</button>
        </div>
        <div class="header-buttons">
          <button class="action-btn secondary" onclick="downloadDatabaseInJsonFormat()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            JSON
          </button>
          <button class="action-btn secondary" onclick="downloadExcelSummary()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Excel
          </button>
        </div>
      </div>

      <div class="message-container">
        <div id="message-field" class="message-field"></div>
      </div>

      <div class="form-content" id="form-content">
        <h1 class="form-title">SudEdu Tekstų Pridėjimas</h1>

        <div class="form-group">
          <label class="form-label">Pavadinimas</label>
          <textarea class="form-input single-line-input" id="title" placeholder="Įveskite pavadinimą" disabled></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Autorius</label>
          <textarea class="form-input single-line-input" id="author" placeholder="Įveskite autorių" disabled></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Šaltinis</label>
          <textarea class="form-input single-line-input" id="reference" placeholder="Įveskite šaltinį" disabled></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Teksto tipas</label>
          <div class="checkbox-group" id="type-options"></div>
          <div class="input-with-button">
            <input type="text" class="form-input" id="new-type" placeholder="Naujas tipas" disabled>
            <button class="action-btn" id="new-type-btn" onclick="addOption('type')" disabled>Pridėti</button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Užduočių suderinamumas</label>
          <div class="checkbox-group" id="suitable-for-options"></div>
          <div class="input-with-button">
            <input type="text" class="form-input" id="new-suitable-for" placeholder="Nauja užduotis" disabled>
            <button class="action-btn" id="new-suitable-for-btn" onclick="addOption('suitable-for')" disabled>Pridėti</button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Klasėms</label>
          <div class="checkbox-group" id="class-options"></div>
        </div>

        <div class="text-section">
          <div class="text-section-title">Pradžia</div>
          <textarea class="form-textarea" id="start-text" placeholder="Įveskite pradžią" rows="3" disabled></textarea>
          <div class="text-add-controls">
            <button class="action-btn" onclick="addText('start')" disabled>Pridėti</button>
            <div class="no-split-checkbox">
              <input type="checkbox" id="start-no-split" disabled>
              <label for="start-no-split">⚠️ Nedalomi sakiniai</label>
            </div>
          </div>
          <div class="text-list" id="start-list"></div>
        </div>

        <div class="text-section">
          <div class="text-section-title">Įvykių raida</div>
          <textarea class="form-textarea" id="middle-text" placeholder="Įveskite įvykių raidą" rows="3" disabled></textarea>
          <div class="text-add-controls">
            <button class="action-btn" onclick="addText('middle')" disabled>Pridėti</button>
            <div class="no-split-checkbox">
              <input type="checkbox" id="middle-no-split" disabled>
              <label for="middle-no-split">⚠️ Nedalomi sakiniai</label>
            </div>
          </div>
          <div class="text-list" id="middle-list"></div>
        </div>

        <div class="text-section">
          <div class="text-section-title">Pabaiga</div>
          <textarea class="form-textarea" id="end-text" placeholder="Įveskite pabaigą" rows="3" disabled></textarea>
          <div class="text-add-controls">
            <button class="action-btn" onclick="addText('end')" disabled>Pridėti</button>
            <div class="no-split-checkbox">
              <input type="checkbox" id="end-no-split" disabled>
              <label for="end-no-split">⚠️ Nedalomi sakiniai</label>
            </div>
          </div>
          <div class="text-list" id="end-list"></div>
        </div>

        <div class="text-section">
          <div class="text-section-title">Distraktorius</div>
          <textarea class="form-textarea" id="distractor-text" placeholder="Įveskite distraktorių" rows="3" disabled></textarea>
          <div class="text-add-controls">
            <button class="action-btn" onclick="addText('distractor')" disabled>Pridėti</button>
            <div class="no-split-checkbox">
              <input type="checkbox" id="distractor-no-split" disabled>
              <label for="distractor-no-split">⚠️ Nedalomi sakiniai</label>
</div>
</div>
<div class="text-list" id="distractor-list"></div>
</div>
  </div>
</div>
  </div>
</div>
<script>
const apiBase = 'https://sudedu-text-database-server.onrender.com/';
const messageField = document.querySelector("#message-field");
const NO_SPLIT_MARKER = '\uE000';
let database = {};
const textSections = { start: [], middle: [], end: [], distractor: [] };
let editIndex = null;
let isEditMode = false;
let currentEntryId = null;
let isAuthenticated = false;
let allOptions = { types: [], SF: [], classes: [] };
let selectedTypeFilter = new Set();
let selectedDifficultyFilters = new Set();
let selectedClassFilters = new Set();

const AUTH_TOKEN_KEY = 'sudEduAuthToken';

const codeDecoder = {
  "C50": "RAŠYBA",
  "C51": "TURINIO KOMPONAVIMAS",
  "C52": "STRUKTŪROS IŠDĖSTYMAS",
  "C58": "LENGVAS",
  "C59": "VIDUTINIS",
  "C60": "SUNKUS",
  "C75": "1-2 KLASĖ",
  "C76": "3-4 KLASĖ"
};

function decodeText(code) {
  return codeDecoder[code] || code;
}

// Auth functions
function getAuthToken() {
  return localStorage.getItem(AUTH_TOKEN_KEY);
}

function setAuthToken(token) {
  localStorage.setItem(AUTH_TOKEN_KEY, token);
}

function removeAuthToken() {
  localStorage.removeItem(AUTH_TOKEN_KEY);
}

function addNoSplitMarkers(text) {
  // Trim trailing whitespace/invisible chars to find the last tandem
  const trimmedText = text.replace(/[\s\u200B-\u200D\uFEFF]*$/gu, '');

  // Regex to match sentence-ending tandems with optional quotes and spaces
  const tandemPattern = /[\s]*["'`„“”«»]*[\s]*[.!?]+[\s]*["'`„“”«»]*/gu;

  // Find all tandems
  const tandems = [...trimmedText.matchAll(tandemPattern)];
  if (tandems.length === 0) return text;

  // Find last tandem that is truly at the end (ignoring whitespace)
  let lastTandemIndex = tandems.length - 1;
  while (lastTandemIndex >= 0) {
    const match = tandems[lastTandemIndex];
    const afterMatch = trimmedText.slice(match.index + match[0].length).trim();
    if (afterMatch === '') break; // Nothing meaningful after, this is the last tandem
    lastTandemIndex--;
  }

  // Insert markers for all tandems except the last meaningful one
  let indexOffset = 0;
  let result = trimmedText;

  tandems.forEach((match, i) => {
    if (i === lastTandemIndex) return; // Skip last meaningful tandem

    const offset = match.index + indexOffset;
    const tandemText = match[0];

    // Insert marker after the tandem
    result = result.slice(0, offset + tandemText.length) + NO_SPLIT_MARKER + result.slice(offset + tandemText.length);

    indexOffset += NO_SPLIT_MARKER.length;
  });

  // Append any trailing characters trimmed initially
  const trailing = text.slice(trimmedText.length);
  return result + trailing;
}

function removeNoSplitMarkers(text) {
  return text.replace(new RegExp(NO_SPLIT_MARKER, 'g'), '');
}

function hasNoSplitMarkers(text) {
  return text.includes(NO_SPLIT_MARKER);
}

// API request wrapper
async function makeAuthenticatedRequest(url, options = {}) {
  if (!isAuthenticated) {
    showLoginModal();
    throw new Error('Reikia prisijungti');
  }
  
  const token = getAuthToken();
  if (!token) {
    showLoginModal();
    throw new Error('Reikia prisijungti');
  }

  const headers = {
    ...options.headers,
    'Authorization': token
  };

  const response = await fetch(url, {
    ...options,
    headers
  });

  if (response.status === 401 || response.status === 403) {
    isAuthenticated = false;
    removeAuthToken();
    showLoginModal();
    throw new Error('Sesija pasibaigė. Prisijunkite iš naujo.');
  }

  return response;
}

// Login handling
async function handleLogin(password) {
  const loginSubmit = document.getElementById('login-submit');
  const loginSpinner = document.getElementById('login-spinner');
  const loginMessage = document.getElementById('login-message');
  
  loginSubmit.style.display = 'none';
  loginSpinner.style.display = 'flex';
  loginMessage.style.display = 'none';
  
  try {
    const response = await fetch(`${apiBase}auth/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ password })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.message || 'Prisijungimo klaida');
    }
    
    isAuthenticated = true;
    setAuthToken(data.token);
    hideLoginModal();
    showMainApp();
    
    initializeData();
  } catch (error) {
    console.error('Login error:', error);
    loginMessage.textContent = error.message || 'Prisijungimo klaida. Bandykite dar kartą.';
    loginMessage.style.display = 'block';
  } finally {
    loginSubmit.style.display = 'block';
    loginSpinner.style.display = 'none';
  }
}

function showLoginModal() {
  document.getElementById('login-modal').style.display = 'flex';
  document.getElementById('main-app').style.display = 'none';
  const input = document.getElementById('login-password');
  if (input) {
    input.value = '';
  }
}

function hideLoginModal() {
  document.getElementById('login-modal').style.display = 'none';
}

function showMainApp() {
  document.getElementById('main-app').style.display = 'block';
}

// UI state management
function disableButtons() {
  const buttons = document.querySelectorAll('button');
  buttons.forEach(button => {
    if (button.id !== 'login-submit' && button.id !== 'edit-toggle-btn' && button.id !== 'delete-btn' && button.id !== 'new-entry-btn') {
      button.disabled = true;
    }
  });
}

function enableButtons() {
  const buttons = document.querySelectorAll('button');
  buttons.forEach(button => {
    if (button.id !== 'edit-toggle-btn' && button.id !== 'delete-btn') {
      button.disabled = false;
    }
  });
  updateEditDeleteButtons();
}

function disableForm() {
  const inputs = document.querySelectorAll('input, textarea, select');
  inputs.forEach(input => {
    if (input.id !== 'search-bar') {
      input.disabled = true;
    }
  });
  document.getElementById('save-btn').disabled = true;
  
  document.querySelectorAll('.text-section button').forEach(btn => {
    btn.disabled = true;
  });
  
  document.getElementById('new-type-btn').disabled = true;
  document.getElementById('new-suitable-for-btn').disabled = true;
}

function enableForm() {
  const inputs = document.querySelectorAll('input, textarea, select');
  inputs.forEach(input => {
    if (input.id !== 'new-type' && input.id !== 'new-suitable-for') {
      input.disabled = false;
    }
  });
  document.getElementById('save-btn').disabled = false;
  
  document.querySelectorAll('.text-section button').forEach(btn => {
    btn.disabled = false;
  });
  
  document.getElementById('new-type-btn').disabled = false;
  document.getElementById('new-suitable-for-btn').disabled = false;
}

function showMessage(message, type) {
  messageField.textContent = message;
  messageField.className = 'message-field ' + type;
  messageField.style.display = 'block';
  setTimeout(() => {
    messageField.style.display = 'none';
  }, 5000);
}

function scrollToTop() {
  const formContent = document.querySelector('.form-content');
  if (formContent) {
    formContent.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  }
}

function updateEditDeleteButtons() {
  const editBtn = document.getElementById('edit-toggle-btn');
  const deleteBtn = document.getElementById('delete-btn');
  
  if (currentEntryId) {
    editBtn.disabled = false;
    deleteBtn.disabled = false;
  } else {
    editBtn.disabled = true;
    deleteBtn.disabled = true;
  }
  
  if (isEditMode) {
    editBtn.textContent = 'Atšaukti';
    editBtn.classList.remove('success');
    editBtn.classList.add('secondary');
  } else {
    editBtn.textContent = 'Redaguoti';
    editBtn.classList.remove('secondary');
    editBtn.classList.add('success');
  }
}

function toggleEditMode() {
  if (!currentEntryId) {
    alert('Pasirinkite įrašą redagavimui');
    return;
  }

  isEditMode = !isEditMode;
  
  if (isEditMode) {
    enableForm();
    document.getElementById('form-content').classList.add('edit-mode');
    
    document.getElementById('new-type').disabled = false;
    document.getElementById('new-suitable-for').disabled = false;
  } else {
    disableForm();
    document.getElementById('form-content').classList.remove('edit-mode');
    const entry = database[currentEntryId];
    if (entry) {
      const listItem = document.querySelector(`[data-id="${currentEntryId}"]`);
      loadEntry(currentEntryId, entry, listItem);
    }
    
    document.getElementById('new-type').disabled = true;
    document.getElementById('new-suitable-for').disabled = true;
  }
  
  updateEditDeleteButtons();
}

function prepareNewEntry() {
  if (isEditMode && !confirm('Redagavimas vyksta. Ar norite išeiti neišsaugojus pakeitimų?')) {
    return;
  }

  document.querySelectorAll('.entry-item').forEach(item => {
    item.classList.remove('selected');
  });

  clearForm();
  enableForm();
  
  document.getElementById('new-type').disabled = false;
  document.getElementById('new-suitable-for').disabled = false;
  document.getElementById('new-type-btn').disabled = false;
  document.getElementById('new-suitable-for-btn').disabled = false;

  editIndex = null;
  currentEntryId = null;
  isEditMode = false;
  
  document.getElementById('form-content').classList.remove('edit-mode');
  document.getElementById('save-btn').textContent = 'Išsaugoti tekstą';
  
  updateEditDeleteButtons();
  scrollToTop();
  
  showMessage('Pasiruošta naujam įrašui', 'info');

  closeSidebar();
}

function initializeFilters() {
  const typeFiltersContainer = document.getElementById('type-filters');
  const difficultyFiltersContainer = document.getElementById('difficulty-filters');
  
  // Create type filter chips (now checkboxes)
  typeFiltersContainer.innerHTML = '';
  allOptions.SF.forEach(type => {
    const chip = document.createElement('div');
    chip.className = 'filter-chip';
    chip.textContent = decodeText(type); // CHANGED: Use decoded text
    chip.dataset.type = type;
    chip.onclick = () => toggleTypeFilter(type);
    typeFiltersContainer.appendChild(chip);
  });

  // Create class filter chips
  const classFiltersContainer = document.getElementById('class-filters');
  classFiltersContainer.innerHTML = '';
  allOptions.classes.forEach(classOption => {
    const chip = document.createElement('div');
    chip.className = 'filter-chip';
    chip.textContent = decodeText(classOption);
    chip.dataset.class = classOption;
    chip.onclick = () => toggleClassFilter(classOption);
    classFiltersContainer.appendChild(chip);
  });
  
  // Filter header toggle
  document.getElementById('filter-header').onclick = toggleFilters;
}

function toggleClassFilter(classOption) {
  const chip = document.querySelector(`[data-class="${classOption}"]`);
  
  if (selectedClassFilters.has(classOption)) {
    selectedClassFilters.delete(classOption);
    chip.classList.remove('active');
  } else {
    selectedClassFilters.add(classOption);
    chip.classList.add('active');
  }
  
  applyFilters();
}

function toggleFilters() {
  const content = document.getElementById('filter-content');
  const icon = document.getElementById('filter-icon');
  
  content.classList.toggle('collapsed');
  icon.classList.toggle('collapsed');
}

function toggleTypeFilter(type) {
  const chip = document.querySelector(`[data-type="${type}"]`);
  
  if (selectedTypeFilter === null) {
    selectedTypeFilter = new Set();
  }
  
  if (selectedTypeFilter.has(type)) {
    // Deselect this type
    selectedTypeFilter.delete(type);
    chip.classList.remove('active');
  } else {
    // Select this type
    selectedTypeFilter.add(type);
    chip.classList.add('active');
  }
  
  // Update difficulty filters based on all selected types
  if (selectedTypeFilter.size > 0) {
    updateDifficultyFilters();
    document.getElementById('difficulty-filter-group').style.display = 'block';
  } else {
    document.getElementById('difficulty-filter-group').style.display = 'none';
    selectedDifficultyFilters.clear();
  }
  
  applyFilters();
}

function updateDifficultyFilters() {
  const container = document.getElementById('difficulty-filters');
  container.innerHTML = '';
  
  // Get unique difficulty levels for all selected types
  const difficulties = new Set();
  Object.values(database).forEach(entry => {
    if (entry.SF) {
      selectedTypeFilter.forEach(type => {
        if (entry.SF[type]) {
          difficulties.add(entry.SF[type]);
        }
      });
    }
  });
  
  // Preserve previously selected difficulties that still exist
  const validDifficulties = new Set();
  difficulties.forEach(diff => {
    if (diff) {
      validDifficulties.add(diff);
      const chip = document.createElement('div');
      chip.className = 'filter-chip';
      chip.textContent = decodeText(diff); // CHANGED: Use decoded text
      chip.dataset.difficulty = diff;
      chip.onclick = () => toggleDifficultyFilter(diff);
      
      // Restore active state if previously selected
      if (selectedDifficultyFilters.has(diff)) {
        chip.classList.add('active');
      }
      
      container.appendChild(chip);
    }
  });
  
  // Remove selected difficulties that are no longer valid
  selectedDifficultyFilters.forEach(diff => {
    if (!validDifficulties.has(diff)) {
      selectedDifficultyFilters.delete(diff);
    }
  });
}

function toggleDifficultyFilter(difficulty) {
  const chip = document.querySelector(`[data-difficulty="${difficulty}"]`);
  
  if (selectedDifficultyFilters.has(difficulty)) {
    selectedDifficultyFilters.delete(difficulty);
    chip.classList.remove('active');
  } else {
    selectedDifficultyFilters.add(difficulty);
    chip.classList.add('active');
  }
  
  applyFilters();
}

function applyFilters() {
  const searchTerm = document.getElementById('search-bar').value.toLowerCase().trim();
  const entries = document.querySelectorAll('.entry-item');
  let visibleCount = 0;
  
  entries.forEach(item => {
    const id = item.dataset.id;
    const entry = database[id];
    
    // Search filter
    let matchesSearch = true;
    if (searchTerm) {
      matchesSearch = 
        String(id).includes(searchTerm) ||
        (entry.title?.toLowerCase().includes(searchTerm)) ||
        (entry.author?.toLowerCase().includes(searchTerm)) ||
        (entry.ref?.toLowerCase().includes(searchTerm)) ||
        (entry.text?.start?.some(part => removeNoSplitMarkers(part).toLowerCase().includes(searchTerm))) ||
        (entry.text?.middle?.some(part => removeNoSplitMarkers(part).toLowerCase().includes(searchTerm))) ||
        (entry.text?.end?.some(part => removeNoSplitMarkers(part).toLowerCase().includes(searchTerm))) ||
        (entry.text?.distractor?.some(part => removeNoSplitMarkers(part).toLowerCase().includes(searchTerm)));
    }
    
    // Type filter - CHANGED: Check if entry matches ANY selected type
    let matchesType = true;
    if (selectedTypeFilter && selectedTypeFilter.size > 0) {
      matchesType = false;
      selectedTypeFilter.forEach(type => {
        if (entry.SF && entry.SF[type]) {
          // If no difficulty filters, just matching the type is enough
          if (selectedDifficultyFilters.size === 0) {
            matchesType = true;
          } else {
            // Check if the difficulty matches
            if (selectedDifficultyFilters.has(entry.SF[type])) {
              matchesType = true;
            }
          }
        }
      });
    }
    
    
    // Class filter - add this after the matchesType check
    let matchesClass = true;
    if (selectedClassFilters.size > 0) {
      matchesClass = false;
      if (entry.class && Array.isArray(entry.class)) {
        selectedClassFilters.forEach(classOption => {
          if (entry.class.includes(classOption)) {
            matchesClass = true;
          }
        });
      }
    }

    const isVisible = matchesSearch && matchesType && matchesClass; 
    item.style.display = isVisible ? 'flex' : 'none';
    if (isVisible) visibleCount++;
  });
  
  document.getElementById('entry-count').textContent = visibleCount;
}

// Data initialization
function initializeData() {
  disableButtons();
  showMessage('Kraunami duomenys...', 'info');

  Promise.all([
    makeAuthenticatedRequest(`${apiBase}text/get-options`).then(res => res.json()),
    makeAuthenticatedRequest(`${apiBase}text/get-database`).then(res => res.json())
  ])
  .then(([optionsData, dbData]) => {
    allOptions = optionsData;
    displayOptions('type', optionsData.types);
    displayOptions('suitable-for', optionsData.SF);
    displayOptions('class', optionsData.classes);
    database = dbData;
    displayEntries();
    initializeFilters();
    showMessage('Duomenys sėkmingai įkelti', 'success');
    prepareNewEntry();
  })
  .catch(error => {
    console.error('Error initializing data:', error);
    showMessage('Klaida įkeliant duomenis. Bandykite vėliau.', 'error');
    if (error.message.includes('401') || error.message.includes('Reikia prisijungti')) {
      isAuthenticated = false;
      removeAuthToken();
      showLoginModal();
    }
  })
  .finally(() => {
    enableButtons();
  });
}

function displayOptions(category, options) {
  const container = document.getElementById(`${category}-options`);
  container.innerHTML = '';
  
  options.forEach(option => {
    const optionDiv = document.createElement('div');
    optionDiv.className = 'checkbox-item';

    const input = document.createElement('input');
    input.type = category === 'type' ? 'radio' : 'checkbox';
    input.value = option;
    input.id = `${category}-${option}`;
    input.name = category;
    input.disabled = true;

    const label = document.createElement('label');
    label.setAttribute('for', `${category}-${option}`);
    label.textContent = decodeText(option); // CHANGED: Use decoded text

    if (category === 'suitable-for') {
      const wrapper = document.createElement('div');
      wrapper.className = 'option-with-select';
      
      const select = document.createElement('select');
      select.className = 'form-select difficulty-level';
      select.id = `${category}-difficulty-${option}`;
      select.disabled = true;
      ['', 'C58', 'C59', 'C60'].forEach(diff => {
        const optionElem = document.createElement('option');
        optionElem.value = diff;
        optionElem.textContent = diff ? decodeText(diff) : 'Pasirinkite'; // CHANGED: Use decoded text
        select.appendChild(optionElem);
      });
      
      wrapper.append(input, label, select);
      optionDiv.appendChild(wrapper);
    } else {
      optionDiv.append(input, label);
    }
    
    container.appendChild(optionDiv);
  });
}

function displayEntries() {
  const list = document.getElementById('database-entries');
  list.innerHTML = '';
  
  const sortedIds = Object.keys(database).sort((a, b) => parseInt(a) - parseInt(b));
  
  sortedIds.forEach((id) => {
    const entry = database[id];
    const listItem = document.createElement('div');
    listItem.className = 'entry-item';
    listItem.dataset.id = id;
    
    const idSpan = document.createElement('span');
    idSpan.className = 'entry-id';
    idSpan.textContent = id;
    
    const titleSpan = document.createElement('span');
    titleSpan.className = 'entry-title';
    titleSpan.textContent = entry.title || 'Rašybos sakiniai';
    
    listItem.appendChild(idSpan);
    listItem.appendChild(titleSpan);
    
    listItem.addEventListener('click', () => {
      closeSidebar();
      disableForm();
      if (isEditMode) {
        if (confirm('Redagavimas vyksta. Ar norite išeiti neišsaugojus pakeitimų?')) {
          toggleEditMode();
          loadSelectedEntry(id, entry, listItem);
        }
      } else {
        loadSelectedEntry(id, entry, listItem);
      }
    });
    
    list.appendChild(listItem);
  });
  
  document.getElementById('entry-count').textContent = sortedIds.length;
}

function loadSelectedEntry(id, entry, listItem) {
  currentEntryId = id;
  loadEntry(id, entry, listItem);
  updateEditDeleteButtons();
}

function loadEntry(id, entry, listItem) {
  document.querySelectorAll('.entry-item').forEach(item => {
    item.classList.remove('selected');
  });
  
  listItem.classList.add('selected');
  editIndex = id;
  
  listItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  
  document.getElementById('title').value = entry.title || '';
  document.getElementById('author').value = entry.author || '';
  document.getElementById('reference').value = entry.ref || '';
  
  const typeInput = document.querySelector(`input[name="type"][value="${entry.type}"]`);
  if (typeInput) typeInput.checked = true;
  
  document.querySelectorAll('input[name="suitable-for"]').forEach(input => {
    input.checked = false;
    const difficultySelect = document.getElementById(`suitable-for-difficulty-${input.value}`);
    if (difficultySelect) difficultySelect.value = '';
  });
  
  if (entry.SF) {
    Object.entries(entry.SF).forEach(([key, value]) => {
      const input = document.querySelector(`input[name="suitable-for"][value="${key}"]`);
      if (input) {
        input.checked = true;
        const difficultySelect = document.getElementById(`suitable-for-difficulty-${key}`);
        if (difficultySelect) {
          difficultySelect.value = value || '';
        }
      }
    });
  }
  
  document.querySelectorAll('input[name="class"]').forEach(input => {
    input.checked = entry.class?.includes(input.value) || false;
  });
  
  ['start', 'middle', 'end', 'distractor'].forEach(section => {
    const textData = entry.text?.[section] || [];
    textSections[section] = Array.isArray(textData) ? [...textData] : [];
    updateTextList(section);
  });
  
  document.getElementById('save-btn').textContent = 'Atnaujinti tekstą';
  document.title = `Redaguojama: ${entry.title || id}`;
}

function saveEntry() {
  const title = document.getElementById('title').value.trim();
  const author = document.getElementById('author').value.trim();
  const reference = document.getElementById('reference').value.trim();
  const type = document.querySelector('input[name="type"]:checked')?.value;
  
  const suitableFor = {};
  let hasSuitableFor = false;
  document.querySelectorAll('input[name="suitable-for"]:checked').forEach(input => {
    hasSuitableFor = true;
    const difficultySelect = document.getElementById(`suitable-for-difficulty-${input.value}`);
    suitableFor[input.value] = difficultySelect ? difficultySelect.value : '';
  });

  const classChoices = [...document.querySelectorAll('input[name="class"]:checked')].map(cb => cb.value);
  const hasClassChoices = classChoices.length > 0;

  const hasStartText = textSections.start.length > 0;
  const hasMiddleText = textSections.middle.length > 0;
  const hasEndText = textSections.end.length > 0;
  const hasAnyText = hasStartText || hasMiddleText || hasEndText;

  const errors = [];
  
  if (!type) {
    errors.push('• Pasirinkite tekstų tipą');
  }
  
  if (!hasSuitableFor) {
    errors.push('• Pasirinkite bent vieną užduoties rūšį');
  }
  
  if (!hasClassChoices) {
    errors.push('• Pasirinkite bent vieną klasę');
  }
  
  if (!hasAnyText) {
    errors.push('• Įveskite bent vieną teksto dalį (pradžią, įvykių raidą arba pabaigą)');
  }

  if (errors.length > 0) {
    alert('Pataisykite šias klaidas:\n\n' + errors.join('\n'));
    return;
  }

  const entryData = {
    title,
    author,
    ref: reference,
    type,
    SF: suitableFor,
    class: classChoices,
    text: textSections
  };

  if (editIndex !== null) {
    entryData.id = editIndex;
  }

  disableButtons();
  showMessage('Siunčiama...', 'info');

  makeAuthenticatedRequest(`${apiBase}text/save-entry`, {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(entryData)
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => { throw new Error(err.message || 'Server error'); });
    }
    return response.json();
  })
  .then(data => {
    alert(editIndex !== null ? 'Įrašas sėkmingai atnaujintas!' : 'Įrašas sėkmingai sukurtas!');
    return makeAuthenticatedRequest(`${apiBase}text/get-database`);
  })
  .then(response => response.json())
  .then(data => {
    database = data;
    displayEntries();
    editIndex = null;
    currentEntryId = null;
    isEditMode = false;
    document.getElementById('form-content').classList.remove('edit-mode');
    document.getElementById('save-btn').textContent = 'Išsaugoti tekstą';
    clearForm();
    scrollToTop();
    updateEditDeleteButtons();
    applyFilters();
    prepareNewEntry();
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Klaida: ' + (error.message || 'Serverio klaida'));
    if (error.message === "Unauthorized") {
      removeAuthToken();
      showLoginModal();
    }
  })
  .finally(() => {
    enableButtons();
  });
}

function deleteEntry() {
  if (!currentEntryId) {
    alert('Pasirinkite įrašą, kurį norite ištrinti');
    return;
  }

  if (!confirm('Ar tikrai norite ištrinti šį įrašą? Šio veiksmo atšaukti negalėsite.')) {
    return;
  }

  disableButtons();
  showMessage('Trinamas įrašas...', 'info');

  makeAuthenticatedRequest(`${apiBase}text/delete-entry`, {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ id: currentEntryId })
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => { throw new Error(err.message || 'Server error'); });
    }
    return response.json();
  })
  .then(data => {
    alert('Įrašas sėkmingai ištrintas!');
    return makeAuthenticatedRequest(`${apiBase}text/get-database`);
  })
  .then(response => response.json())
  .then(data => {
    database = data;
    displayEntries();
    editIndex = null;
    currentEntryId = null;
    isEditMode = false;
    document.getElementById('form-content').classList.remove('edit-mode');
    document.getElementById('save-btn').textContent = 'Išsaugoti tekstą';
    clearForm();
    scrollToTop();
    updateEditDeleteButtons();
    applyFilters();
    prepareNewEntry();
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Klaida: ' + (error.message || 'Serverio klaida'));
    if (error.message === "Unauthorized") {
      removeAuthToken();
      showLoginModal();
    }
  })
  .finally(() => {
    enableButtons();
  });
}

function clearForm() {
  document.getElementById('title').value = '';
  document.getElementById('author').value = '';
  document.getElementById('reference').value = '';
  
  document.querySelectorAll('input[name="type"]').forEach(input => {
    input.checked = false;
  });
  
  document.querySelectorAll('input[name="suitable-for"]').forEach(input => {
    input.checked = false;
    const difficultySelect = document.getElementById(`suitable-for-difficulty-${input.value}`);
    if (difficultySelect) difficultySelect.value = '';
  });
  
  document.querySelectorAll('input[name="class"]').forEach(input => {
    input.checked = false;
  });
  
  ['start', 'middle', 'end', 'distractor'].forEach(section => {
    textSections[section] = [];
    updateTextList(section);
    document.getElementById(`${section}-text`).value = '';
    document.getElementById(`${section}-no-split`).checked = false;
  });
}

function updateTextList(section) {
  const listDiv = document.getElementById(`${section}-list`);
  listDiv.innerHTML = '';
  textSections[section].forEach((text, index) => {
    const chip = document.createElement('div');
    chip.className = 'text-chip';
    const displayText = removeNoSplitMarkers(text);
    chip.textContent = displayText;
    chip.dataset.index = index;
    
    if (hasNoSplitMarkers(text)) {
      const indicator = document.createElement('span');
      indicator.className = 'no-split-indicator';
      indicator.textContent = '⚠️';
      indicator.title = 'Nedalomi sakiniai';
      chip.appendChild(indicator);
    }
    
    chip.onclick = (e) => {
      e.stopPropagation();
      handleTextItemClick(section, index);
    };
    listDiv.appendChild(chip);
  });
}

function addText(section) {
  const textarea = document.getElementById(`${section}-text`);
  const noSplitCheckbox = document.getElementById(`${section}-no-split`);
  let text = textarea.value.trim();

  console.log('Adding text:', text);
console.log('No-split checkbox checked:', noSplitCheckbox.checked);

if (noSplitCheckbox.checked) {
  text = addNoSplitMarkers(text);
  console.log('Text with markers:', text);
}
  
  if (text) {
    if (noSplitCheckbox.checked) {
      text = addNoSplitMarkers(text);
    }
    
    textSections[section].push(text);
    updateTextList(section);
    textarea.value = '';
    noSplitCheckbox.checked = false;
  }
}

function handleTextItemClick(section, index) {
  if (!isEditMode && currentEntryId) {
    alert('Norėdami redaguoti tekstą, pirmiausia įjunkite redagavimo režimą');
    return;
  }

  const list = document.getElementById(`${section}-list`);
  const chip = list.querySelector(`[data-index="${index}"]`);
  const originalText = textSections[section][index];
  const hasMarkers = hasNoSplitMarkers(originalText);
  const displayText = removeNoSplitMarkers(originalText);

  const wrapper = document.createElement('div');
  wrapper.style.width = '100%';
  wrapper.style.padding = '10px';
  wrapper.style.background = 'rgba(255, 255, 255, 0.6)';
  wrapper.style.borderRadius = '12px';

  const textarea = document.createElement('textarea');
  textarea.className = 'form-textarea';
  textarea.value = displayText;
  textarea.rows = 3;
  textarea.style.marginBottom = '10px';

  const noSplitCheckbox = document.createElement('input');
  noSplitCheckbox.type = 'checkbox';
  noSplitCheckbox.checked = hasMarkers;
  noSplitCheckbox.id = `edit-no-split-${section}-${index}`;

  const noSplitLabel = document.createElement('label');
  noSplitLabel.setAttribute('for', `edit-no-split-${section}-${index}`);
  noSplitLabel.textContent = '⚠️ Nedalomi sakiniai';
  noSplitLabel.style.cursor = 'pointer';

  const checkboxWrapper = document.createElement('div');
  checkboxWrapper.className = 'no-split-checkbox';
  checkboxWrapper.style.marginBottom = '10px';
  checkboxWrapper.appendChild(noSplitCheckbox);
checkboxWrapper.appendChild(noSplitLabel);
const btnGroup = document.createElement('div');
btnGroup.style.display = 'flex';
btnGroup.style.gap = '10px';
const saveBtn = document.createElement('button');
saveBtn.textContent = 'Išsaugoti';
saveBtn.className = 'action-btn success';
saveBtn.onclick = () => {
let newText = textarea.value.trim();
if (noSplitCheckbox.checked) {
newText = addNoSplitMarkers(newText);
}
textSections[section][index] = newText;
updateTextList(section);
};
const cancelBtn = document.createElement('button');
cancelBtn.textContent = 'Atšaukti';
cancelBtn.className = 'action-btn secondary';
cancelBtn.onclick = () => {
updateTextList(section);
};
const deleteBtn = document.createElement('button');
deleteBtn.textContent = 'Ištrinti';
deleteBtn.className = 'action-btn danger';
deleteBtn.onclick = () => {
textSections[section].splice(index, 1);
updateTextList(section);
};
btnGroup.appendChild(saveBtn);
btnGroup.appendChild(cancelBtn);
btnGroup.appendChild(deleteBtn);
wrapper.appendChild(textarea);
wrapper.appendChild(checkboxWrapper);
wrapper.appendChild(btnGroup);
chip.replaceWith(wrapper);
}
function addOption(category) {
const input = document.getElementById(`new-${category}`);
const value = input.value.trim();
if (value) {
if (category === 'type') {
const container = document.getElementById('type-options');
const optionDiv = document.createElement('div');
optionDiv.className = 'checkbox-item';
  const radioInput = document.createElement('input');
  radioInput.type = 'radio';
  radioInput.value = value;
  radioInput.id = `type-${value}`;
  radioInput.name = 'type';
  
  const label = document.createElement('label');
  label.setAttribute('for', `type-${value}`);
  label.textContent = value;
  
  optionDiv.appendChild(radioInput);
  optionDiv.appendChild(label);
  container.appendChild(optionDiv);
  
  radioInput.checked = true;
} else if (category === 'suitable-for') {
  const container = document.getElementById('suitable-for-options');
  const optionDiv = document.createElement('div');
  optionDiv.className = 'checkbox-item';
  
  const wrapper = document.createElement('div');
  wrapper.className = 'option-with-select task-type';
  
  const checkInput = document.createElement('input');
  checkInput.type = 'checkbox';
  checkInput.value = value;
  checkInput.id = `suitable-for-${value}`;
  checkInput.name = 'suitable-for';
  
  const label = document.createElement('label');
  label.setAttribute('for', `suitable-for-${value}`);
  label.textContent = value;
  
  const select = document.createElement('select');
  select.className = 'form-select';
  select.id = `suitable-for-difficulty-${value}`;
  ['', 'C58', 'C59', 'C60'].forEach(diff => {
    const option = document.createElement('option');
    option.value = diff;
    option.textContent = diff || 'Pasirinkite';
    select.appendChild(option);
  });
  
  wrapper.appendChild(checkInput);
  wrapper.appendChild(label);
  wrapper.appendChild(select);
  optionDiv.appendChild(wrapper);
  container.appendChild(optionDiv);
  
  checkInput.checked = true;
}

input.value = '';
showMessage('Parinktis pridėta - bus išsaugota kartu su įrašu', 'success');
}
}
async function downloadExcelSummary() {
disableButtons();
showMessage('Generuojama Excel santrauka...', 'info');
try {
const response = await makeAuthenticatedRequest(`${apiBase}text/download-excel`, {
method: 'GET'
});
if (!response.ok) {
  const errorData = await response.json();
  throw new Error(errorData.message || 'Server returned an error');
}

const blob = await response.blob();
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = 'sudedu_duomenu_bazes_santrauka.xlsx';
document.body.appendChild(a);
a.click();
window.URL.revokeObjectURL(url);

alert('Excel santrauka sėkmingai atsisiųsta!');
} catch (error) {
console.error('Download failed:', error);
alert(`Klaida: ${error.message}`);
if (error.message === "Unauthorized") {
removeAuthToken();
showLoginModal();
}
} finally {
enableButtons();
}
}
async function downloadDatabaseInJsonFormat() {
disableButtons();
showMessage('Ruošiamas JSON failas...', 'info');
try {
const response = await makeAuthenticatedRequest(`${apiBase}text/download-db`);
if (!response.ok) {
  const errorData = await response.json();
  throw new Error(errorData.message || 'Server returned an error');
}

const blob = await response.blob();
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = 'sudedu_duomenu_baze.json';
document.body.appendChild(a);
a.click();
window.URL.revokeObjectURL(url);

alert('Duomenų bazė sėkmingai atsisiųsta JSON formatu!');
} catch (error) {
console.error('Download failed:', error);
alert(`Klaida: ${error.message}`);
if (error.message === "Unauthorized") {
removeAuthToken();
showLoginModal();
}
} finally {
enableButtons();
}
}
// Event listeners
document.addEventListener('DOMContentLoaded', () => {
disableForm();
// Search with debounce
let searchTimeout;
document.getElementById('search-bar').addEventListener('input', () => {
clearTimeout(searchTimeout);
searchTimeout = setTimeout(applyFilters, 300);
});
// New entry button
document.getElementById('new-entry-btn').addEventListener('click', prepareNewEntry);
// Edit and delete buttons
document.getElementById('edit-toggle-btn').addEventListener('click', toggleEditMode);
document.getElementById('delete-btn').addEventListener('click', deleteEntry);
// Login handling
const authToken = getAuthToken();
if (authToken) {
makeAuthenticatedRequest(`${apiBase}auth/verify-token`)
.then(() => {
isAuthenticated = true;
document.getElementById('login-modal').style.display = 'none';
document.getElementById('main-app').style.display = 'block';
initializeData();
})
.catch(() => {
isAuthenticated = false;
removeAuthToken();
document.getElementById('login-modal').style.display = 'flex';
document.getElementById('main-app').style.display = 'none';
});
} else {
document.getElementById('login-modal').style.display = 'flex';
document.getElementById('main-app').style.display = 'none';
}
document.getElementById('login-submit').addEventListener('click', () => {
const password = document.getElementById('login-password').value.trim();
if (password) {
handleLogin(password);
} else {
document.getElementById('login-message').textContent = 'Įveskite slaptažodį';
document.getElementById('login-message').style.display = 'block';
}
});
document.getElementById('login-password').addEventListener('keypress', (e) => {
if (e.key === 'Enter') {
const password = document.getElementById('login-password').value.trim();
if (password) {
handleLogin(password);
}
}
});
});
// Prevent password field from being disabled
const passwordInput = document.getElementById('login-password');
if (passwordInput) {
const observer = new MutationObserver(() => {
if (passwordInput.disabled) {
passwordInput.disabled = false;
}
});
observer.observe(passwordInput, { attributes: true, attributeFilter: ['disabled'] });
Object.defineProperty(passwordInput, 'disabled', {
set: () => {},
get: () => false
});
}

// Sidebar functionality
const sidebarWrapper = document.getElementById('sidebarWrapper');
const toggleTab = document.getElementById('toggleTab');
const sidebarOverlay = document.getElementById('sidebarOverlay');

// Toggle sidebar function
function toggleSidebar() {
  sidebarWrapper.classList.toggle('open');
}

// Open sidebar function
function openSidebar() {
  sidebarWrapper.classList.add('open');
}

// Close sidebar function
function closeSidebar() {
    sidebarWrapper.classList.remove('open');
}

function displaySidebar() {
    const sidebarWrapper = document.querySelector('.sidebar-wrapper');
    const width = sidebarWrapper.offsetWidth;

    if (window.innerWidth <= 768) {
        sidebarWrapper.style.transform = `translateX(${(width)*-1}px)`;
    } else {
        sidebarWrapper.style.transform = `translateX(0px)`;
    }
}

function hideSidebar() {
    const sidebarWrapper = document.querySelector('.sidebar-wrapper');
    const width = sidebarWrapper.offsetWidth;

    sidebarWrapper.style.transform = `translateX(${(width+35)*-1}px)`;

    closeSidebar();
}

// Event listeners
if (toggleTab) {
    toggleTab.addEventListener('click', toggleSidebar);
}

// Close sidebar on window resize if it becomes desktop size
window.addEventListener('resize', () => {
    hideSidebar()
});
</script>
</body>
</html>