<!DOCTYPE html>
<html>

<head>
	<title>SUDEDU - užduotys</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
	<link rel="icon" href="../images/favicon.ico" type="image/x-icon">
	<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Andika:wght@400;700&family=Josefin+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
	<link rel="stylesheet" type="text/css" href="../summary.css">
    <link rel="stylesheet" type="text/css" href="../index.css">
    <link rel="stylesheet" href="../main-nav-bar.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-96Q83PW8XY"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-96Q83PW8XY');
    </script>
    <script src="../refresh-token.js"></script>

    <style>
        * {
            box-sizing: border-box;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        html {
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: linear-gradient(to top, #ffbf9c, #ffbf92, #ffbf89, #ffbf7e, #ffc074);
            width: 100vw;
            height: 100svh;
            overflow: hidden;
            user-select: none;         /* Standard */
            -webkit-user-select: none; /* Chrome, Safari, Edge */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE/older Edge */
        }

        body {
            margin: 0;
            font-family: 'SFpro', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(6px);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(6px);
            border-radius: 10px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            background-clip: content-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.6);
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.4) transparent;
        }

        body {
            display: flex;
            flex-direction: column;
            padding: 0;
            height: 100svh;
            width: 100vw;
        }

        .row {
            width: 100%;
            min-width: 100%;
            --bs-gutter-x: 0; 
        }

        #template-container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            max-width: none;
            display: flex;
            align-items: start;
            justify-content: center;
        }
        
        #content-container {
            flex: 1;
            max-height: calc(100% - 80px - 16px - 16px);
            min-height: calc(100% - 80px - 16px - 16px);
            width: calc(100% - (2 * 16px));
            display: flex;
            justify-content: start;
            background: rgba(255, 255, 255, 0.08);
            margin: 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.1);
        }

        .task-info-holder > :not(:empty),
        .task-info-holder-student > :not(:empty) {
        margin-top: 5px;
        }

        #inner-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #teacher-gui {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
            flex-direction: row;
        }

        .left-side-bar {
            height: 100%;
            padding: 15px;
            flex: 1 1 35%;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.15);
            border-top-left-radius: 20px;
            border-bottom-left-radius: 20px;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        #dynamic-teacher-content {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .initial-button-div {
            min-width: 250px;
            margin-bottom: 15px;
        }

        .teacher-button {
            width: 100%;
        }

        #timer-input-div,
        #question-number-input-div {
            margin-top: 10px;
        }

        .teacher-button:disabled {
            background-color: #40c9a9;
            border-color: #40c9a9;
            color: black;
            filter: grayscale(25%);
        }

        .confirmation-button-div {
            min-width: 150px;
            margin: 0 0 15px 15px;
        }

        #confirm-delete-task-button,
        #confirm-delete-student-button {
            width: 100%;
        }

        #teacher-message-line-2 {
            text-align: center;
            margin: 15px 0;
            min-height: 48px;
        }
        
        #teacher-message-line,
        #teacher-data-retrieval-message,
        #student-message {
            text-align: center;
            margin-right: 4vw;
        }

        #task-group-sorting {
            width: 100%;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            color: #212529;
            padding: 12px 16px;
            transition: all 0.3s ease;
            box-shadow: none;
            text-align: center;
            font-size: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-dropdown-inner-group-list:not(:empty) {
            border-top: 2px solid rgba(255, 255, 255, 1);
            padding-top: 5px;
            margin-top: 5px;
        }

        #task-group-count {
            font-size: 0.9rem;
        }

        .group-options-arrow {
            height: 24px;
            width: 24px;
            margin: 0 4px;
        }
        
        .left-side-bar-inner {
            height: 100%;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        #student-details-for-teachers {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        #outer-student-list-container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 20px;
            overflow: hidden;
            flex: 1 0 60svh;
            display: flex;
            flex-direction: column;
        }

        #student-list-header {
            background: rgba(255, 255, 255, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
        }

        #student-list-header-checkbox-container,
        #student-list-title-container {
            padding: 10px 0 10px 0;
            font-weight: bold;
            text-transform: uppercase;
        }

        #student-list-title-container {
            margin-left: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .teacher-home-button {
            border: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.25);
            padding: 5px 7px;
            border-radius: 8px;
            cursor: pointer;
            transition: box-shadow 0.3s ease;
        }

        #select-all-checkbox {
            margin-right: 10px;
        }

        #student-list-container {
            overflow: auto;
            flex: 1;
        }

        #student-list {
            background: transparent;
            padding: 15px 15px 20px 15px;
        }

        .student-checkbox,
        .task-checkbox {
            margin-right: 10px;
        }

        #student-list ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .outer-student-list-entry-item {
            display: flex;
            flex-direction: column;
            align-items: start;
            justify-content: center;
        }

        .student-li-item {
            display: flex;
            align-items: center;
            justify-content: start;
            font-weight: bold;
            text-transform: uppercase;
        }

        .task-li-item {
            margin-left: 20px;
            display: flex;
            align-items: center;
            justify-content: start;
        }

        .student-li-item,
        .task-container {
            width: 100%;
        }

        .task-li-item {
            width: calc(100% - 20px);
        }

        .student-li-item .selection-option {
            width: 80%;
            transition: box-shadow 0.3s ease; /* Smooth transition for highlighting */
        }

        .task-li-item .selection-option {
            width: calc(80% - 5px);
            transition: box-shadow 0.3s ease; /* Smooth transition for highlighting */
            white-space: normal;
            overflow-wrap: break-word;
        }

        #student-task-list-container .task-li-item .selection-option {
            width: calc(100% - 15px);
        }

        .selected-option {
            background: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.5); /* Adds a glow effect around the selected element */
        }

        #student-list li { 
            padding: 10px 0 0 0; 
        }

        #new-task-options-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            max-width: 500px;
            flex: 1;
            justify-content: center;
        }

        #group_name,
        #mode_choice,
        #mode_choice_1,
        #mode_choice_2,
        #mode_choice_3,
        #mode_choice_4,
        #mode_choice_5,
        #mode_choice_6,
        #mode_choice_7,
        #mode_choice_8,
        #mode_choice_9,
        #mode_choice_10,
        #mode_choice_13,
        #mode_choice_14,
        #mode_choice_15,
        #class_choice {
            width: 100%;
            box-sizing: border-box;
            text-align: center;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            font-size: 1.3rem;
            padding: 7px;
            margin: 10px 0;
        }

        #mode_choice_11_div {
            box-sizing: border-box;
        }

        #mode_choice_12 {
            width: auto;
        }

        .remainder-div {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #remainder-option {
            font-weight: 600;
        }

        .selected_numbers_inner_div {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .number-choice-label-iki,
        .number-choice-label-nuo {
            font-weight: 600;
            font-size: 1.75rem;
        }

        .timer-question-number-div,
        .timer-input-div,
        .question-number-input-div {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #timer-input,
        #question-number-input {
            padding: 0.5rem;
            font-size: 1.3rem;
            width: 55px;
            border: 0;
            margin: 0;
            outline: none;
            border-radius: 20px;
            background: transparent;
            text-align: center;
        }

        #timer-input:focus,
        #question-number-input:focus,
        #timer-input:active,
        #question-number-input:active {
            border: 0;
            margin: 0;
            outline: none;
        }

        .timer-choice-label,
        .answer-number-label {
            font-size: 1.75rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 0;
            width: 130px;
        }

        #new-task-options-container > * {
            width: 100%;;
        }

        #text-distractor {
            margin-bottom: 15px;
        }

        .new-task-input-holder {
            width: 100%;
        }

        #group_name {
            border: 0;
            outline: 0;
            font-size: 1.3rem;
            text-align: start;
            padding-left: 15px;
        }

        #group_name:focus,
        #group_name:active,
        #group_name:hover {
            border: 0;
            outline: none;
        }

        .modeChoice4_div {
            width: 100%;
            padding: 0;
        }
        
        .empty-placeholder-between-options {
            padding: 0;
            width: 100%;
        }

        .timer-choice-label,
        .answer-number-label {
            margin-left: 10px;
        }

        #student-task-info-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex: 1;
            min-width: 0;
        }

        #student-task-info-container-inner {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            min-width: 0;
        }

        .summary-inner-container:not(:empty) {
            margin-top: 10px;
            margin-bottom: 10px;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 20px;
        }

        table {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
            border-color: rgba(255, 255, 255, 0.2);
            overflow: hidden;
            margin: 0 !important;
            table-layout: fixed;
            border-radius: 20px;
        }

        th,
        td {
            padding: 5px 5px 5px 5px;
            background-color: rgba(255, 255, 255, 0.2);
            font-size: 1rem;
        }

        th:first-child, th:nth-child(2) {
            text-align: center;
        }

        td:first-child, td:nth-child(2) {
            text-align: center;
        }

        tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        tbody td:hover:before {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            top: -9999px;
            bottom: -9999px;
            background-color: rgba(255, 255, 255, 0.2);
            z-index: 2;
        }

        tbody td {
            position: relative;
        }

        .bar {
            height: 20px;
            border-radius: 8px;
            max-width: 100%;
        }

        #student-task-student-name {
            font-weight: 800;
            text-transform: uppercase;
            font-size: 1.5rem;
            margin-bottom: 0;
            display: flex;
            align-items: center;
        }
        
        #student-task-group-and-status-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        #frequent-mistakes-container {
            display: none;
        }

        #frequent-mistakes-container .clickable-word {
            cursor: default;
        }

        #frequent-mistakes-container .clickable-word:hover,
        #frequent-mistakes-container .clickable-word:active {
            text-decoration: none;
        }

        #student-task-group,
        #student-task-group-for-student {
            max-width: 95%;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 1.25rem;
            white-space: normal;
            overflow-wrap: break-word;
        }

        #student-task-group-for-student {
            max-width: 95%;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 1.5rem;
            white-space: normal;
            overflow-wrap: break-word;
        }

        .student-list-task-indicatior {
            display: inline-block;
            margin-left: 5px;
            width: 10px;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
        }

        .mistakes-summary-forstudents-title {
            width: 100%;
            text-align: start;
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 15px;
            margin-top: 5px;
            text-transform: uppercase;
        }

        #student-task-status-indicator,
        #student-task-status-indicator-for-student {
            width: 20px;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
        }

        #task-description-title,
        #task-description-title-for-student {
            margin-top: 10px;
        }

        #task-description-for-student {
            margin-top: 10px;
        }

        .reset-button-div {
            margin-top: 40px;
        }

        .task-description-list {
            margin-bottom: 0;
            margin-top: 5px;
            padding: 0;
        }

        .task-description-list-item {
            text-transform: lowercase;
            margin-left: 2rem;
        }

        #change-teacher-input {
            margin-bottom: 5px;
        }

        #teacher-name {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        #change-teacher-toggle-button {
            text-decoration: underline;
            cursor: pointer;
            text-align: start;
            color: #32ac93;
            background-color: transparent;
            border: none;
            padding: 0;
        }

        #change-teacher-toggle-button:disabled {
            color: gray;
        }

        #add-change-teacher-buttons {
            height: 38px;
            margin: 10px 0;
        }

        #student-gui {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
            flex-direction: row;
        }

        #student-task-for-students-title-container {
            background: rgba(255, 255, 255, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding: 15px;
            display: flex;
            justify-content: space-between;
        }

        #student-task-list-container {
            overflow: auto;
            flex: 1;
            padding-top: 10px;
        }

        #student-tasks-list {
            background-color: transparent;
            padding: 0 0 10px 0;
        }

        .task-li-item-for-students {
            padding-top: 10px;
            margin-left: 15px;
        }

        #task-info-container-for-students {
            height: 100%;
            width: 100%;
        }

        .grammar-params-list {
            margin-left: 15px;
            padding: 0;
        }

        .grammar-view-selector {
            position: relative;
            border: none;
            border-radius: 4px;
            background-color: transparent;
            text-align: center;
            font-weight: bold;
            z-index: 10;
            pointer-events: auto;
            font-size: 1rem;
        }

        .task-info-subtitle {
            font-style: italic;
        }

        .student-statistics-title {
            font-size: 1.35rem;
            margin: 10px 0 5px 0;
            font-weight: 600;
            text-decoration: underline;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }

        .student-statistics-subtitle {
            font-size: 1.15rem;
            font-weight: 600;
        }

        .btn:disabled {
            background-color: #40c9a9;
            border-color: #40c9a9;
            color: black;
            filter: grayscale(25%);
        }

        .dropdown:disabled {
            filter: grayscale(25%);
            background-color: #FAF1E6;
            border-color: #6c757d;
        }

        .invalid-submition {
        animation: shake 0.2s ease-in-out 0s 2 !important;
        }

        #expand-student-info-button {
            background-color: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .complete-task-holder {
            display: flex;
            justify-content: end;
            margin-top: 10px;
            gap: 5px;
        }

        #complete-task-button {
            position: relative;
            display: flex;
            align-items: center;
            padding: 12px 18px 12px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0;
            background: linear-gradient(135deg, #3288AC, #286D8A);
            border: none;
            /*border: 1px solid #286D8A;*/
            color: #F5F5F7;
            letter-spacing: 0.01em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            /*box-shadow: 
                0 1px 2px rgba(0, 0, 0, 0.2),
                0 4px 12px rgba(50, 136, 172, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);*/
        }

        #complete-task-button::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
        border-radius: 20px;
        pointer-events: none;
        transition: background 0.3s ease;
        }

        #complete-task-button::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 20px;
        padding: 1px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        pointer-events: none;
        }

        #complete-task-button:hover::before {
        background: rgba(255, 255, 255, 0.15);
        }


#student-task-student-knowledge-level,
#student-task-student-performance-mean,
#student-task-student-consistency-mean {
    flex: 1 1 auto;
}

.categories-dropdown-holder,
.student-points-holder {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: start;
    gap: 5px;
}

.knowledge-level-select-text, 
.student-points-label,
.student-consistency-label,
.student-statistics-label {
    text-transform: uppercase;
    font-weight: 600;
}

.student-points {
    font-size: 1.5rem;
    font-weight: 700;
}

#student-statistics-completed-tasks {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid rgba(255, 255, 255, 0.3);
    text-transform: uppercase;
    font-weight: 600;
    font-size: 1.25rem;
}

#student-statistics-completed-tasks .task-info-subtitle {
    font-style: normal;
}
        
.student-statistic-top-section {
    display: flex;
    align-items: start;
    margin-top: 20px !important;
    flex-wrap: wrap;
    width: 100%;
    gap: 15px;
}

/* Form and button styles */
.form-control {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
}

#student-statistics-komponavimas-completed-texts ol,
#text-comprehension-mistakes-summary ol {
    margin: 5px 0;
}

#student-statistics-komponavimas-completed-texts:not(:empty) {
    margin-top: 5px;
}


.task-info-holder,
.task-info-holder-student {
    flex-direction: column;
}


#task-list-title-for-students {
    font-weight: 700;
}

        @keyframes shake {
        0% { margin-left: 0rem; }
        25% { margin-left: 0.5rem; }
        75% { margin-left: -0.5rem; }
        100% { margin-left: 0rem; }
        }

        .clickable-word {
            cursor: pointer;
            position: relative;
            z-index: 1000;
        }

        .clickable-word:hover {
            text-decoration: underline;
        }

        .student-name,
        .selection-option {
            user-select: none;       /* Standard */
            -webkit-user-select: none; /* Chrome/Safari */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE/Edge */
        }


        .incorrect-part {
            pointer-events: none;
            padding: 0;
            font-weight: bold;
            padding: 2px 1px;
            border-radius: 3px;
            color: #32ac93;
        }

        .user-incorrect-answer {
            color: #D57E7E;
            font-weight: bold;
        }


        #student-tasks-list-outer-container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            overflow: hidden;
            flex: 1 0 60svh;
            display: flex;
            flex-direction: column;
        }


           .container {
      display: flex;
      min-height: 0;
    }

    /* Sidebar wrapper */
    .sidebar-wrapper {
      position: relative;
      flex: 1 1 65%;
      height: 100%;
      margin-right: 10px;
      min-width: 0;
    }

    /* Sidebar content */
    .sidebar {
        position: relative;
        padding: 16px;
        height: 100%;
        width: 100%;
        overflow-y: auto;
        margin-right: 15px;
        min-width: 0;
    }
    
    #knowledge-level-select {
        padding: 6px 8px;
        font-size: 1rem;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        width: 150px;
        text-align: center;
        cursor: pointer;
        width: auto;
    }

    #knowledge-level-select:focus,
    #knowledge-level-select:active {
        outline: none;
    }

    .sidebar-content {
      min-height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    /* Toggle tab - always visible */
    .toggle-tab {
      position: absolute;
      right: -34px;
      top: 0;
      border: none;
      width: 34px;
      height: 62px;
      border-radius: 0 20px 20px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    -webkit-backdrop-filter: blur(15px);
    backdrop-filter: blur(15px);
    background: rgba(255, 255, 255, 0.5);
    padding: 0;
    }

    .toggle-tab svg {
      width: 24px;
      height: 24px;
      transition: transform 0.3s ease;
    }

    /* Main content */
    .main-content {
      flex: 1;
      padding: 2rem;
      background: #f5f5f5;
    }

    .main-content h1 {
      color: #2c3e50;
      margin-bottom: 1rem;
    }

    .main-content p {
      line-height: 1.6;
      color: #555;
      margin-bottom: 1rem;
    }

      #action-buttons-container,
    #confirmation-buttons-container {
        display: flex;
        flex-direction: row;
        gap: 5px;
        height: 60px;
    }

    #confirmation-buttons-container {
        display: none;
    }


#student-action-buttons-container {
    display: flex;
    justify-content: end;
    margin-bottom: 10px;
    height: 60px;
}

#text-message {
    margin-top: 10px;
}

.student-action-btn {
    flex: 0 0 auto;
    width: 100px;
}

.teacher-action-btn,
.confirm-btn,
.new-search-btn,
.cancel-btn {
    flex: 1;
}

.teacher-action-btn,
.student-action-btn,
.confirm-btn,
.new-search-btn,
.cancel-btn {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  border: none;
  /*border: #286D8A 1px solid;*/
  background: linear-gradient(135deg, #3288AC, #286D8A);
  border-radius: 20px;
  cursor: pointer;
  font-size: 1rem;
  color: #F5F5F7;
  min-width: 0;
  padding: 16px 15px;
  font-weight: 500;
  letter-spacing: 0.01em;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  /*box-shadow: 
        0 1px 2px rgba(0, 0, 0, 0.2),
        0 4px 12px rgba(50, 136, 172, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);*/
}

.teacher-action-btn::before,
.student-action-btn::before,
.confirm-btn::before,
.new-search-btn::before,
.cancel-btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
  border-radius: 20px;
  pointer-events: none;
  transition: background 0.3s ease;
}

.teacher-action-btn::after,
.student-action-btn::after,
.confirm-btn::after,
.new-search-btn::after,
.cancel-btn::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 20px;
  padding: 1px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
}

.teacher-action-btn:hover::before,
.student-action-btn:hover::before,
.confirm-btn:hover::before,
.new-search-btn:hover::before,
.cancel-btn:hover::before {
  background: rgba(255, 255, 255, 0.15);
}


.confirm-btn {
    background: linear-gradient(135deg, #A0C58F, #32ac93);
    border: none;
    /*border: 1px solid #32ac93;*/
}

.new-search-btn {
    background: linear-gradient(135deg, #3288AC, #286D8A);
    border: none;
    /*border: 1px solid #32ac93;*/
}

.cancel-btn {
    background: linear-gradient(135deg, #ff8073, #e74c3c);
    border: none;
    /*border: 1px solid #e74c3c;*/
}

#teacher-home-svg {
    height: 24px;
    width: 24px;
}

#confirm-button:disabled,
#new-search-button:disabled,
#new-search-button:disabled,
#cancel-button:disabled,
#new-task-button:disabled,
#delete-task-button:disabled,
#delete-student-button:disabled {
    opacity: 0.6;
    background: linear-gradient(135deg, #95a5a6, #aeb4b5);
    cursor: not-allowed;   
}

button:disabled.teacher-action-btn::before,
button:disabled.student-action-btn::before,
button:disabled.confirm-btn::before,
button:disabled.new-search-btn::before,
button:disabled.new-search-btn::before,
button:disabled.cancel-btn::before {
    background: transparent !important;
    pointer-events: none; /* ensures no interaction with pseudo-element */
}

#confirmation-buttons-container {
    animation: slideIn 0.3s ease-out;
}

.active-summary-button {
  position: relative;
  letter-spacing: 0.01em;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  /*box-shadow: 
    0 1px 2px rgba(0, 0, 0, 0.2),
    0 4px 12px rgba(50, 136, 172, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);*/
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-5px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#student-stats-graph-holder {
    flex-wrap: wrap;
    width: 100%;
    flex-direction: column;
    min-width: 0;
    gap: 5px
}

 .input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            overflow: hidden;
        }

        .control-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #333;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: #f0e5d6;
        }

        .control-btn:active {
            background: #e6dbc6;
        }

        .timer-input, .question-number-input {
            padding: 0.5rem;
            font-size: 1rem;
            width: 55px;
            border: 0;
            margin: 0;
            outline: none;
            background: #FAF1E6;
            text-align: center;
            -moz-appearance: textfield;
        }

        /* Hide number input spinners */
        .timer-input::-webkit-outer-spin-button,
        .timer-input::-webkit-inner-spin-button,
        .question-number-input::-webkit-outer-spin-button,
        .question-number-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .timer-label {
            font-size: 1rem;
            color: #333;
            margin: 0;
            font-weight: 500;
        }
   
#delete-task-button-label,
#create-task-button-label,
#delete-student-button-label {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
}

.two-rows-button-label {
    flex-direction: column !important;
    gap: 0 !important;
    flex-wrap: nowrap !important;
}

.btn-label span {
    display: flex;
    justify-content: center;
    align-items: center;
}

.btn-label svg {
    height: 30px;
    width: 30px;
}

#delete-task-button svg {
    height: 32px;
    width: 32px;
}

#frequent-mistakes-btn svg {
    height: 35px;
    width: 35px;
}

#new-task-button,
#delete-task-button,
#delete-student-button,
#browse-task-history-button,
#frequent-mistakes-btn,
.teacher-home-button,
.edit-name-button {
  position: relative;
  overflow: visible; /* allow tooltip outside button */
}

#new-task-button::before,
#delete-task-button::before,
#delete-student-button::before,
#browse-task-history-button::before,
#frequent-mistakes-btn::before,
.teacher-home-button::before,
.edit-name-button::before {
  position: absolute;
  top: 110%;        /* above the button */
  left: 50%;
  transform: translateX(-50%);
  display: inline-block; /* << important: allow width/height to fit text */
  background: #333;
  color: white;
  padding: 4px 6px;   /* padding around text */
  border-radius: 6px;
  font-size: 14px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease, transform 0.2s ease;
  z-index: 9999;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  width: max-content;
  height: max-content;
  font-weight: normal;
  text-transform: none;
}

#new-task-button::before {
    content: "Nauja užduotis";
}

#delete-task-button::before {
    content: "Trinti užduotis";
}

#delete-student-button::before {
    content: "Šalinti mokinius";
}

#browse-task-history-button::before {
    content: "Rezultatų archyvas";
}

#frequent-mistakes-btn::before {
    content: "Paskutinės klaidos";
}

.teacher-home-button::before {
    content: "Klasės apžvalga";
}

.edit-name-button::before {
    content: "Keisti vardą";
}


#new-task-button:hover::before,
#delete-task-button:hover::before,
#delete-student-button:hover::before,
#browse-task-history-button:hover::before,
.edit-name-button:hover::before {
  opacity: 1;
  transform: translateX(-50%) translateY(-4px); /* optional slight slide */
}

.teacher-home-button:hover::before {
  opacity: 1;
  transform: translateX(-15%) translateY(10px); /* optional slight slide */
}

#frequent-mistakes-btn:hover::before {
  opacity: 1;
  transform: translateX(-60%) translateY(-4px); /* optional slight slide */
}

/*OVERRIDE HOVER ON MOBILE AS IT STAYS THERE UNTILL NEXT CLICK*/
@media (hover: none) and (pointer: coarse) {
  #new-task-button::before,
  #delete-task-button::before,
  #delete-student-button::before,
  #browse-task-history-button::before,
  #frequent-mistakes-btn::before,
  .teacher-home-button:hover::before,
  .edit-name-button:hover::before {
    display: none !important;
  }
}


    .filter-label {
        font-weight: 600;
        color: #4a4a4a;
        margin-bottom: 12px;
        display: block;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .button-group-metrics {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }

    .btn-subject {
        position: relative;
        padding: 10px 20px;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 14px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
        color: #333;
        text-transform: uppercase;
    }

    .btn-subject::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
    border-radius: 14px;
    pointer-events: none;
    transition: background 0.3s ease;
    }

    .mode_choice_11_div {
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-subject::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 14px;
    padding: 1px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
    }

    .btn-subject:hover:not(:disabled):not(.active) {
        background: rgba(255, 255, 255, 0.4);
    }

    .btn-subject.active {
        color: #F5F5F7;
        background: linear-gradient(135deg, #A0C58F, #32ac93);
    }

    .btn-metric {
        position: relative;
        padding: 10px 20px;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.3s ease;
        color: #333;
        text-transform: capitalize;
    }

    .btn-metric::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
    border-radius: 20px;
    pointer-events: none;
    transition: background 0.3s ease;
    }

    .btn-metric::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 20px;
    padding: 1px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
    }

    .btn-metric:hover:not(:disabled):not(.active) {
        background: rgba(255, 255, 255, 0.4);
    }

    .btn-metric:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    button[data-metric-id="0"].active {
        background-color: #286D8A;
        color: #F5F5F7;
    }

    button[data-metric-id="1"].active {
        background-color: #32ac93;
        color: #F5F5F7;
    }

    button[data-metric-id="2"].active {
        background-color: #e74c3c;
        color: #F5F5F7;
    }

    button[data-metric-id="3"].active {
        background-color: #F28C28;
        color: #F5F5F7;
    }

    button[data-metric-id="4"].active {
        background-color: #8b5cf6;
        color: #F5F5F7;
    }

    button[data-metric-id="5"].active {
        background-color: #ec4899;
        color: #F5F5F7;
    }

    button[data-metric-id="6"].active {
        background-color: #06b6d4;
        color: #F5F5F7;
    }

    button[data-metric-id="7"].active {
        background-color: #84cc16;
        color: #F5F5F7;
    }

    /* Enhanced chart container with fixed header */
    .chart-container {
        position: relative;
        height: 350px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 20px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        width: 100%;
    }

    .chart-body {
        flex: 1;
        position: relative;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        width: 100%;
    }

    .chart-scrollable {
        position: relative;
        height: 100%;
    }
    
    #statsChart {
        width: 100% !important;
        height: 100% !important;
    }

    .chart-scroll-indicator.hidden {
        opacity: 0;
    }

    .info-box {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 15px;
        margin-top: 20px;
        border-radius: 20px;
    }

    .info-box p {
        color: #1a1a1a;
        font-size: 13px;
        line-height: 1.6;
    }

    .student-name-id-holder {
        display: inline-block;   /* or block if needed */
        min-width: 0;
        max-width: 100%;         /* stay within parent */
        word-wrap: break-word;   /* wrap long text */
        white-space: normal;     /* allow wrapping */
        width: auto;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        flex: 1 1 auto;
    }

    .edit-name-button{
        flex: 0 0 auto;
        cursor: pointer;
    }

    .student-name-id-holder span {
        display: inline;         /* keep inline for name and ID */
    }

    #student-name {
        margin-right: 5px;
        display: flex;
        min-width: 0;
        white-space: normal;
        word-break: break-word;
    }

    .student-name-field {
        font-weight: 800;
        font-size: 1.5rem;
        border: none;
        width: auto;
        min-width: 3ch;
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 20px;
        border: none;
        padding: 0 8px;
        max-width: 100%;
        margin-right: 5px;
        flex: 1 1 auto;
    }

    #student-id {
        flex: 1 0 auto;
        min-width: 0;
        white-space: normal;
        word-break: break-word;
    }

    .student-name-field:focus,
    .student-name-field:active {
        border: none;
        outline: none;
    }

    .selected-text-task-info-for-teachers-item {
        text-transform: uppercase;
        cursor: pointer;
    }

    .selected-text-task-info-for-teachers-item:hover {
        text-decoration: underline;
    }

    /* Dropdown Controls */
.filter-section {
    display: flex;
    gap: 10px;
    margin-bottom: 5px;
    max-width: 100%;
}

.item-display-none-lock {
    display: none !important;
}

.dropdown-container {
    position: relative;
}

.dropdown-container:first-child {
    flex: 1 1 200px;
    min-width: 180px;
}

.dropdown-container:last-child {
    flex: 2 1 300px;
    min-width: 200px;
}

#subjectDropdownBtn,
#metricsDropdownBtn {
    width: 100%;
    padding: 10px 16px;
    border: none;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: #333;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s;
    text-align: left;
    min-height: 42px; /* Add this - ensures consistent height */
    height: auto; /* Add this */
}

#subjectDropdownText,
#metricsDropdownText {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1; /* Add this to prevent text from pushing the icon */
    min-width: 0; /* Add this to allow text truncation */
}

#subjectDropdownBtn {
    font-size: 0.95rem;
    font-weight: 600;
}

#subjectDropdownText {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    text-transform: uppercase;
}

#metricsDropdownText {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

#subjectDropdownIcon,
#metricsDropdownIcon {
    flex-shrink: 0;
    margin-left: 8px;
    transition: transform 0.2s;
}

#subjectDropdownMenu,
#metricsDropdownMenu {
    display: none;
    position: absolute;
    top: calc(100% + 5px);
    left: 0;
    right: 0;
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    background: rgba(255, 255, 255, 0.95);
    border-radius: 14px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    overflow: hidden;
    animation: dropdownSlide 0.2s ease-out;
}

/* Dropdown menu items */
.dropdown-menu-item {
    padding: 12px 16px;
    cursor: pointer;
    background: transparent;
    transition: background 0.2s;
    font-size: 0.9rem;
    font-weight: 500;
    color: #333;
    text-transform: uppercase;
}

.dropdown-menu-item:hover {
    background: rgba(0, 0, 0, 0.05);
}

.dropdown-menu-item.active {
    background: rgba(50, 172, 147, 0.2);
    font-weight: 600;
}

.metric-menu-item {
    padding: 12px 16px;
    cursor: pointer;
    background: transparent;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.metric-menu-item:hover {
    background: rgba(0, 0, 0, 0.05);
}

.metric-checkbox {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 2px solid;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
}

.metric-menu-item span {
    font-size: 0.9rem;
    font-weight: 500;
    color: #333;
}

.task-history-chart-wrapper {
    position: relative;
    height: 350px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 20px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    width: 100%;
}

.task-history-date-input {
    padding: 10px 16px;
    padding-right: 36px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    font-size: 0.9rem;
    color: #333;
    transition: all 0.2s;
    font-family: inherit; /* ADD THIS */
    cursor: pointer;
    caret-color: transparent;
}

.lt-date-input-wrapper {
    position: relative;
    display: inline-flex;
    align-items: center;
    width: 100%;
}

.lt-date-input-wrapper .task-history-date-input {
    width: 100%;
}

.lt-date-calendar-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    opacity: 0.45;
    display: flex;
    align-items: center;
}

/* Customize month/year header font size via this class */
.lt-date-month-year {
    font-size: 1.15rem;
}

.lt-date-btn-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 8px 4px;
}

.lt-date-btn {
    border: none;
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 0.8rem;
    font-family: inherit;
    cursor: pointer;
    transition: background 0.2s;
}

.lt-date-btn-today {
    background: rgba(50, 136, 172, 0.15);
    color: #286D8A;
}

.lt-date-btn-today:hover {
    background: rgba(50, 136, 172, 0.28);
}

.lt-date-btn-clear {
    background: rgba(0, 0, 0, 0.07);
    color: #555;
}

.lt-date-btn-clear:hover {
    background: rgba(0, 0, 0, 0.13);
}

.task-history-date-input::-webkit-calendar-picker-indicator {
    cursor: pointer;
    filter: invert(0.5);
}

.task-history-date-input:focus {
    outline: none;
    border-color: rgba(255, 255, 255, 0.5);
}

.task-history-date-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1 1 auto;
}

.task-history-date-label {
    font-weight: 600;
    font-size: 0.85rem;
    color: #4a4a4a;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.task-history-dropdown-container {
    position: relative;
    flex: 1 1 50%;
}

#taskHistoryMetricsBtn {
    width: auto;
    padding: 10px 16px;
    border: none;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: #333;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s;
    text-align: left;
    min-height: 42px;
    height: auto;
    width: 100%;
}

.task-history-controls {
    flex: 1 1 auto;
}

.task-history-controls-outer {
    display: flex;
    align-items: end;
    margin-bottom: 15px;
    gap: 10px;
    flex-wrap: wrap;
}

#taskHistoryMetricsText {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
    min-width: 0;
}

#taskHistoryMetricsIcon {
    flex-shrink: 0;
    margin-left: 8px;
    transition: transform 0.2s;
}

#taskHistoryMetricsMenu {
    display: none;
    position: absolute;
    top: calc(100% + 5px);
    left: 0;
    right: 0;
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    background: rgba(255, 255, 255, 0.95);
    border-radius: 14px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    overflow: hidden;
    animation: dropdownSlide 0.2s ease-out;
}

.task-history-metric-item {
    padding: 12px 16px;
    cursor: pointer;
    background: transparent;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.task-history-metric-item:hover {
    background: rgba(0, 0, 0, 0.05);
}

.task-history-metric-checkbox {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 2px solid;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
}

.task-history-metric-item span {
    font-size: 0.9rem;
    font-weight: 500;
    color: #333;
}

.task-history-date-selector {
    display: flex;
    gap: 10px;
}

.task-history-container {
    display: flex;
    flex-direction: column;
}

.latest-mistakes-summary-holder {
    max-height: 50vh;
    overflow-y: auto;
}

.task-label-expandable {
    cursor: pointer;
}

.task-label-expand-icon {
    opacity: 0.5;
    font-size: 1rem;
}

.task-label-grammar {
    opacity: 0.75;
    font-style: italic;
}


    @media (max-width: 1999px) {
        #teacher-message-line,
        #teacher-data-retrieval-message,
        #student-message {
            margin-right: 8vw;
        }
    }

    @media (max-width: 992px) {
        .sidebar-wrapper,
        .left-side-bar {
            flex: 1 1 50%;
        }
    }

    /* Desktop: sidebar always visible, hide toggle */
    @media (min-width: 769px) {
      .toggle-tab {
        display: none;
      }
    }

    /* Mobile: collapsible sidebar */
    @media (max-width: 768px) {

        #content-container {
            max-height: none;
            min-height: none;
        }


        #student-task-info-container {
                padding-left: 0;
            }

            #teacher-button-holder-outer {
                display: flex;
                justify-content: end;
            }

            .teacher-button-holder {
                width: 92%;
            }

            #action-buttons-container, 
            #confirmation-buttons-container {
                gap: 8px;
            }

            #student-task-info-container-inner {
                padding: 15px;
            }
            
            #content-container {
                margin: 0;
                flex: 1;
                width: 100vw;
                justify-content: start;
                background: transparent;
                border: none;
                box-shadow: none
            }

            #teacher-gui {
                align-items: center;
            }

            .left-side-bar {
                height: 100%;
                background: transparent;
                border-right: none;
                border-radius: 0;
            }

            .dropdown {
                margin: 7px 0;
            }

            #dynamic-student-content {
                padding-left: 0;
            }

            #timer-input,
            #question-number-input {
                font-size: 1.1rem;
            }

            .timer-choice-label, 
            .answer-number-label {
                font-size: 1.25rem;
            }

      .sidebar {
        padding: 16px;
        height: 100%;
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        background: rgba(255, 255, 255, 0.5);
        border-bottom-right-radius: 8px;
        margin: 0;
        margin-top: 0;
      }

      .sidebar-wrapper {
        position: fixed;
        left: 0;
        top: 95px;
        height: calc(100% - 80px - 30px);
        width: calc(100vw - 34px - 5px);
        z-index: 100;
        transition: transform 0.3s ease;
        transform: translateX(calc(-1*(100vw - 34px - 5px)));
        padding-left: 0;
      }

      .sidebar-wrapper.open {
        transform: translateX(0);
      }

      .sidebar-wrapper.open .toggle-tab svg {
        transform: rotate(180deg);
      }

      .main-content {
        padding: 1.5rem;
        width: 100%;
      }

      /* Overlay */
      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99;
      }

      .overlay.active {
        display: block;
      }

    .timer-input, .question-number-input {
            pointer-events: none;
        }
        
    /* Re-enable for buttons */
    .control-btn {
        pointer-events: auto;
    }

    #complete-task-button {
        padding: 10px 16px;
    }

    #summary-table-frequent-mistakes table {
        border-color: transparent;
    }

    th,
    td {
        background-color: rgba(255, 255, 255, 0.8);
    }

    .summary-table-frequent-mistakes-outer-div th,
    .summary-table-frequent-mistakes-outer-div td {
        background-color: transparent;
    }

    .summary-table-frequent-mistakes-outer-div .table-container {
        box-shadow: none;
    }

    .summary-table-frequent-mistakes-outer-div td:first-child {
        padding-left: 0;
        padding-right: 0;
    }

    #knowledge-level-select {
        background: rgba(255, 255, 255, 0.8);
    }

    .student-statistics-title {
        border-top: 2px solid rgba(255, 255, 255, 1);
    }

    #student-statistics-completed-tasks {
        border-top: 2px solid rgba(255, 255, 255, 1);
        font-size: 1.15rem;
    }

    tr:last-child td {
    padding-bottom: 10px;
    }

    .filter-section {
        width: 100%;
        flex-wrap: wrap;
    }

    #subjectDropdownBtn,
    #metricsDropdownBtn {
        background: rgba(255, 255, 255, 1);
    }
            
    .button-group {
        gap: 8px;
    }
    
    .chart-container {
        height: 400px;
        padding: 15px;
        border-radius: 15px;
    }
    
    .info-box {
        padding: 12px;
        margin-top: 15px;
    }
    
    .info-box p {
        font-size: 12px;
    }
    
    .chart-scroll-indicator {
        display: none;
    }

    .btn-metric,
    .btn-subject {
        background: rgba(255, 255, 255, 0.8);
    }

    .chart-container {
        background: rgba(255, 255, 255, 0.8);
        padding: 10px 3px;
    }

    .chart-container {
        height: 300px;
    }

    .task-history-container {
        gap: 10px;
    }
    
    .task-history-chart-wrapper {
        padding: 15px;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.8);
    }
    
    .task-history-date-input,
    #taskHistoryMetricsBtn {
        background: rgba(255, 255, 255, 1);
    }
}

    @media (max-width: 578px) {
            html,
            body {
                width: 100vw;
            }

            #group_name,
            #mode_choice,
            #mode_choice_1,
            #mode_choice_2,
            #mode_choice_3,
            #mode_choice_4,
            #mode_choice_5,
            #mode_choice_6,
            #mode_choice_7,
            #mode_choice_8,
            #mode_choice_9,
            #mode_choice_10,
            #mode_choice_13,
            #mode_choice_14,
            #mode_choice_15,
            #class_choice {
                font-size: 1.1rem;
            }

            .initial-button-div {
                width: 100%;
            }

            .confirmation-button-div {
                width: 100%;
                margin: 0;
            }

            #confirm-delete-task-button {
                margin-bottom: 15px;
            }

            #confirm-delete-student-button {
                margin-bottom: 15px;
            }

            .teacher-button-line {
                flex-direction: column;
            }

            #teacher-message-line,
            #teacher-data-retrieval-message {
                margin-bottom: 15px;
            }

        #student-task-group-for-student {
            font-size: 1.25rem;
        }

         .mistakes-summary-forstudents-title {
            font-size: 1.25rem;
        }
        .student-points {
            font-size: 1.25rem;
            padding-top: 0.25rem;
        }

        .btn-subject {
            font-size: 0.75rem;
        }

        .btn-metric {
            font-size: 0.8rem;
        }

        .chart-container {
            height: 200px;
        }

        #knowledge-level-select {
            width: 100px;
        }

        .dropdown-container,
        .dropdown-container:first-child,
        .dropdown-container:last-child {
            flex: 1 1 100% !important;
            min-width: 100% !important;
        }

        .task-history-chart-wrapper {
            padding: 10px;
        }

        th:first-child, 
        th:nth-child(2) {
            width: 37%;
        }

        th:nth-child(3) {
            width: 26%;
        }

    }


.text-comprehenstion-text-id:hover {
    text-decoration: underline;
    cursor: pointer;
}

.txt-browser-wrapper {
    max-width: 1200px;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 20px;
    overflow: hidden;
    margin-top: 16px;
    width: 100%;
}

.txt-browser-main-header {
    background: rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    padding: 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
    transition: background 0.2s;
}

.txt-browser-main-title {
    font-size: 1.5rem;
    font-weight: 600;
    text-transform: uppercase;
    margin: 0;
}

.txt-browser-main-icon {
    transition: transform 0.3s;
    font-size: 1.5rem;
    display: flex;
}

.txt-browser-main-icon svg {
    height: 30px;
    width: 30px;
}

.txt-browser-main-icon:not(.collapsed) {
    transform: rotate(180deg);
}


.txt-browser-content {
    height: 0;
    overflow: hidden;
    transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: none;
    width: 100%; /* Prevent width changes */
}

.txt-browser-content.expanded {
    display: block;
}

.txt-viewer-container {
    background: transparent;
    border-radius: 0;
    box-shadow: none;
    overflow: visible;
    display: flex;
    flex-direction: column;
    min-height: 0;
}

.txt-viewer-sticky-header {
    z-index: 100;
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
    padding: 15px;
    flex: 0 0 auto;
}

.txt-viewer-selected-ids-container {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    padding: 12px;
    display: none;
    height: 90px;
    min-height: 90px;
    overflow-y: auto;
}

.txt-viewer-selected-ids-container-outer {
    padding: 15px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
}

.txt-viewer-selected-ids-container.txt-viewer-visible {
    display: block;
}

.txt-viewer-selected-ids-label {
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 14px;
    text-transform: uppercase;
}

.txt-viewer-selected-ids-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.txt-viewer-selected-id-chip {
    background: #3288AC;
    color: white;
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 13px;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}


.txt-viewer-selected-id-chip .txt-viewer-remove {
    font-weight: bold;
    font-size: 16px;
}

.txt-viewer-search-input {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    font-size: 16px;
    transition: border-color 0.2s;
    margin-bottom: 15px;
}

.txt-viewer-search-input:focus,
.txt-viewer-search-input:active {
    outline: none;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

/* Unified filters section */
.txt-viewer-all-filters-wrapper {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    overflow: hidden;
}

.txt-viewer-all-filters-header {
    padding: 12px 16px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    user-select: none;
    transition: background 0.2s;
}

.txt-viewer-all-filters-icon svg {
    height: 24px;
    width: 24px;
}

.txt-viewer-all-filters-icon {
    transition: transform 0.3s;
    display: flex;
}

.txt-viewer-all-filters-icon.txt-viewer-collapsed {
    transform: rotate(-180deg);
}

.txt-viewer-all-filters-content {
    max-height: 500px;
    overflow: hidden;
    transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    padding: 16px;
    display: flex;
    flex-wrap: wrap;
}

.txt-viewer-all-filters-content.txt-viewer-collapsed {
    max-height: 0;
    padding: 0 16px;
}

.txt-viewer-filter-group {
    margin-bottom: 15px;
    flex: 1 1 auto;
}

.txt-viewer-filter-group:last-child {
    margin-bottom: 0;
}

.txt-viewer-filter-label {
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.txt-viewer-filter-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.txt-viewer-filter-option {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 6px;
    border-radius: 8px;
    transition: background 0.2s;
}

.txt-viewer-filter-option:hover {
    background: rgba(255, 255, 255, 0.5);
}

.txt-viewer-filter-option input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.txt-viewer-filter-option label {
    cursor: pointer;
    font-size: 14px;
    flex: 1;
}

.txt-viewer-texts-list {
    padding: 15px;
    flex: 1 1 auto;
    min-height: 0;
    overflow: auto;
}

.txt-viewer-text-item {
    margin-bottom: 12px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 20px;
}

.text-item-expanded {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.txt-viewer-text-item-header {
    padding: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: background 0.2s;
}

.txt-viewer-text-item-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.txt-viewer-text-item-main {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
}

.txt-viewer-text-item-info {
    flex: 1;
}

.txt-viewer-text-item-id {
    color: #3288AC;
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
}

.txt-viewer-text-item-title {
    font-weight: 500;
    font-size: 16px;
}

.txt-viewer-text-item-expand-icon {
    transition: transform 0.3s;
    color: #666;
    display: flex;
}

.txt-viewer-text-item-expand-icon svg {
    height: 24px;
    width: 24px;
}

.txt-viewer-text-item-expand-icon.txt-viewer-expanded {
    transform: rotate(180deg);
}

.txt-viewer-text-item-details {
    padding: 0 16px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, padding 0.3s ease-out;
}

.txt-viewer-text-item-details.txt-viewer-expanded {
    max-height: 2000px;
    padding: 16px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    flex: 1 1 auto;
    overflow: auto;
}

.text-detail-row {
    margin-bottom: 16px;
}

.text-detail-label {
    font-weight: 600;
    color: #666;
    font-size: 13px;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.text-detail-content {
    font-size: 15px;
    line-height: 1.6;
}

.text-section {
    margin-bottom: 12px;
}

.text-section-title {
    font-weight: 600;
    color: #3288AC;
    font-size: 14px;
}

.text-section-paragraph {
    margin-bottom: 8px;
    white-space: pre-line;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 8px;
    padding: 5px 10px;
}

#student-task-history-container,
.task-history-container {
    height: 100%;
    width: 100%;
}

.text-section-paragraph:last-child {
    margin-bottom: 0;
}

.txt-viewer-no-results {
    text-align: center;
    padding: 40px;
    color: #666;
    font-size: 16px;
}

.badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    margin-right: 6px;
    margin-bottom: 6px;
}

.badge-class-lower {
    background: #e1f5fe;
    color: #A0C58F;
}

.badge-class-higher {
    background: #e1f5fe;
    color: #01579b;
}

.badge-struktura {
    background: #f3e5f5;
    color: #4a148c;
}

.badge-komponavimas {
    background: #fff3e0;
    color: #e65100;
}


.dropdown-wrapper {
    position: relative;
    display: inline-block;
    margin: 15px 0;
}

.dropdown-toggle {
    padding: 6px 12px;
    border: 1px solid #aaa;
    background: #f8f8f8;
    cursor: pointer;
    border-radius: 4px;
    font-size: 14px;
}

.dropdown-menu {
    position: absolute;
    top: calc(100% + 5px);
    left: 0;
    z-index: 999;
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    background: rgba(255, 255, 255, 0.5);
    width: 100%;
    padding: 8px;
    border-radius: 20px;
    max-height: 65vh;
    overflow-y: auto;
}

.hidden {
    display: none;
}

.dropdown-item {
    display: flex;
    align-items: center;
    padding: 4px 0;
    cursor: pointer;
}

.dropdown-item input {
    margin-right: 6px;
}

#history-view-tabs {
    display: none;
    width: 100%;
    gap: 8px;
    margin-bottom: 12px;
    padding: 0 4px;
}

.history-tab-btn {
    flex: 1;
    padding: 8px 12px;
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.2s ease;
    text-transform: uppercase;
}

.history-tab-btn.active-tab {
    background: rgba(255,255,255,0.45);
}

#task-archive-table-container {
    width: 100%;
    overflow-x: auto;
    overflow-y: auto;
    max-height: 500px;
    border-radius: 20px;
}

#task-archive-table-container table {
    table-layout: auto;
}

#task-archive-table-container th,
#task-archive-table-container td {
    white-space: nowrap;
    text-align: center;
    padding: 6px 6px;
}

#task-archive-table-container td:nth-child(2) {
    white-space: normal;
    text-align: left;
    max-width: 180px;
    overflow-wrap: break-word;
}

.task-archive-empty {
    text-align: center;
    padding: 20px;
    opacity: 0.6;
    font-style: italic;
}

#task-archive-date-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 16px;
}

#task-archive-view {
    flex-direction: column;
    width: 100%;
}

#task-archive-view {
    flex-direction: column;
    width: 100%;
    min-height: 0;
}

#task-archive-table-container {
    border: 1px solid rgba(255, 255, 255, 0.3);
}

#task-archive-table-container thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    background: rgba(255, 200, 150, 0.85);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
}

#task-archive-table-container table {
    table-layout: auto;
    border-collapse: separate;
    border-spacing: 0;
    overflow: visible;
    height: auto;
}

#task-archive-table-container tbody td::before {
    display: none;
}

@keyframes dropdownSlide {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.sentence-occurrence {
    white-space: pre-wrap;
    word-wrap: break-word;
}

@media (max-width: 768px) {
    .txt-viewer-sticky-header {
        padding: 15px;
    }

    .txt-viewer-texts-list {
        padding: 15px;
    }

    .txt-viewer-filter-options {
        grid-template-columns: 1fr;
    }


    .txt-viewer-search-input,
    .txt-viewer-all-filters-wrapper,
    .txt-viewer-selected-ids-container,
    .txt-viewer-text-item {
        background: rgba(255, 255, 255, 0);
        border: 1px solid rgba(255, 255, 255, 1);
    }

    .txt-viewer-sticky-header {
        border-bottom: 2px solid rgba(255, 255, 255, 1);
    }

    .txt-viewer-selected-ids-container-outer {
        border-bottom: 2px solid rgba(255, 255, 255, 1);
    }

    .text-section-paragraph {
        background: rgba(255, 255, 255, 1);
        border: 1px solid rgba(255, 255, 255, 1);
    }

    .txt-browser-main-header {
        background: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.7);
        padding: 15px;
    }

    .txt-browser-main-title {
        font-size: 1.25rem;
    }

    #task-archive-table-container thead th {
        background: rgba(255, 200, 150, 1);
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
    }

    .history-tab-btn.active-tab {
        background: rgba(255, 200, 150, 1);
        border: 1px solid rgba(255, 200, 150, 0.3);
    }

    thead tr:first-child th {
        background-color: rgba(255, 200, 150, 0.85);
    }
}

@media (min-device-width: 768px) and (max-device-width: 1200px) and (orientation: portrait)  {
        #content-container {
            max-height: none;
            min-height: none;
        }

        .toggle-tab {
            right: -38px;
            width: 38px;
            height: 80px;
        }

        .sidebar-wrapper {
            width: calc(100vw - 38px - 5px);
            transform: translateX(calc(-100vw - 38px - 5px));
        }

        #group_name, #mode_choice, #mode_choice_1, #mode_choice_2, #mode_choice_3, #mode_choice_4, #mode_choice_5, #mode_choice_6, #mode_choice_7, #mode_choice_8, #mode_choice_9, #mode_choice_10, #mode_choice_13, #mode_choice_14, #mode_choice_15, #class_choice {
            font-size: 1.6rem;
        }

        #timer-input, #question-number-input {
            font-size: 1.6rem;
            width: 70px;
        }

        input[type="checkbox"] {
            transform: scale(1.5);
        }

        #teacher-home-svg {
            height: 36px;
            width: 36px;
        }

        #subjectDropdownBtn, 
        #metricsDropdownBtn {
            font-size: 1.25rem;
        }

        #frequent-mistakes-btn svg {
            height: 46px;
            width: 46px;
        }

        #task-group-sorting {
            font-size: 1.65rem;
        }

        #task-group-count {
            font-size: 1.25rem;
        }

        .txt-viewer-text-item-id {
            font-size: 18px;
        }

        .txt-viewer-text-item-title {
            font-size: 20px;
        }

        .badge {
            font-size: 16px;
        }

        .text-section-title {
            font-size: 17px;
        }

        .text-section-paragraph {
            font-size: 20px;
        }

        .text-detail-content {
            font-size: 18px;
        }

        .txt-viewer-search-input {
            font-size: 18px;
        }

        .txt-viewer-filter-label {
            font-size: 17px;
        }

        .txt-viewer-filter-option label {
            font-size: 17px;
        }

        .student-action-btn {
            padding: 32px 30px;
        }

        .left-side-bar {
            padding: 35px;
        }


        body {
            font-size: 1.5rem;
        }

        #new-task-button,
        #delete-task-button,
        #delete-student-button,
        #confirm-delete-task-button,
        #confirm-delete-student-button,
        #submitButton,
        #add-teacher,
        #change-teacher,
        #confirm-button,
        #new-search-button,
        #cancel-button,
        #frequent-mistakes-btn,
        .display-summary-button {
            font-size: 1.5rem;
        }

        #add-change-teacher-buttons {
            margin: 10px 0 30px 0;
        }

        #complete-task-button {
            font-size: 1.4rem;
        }

        #student-message {
            margin-right: 0;
        }

        #teacher-name {
            font-size: 1.75rem;
        }

        .form-control {
            font-size: 1.75rem;
        }

        .menu ul li a {
            font-size: 1.75rem;
        }

        .menu {
            width: 160px;
        }

        .reset-button {
            width: 6rem;
            height: 6rem;
        }

        .sidebar {
        padding: 16px;
        height: 100%;
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        background: rgba(255, 255, 255, 0.5);
        border-bottom-right-radius: 8px;
        margin: 0;
      }

      .sidebar-wrapper {
        position: fixed;
        left: 0;
        top: 134px;
        height: calc(100% - 100px - 70px);
        width: calc(100vw - 34px - 5px);
        z-index: 100;
        transition: transform 0.3s ease;
        transform: translateX(calc(-1*(100vw - 34px - 5px)));
        padding-left: 0;
      }

      .sidebar-wrapper.open {
        transform: translateX(0);
      }

      .sidebar-wrapper.open .toggle-tab svg {
        transform: rotate(180deg);
      }

      .main-content {
        padding: 1.5rem;
        width: 100%;
      }

    .toggle-tab {
        display: flex;
      }

       #student-task-info-container {
                padding-left: 0;
            }

            #teacher-button-holder-outer {
                display: flex;
                justify-content: end;
            }

            .teacher-button-holder {
                width: 92%;
            }

            #action-buttons-container, 
            #confirmation-buttons-container {
                gap: 8px;
            }

            #student-task-info-container-inner {
                padding: 15px;
            }
            
            #content-container {
                margin: 0;
                flex: 1;
                width: 100vw;
                justify-content: start;
                background: transparent;
                border: none;
                box-shadow: none
            }

            #teacher-gui {
                align-items: center;
            }

            #text-browser-button {
                font-size: 1.5rem;
            }

            table * {
                font-size: 1.5rem;
            }

            .grammar-view-selector {
                font-size: 1.5rem;
            }

            th,
            td {
                background-color: rgba(255, 255, 255, 0.8);
            }

            .student-action-btn {
                flex: 0 0 auto;
                width: auto;
            }

            #knowledge-level-select {
                background: rgba(255, 255, 255, 1);
                font-size: 1.5rem;
            }

    .student-statistics-title {
        border-top: 2px solid rgba(255, 255, 255, 1);
    }

    #student-statistics-completed-tasks {
        border-top: 2px solid rgba(255, 255, 255, 1);
    }

    .student-name-field,
    #student-task-student-name {
        font-size: 2rem;
    }

    .edit-icon img {
        height: 24px;
        width: 24px;
    }
    }

    </style>
</head>

<body>
    <div id="customConfirmModal" class="modal">
    <div class="modal-content">
        <p id="customModalText"></p>
        <div class="modal-buttons">
        <button id="customConfirmYes" class="btn btn-confirm">Taip</button>
        <button id="customConfirmNo" class="btn btn-cancel">Ne</button>
        </div>
    </div>
    </div>

    <div id="object-popup" class="object-popup-overlay" style="display:none;">
    <div class="object-popup-panel">
        <button class="object-popup-close">&times;</button>
        <div class="title-subtitle-inline-button-wrapper">
        <div class="object-popup-title-subtitle-wrapper">
        <div class="object-popup-title" id="object-popup-title"></div>
        <div class="object-popup-subtitle" id="object-popup-subtitle"></div>
        </div>
        </div>
        <div class="object-popup-content" id="object-popup-content">
        <!-- Dynamic content goes here -->
        </div>
    </div>
    </div>

   <nav class="main-navbar" id="mainNavbar">
        <div class="main-nav-container">
            <!-- Logo -->
            <a href="#" class="main-nav-logo">
                <div class="main-nav-logo-icon">
                 <img id="sudedu-main-nav-bar-logo" src="../images/sudedu_logo.png" alt="sudEdu">
                </div>
            </a>

            <!-- Desktop Navigation -->
            <div class="main-nav-links invisible">
                <a href="index.html" class="main-nav-link">Praktika</a>
                <a href="uzduotys.html" class="main-nav-link main-nav-link-active">Užduotys</a>
                <a href="klase.html" class="main-nav-link">Klasė</a>
                <a href="augintiniai.html" class="main-nav-link">Augintiniai</a>
                <a href="apie.html" class="main-nav-link">Instrukcijos</a>
                
                <div class="main-nav-language-dropdown" id="languageDropdown">
                    <button class="main-nav-language-btn" id="languageBtn">
                        <span id="currentLanguage">LT</span>
                        <span class="main-nav-language-arrow"></span>
                    </button>
                    <div class="main-nav-language-menu">
                        <button class="main-nav-language-option selected" data-lang="LT">LT</button>
                        <button class="main-nav-language-option" data-lang="EN">EN</button>
                    </div>
                </div>
                
                
                <div class="main-nav-connect-wrapper">
                    <div class="main-nav-connect-glow"></div>
                    <button class="main-nav-log-out-btn">
                        <span class="main-nav-connect-text">Atsijungti</span>
                    </button>

                    <button class="main-nav-log-in-btn">
                        <span class="main-nav-connect-text">Prisijungti</span>
                    </button>
                </div>
            </div>

            <!-- Mobile Button -->
            <button class="main-nav-mobile-btn" id="mainNavMobileBtn">
                <span class="main-nav-hamburger"></span>
                <span class="main-nav-hamburger"></span>
                <span class="main-nav-hamburger"></span>
            </button>

            <!-- Mobile Menu -->
            <div class="main-nav-mobile-menu" id="mainNavMobileMenu">
                <a href="index.html" class="main-nav-mobile-link">Praktika</a>
                <a href="uzduotys.html" class="main-nav-mobile-link active">Užduotys</a>
                <a href="klase.html" class="main-nav-mobile-link">Klasė</a>
                <a href="augintiniai.html" class="main-nav-mobile-link">Augintiniai</a>
                <a href="apie.html" class="main-nav-mobile-link">Instrukcijos</a>
                
                <div class="main-nav-mobile-language">
                    <button class="language-option language-option-LT selected" onclick="setLanguage('LT')">LT</button>
                    <span class="language-separator">/</span>
                    <button class="language-option language-option-EN" onclick="setLanguage('EN')">EN</button>
                </div>
                
                <button class="main-nav-mobile-log-out-btn">
                    <span class="main-nav-connect-text">Atsijungti</span>
                </button>
                <button class="main-nav-mobile-log-in-btn">
                    <span class="main-nav-connect-text">Prisijungti</span>
                </button>
            </div>
        </div>
    </nav>

    <div id="content-container">
	<div class="container" id="template-container">
        <div id="inner-container">
            <!-- TEACHER GUI -->
<div id="teacher-gui" style="display: none;">

    <!-- LEFT SIDE: Student List (always visible) -->
    <div class="left-side-bar">
        <div class="left-side-bar-inner">
                <!-- Button and Message Section (stays on top, full width) -->
        <div id="teacher-button-holder-outer">
                <div class="teacher-button-holder">
                    <!-- Action buttons that transform -->
                    <div id="action-buttons-container">
                        <button id="new-task-button" class="teacher-action-btn" data-action="new-task">
                            <span id="create-task-button-label" class="btn-label">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor"><path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q65 0 123 19t107 53l-58 59q-38-24-81-37.5T480-800q-133 0-226.5 93.5T160-480q0 133 93.5 226.5T480-160q32 0 62-6t58-17l60 61q-41 20-86 31t-94 11Zm280-80v-120H640v-80h120v-120h80v120h120v80H840v120h-80ZM424-296 254-466l56-56 114 114 400-401 56 56-456 457Z"/></svg>
                            </span>
                        </button>
                        
                        <button id="delete-task-button" class="teacher-action-btn" data-action="delete-task">
                            <span id="delete-task-button-label"  class="btn-label">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor"><path d="m376-300 104-104 104 104 56-56-104-104 104-104-56-56-104 104-104-104-56 56 104 104-104 104 56 56Zm-96 180q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520Zm-400 0v520-520Z"/></svg>
                            </span>
                        </button>
                        
                        <button id="delete-student-button" class="teacher-action-btn" data-action="delete-student">
                            <span id="delete-student-button-label"  class="btn-label">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor"><path d="M819-28 680-167v7H40v-112q0-34 17.5-62.5T104-378q62-31 126-46.5T360-440q12 0 24.5.5T409-438l-42-42h-7q-66 0-113-47t-47-113v-7L27-820l57-57L876-85l-57 57ZM666-434q51 6 96 20.5t84 35.5q36 20 55 44.5t19 53.5v120h-5L755-320q-9-33-31.5-62.5T666-434Zm-306 74q-56 0-111 13.5T140-306q-9 5-14.5 14t-5.5 20v32h480v-7l-87-87q-38-13-76.5-19.5T360-360Zm202-153q19-28 28.5-60t9.5-67q0-42-14.5-81T544-792q14-5 28-6.5t28-1.5q66 0 113 47t47 113q0 66-49.5 113T595-480l-33-33Zm-58-58-64-64v-5q0-33-23.5-56.5T360-720h-5l-64-64q16-8 33-12t36-4q66 0 113 47t47 113q0 19-4 36t-12 33ZM365-240Zm33-438Z"/></svg>
                            </span>
                        </button>

                        <button id="browse-task-history-button" class="teacher-action-btn" data-action="browse-history">
                            <span id="browse-task-history-label"  class="btn-label">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor"><path d="m105-399-65-47 200-320 120 140 160-260 120 180 135-214 65 47-198 314-119-179-152 247-121-141-145 233Zm475 159q42 0 71-29t29-71q0-42-29-71t-71-29q-42 0-71 29t-29 71q0 42 29 71t71 29ZM784-80 676-188q-21 14-45.5 21t-50.5 7q-75 0-127.5-52.5T400-340q0-75 52.5-127.5T580-520q75 0 127.5 52.5T760-340q0 26-7 50.5T732-244l108 108-56 56Z"/></svg>
                            </span>
                        </button>
                    </div>
                    
                    <!-- Confirmation buttons (hidden by default) -->
                    <div id="confirmation-buttons-container">
                        <button id="confirm-button" class="confirm-btn">
                            <span id="confirm-label">Patvirtinti</span>
                        </button>
                        <button id="new-search-button" class="new-search-btn"  style="display: none;" disabled>
                            <span id="new-search-label">Nauja paieška</span>
                        </button>
                        <button id="cancel-button" class="cancel-btn">
                            <span id="cancel-label">Atšaukti</span>
                        </button>
                    </div>
                </div>
        </div>


            <div id="student-details-for-teachers">
                <div class="dropdown-wrapper">
                    <button id="task-group-sorting" class="dropdown-toggle">
                        <span id="task-group-count" class="group-count">0/0</span>
                        Užduočių grupės 
                        <span class="group-options-arrow">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
                                <path d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"></path>
                            </svg>
                        </span>
                    </button>

                    <div id="task-group-menu" class="dropdown-menu hidden"></div>
                </div>
                <div id="outer-student-list-container">
                    <div class="d-flex justify-content-between" id="student-list-header">
                        <div class="align-items-center justify-content-start" id="student-list-header-checkbox-container" style="display: none;">
                            <input type="checkbox" id="select-all-checkbox">
                            <div>pasirinkti visus</div>
                        </div>
                        <div class="align-items-center justify-content-start" id="student-list-title-container">
                            <div class="teacher-home-button selected-option">
                                <svg id="teacher-home-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#1f1f1f"><path d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z"/></svg>
                            </div>
                            <div>Mokinių sąrašas:</div>
                        </div>
                        <button type="button" id="expand-student-info-button" style="margin-left: auto;">&#x2212;</button>
                    </div>
                    <div id="student-list-container">
                    <div id="student-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- RIGHT SIDE: Collapsible Sidebar with Task Options and Info -->
        <div class="sidebar-wrapper" id="sidebarWrapper">
            <aside class="sidebar hide-scrollbar-mobile" id="sidebar">
                <div class="sidebar-content" id="sidebarContent">
                    <div id="dynamic-teacher-content">
                        <div id="history-view-tabs" style="display: none;">
                            <button class="history-tab-btn" id="history-tab-istorija" onclick="switchHistoryTab('istorija')">Užduočių istorija</button>
                            <button class="history-tab-btn active-tab" id="history-tab-progresas" onclick="switchHistoryTab('progresas')">Mokinių progresas</button>
                        </div>

                        <!-- New Task Options Container -->
                        <div id="new-task-options-container" style="display: none;">
                            <div class="new-task-input-holder">
                                <input type="text" id="group_name" placeholder="Užduočių grupės pavadinimas" class="form-control">
                            </div>

                            <div class="ode_choice_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice" id="mode_choice">
                                    <option value="math">MATEMATIKĄ</option>
                                    <option value="lang">LIETUVIŲ KALBĄ</option>
                                </select>
                            </div>

                            <div class="mode_choice_1_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_1" id="mode_choice_1">
                                    <option value="C1">SUDĖTĮ</option>
                                    <option value="C2">ATIMTĮ</option>
                                    <option value="C3">SUDĖTĮ IR ATIMTĮ</option>
                                    <option value="C4">DAUGYBĄ</option>
                                    <option value="C5">DALYBĄ</option>
                                    <option value="C6">DAUGYBĄ IR DALYBĄ</option>
                                    <option value="C7">ĮVAIRIUS VEIKSMUS</option>
                                </select>
                            </div>

                            <div class="mode_choice_2_div">
                                <div class="col-12 d-flex justify-content-center align-items-center mode_choice_2_div text-center" id="mode_choice_2_div">
                                    <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_2" id="mode_choice_2">
                                        <option value="C8">VIENAŽENKLIŲ SKAIČIŲ IKI 10</option>
                                        <option value="C9">VIENAŽENKLIŲ SKAIČIŲ IKI 20 (LENTELINĖ SUDĖTIS)</option>
                                        <option value="C10">DVIŽENKLIO IR VIENAŽENKLIO SKAIČIŲ IKI 20</option>
                                        <option value="C11">DVIŽENKLIO IR VIENAŽENKLIO SKAIČIŲ IKI 100</option>
                                        <option value="C12">DVIŽENKLIŲ SKAIČIŲ IKI 100</option>
                                        <option value="C13">SKAIČIŲ IKI 1 000</option>
                                        <option value="C14">SKAIČIŲ IKI 10 000</option>
                                        <option value="C15">SKAIČIŲ IKI 1 000 000</option>
                                    </select>
                                </div>
                            </div>

                            <div class="selected_numbers_div">
                                <div class="selected_numbers_inner_div">
                                    <label class="number-choice-label-nuo" for="selected_number" id="number_label" style="display: none;">NUO</label>
                                    <select class="btn btn-secondary dropdown-toggle dropdown text-center" name="selected_number" id="selected_number" style="display: none;">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                    </select>
                                    <label class="number-choice-label-iki" for="selected_number_2" id="number_label_2" style="display: none;">IKI</label>
                                    <select class="btn btn-secondary dropdown-toggle dropdown text-center" name="selected_number_2" id="selected_number_2" style="display: none;">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                    </select>
                                </div>
                            </div>

                            <div class="remainder-div">
                                <label id="remainder-option" style="display: none;">
                                    <input id="remainder-input" type="checkbox" name="myCheckbox"> DALYBA SU LIEKANA
                                </label>
                            </div>

                            <div class="mode_choice_3_div">
                                <div class="col-12 d-flex justify-content-center align-items-center text-center mode_choice_3_div" id="mode_choice_3_div">
                                    <select class="btn btn-secondary dropdown-toggle dropdown text-center" name="mode_choice_3" id="mode_choice_3">
                                        <option value="C37">NEPERŽENGIANT DEŠIMTIES</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mode_choice_5_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_5" id="mode_choice_5">
                                    <option value="C41">SKAITINĖ LYGYBĖ</option>
                                    <option value="C42">SKAITINĖ LYGYBĖ SU NEŽINOMUOJU</option>
                                </select>
                            </div>

                            <div class="mode_choice_6_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_6" id="mode_choice_6" style="display: none;">
                                    <option value="C43">NEŽINOMAS DĖMUO</option>
                                </select>
                            </div>

                            <div class="mode_choice_7_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_7" id="mode_choice_7" style="display: block;">
                                    <option value="C47">EILUTE</option>
                                    <option value="C48">STULPELIU / KAMPU</option>
                                </select>
                            </div>

                            <div class="mode_choice_8_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_8" id="mode_choice_8" style="display: none;">
                                    <option value="C49">TEKSTO SUPRATIMĄ</option>
                                    <option value="C83">GRAMATIKĄ</option>
                                </select>
                            </div>

                            <div class="mode_choice_9_div">
                                <div class="col-12 d-flex justify-content-center align-items-center mode_choice_9_div text-center" id="mode_choice_9_div">
                                    <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_9" id="mode_choice_9" style="display: none;">
                                        <option value="C51">TURINIO KOMPONAVIMĄ</option>
                                        <option value="C52">STRUKTŪROS IŠDĖSTYMĄ</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mode_choice_15_div">
                                <div class="col-12 d-flex justify-content-center align-items-center mode_choice_15_div text-center" id="mode_choice_15_div">
                                    <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_15" id="mode_choice_15" style="display: none;">
                                        <option value="C82">ATSITIKTINIAI TEKSTAI</option>
                                        <option value="C84">PARINKTI TEKSTUS</option>
                                    </select>
                                </div>
                            </div>

                            <div class="class_choice_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="class_choice" id="class_choice" style="display: none;">
                                    <option value="C75">1-2 KLASĖ</option>
                                    <option value="C76">3-4 KLASĖ</option>
                                </select>
                            </div>

                            <div class="mode_choice_10_div">
                                <div class="col-12 d-flex justify-content-center align-items-center mode_choice_10_div text-center" id="mode_choice_10_div">
                                    <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_10" id="mode_choice_10" style="display: none;">
                                        <option value="C58">LENGVAS</option>
                                        <option value="C59">VIDUTINIS</option>
                                        <option value="C60">SUNKUS</option>
                                    </select>
                                </div>
                            </div>

                            <div class="rasyba-options-row">

                                <!--
                                    To add a new controlled section, you just need:
                                    <input type="checkbox" class="r parent-toggle" value='NEW_CATEGORY' data-controls="new-div">
                                    <div id="new-div" data-parent="NEW_CATEGORY">
                                        child checkboxes here
                                    </div>
                                -->

                                <div class="mode_choice_11_div" id="mode_choice_11_div" style="display: none;">
                                    <label class="rasyba-options-label">
                                        <input type="checkbox" class="r parent-toggle" name="r" value='GALŪNĖS' data-controls="galuniu-div" checked>
                                        <span class="rasyba-options-label-text" id="rasyba-options-label-text-galune">ŽODŽIO PABAIGA:</span>
                                    </label>
                                    <br>
                                    <div id="galuniu-div" data-parent="GALŪNĖS">
                                        <label class="rasyba-options-label options-for-first-second-classes">
                                            <input type="checkbox" class="rasyba-options options-for-first-second-classes-input" name="rasyba-option" value='{"C85": []}' checked>
                                            <span class="rasyba-options-label-text">KĄ VIENĄ?</span>
                                            <br>
                                        </label>
                                        <label class="rasyba-options-label options-for-first-second-classes">
                                            <input type="checkbox" class="rasyba-options options-for-first-second-classes-input" name="rasyba-option" value='{"C86": []}' checked>
                                            <span class="rasyba-options-label-text">KO DAUG?</span>
                                            <br>
                                        </label>
                                        <label class="rasyba-options-label options-for-first-second-classes">
                                            <input type="checkbox" class="rasyba-options options-for-first-second-classes-input" name="rasyba-option" value='{"C87": []}' checked>
                                            <span class="rasyba-options-label-text">KUR KAME?</span>
                                            <br>
                                        </label>
                                        <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                            <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C62": []}'>
                                            <span class="rasyba-options-label-text">DAIKTAVARDŽIAI</span>
                                            <br>
                                        </label>
                                        <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                            <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C63": []}'>
                                            <span class="rasyba-options-label-text">BŪDVARDŽIAI</span>
                                            <br>
                                        </label>
                                        <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                            <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C65": []}'>
                                            <span class="rasyba-options-label-text">VEIKSMAŽODŽIAI</span>
                                            <br>
                                        </label>
                                        <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                            <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C92": []}'>
                                            <span class="rasyba-options-label-text">PRIEVEIKSMIAI</span>
                                            <br>
                                        </label>
                                        <div class="mode_choice_12_div" id="mode_choice_12_div">
                                            <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_12" id="mode_choice_12">
                                                <option value="C73">LENGVESNĖS KOMBINACIJOS</option>
                                                <option value="C74">SUNKESNĖS KOMBINACIJOS</option>
                                            </select>
                                        </div>
                                    </div>
                                    <label class="rasyba-options-label">
                                        <input id="C66" type="checkbox" class="rasyba-options" name="rasyba-option" value='{"C66": []}' checked>
                                        <span class="rasyba-options-label-text">ĮSIDĖMĖTINA RAŠYBA</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                        <input id="C64" type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C64": []}' checked>
                                        <span class="rasyba-options-label-text">SUDURTINIAI ŽODŽIAI</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                        <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C71": []}'>
                                        <span class="rasyba-options-label-text">PRIEBALSIŲ SUPANAŠĖJIMAS</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-first-second-classes" style="display: block;">
                                        <input type="checkbox" class="rasyba-options options-for-first-second-classes-input" name="rasyba-option" value='{"C67": []}' checked>
                                        <span class="rasyba-options-label-text">PANAŠIAI SKAMBANČIOS PRIEBALSĖS</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-first-second-classes">
                                        <input id="C66" type="checkbox" class="rasyba-options" name="rasyba-option" value='{"C61": []}' checked>
                                        <span class="rasyba-options-label-text">H - CH - F</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-first-second-classes" style="display: block;">
                                        <input type="checkbox" class="rasyba-options options-for-first-second-classes-input" name="rasyba-option" value='{"C91": []}' checked>
                                        <span class="rasyba-options-label-text">MINKŠTUMO ŽENKLAS</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-first-second-classes" style="display: block;">
                                        <input type="checkbox" class="r parent-toggle" name="r" value='BALSĖS' data-controls="balsiu-div" checked>
                                        <span class="rasyba-options-label-text">BALSĖS</span>
                                        <br>
                                    </label>
                                    <div id="balsiu-div" data-parent="BALSĖS">
                                        <label class="rasyba-options-label options-for-first-second-classes">
                                            <input type="checkbox" class="rasyba-options options-for-first-second-classes-input" name="rasyba-option" value='{"C88": []}' checked>
                                            <span class="rasyba-options-label-text">E - Ė</span>
                                            <br>
                                        </label>
                                        <label class="rasyba-options-label options-for-first-second-classes">
                                            <input type="checkbox" class="rasyba-options options-for-first-second-classes-input" name="rasyba-option" value='{"C89": []}' checked>
                                            <span class="rasyba-options-label-text">I - Y</span>
                                            <br>
                                        </label>
                                        <label class="rasyba-options-label options-for-first-second-classes">
                                            <input type="checkbox" class="rasyba-options options-for-first-second-classes-input" name="rasyba-option" value='{"C90": []}' checked>
                                            <span class="rasyba-options-label-text">U - Ū</span>
                                            <br>
                                        </label>
                                    </div>
                                    <label class="rasyba-options-label options-for-first-second-classes" style="display: block;">
                                        <input type="checkbox" class="rasyba-options options-for-first-second-classes-input" name="rasyba-option" value='{"C68": []}' checked>
                                        <span class="rasyba-options-label-text">DVIBALSIAI</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                        <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C68": []}'>
                                        <span class="rasyba-options-label-text">DVIBALSIAI</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                        <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C72": []}'>
                                        <span class="rasyba-options-label-text">MIŠRIEJI DVIGARSIAI</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-third-fourth-classes" style="display: none;">
                                        <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C69": []}'>
                                        <span class="rasyba-options-label-text">PRIEŠDĖLIAI</span>
                                        <br>
                                    </label>
                                    <label class="rasyba-options-label options-for-third-fourth-classes temporarily-disabled" style="display: none;">
                                        <input type="checkbox" class="rasyba-options options-for-third-fourth-classes-input" name="rasyba-option" value='{"C70": []}'>
                                        <span class="rasyba-options-label-text">PRIESAGOS</span>
                                        <br>
                                    </label>
                                </div>

                                <div class="mode_choice_13_div">
                                    <div class="row"></div>
                                    <div class="col-12 d-flex justify-content-center align-items-center mode_choice_13_div text-center" id="mode_choice_13_div">
                                        <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_13" id="mode_choice_13" style="display: none;">
                                            <option value="3">RETESNI ATVEJAI</option>
                                            <option value="1">DAŽNESNI ATVEJAI</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="mode_choice_14_div">
                                <div class="col-12 d-flex justify-content-center align-items-center mode_choice_14_div text-center" id="mode_choice_14_div">
                                    <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="mode_choice_14" id="mode_choice_14" style="display: none;">
                                        <option value="C80">BE DISTRAKTORIAUS</option>
                                        <option value="C81">SU DISTRAKTORIUMI</option>
                                    </select>
                                </div>
                            </div>

                            <div class="modeChoice4_div">
                                <select class="btn btn-secondary dropdown-toggle dropdown dropdown-options" name="modeChoice4" id="mode_choice_4" style="display: block;">
                                    <option value="C40">NUSTATYTI VEIKSMŲ KIEKĮ</option>
                                    <option value="C39">NUSTATYTI LAIKO TRUKMĘ</option>
                                </select>
                            </div>

                            <div class="timer-question-number-div">
                                <div class="timer-input-div" id="timer-input-div" style="display: none;">
                                    <div class="input-group">
                                        <div class="input-wrapper">
                                            <button class="control-btn" 
                                                    onmousedown="startHold('timer-input', 1, 60, false)"
                                                    onmouseup="stopHold()"
                                                    onmouseleave="stopHold()"
                                                    ontouchstart="event.preventDefault(); startHold('timer-input', 1, 60, false)"
                                                    ontouchend="stopHold()"
                                                    ontouchcancel="stopHold()">−</button>
                                            <input type="number" class="timer-input" id="timer-input" min="1" max="60" step="1" value="5" readonly>
                                            <button class="control-btn" 
                                                    onmousedown="startHold('timer-input', 1, 60, true)"
                                                    onmouseup="stopHold()"
                                                    onmouseleave="stopHold()"
                                                    ontouchstart="event.preventDefault(); startHold('timer-input', 1, 60, true)"
                                                    ontouchend="stopHold()"
                                                    ontouchcancel="stopHold()">+</button>
                                        </div>
                                        <h3 class="timer-choice-label">minutes</h3>
                                    </div>
                                </div>
                                <div class="question-number-input-div" id="question-number-input-div">
                                    <div class="input-group">
                                        <div class="input-wrapper">
                                            <button class="control-btn" 
                                                    onmousedown="startHold('question-number-input', 1, 200, false)"
                                                    onmouseup="stopHold()"
                                                    onmouseleave="stopHold()"
                                                    ontouchstart="event.preventDefault(); startHold('question-number-input', 1, 200, false)"
                                                    ontouchend="stopHold()"
                                                    ontouchcancel="stopHold()">−</button>
                                            <input type="number" class="question-number-input" id="question-number-input" min="1" max="200" step="1" value="20" readonly>
                                            <button class="control-btn" 
                                                    onmousedown="startHold('question-number-input', 1, 200, true)"
                                                    onmouseup="stopHold()"
                                                    onmouseleave="stopHold()"
                                                    ontouchstart="event.preventDefault(); startHold('question-number-input', 1, 200, true)"
                                                    ontouchend="stopHold()"
                                                    ontouchcancel="stopHold()">+</button>
                                        </div>
                                        <h3 class="answer-number-label">veiksmų</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="student-task-history-container" style="display: none;">
                            <div class="task-history-container">
                                <div class="task-history-controls-outer">

                                <div class="task-history-dropdown-container">
                                    <button id="taskHistoryMetricsBtn">
                                        <span id="taskHistoryMetricsText"></span>
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="taskHistoryMetricsIcon">
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                    </button>
                                    
                                    <div id="taskHistoryMetricsMenu"></div>
                                </div>

                                <div class="task-history-controls">
                                    <div class="task-history-date-selector">
                                        <div class="task-history-date-group">
                                            <label class="task-history-date-label">Nuo</label>
                                            <div class="lt-date-input-wrapper">
                                                <input class="task-history-date-input" id="taskHistoryStartDate">
                                                <span class="lt-date-calendar-icon"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></span>
                                            </div>
                                        </div>
                                        <div class="task-history-date-group">
                                            <label class="task-history-date-label">Iki</label>
                                            <div class="lt-date-input-wrapper">
                                                <input class="task-history-date-input" id="taskHistoryEndDate">
                                                <span class="lt-date-calendar-icon"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                </div>

                                <div class="task-history-chart-wrapper">
                                    <canvas id="taskHistoryChart"></canvas>
                                </div>
                                <div id="task-history-description-box" style="display:none; margin: 10px 4px 4px 4px; padding: 10px 14px; background: rgba(255,255,255,0.18); border-radius: 12px; border: 1px solid rgba(255,255,255,0.25); font-size: 0.88rem; color: #222;">
                                    <div style="font-weight:600; margin-bottom:4px; opacity:0.7; font-size:0.8rem; text-transform:uppercase; letter-spacing:0.04em;">Užduoties aprašymas</div>
                                    <div id="task-history-description-content"></div>
                                </div>
                            </div>
                        </div>

                        <div id="task-archive-view" style="display: none;">
                            <div id="task-archive-date-controls">
                                <div class="task-history-date-group">
                                    <label class="task-history-date-label">Nuo</label>
                                    <div class="lt-date-input-wrapper">
                                        <input class="task-history-date-input" id="archiveStartDate">
                                        <span class="lt-date-calendar-icon"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></span>
                                    </div>
                                </div>
                                <div class="task-history-date-group">
                                    <label class="task-history-date-label">Iki</label>
                                    <div class="lt-date-input-wrapper">
                                        <input class="task-history-date-input" id="archiveEndDate">
                                        <span class="lt-date-calendar-icon"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></span>
                                    </div>
                                </div>
                            </div>
                            <div id="task-archive-table-container">
                                <div class="task-archive-empty">Pasirinkite mokinį iš sąrašo.</div>
                            </div>
                        </div>

                        <!-- Student Task Info Container -->
                        <div id="student-task-info-container">
                            <div id="student-task-info-container-inner">
                                <div class="task-info-holder">
                                    <div id="student-task-student-name"></div>
                                    <div id="student-task-student-email"></div>
                                    <div class="student-statistic-top-section">
                                    <div id="student-task-student-knowledge-level"></div>
                                    <div id="student-task-student-performance-mean"></div>
                                    <div id="student-task-student-consistency-mean"></div>
                                    <div id="student-stats-graph-holder" style="display: none;">
                                        <div class="student-statistics-label">Mokinio ilgalaikė statistika (savaitinis vidurkis)</div>
                                        <div class="filter-section">
                                            <!-- Subject Dropdown -->
                                            <div class="dropdown-container">
                                                <button id="subjectDropdownBtn">
                                                    <span id="subjectDropdownText"></span>
                                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="subjectDropdownIcon">
                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                    </svg>
                                                </button>
                                                
                                                <div id="subjectDropdownMenu"></div>
                                            </div>

                                            <!-- Metrics Dropdown -->
                                            <div class="dropdown-container">
                                                <button id="metricsDropdownBtn">
                                                    <span id="metricsDropdownText"></span>
                                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="metricsDropdownIcon">
                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                    </svg>
                                                </button>
                                                
                                                <div id="metricsDropdownMenu"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="chart-container">
                                            <div class="chart-body scroll-indicators-horizontal" id="chartBody">
                                                <div class="chart-scrollable">
                                                    <canvas id="statsChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                    <div id="student-task-group-and-status-indicator">
                                        <div id="student-task-group"></div>
                                        <div id="student-task-status-indicator"></div>
                                    </div>
                                    <div class="col-12" id="student-task-completion-date"></div>
                                    <div class="col-12" id="student-statistics-completed-tasks" style="display: none;"></div>

                                    <div id="student-statistics-math" style="display: none;">
                                        <div class="student-statistics-title">Matematika</div>
                                        <div class="col-12" id="student-statistics-math-error-frequency"></div>
                                    </div>

                                    <div class="col-12" id="student-score-duration"></div>
                                    <div class="col-12" id="student-score-asnwer-number"></div>
                                    <div class="col-12" id="student-score-mistake-number"></div>
                                    <div class="col-12" id="text-comprehension-mistakes-summary"></div>

                                    <div id="mistakes-summary-math" style="display: none;">
                                        <div id="mistakes-table-title-math" class="task-info-subtitle">Dažniausios skaičiavimo klaidos:</div>
                                        <div class="summary-inner-container">
                                            <div class="col-12 table-container">
                                                <div id="summary-table"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="student-statistics-lang-grammar" style="display: none;">
                                        <div class="student-statistics-title">Lietuvių kalba</div>
                                        <div class="student-statistics-subtitle">Rašyba</div>
                                        <div class="col-12" id="student-statistics-grammar-error-frequency"></div>
                                    </div>

                                    <div id="mistakes-summary-grammar" style="display: none;">
                                        <div id="mistakes-table-title-grammar" class="task-info-subtitle">Dažniausios rašybos klaidos:</div>
                                        <div class="summary-inner-container">
                                            <div class="col-12 table-container">
                                                <div id="summary-table-grammar"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="sentence-with-mistake-field"></div>

                                    <div id="student-statistics-lang-text-comprahension" style="display: none;">
                                        <div class="student-statistics-subtitle" id="student-statistics-lang-text-comprahension-komponavimas" style="display: none;">Turinio komponavimas</div>
                                        <div class="col-12" id="student-statistics-komponavimas-error-frequency"></div>
                                        <div class="col-12" id="student-statistics-komponavimas-completed-texts"></div>
                                        <div class="student-statistics-subtitle" id="student-statistics-lang-text-comprahension-isdestymas" style="display: none;">Struktūros išdėstymas</div>
                                        <div class="col-12" id="student-statistics-isdestymas-error-frequency"></div>
                                        <div class="col-12" id="student-statistics-isdestymas-completed-texts"></div>
                                    </div>

                                    <div id="task-description-outer-container">
                                        <div id="task-description-title" class="task-info-subtitle" style="display: none;">Užduoties aprašymas:</div>
                                        <div id="task-description"></div>
                                    </div>
                                </div>
                            </div>
                        </div>


    <div class="txt-browser-wrapper">
        <div class="txt-browser-main-header" id="mainBrowserHeader">
            <h2 class="txt-browser-main-title">Tekstų Naršyklė</h2>
            <span class="txt-browser-main-icon collapsed" id="mainBrowserIcon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
                    <path d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"/>
                </svg>
            </span>
        </div>
        
        <div class="txt-browser-content" id="mainBrowserContent">
            <div>
            <div class="txt-viewer-container">
                <div class="txt-viewer-sticky-header">
                    <input 
                        type="text" 
                        class="txt-viewer-search-input" 
                        id="searchInput" 
                        placeholder="Ieškoti pagal ID, pavadinimą, autorių ar tekstą..."
                        autocomplete="off"
                    >

                    <div class="txt-viewer-all-filters-wrapper">
                        <div class="txt-viewer-all-filters-header" id="allFiltersHeader">
                            <span>Filtrai</span>
                            <span class="txt-viewer-all-filters-icon" id="allFiltersIcon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
                                <path d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"/>
                            </svg>                            
                        </span>
                        </div>
                        <div class="txt-viewer-all-filters-content txt-viewer-collapsed" id="allFiltersContent">
                            <div class="txt-viewer-filter-group">
                                <div class="txt-viewer-filter-label">Klasė</div>
                                <div class="txt-viewer-filter-options">
                                    <div class="txt-viewer-filter-option">
                                        <input type="checkbox" id="class_1_2" checked onchange="applyFilters()">
                                        <label for="class_1_2">1-2 klasė</label>
                                    </div>
                                    <div class="txt-viewer-filter-option">
                                        <input type="checkbox" id="class_3_4" checked onchange="applyFilters()">
                                        <label for="class_3_4">3-4 klasė</label>
                                    </div>
                                </div>
                            </div>

                            <div class="txt-viewer-filter-group">
                                <div class="txt-viewer-filter-label">Užduoties tipas</div>
                                <div class="txt-viewer-filter-options">
                                    <div class="txt-viewer-filter-option">
                                        <input type="checkbox" id="task_struktura" checked onchange="applyFilters()">
                                        <label for="task_struktura">Struktūros išdėstymas</label>
                                    </div>
                                    <div class="txt-viewer-filter-option">
                                        <input type="checkbox" id="task_komponavimas" checked onchange="applyFilters()">
                                        <label for="task_komponavimas">Turinio komponavimas</label>
                                    </div>
                                </div>
                            </div>

                            <div class="txt-viewer-filter-group">
                                <div class="txt-viewer-filter-label">Sudėtingumas</div>
                                <div class="txt-viewer-filter-options">
                                    <div class="txt-viewer-filter-option">
                                        <input type="checkbox" id="diff_lengvas" checked onchange="applyFilters()">
                                        <label for="diff_lengvas">Lengvas</label>
                                    </div>
                                    <div class="txt-viewer-filter-option">
                                        <input type="checkbox" id="diff_vidutinis" checked onchange="applyFilters()">
                                        <label for="diff_vidutinis">Vidutinis</label>
                                    </div>
                                    <div class="txt-viewer-filter-option">
                                        <input type="checkbox" id="diff_sunkus" checked onchange="applyFilters()">
                                        <label for="diff_sunkus">Sunkus</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="txt-viewer-selected-ids-container-outer">
                <div class="txt-viewer-selected-ids-container hide-scrollbar scroll-indicators" id="selectedIdsContainer">
                    <div class="txt-viewer-selected-ids-label">Pasirinkti tekstai:</div>
                    <div class="txt-viewer-selected-ids-list" id="selectedIdsList"></div>
                </div>
                </div>

                <div class="txt-viewer-texts-list" id="textsList">
                    <div class="txt-viewer-no-results">Kraunama...</div>
                </div>
            </div>
            </div>
        </div>
    </div>


                    </div>
                </div>
            </aside>

            <button class="toggle-tab" id="toggleTab" aria-label="Toggle sidebar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </button>
        </div>
    </div>

<!-- STUDENT GUI -->
<div id="student-gui" style="display: none;">

        <!-- LEFT SIDE: Student List (always visible) -->
    <div class="left-side-bar">
        <div class="left-side-bar-inner">
                <div id="student-button-holder-outer">
                <div class="student-button-holder">
                    <!-- Action buttons that transform -->
                    <div id="student-action-buttons-container">
                        <button id="frequent-mistakes-btn" class="student-action-btn" onclick="displayFrequentMistakes()">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor"><path d="M280-320q17 0 28.5-11.5T320-360q0-17-11.5-28.5T280-400q-17 0-28.5 11.5T240-360q0 17 11.5 28.5T280-320Zm-40-120h80v-200h-80v200Zm160 80h320v-80H400v80Zm0-160h320v-80H400v80ZM160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Zm0-80h640v-480H160v480Zm0 0v-480 480Z"/></svg>
                    </div>
                </div>
        </div>

        <div class="" id="student-tasks-list-outer-container">
            <div class="align-items-center justify-content-start" id="student-task-for-students-title-container">
                <div id="task-list-title-for-students"></div>
            </div>
            <div id="student-task-list-container">
            <div id="student-tasks-list"></div>
            </div>
        </div>

        </div>
    </div>


<div class="sidebar-wrapper" id="sidebarWrapperStudent">
    <aside class="sidebar hide-scrollbar-mobile" id="sidebarStudent">
        <div class="sidebar-content" id="sidebarContentStudent">

        <!-- RIGHT SIDE: Task Info (collapsible on mobile) -->
        <div class="" id="dynamic-student-content">
            <div id="task-info-container-for-students">
                <div id="student-task-info-container-inner">
                    <div class="task-info-holder-student">
                        <div id="student-task-group-and-status-indicator">
                            <div id="student-task-group-for-student"></div>
                            <div id="student-task-status-indicator-for-student"></div>
                        </div>
                        <div class="col-12" id="student-task-completion-date-for-students"></div>
                        <div class="col-12" id="student-score-duration-for-student"></div>
                        <div class="col-12" id="student-score-asnwer-number-for-student"></div>
                        <div class="col-12" id="student-score-mistake-number-for-student"></div>

                        <div id="mistakes-summary-math-for-student" style="display: none;">
                            <div id="mistakes-table-title-math-for-students" class="task-info-subtitle">Dažniausios skaičiavimo klaidos:</div>
                            <div class="summary-inner-container">
                                <div class="table-container">
                                    <div id="summary-table-for-student"></div>
                                </div>
                            </div>
                        </div>

                        <div id="mistakes-summary-grammar-for-student" style="display: none;">
                            <div id="mistakes-table-title-grammar-for-student" class="task-info-subtitle">Dažniausios rašybos klaidos:</div>
                            <div class="summary-inner-container">
                                <div class="table-container">
                                    <div id="summary-table-grammar-for-student"></div>
                                </div>
                            </div>
                            <div id="sentence-with-mistake-field-for-student"></div>
                        </div>

                        <div id="task-description-outer-container-for-student">
                            <div id="task-description-title-for-student" class="task-info-subtitle" style="display: none;">Užduoties aprašymas:</div>
                            <div id="task-description-for-student"></div>
                        </div>
                    </div>
                    <div class="complete-task-holder" style="display: none;">
                        <div class="coin-display-holder"></div>
                        <button id="complete-task-button" class="" onclick="completeTask()">Atlikti užduotį</button>
                    </div>

                    <div id="frequent-mistakes-container" style="flex-direction: column; justify-content: space-between;" hidden>
                    <div class="row d-flex align-items-start">
                        <div class="mistakes-summary-forstudents-title">
                            Paskutinės klaidos
                        </div>
                    </div>

                    <div id="mistakes-summary-math">
                    <div class="summary-choices-button-holder">
                    <button class="display-summary-button active-summary-button" onclick="displayMathSummary()" id="display-math-summary-button">Matematika</button>
                    <button class="display-summary-button" onclick="displayGrammarSummary()" id="display-grammar-summary-button">Rašyba</button>
                    </div>
                    <div class="latest-mistakes-summary-holder">
                        <div class="summary-table-frequent-mistakes-outer-div">
                            <div id="summary-table-outer-div" class="">
                                <div class="table-container" id="table-container-math">
                                    <div id="summary-table-frequent-mistakes"></div>
                                </div>
                            </div>
                        </div>

                        <div id="mistakes-summary-grammar" class="summary-table-frequent-mistakes-outer-div">
                            <div id="summary-table-grammar-outer-div" class="" style="display: none;">
                                <div class="table-container" id="table-container-grammar">
                                    <div id="summary-table-grammar-frequent-mistakes"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                </div>










            </div>
        </div>
        </div>
        </aside>
                    <button class="toggle-tab" id="toggleTabStudent" aria-label="Toggle sidebar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </button>
        </div>
        
</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="../mental-arithmetic.js"></script>
	<script src="../mental-arithmetic-combinations.js"></script>
    <script src="../parameter_dictionary.js"></script>
    <script src="../main-nav-bar.js"></script>
    <script src="matematika_options.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Lithuanian locale -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/lt.js"></script>

	<script>
        const redCircleColorCode = '#D57E7E';
        const greenCircleColorCode = '#40c9a9';

        if (!userData) {
            window.location.href = './';
        }

        let chart = null;

        let studentList;
        let globalErrorThresholds;
        let tasksList;
        let currentTaskId;
        let currentTaskInstructions;
        let currentTaskDuration;
        let studentListDiv = document.getElementById('student-list')
        let addingNewTask = false;
        let deletingTask = false;
        let deletingStudent = false;
        let browsingHistory = false;
        let showingSelectAllCheckbox = false;
        let taskContainerVisible = true;
        let changingTeacher = false;
        let classScoreMedian;
        let classConsistencyMedian;
        const teacherGUI = document.getElementById('teacher-gui');
        const studentGUI = document.getElementById('student-gui');
        let studentTasksList = document.getElementById('student-tasks-list')
        let taskInfoContainerForStudents = document.getElementById('task-info-container-for-students')
        const newTaskButton = document.getElementById('new-task-button');
        const deleteTaskButton = document.getElementById('delete-task-button');
        const teacherMessageLine = document.getElementById('teacher-message-line');
        const teacherDataRetrievalMessage = document.getElementById('teacher-data-retrieval-message');
        const teacherMessageLine2 = document.getElementById('teacher-message-line-2');
        const newTaskOptions = document.getElementById('new-task-options-container');
        const studentTaskInfoContainer = document.getElementById('student-task-info-container');
        const studentTaskStudentName = document.getElementById('student-task-student-name');
        const studentTaskStudentEmail = document.getElementById('student-task-student-email');
        const studentTaskGroup = document.getElementById('student-task-group');

        const studentTaskStatus = document.getElementById('student-task-status');
        const studentScoreAnswerNumber = document.getElementById('student-score-asnwer-number');
        const studentScoreMistakeNumber = document.getElementById('student-score-mistake-number');

        const textComprehensionMistakesSummary = document.getElementById('text-comprehension-mistakes-summary');

        const studentScoreDuration= document.getElementById('student-score-duration');
        const studentScoreDurationForStudent = document.getElementById('student-score-duration-for-student');

        let dynamicStudentContent = document.getElementById('dynamic-student-content');

        let taskGroupForStudents = document.getElementById('task-group-for-students');
        let taskStatusForStudents = document.getElementById('task-status-for-students');

        const deleteStudentButton = document.getElementById('delete-student-button');
        const confirmDeleteStudentButton = document.getElementById('confirm-delete-student-button');

        const taskHistoryBrowserButton = document.getElementById('browse-task-history-button');

        const studentListTitle = document.getElementById('student-list-title-container');
        const studentListSelectAllCheckbox = document.getElementById('student-list-header-checkbox-container');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');

        const teacherDispalyStudentTaskIndicator = document.getElementById('student-task-status-indicator');
        const mistakesSummaryTable = document.querySelector('#summary-table');

        const taskDescriptionTitle = document.querySelector('#task-description-title');
        const taskDescription = document.querySelector('#task-description');

        const studentTaskGroupForStudent = document.getElementById('student-task-group-for-student');
        const studentScoreAnswerNumberForStudent = document.getElementById('student-score-asnwer-number-for-student');
        const studentScoreMistakeNumberForStudent = document.getElementById('student-score-mistake-number-for-student');
        const taskDescriptionForStudent = document.querySelector('#task-description-for-student');
        const teacherDispalyStudentTaskIndicatorForStudent = document.getElementById('student-task-status-indicator-for-student');
        const taskListTitleForStudents = document.getElementById('task-list-title-for-students');
        const expandStudentInfoButton = document.getElementById('expand-student-info-button')

        const completeTaskButton = document.getElementById('complete-task-button');
        const completeTaskButtonHolder = document.querySelector('.complete-task-holder');

        const frequentMistakeContainerElement = document.getElementById("frequent-mistakes-container");

        enableTeacherControlPannel();
        enableNewTaskContainer();
        document.querySelectorAll('.item-to-be-disabled-while-talking-to-server').forEach(el => el.disabled = false);

        function toggleStudentListLabel() {
            showingSelectAllCheckbox = !showingSelectAllCheckbox
            if (showingSelectAllCheckbox && ! browsingHistory) {
                studentListTitle.style.display = "none"
                studentListSelectAllCheckbox.style.display = "flex"
                selectAllCheckbox.checked = false
            } else {
                studentListTitle.style.display = "flex"
                studentListSelectAllCheckbox.style.display = "none"
                selectAllCheckbox.checked = false
            }
        }

        document.getElementById('select-all-checkbox').addEventListener('change', function () {
            const checkboxes = document.querySelectorAll('#student-list input[type="checkbox"]');

            checkboxes.forEach(checkbox => {
                if (getComputedStyle(checkbox).visibility !== 'hidden') {
                    checkbox.checked = this.checked;
                }
            });
        });

        function toggleDeleteStudent() {
            deletingStudent = !deletingStudent
            const dropdown = document.getElementById("task-group-sorting");
            const menu = document.getElementById("task-group-menu");
            
            toggleStudentListLabel();
            clearTaskInfoContainer();
            
            if (deletingStudent) {
                // First: select all groups and trigger filtering
                restoreAllIfNoneSelected(true);
                menu.dispatchEvent(new Event("change"));
                
                // Then: disable dropdown and show student checkboxes
                setTimeout(() => {
                    dropdown.disabled = true;
                    taskContainerVisible = true;
                    toggleTaskVisibility();

                    document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                        checkbox.style.visibility = "visible";
                        checkbox.disabled = false;
                    });
                }, 100);
            } else {
                taskContainerVisible = false;
                toggleTaskVisibility();
                document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                    checkbox.style.visibility = "hidden";
                    checkbox.checked = false;
                });
                dropdown.disabled = false;
            }
        }

        async function deleteStudents() {
            let studentsToRemove = [];
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                if (checkbox.checked) {
                    studentsToRemove.push(parseInt(checkbox.value));
                }
            });
            
            if (studentsToRemove.length === 0) {
                messageToTheUser("Pasirinkite bent vieną mokinį pašalinimui!");
                return
            }

            const studentIdsBeingRemoved = studentsToRemove.map(id => parseInt(id));
    
            // Find matching students and collect assignmentIds
            const assignmentIds = [];
            
            studentList.forEach(student => {
                if (studentIdsBeingRemoved.includes(student.id)) {
                    student.tasks.forEach(task => {
                        assignmentIds.push(task.assignmentId);
                    });
                }
            });

            disableTeacherControlPannel();

            deletingTask = true
            await deleteTasks(assignmentIds)

            disableConfirmationButtons();
            try {
                // Prepare the list of tasks to delete (assuming tasksToTemove is already populated)
                const studentsToDelete = studentsToRemove;  // Ensure this array holds task IDs to be deleted

                const response = await apiFetch(apiBase + 'students', {
                    method: 'DELETE',  // Change to DELETE method
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ studentIds: studentsToDelete })  // Send the list as JSON in the body
                });

                if (!response) {
                    return;
                }

                if (!response.ok) {
                    const errorData  = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }

                // Optionally, handle the response if needed (e.g., confirm deletion or update the UI)
                const result = await response.json().catch(() => ({}));
                if (result.message === "Student removal successful.") {
                    fetchDataForTeachers()
                    messageToTheUser("Mokinių šalinimas sėkmingas.", false);
                } 

            } catch (error) {
                console.log('Error deleting tasks:', error);
                if (error.message === "Unauthorized") {
                    clearUserData();
                    window.location.href = "prisijungimas";
                } else {
                    messageToTheUser('Nepavyko pašalinti mokinių. Bandykite vėl vėliau.');
                }
            } finally {
                enableTeacherControlPannel();
                showingSelectAllCheckbox = true;
                toggleDeleteStudent() 
                clearTaskInfoContainer();
                hideConfirmationButtons();
            }
        }


        function clearTaskInfoContainer() {
            studentTaskStudentName.innerHTML = '';
            studentTaskStudentEmail.innerHTML = '';
            studentTaskGroup.innerHTML = '';
            studentScoreAnswerNumber.innerHTML = '';
            studentScoreMistakeNumber.innerHTML = '';
            mistakesSummaryTable.innerHTML = '';
            taskDescription.innerHTML = '';
            taskDescriptionTitle.style.display = "none"
            teacherDispalyStudentTaskIndicator.style.display = "none"
            studentStatisticsCompletedTasks.innerHTML = '';
            studentStatisticsCompletedTasks.style.display = "none";
            studentStatisticsKnowledgeLevel.innerHTML = '';
            studentStatisticsKnowledgeLevel.style.display = "none";
            studentStatisticsPerformanceMean.innerHTML = '';
            studentStatisticsPerformanceMean.style.display = "none";
            studentStatisticsConsistencyMean.innerHTML = '';
            studentStatisticsConsistencyMean.style.display = "none";
            studentStatisticsMathDiv.style.display = "none";
            studentStatisticsMathErrorFrequency.innerHTML = '';
            studentStatisticsLangDiv.style.display = "none";
            studentStatisticsGrammarErrorFrequency.innerHTML = '';
            studentStatisticsTextComprahensionDiv.style.display = "none";
            studentStatisticsKomponavimasErrorFrequency.innerHTML = '';
            studentStatisticsIsdestymasErrorFrequency.innerHTML = '';
            document.querySelector("#mistakes-summary-math").style.display = "none";
            document.querySelector("#mistakes-summary-grammar").style.display = "none";
            studentStatisticsTextComprahensionIsdestymasTitle.style.display = "none";
            studentStatisticsTextComprahensionKomponavimasTitle.style.display = "none";
            studentTaskCompletionDate.innerHTML = '';
            document.querySelector("#summary-table-grammar").innerHTML = "";
            document.querySelector("#summary-table").innerHTML = "";
            document.querySelector("#sentence-with-mistake-field").innerHTML = "";
            textComprehensionMistakesSummary.innerHTML = "";
            studentScoreDuration.innerHTML = "";
            studentStatisticsIsdestymasCompletedTexts.innerHTML = "";
            studentStatisticsKomponavimasCompletedTexts.innerHTML = "";
            document.querySelector("#student-stats-graph-holder").style.display = "none";
            if (chart) {
                chart.destroy();
            }
        }

        function clearTaskInfoContainerForStudents() {
            studentTaskGroupForStudent.innerHTML = '';
            studentScoreAnswerNumberForStudent.innerHTML = '';
            studentScoreMistakeNumberForStudent.innerHTML = '';
            document.querySelector("#summary-table-for-student").innerHTML = '';
            taskDescriptionForStudent.innerHTML = '';
            teacherDispalyStudentTaskIndicatorForStudent.style.display = "none"
            studentTaskCompletionDateForStudents.innerHTML = '';
            document.querySelector("#summary-table-grammar-for-student").innerHTML = "";
            document.querySelector("#summary-table-for-student").innerHTML = "";
            document.querySelector("#sentence-with-mistake-field-for-student").innerHTML = "";
            document.querySelector("#mistakes-table-title-grammar-for-student").innerHTML = "";
            document.querySelector("#mistakes-table-title-math-for-students").innerHTML = "";
            document.querySelector("#mistakes-summary-math-for-student").style.display = "none";
            document.querySelector("#mistakes-summary-grammar-for-student").style.display = "none";
            studentScoreDurationForStudent.innerHTML = "";
            document.querySelector("#frequent-mistakes-container").style.display = "none";
            document.querySelector('.task-info-holder-student').style.display = "none";
            completeTaskButtonHolder.style.display = "none";
        }

        let studentStatisticsCompletedTasks = document.querySelector("#student-statistics-completed-tasks");

        let studentStatisticsPerformanceMean = document.querySelector("#student-task-student-performance-mean");
        let studentStatisticsConsistencyMean = document.querySelector("#student-task-student-consistency-mean");
        let studentStatisticsKnowledgeLevel = document.querySelector("#student-task-student-knowledge-level");
        const studentStatisticsMathDiv = document.querySelector("#student-statistics-math");
        const studentStatisticsMathErrorFrequency = document.querySelector("#student-statistics-math-error-frequency");
        const studentStatisticsLangDiv = document.querySelector("#student-statistics-lang-grammar") 
        const studentStatisticsGrammarErrorFrequency = document.querySelector("#student-statistics-grammar-error-frequency");
        const studentStatisticsTextComprahensionDiv = document.querySelector("#student-statistics-lang-text-comprahension")
        const studentStatisticsKomponavimasErrorFrequency = document.querySelector("#student-statistics-komponavimas-error-frequency"); 
        const studentStatisticsIsdestymasErrorFrequency = document.querySelector("#student-statistics-isdestymas-error-frequency"); 

        const studentStatisticsKomponavimasCompletedTexts = document.querySelector("#student-statistics-komponavimas-completed-texts"); 
        const studentStatisticsIsdestymasCompletedTexts = document.querySelector("#student-statistics-isdestymas-completed-texts"); 

        const studentStatisticsTextComprahensionIsdestymasTitle = document.querySelector("#student-statistics-lang-text-comprahension-isdestymas")
        const studentStatisticsTextComprahensionKomponavimasTitle = document.querySelector("#student-statistics-lang-text-comprahension-komponavimas")

        const studentTaskCompletionDate = document.querySelector("#student-task-completion-date")
        const studentTaskCompletionDateForStudents = document.querySelector("#student-task-completion-date-for-students")
        
        function calculateAverageStudentsConsistency(stats) {
            if (!stats.c || stats.c.length === 0) return 0;

            const avg = stats.c.reduce((sum, val) => sum + val, 0) / stats.c.length;
            return +(avg * 100).toFixed(2);
        }

        function calculateAverageStudentScore(stats) {
            const validKeys = Object.keys(stats).filter(k => !['c', 'd'].includes(k));
            let ratios = [];

            for (const key of validKeys) {
                for (const sub of stats[key]) {
                if (Array.isArray(sub) && sub.length >= 4) {
                    const points = sub[0];
                    ratios.push(points);
                }
                }
            }

            if (ratios.length === 0) return 0;
            return (ratios.reduce((a, b) => a + b, 0) / ratios.length).toFixed(2);
        }

let studentStatisticsLastRecord;

function processStudentTasks(studentTasks) {
    // Initialize the result objects
    const mathTasks = [[0, 0], []];
    const grammarTasks = [[0, 0], []];
    const komponavimasTasks = [[0, 0], []];
    const isdestymasTasks = [[0, 0], []];

    // Filter tasks with status true
    const filteredTasks = studentTasks.filter(task => task.status);

    for (const task of filteredTasks) {
        try {
            const taskDesc = JSON.parse(task.taskDescription);
            const result = JSON.parse(task.result);

            if (taskDesc[0] === "math") {
                // Process math tasks
                mathTasks[0][0] += result[0][0];
                mathTasks[0][1] += result[0][1];
                mathTasks[1].push(...result[1]);
            } else if (taskDesc[0] === "lang") {
                if (taskDesc[1] === "C83") {
                    // Process grammar tasks
                    grammarTasks[0][0] += result[0][0];
                    grammarTasks[0][1] += result[0][1];
                    grammarTasks[1].push(...result[1]);
                } else if (taskDesc[1] === "C49") {
                    if (taskDesc[2] === "C51") {
                        // Process komponavimas tasks
                        komponavimasTasks[0][0] += result[0][0];
                        komponavimasTasks[0][1] += result[0][1];
                        komponavimasTasks[1].push([[...result[1]], task.completionDate.split("T")[0]]);
                    } else if (taskDesc[2] === "C52") {
                        // Process isdestymas tasks
                        isdestymasTasks[0][0] += result[0][0];
                        isdestymasTasks[0][1] += result[0][1];
                        isdestymasTasks[1].push([[...result[1]], task.completionDate.split("T")[0]]);
                    }
                }
            }
        } catch (error) {
            // Skip tasks with invalid taskDescription or result format
            console.error("Error processing task:", error);
            continue;
        }
    }

        return {
            math: mathTasks,
            grammar: grammarTasks,
            komponavimas: komponavimasTasks,
            isdestymas: isdestymasTasks
        };
}

function countTaskStatuses(studentTasks, category = null) {
    let trueCount = 0;
    let falseCount = 0;
    let filteredTasks = studentTasks;

    if (category) {
        filteredTasks = studentTasks.filter(task => {
            try {
                const taskDesc = JSON.parse(task.taskDescription);
                // Check for different possible category locations
                return taskDesc.some(item => item === category);
            } catch (e) {
                console.error("Error parsing taskDescription:", e);
                return false;
            }
        });
    }

    const total = filteredTasks.length;

    for (const task of filteredTasks) {
        if (task.status === true) {
            trueCount++;
        } else if (task.status === false) {
            falseCount++;
        }
    }

    return {
        total: total,
        completed: trueCount,
        pending: falseCount,
    };
}

 // STATS PART START

const statTypesKeys = {
    "c": "nuoseklumas",
    "m": "matematika",
    "t": "teksto suvokimas",
    "g": "rašyba",
}

const statKeys = {
    0: "rezultatyvumas",
    1: "taškai",
    2: "teisingi atsakymai",
    3: "klaidų dažnis",
    4: "atsakyti klausimai",
    5: "santykinis sudėtingumas"
}

const statsToBeExpressedAsPercetnge = [2, 3];

/**
 * --- CORE SCORING ENGINE ---
 * Error rate: 0 mistakes = full points, 75th percentile = 0 points
 */
function calculatePerformanceIndex(student, allClassRecords, overrides = {}) {
    if (!student || !student.totalAnswers) return 0;

    const ENABLE_DIFFICULTY_SCALING = true; 
    const PENALTY_FOR_VOLUME_BELOW_THRESHOLD = 0.25;

    const MAX_VOL_PTS = 20;
    const MAX_FIRST_TRY_PTS = 40;
    const MAX_NO_MISTAKE_PTS = 40;

    let volLower = overrides.vol25;
    let volUpper = overrides.vol75;
    let medPPA = overrides.medianPPA;
    let errorRate75 = overrides.errorRate75;

    if (volLower === undefined || volUpper === undefined) {
        volLower = student.totalAnswers * 0.7;
        volUpper = student.totalAnswers * 1.3;
    }
    if (volUpper <= volLower) volUpper = volLower + 1;
    
    // Effort Score
    let rawVolScore = 0;
    if (student.totalAnswers >= volUpper) {
        rawVolScore = MAX_VOL_PTS;
    } else if (student.totalAnswers <= volLower) {
        rawVolScore = (student.totalAnswers / volLower) * (MAX_VOL_PTS * 0.25);
    } else {
        const progress = (student.totalAnswers - volLower) / (volUpper - volLower);
        rawVolScore = (MAX_VOL_PTS * 0.6) + (MAX_VOL_PTS * 0.4 * progress);
    }

    // Check if student meets minimum volume threshold
    const meetsVolumeThreshold = student.totalAnswers >= volLower;
    
    // Set caps based on threshold
    const effectiveMaxFirstTry = meetsVolumeThreshold ? MAX_FIRST_TRY_PTS : MAX_FIRST_TRY_PTS * PENALTY_FOR_VOLUME_BELOW_THRESHOLD;
    const effectiveMaxMistake = meetsVolumeThreshold ? MAX_NO_MISTAKE_PTS : MAX_NO_MISTAKE_PTS * PENALTY_FOR_VOLUME_BELOW_THRESHOLD;

    // Mastery Scores - First Try
    const rawFirstTryScore = effectiveMaxFirstTry * (student.correctFirstAttempt / student.totalAnswers);

    // Mastery Scores - Mistakes (NORMALIZED)
    let rawMistakeScore;
    const studentErrorRate = student.mistakes / student.totalAnswers;
    
    if (errorRate75 !== undefined && errorRate75 > 0) {
        
        let normalizedScore;
        
        if (studentErrorRate <= 0) {
            normalizedScore = 1.0;
        } else if (studentErrorRate >= errorRate75) {
            normalizedScore = 0.0;
        } else {
            normalizedScore = 1.0 - (studentErrorRate / errorRate75);
        }
        
        rawMistakeScore = effectiveMaxMistake * normalizedScore;
    } else {
        rawMistakeScore = effectiveMaxMistake * Math.max(0, 1 - studentErrorRate);
    }

    // Difficulty Scaling
    let difficultyScale = 1.0;
    if (ENABLE_DIFFICULTY_SCALING) {
        const studentPPA = student.pointsPerAnswer || 0;
        
        if (medPPA > 0 && studentPPA > 0) {
            difficultyScale = Math.min(1.5, studentPPA / medPPA);
        }
    }

    const finalFirst = Math.min(effectiveMaxFirstTry, rawFirstTryScore * difficultyScale);
    const finalMistake = Math.min(effectiveMaxMistake, rawMistakeScore * difficultyScale);

    const totalScore = Math.round(rawVolScore + finalFirst + finalMistake);

    return totalScore;
}
/**
 * --- DATA TRANSFORMATION ---
 * Calculates weekly error rate 75th percentile with intelligent fallbacks
 */
function transformStudentStats(studentStats, classStats) {
    const DEFAULT_ERROR_THRESHOLDS = {
        m: 0.35,  // Math: 35%
        t: 0.40,  // Text/Reading: 40%
        g: 0.30   // Grammar: 30%
    };

    const result = {};

    if (studentStats.d) studentStatisticsLastRecord = studentStats.d;

    // Handle Consistency (c) separately
    if (studentStats.c) {
        result.c = {
            title: statTypesKeys.c,
            values: studentStats.c.map(v => +(v * 100).toFixed(2))
        };
    }

    // Helper function for percentile calculation
    const getPercentile = (arr, p) => {
        const idx = (arr.length - 1) * p;
        const lower = Math.floor(idx);
        const upper = Math.ceil(idx);
        const weight = idx - lower;
        return arr[lower] * (1 - weight) + arr[upper] * weight;
    };

    const hasSpread = (values) => {
        if (values.length < 5) return false;
        
        const sorted = [...values].sort((a, b) => a - b);
        const q1 = getPercentile(sorted, 0.25);
        const q3 = getPercentile(sorted, 0.75);
        const iqr = q3 - q1;
        
        // Only require IQR > 0 (some variation exists)
        return iqr > 0;
    };

    function getVolumeThreshold(classHistory, weekIndex, category) {
        const MIN_STUDENTS_RATIO = 0.35; // At least 35% of class must be active
        
        // Default volume thresholds by category
        const DEFAULT_VOLUME_THRESHOLDS = {
            m: [100, 250],  // Math: 0-25 questions
            t: [1, 10],  // Text/Reading: 0-30 questions
            g: [20, 40]   // Grammar: 0-20 questions
        };
        
        // Check how many students were active this week
        const allStudentsThisWeek = classHistory
            .map(studentHistory => studentHistory[weekIndex])
            .filter(record => record !== undefined && record[3] > 0);
        
        const totalClassSize = classHistory.length;
        const activeThisWeek = allStudentsThisWeek.length;
        
        // LEVEL 1: If at least half the class was active this week, use weekly thresholds
        if (activeThisWeek >= totalClassSize * MIN_STUDENTS_RATIO && activeThisWeek >= 5) {
            const weekVolumes = allStudentsThisWeek.map(r => r[3] || 0);
            
            if (weekVolumes.length > 0) {
                const sortedVols = [...weekVolumes].sort((a, b) => a - b);
                
                // Trim extreme outliers (5% on each end)
                const start = Math.floor(sortedVols.length * 0.05);
                const end = Math.ceil(sortedVols.length * 0.95);
                const clippedVols = sortedVols.slice(start, end);
                
                if (clippedVols.length > 0) {
                    const lower = getPercentile(clippedVols, 0.3);
                    const upper = getPercentile(clippedVols, 0.7);
                    
                    return [lower, upper];
                }
            }
        }
        
        // LEVEL 2: Not enough students active this week - use all-weeks upper threshold, set lower to 0
        if (classHistory.length > 0) {
            const allVolumes = [];
            
            classHistory.forEach((studentHistory) => {
                studentHistory.forEach(weekRecord => {
                    if (weekRecord && weekRecord[3] > 0) {
                        allVolumes.push(weekRecord[3]);
                    }
                });
            });
            
            if (allVolumes.length >= 5) {
                const sortedVols = [...allVolumes].sort((a, b) => a - b);
                
                // Trim extreme outliers (5% on each end)
                const start = Math.floor(sortedVols.length * 0.05);
                const end = Math.ceil(sortedVols.length * 0.95);
                const clippedVols = sortedVols.slice(start, end);
                
                if (clippedVols.length > 0) {
                    const upper = getPercentile(clippedVols, 0.7);
                    return [0, upper]; // Lower threshold is 0
                }
            }
        }
        
        // LEVEL 3: Fallback - use category-specific defaults
        return DEFAULT_VOLUME_THRESHOLDS[category] || [0, 30];
    }
       
    function getErrorRateThreshold (classHistory, weekIndex, category) {
        const MIN_STUDENTS = 10;
        const MIN_TOTAL_DATA_POINTS = 15;
        
        // LEVEL 1: Try weekly data from class
        if (classHistory.length >= MIN_STUDENTS) {
            const allStudentsThisWeek = classHistory
                .map(studentHistory => studentHistory[weekIndex])
                .filter(record => record !== undefined && record[3] > 0);
            
            if (allStudentsThisWeek.length >= MIN_STUDENTS) {
                const totalTasksThisWeek = allStudentsThisWeek.reduce((sum, r) => sum + (r[3] || 0), 0);
                
                if (totalTasksThisWeek >= MIN_TOTAL_DATA_POINTS) {
                    const errorRates = allStudentsThisWeek.map(r => {
                        const studentTotal = r[3] || 0;
                        const studentMistakes = r[2] || 0;
                        return studentTotal > 0 ? studentMistakes / studentTotal : 0;
                    });
                    
                    const mean = errorRates.reduce((sum, v) => sum + v, 0) / errorRates.length;
                    
                    // Special case: Very low mean error rate (class doing great!)
                    if (mean < 0.01) {
                        const sortedErrors = [...errorRates].sort((a, b) => a - b);
                        const threshold = Math.max(
                            getPercentile(sortedErrors, 0.75),
                            0.02
                        );
                        return threshold;
                    }
                    
                    // Check if weekly data has any variation
                    if (hasSpread(errorRates)) {
                        // Calculate IQR for this week
                        const sortedWeekly = [...errorRates].sort((a, b) => a - b);
                        const weeklyQ1 = getPercentile(sortedWeekly, 0.25);
                        const weeklyQ3 = getPercentile(sortedWeekly, 0.75);
                        const weeklyIQR = weeklyQ3 - weeklyQ1;
                        
                        // Calculate IQR for EACH week in history
                        const weeklyIQRs = [];
                        const numWeeks = Math.max(...classHistory.map(sh => sh.length));
                        
                        for (let w = 0; w < numWeeks; w++) {
                            const studentsThisWeek = classHistory
                                .map(sh => sh[w])
                                .filter(record => record && record[3] > 0);
                            
                            if (studentsThisWeek.length >= MIN_STUDENTS) {
                                const weekErrorRates = studentsThisWeek.map(r => {
                                    const total = r[3] || 0;
                                    const mistakes = r[2] || 0;
                                    return total > 0 ? mistakes / total : 0;
                                });
                                
                                const sorted = [...weekErrorRates].sort((a, b) => a - b);
                                const q1 = getPercentile(sorted, 0.25);
                                const q3 = getPercentile(sorted, 0.75);
                                const iqr = q3 - q1;
                                
                                if (iqr > 0) {
                                    weeklyIQRs.push(iqr);
                                }
                            }
                        }
                        
                        // Need at least 3 historical weeks to compare
                        if (weeklyIQRs.length >= 3) {
                            const sortedIQRs = [...weeklyIQRs].sort((a, b) => a - b);
                            const iqrThreshold = getPercentile(sortedIQRs, 0.20); // Bottom 20%
                            
                            // If this week's IQR is above the 20th percentile of historical IQRs, use it
                            if (weeklyIQR >= iqrThreshold) {
                                const weeklyThreshold = getPercentile(sortedWeekly, 0.75);
                                return weeklyThreshold;
                            }
                            // Otherwise this week has unusually low variation - fall back to all-weeks
                        }
                    }
                }
            }
        }
        
        // LEVEL 2: Try all weeks combined from class
        if (classHistory.length > 0) {
            const allErrorRates = [];
            const studentsWithData = new Set();
            
            classHistory.forEach((studentHistory, studentIndex) => {
                let studentHasData = false;
                studentHistory.forEach(weekRecord => {
                    if (weekRecord && weekRecord[3] > 0) {
                        const total = weekRecord[3];
                        const mistakes = weekRecord[2] || 0;
                        allErrorRates.push(mistakes / total);
                        studentHasData = true;
                    }
                });
                if (studentHasData) {
                    studentsWithData.add(studentIndex);
                }
            });
            
            const totalTasks = classHistory.reduce((sum, studentHistory) => {
                return sum + studentHistory.reduce((s, record) => s + (record?.[3] || 0), 0);
            }, 0);
            
            if (studentsWithData.size >= MIN_STUDENTS && 
                totalTasks >= MIN_TOTAL_DATA_POINTS && 
                allErrorRates.length >= MIN_STUDENTS) {
                
                const mean = allErrorRates.reduce((sum, v) => sum + v, 0) / allErrorRates.length;
                
                // Special case for very low error rates
                if (mean < 0.01) {
                    const sortedErrors = [...allErrorRates].sort((a, b) => a - b);
                    return Math.max(getPercentile(sortedErrors, 0.75), 0.02);
                }
                
                if (hasSpread(allErrorRates)) {
                    const sortedErrors = [...allErrorRates].sort((a, b) => a - b);
                    return getPercentile(sortedErrors, 0.75);
                }
            }
        }
        
        // LEVEL 3: Fall back to global threshold
        return globalErrorThresholds?.[category] ?? DEFAULT_ERROR_THRESHOLDS[category] ?? 0.35;
    };
        

    // Process Subject Stats (m, t, g)
    for (const [key, studentWeeks] of Object.entries(studentStats)) {
        if (key === "c" || key === "d") continue;

        const subjectTitle = statTypesKeys[key] || key;
        const valuesObj = {};

        // Initialize metric arrays
        Object.keys(statKeys).forEach((i) => {
            valuesObj[i] = { title: statKeys[i], values: [] };
        });

        // Add threshold tracking arrays
        valuesObj['volumeThresholdLower'] = { title: 'Volume Lower Threshold', values: [] };
        valuesObj['errorThresholdUpper'] = { title: 'Error Upper Threshold', values: [] };

        const classHistory = classStats && classStats[key] ? classStats[key] : [];

        // PROCESS WEEKLY DATA
        studentWeeks.forEach((weekData, index) => {
            const total = weekData[3] ?? 0;
            const studentObj = {
                points: weekData[0],
                correctFirstAttempt: weekData[1],
                mistakes: weekData[2],
                totalAnswers: total,
                pointsPerAnswer: weekData[4] || 0
            };

            // --- Calculate WEEKLY volume thresholds (keep as is - use class data always) ---
            let weeklyVolLower = 0;
            let weeklyVolUpper = 0;
            
            if (classHistory.length > 0) {
                const allStudentsThisWeek = classHistory
                    .map(studentHistory => studentHistory[index])
                    .filter(record => record !== undefined);
                
                const weekVolumes = allStudentsThisWeek.map(r => r[3] || 0).filter(v => v > 0);
                
                if (weekVolumes.length > 0) {
                    const sortedVols = [...weekVolumes].sort((a, b) => a - b);
                    
                    // Trim extreme outliers (5% on each end)
                    const start = Math.floor(sortedVols.length * 0.05);
                    const end = Math.ceil(sortedVols.length * 0.95);
                    const clippedVols = sortedVols.slice(start, end);


                    
                    if (clippedVols.length > 0) {
                        const thresholds = getVolumeThreshold(classHistory, index, key)
                        weeklyVolLower = thresholds[0];
                        weeklyVolUpper = thresholds[1];
                    }
                }
            }

            // --- Calculate error rate 75th percentile with intelligent fallbacks ---
            const weeklyErrorRate75 = getErrorRateThreshold(classHistory, index, key);

            // --- Calculate Relative Difficulty ---
            let weeklyMedPPA = 0;
            let hasDifficultyData = false;
            let classDidTasks = false;

            if (classHistory.length > 0) {
                const classSize = classHistory.length;
                const MIN_PPA_STUDENTS = Math.floor(classSize / 2);

                let combinedPPAs = [];
                let uniqueContributors = new Set();

                // Track if anyone did tasks this week
                const thisWeekRecords = classHistory
                    .map(studentHistory => studentHistory[index])
                    .filter(r => r !== undefined);

                classDidTasks = thisWeekRecords.some(r => r[3] > 0);

                let weekPointer = index;

                while (weekPointer >= 0 && uniqueContributors.size < MIN_PPA_STUDENTS) {

                    classHistory.forEach((studentHistory, studentIndex) => {
                        const record = studentHistory[weekPointer];

                        if (record && record[3] > 0 && record[4] !== undefined) {
                            combinedPPAs.push(record[4]);
                            uniqueContributors.add(studentIndex);
                        }
                    });

                    weekPointer--;
                }

                hasDifficultyData = combinedPPAs.length > 0;

                if (hasDifficultyData) {
                    weeklyMedPPA = getMedian(combinedPPAs);
                }
            }

            const studentPPA = weekData[4] || 0;
            const studentHasPPAData = weekData[4] !== undefined; // ADD THIS
            const studentDidTasks = total > 0;
            let relDifficulty;

            // Case 1: No difficulty data available
            if (!hasDifficultyData) {
                relDifficulty = 1.0;
            }
            // Case 2: Student did no tasks
            else if (!studentDidTasks) {
                relDifficulty = 1.0;
            }
            // NEW Case: Student has tasks but PPA wasn't tracked for them yet
            else if (!studentHasPPAData) {
                relDifficulty = 1.0;  // Neutral — data not collected yet
            }
            // Case 3: Student did tasks but PPA is 0
            else if (studentPPA === 0 && studentDidTasks) {
                relDifficulty = 0;
            }
            // Case 4: Class median is 0
            else if (weeklyMedPPA === 0) {
                // If class didn't do tasks at all, neutral difficulty
                if (!classDidTasks) {
                    relDifficulty = 1.0;
                }
                // Class did tasks but median PPA is 0
                else {
                    // Student has PPA > 0, so they're doing better than the class
                    relDifficulty = 1.5; // Max difficulty scaling
                    // Note: if studentPPA is also 0, it's already handled by Case 3
                }
            }
            // Case 5: Normal case - calculate ratio
            else {
                relDifficulty = +(studentPPA / weeklyMedPPA).toFixed(2);
            }

            valuesObj[5].values.push(relDifficulty !== null ? relDifficulty : undefined);

            // --- Calculate Performance Index with error threshold ---
            const perfIndex = total > 0 
                ? calculatePerformanceIndex(studentObj, [], { 
                    vol25: weeklyVolLower, 
                    vol75: weeklyVolUpper,
                    medianPPA: hasDifficultyData ? weeklyMedPPA : 0,
                    errorRate75: weeklyErrorRate75
                }, key) 
                : 0;
            
            valuesObj[0].values.push(perfIndex);

            // Store thresholds for chart display
            valuesObj['volumeThresholdLower'].values.push(weeklyVolLower);
            valuesObj['errorThresholdUpper'].values.push(weeklyErrorRate75 * 100); // Convert to percentage

            // --- Populate Standard Metrics (Indices 1-4) ---
            weekData.forEach((val, i) => {
                if (i > 3) return; 

                let value;
                if (i === 0 || i === 3) {
                    value = val;
                } else {
                    const ratio = total === 0 ? 0 : val / total;
                    value = statsToBeExpressedAsPercetnge.includes(i + 1) ? +(ratio * 100).toFixed(2) : +ratio.toFixed(2);
                }
                
                valuesObj[i + 1].values.push(value);
            });
        });

        result[key] = { title: subjectTitle, values: valuesObj };
    }

    return result;
}


// --- SHARED UTILITIES ---

function getMedian(values) {
    if (values.length === 0) return 0;
    const sorted = [...values].sort((a, b) => a - b);
    const half = Math.floor(sorted.length / 2);
    if (sorted.length % 2) return sorted[half];
    return (sorted[half - 1] + sorted[half]) / 2.0;
}

function getDistribution(arr) {
    if (arr.length === 0) return { median: 0, mad: 0 };
    const medianVal = getMedian(arr);
    const deviations = arr.map(x => Math.abs(x - medianVal));
    const madVal = getMedian(deviations);
    return { median: medianVal, mad: madVal === 0 ? 0.001 : madVal };
}

function calculateClassStatistics(records, taskType) {
    const valid = records.filter(r => r.totalAnswers >= 2);
    if (valid.length < 5) return getTaskReference(taskType);

    return {
        count: valid.length,
        firstTryRate: getDistribution(valid.map(r => r.correctFirstAttempt / r.totalAnswers)),
        errorRate: getDistribution(valid.map(r => r.mistakes / r.totalAnswers)),
        avgPointsPerAnswer: getDistribution(valid.map(r => r.points / r.totalAnswers)),
    };
}

function getClassBenchmarks(records) {
    const valid = records.filter(r => r.totalAnswers > 0);
    if (valid.length === 0) return { medianVolume: 0, medianPPA: 0 };
    return {
        medianVolume: getMedian(valid.map(r => r.totalAnswers)),
        medianPPA: getMedian(valid.map(r => r.points / r.totalAnswers))
    };
}


var lithuanianMonths = ['Saus.', 'Vas.', 'Kov.', 'Bal.', 'Geg.', 'Birž.', 'Liep.', 'Rugp.', 'Rugs.', 'Spal.', 'Lap.', 'Gruod.'];

var metricColors = ['#32ac93', '#e74c3c', '#F28C28', '#8b5cf6', '#286D8A', '#ec4899', '#06b6d4', '#84cc16'];

var selectedSubject = null;
var selectedMetrics = [];
var lastSelectedSubject = null;
var lastSelectedMetrics = [];
var availableMetrics = [];
var previousDatasets = [];

function getPreviousMonday(date) {
    var d = new Date(date);
    var day = d.getDay();
    var diff = day === 0 ? 6 : day - 1;
    d.setDate(d.getDate() - diff);
    d.setHours(0, 0, 0, 0);
    return d;
}

function generateMondayDates(count) {
    var dates = [];
    var today = new Date();

    var currentMonday = getPreviousMonday(today);

    if (studentStatisticsLastRecord) {
        var lastDataDate = new Date((studentStatisticsLastRecord) * 24 * 60 * 60 * 1000);
        var lastDataMonday = getPreviousMonday(lastDataDate);
        currentMonday = lastDataMonday;
    }
    
    for (var i = 0; i < count; i++) {
        dates.push(formatLithuanianDate(currentMonday));
        currentMonday.setDate(currentMonday.getDate() - 7);
    }
    
    return dates.reverse();
}

function formatLithuanianDate(date) {
    var day = date.getDate();
    var month = lithuanianMonths[date.getMonth()];
    return month + ' ' + day;
}

function isPercentageMetric(metricTitle) {
    var lower = metricTitle.toLowerCase();
    return lower.indexOf('atsakym') !== -1 || lower.indexOf('klaid') !== -1 || lower.indexOf('nuosekl') !== -1 || lower.indexOf('rezultatyvum') !== -1;
}

function extractMetricsFromData() {
    var metrics = [];
    var keys = Object.keys(processedStudentStats);
    
    // Define metrics to exclude
    var excludedMetrics = ["taškai", "teisingi atsakymai"];
    var excludedKeys = ["volumeThresholdLower", "errorThresholdUpper"]; // Exclude threshold data keys
    
    for (var i = 0; i < keys.length; i++) {
        var key = keys[i];
        if (key === 'c') continue;
        
        var subjectValues = processedStudentStats[key].values;
        if (typeof subjectValues === 'object' && !Array.isArray(subjectValues)) {
            var metricKeys = Object.keys(subjectValues);
            for (var j = 0; j < metricKeys.length; j++) {
                var metricKey = metricKeys[j];
                
                // Skip threshold keys
                if (excludedKeys.indexOf(metricKey) !== -1) {
                    continue;
                }
                
                var metricData = subjectValues[metricKey];
                
                // Check if this metric should be excluded
                if (excludedMetrics.includes(metricData.title)) {
                    continue;
                }
                
                var isPercent = isPercentageMetric(metricData.title);
                var isRezultatyvumas = metricData.title.toLowerCase().indexOf('rezultatyvum') !== -1;
                var isSudetingumas = metricData.title.toLowerCase().indexOf('sudėtingum') !== -1;
                
                var existing = false;
                for (var k = 0; k < metrics.length; k++) {
                    if (metrics[k].id === metricKey && metrics[k].title === metricData.title) {
                        existing = true;
                        break;
                    }
                }
                
                if (!existing) {
                    var metricType;
                    var yAxisID;
                    
                    if (isSudetingumas) {
                        metricType = 'sudetingumas';
                        yAxisID = 'y-sudetingumas';
                    } else if (isRezultatyvumas) {
                        metricType = 'rezultatyvumas';
                        yAxisID = 'y-rezultatyvumas';
                    } else if (isPercent) {
                        metricType = 'percentage';
                        yAxisID = 'y-percent';
                    } else {
                        metricType = 'absolute';
                        yAxisID = 'y-absolute-' + metricKey;
                    }
                    
                    metrics.push({
                        id: metricKey,
                        title: metricData.title,
                        type: metricType,
                        color: metricColors[metrics.length % metricColors.length],
                        yAxisID: yAxisID
                    });
                }
            }
            break;
        }
    }
    
    return metrics;
}

function getAxisIdForAbsoluteMetric(metricId, allSelectedMetrics, subjectData) {
    if (!subjectData || !subjectData.values || !subjectData.values[metricId]) {
        return 'y-absolute-' + metricId;
    }
    
    var currentValues = subjectData.values[metricId].values;
    var currentMax = Math.max.apply(null, currentValues);
    
    for (var i = 0; i < allSelectedMetrics.length; i++) {
        var otherId = allSelectedMetrics[i];
        if (otherId === metricId) continue;
        
        var otherMetric = null;
        for (var j = 0; j < availableMetrics.length; j++) {
            if (availableMetrics[j].id === otherId && availableMetrics[j].type === 'absolute') {
                otherMetric = availableMetrics[j];
                break;
            }
        }
        
        if (!otherMetric || !subjectData.values[otherId]) continue;
        
        var otherValues = subjectData.values[otherId].values;
        var otherMax = Math.max.apply(null, otherValues);
        
        var maxDiff = Math.abs(currentMax - otherMax);
        var largerMax = Math.max(currentMax, otherMax);
        var threshold = largerMax * 0.15;
        
        if (maxDiff <= threshold) {
            var sharedId = parseInt(metricId) < parseInt(otherId) ? metricId : otherId;
            return 'y-absolute-shared-' + sharedId;
        }
    }
    
    return 'y-absolute-' + metricId;
}

function selectSubject(key) {
    selectedSubject = key;
    
    if (key === 'c') {
        selectedMetrics = [];
    } else {
        if (selectedMetrics.length === 0 && availableMetrics.length > 0) {
            selectedMetrics = [availableMetrics[0].id];
        }
    }
    
    // Update subject dropdown text
    var subjectDropdownText = document.getElementById('subjectDropdownText');
    var currentSubject = processedStudentStats[key];
    if (subjectDropdownText && currentSubject) {
        subjectDropdownText.textContent = currentSubject.title;
    }
    
    // Update dropdown items active state
    var subjectItems = document.querySelectorAll('#subjectDropdownMenu [data-subject-key]');
    for (var i = 0; i < subjectItems.length; i++) {
        var itemKey = subjectItems[i].getAttribute('data-subject-key');
        if (itemKey === key) {
            subjectItems[i].style.background = 'rgba(50, 172, 147, 0.2)';
            subjectItems[i].style.fontWeight = '600';
        } else {
            subjectItems[i].style.background = 'transparent';
            subjectItems[i].style.fontWeight = '500';
        }
    }
    
    updateMetricsDropdownDisplay();
    updateChart();

    lastSelectedSubject = key;
    lastSelectedMetrics = selectedMetrics.slice();
}

function updateMetricsDropdownDisplay() {
    var metricsDropdownText = document.getElementById('metricsDropdownText');
    var metricsDropdownBtn = document.getElementById('metricsDropdownBtn');
    
    if (selectedSubject === 'c') {
        metricsDropdownBtn.style.display = 'none';
        return;
    } else {
        metricsDropdownBtn.style.display = 'flex';
    }
    
    // Update text
    if (selectedMetrics.length === 0) {
        metricsDropdownText.textContent = 'Pasirinkite rodiklius';
    } else {
        var selectedTitles = selectedMetrics.map(function(id) {
            var metric = availableMetrics.find(function(m) { return m.id === id; });
            return metric ? metric.title : '';
        }).filter(function(t) { return t; });
        metricsDropdownText.textContent = selectedTitles.join(', ');
    }
    
    // Update checkboxes
    var checkboxes = document.querySelectorAll('.metric-checkbox');
    for (var i = 0; i < checkboxes.length; i++) {
        var metricId = checkboxes[i].getAttribute('data-metric-id');
        var isSelected = selectedMetrics.indexOf(metricId) !== -1;
        var metric = availableMetrics.find(function(m) { return m.id === metricId; });
        
        if (isSelected) {
            checkboxes[i].style.background = metric.color;
            checkboxes[i].querySelector('svg').style.display = 'block';
        } else {
            checkboxes[i].style.background = 'transparent';
            checkboxes[i].querySelector('svg').style.display = 'none';
        }
    }
}

function toggleMetric(id) {
    if (selectedSubject === 'c') return;
    
    var index = selectedMetrics.indexOf(id);
    if (index !== -1) {
        selectedMetrics.splice(index, 1);
    } else {
        selectedMetrics.push(id);
    }
    
    updateChart();
    lastSelectedMetrics = selectedMetrics.slice();
}

function initializeButtons() {
    var subjectDropdownBtn = document.getElementById('subjectDropdownBtn');
    var subjectDropdownMenu = document.getElementById('subjectDropdownMenu');
    var subjectDropdownText = document.getElementById('subjectDropdownText');
    var subjectDropdownIcon = document.getElementById('subjectDropdownIcon');
    
    var metricsDropdownBtn = document.getElementById('metricsDropdownBtn');
    var metricsDropdownMenu = document.getElementById('metricsDropdownMenu');
    var metricsDropdownText = document.getElementById('metricsDropdownText');
    var metricsDropdownIcon = document.getElementById('metricsDropdownIcon');

    availableMetrics = extractMetricsFromData();

    var keys = Object.keys(processedStudentStats);
    var firstKey = keys[0];
    
    // Build subject dropdown
    subjectDropdownMenu.innerHTML = '';
    for (var i = 0; i < keys.length; i++) {
        var key = keys[i];
        var data = processedStudentStats[key];
        var item = document.createElement('div');
        item.className = 'dropdown-menu-item';
        item.textContent = data.title;
        item.setAttribute('data-subject-key', key);

        item.onmouseover = function() {
            if (this.getAttribute('data-subject-key') !== selectedSubject) {
                this.style.background = 'rgba(0, 0, 0, 0.05)';
            }
        };
        item.onmouseout = function() {
            if (this.getAttribute('data-subject-key') !== selectedSubject) {
                this.style.background = 'transparent';
            }
        };
        item.onclick = (function(k) {
            return function() {
                selectSubject(k);
                subjectDropdownMenu.style.display = 'none';
                subjectDropdownIcon.style.transform = 'rotate(0deg)';
            };
        })(key);
        
        subjectDropdownMenu.appendChild(item);
    }

    // Build metrics dropdown
    metricsDropdownMenu.innerHTML = '';
    for (var j = 0; j < availableMetrics.length; j++) {
        var metric = availableMetrics[j];
        var item = document.createElement('div');
        item.className = 'metric-menu-item';
        item.setAttribute('data-metric-id', metric.id);

        var checkbox = document.createElement('div');
        checkbox.className = 'metric-checkbox';
        checkbox.setAttribute('data-metric-id', metric.id);
        checkbox.className = 'metric-checkbox';
        checkbox.style.borderColor = metric.color;        

        var checkmark = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        checkmark.setAttribute('width', '12');
        checkmark.setAttribute('height', '10');
        checkmark.setAttribute('viewBox', '0 0 12 10');
        checkmark.setAttribute('fill', 'none');
        checkmark.style.display = 'none';
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 'M1 5L4.5 8.5L11 1.5');
        path.setAttribute('stroke', 'white');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        checkmark.appendChild(path);
        checkbox.appendChild(checkmark);
        
        var label = document.createElement('span');
        label.textContent = metric.title;
        label.style.cssText = 'font-size: 0.9rem; font-weight: 500; color: #333;';
        
        item.appendChild(checkbox);
        item.appendChild(label);
        
        item.onmouseover = function() {
            this.style.background = 'rgba(0, 0, 0, 0.05)';
        };
        item.onmouseout = function() {
            this.style.background = 'transparent';
        };
        item.onclick = (function(mid, chk, lbl, color) {
            return function(e) {
                e.stopPropagation();
                toggleMetric(mid);
                updateMetricsDropdownDisplay();
            };
        })(metric.id, checkbox, label, metric.color);
        
        metricsDropdownMenu.appendChild(item);
    }
    
    // Subject dropdown toggle
    subjectDropdownBtn.onclick = function(e) {
        e.stopPropagation();
        var isOpen = subjectDropdownMenu.style.display === 'block';
        subjectDropdownMenu.style.display = isOpen ? 'none' : 'block';
        subjectDropdownIcon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
        metricsDropdownMenu.style.display = 'none';
        metricsDropdownIcon.style.transform = 'rotate(0deg)';
    };
    
    // Metrics dropdown toggle
    metricsDropdownBtn.onclick = function(e) {
        e.stopPropagation();
        if (selectedSubject === 'c') return;
        var isOpen = metricsDropdownMenu.style.display === 'block';
        metricsDropdownMenu.style.display = isOpen ? 'none' : 'block';
        metricsDropdownIcon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
        subjectDropdownMenu.style.display = 'none';
        subjectDropdownIcon.style.transform = 'rotate(0deg)';
    };
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown-container')) {
            subjectDropdownMenu.style.display = 'none';
            metricsDropdownMenu.style.display = 'none';
            subjectDropdownIcon.style.transform = 'rotate(0deg)';
            metricsDropdownIcon.style.transform = 'rotate(0deg)';
        }
    });
    
    // Check if we should restore previous selection
    if (lastSelectedSubject && processedStudentStats[lastSelectedSubject]) {
        selectSubject(lastSelectedSubject);
        if (lastSelectedMetrics.length > 0 && lastSelectedSubject !== 'c') {
            selectedMetrics = lastSelectedMetrics.slice();
            updateMetricsDropdownDisplay();
            updateChart();
        }
    } else if (firstKey) {
        selectSubject(firstKey);
    }
}

function getDataForSubject() {
    if (!selectedSubject) return null;
    
    var subject = processedStudentStats[selectedSubject];
    if (selectedSubject === 'c') {
        return { 
            dates: generateMondayDates(subject.values.length), 
            values: subject.values,
            isConsistency: true
        };
    } else {
        var firstMetricKey = Object.keys(subject.values)[0];
        var firstMetric = subject.values[firstMetricKey];
        return { 
            dates: generateMondayDates(firstMetric.values.length),
            values: subject.values,
            isConsistency: false
        };
    }
}

function updateChart() {
    if (chart) {
        chart.destroy();
        chart = null;
    }

    var subjectData = getDataForSubject();
    if (!subjectData) return;
    
    var datasets = [];
    var newDatasetLabels = [];

    if (subjectData.isConsistency) {
        var label = processedStudentStats.c.title;
        newDatasetLabels.push(label);
        
        var wasAlreadyShown = false;
        for (var p = 0; p < previousDatasets.length; p++) {
            if (previousDatasets[p] === label) {
                wasAlreadyShown = true;
                break;
            }
        }
        
        datasets.push({
            label: label,
            data: subjectData.values,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.3,
            borderWidth: 3,
            borderDash: [],
            pointRadius: 0,
            pointHoverRadius: 0,
            pointBackgroundColor: '#10b981',
            pointBorderColor: 'transparent',
            pointBorderWidth: 0,
            pointHoverBorderWidth: 0,
            pointStyle: 'circle',
            yAxisID: 'y-percent',
            animation: wasAlreadyShown ? false : {
                duration: 750,
                easing: 'easeInOutQuart'
            }
        });
    } else {
        // Define metrics that should ALWAYS have solid lines
        var solidLineMetrics = ['rezultatyvumas', 'klaidų dažnis', 'atsakyti klausimai', 'santykinis sudėtingumas'];
        
        // Track which metrics are being displayed and their axes
        var showVolumeThreshold = false;
        var showErrorThreshold = false;
        var volumeMetricColor = null;
        var errorMetricColor = null;
        var volumeAxisID = null;
        var errorMetricIndex = -1; // Track the dataset index instead of axis
        
        for (var i = 0; i < selectedMetrics.length; i++) {
            var metricId = selectedMetrics[i];
            var metric = null;
            for (var j = 0; j < availableMetrics.length; j++) {
                if (availableMetrics[j].id === metricId) {
                    metric = availableMetrics[j];
                    break;
                }
            }
            var metricData = subjectData.values[metricId];
            
            if (metric && metricData) {
                var datasetLabel = metricData.title;
                newDatasetLabels.push(datasetLabel);
                
                var wasShown = false;
                for (var p = 0; p < previousDatasets.length; p++) {
                    if (previousDatasets[p] === datasetLabel) {
                        wasShown = true;
                        break;
                    }
                }
                
                var yAxisId;
                if (metric.type === 'sudetingumas') {
                    yAxisId = 'y-sudetingumas';
                } else if (metric.type === 'rezultatyvumas') {
                    yAxisId = metric.yAxisID;
                } else if (metric.type === 'percentage') {
                    yAxisId = metric.yAxisID;
                } else {
                    yAxisId = getAxisIdForAbsoluteMetric(metricId, selectedMetrics, subjectData);
                }
                
                // Check if this is a volume or error metric and store its info
                if (datasetLabel.toLowerCase().indexOf('atsakyti klausimai') !== -1) {
                    showVolumeThreshold = true;
                    volumeMetricColor = metric.color;
                    volumeAxisID = yAxisId;
                }
                if (datasetLabel.toLowerCase().indexOf('klaidų dažnis') !== -1) {
                    showErrorThreshold = true;
                    errorMetricColor = metric.color;
                    errorMetricIndex = datasets.length; // Store the index where this dataset will be
                }
                
                // Check if this metric should have a solid line
                var shouldBeSolid = false;
                for (var s = 0; s < solidLineMetrics.length; s++) {
                    if (datasetLabel.toLowerCase().indexOf(solidLineMetrics[s]) !== -1) {
                        shouldBeSolid = true;
                        break;
                    }
                }
                
                datasets.push({
                    label: datasetLabel,
                    data: metricData.values,
                    borderColor: metric.color,
                    backgroundColor: metric.color + '20',
                    tension: 0.3,
                    borderWidth: 3,
                    borderDash: shouldBeSolid ? [] : null,
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    pointBackgroundColor: metric.color,
                    pointBorderColor: 'transparent',
                    pointBorderWidth: 0,
                    pointHoverBorderWidth: 0,
                    pointStyle: 'circle',
                    yAxisID: yAxisId,
                    forceSolid: shouldBeSolid,
                    animation: wasShown ? false : {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    }
                });
            }
        }
        
        // Add volume lower threshold line (only if atsakyti klausimai is displayed)
        if (showVolumeThreshold && subjectData.values['volumeThresholdLower'] && volumeAxisID) {
            var lighterVolumeColor = volumeMetricColor ? hexToRgba(volumeMetricColor, 0.4) : 'rgba(128, 128, 128, 0.4)';
            
            datasets.push({
                label: 'minimali atsakytų klausimų riba',
                data: subjectData.values['volumeThresholdLower'].values,
                borderColor: lighterVolumeColor,
                backgroundColor: 'transparent',
                tension: 0.3,
                borderWidth: 2,
                borderDash: [8, 4],
                pointRadius: 0,
                pointHoverRadius: 0,
                yAxisID: volumeAxisID, // Use the same axis as the volume metric
                forceSolid: false,
                isThreshold: true,
                animation: false
            });
        }

    }

    var dashPatterns = [
        [5, 5],
        [10, 5],
        [15, 3, 3, 3],
        [2, 8],
        [20, 5, 5, 5],
        [8, 3, 2, 3]
    ];

    var pointStyles = ['circle', 'rectRot', 'triangle', 'rect', 'star', 'cross'];

    if (datasets.length > 1) {
        var datasetsNeedDashes = new Array(datasets.length).fill(false);
        
        for (var i = 0; i < datasets.length; i++) {
            if (datasets[i].forceSolid || datasets[i].isThreshold) {
                continue;
            }
            
            for (var j = i + 1; j < datasets.length; j++) {
                if (datasets[j].forceSolid || datasets[j].isThreshold) {
                    continue;
                }
                
                if (doDatasetsOverlap(datasets[i], datasets[j])) {
                    datasetsNeedDashes[i] = true;
                    datasetsNeedDashes[j] = true;
                }
            }
        }
        
        var dashIndex = 0;
        var pointStyleIndex = 0;
        
        for (var i = 0; i < datasets.length; i++) {
            if (datasets[i].forceSolid) {
                datasets[i].borderDash = [];
                datasets[i].pointStyle = 'circle';
            } else if (datasets[i].isThreshold) {
                continue;
            } else if (datasetsNeedDashes[i]) {
                datasets[i].borderDash = dashPatterns[dashIndex % dashPatterns.length];
                datasets[i].pointStyle = pointStyles[pointStyleIndex % pointStyles.length];
                dashIndex++;
                pointStyleIndex++;
            } else {
                datasets[i].borderDash = [];
                datasets[i].pointStyle = 'circle';
            }
        }
    }

    function doDatasetsOverlap(dataset1, dataset2) {
        var data1 = dataset1.data;
        var data2 = dataset2.data;
        
        if (data1.length !== data2.length) return false;
        
        var overlapThreshold = 5;
        var overlapCount = 0;
        var totalPoints = data1.length;
        
        for (var k = 0; k < data1.length; k++) {
            var diff = Math.abs(data1[k] - data2[k]);
            
            if (diff <= overlapThreshold) {
                overlapCount++;
            }
        }
        
        var overlapRatio = overlapCount / totalPoints;
        return overlapRatio > 0.3;
    }

    previousDatasets = newDatasetLabels;

    var usedAxisTypes = {};
    var percentageMetrics = [];
    var over100Metrics = [];
    
    if (subjectData.isConsistency) {
        percentageMetrics.push({ title: processedStudentStats.c.title, maxValue: Math.max.apply(null, subjectData.values), color: '#10b981' });
    }
        
    for (var i = 0; i < selectedMetrics.length; i++) {
        var metricId = selectedMetrics[i];
        for (var j = 0; j < availableMetrics.length; j++) {
            if (availableMetrics[j].id === metricId) {
                var metric = availableMetrics[j];
                var yAxisId;
                
                if (metric.type === 'sudetingumas') {
                    yAxisId = 'y-sudetingumas';
                } else if (metric.type === 'rezultatyvumas') {
                    yAxisId = metric.yAxisID;
                } else if (metric.type === 'percentage') {
                    yAxisId = metric.yAxisID;
                } else {
                    yAxisId = getAxisIdForAbsoluteMetric(metricId, selectedMetrics, subjectData);
                }
                
                if (metric.type !== 'rezultatyvumas' && metric.type !== 'sudetingumas') {
                    if (!usedAxisTypes[yAxisId]) {
                        usedAxisTypes[yAxisId] = [];
                    }
                    usedAxisTypes[yAxisId].push(metric);
                }
                
                if (metric.type === 'percentage') {
                    var metricData = subjectData.values[metricId];
                    var maxVal = Math.max.apply(null, metricData.values);
                    var metricInfo = { 
                        title: metric.title, 
                        maxValue: maxVal,
                        id: metricId,
                        metric: metric,
                        color: metric.color
                    };
                    
                    if (maxVal > 100) {
                        over100Metrics.push(metricInfo);
                    } else {
                        percentageMetrics.push(metricInfo);
                    }
                }
                break;
            }
        }
    }

    // This loop reassigns axes for >100% metrics
    for (var i = 0; i < datasets.length; i++) {
        var dataset = datasets[i];
        if (dataset.yAxisID === 'y-percent') {
            var maxInDataset = Math.max.apply(null, dataset.data);
            if (maxInDataset > 100) {
                for (var j = 0; j < over100Metrics.length; j++) {
                    if (dataset.label.indexOf(over100Metrics[j].title) !== -1) {
                        dataset.yAxisID = 'y-percent-' + over100Metrics[j].id;
                        break;
                    }
                }
            }
        }
    }

    // NOW add the error threshold AFTER we know the final axis assignment
    if (showErrorThreshold && subjectData.values['errorThresholdUpper'] && errorMetricIndex >= 0) {
        var lighterErrorColor = errorMetricColor ? hexToRgba(errorMetricColor, 0.4) : 'rgba(128, 128, 128, 0.4)';
        var errorDataset = datasets[errorMetricIndex];
        var finalErrorAxisID = errorDataset ? errorDataset.yAxisID : 'y-percent';
        
        datasets.push({
            label: 'maksimali klaidų riba',
            data: subjectData.values['errorThresholdUpper'].values,
            borderColor: lighterErrorColor,
            backgroundColor: 'transparent',
            tension: 0.3,
            borderWidth: 2,
            borderDash: [8, 4],
            pointRadius: 0,
            pointHoverRadius: 0,
            yAxisID: finalErrorAxisID, // Use the same axis as the error metric actually ended up on
            forceSolid: false,
            isThreshold: true,
            animation: false
        });
    }

    var yAxes = {};
    var axisColorInfo = {};

    var sudetingumasMetrics = [];
    for (var i = 0; i < selectedMetrics.length; i++) {
        var metricId = selectedMetrics[i];
        for (var j = 0; j < availableMetrics.length; j++) {
            if (availableMetrics[j].id === metricId && availableMetrics[j].type === 'sudetingumas') {
                var metricData = subjectData.values[metricId];
                sudetingumasMetrics.push({
                    title: availableMetrics[j].title,
                    color: availableMetrics[j].color,
                    id: metricId
                });
                break;
            }
        }
    }

    var rezultatyvumasMetrics = [];
    for (var i = 0; i < selectedMetrics.length; i++) {
        var metricId = selectedMetrics[i];
        for (var j = 0; j < availableMetrics.length; j++) {
            if (availableMetrics[j].id === metricId && availableMetrics[j].type === 'rezultatyvumas') {
                var metricData = subjectData.values[metricId];
                rezultatyvumasMetrics.push({
                    title: availableMetrics[j].title,
                    color: availableMetrics[j].color,
                    id: metricId
                });
                break;
            }
        }
    }

    var axisKeys = Object.keys(usedAxisTypes);
    var primaryGridAxis = null;
    
    if (sudetingumasMetrics.length > 0) {
        primaryGridAxis = 'y-sudetingumas';
    } else if (rezultatyvumasMetrics.length > 0) {
        primaryGridAxis = 'y-rezultatyvumas';
    } else if (subjectData.isConsistency || percentageMetrics.length > 0) {
        primaryGridAxis = 'y-percent';
    } else if (over100Metrics.length > 0) {
        primaryGridAxis = 'y-percent-' + over100Metrics[0].id;
    } else if (axisKeys.length > 0) {
        primaryGridAxis = axisKeys[0];
    }

    if (sudetingumasMetrics.length > 0) {
        var sudetingumasColors = [];
        for (var i = 0; i < sudetingumasMetrics.length; i++) {
            sudetingumasColors.push(sudetingumasMetrics[i].color);
        }
        
        axisColorInfo['y-sudetingumas'] = sudetingumasColors;
        yAxes['y-sudetingumas'] = {
            type: 'linear',
            display: true,
            position: 'left',
            title: { display: false },
            min: 0,
            max: 2.0,
            ticks: { 
                stepSize: 0.25,
                callback: function(value) { 
                    return value.toFixed(2); 
                },
                color: '#666'
            },
            grid: {
                drawOnChartArea: primaryGridAxis === 'y-sudetingumas',
                color: function(context) {
                    if (context.tick.value === 1.0) {
                        return 'rgba(0, 0, 0, 0.3)';
                    }
                    return 'rgba(0, 0, 0, 0.1)';
                },
                lineWidth: function(context) {
                    if (context.tick.value === 1.0) {
                        return 2;
                    }
                    return 1;
                }
            },
            border: { display: false }
        };
    }

    if (rezultatyvumasMetrics.length > 0) {
        var rezultatyvumasColors = [];
        for (var i = 0; i < rezultatyvumasMetrics.length; i++) {
            rezultatyvumasColors.push(rezultatyvumasMetrics[i].color);
        }
        
        axisColorInfo['y-rezultatyvumas'] = rezultatyvumasColors;
        yAxes['y-rezultatyvumas'] = {
            type: 'linear',
            display: true,
            position: 'left',
            title: { display: false },
            min: 0,
            max: 100,
            ticks: { 
                stepSize: 10,
                callback: function(value) { return value.toFixed(0); },
                color: '#666'
            },
            grid: {
                drawOnChartArea: primaryGridAxis === 'y-rezultatyvumas',
                color: 'rgba(0, 0, 0, 0.1)'
            },
            border: { display: false }
        };
    }

    if (percentageMetrics.length > 0) {
        var percentColors = [];
        for (var i = 0; i < percentageMetrics.length; i++) {
            percentColors.push(percentageMetrics[i].color);
        }
        
        axisColorInfo['y-percent'] = percentColors;
        if (selectedSubject === 'c') {
            yAxes['y-percent'] = {
                type: 'linear',
                display: true,
                position: 'left',
                title: { display: false },
                min: 0,
                max: 100,
                ticks: { 
                    stepSize: 10,
                    callback: function(value) { return value.toFixed(0) + '%'; },
                    color: '#666'
                },
                grid: {
                    drawOnChartArea: primaryGridAxis === 'y-percent',
                    color: 'rgba(0, 0, 0, 0.1)'
                },
                border: { display: false }
            };
        } else {
            yAxes['y-percent'] = {
                type: 'linear',
                display: true,
                position: 'left',
                title: { 
                    display: false
                },
                min: 0,
                max: 100,
                ticks: { 
                    stepSize: 10,
                    callback: function(value) { return value.toFixed(0) + '%'; },
                    color: '#666'
                },
                grid: {
                    drawOnChartArea: primaryGridAxis === 'y-percent',
                    color: 'rgba(0, 0, 0, 0.1)'
                },
                border: {
                    display: false
                }
            };
        }
    }

    for (var i = 0; i < over100Metrics.length; i++) {
        var metric = over100Metrics[i];
        var axisId = 'y-percent-' + metric.id;
        axisColorInfo[axisId] = [metric.color];
        
        yAxes[axisId] = {
            type: 'linear',
            display: true,
            position: 'left',
            title: { 
                display: false
            },
            min: 0,
            ticks: { 
                callback: function(value) { return value.toFixed(0) + '%'; },
                color: '#666'
            },
            grid: { 
                drawOnChartArea: primaryGridAxis === axisId,
                color: 'rgba(0, 0, 0, 0.1)'
            },
            border: {
                display: false
            }
        };
    }

    var rightAxisCount = 0;
    for (var i = 0; i < axisKeys.length; i++) {
        var axisId = axisKeys[i];
        if (axisId !== 'y-percent' && !axisId.startsWith('y-percent-') && axisId !== 'y-rezultatyvumas' && axisId !== 'y-sudetingumas') {
            var metricsOnAxis = usedAxisTypes[axisId];
            var axisColors = metricsOnAxis.map(function(m) { return m.color; });
            
            axisColorInfo[axisId] = axisColors;
            
            yAxes[axisId] = {
                type: 'linear',
                display: true,
                min: 0,
                position: percentageMetrics.length > 0 || over100Metrics.length > 0 || rezultatyvumasMetrics.length > 0 || sudetingumasMetrics.length > 0 || rightAxisCount > 0 ? 'right' : 'left',
                title: { 
                    display: false
                },
                ticks: {
                    callback: function(value) { return value.toFixed(0); },
                    color: '#666'
                },
                grid: { 
                    drawOnChartArea: primaryGridAxis === axisId,
                    color: 'rgba(0, 0, 0, 0.1)'
                },
                border: {
                    display: false
                }
            };
            rightAxisCount = rightAxisCount + 1;
        }
    }

    var ctx = document.getElementById('statsChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: subjectData.dates,
            datasets: datasets
        },
        options: {
            clip: false, 
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            var label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            var yAxisId = context.dataset.yAxisID;
                            
                            if (yAxisId === 'y-sudetingumas') {
                                label += context.parsed.y.toFixed(2);
                            } else if (yAxisId === 'y-percent' || yAxisId.indexOf('y-percent-') === 0) {
                                label += context.parsed.y.toFixed(0) + '%';
                            } else if (yAxisId === 'y-rezultatyvumas') {
                                label += context.parsed.y.toFixed(0);
                            } else {
                                label += context.parsed.y.toFixed(0);
                            }
                            return label;
                        }
                    }
                }
            },
            scales: Object.assign({
                x: {
                    display: true,
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#666'
                    },
                    border: {
                        display: false
                    }
                }
            }, yAxes)
        },
        plugins: [{
            id: 'coloredAxisLines',
            afterDatasetsDraw: function(chart) {
                var ctx = chart.ctx;
                var chartArea = chart.chartArea;
                
                Object.keys(axisColorInfo).forEach(function(scaleId) {
                    var scale = chart.scales[scaleId];
                    if (!scale) return;
                    
                    var colors = axisColorInfo[scaleId];
                    if (!colors || colors.length === 0) return;
                    
                    var lineWidth = 3;
                    var spacing = 1;
                    
                    var isLeft = scale.position === 'left';
                    var x = isLeft ? scale.left : scale.right;
                    var y1 = chartArea.top;
                    var y2 = chartArea.bottom;

                    var axisFullWidth = scale.width;
                    
                    let secondaryLineShift;
                    for (var i = 0; i < colors.length; i++) {
                        secondaryLineShift = i * lineWidth;
                        ctx.save();
                        ctx.strokeStyle = hexToRgba(colors[i], 0.6);
                        ctx.lineWidth = lineWidth;
                        ctx.beginPath();
                        
                        var offset = i * (lineWidth + spacing);
                        var xPos = isLeft ? x + axisFullWidth - secondaryLineShift : x - axisFullWidth + secondaryLineShift;
                        
                        ctx.moveTo(xPos, y1);
                        ctx.lineTo(xPos, y2);
                        ctx.stroke();
                        ctx.restore();
                    }
                });
            }
        }]
    });
    addHideScrollbarForTouch();
}

function hexToRgba(hex, opacity) {
    // Remove the hash if it exists
    hex = hex.replace('#', '');
    
    // Parse the hex values
    var r = parseInt(hex.substring(0, 2), 16);
    var g = parseInt(hex.substring(2, 4), 16);
    var b = parseInt(hex.substring(4, 6), 16);
    
    return `rgba(${r}, ${g}, ${b}, ${opacity})`;
}

// STATS PART END


function displayComletedTextIdsForTextComp(textInfo, htmlContainer, showAverages = false) {
    const ul = document.createElement("ol");
    const textComprehensionTextsTitle = document.createElement("div");
    
    if (showAverages) {
        textComprehensionTextsTitle.innerHTML = "Sudėlioti tekstai (vidutinis klaidų skaičius):";
    } else {
        textComprehensionTextsTitle.innerHTML = "Sudėlioti tekstai:";
    }
    textComprehensionTextsTitle.classList.add("task-info-subtitle");

    // 1. Extract all [textId, mistakes, date] triples
    const allEntries = [];
    const entries = textInfo.slice(1)[0]; // Skip metadata (e.g., [2, 1])

    for (const entry of entries) {
        const [texts, date] = entry; // each entry is [texts, taskDate]

        for (const text of texts) { // texts is an array of [textId, textMistakes]
            const [textId, textMistakes] = text;
            allEntries.push({ textId, textMistakes, date });
        }
    }

    if (showAverages) {
        // Group by textId and calculate averages
        const grouped = {};
        
        for (const { textId, textMistakes } of allEntries) {
            if (!grouped[textId]) {
                grouped[textId] = {
                    textId,
                    totalMistakes: 0,
                    count: 0
                };
            }
            grouped[textId].totalMistakes += Number(textMistakes);
            grouped[textId].count += 1;
        }

        // Calculate averages and sort by highest average (descending)
        const averages = Object.values(grouped).map(item => ({
            textId: item.textId,
            average: (item.totalMistakes / item.count).toFixed(1)
        }));
        
        averages.sort((a, b) => Number(b.average) - Number(a.average));

        // Display sorted averages
        for (const { textId, average } of averages) {
            const li = document.createElement("li");
            const textIdSpan = document.createElement("span");
            const averageSpan = document.createElement("span");

            textIdSpan.innerHTML = `ID${textId}`;
            textIdSpan.classList.add("text-comprehenstion-text-id");
            textIdSpan.dataset.textId = textId;

            averageSpan.innerHTML = `: ${average}`;

            textIdSpan.addEventListener("click", (e) => {
                e.stopPropagation();
                e.preventDefault();
                const id = e.currentTarget.dataset.textId;
                openTextBrowser(Number(id));
            });

            li.appendChild(textIdSpan);
            li.appendChild(averageSpan);
            ul.appendChild(li);
        }

    } else {
        // 2. Sort by textId (ascending, converted to number)
        allEntries.sort((a, b) => Number(a.textId) - Number(b.textId));

        // 3. Display sorted entries
        for (const { textId, textMistakes, date } of allEntries) {
            const li = document.createElement("li");
            const textIdSpan = document.createElement("span");
            const mistakesNumberSpan = document.createElement("span");
            const completionDataSpan = document.createElement("span");

            textIdSpan.innerHTML = `ID${textId}`;
            textIdSpan.classList.add("text-comprehenstion-text-id");

            // Lithuanian pluralization
            let numberLabel;
            const mistakesNum = Number(textMistakes);
            if (mistakesNum === 0 || (mistakesNum > 9 && mistakesNum < 21)) {
                numberLabel = "klaidų";
            } else if (mistakesNum === 1 || String(mistakesNum).endsWith("1")) {
                numberLabel = "klaida";
            } else {
                numberLabel = "klaidos";
            }

            mistakesNumberSpan.innerHTML = `: ${textMistakes} ${numberLabel}`;
            completionDataSpan.innerHTML = ` (${date})`;
            textIdSpan.dataset.textId = textId;

            textIdSpan.addEventListener("click", (e) => {
                e.stopPropagation();
                e.preventDefault();
                const id = e.currentTarget.dataset.textId;
                openTextBrowser(Number(id));
            });

            li.appendChild(textIdSpan);
            li.appendChild(mistakesNumberSpan);
            li.appendChild(completionDataSpan);
            ul.appendChild(li);
        }
    }

    htmlContainer.appendChild(textComprehensionTextsTitle);
    htmlContainer.appendChild(ul);
}

let globalClassStatsCache = null;

function assembleClassStats() {
    // 1. Safety check: Ensure the global studentList exists and has data
    if (!studentList || studentList.length === 0) {
        console.warn("assembleClassStats: studentList is empty or undefined.");
        return null;
    }

    const classStats = {};
    
    studentList.forEach(s => {
        // 2. Critical Fix: Check if s.stats exists. 
        // Some students (especially new ones) might have null/undefined stats.
        if (!s.stats) return; 

        for (const [key, weeks] of Object.entries(s.stats)) {
            // Skip metadata keys
            if (key === "c" || key === "d") continue;
            
            if (!classStats[key]) {
                classStats[key] = [];
            }
            
            // Push this student's history for this category into the class group
            classStats[key].push(weeks);
        }
    });

    return classStats;
}


let processedStudentStats;


function displayStudentStatistics(student, studentTasks) {
    if (!globalClassStatsCache) {
        globalClassStatsCache = assembleClassStats();
    }

    processedStudentStats = transformStudentStats(student[3], globalClassStatsCache);
    const averageStudentScore = calculateAverageStudentScore(student[3]);
    const averageStudentConsistency = calculateAverageStudentsConsistency(student[3]);

    clearTaskInfoContainer();
    studentTaskStudentName.innerHTML = `
        <span class="student-name-id-holder"><span id="student-name">${student[1]}</span><span id='student-id'>(ID: ${student[0]})</span></span>
        <button class="edit-name-button" onclick="editStudentName('${student[0]}', this)">
            <span class="edit-icon">
            <img src="../images/icons/icon-edit.svg">
            </span>
        </button>
        `;
    studentTaskStudentEmail.innerHTML = student[4];

    const knowledgeOptions = [
        { value: -1, label: "Nustatykite lygį", hidden: true }, // placeholder, shown only if -1
        { value: 0, label: "Priešmokyklinis" },
        { value: 1, label: "1 klasė" },
        { value: 2, label: "2 klasė" },
        { value: 3, label: "3 klasė" },
        { value: 4, label: "4 klasė" },
        { value: 5, label: "Aukštesnis" },
    ];

    // Build the dropdown
    let selectHTML = `<div class="categories-dropdown-holder">
        <div class="knowledge-level-select-text">Žinių lygis</div>
        <select id="knowledge-level-select">
            ${knowledgeOptions.map(opt => `
                <option value="${opt.value}" ${opt.hidden ? "hidden" : ""}>${opt.label}</option>
            `).join("")}
        </select>
    </div>`;

    studentStatisticsKnowledgeLevel.innerHTML = selectHTML;
    studentStatisticsKnowledgeLevel.style.display = "block";

    studentStatisticsPerformanceMean.innerHTML = `<div class="student-points-holder"><div class="student-points-label">Taškai</div> <div class="student-points">${averageStudentScore} (${classScoreMedian})</div></div>`;
    studentStatisticsPerformanceMean.style.display = "block";

    studentStatisticsConsistencyMean.innerHTML = `<div class="student-points-holder"><div class="student-consistency-label">Nuoseklumas</div> <div class="student-points">${averageStudentConsistency}% (${classConsistencyMedian}%)</div></div>`;
    studentStatisticsConsistencyMean.style.display = "block";

    const knowledgeSelect = document.getElementById("knowledge-level-select");

    // Preselect based on DB value
    if (student[2] !== undefined) {
        knowledgeSelect.value = student[2];
    }

    // Event listener to update when changed
    knowledgeSelect.addEventListener("change", async (e) => {
        const newValue = parseInt(e.target.value, 10);
        if (newValue !== student[2]) {
            try {
                const response = await apiFetch(apiBase + `students/knowledge-level`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        studentId: Number(student[0]),
                        knowledgeLvl: Number(newValue)
                    })
                });

                if (!response) {
                    return;
                }

                if (!response.ok) {
                    throw new Error("Nepavyko atnaujinti lygio");
                }

                const data = await response.json();
                student[2] = data.knowledgeLvl; // update local student object

                // ADD THIS: Update the student in the global studentList
                const studentInList = studentList.find(s => s.id === Number(student[0]));
                if (studentInList) {
                    studentInList.knowledgeLvl = data.knowledgeLvl;
                }

                messageToTheUser("Žinių lygis sėkmingai atnaujintas!", false);
            } catch (error) {
                console.error("Error updating knowledge level:", error);
                messageToTheUser("Nepavyko atnaujinti žinių lygio. Bandykite vėliau vėl");
            }
        }
    });

    if (processedStudentStats?.c?.values?.length > 2) {
        initializeButtons();
        document.querySelector("#student-stats-graph-holder").style.display = "flex";
        document.querySelector(".student-statistics-label").innerHTML = 'Mokinio ilgalaikė statistika (savaitinis vidurkis)'
    } else {
        document.querySelector("#student-stats-graph-holder").style.display = "none";
    }

    const taskStatusSummary = countTaskStatuses(studentTasks)

    if (taskStatusSummary.total > 0) {
        studentStatisticsCompletedTasks.style.display = "block";
        studentStatisticsCompletedTasks.innerHTML = `<span class="task-info-subtitle">Baigtos užduotys:</span> ${taskStatusSummary.completed}/${taskStatusSummary.total}`
    }

    const categorizedStudentTasks = processStudentTasks(studentTasks)

    if (countTaskStatuses(studentTasks, "math").completed > 0)
        studentStatisticsMathDiv.style.display = "block";
        mistakeFrequency = Math.round(categorizedStudentTasks.math[0][1]/categorizedStudentTasks.math[0][0]*100)
        if (!isNaN(mistakeFrequency)) {
        studentStatisticsMathErrorFrequency.innerHTML = `<span class="task-info-subtitle">Klaidų dažnis:</span> ${categorizedStudentTasks.math[0][1]}/${categorizedStudentTasks.math[0][0]} (${mistakeFrequency}%)`;
        }

    if (countTaskStatuses(studentTasks, "C83").completed > 0) {
        studentStatisticsLangDiv.style.display = "block";
        mistakeFrequency = Math.round(categorizedStudentTasks.grammar[0][1]/categorizedStudentTasks.grammar[0][0]*100)
        if (!isNaN(mistakeFrequency)) {
            studentStatisticsGrammarErrorFrequency.innerHTML = `<span class="task-info-subtitle">Klaidų dažnis:</span> ${categorizedStudentTasks.grammar[0][1]}/${categorizedStudentTasks.grammar[0][0]} (${mistakeFrequency}%)`;
        }
    }

    if (countTaskStatuses(studentTasks, "C51").completed > 0 || countTaskStatuses(studentTasks, "C52").completed > 0) {
        studentStatisticsTextComprahensionDiv.style.display = "block";
    }

    if (countTaskStatuses(studentTasks, "C51").completed > 0) {
        mistakeFrequency = Math.round(categorizedStudentTasks.komponavimas[0][1]/categorizedStudentTasks.komponavimas[0][0]*100)
        if (!isNaN(mistakeFrequency)) {
            studentStatisticsKomponavimasErrorFrequency.innerHTML = `<span class="task-info-subtitle">Klaidų dažnis:</span> ${categorizedStudentTasks.komponavimas[0][1]}/${categorizedStudentTasks.komponavimas[0][0]} (${mistakeFrequency}%)`;
            studentStatisticsTextComprahensionKomponavimasTitle.style.display = "block";
        }
    }

    if (countTaskStatuses(studentTasks, "C52").completed > 0) {
        mistakeFrequency = Math.round(categorizedStudentTasks.isdestymas[0][1]/categorizedStudentTasks.isdestymas[0][0]*100)
        if (!isNaN(mistakeFrequency)) {
            studentStatisticsIsdestymasErrorFrequency.innerHTML = `<span class="task-info-subtitle">Klaidų dažnis:</span> ${categorizedStudentTasks.isdestymas[0][1]}/${categorizedStudentTasks.isdestymas[0][0]} (${mistakeFrequency}%)`;
            studentStatisticsTextComprahensionIsdestymasTitle.style.display = "block";
        }
    }


    const combinedMathAndGrammarMistakes = [...categorizedStudentTasks.math[1], ...categorizedStudentTasks.grammar[1]]

    if (combinedMathAndGrammarMistakes.length > 0) {
        generateSummaryTable("custom", combinedMathAndGrammarMistakes, "summary-table", "summary-table-grammar") 
    }


    document.querySelector("#mistakes-summary-math").style.display = "block";
    document.querySelector("#mistakes-summary-grammar").style.display = "block";
    if (document.querySelector("#summary-table").innerHTML === "Klaidų nėra!" || document.querySelector("#summary-table").innerHTML === '') {
        document.querySelector("#mistakes-summary-math").style.display = "none";
    }

    if (document.querySelector("#summary-table-grammar").innerHTML === "Klaidų nėra!" || document.querySelector("#summary-table-grammar").innerHTML === '') {
        document.querySelector("#mistakes-summary-grammar").style.display = "none";
    }


    if (categorizedStudentTasks.isdestymas[1].length > 0) {
        displayComletedTextIdsForTextComp(categorizedStudentTasks.isdestymas, studentStatisticsIsdestymasCompletedTexts)
    }
    if (categorizedStudentTasks.komponavimas[1].length > 0) {
        displayComletedTextIdsForTextComp(categorizedStudentTasks.komponavimas, studentStatisticsKomponavimasCompletedTexts)
    }
}

function calculateClassMeanStats(students) {
    if (!students || students.length === 0) {
        return { c: [], m: [], t: [], g: [], d: 0 };
    }

    /**
     * Filters outliers using the Interquartile Range (IQR) method
     * and calculates the arithmetic mean of the remaining values.
     */
    function calculateCleanMean(arr) {
        if (arr.length === 0) return 0;
        if (arr.length <= 2) return arr.reduce((a, b) => a + b, 0) / arr.length;

        const sorted = [...arr].sort((a, b) => a - b);
        
        // Calculate Quartiles
        const q1 = sorted[Math.floor((sorted.length / 4))];
        const q3 = sorted[Math.floor((sorted.length * (3 / 4)))];
        const iqr = q3 - q1;

        // Define Bounds
        const lowerBound = q1 - 1.5 * iqr;
        const upperBound = q3 + 1.5 * iqr;

        // Filter and Average
        const validValues = sorted.filter(v => v >= lowerBound && v <= upperBound);
        
        // If IQR filtering removes everything (rare), fallback to original array
        const finalSet = validValues.length > 0 ? validValues : sorted;
        return finalSet.reduce((a, b) => a + b, 0) / finalSet.length;
    }

    const maxLengths = {
        c: Math.max(...students.map(s => s.stats.c?.length || 0)),
        m: Math.max(...students.map(s => s.stats.m?.length || 0)),
        t: Math.max(...students.map(s => s.stats.t?.length || 0)),
        g: Math.max(...students.map(s => s.stats.g?.length || 0))
    };

    // Calculate Clean Mean for consistency (c)
    const meanC = [];
    for (let i = 0; i < maxLengths.c; i++) {
        const values = students
            .map(s => {
                const arr = s.stats.c || [];
                const index = arr.length - maxLengths.c + i;
                return index >= 0 ? arr[index] : null;
            })
            .filter(v => v !== null && v !== undefined);
        
        if (values.length > 0) {
            meanC.push(calculateCleanMean(values));
        }
    }

    // Calculate Clean Mean for multi-value categories (m, t, g)
    function calculateMeanForCategory(category, maxLength) {
        const result = [];
        for (let i = 0; i < maxLength; i++) {
            const meanEntry = [0, 0, 0, 0];
            for (let j = 0; j < 4; j++) {
                const values = students
                    .map(s => {
                        const arr = s.stats[category] || [];
                        const index = arr.length - maxLength + i;
                        return index >= 0 ? arr[index]?.[j] : null;
                    })
                    .filter(v => v !== null && v !== undefined);

                if (values.length > 0) {
                    meanEntry[j] = calculateCleanMean(values);
                }
            }
            result.push(meanEntry);
        }
        return result;
    }

    return {
        c: meanC,
        m: calculateMeanForCategory('m', maxLengths.m),
        t: calculateMeanForCategory('t', maxLengths.t),
        g: calculateMeanForCategory('g', maxLengths.g),
        d: Math.max(...students.map(s => s.stats.d || 0))
    };
}

function averageTransformedStats(transformedStatsArray) {
    if (!transformedStatsArray || transformedStatsArray.length === 0) {
        return {};
    }

    // Helper function
    function winsorizedMean(values, percentile = 0.90) {
        if (values.length === 0) return 0;
        
        const sorted = [...values].sort((a, b) => a - b);
        const capIndex = Math.floor(sorted.length * percentile);
        const cap = sorted[Math.max(0, capIndex - 1)];
        
        const winsorized = values.map(v => Math.min(v, cap));
        return winsorized.reduce((a, b) => a + b, 0) / winsorized.length;
    }

    const result = {};

    for (const key in transformedStatsArray[0]) {
        if (key === 'd') {
            result[key] = Math.max(...transformedStatsArray.map(s => s[key] || 0));
            continue;
        }

        const subjectData = transformedStatsArray[0][key];
        
        if (key === 'c') {
            // Consistency metric
            result[key] = {
                title: subjectData.title,
                values: []
            };
            
            const maxLength = Math.max(...transformedStatsArray.map(s => 
                s[key]?.values?.length || 0
            ));
            
            for (let weekIdx = 0; weekIdx < maxLength; weekIdx++) {
                const weekValues = transformedStatsArray.map(s => {
                    const arr = s[key]?.values || [];
                    const index = arr.length - maxLength + weekIdx;
                    return index >= 0 ? (arr[index] || 0) : 0;
                });

                const mean = winsorizedMean(weekValues);
                result[key].values.push(mean);
            }
        } else {
            // Subject metrics
            result[key] = { 
                title: subjectData.title, 
                values: {} 
            };

            for (const metricIdx in subjectData.values) {
                const metricData = subjectData.values[metricIdx];
                result[key].values[metricIdx] = {
                    title: metricData.title,
                    values: []
                };

                const maxLength = Math.max(...transformedStatsArray.map(s => 
                    s[key]?.values?.[metricIdx]?.values?.length || 0
                ));

                for (let weekIdx = 0; weekIdx < maxLength; weekIdx++) {
                    // Relative difficulty index (usually 5)
                    if (parseInt(metricIdx, 10) === 5) {
                        result[key].values[metricIdx].values.push(1); // Always 1
                        continue;
                    }

                    // Total Answers metric
                    if (parseInt(metricIdx, 10) === 4) {
                        const classSize = transformedStatsArray.length;
                        let totalSum = 0;
                        let studentsReached = 0;

                        for (let studentIdx = 0; studentIdx < classSize; studentIdx++) {
                            const student = transformedStatsArray[studentIdx];
                            const arr = student[key]?.values?.[metricIdx]?.values || [];
                            const index = arr.length - maxLength + weekIdx;
                            const val = index >= 0 ? (arr[index] || 0) : 0;
                            totalSum += val;
                            if (val > 0) studentsReached++;
                        }

                        const weekValues = transformedStatsArray.map(s => {
                            const arr = s[key]?.values?.[metricIdx]?.values || [];
                            const index = arr.length - maxLength + weekIdx;
                            return index >= 0 ? (arr[index] || 0) : 0;
                        });

                        const mean = winsorizedMean(weekValues, 0.90);

                        const fractionReached = studentsReached / classSize;
                        const adjustedMean = mean * fractionReached;

                        result[key].values[metricIdx].values.push(adjustedMean);
                        continue;
                    }

                    // Normal case for other metrics
                    const weekValues = transformedStatsArray.map(s => {
                        const arr = s[key]?.values?.[metricIdx]?.values || [];
                        const index = arr.length - maxLength + weekIdx;
                        return index >= 0 ? (arr[index] || 0) : 0;
                    });

                    const mean = winsorizedMean(weekValues, 0.90);
                    result[key].values[metricIdx].values.push(mean);
                }
            }
        }
    }

    return result;
}

function mergeAllStudentTasks(students) {
    if (!students || students.length === 0) {
        return [];
    }

    // Collect all tasks from all students
    const allTasks = [];
    
    students.forEach(student => {
        if (student.tasks && Array.isArray(student.tasks)) {
            student.tasks.forEach(task => {
                allTasks.push({
                    assignmentId: task.assignmentId,
                    status: task.status,
                    result: task.result,
                    completionDate: task.completionDate,
                    group: task.group,
                    duration: task.duration,
                    taskDescription: task.taskDescription
                });
            });
        }
    });

    // Sort by assignmentId to maintain some order
    allTasks.sort((a, b) => a.assignmentId - b.assignmentId);

    // Reindex assignmentIds to avoid conflicts
    // Start from the highest existing assignmentId + 1 to ensure no conflicts
    const maxExistingId = Math.max(
        ...allTasks.map(t => t.assignmentId),
        0
    );

    const reindexedTasks = allTasks.map((task, index) => ({
        ...task,
        assignmentId: maxExistingId + index + 1
    }));

    return reindexedTasks;
}

function displayTeacherHome(selectedGroupNames=null) {
    if (!globalClassStatsCache) {
        globalClassStatsCache = assembleClassStats();
    }

    // Deep copy studentList
    studentListFiltered = JSON.parse(JSON.stringify(studentList));
    
    // Filter tasks if selectedGroupNames is provided
    if (selectedGroupNames && selectedGroupNames.length > 0) {
        studentListFiltered = studentListFiltered
            .map(student => ({
                ...student,
                tasks: student.tasks.filter(task => selectedGroupNames.includes(task.group))
            }))
            .filter(student => student.tasks.length > 0); // Remove students with no matching tasks
    }

    clearTaskInfoContainer();
    studentTaskStudentName.innerHTML = `
        <span class="student-name-id-holder"><span id="student-name">KLASĖS APŽVALGA</span>
        `;


    studentStatisticsPerformanceMean.innerHTML = `<div class="student-points-holder"><div class="student-points-label">Vidutiniai taškai</div> <div class="student-points">${classScoreMedian}</div></div>`;
    studentStatisticsPerformanceMean.style.display = "block";

    studentStatisticsConsistencyMean.innerHTML = `<div class="student-points-holder"><div class="student-consistency-label">Vidutinis nuoseklumas</div> <div class="student-points">${classConsistencyMedian}%</div></div>`;
    studentStatisticsConsistencyMean.style.display = "block";

    const knowledgeSelect = document.getElementById("knowledge-level-select");

    // Calculate transformed stats for each student first
    const allTransformedStats = studentListFiltered.map(student => 
        transformStudentStats(student.stats, globalClassStatsCache)
    );

    // Now average the ALREADY-TRANSFORMED relative difficulties
    processedStudentStats = averageTransformedStats(allTransformedStats);

    if (processedStudentStats?.c?.values?.length > 2) {
        initializeButtons();
        document.querySelector(".student-statistics-label").innerHTML = 'Klasės ilgalaikė statistika (savaitinis vidurkis)'
        document.querySelector("#student-stats-graph-holder").style.display = "flex";
    } else {
        document.querySelector("#student-stats-graph-holder").style.display = "none";
    }

    const studentTasks = mergeAllStudentTasks(studentListFiltered)

    const taskStatusSummary = countTaskStatuses(studentTasks)

    if (taskStatusSummary.total > 0) {
        studentStatisticsCompletedTasks.style.display = "block";
        studentStatisticsCompletedTasks.innerHTML =
            `<span class="task-info-subtitle">Baigtos užduotys:</span> ${taskStatusSummary.completed}/${taskStatusSummary.total}` +
            (taskStatusSummary.total ? ` (${Math.round(taskStatusSummary.completed / taskStatusSummary.total * 100)}%)` : "");

    }

    const categorizedStudentTasks = processStudentTasks(studentTasks)

    if (countTaskStatuses(studentTasks, "math").completed > 0)
        studentStatisticsMathDiv.style.display = "block";
        mistakeFrequency = Math.round(categorizedStudentTasks.math[0][1]/categorizedStudentTasks.math[0][0]*100)
        if (!isNaN(mistakeFrequency)) {
        studentStatisticsMathErrorFrequency.innerHTML = `<span class="task-info-subtitle">Klaidų dažnis:</span> ${categorizedStudentTasks.math[0][1]}/${categorizedStudentTasks.math[0][0]} (${mistakeFrequency}%)`;
        }

    if (countTaskStatuses(studentTasks, "C83").completed > 0) {
        studentStatisticsLangDiv.style.display = "block";
        mistakeFrequency = Math.round(categorizedStudentTasks.grammar[0][1]/categorizedStudentTasks.grammar[0][0]*100)
        if (!isNaN(mistakeFrequency)) {
            studentStatisticsGrammarErrorFrequency.innerHTML = `<span class="task-info-subtitle">Klaidų dažnis:</span> ${categorizedStudentTasks.grammar[0][1]}/${categorizedStudentTasks.grammar[0][0]} (${mistakeFrequency}%)`;
        }
    }

    if (countTaskStatuses(studentTasks, "C51").completed > 0 || countTaskStatuses(studentTasks, "C52").completed > 0) {
        studentStatisticsTextComprahensionDiv.style.display = "block";
    }

    if (countTaskStatuses(studentTasks, "C51").completed > 0) {
        mistakeFrequency = Math.round(categorizedStudentTasks.komponavimas[0][1]/categorizedStudentTasks.komponavimas[0][0]*100)
        if (!isNaN(mistakeFrequency)) {
            studentStatisticsKomponavimasErrorFrequency.innerHTML = `<span class="task-info-subtitle">Klaidų dažnis:</span> ${categorizedStudentTasks.komponavimas[0][1]}/${categorizedStudentTasks.komponavimas[0][0]} (${mistakeFrequency}%)`;
            studentStatisticsTextComprahensionKomponavimasTitle.style.display = "block";
        }
    }

    if (countTaskStatuses(studentTasks, "C52").completed > 0) {
        mistakeFrequency = Math.round(categorizedStudentTasks.isdestymas[0][1]/categorizedStudentTasks.isdestymas[0][0]*100)
        if (!isNaN(mistakeFrequency)) {
            studentStatisticsIsdestymasErrorFrequency.innerHTML = `<span class="task-info-subtitle">Klaidų dažnis:</span> ${categorizedStudentTasks.isdestymas[0][1]}/${categorizedStudentTasks.isdestymas[0][0]} (${mistakeFrequency}%)`;
            studentStatisticsTextComprahensionIsdestymasTitle.style.display = "block";
        }
    }


    const combinedMathAndGrammarMistakes = [...categorizedStudentTasks.math[1], ...categorizedStudentTasks.grammar[1]]

    if (combinedMathAndGrammarMistakes.length > 0) {
        generateSummaryTable("custom", combinedMathAndGrammarMistakes, "summary-table", "summary-table-grammar", usePercentage=true) 
    }


    document.querySelector("#mistakes-summary-math").style.display = "block";
    document.querySelector("#mistakes-summary-grammar").style.display = "block";
    if (document.querySelector("#summary-table").innerHTML === "Klaidų nėra!" || document.querySelector("#summary-table").innerHTML === '') {
        document.querySelector("#mistakes-summary-math").style.display = "none";
    }

    if (document.querySelector("#summary-table-grammar").innerHTML === "Klaidų nėra!" || document.querySelector("#summary-table-grammar").innerHTML === '') {
        document.querySelector("#mistakes-summary-grammar").style.display = "none";
    }


    if (categorizedStudentTasks.isdestymas[1].length > 0) {
        displayComletedTextIdsForTextComp(categorizedStudentTasks.isdestymas, studentStatisticsIsdestymasCompletedTexts, showAverages=true)
    }
    if (categorizedStudentTasks.komponavimas[1].length > 0) {
        displayComletedTextIdsForTextComp(categorizedStudentTasks.komponavimas, studentStatisticsKomponavimasCompletedTexts, showAverages=true)
    }
}
                

        function displayTaskInfo(student, task) {
            clearTaskInfoContainer();

            taskDescriptionTitle.style.display = "block"
            teacherDispalyStudentTaskIndicator.style.display = "block"

            currentTaskInstructions = task.taskDescription;
            currentTaskDuration = JSON.parse(task.duration);

            const parsedTaskDescription = JSON.parse(currentTaskInstructions);

            const formattedTaskDescription = getOptionTextFromValues(parsedTaskDescription, currentTaskDuration, forTeacher=true);
            studentTaskStudentName.innerHTML = `
                <span class="student-name-id-holder"><span id="student-name">${student[1]}</span><span id='student-id'>(ID: ${student[0]})</span></span>
                <button class="edit-name-button" onclick="editStudentName('${student[0]}', this)">
                    <span class="edit-icon">
                    <img src="../images/icons/icon-edit.svg">
                    </span>
                </button>
                `;
            studentTaskStudentEmail.innerHTML = student[2];

            studentTaskGroup.innerHTML = `Užduotis: ${task.group}`;
            teacherDispalyStudentTaskIndicator.style.backgroundColor = task.status ? greenCircleColorCode : redCircleColorCode;
            if (task.status) {
                studentTaskCompletionDate.innerHTML = `<span class="task-info-subtitle">Data</span>: ${task.completionDate.split('T')[0]}`
            }
            if (task.result !== '') {
                const parsedTaskResult = JSON.parse(task.result)
                const score = parsedTaskResult[0]
                const textComprehensionrResults = parsedTaskResult[1]

                if (JSON.parse(task.taskDescription)[1] === "C49") {
                    const ul = document.createElement("ol");
                    const textComprehensionTextsTitle = document.createElement("div");
                    textComprehensionTextsTitle.innerHTML = "Sudėlioti tekstai:";
                    textComprehensionTextsTitle.classList.add("task-info-subtitle");

                    textComprehensionrResults.forEach(([outerKey, value]) => {
                        const li = document.createElement("li");
                        const textIdSpan = document.createElement("span");
                        const mistakesNumberSpan = document.createElement("span");
                        textIdSpan.innerHTML = `ID${outerKey}`;
                        textIdSpan.classList.add("text-comprehenstion-text-id");
                        let numberLabel = ''
                        if (Number(value) === 0 || (Number(value) > 9 && Number(value) < 21)) {
                            numberLabel = "klaidų";
                        } else if (Number(value) === 1 || Number(value.toString().slice(-1)) === 1) {
                            numberLabel = "klaida";
                        } else if (Number(value) < 10 || Number(value) > 21) {
                            numberLabel = "klaidos";
                        }
                        mistakesNumberSpan.innerHTML = `: ${value} ${numberLabel}`;
                        textIdSpan.dataset.textId = outerKey;

                        li.appendChild(textIdSpan)
                        li.appendChild(mistakesNumberSpan)

                        textIdSpan.addEventListener("click", () => {
                            const id = event.currentTarget.dataset.textId;
                            openTextBrowser(Number(id));
                        });

                        ul.appendChild(li);
                    });
                    textComprehensionMistakesSummary.appendChild(textComprehensionTextsTitle);
                    textComprehensionMistakesSummary.appendChild(ul);
                }

                const taskInfo = JSON.parse(task.taskDescription)
                if ((taskInfo[0] === "math" && currentTaskDuration[0] === "C40") || (taskInfo[0] === "lang" && currentTaskDuration[0]  === "C40")) {
                    studentScoreDuration.innerHTML = `<span class="task-info-subtitle">Trukmė:</span> ${JSON.parse(task.result)[2]}`
                }

                if (parsedTaskDescription[0] === "math") {
                    studentScoreAnswerNumber.innerHTML = `<span class="task-info-subtitle">Atlikti veiksmai:</span> ${score[0]}`;
                    studentScoreMistakeNumber.innerHTML = `<span class="task-info-subtitle">Klaidos:</span> ${score[1]}`;
                } else if (parsedTaskDescription[0] === "lang") {
                    if (parsedTaskDescription[1] === "C83") {
                        if (parsedTaskDescription[2] === "C50") {
                            studentScoreAnswerNumber.innerHTML = `<span class="task-info-subtitle">Įrašytos raidės:</span> ${score[0]}`;
                            studentScoreMistakeNumber.innerHTML = `<span class="task-info-subtitle">Klaidos:</span> ${score[1]}`;
                        }
                    } else if (parsedTaskDescription[1] === "C49") {
                        studentScoreAnswerNumber.innerHTML = `<span class="task-info-subtitle">Sudėliotų tekstų skaičius:</span> ${score[0]}`;
                        studentScoreMistakeNumber.innerHTML = `<span class="task-info-subtitle">Klaidos:</span> ${score[1]}`;
                    }
                }

                if (taskInfo[0] === "math" || (taskInfo[0] === "lang" && taskInfo[1] === "C83")) {
                    let mistakesList = [];
                    mistakesList = JSON.parse(task.result)[1]
                    if (mistakesList.length > 0) {
                        generateSummaryTable("custom", mistakesList) 
                    }
                }

                if (parsedTaskDescription[0] === "math") {
                    document.querySelector("#mistakes-summary-math").style.display = "block";
                    document.querySelector("#mistakes-summary-grammar").style.display = "none";
                } else if (parsedTaskDescription[0] === "lang" && parsedTaskDescription[1] === "C83") {
                    document.querySelector("#mistakes-summary-math").style.display = "none";
                    document.querySelector("#mistakes-summary-grammar").style.display = "block";
                } else {
                    document.querySelector("#mistakes-summary-math").style.display = "none";
                    document.querySelector("#mistakes-summary-grammar").style.display = "none";
                }

                if (document.querySelector("#summary-table").innerHTML === "Klaidų nėra!" || document.querySelector("#summary-table").innerHTML === '') {
                    document.querySelector("#mistakes-summary-math").style.display = "none";
                }
                if (document.querySelector("#summary-table-grammar").innerHTML === "Klaidų nėra!" || document.querySelector("#summary-table-grammar").innerHTML === '') {
                    document.querySelector("#mistakes-summary-grammar").style.display = "none";
                }
            }

            taskDescriptionList = document.createElement('ul');
            taskDescriptionList.classList.add("task-description-list");

            formattedTaskDescription.forEach(item => {
                if (item) {  // Ensure empty values are not added
                    let listItem = document.createElement('li');
                    
                    // Check if item contains an HTML tag, then use innerHTML
                    if (item.includes("<")) {
                        listItem.innerHTML = item; // Render HTML properly
                    } else {
                        listItem.textContent = item; // Use textContent for plain text
                    }
                    
                    listItem.classList.add("task-description-list-item");
                    taskDescriptionList.appendChild(listItem);
                }
            });

            taskDescription.appendChild(taskDescriptionList);

        }

        async function displayStudentTaskInfo(task) {
            clearTaskInfoContainerForStudents()
            document.querySelector('.task-info-holder-student').style.display = "flex";
            currentTaskId = task.assignmentId
            currentTaskInstructions = task.taskInstructions
            const parsedTaskDescription = JSON.parse(currentTaskInstructions);

            currentTaskDuration = JSON.parse(task.duration);

            const formattedTaskDescription = getOptionTextFromValues(parsedTaskDescription, currentTaskDuration);

            studentTaskGroupForStudent.innerHTML = `Užduotis: ${task.group}`;

            teacherDispalyStudentTaskIndicatorForStudent.style.display = "block";
            teacherDispalyStudentTaskIndicatorForStudent.style.backgroundColor = task.status ? greenCircleColorCode : redCircleColorCode;
            if (task.status) {
                studentTaskCompletionDateForStudents.innerHTML = `<span class="task-info-subtitle">Data</span>: ${task.completionDate.split('T')[0]}`
            }

            if (task.status) {
                completeTaskButtonHolder.style.display = "none";
            } else {
                completeTaskButtonHolder.style.display = "flex";

                let numberOfQuestions;
                let answeringMode;
                let earningsDiplay = "";

                answeringMode = currentTaskDuration[0]
                numberOfQuestions = currentTaskDuration[1]

                let potentialEarnings;
                if (answeringMode === "C39" || parsedTaskDescription[1] === "C83") {
                    potentialEarnings = await calculateTasksPerCorrectAnswerPoints(JSON.parse(task.taskInstructions));
                    if (potentialEarnings != null) {
                        potentialEarnings = Number(potentialEarnings.toFixed(2))
                    }
                    earningsDiplay = `
                        <div class="earnings-estimation-outer">
                            <button class="earnings-estimation-display info-button"
                                onclick="openObjectPopup(infoMessages['coin-amount-custom-timer'].content, infoMessages['coin-amount-custom-timer'].title, infoMessages['coin-amount-custom-timer'].subtitle)">
                                <div class="potetnital-earnings-amount-and-info-holder">
                                    <span class="potetnital-earnings-coin-icon-and-amount-holder">
                                    <span class="earnings-iki-holder">
                                        x
                                    </span>
                                    <span class="coin-icon">
                                            <img src="../images/icons/icon-sudedu-coin.png">
                                    </span>
                                    <span class="coin-amount">${potentialEarnings}</span>
                                    </span>
                                    <div 
                                        class="info-icon"
                                        >
                                    <svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 256 256" xml:space="preserve">
                                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">
                                        <path d="M 49.083 71.489 l 5.776 -21.96 l 4.186 -15.247 c 3.497 -16.18 -32.704 -2.439 -38.002 1.695 l 0.425 4.853 c 4.824 -3.395 23.091 -7.744 19.449 4.275 l -1.634 6.135 l 0 0 l -8.329 31.071 c -3.497 16.18 32.704 2.439 38.002 -1.695 l -0.425 -4.853 C 63.708 79.159 45.441 83.508 49.083 71.489 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/>
                                        <circle cx="53.871" cy="11.201" r="11.201" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>
                                    </g>
                                    </svg>
                                    </div>
                                </div>
                            </button>
                        </div>
                        `
                } else if (answeringMode === "C40") {
                    let parsedTaskInfo = JSON.parse(task.taskInstructions)
                    if (parsedTaskInfo[0] === "lang" && parsedTaskInfo[1] === "C49" && parsedTaskInfo[4] === "C84") {
                        potentialEarnings = await calculateTasksPerCorrectAnswerPoints("selectedTexts", {taskSettings: [parsedTaskInfo,numberOfQuestions]});
                        if (potentialEarnings != null && potentialEarnings[0] != null) {
                            potentialEarnings = Number(potentialEarnings[0].toFixed(2))
                        }
                    } else {
                        potentialEarnings = await calculateTasksPerCorrectAnswerPoints(JSON.parse(task.taskInstructions));
                        if (potentialEarnings != null) {
                            potentialEarnings = Number((potentialEarnings * numberOfQuestions).toFixed(2))
                        }
                    }
                    earningsDiplay = `
                        <div class="earnings-estimation-outer">
                            <button class="earnings-estimation-display info-button"
                                onclick="openObjectPopup(infoMessages['coin-amount-custom-question-number'].content, infoMessages['coin-amount-custom-question-number'].title, infoMessages['coin-amount-custom-question-number'].subtitle)">
                                <div class="potetnital-earnings-amount-and-info-holder">
                                    <span class="potetnital-earnings-coin-icon-and-amount-holder">
                                    <span class="earnings-iki-holder">
                                        IKI
                                    </span>
                                    <span class="coin-icon">
                                            <img src="../images/icons/icon-sudedu-coin.png">
                                    </span>
                                    <span class="coin-amount">${potentialEarnings}</span>
                                    </span>
                                    <div 
                                        class="info-icon"
                                        >
                                    <svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 256 256" xml:space="preserve">
                                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">
                                        <path d="M 49.083 71.489 l 5.776 -21.96 l 4.186 -15.247 c 3.497 -16.18 -32.704 -2.439 -38.002 1.695 l 0.425 4.853 c 4.824 -3.395 23.091 -7.744 19.449 4.275 l -1.634 6.135 l 0 0 l -8.329 31.071 c -3.497 16.18 32.704 2.439 38.002 -1.695 l -0.425 -4.853 C 63.708 79.159 45.441 83.508 49.083 71.489 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/>
                                        <circle cx="53.871" cy="11.201" r="11.201" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>
                                    </g>
                                    </svg>
                                    </div>
                                </div>
                            </button>
                        </div>
                        `
                }

                document.querySelector(".coin-display-holder").innerHTML = earningsDiplay
            }

            if (task.result !== '') {
                const parsedTaskResult = JSON.parse(task.result)
                const score = parsedTaskResult[0]
                const textComprehensionrResults = parsedTaskResult[1]

                const taskInfo = JSON.parse(task.taskInstructions)
                if ((taskInfo[0] === "math" && currentTaskDuration[0] === "C40") || (taskInfo[0] === "lang" && currentTaskDuration[0] === "C40")) {
                    studentScoreDurationForStudent.innerHTML = `<span class="task-info-subtitle">Trukmė:</span> ${JSON.parse(task.result)[2]}`
                }

 
                if (parsedTaskDescription[0] === "math") {
                    studentScoreAnswerNumberForStudent.innerHTML = `<span class="task-info-subtitle">Atlikti veiksmai:</span> ${score[0]}`;
                    studentScoreMistakeNumberForStudent.innerHTML = `<span class="task-info-subtitle">Klaidos</span>: ${score[1]}`;
                } else if (parsedTaskDescription[0] === "lang") {
                    if (parsedTaskDescription[1] === "C83") {
                        studentScoreAnswerNumberForStudent.innerHTML = `<span class="task-info-subtitle">Irašytos raidės:</span> ${score[0]}`;
                        studentScoreMistakeNumberForStudent.innerHTML = `<span class="task-info-subtitle">Klaidos:</span> ${score[1]}`;
                    } else if (parsedTaskDescription[1] === "C49") {
                        studentScoreAnswerNumberForStudent.innerHTML = `<span class="task-info-subtitle">Sudėliotų tekstų skaičius:</span> ${score[0]}`;
                        studentScoreMistakeNumberForStudent.innerHTML = `<span class="task-info-subtitle">Klaidos:</span> ${score[1]}`;
                    }
                }

                if (taskInfo[0] === "math" || (taskInfo[0] === "lang" && taskInfo[1] === "C83")) {
                    let mistakesList = [];
                    mistakesList = JSON.parse(task.result)[1]

                    if (mistakesList.length > 0) {
                        generateSummaryTable("custom", mistakesList, "summary-table-for-student", "summary-table-grammar-for-student") 
                    }
                }

                if (parsedTaskDescription[0] === "math") {
                    document.querySelector("#mistakes-summary-math-for-student").style.display = "block";
                    document.querySelector("#mistakes-summary-grammar-for-student").style.display = "none";
                } else if (parsedTaskDescription[0] === "lang" && parsedTaskDescription[1] === "C83") {
                    document.querySelector("#mistakes-summary-math-for-student").style.display = "none";
                    document.querySelector("#mistakes-summary-grammar-for-student").style.display = "block";
                } else {
                    document.querySelector("#mistakes-summary-math-for-student").style.display = "none";
                    document.querySelector("#mistakes-summary-grammar-for-student").style.display = "none";
                }

                if (document.querySelector("#summary-table-for-student").innerHTML === "Klaidų nėra!" || document.querySelector("#summary-table-for-student").innerHTML === "") {
                    document.querySelector("#mistakes-summary-math-for-student").style.display = "none";
                }
                if (document.querySelector("#summary-table-grammar-for-student").innerHTML === "Klaidų nėra!" || document.querySelector("#summary-table-grammar-for-student").innerHTML === "") {
                    document.querySelector("#mistakes-summary-grammar-for-student").style.display = "none";
                }

                if (taskInfo[0] === "math" || (taskInfo[0] === "lang" && taskInfo[1] === "C83")) {
                    let mistakesList = [];
                    mistakesList = JSON.parse(task.result)[1]
                    if (mistakesList.length > 0) {
                        generateSummaryTable("custom", mistakesList, "summary-table-for-student") 
                    }
                }
            }

            taskDescriptionList = document.createElement('ul');
            taskDescriptionList.classList.add("task-description-list")
            formattedTaskDescription.forEach(item => {
                if (item) {  // Ensure empty values are not added
                    if (!item.includes("KLASĖ")) {
                        let listItem = document.createElement('li');
                        
                        // Check if item contains an HTML tag, then use innerHTML
                        if (item.includes("<")) {
                            listItem.innerHTML = item; // Render HTML properly
                        } else {
                            listItem.textContent = item; // Use textContent for plain text
                        }
                        
                        listItem.classList.add("task-description-list-item");
                        taskDescriptionList.appendChild(listItem);
                    }
                }
            });
            let description = document.createElement('div');
            description.innerHTML = '<span class="task-info-subtitle">Užduoties aprašymas:</span>'

            taskDescriptionForStudent.appendChild(description);
            taskDescriptionForStudent.appendChild(taskDescriptionList);
        }

        function populateTaskGroupDropdown() {
            const menu = document.getElementById("task-group-menu");
            menu.innerHTML = ''; 

            const taskGroups = new Set();

            studentList.forEach(student => {
                student.tasks.forEach(task => {
                    taskGroups.add(task.group);
                });
            });

            const sortedGroups = Array.from(taskGroups).sort();

            // --- Add "Visos" checkbox ---
            const selectAll = document.createElement("div");
            selectAll.className = "dropdown-item";
            selectAll.innerHTML = `
                <input type="checkbox" id="select-all-checkbox" checked>
                Visos užduočių grupės
            `;

            menu.appendChild(selectAll);

            const innerGroupNames = document.createElement("div");
            innerGroupNames.classList = "group-dropdown-inner-group-list"

            // --- Add each group checkbox ---
            sortedGroups.forEach(group => {
                const label = document.createElement("label");
                label.className = "dropdown-item";
                label.innerHTML = `
                    <input type="checkbox" class="option-checkbox" value="${group}" checked>
                    ${group}
                `;
                innerGroupNames.appendChild(label);
            });

            menu.appendChild(innerGroupNames);

            // Only attach dropdown logic if there are groups
            if (sortedGroups.length > 0) {
                attachDropdownCheckboxLogic();
            } else {
                // If no groups, just update the count to show 0/0
                updateTaskGroupCount();
            }
        }

        function updateTaskGroupCount() {
            const menu = document.getElementById("task-group-menu");
            const checkboxes = [...menu.querySelectorAll(".option-checkbox")];
            const selectedCount = checkboxes.filter(cb => cb.checked).length;
            const totalCount = checkboxes.length;

            const counter = document.getElementById("task-group-count");
            counter.textContent = `${selectedCount} / ${totalCount}`;
        }

        function attachDropdownCheckboxLogic() {
            const menu = document.getElementById("task-group-menu");
            const selectAll = document.getElementById("select-all-checkbox");
            const checkboxes = [...menu.querySelectorAll(".option-checkbox")];

            selectAll.addEventListener("change", () => {
                checkboxes.forEach(cb => cb.checked = selectAll.checked);
                menu.dispatchEvent(new Event("change"));
                updateTaskGroupCount();
            });

            checkboxes.forEach(cb => {
                cb.addEventListener("change", () => {
                    const allChecked = checkboxes.every(x => x.checked);
                    selectAll.checked = allChecked;
                    menu.dispatchEvent(new Event("change"));
                    updateTaskGroupCount();
                });
            });

            // Initial count
            updateTaskGroupCount();
        }


        function restoreAllIfNoneSelected(selectAllAnyway=false) {
            const menu = document.getElementById("task-group-menu");
            const checkboxes = [...menu.querySelectorAll(".option-checkbox")];
            const selectAll = document.getElementById("select-all-checkbox");

            // If there are no checkboxes (no task groups), just return
            if (checkboxes.length === 0) {
                if (selectAll) {
                    selectAll.checked = true;
                }
                updateTaskGroupCount();
                return;
            }

            const noneSelected = checkboxes.every(cb => !cb.checked);

            if (noneSelected || selectAllAnyway) {
                selectAll.checked = true;
                checkboxes.forEach(cb => cb.checked = true);
                menu.dispatchEvent(new Event("change"));
            }

            updateTaskGroupCount();
        }


        function handleTaskGroupChange() {
            const menu = document.getElementById("task-group-menu");
            const button = document.getElementById("task-group-sorting");
            let selectedGroups = []; // List of selected checkbox values

            menu.addEventListener("change", () => {
                const checkboxes = [...document.querySelectorAll(".option-checkbox")];
                const selected = checkboxes
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);

                const allSelected = document.getElementById("select-all-checkbox").checked;

                // Update selectedGroups list (excluding "select-all")
                if (allSelected) {
                    selectedGroups = [];
                } else {
                    selectedGroups = selected;
                }

                let filteredStudents;

                if (allSelected || selected.length === 0) {
                    filteredStudents = studentList;
                } else {
                    filteredStudents = studentList
                        .map(student => ({
                            ...student,
                            tasks: student.tasks.filter(task => selected.includes(task.group))
                        }))
                        .filter(student => student.tasks.length > 0);
                }

                // Re-render
                taskContainerVisible = false;
                toggleTaskVisibility();
                
                renderDataForTeachers(filteredStudents);
                
                displayTeacherHome(selectedGroups);
            });
        }


        if (userData && userData.accType === "teacher") {
            handleTaskGroupChange();
        }

        const toggleBtn = document.querySelector(".dropdown-wrapper");
        const menu = document.getElementById("task-group-menu");

        toggleBtn.addEventListener("click", e => {
            e.stopPropagation();
            menu.classList.toggle("hidden");
            restoreAllIfNoneSelected();
        });

        // Prevent clicks inside the menu from bubbling up and closing it
        menu.addEventListener("click", e => {
            e.stopPropagation();
        });

        document.addEventListener("click", e => {
            if (!menu.contains(e.target) && e.target !== toggleBtn) {
                menu.classList.add("hidden");
                restoreAllIfNoneSelected();
            }
        });

        function medianStudentScore(students) {
        const studentAverages = students.map(student => {
            const stats = student.stats;
            const validKeys = Object.keys(stats).filter(k => !['c', 'd'].includes(k));

            let allRatios = [];

            for (const key of validKeys) {
            const statArray = stats[key];
            if (Array.isArray(statArray)) {
                for (const sub of statArray) {
                if (Array.isArray(sub) && sub.length >= 4) {
                    const points = sub[0];
                    allRatios.push(points);
                }
                }
            }
            }

            if (allRatios.length === 0) return 0;
            const avg = allRatios.reduce((a, b) => a + b, 0) / allRatios.length;
            return avg;
        });

        // Sort for median
        const sorted = studentAverages.sort((a, b) => a - b);
        const mid = Math.floor(sorted.length / 2);

        const median =
            sorted.length % 2 === 0
            ? (sorted[mid - 1] + sorted[mid]) / 2
            : sorted[mid];

        // Express as percentage, rounded to 2 digits
        return +median.toFixed(2);
        }
        

        function medianStudentConsistency(students) {
            // Compute average consistency for each student
            const studentConsistencies = students.map(student => {
                const c = student.stats.c || [];
                if (c.length === 0) return 0;
                const avg = c.reduce((sum, val) => sum + val, 0) / c.length;
                return avg; // fraction 0-1
            });

            // Sort to calculate median
            const sorted = studentConsistencies.sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);

            const median =
                sorted.length % 2 === 0
                ? (sorted[mid - 1] + sorted[mid]) / 2
                : sorted[mid];

            // Express as percentage, rounded to 2 decimals
            return +(median * 100).toFixed(2);
        }


        
    function renderDataForTeachers(filteredList = studentList) {
        studentListDiv.innerHTML = '';

        // Sort students alphabetically by nickname
        const sortedStudents = [...filteredList].sort((a, b) => a.nickname.localeCompare(b.nickname));

        classScoreMedian = medianStudentScore(sortedStudents);

        classConsistencyMedian = medianStudentConsistency(sortedStudents);

        const listContainer = document.createElement('ul');

        sortedStudents.forEach((student, studentIndex) => {
        const studentElement = document.createElement('li');
        studentElement.classList.add('student-li-item');

        // Student checkbox
        const studentCheckbox = document.createElement('input');
        studentCheckbox.type = 'checkbox';
        studentCheckbox.id = `student-${student.id}`;
        studentCheckbox.value = student.id;
        studentCheckbox.classList.add('student-checkbox');
        studentCheckbox.style.visibility = 'hidden';

        // Student label with numbering
        const studentName = document.createElement('div');
        studentName.classList.add('student-name');
        studentName.classList.add('selection-option');
        studentName.style.cursor = 'pointer';
        studentName.dataset.studentId = student.id;
        studentName.innerHTML = `${studentIndex + 1}. ${student.nickname} (ID: ${student.id})`;

        studentName.addEventListener('click', async () => {
            if (document.querySelector(`#tasks-${student.id}`).style.display === "none") {
                if (!browsingHistory) {
                    document.querySelector(`#tasks-${student.id}`).style.display = "block";
                } else {
                    const isIstorijaTab = document.getElementById("history-tab-istorija").classList.contains("active-tab");
                    if (isIstorijaTab) {
                        currentHistoryStudentId = student.id;
                        loadTaskArchive();
                    } else if (taskHistoryCurrentTask && document.getElementById('new-search-button').disabled === false) {
                        taskHistoryState.isClassAverageView = false;
                        await retrieveTaskHistoryInformation(student.id, taskHistoryCurrentTask);
                    }
                }
            } else {
                if (!browsingHistory) {
                    if (studentName.classList.contains("selected-option"))
                        document.querySelector(`#tasks-${student.id}`).style.display = "none";
                } else {
                    const isIstorijaTab = document.getElementById("history-tab-istorija").classList.contains("active-tab");
                    if (isIstorijaTab) {
                        currentHistoryStudentId = student.id;
                        loadTaskArchive();
                    } else if (taskHistoryCurrentTask && document.getElementById('new-search-button').disabled === false) {
                        taskHistoryState.isClassAverageView = false;
                        await retrieveTaskHistoryInformation(student.id, taskHistoryCurrentTask);
                    }
                }
            }

            document.querySelectorAll('.selection-option').forEach(name => {
                name.classList.remove('selected-option');
            });

            document.querySelector(".teacher-home-button").classList.remove('selected-option');
            studentName.classList.add('selected-option');

            // Display task info
            displayStudentStatistics([student.id, student.nickname, student.knowledgeLvl, student.stats, student.username], student.tasks);

            if (currentAction !== "new-task") {
                openSidebar();
            }

            toggleMainBrowser(true);
            const sidebar = document.querySelector('.sidebar');
            sidebar.scrollTo({
            top: 0,
            behavior: 'smooth'
            });
        });

        // Student-level task status circles
        const studentCircleContainer = document.createElement('div');
        studentCircleContainer.classList.add('student-li-entry-tasks-indicatior');

        // Tasks container
        const tasksContainer = document.createElement('ul');
        tasksContainer.id = `tasks-${student.id}`;
        tasksContainer.classList.add('task-container');

        student.tasks.forEach((task, taskIndex) => {
            const taskWrapper = document.createElement('li');
            taskWrapper.classList.add('task-li-item');

            // Task checkbox
            const taskCheckbox = document.createElement('input');
            taskCheckbox.type = 'checkbox';
            taskCheckbox.id = `task-${task.assignmentId}`;
            taskCheckbox.value = task.assignmentId;
            taskCheckbox.classList.add('task-checkbox');
            taskCheckbox.style.visibility = "hidden";
            taskCheckbox.disabled = true;

            // Task label with numbering
            const taskName = document.createElement('div');
            taskName.innerHTML = `${taskIndex + 1}. ${task.group}`;
            taskName.style.cursor = 'pointer';
            taskName.classList.add('task-name');
            taskName.classList.add('selection-option');
            taskName.addEventListener('click', () => {
                // Remove 'selected-option' class from all task names
                document.querySelectorAll('.selection-option').forEach(task => {
                    task.classList.remove('selected-option');
                });

                document.querySelector(".teacher-home-button").classList.remove('selected-option');

                // Add 'selected-option' class to the clicked task
                taskName.classList.add('selected-option');

                // Display task info
                displayTaskInfo([student.id, student.nickname, student.username], task);

                if (currentAction !== "new-task") {
                    openSidebar();
                }

                toggleMainBrowser(true);
                const sidebar = document.querySelector('.sidebar');
                sidebar.scrollTo({
                top: 0,
                behavior: 'smooth'
                });
            });

            // Task status circle
            const taskCircle = document.createElement('div');
            taskCircle.classList.add('student-list-task-indicatior');
            taskCircle.style.backgroundColor = task.status ? greenCircleColorCode : redCircleColorCode;

            // Append elements to task wrapper
            taskWrapper.appendChild(taskCheckbox);
            taskName.appendChild(taskCircle);
            taskWrapper.appendChild(taskName);

            // Append task to tasks container
            tasksContainer.appendChild(taskWrapper);
        });

        // Append elements to student element
        studentElement.appendChild(studentCheckbox);
        studentElement.appendChild(studentName);

        const outerStudentListItem = document.createElement('div');
        outerStudentListItem.classList.add('outer-student-list-entry-item');
        outerStudentListItem.appendChild(studentElement);
        outerStudentListItem.appendChild(tasksContainer);

        // Append student element to main list
        listContainer.appendChild(outerStudentListItem);
    });

    studentListDiv.appendChild(listContainer);

    if (deletingTask) {  
        document.querySelectorAll('.task-checkbox').forEach(checkbox => {
        checkbox.style.visibility = "visible";
        checkbox.disabled = false;
        });
    }

    if (deletingStudent || addingNewTask) {
        document.querySelectorAll('.student-checkbox').forEach(checkbox => {
            checkbox.style.visibility = "visible";
            checkbox.disabled = false;
        });
    }

    displayTeacherHome();
}

        document.getElementById('expand-student-info-button').addEventListener('click', () => {
            if (browsingHistory) return;
            toggleTaskVisibility();
        });


        function toggleTaskVisibility() {
            taskContainerVisible = !taskContainerVisible;
            if (taskContainerVisible) {
                expandStudentInfoButton.innerHTML = '&#x2212;';
                document.querySelectorAll('.task-container').forEach(container => {
                    container.style.display = 'block';
                });
            } else {
                expandStudentInfoButton.innerHTML = '+';
                document.querySelectorAll('.task-container').forEach(container => {
                    container.style.display = 'none';
                });
            }
        }

        function renderDataForStudents() {

            tasksList.forEach((task, taskIndex) => {
                const taskWrapper = document.createElement('li');
                taskWrapper.classList.add('task-li-item');
                taskWrapper.classList.add('task-li-item-for-students');

                // Task checkbox
                const taskCheckbox = document.createElement('input');
                taskCheckbox.type = 'checkbox';
                taskCheckbox.id = `task-${task.assignmentId}`;
                taskCheckbox.value = task.assignmentId;
                taskCheckbox.classList.add('task-checkbox');
                taskCheckbox.style.visibility = "hidden";
                taskCheckbox.disabled = true;

                // Task label with numbering
                const taskName = document.createElement('div');
                taskName.innerHTML = `${taskIndex + 1}. ${task.group}`;
                taskName.style.cursor = 'pointer';
                taskName.classList.add('task-name');
                taskName.classList.add('selection-option');
                taskName.addEventListener('click', () => {
                    // Remove 'selected-option' class from all task names
                    document.querySelectorAll('.selection-option').forEach(task => {
                        task.classList.remove('selected-option');
                    });

                    // Add 'selected-option' class to the clicked task
                    taskName.classList.add('selected-option');

                    // Display task info
                    displayStudentTaskInfo(task);
                    openSidebarStudent();
                });

                // Task status circle
                const taskCircle = document.createElement('div');
                taskCircle.classList.add('student-list-task-indicatior');
                taskCircle.style.backgroundColor = task.status ? greenCircleColorCode : redCircleColorCode;

                // Append elements to task wrapper
                //taskWrapper.appendChild(taskCheckbox);
                taskName.appendChild(taskCircle);
                taskWrapper.appendChild(taskName);

                // Append task to tasks container
                studentTasksList.appendChild(taskWrapper);
            });

            const totalTasks = tasksList.length;
            const completedTasks = tasksList.filter(task => task.status === true).length;
            if (totalTasks.length === 0) {
                taskListTitleForStudents.innerHTML = "Užduotys:"
            } else {
                taskListTitleForStudents.innerHTML = `Užduotys (atlikta ${completedTasks}/${totalTasks}):`
            }
        }

        async function fetchDataForTeachers() {
            let success = false;
            let showMessageTimeout;
            let closer;

            // Schedule showing the message after 500ms
            showMessageTimeout = setTimeout(() => {
                closer = messageToTheUser("Mokinių ir užduočių informacija ieškoma duomenų bazėje. Procesas gali užtrukti kelias minutes.", false, true);
            }, 500);

            newTaskButton.disabled = true
            deleteTaskButton.disabled = true
            deleteStudentButton.disabled = true
            taskHistoryBrowserButton.disabled = true

            try {
                const response = await apiFetch(apiBase + 'students', {
                    method: 'GET'
                });

                if (!response) {
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }

                const responseData = await response.json();
                
                // Handle both old format (array) and new format (object with students + thresholds)
                if (Array.isArray(responseData)) {
                    // Old format - just students array
                    studentList = responseData;
                    globalErrorThresholds = { m: undefined, t: undefined, g: undefined };
                } else {
                    // New format - object with students and globalErrorThresholds
                    studentList = responseData.students || [];
                    globalErrorThresholds = responseData.globalErrorThresholds || { m: undefined, t: undefined, g: undefined };
                }
                
                studentList.forEach(student => {
                    // EXCLUDE CURRENT WEEK
                    if (student.stats) {
                        // Remove last entry from consistency array
                        if (student.stats.c && student.stats.c.length > 0) {
                            student.stats.c = student.stats.c.slice(0, -1);
                        }
                        // Remove last entry from math stats
                        if (student.stats.m && student.stats.m.length > 0) {
                            student.stats.m = student.stats.m.slice(0, -1);
                        }
                        // Remove last entry from text stats
                        if (student.stats.t && student.stats.t.length > 0) {
                            student.stats.t = student.stats.t.slice(0, -1);
                        }
                        // Remove last entry from grammar stats
                        if (student.stats.g && student.stats.g.length > 0) {
                            student.stats.g = student.stats.g.slice(0, -1);
                        }
                        // Adjust date to previous week (subtract 7 days)
                        if (student.stats.d) {
                            student.stats.d = student.stats.d - 7;
                        }
                    }
                });
                success = true;

                populateTaskGroupDropdown();
                renderDataForTeachers();
            } catch (error) {
                console.log('Error fetching data:', error);
                if (error.message === "Unauthorized") {
                    clearUserData();
                    window.location.href = "prisijungimas";
                } else {
                    messageToTheUser('Nepavyko pasiekti duomenų. Bandykite vėl vėliau.');
                }
            } finally {
                // Cancel showing the message if not yet displayed
                clearTimeout(showMessageTimeout);

                // Close message if it was displayed
                if (closer) {
                    setTimeout(() => closer(), 0); // close after 0.5s
                }
            }
            if (success) {
                newTaskButton.disabled = false
                deleteTaskButton.disabled = false
                deleteStudentButton.disabled = false
                taskHistoryBrowserButton.disabled = false
            }
        }

        async function fetchDataForStudents() {
            let success = false;
            let showMessageTimeout;
            let closer;

            // Schedule showing the message after 500ms
            showMessageTimeout = setTimeout(() => {
                closer = messageToTheUser( 'Užduočių informacija ieškoma duomenų bazėje. Procesas gali užtrukti kelias minutes.', false, true);
            }, 500);

            try {
                const response = await apiFetch(apiBase + 'tasks', {
                    method: 'GET'
                });

                if (!response) {
                    return;
                }

                if (!response.ok) {
                    const errorData  = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }

                tasksList = await response.json().catch(() => ({}));
                success = true;
                renderDataForStudents();

            } catch (error) {
                console.log('Error fetching data:', error);
                if (error.message === "Unauthorized") {
                    clearUserData();
                    window.location.href = "prisijungimas";
                } else {
                    messageToTheUser('Nepavyko pasiekti duomenų. Bandykite vėl vėliau.')
                }
            }
            if (success) {
                 // Cancel showing the message if not yet displayed
                clearTimeout(showMessageTimeout);

                // Close message if it was displayed
                if (closer) {
                    setTimeout(() => closer(), 0); // close after 0.5s
                }
            }
        }
    

    function toggleAddNewTask() {
        addingNewTask = !addingNewTask
        toggleStudentListLabel();
        const dropdown = document.getElementById("task-group-sorting");
        const menu = document.getElementById("task-group-menu");
        
        if (addingNewTask) {
            // First: select all groups and trigger filtering
            restoreAllIfNoneSelected(true);
            menu.dispatchEvent(new Event("change"));
            
            // Then: disable dropdown and show UI
            setTimeout(() => {
                dropdown.disabled = true;
                taskContainerVisible = true;
                toggleTaskVisibility();
                studentTaskInfoContainer.style.display = 'none';
                
                document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                    checkbox.style.visibility = 'visible';
                });

                const modeChoice15Element = document.getElementById('mode_choice_15');

                if (modeChoice15Element && modeChoice15Element.options.length < 2) {
                    modeChoice15Element.innerHTML = '';
                    modeChoice15Element.innerHTML += '<option value="C82">ATSITIKTINIAI TEKSTAI</option>'
                    modeChoice15Element.innerHTML += '<option value="C84">PARINKTI TEKSTUS</option>'
                }

                let changeEvent = new Event('change');
                modeChoice15Element.value = 'C82';
                modeChoice15Element.dispatchEvent(changeEvent);

                const modeChoice15Selection = modeChoice15Element.value;

                if (modeChoice15Selection === "C82") {
                    isSelectionModeEnabled = false;
                    enforceTaskTypeFilter(); // Restore normal checkboxes
                } else if (modeChoice15Selection === "C84") {
                    isSelectionModeEnabled = true;
                    enforceTaskTypeFilter(); // Enforce task type filter
                }

                refilterTexts();

                openSidebar();

                toggleMainBrowser(true);
                const sidebar = document.querySelector('.sidebar');
                sidebar.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                
                newTaskOptions.style.display = 'flex';
                document.querySelector("#group_name").style.display = "block";
                document.querySelector("#mode_choice_4").style.display = "block";
                document.querySelector(".timer-question-number-div").style.display = "block";
            }, 100);

        } else {
            taskContainerVisible = false;
            toggleTaskVisibility();
            studentTaskInfoContainer.style.display = 'flex'; 
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                checkbox.style.visibility = 'hidden';
                checkbox.checked = false;
            });
            newTaskOptions.style.display = 'none';
            dropdown.disabled = false;
            toggleMainBrowser(closeMainBrowser=true);
            isSelectionModeEnabled = false;
            enforceTaskTypeFilter(); // ADD THIS LINE - restores normal behavior
            refilterTexts();
        }
    }

    function toggleBrowseHistory() {
        browsingHistory = !browsingHistory
        updateModeChoice7();
        updateModeChoice13();
        updateModeChoice12();
        toggleStudentListLabel();
        const dropdown = document.getElementById("task-group-sorting");
        if (browsingHistory) {

            dropdown.disabled = true;
            
            taskContainerVisible = true;
            toggleTaskVisibility();

            document.querySelector(".txt-browser-wrapper").style.display = 'none'; 
            studentTaskInfoContainer.style.display = 'none'; 
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
            checkbox.style.visibility = 'hidden';

            const modeChoice15Element = document.getElementById('mode_choice_15');

            if (modeChoice15Element && modeChoice15Element.options.length > 1) {
                modeChoice15Element.innerHTML = '';
                modeChoice15Element.innerHTML += '<option value="C82">ATSITIKTINIAI TEKSTAI</option>'
            }

            let changeEvent = new Event('change');
            modeChoice15Element.value = 'C82';
            modeChoice15Element.dispatchEvent(changeEvent);

            openSidebar();

            toggleMainBrowser(true);
            const sidebar = document.querySelector('.sidebar');
            sidebar.scrollTo({
            top: 0,
            behavior: 'smooth'
            });
        });

            document.querySelector("#mode_choice_15").classList.add("item-display-none-lock");
            document.querySelector("#mode_choice_4").classList.add("item-display-none-lock");
            document.querySelector(".timer-question-number-div").classList.add("item-display-none-lock");

            // Show tabs immediately, default to Istorija
            document.getElementById("history-view-tabs").style.display = "flex";
            document.getElementById("history-tab-istorija").classList.add("active-tab");
            document.getElementById("history-tab-progresas").classList.remove("active-tab");
            document.getElementById("confirm-button").style.display = "none";
            newTaskOptions.style.display = 'none';
            document.querySelector("#student-task-history-container").style.display = "none";
            document.getElementById("task-archive-view").style.display = "flex";

            // Set default date range (today back 2 weeks) - handled by flatpickr defaultDate

            document.getElementById("new-search-button").disabled = true;
            taskHistoryState.isClassAverageView = false;
        } else {
            taskHistoryCurrentTask = null;
            retrievedDataInstance = null;
            document.querySelector(".txt-browser-wrapper").style.display = 'block'; 
            studentTaskInfoContainer.style.display = 'flex'; 
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                checkbox.style.visibility = 'hidden';
                checkbox.checked = false;
            });
            newTaskOptions.style.display = 'none';
            document.querySelector("#student-task-history-container").style.display = "none";
            document.getElementById("history-view-tabs").style.display = "none";
            document.getElementById("task-archive-view").style.display = "none";
            document.getElementById("history-tab-progresas").classList.remove("active-tab");
            document.getElementById("history-tab-istorija").classList.remove("active-tab");
            document.getElementById("confirm-button").style.display = "";
            currentHistoryStudentId = null;
            dropdown.disabled = false;
            toggleMainBrowser(closeMainBrowser=true);
            isSelectionModeEnabled = false;
            refilterTexts();

            document.querySelector("#mode_choice_15").classList.remove("item-display-none-lock");
            document.querySelector("#mode_choice_4").classList.remove("item-display-none-lock");
            document.querySelector(".timer-question-number-div").classList.remove("item-display-none-lock");

            document.querySelector(".teacher-home-button").style.opacity = "";
            document.querySelector(".teacher-home-button").style.pointerEvents = "";
        }
    }

    document.getElementById("new-search-button").addEventListener("click", () => {
        startNewTaskHistorySearch();
        openSidebar();
    });

    function startNewTaskHistorySearch () {
        enableConfirmationButtons();
        enableTeacherControlPannel();
        enableNewTaskContainer();

        document.getElementById('confirm-button').disabled = false;
        document.getElementById("new-search-button").disabled = true;
        // Switch to Progresas tab, show task selector
        document.getElementById("history-tab-progresas").classList.add("active-tab");
        document.getElementById("history-tab-istorija").classList.remove("active-tab");
        document.querySelector("#student-task-history-container").style.display = "none";
        document.getElementById("task-archive-view").style.display = "none";
        newTaskOptions.style.display = 'flex';
        document.querySelector("#group_name").style.display = "none";
    }

    function toggleDeleteTask() {
        deletingTask = !deletingTask
        toggleStudentListLabel();
        
        if (deletingTask) {
            setTimeout(() => {
                taskContainerVisible = false;
                toggleTaskVisibility();
                document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.style.visibility = "visible";
                    checkbox.disabled = false;
                });
            }, 100);
        } else {
            taskContainerVisible = false;
            toggleTaskVisibility();
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.style.visibility = "hidden";
                checkbox.checked = false;
                checkbox.disabled = true;
            });
        }
    }

    function deleteSelectedTasks() {
        let tasksToRemove = [];
        document.querySelectorAll('.task-checkbox').forEach(checkbox => {
            if (checkbox.checked) {
                tasksToRemove.push(parseInt(checkbox.value));
            }
        });

        if (tasksToRemove.length === 0) {
            messageToTheUser( "Pasirinkite bent vieną užduotį ištrynimui!")
            return
        }

        deleteTasks(tasksToRemove)
    }

    async function deleteAllTasks() {
        try {
                const response = await apiFetch(apiBase + 'tasks', {
                    method: 'GET'
                });

                if (!response) {
                    return;
                }

                if (!response.ok) {
                    const errorData  = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }

                const allStudentsTasks = await response.json().catch(() => ({}));
                const assignmentIds = allStudentsTasks.map(task => task.assignmentId);
                deleteTasks(assignmentIds)
                
            } catch (error) {
                console.log('Error fetching tasks:', error);
                if (error.message === "Unauthorized") {
                    clearUserData();
                    window.location.href = "prisijungimas";
                } else {
                    teacherMessageLine.innerHTML = 'Nepavyko pasiekti duomenų. Bandykite vėl vėliau.'
                }
            }
    }


    async function deleteTasks(tasksToRemove) {
        disableConfirmationButtons();
        try {
            // Prepare the list of tasks to delete (assuming tasksToTemove is already populated)
            const tasksToDelete = tasksToRemove;  // Ensure this array holds task IDs to be deleted

            disableTeacherControlPannel()
            const response = await apiFetch(apiBase + 'tasks', {
                method: 'DELETE',  // Change to DELETE method
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ tasks: tasksToDelete })  // Send the list as JSON in the body
            });

            if (!response) {
                return;
            }

            if (!response.ok) {
                const errorData  = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
            }

            // Optionally, handle the response if needed (e.g., confirm deletion or update the UI)
            const result = await response.json().catch(() => ({}));
            if (result.message === "Tasks and their associated assignments deleted successfully.") {
                messageToTheUser("Užduotys pašalintos sėkmingai!", false)
                fetchDataForTeachers()
            }

        } catch (error) {
            console.log('Error fetching tasks:', error);
            if (error.message === "Unauthorized") {
                clearUserData();
                window.location.href = "prisijungimas";
            } else {
                messageToTheUser("Nepavyko pašalinti užduočių. Bandykite vėl vėliau.")
            }
        } finally {
            enableTeacherControlPannel();
            clearTaskInfoContainer();
            hideConfirmationButtons();
            toggleDeleteTask()
        }
    }
    
    async function setTask() {
        function removeError(element) { 
            element.classList.remove('invalid-submition'); 
        };

        const selectedStudents = Array.from(document.querySelectorAll('.student-checkbox'))
            .filter(checkbox => checkbox.checked)
            .map(checkbox => parseInt(checkbox.value))

        if (selectedStudents.length === 0) {
            messageToTheUser("Pasirinkite bent vieną mokinį!");
            return
        }

        const groupName = document.getElementById('group_name').value.trim();
        let modeChoice1 = document.getElementById('mode_choice_1').value
        let modeChoice2 = document.getElementById('mode_choice_2').value
        let modeChoice3 = document.getElementById('mode_choice_3').value
        const modeChoice4 = document.getElementById('mode_choice_4').value
        let modeChoice5 = document.getElementById('mode_choice_5').value
        const modeChoice6 = document.getElementById('mode_choice_6').value
        const modeChoice7 = document.getElementById('mode_choice_7').value
        const classChoiceSelection = document.querySelector('#class_choice').value;
        const timerInput = document.getElementById('timer-input').value
        const questionNumberInput = document.getElementById('question-number-input').value
        const remainderInput = document.getElementById('remainder-input').checked

        const selectedNumberElement = document.querySelector('#selected_number');
        const selectedNumber2Element = document.querySelector('#selected_number_2');
        let selectedNumbers = [
                    Number(selectedNumberElement.value),
                    Number(selectedNumber2Element.value)
                ].sort((a, b) => a - b);

        let modeChoiceSelection = document.querySelector('#mode_choice').value;
        let mode = modeChoiceSelection;

        if (groupName.length === 0) {
            messageToTheUser("Įveskite grupės pavadinimą!")
            return
        } else if (groupName.length >= 60) {
            messageToTheUser("Maksimalus grupės pavadinimo ilgis yra 60 simbolių.")
            return
        }

        let durationType;
        if (modeChoice4 === "C39") {
            durationType = timerInput;
        } else if (modeChoice4 === "C40") {
            durationType = questionNumberInput;
        }

        if (modeChoice3 === "") modeChoice3 = "C37"

        const modeChoiceElementSelection = document.querySelector('#mode_choice').value;
        let task = [];
        let taskDuration = [];

        if (mode === "math") {
            const modeChoice8Selection = document.querySelector('#mode_choice_8')?.value || "C79";
            task = [
                mode, modeChoice1, modeChoice2, modeChoice3, 
                modeChoice5, modeChoice6, modeChoice7, selectedNumbers, 
                remainderInput, modeChoice8Selection
            ];
            taskDuration = [
                modeChoice4, durationType
            ]
        } else if (mode === "lang") {
            const classChoiceSelection = document.querySelector('#class_choice').value;
            classChoice = classChoiceSelection;

            let modeChoice8Selection = document.querySelector('#mode_choice_8').value;
            modeChoice1 = modeChoice8Selection;

            const modeChoice9Selection = document.querySelector('#mode_choice_9').value;

            modeChoice2 = modeChoice9Selection;

            const selectedOptions = getSelectedRasybaConditions();

            const sortedModeChoice3 = Object.fromEntries(
            Object.entries(selectedOptions).sort(([a], [b]) => {
                const numA = parseInt(a.slice(1));
                const numB = parseInt(b.slice(1));
                return numA - numB;
            })
            );

            modeChoice3 = sortedModeChoice3;

            const modeChoice12Selection = document.querySelector('#mode_choice_12').value;
            modeChoice5 = modeChoice12Selection;

            const modeChoiceLtDifficulty = document.getElementById('mode_choice_10').value;

            const modeChoice14Selection = document.getElementById('mode_choice_14').value;
            const modeChoice15Selection = document.getElementById('mode_choice_15').value;

            let modeChoice13Selection = document.querySelector('#mode_choice_13').value;
            let questionFrequency = Number(modeChoice13Selection);
            
            if (modeChoice1 === "C49") {
                if (modeChoice15Selection === "C82") {
                    task = [
                        mode, modeChoice1, modeChoice2, modeChoice14Selection, modeChoice15Selection, classChoiceSelection, modeChoiceLtDifficulty
                    ];
                    taskDuration = [modeChoice4, durationType, generateSessionSeed()]
                } else if (modeChoice15Selection === "C84") {
                    task = [
                        mode, modeChoice1, modeChoice2, modeChoice14Selection, modeChoice15Selection
                    ];
                    taskDuration = ["C40", selectedIds]
                }
            } else if (modeChoice1 === "C83") {
                if (modeChoice2 === "C50") {
                    task = [
                        mode, modeChoice1, modeChoice2, classChoiceSelection, modeChoice3,
                        modeChoice5, questionFrequency
                    ];
                    taskDuration = [modeChoice4, durationType, generateSessionSeed()]
                }
            }
        }

        const normalizedTask = JSON.stringify(task);
        const normalizedDuration = JSON.stringify(taskDuration);

        const taskData = {
            students: selectedStudents,
            group_name: groupName,
            task: normalizedTask,
            taskDuration: normalizedDuration
        }

        disableNewTaskContainer();
        disableTeacherControlPannel();
        disableConfirmationButtons();
        try {
            console.log(JSON.parse(taskData.task))
        const response = await apiFetch(apiBase + 'tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(taskData)
        });

        if (!response) {
            return;
        }

        // First parse the response as JSON
        const responseData = await response.json().catch(() => ({}));
        

        if (responseData.message === 'Task set successfully') {
            messageToTheUser('Užduotis sukurta sėkmingai!', false)
            fetchDataForTeachers()
        } else if (responseData.message === 'Some students already have the maximum allowed tasks per student.') {
            messageToTheUser('Galima sukurti tik 6 užduotis per mokinį. Išstrinkite seną užduotį, kad galėtumėte sukurti naują.')
        } else {
            throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
        }
        } catch (error) {
            console.log('Error fetching tasks:', error);
            if (error.message === "Unauthorized") {
                clearUserData();
                window.location.href = "prisijungimas";
            } else {            
                messageToTheUser('Nepavyko pridėti užduoties. Bandykite vėl vėliau.');
        }
        } finally {
            toggleAddNewTask();
            enableTeacherControlPannel();
            enableNewTaskContainer();
            hideConfirmationButtons();
        }
    }

    function completeTask() {
        const parsedCurrentTaskInstructions = JSON.parse(currentTaskInstructions);

            if (localStorage.getItem('controller') !== null) {
				controller = JSON.parse(localStorage.getItem('controller'))
			}

			var checkbox = document.getElementById("remainder-input");
            controller.language = "LT";
            if (parsedCurrentTaskInstructions[0] === "math") {
                controller.mode = 'math';
                controller.modeChoice1 = parsedCurrentTaskInstructions[1];
                controller.modeChoice2 = parsedCurrentTaskInstructions[2];
                if (parsedCurrentTaskInstructions[3] === "C37") {
                    controller.modeChoice3 = true;
                } else if (parsedCurrentTaskInstructions[3] === "C38") {
                    controller.modeChoice3 = false;
                }
                controller.modeChoice5 = parsedCurrentTaskInstructions[4];
                controller.modeChoice6 = parsedCurrentTaskInstructions[5];
                controller.modeChoice7 = parsedCurrentTaskInstructions[6];
                controller.selectedNumbers = parsedCurrentTaskInstructions[7];
                controller.withRemainder = parsedCurrentTaskInstructions[8];
                controller.modeChoice8 = parsedCurrentTaskInstructions[9];
                controller.task = ["setTask", currentTaskId];
                controller.taskCompleted = false;
                controller.taskRecorded = false;

                controller.modeChoice4 = currentTaskDuration[0];
                controller.setTaskDuration = currentTaskDuration[1];
            } else if (parsedCurrentTaskInstructions[0] === "lang") {
                controller.mode = 'lang';
                if (parsedCurrentTaskInstructions[1] === "C49") {
                    controller.modeChoice1 = parsedCurrentTaskInstructions[1];
                    controller.modeChoice2 = parsedCurrentTaskInstructions[2];
                    controller.modeChoice6 = parsedCurrentTaskInstructions[3];
                    controller.modeChoice7 = parsedCurrentTaskInstructions[4];

                    if (controller.modeChoice7 === "C82") {
                        controller.classChoice = parsedCurrentTaskInstructions[5];
                        controller.modeChoiceLtDifficulty = parsedCurrentTaskInstructions[6];
                        controller.modeChoice4 = currentTaskDuration[0];
                        controller.setTaskDuration = currentTaskDuration[1];
                        if (currentTaskDuration[2]) {
                            controller.modeChoice8 = currentTaskDuration[2]
                        }
                    } else if (controller.modeChoice7 === "C84") {
                        controller.modeChoice4 = currentTaskDuration[0];
                        controller.modeChoice8 = currentTaskDuration[1];
                        controller.setTaskDuration = controller.modeChoice8.length;
                    }

                    controller.task = ["setTask", currentTaskId];
                    controller.taskCompleted = false;
                    controller.taskRecorded = false;

                } else if (parsedCurrentTaskInstructions[1] === "C83") {
                    if (parsedCurrentTaskInstructions[2] === "C50") {
                        controller.modeChoice1 = parsedCurrentTaskInstructions[1];
                        controller.modeChoice2 = parsedCurrentTaskInstructions[2];
                        controller.classChoice = parsedCurrentTaskInstructions[3];
                        controller.modeChoice3 = parsedCurrentTaskInstructions[4];
                        controller.modeChoice5 = parsedCurrentTaskInstructions[5];
                        controller.questionFrequency = parsedCurrentTaskInstructions[6];
                        
                        controller.task = ["setTask", currentTaskId];
                        controller.taskCompleted = false;
	                    controller.taskRecorded = false;

                        controller.modeChoice4 = currentTaskDuration[0];
                        controller.setTaskDuration = currentTaskDuration[1];
                        if (currentTaskDuration[2]) {
                            controller.modeChoice8 = currentTaskDuration[2]
                        }
                    }
                }
            }

			localStorage.setItem('controller', JSON.stringify(controller))

            startQuestions();
    }

    function arraysEqual(a, b) {
        if (!Array.isArray(a) || !Array.isArray(b)) return false;
        if (a.length !== b.length) return false;

        for (let i = 0; i < a.length; i++) {
            const valA = a[i];
            const valB = b[i];

            const bothArrays = Array.isArray(valA) && Array.isArray(valB);

            if (bothArrays) {
                if (!arraysEqual(valA, valB)) return false;
            } else if (valA !== valB) {
                return false;
            }
        }

        return true;
    }

function expandTaskForHistoryBrowsing(task) {
  // ---------- Hierarchical Expansion Rules ----------
  const expansionRules = {
    "C3": { "C1": {}, "C2": {} },
    "C6": { "C4": {}, "C5": {} },
    "C7": {
      "C1": {
        "C31": ["C8"],
        "C32": ["C8", "C9", "C10", "C17"],
        "C33": ["C9", "C10", "C11", "C12", "C17"],
        "C34": ["C11", "C12", "C13"],
        "C35": ["C14"],
        "C36": ["C15"],
        "C43": ["C43", "C44", "C45", "C46"],
        "C44": ["C43", "C44", "C45", "C46"],
        "C45": ["C43", "C44", "C45", "C46"],
        "C46": ["C43", "C44", "C45", "C46"]
      },
      "C2": {
        "C31": ["C8"],
        "C32": ["C8", "C9", "C10", "C17"],
        "C33": ["C9", "C10", "C11", "C12", "C17"],
        "C34": ["C11", "C12", "C13"],
        "C35": ["C14"],
        "C36": ["C15", "C16"],
        "C43": ["C43", "C44", "C45", "C46"],
        "C44": ["C43", "C44", "C45", "C46"],
        "C45": ["C43", "C44", "C45", "C46"],
        "C46": ["C43", "C44", "C45", "C46"]
      },
      "C3": {
        "C31": ["C8"],
        "C32": ["C8", "C9", "C10", "C17"],
        "C33": ["C9", "C10", "C11", "C12", "C17"],
        "C34": ["C11", "C12", "C13"],
        "C35": ["C14"],
        "C36": ["C15"],
        "C43": ["C43", "C44", "C45", "C46"],
        "C44": ["C43", "C44", "C45", "C46"],
        "C45": ["C43", "C44", "C45", "C46"],
        "C46": ["C43", "C44", "C45", "C46"]
      },
      "C4": {
        "C33": ["C18"],
        "C34": ["C19", "C20"],
        "C35": ["C20", "C21", "C28", "C29"],
        "C36": ["C21", "C22", "C23", "C24", "C25", "C26", "C29", "C30"]
      },
      "C5": {
        "C33": ["C18"],
        "C34": ["C19", "C20"],
        "C35": ["C20", "C21", "C28", "C29", "C30"],
        "C36": ["C21", "C22", "C23", "C24", "C25", "C26", "C29", "C30"]
      },
      "C6": {
        "C33": ["C18"],
        "C34": ["C19", "C20"],
        "C35": ["C20", "C21", "C28", "C29"],
        "C36": ["C21", "C22", "C23", "C24", "C25", "C26", "C29"]
      }
    }
  };

  const clone = obj => JSON.parse(JSON.stringify(obj));

  // ---------- Helper: Extract numeric suffix from Cxxx codes ----------
  const getCNum = key => {
    const m = key.match(/^C(\d+)$/);
    return m ? parseInt(m[1], 10) : Infinity;
  };

  // ---------- Helper: Generate all non-empty subsets, sorted by numeric code ----------
  function getAllSubsets(keys) {
    const sorted = [...keys].sort((a, b) => getCNum(a) - getCNum(b));
    const subsets = [];
    const total = 1 << sorted.length;
    for (let mask = 1; mask < total; mask++) {
      const subset = [];
      for (let bit = 0; bit < sorted.length; bit++) {
        if (mask & (1 << bit)) subset.push(sorted[bit]);
      }
      subsets.push(subset);
    }
    subsets.sort((a, b) => {
      if (a.length !== b.length) return a.length - b.length;
      for (let i = 0; i < a.length; i++) {
        const diff = getCNum(a[i]) - getCNum(b[i]);
        if (diff !== 0) return diff;
      }
      return 0;
    });
    return subsets;
  }

  // ---------- Helper: Generic paired-code expander ----------
  // Replaces any occurrence of `token` in a task with `codeA` (one variant)
  // and `codeB` (another variant), recursively handling multiple occurrences.
  function expandPairedCode(tasks, token, codeA, codeB) {
    const expanded = [];
    for (const t of tasks) {
      let found = false;
      for (let i = 0; i < t.length; i++) {
        if (t[i] === token) {
          found = true;
          const tA = clone(t);
          tA[i] = codeA;
          const tB = clone(t);
          tB[i] = codeB;
          expanded.push(...expandPairedCode([tA], token, codeA, codeB));
          expanded.push(...expandPairedCode([tB], token, codeA, codeB));
          break;
        }
      }
      if (!found) expanded.push(t);
    }
    return expanded;
  }

  // ---------- STEP 0: Split tasks where index 6 === 0 into variants with 1 and 3 ----------
  function expandZeroAtIndex6(tasks) {
    const expanded = [];
    for (const t of tasks) {
      if (t.length > 6 && typeof t[6] === "number" && t[6] === 0) {
        const t1 = clone(t);
        t1[6] = 1;
        expanded.push(t1);
        const t3 = clone(t);
        t3[6] = 3;
        expanded.push(t3);
      } else {
        expanded.push(t);
      }
    }
    return expanded;
  }

  // ---------- STEP 0b: Expand C50 using dict at position 4 ----------
  function expandC50(tasks) {
    const expanded = [];
    for (const t of tasks) {
      if (!t.includes("C50")) {
        expanded.push(t);
        continue;
      }
      const dict = t[4];
      if (!dict || typeof dict !== "object" || Array.isArray(dict)) {
        expanded.push(t);
        continue;
      }
      const keys = Object.keys(dict);
      if (keys.length === 0) {
        expanded.push(t);
        continue;
      }
      const subsets = getAllSubsets(keys);
      for (const subset of subsets) {
        const tVariant = clone(t);
        const newDict = {};
        for (const key of subset) {
          newDict[key] = dict[key];
        }
        tVariant[4] = newDict;
        expanded.push(tVariant);
      }
    }
    return expanded;
  }

  // ---------- Apply all pre-expansions in order ----------
  let initialTasks = expandZeroAtIndex6([clone(task)]);                          // 1. 0 → 1 and 3
  initialTasks = expandPairedCode(initialTasks, "C47-C48", "C47", "C48");        // 2. C47-C48 split
  initialTasks = expandPairedCode(initialTasks, "C73-C74", "C73", "C74");        // 3. C73-C74 split
  initialTasks = expandC50(initialTasks);                                         // 4. C50 dict subsets

  const results = [...initialTasks];
  let primaryVariants = [];

  // ---------- STEP 1: Primary → Secondary ----------
  for (const baseTask of initialTasks) {
    for (let i = 0; i < baseTask.length; i++) {
      const value = baseTask[i];
      if (!expansionRules[value]) continue;

      for (const [primaryReplacement, secondaryRules] of Object.entries(expansionRules[value])) {
        const tPrimary = clone(baseTask);
        tPrimary[i] = primaryReplacement;

        // Boolean fix for C4
        if (primaryReplacement === "C4") {
          const boolIndex = tPrimary.length - 2;
          if (typeof tPrimary[boolIndex] === "boolean") tPrimary[boolIndex] = false;
        }

        // ---------- Collect all positions to replace ----------
        const positions = [];
        for (let j = 0; j < tPrimary.length; j++) {
          const secValue = tPrimary[j];
          if (secondaryRules[secValue]) {
            positions.push({ index: j, replacements: secondaryRules[secValue] });
          }
        }

        // ---------- Generate all combinations of secondary replacements ----------
        const combine = (posIndex = 0, current = clone(tPrimary)) => {
          if (posIndex >= positions.length) {
            // Also expand any paired codes that may have survived into secondary expansion
            let expanded = expandPairedCode([current], "C47-C48", "C47", "C48");
            expanded = expandPairedCode(expanded, "C73-C74", "C73", "C74");
            primaryVariants.push(...expanded);
            return;
          }
          const { index, replacements } = positions[posIndex];
          for (const r of replacements) {
            const next = clone(current);
            next[index] = r;
            if (r === "C18") next[7] = [1, 10];
            combine(posIndex + 1, next);
          }
        };

        if (positions.length > 0) {
          combine();
        } else {
          let expanded = expandPairedCode([tPrimary], "C47-C48", "C47", "C48");
          expanded = expandPairedCode(expanded, "C73-C74", "C73", "C74");
          primaryVariants.push(...expanded);
        }
      }
    }
  }

  results.push(...primaryVariants);

  // ---------- STEP 2: Swap C37 <-> C38 for primary C1/C2/C3 ----------
  const swapVariants = [];
  for (const t of results) {
    const primaryCode = t[1];
    if (["C1", "C2", "C3"].includes(primaryCode)) {
      for (let i = 0; i < t.length; i++) {
        if (t[i] === "C37") {
          const swapped = clone(t);
          swapped[i] = "C38";
          swapVariants.push(swapped);
        } else if (t[i] === "C38") {
          const swapped = clone(t);
          swapped[i] = "C37";
          swapVariants.push(swapped);
        }
      }
    }
  }
  results.push(...swapVariants);

  // ---------- STEP 3: Expand C18 ranges ----------
  const finalTasks = [];
  for (const t of results) {
    if (t.includes("C18")) {
      const range = t[7];
      if (!Array.isArray(range) || range.length < 2) {
        finalTasks.push(t);
        continue;
      }
      const start = parseInt(range[0], 10);
      const end = parseInt(range[1], 10);
      for (let first = start; first <= end; first++) {
        for (let second = first; second <= end; second++) {
          const tRange = clone(t);
          tRange[7][0] = first;
          tRange[7][1] = second;
          finalTasks.push(tRange);
        }
      }
    } else {
      finalTasks.push(t);
    }
  }

  return [clone(task), ...finalTasks.filter(t => t !== task)];
}

let taskHistoryCurrentTask = null;
    
 async function setTaskHistoryQuery() {
    let modeChoice1 = document.getElementById('mode_choice_1').value
    let modeChoice2 = document.getElementById('mode_choice_2').value
    let modeChoice3 = document.getElementById('mode_choice_3').value
    const modeChoice4 = document.getElementById('mode_choice_4').value
    let modeChoice5 = document.getElementById('mode_choice_5').value
    const modeChoice6 = document.getElementById('mode_choice_6').value
    const modeChoice7 = document.getElementById('mode_choice_7').value
    const classChoiceSelection = document.querySelector('#class_choice').value;
    const timerInput = document.getElementById('timer-input').value
    const questionNumberInput = document.getElementById('question-number-input').value
    const remainderInput = document.getElementById('remainder-input').checked

    const selectedNumberElement = document.querySelector('#selected_number');
    const selectedNumber2Element = document.querySelector('#selected_number_2');
    let selectedNumbers = [
                    Number(selectedNumberElement.value),
                    Number(selectedNumber2Element.value)
                ].sort((a, b) => a - b);

    let modeChoiceSelection = document.querySelector('#mode_choice').value;
    let mode = modeChoiceSelection;

    if (modeChoice3 === "") modeChoice3 = "C37"

    const modeChoiceElementSelection = document.querySelector('#mode_choice').value;
    
    let task = [];

    if (mode === "math") {
        task = [
            mode, modeChoice1, modeChoice2, modeChoice3, 
            modeChoice5, modeChoice6, modeChoice7, selectedNumbers, 
            remainderInput, "C79"
        ];
    } else if (mode === "lang") {
        const classChoiceSelection = document.querySelector('#class_choice').value;
        classChoice = classChoiceSelection;

        let modeChoice8Selection = document.querySelector('#mode_choice_8').value;
        modeChoice1 = modeChoice8Selection;

        const modeChoice9Selection = document.querySelector('#mode_choice_9').value;

        modeChoice2 = modeChoice9Selection;

        const selectedOptions = getSelectedRasybaConditions();

        const sortedModeChoice3 = Object.fromEntries(
        Object.entries(selectedOptions).sort(([a], [b]) => {
            const numA = parseInt(a.slice(1));
            const numB = parseInt(b.slice(1));
            return numA - numB;
        })
        );

        modeChoice3 = sortedModeChoice3;

        const modeChoice12Selection = document.querySelector('#mode_choice_12').value;
        modeChoice5 = modeChoice12Selection;

        const modeChoiceLtDifficulty = document.getElementById('mode_choice_10').value;

        const modeChoice14Selection = document.getElementById('mode_choice_14').value;
        const modeChoice15Selection = document.getElementById('mode_choice_15').value;

        let questionFrequency;

        let modeChoice13Selection = document.querySelector('#mode_choice_13').value;
        questionFrequency = Number(modeChoice13Selection);
        
        if (modeChoice1 === "C49") {
            task = [
                mode, modeChoice1, modeChoice2, modeChoice14Selection, modeChoice15Selection, classChoiceSelection, modeChoiceLtDifficulty
            ];
        } else if (modeChoice1 === "C83") {
            if (modeChoice2 === "C50") {
                task = [
                    mode, modeChoice1, modeChoice2, classChoiceSelection, modeChoice3,
                    modeChoice5, questionFrequency
                ];
            }
        }
    }

    const expandedTasks = expandTaskForHistoryBrowsing(task);

    taskHistoryCurrentTask = JSON.parse(JSON.stringify(expandedTasks));

    // Check if a student is selected, if not select the first one
    let selectedStudent = document.querySelector(".outer-student-list-entry-item .student-name.selected-option");
    if (!selectedStudent) {
        // Select first student
        selectedStudent = document.querySelector(".outer-student-list-entry-item .student-name");
        if (selectedStudent) {
            // Remove selected class from home button
            document.querySelector(".teacher-home-button").classList.remove('selected-option');
            // Add selected class to first student
            selectedStudent.classList.add('selected-option');
        }
    }

    if (!selectedStudent) {
        messageToTheUser("Nepavyko rasti mokinių. Bandykite vėl vėliau.");
        return;
    }

    const selectedStudentId = Number(selectedStudent.dataset.studentId);

    retrieveTaskHistoryInformation(selectedStudentId, expandedTasks);
}

    async function retrieveTaskHistoryInformation (studentId, tasks) {
        disableNewTaskContainer();
        disableTeacherControlPannel();
        disableConfirmationButtons();
        document.querySelectorAll(".student-name").forEach(el => {
            el.style.pointerEvents = "none"; // stops clicks
            el.style.opacity = "0.7";        // visual cue
            el.style.cursor = "default";     // change cursor
        });

        let retrievedDataInstance = await fetchTaskStats(studentId, tasks);

        if (retrievedDataInstance && retrievedDataInstance.insufficient) {
            enableConfirmationButtons();
            enableTeacherControlPannel();
            document.getElementById("task-group-sorting").disabled = true;
            enableNewTaskContainer();
            document.querySelector(`.student-name[data-student-id="${studentId}"]`).classList.add("selected-option");
            document.querySelectorAll(".student-name").forEach(el => {
                el.style.pointerEvents = "auto";
                el.style.opacity = "1";
                el.style.cursor = "pointer";
            });
            currentHistoryStudentId = studentId;
            document.getElementById('confirm-button').disabled = true;
            newTaskOptions.style.display = 'none';
            document.getElementById("task-archive-view").style.display = "none";
            document.getElementById("history-tab-progresas").classList.add("active-tab");
            document.getElementById("history-tab-istorija").classList.remove("active-tab");
            document.querySelector("#student-task-history-container").style.display = "flex";
            document.getElementById("new-search-button").disabled = false;
            document.querySelector('.sidebar').scrollTo({ top: 0, behavior: 'smooth' });
            // Show message in chart area
            document.querySelector('.task-history-chart-wrapper').innerHTML =
                '<div class="task-history-empty">Nepakanka duomenų šiai užduočiai (reikia bent 5 įrašų).</div>';
            renderTaskHistoryDescription();
        } else if (retrievedDataInstance) {
            enableConfirmationButtons();
            enableTeacherControlPannel();
            document.getElementById("task-group-sorting").disabled = true;
            enableNewTaskContainer();
            document.querySelector(`.student-name[data-student-id="${studentId}"]`).classList.add("selected-option");
            document.querySelectorAll(".student-name").forEach(el => {
                el.style.pointerEvents = "auto";
                el.style.opacity = "1";
                el.style.cursor = "pointer";
            });
            currentHistoryStudentId = studentId;
            initTaskHistoryGraph(retrievedDataInstance);
            document.getElementById('confirm-button').disabled = true;
            newTaskOptions.style.display = 'none';
            document.getElementById("task-archive-view").style.display = "none";
            document.getElementById("history-tab-progresas").classList.add("active-tab");
            document.getElementById("history-tab-istorija").classList.remove("active-tab");
            document.querySelector("#student-task-history-container").style.display = "flex";
            document.getElementById("new-search-button").disabled = false;
            document.querySelector('.sidebar').scrollTo({ top: 0, behavior: 'smooth' });
            renderTaskHistoryDescription();
        } else {
            toggleBrowseHistory();
            taskContainerVisible = true;
            toggleTaskVisibility();
            hideConfirmationButtons();
            document.getElementById("task-group-sorting").disabled = true;
            fetchDataForTeachers();
        }
    }

    document.querySelector(".teacher-home-button").addEventListener('click', () => {
        if (browsingHistory) {
            const isIstorija = document.getElementById("history-tab-istorija").classList.contains("active-tab");
            if (isIstorija) return;

            // Only act if a graph has actually been loaded
            const graphLoaded = document.getElementById('new-search-button').disabled === false;
            if (!graphLoaded) return;

            const isShowingClassAvg = document.querySelector(".teacher-home-button").classList.contains("selected-option");
            if (isShowingClassAvg) {
                document.querySelector(".teacher-home-button").classList.remove('selected-option');
                if (currentHistoryStudentId) {
                    const selectedStudent = document.querySelector(`.student-name[data-student-id="${currentHistoryStudentId}"]`);
                    if (selectedStudent) selectedStudent.classList.add('selected-option');
                }
                taskHistoryState.isClassAverageView = false;
                initTaskHistoryGraph(taskHistoryState.rawData);
            } else {
                document.querySelectorAll('.selection-option').forEach(el => el.classList.remove('selected-option'));
                document.querySelector(".teacher-home-button").classList.add('selected-option');
                renderClassAverageOnly();
            }
            openSidebar();
            return;
        }

        document.querySelectorAll('.selection-option').forEach(task => task.classList.remove('selected-option'));
        document.querySelector(".teacher-home-button").classList.add('selected-option');
        displayTeacherHome();
        if (currentAction !== "new-task") openSidebar();
        toggleMainBrowser(true);
        document.querySelector('.sidebar').scrollTo({ top: 0, behavior: 'smooth' });
    });
    
    // HISTORY VIEW TABS

let currentHistoryStudentId = null;
const taskArchiveCache = {};
const TASK_ARCHIVE_CACHE_TTL = 30 * 60 * 1000;

function switchHistoryTab(tab) {
    document.getElementById("history-tab-progresas").classList.toggle("active-tab", tab === 'progresas');
    document.getElementById("history-tab-istorija").classList.toggle("active-tab", tab === 'istorija');

    if (tab === 'progresas') {
        document.getElementById("task-archive-view").style.display = "none";
        document.getElementById("confirm-button").style.display = "";
        document.getElementById('new-search-button').style.display = 'flex';
        document.querySelector(".teacher-home-button").style.opacity = "";
        document.querySelector(".teacher-home-button").style.pointerEvents = "";
        const graphLoaded = document.getElementById('new-search-button').disabled === false;
        if (graphLoaded) {
            document.querySelector("#student-task-history-container").style.display = "flex";
            newTaskOptions.style.display = 'none';
        } else {
            document.querySelector("#student-task-history-container").style.display = "none";
            newTaskOptions.style.display = 'flex';
            document.querySelector("#group_name").style.display = "none";
            enableNewTaskContainer();
        }
    } else {
        document.querySelector("#student-task-history-container").style.display = "none";
        newTaskOptions.style.display = 'none';
        document.getElementById("confirm-button").style.display = "none";
        document.getElementById("task-archive-view").style.display = "flex";
        document.getElementById('new-search-button').style.display = 'none';
        document.querySelector(".teacher-home-button").style.opacity = "0.35";
        document.querySelector(".teacher-home-button").style.pointerEvents = "none";
        if (currentHistoryStudentId) loadTaskArchive();
    }
}

function renderClassAverageOnly() {
    if (!taskHistoryState.rawData || !taskHistoryState.rawData.averageDates || taskHistoryState.rawData.averageDates.length === 0) {
        document.querySelector('.task-history-chart-wrapper').innerHTML =
            '<div class="task-history-empty">Nepakanka klasės duomenų.</div>';
        document.querySelector("#student-task-history-container").style.display = "flex";
        return;
    }

    const data = taskHistoryState.rawData;
    const classOnlyData = {
        studentDates: data.averageDates,
        mistakeFrequency: data.averageMistakeFrequency,
        answerRate: data.averageAnswerRate,
        averageDates: [],
        averageMistakeFrequency: [],
        averageAnswerRate: [],
        isClassAverageView: true
    };

    taskHistoryState.isClassAverageView = true;

    const savedRaw = taskHistoryState.rawData;
    const savedStart = taskHistoryState.startDate;
    const savedEnd = taskHistoryState.endDate;

    taskHistoryState.startDate = data.averageDates[0];
    taskHistoryState.endDate = data.averageDates[data.averageDates.length - 1];
    taskHistoryState.rawData = classOnlyData;

    document.querySelector("#student-task-history-container").style.display = "flex";
    initTaskHistoryGraph(classOnlyData);

    taskHistoryState.rawData = savedRaw;
    taskHistoryState.startDate = savedStart;
    taskHistoryState.endDate = savedEnd;
}

async function loadTaskArchive() {
    await new Promise(resolve => requestAnimationFrame(resolve));
    // Check if a student is selected, if not select the first one
    let selectedStudent = document.querySelector(".outer-student-list-entry-item .student-name.selected-option");
    if (!selectedStudent) {
        selectedStudent = document.querySelector(".outer-student-list-entry-item .student-name");
        if (selectedStudent) {
            document.querySelector(".teacher-home-button").classList.remove('selected-option');
            selectedStudent.classList.add('selected-option');
        }
    }

    if (!selectedStudent) {
        document.getElementById("task-archive-table-container").innerHTML = '<div class="task-archive-empty">Nėra mokinių.</div>';
        return;
    }

    currentHistoryStudentId = Number(selectedStudent.dataset.studentId);

    const startDate = document.getElementById("archiveStartDate").value;
    const endDate = document.getElementById("archiveEndDate").value;
    const container = document.getElementById("task-archive-table-container");

    try {
        let allRows;
        const cached = taskArchiveCache[currentHistoryStudentId];
        const now = Date.now();

        if (cached && (now - cached.cachedAt) < TASK_ARCHIVE_CACHE_TTL) {
            allRows = cached.rows;
        } else {
            container.innerHTML = '<div class="task-archive-empty">Kraunama...</div>';
            const url = `${apiBase}students/task-history/${currentHistoryStudentId}`;
            const response = await apiFetch(url, { method: 'GET', headers: { 'Content-Type': 'application/json' } });

            if (!response || !response.ok) {
                container.innerHTML = '<div class="task-archive-empty">Klaida gaunant duomenis.</div>';
                return;
            }

            allRows = await response.json();
            taskArchiveCache[currentHistoryStudentId] = { rows: allRows, cachedAt: now };
        }

        // Filter by date range client-side
        let rows = allRows.filter(row => {
            if (startDate && row.date < startDate) return false;
            if (endDate && row.date > endDate) return false;
            return true;
        });

        rows = filterOutlierRows(rows);

        if (!rows.length) {
            container.innerHTML = '<div class="task-archive-empty">Nėra duomenų šiam laikotarpiui.</div>';
            return;
        }

        let tableHtml = `<table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Užduotis</th>
                    <th>Atsakyta<br>iš viso</th>
                    <th>Teisingai iš<br>pirmo karto</th>
                    <th>Klaidos</th>
                    <th>Greitis<br>(ats./min.)</th>
                </tr>
            </thead>
            <tbody>`;

        const subjectColors = {
            'TURINIO KOMPONAVIMAS': '#32ac93',
            'STRUKTŪROS IŠDĖSTYMAS': '#32ac93',
            'RAŠYBA': '#F28C28',
            'default': '#286D8A', // ALL MATH TASKS
        };

        rows.forEach(row => {
            const parsedTaskDesc = JSON.parse(row.taskInfo);
            const formattedTaskDesc = getOptionTextFromValues(parsedTaskDesc, null, forTeacher=true, compact=true);

            const primary = formattedTaskDesc.filter(([_, t]) => t === 'primary').map(([v]) => v);
            const secondary = formattedTaskDesc.filter(([_, t]) => t === 'secondary').map(([v]) => v);
            const grammarParams = formattedTaskDesc.filter(([_, t]) => t === 'grammar-params').map(([v]) => Array.isArray(v) ? v.join(' | ') : v);

            const firstColor = subjectColors[primary[0]] || subjectColors['default'];
            const firstItem = primary[0] ? `<span style="color:${firstColor || 'inherit'}; font-weight:600;">${primary[0]}</span>` : '';
            const restItems = primary.slice(1).join(' • ');
            const primaryStr = firstItem + (restItems ? ` • ${restItems}` : '');

            const hasSecondary = secondary.length > 0 || grammarParams.length > 0;
            const secondaryContent = [
                ...secondary,
                ...(grammarParams.length ? [`[${grammarParams.join(' | ')}]`] : [])
            ].join(' • ');
            const secondaryStr = hasSecondary ? `<span class="task-label-secondary" style="display:none;"> • ${secondaryContent}</span>` : '';
            const expandIcon = hasSecondary ? ` <span class="task-label-expand-icon">›</span>` : '';

            const taskLabel = `<span class="task-label-wrapper${hasSecondary ? ' task-label-expandable' : ''}" ${hasSecondary ? `onclick="
                const sec = this.querySelector('.task-label-secondary');
                const icon = this.querySelector('.task-label-expand-icon');
                const expanded = sec.style.display !== 'none';
                sec.style.display = expanded ? 'none' : 'inline';
                icon.style.display = expanded ? 'inline' : 'none';
            "` : ''}>${primaryStr}${expandIcon}${secondaryStr}</span>`;

            const mistakePct = row.totalAnswers > 0
                ? Math.round((row.mistakes / row.totalAnswers) * 100)
                : 0;

            const correctPct = row.totalAnswers > 0
                ? Math.round((row.correct / row.totalAnswers) * 100)
                : 0;

            tableHtml += `<tr>
                <td>${row.date}</td>
                <td style="text-align:left;">${taskLabel}</td>
                <td>${row.totalAnswers}</td>
                <td>${row.correct} (${correctPct}%)</td>
                <td>${row.mistakes} (${mistakePct}%)</td>
                <td>${row.answerRate}</td>
            </tr>`;
        });

        tableHtml += '</tbody></table>';
        container.innerHTML = tableHtml;

    } catch (e) {
        container.innerHTML = '<div class="task-archive-empty">Klaida.</div>';
    }
}
// Graph state management
const taskHistoryState = {
    selectedMetrics: ['mistakeFrequency', 'answerRate'],
    startDate: null,
    endDate: null,
    dataMaxDate: null,
    chart: null,
    rawData: null
};

// Available metrics configuration
const taskHistoryMetrics = [
    {
        id: 'answerRate',
        label: 'sprendimų greitis',
        color: '#3b82f6',
        yAxisID: 'y-rate',
        isPercent: false
    },
    {
        id: 'mistakeFrequency',
        label: 'klaidų dažnis',
        color: '#ef4444',
        yAxisID: 'y-percent',
        isPercent: true
    }
];

// Initialize dropdown
function initTaskHistoryDropdown() {
    const btn = document.getElementById('taskHistoryMetricsBtn');
    const menu = document.getElementById('taskHistoryMetricsMenu');
    const text = document.getElementById('taskHistoryMetricsText');
    const icon = document.getElementById('taskHistoryMetricsIcon');

    // Build menu items
    menu.innerHTML = '';
    taskHistoryMetrics.forEach(metric => {
        const item = document.createElement('div');
        item.className = 'task-history-metric-item';
        item.setAttribute('data-metric-id', metric.id);

        const checkbox = document.createElement('div');
        checkbox.className = 'task-history-metric-checkbox';
        checkbox.setAttribute('data-metric-id', metric.id);
        checkbox.style.borderColor = metric.color;

        const checkmark = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        checkmark.setAttribute('width', '12');
        checkmark.setAttribute('height', '10');
        checkmark.setAttribute('viewBox', '0 0 12 10');
        checkmark.setAttribute('fill', 'none');
        checkmark.style.display = 'none';
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 'M1 5L4.5 8.5L11 1.5');
        path.setAttribute('stroke', 'white');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        checkmark.appendChild(path);
        checkbox.appendChild(checkmark);

        const label = document.createElement('span');
        label.textContent = metric.label;

        item.appendChild(checkbox);
        item.appendChild(label);

        item.onmouseover = function() {
            this.style.background = 'rgba(0, 0, 0, 0.05)';
        };
        item.onmouseout = function() {
            this.style.background = 'transparent';
        };
        item.onclick = function(e) {
            e.stopPropagation();
            toggleTaskHistoryMetric(metric.id);
        };

        menu.appendChild(item);
    });

    // Dropdown toggle
    btn.onclick = function(e) {
        e.stopPropagation();
        const isOpen = menu.style.display === 'block';
        menu.style.display = isOpen ? 'none' : 'block';
        icon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
    };

    // Close on outside click
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.task-history-dropdown-container')) {
            menu.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    });

    updateTaskHistoryDropdownDisplay();
}

function toggleTaskHistoryMetric(metricId) {
    const index = taskHistoryState.selectedMetrics.indexOf(metricId);
    
    if (index !== -1) {
        taskHistoryState.selectedMetrics.splice(index, 1);
    } else {
        taskHistoryState.selectedMetrics.push(metricId);
    }

    updateTaskHistoryDropdownDisplay();
    renderTaskHistoryGraph();
}

function updateTaskHistoryDropdownDisplay() {
    const text = document.getElementById('taskHistoryMetricsText');
    
    if (taskHistoryState.selectedMetrics.length === 0) {
        text.textContent = 'Pasirinkite rodiklius';
    } else {
        const selectedTitles = taskHistoryState.selectedMetrics.map(function(id) {
            const metric = taskHistoryMetrics.find(function(m) { return m.id === id; });
            return metric ? metric.label : '';
        }).filter(function(t) { return t; });
        
        // ADD THIS LINE - update the text display
        text.textContent = selectedTitles.join(', ');
    }
    
    // Update checkboxes
    const checkboxes = document.querySelectorAll('.task-history-metric-checkbox');
    checkboxes.forEach(function(checkbox) {
        const metricId = checkbox.getAttribute('data-metric-id');
        const isSelected = taskHistoryState.selectedMetrics.indexOf(metricId) !== -1;
        const metric = taskHistoryMetrics.find(function(m) { return m.id === metricId; });
        
        if (isSelected) {
            checkbox.style.background = metric.color;
            checkbox.querySelector('svg').style.display = 'block';
        } else {
            checkbox.style.background = 'transparent';
            checkbox.querySelector('svg').style.display = 'none';
        }
    });
}

function initTaskHistoryDateInputs(data) {
    if (!data || !data.studentDates || data.studentDates.length === 0) {
        return;
    }

    // Find actual min/max dates from ALL data (student + averages)
    const allDates = [...data.studentDates, ...data.averageDates].sort();
    const minDate = allDates[0];
    const maxDate = allDates[allDates.length - 1];

    // Global earliest across all students = earliest average date (class-wide)
    const globalMinDate = (taskHistoryState.rawData && taskHistoryState.rawData.averageDates && taskHistoryState.rawData.averageDates.length > 0)
        ? [...taskHistoryState.rawData.averageDates].sort()[0]
        : minDate;

    // Store data max so Išvalyti on iki can reset to it
    taskHistoryState.dataMaxDate = maxDate;

    // Set default range if not already set (use full data range)
    if (!taskHistoryState.startDate) {
        taskHistoryState.startDate = minDate;
    }
    if (!taskHistoryState.endDate) {
        taskHistoryState.endDate = maxDate;
    }

    const today = new Date().toISOString().split('T')[0];

    // Destroy existing flatpickr instances if they exist
    if (taskHistoryState._startFp && typeof taskHistoryState._startFp.destroy === 'function') { taskHistoryState._startFp.destroy(); }
    if (taskHistoryState._endFp && typeof taskHistoryState._endFp.destroy === 'function') { taskHistoryState._endFp.destroy(); }

    taskHistoryState._startFp = flatpickr("#taskHistoryStartDate", {
        locale: "lt",
        disableMobile: true,
        dateFormat: "Y-m-d",
        allowInput: false,
        clickOpens: true,
        defaultDate: taskHistoryState.startDate,
        minDate: globalMinDate,
        maxDate: today,

        onChange: function(selectedDates, dateStr) {
            if (!dateStr) return;
            const newStart = dateStr;
            if (newStart > taskHistoryState.endDate) {
                taskHistoryState.endDate = newStart;
                taskHistoryState._endFp.setDate(newStart, false);
            }
            taskHistoryState.startDate = newStart;
            renderTaskHistoryGraph();
        },

        onReady: function(selectedDates, dateStr, instance) {
            lockYearInput(instance);
            const clearBtn = document.createElement("button");
            clearBtn.innerText = "Išvalyti";
            clearBtn.type = "button";
            clearBtn.className = "lt-date-btn lt-date-btn-clear";
            clearBtn.onclick = function() {
                instance.setDate(minDate, true);
                instance.close();
            };
            const btnRow = document.createElement("div");
            btnRow.className = "lt-date-btn-row";
            btnRow.appendChild(clearBtn);
            if (instance.calendarContainer) instance.calendarContainer.appendChild(btnRow);
        }
    });

    taskHistoryState._endFp = flatpickr("#taskHistoryEndDate", {
        locale: "lt",
        disableMobile: true,
        dateFormat: "Y-m-d",
        allowInput: false,
        clickOpens: true,
        defaultDate: taskHistoryState.endDate,
        maxDate: today,

        onChange: function(selectedDates, dateStr) {
            if (!dateStr) return;
            const newEnd = dateStr;
            if (newEnd < taskHistoryState.startDate) {
                taskHistoryState.startDate = newEnd;
                taskHistoryState._startFp.setDate(newEnd, false);
            }
            taskHistoryState.endDate = newEnd;
            renderTaskHistoryGraph();
        },

        onReady: function(selectedDates, dateStr, instance) {
            lockYearInput(instance);
            const clearBtn = document.createElement("button");
            clearBtn.innerText = "Išvalyti";
            clearBtn.type = "button";
            clearBtn.className = "lt-date-btn lt-date-btn-clear";
            clearBtn.onclick = function() {
                const resetDate = taskHistoryState.dataMaxDate || maxDate;
                instance.setDate(resetDate, true);
                instance.close();
            };
            const btnRow = document.createElement("div");
            btnRow.className = "lt-date-btn-row";
            btnRow.appendChild(clearBtn);
            if (instance.calendarContainer) instance.calendarContainer.appendChild(btnRow);
        }
    });
}

function filterTaskHistoryData(data) {
    if (!taskHistoryState.startDate || !taskHistoryState.endDate) {
        return data;
    }

    const start = new Date(taskHistoryState.startDate + 'T00:00:00Z');
    const end = new Date(taskHistoryState.endDate + 'T00:00:00Z');

    const filteredStudentDates = [];
    const filteredMistakeFreq = [];
    const filteredAnswerRate = [];

    data.studentDates.forEach(function(date, i) {
        const d = new Date(date + 'T00:00:00Z');
        if (d >= start && d <= end) {
            filteredStudentDates.push(date);
            filteredMistakeFreq.push(data.mistakeFrequency[i]);
            filteredAnswerRate.push(data.answerRate[i]);
        }
    });

    const filteredAverageDates = [];
    const filteredAvgMistakeFreq = [];
    const filteredAvgAnswerRate = [];

    data.averageDates.forEach(function(date, i) {
        const d = new Date(date + 'T00:00:00Z');
        if (d >= start && d <= end) {
            filteredAverageDates.push(date);
            filteredAvgMistakeFreq.push(data.averageMistakeFrequency[i]);
            filteredAvgAnswerRate.push(data.averageAnswerRate[i]);
        }
    });

    return {
        studentDates: filteredStudentDates,
        mistakeFrequency: filteredMistakeFreq,
        answerRate: filteredAnswerRate,
        averageDates: filteredAverageDates,
        averageMistakeFrequency: filteredAvgMistakeFreq,
        averageAnswerRate: filteredAvgAnswerRate
    };
}

// Generate nice x-axis labels
function generateXAxisLabels(dates) {
    if (!dates || dates.length === 0) return [];

    const sortedDates = [...dates].sort();
    const firstDate = new Date(sortedDates[0]);
    const lastDate = new Date(sortedDates[sortedDates.length - 1]);
    const daysDiff = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24));

    let interval;
    if (daysDiff <= 7) {
        interval = 1; // Daily
    } else if (daysDiff <= 30) {
        interval = 3; // Every 3 days
    } else if (daysDiff <= 90) {
        interval = 7; // Weekly
    } else if (daysDiff <= 180) {
        interval = 14; // Bi-weekly
    } else {
        interval = 30; // Monthly
    }

    const labels = [];
    const currentDate = new Date(firstDate);
    
    while (currentDate <= lastDate) {
        labels.push(currentDate.toISOString().split('T')[0]);
        currentDate.setDate(currentDate.getDate() + interval);
    }

    // Always include last date
    const lastLabel = labels[labels.length - 1];
    const lastDataDate = sortedDates[sortedDates.length - 1];
    if (lastLabel !== lastDataDate) {
        labels.push(lastDataDate);
    }

    return labels;
}

// Format date for display (e.g., "Sau. 15", "Vas. 3")
function formatDateLabel(dateStr) {
    const months = ['Sau.', 'Vas.', 'Kov.', 'Bal.', 'Geg.', 'Bir.', 
                    'Lie.', 'Rugp.', 'Rugs.', 'Spal.', 'Lap.', 'Gruod.'];
    const date = new Date(dateStr);
    return months[date.getMonth()] + ' ' + date.getDate();
}

function renderTaskHistoryGraph() {
    if (taskHistoryState.chart) {
        taskHistoryState.chart.destroy();
        taskHistoryState.chart = null;
    }

    if (!taskHistoryState.rawData) {
        document.querySelector('.task-history-chart-wrapper').innerHTML =
            '<div class="task-history-empty">Nėra duomenų.</div>';
        return;
    }

    const hasAnyData = taskHistoryState.rawData.studentDates.length > 0 ||
                       taskHistoryState.rawData.averageDates.length > 0;

    if (!hasAnyData) {
        document.querySelector('.task-history-chart-wrapper').innerHTML =
            '<div class="task-history-empty">Nepakanka duomenų šiai užduočiai (reikia bent 5 įrašų).</div>';
        return;
    }

    const filteredData = filterTaskHistoryData(taskHistoryState.rawData);

    if (filteredData.studentDates.length === 0 && filteredData.averageDates.length === 0) {
        document.querySelector('.task-history-chart-wrapper').innerHTML =
            '<div class="task-history-empty">Nėra duomenų pasirinktam laikotarpiui.</div>';
        return;
    }

    let canvas = document.getElementById('taskHistoryChart');
    if (!canvas) {
        document.querySelector('.task-history-chart-wrapper').innerHTML =
            '<canvas id="taskHistoryChart"></canvas>';
        canvas = document.getElementById('taskHistoryChart');
    }

    // X-axis bounds: driven by student dates if a student is selected, otherwise by average dates.
    // This prevents class-average dates outside the student's range from creating x-axis gaps.
    const hasStudentData = filteredData.studentDates.length > 0;
    const boundingDates = hasStudentData ? filteredData.studentDates : filteredData.averageDates;
    const axisStart = boundingDates[0];
    const axisEnd = boundingDates[boundingDates.length - 1];
    const allDates = [...new Set([...filteredData.studentDates, ...filteredData.averageDates])]
        .sort()
        .filter(d => d >= axisStart && d <= axisEnd);

    const xLabels = allDates.map(date => formatDateLabel(date));
    const datasets = [];

    function computeTrendline(alignedData) {
        // Step 1: backward-looking rolling average, window=3
        // Each point is the average of itself and up to 2 preceding non-null values.
        // This means the last point (potential outlier) is smoothed by recent history,
        // and no future data is needed — causal and symmetric treatment across all points.
        const smoothed = alignedData.map((v, i) => {
            if (v === null) return null;
            const window = [];
            for (let j = i; j >= 0 && window.length < 2; j--) {
                if (alignedData[j] !== null) window.push(alignedData[j]);
            }
            return window.reduce((a, b) => a + b, 0) / window.length;
        });

        // Step 2: fit regression to smoothed series
        const points = [];
        smoothed.forEach((v, i) => { if (v !== null) points.push({ x: i, y: v }); });
        if (points.length < 2) return alignedData.map(() => null);

        const n = points.length;
        const sumX = points.reduce((a, p) => a + p.x, 0);
        const sumY = points.reduce((a, p) => a + p.y, 0);
        const sumXY = points.reduce((a, p) => a + p.x * p.y, 0);
        const sumXX = points.reduce((a, p) => a + p.x * p.x, 0);
        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;

        // Step 3: span from first to last raw non-null point so trendline is always full length
        const rawIndices = alignedData.map((v, i) => v !== null ? i : null).filter(i => i !== null);
        const firstIdx = rawIndices[0];
        const lastIdx = rawIndices[rawIndices.length - 1];

        return alignedData.map((_, i) => {
            if (i < firstIdx || i > lastIdx) return null;
            return Number((slope * i + intercept).toFixed(2));
        });
    }

    const axisColorInfo = {};

    taskHistoryState.selectedMetrics.forEach(function(metricId) {
        const metric = taskHistoryMetrics.find(m => m.id === metricId);
        if (!metric) return;

        const avgDataKey = 'average' + metricId.charAt(0).toUpperCase() + metricId.slice(1);
        const avgData = filteredData[avgDataKey];
        const avgDates = filteredData.averageDates;
        const studentData = filteredData[metricId];
        const studentDates = filteredData.studentDates;

        const alignedStudentData = allDates.map(date => {
            const idx = studentDates.indexOf(date);
            return idx !== -1 ? studentData[idx] : null;
        });

        if (!axisColorInfo[metric.yAxisID]) axisColorInfo[metric.yAxisID] = [];
        axisColorInfo[metric.yAxisID].push(metric.color);

        // 1. Student trendline — bright solid, filled square in tooltip
        const trendData = computeTrendline(alignedStudentData);
        if (trendData.some(v => v !== null)) {
            datasets.push({
                label: '_trend_' + metricId,
                data: trendData,
                borderColor: metric.color,
                backgroundColor: metric.color,
                borderWidth: 3,
                tension: 0,
                pointRadius: 0,
                pointHoverRadius: 0,
                yAxisID: metric.yAxisID,
                order: 2,
                spanGaps: false,
                isTrendline: true
            });
        }

        // 2. Class average — dashed, white-fill square in tooltip
        if (avgData && avgData.length > 0 && avgDates && avgDates.length > 0) {
            const alignedAvgData = allDates.map(date => {
                const idx = avgDates.indexOf(date);
                return idx !== -1 ? avgData[idx] : null;
            });
            datasets.push({
                label: '_avg_' + metricId,
                data: alignedAvgData,
                borderColor: metric.color,
                backgroundColor: 'rgba(255,255,255,0.8)',
                borderWidth: 2,
                borderDash: [6, 4],
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 0,
                yAxisID: metric.yAxisID,
                order: 3,
                spanGaps: true,
                isAverage: true
            });
        }

        // 3. Student data — faint solid, not in tooltip
        if (studentData && studentData.length > 0) {
            datasets.push({
                label: '_data_' + metricId,
                data: alignedStudentData,
                borderColor: metric.color + '60',
                backgroundColor: metric.color + '60',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 0,
                pointHoverRadius: 4,
                pointBackgroundColor: metric.color,
                yAxisID: metric.yAxisID,
                order: 1,
                spanGaps: true
            });
        }
    });

    const yAxes = {};

    if (taskHistoryState.selectedMetrics.indexOf('mistakeFrequency') !== -1) {
        yAxes['y-percent'] = {
            type: 'linear',
            display: true,
            position: 'left',
            min: 0,
            suggestedMax: 100,
            title: {
                display: true,
                text: 'Klaidų dažnis (%)',
                color: '#666',
                font: { size: 12, weight: 'bold' }
            },
            ticks: {
                callback: function(value) { return Math.round(value); },
                stepSize: 10,
                color: '#666'
            },
            grid: { color: 'rgba(0, 0, 0, 0.1)' },
            border: { display: false }
        };
    }

    if (taskHistoryState.selectedMetrics.indexOf('answerRate') !== -1) {
        yAxes['y-rate'] = {
            type: 'linear',
            display: true,
            position: 'right',
            min: 0,
            title: {
                display: true,
                text: 'Sprendimų greitis (ats./min.)',
                color: '#666',
                font: { size: 12, weight: 'bold' }
            },
            ticks: {
                callback: function(value) { return Math.round(value); },
                stepSize: 1,
                color: '#666'
            },
            grid: {
                drawOnChartArea: taskHistoryState.selectedMetrics.indexOf('mistakeFrequency') === -1,
                color: 'rgba(0, 0, 0, 0.1)'
            },
            border: { display: false }
        };
    }

    const gray = '#888888';
    const ctx = canvas.getContext('2d');

    taskHistoryState.chart = new Chart(ctx, {
        type: 'line',
        data: { labels: xLabels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        usePointStyle: false,
                        padding: 15,
                        generateLabels: function() {
                            const isClassView = taskHistoryState.isClassAverageView;
                            const entries = [];
                            const hasTrend = datasets.some(ds => ds.isTrendline);
                            const hasData = datasets.some(ds => ds.label && ds.label.startsWith('_data_'));
                            const hasAvg = datasets.some(ds => ds.isAverage);

                            if (hasTrend) entries.push({
                                text: isClassView ? 'Klasės tendencija' : 'Mokinio tendencija',
                                fillStyle: gray,
                                strokeStyle: gray,
                                lineWidth: 3,
                                lineDash: [],
                                pointStyle: false,
                                hidden: false
                            });
                            if (hasData) entries.push({
                                text: isClassView ? 'Klasės duomenys' : 'Mokinio duomenys',
                                fillStyle: gray + '60',
                                strokeStyle: gray + '60',
                                lineWidth: 2,
                                lineDash: [],
                                pointStyle: false,
                                hidden: false
                            });
                            if (hasAvg) entries.push({
                                text: 'Klasės tendencija',
                                fillStyle: 'rgba(255,255,255,0.8)',
                                strokeStyle: gray,
                                lineWidth: 2,
                                lineDash: [6, 4],
                                pointStyle: false,
                                hidden: false
                            });
                            return entries;
                        }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    filter: function(tooltipItem) {
                        if (!tooltipItem.dataset.label) return false;

                        const label = tooltipItem.dataset.label;
                        const isStudentTrend = label.startsWith('_trend_');
                        const isAvg = tooltipItem.dataset.isAverage;

                        if (!isStudentTrend && !isAvg) return false;

                        const trendDatasets = tooltipItem.chart.data.datasets.filter(
                            ds => ds.label && ds.label.startsWith('_trend_')
                        );
                        const hasTrendData = trendDatasets.some(
                            ds => ds.data[tooltipItem.dataIndex] !== null &&
                                ds.data[tooltipItem.dataIndex] !== undefined
                        );
                        if (!hasTrendData) return false;

                        return tooltipItem.dataset.data[tooltipItem.dataIndex] !== null &&
                            tooltipItem.dataset.data[tooltipItem.dataIndex] !== undefined;
                    },
                    callbacks: {
                        label: function(context) {
                            const metricId = context.dataset.label.replace('_avg_', '').replace('_trend_', '');
                            const metric = taskHistoryMetrics.find(m => m.id === metricId);
                            const label = metric ? (context.dataset.isAverage
                                ? `${metric.label} (klasės tend.)`
                                : `${metric.label} (mokinio tend.)`) : '';
                            return (label ? label + ': ' : '') + (context.dataset.yAxisID === 'y-percent'
                                ? Math.round(context.parsed.y) + '%'
                                : Math.round(context.parsed.y * 10) / 10);
                        }
                    }
                }
            },
            scales: Object.assign({
                x: {
                    type: 'category',
                    ticks: { maxRotation: 45, minRotation: 0, autoSkip: true, maxTicksLimit: 10 },
                    grid: { display: false }
                }
            }, yAxes)
        },
        plugins: [{
            id: 'coloredAxisLines',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                const chartArea = chart.chartArea;

                Object.keys(axisColorInfo).forEach(function(scaleId) {
                    const scale = chart.scales[scaleId];
                    if (!scale) return;

                    const colors = axisColorInfo[scaleId];
                    if (!colors || colors.length === 0) return;

                    const lineWidth = 3;
                    const isLeft = scale.position === 'left';
                    const x = isLeft ? scale.left : scale.right;
                    const y1 = chartArea.top;
                    const y2 = chartArea.bottom;
                    const axisFullWidth = scale.width;

                    colors.forEach(function(color, i) {
                        const secondaryLineShift = i * lineWidth;
                        ctx.save();
                        ctx.strokeStyle = hexToRgba(color, 0.6);
                        ctx.lineWidth = lineWidth;
                        ctx.beginPath();
                        const xPos = isLeft
                            ? x + axisFullWidth - secondaryLineShift
                            : x - axisFullWidth + secondaryLineShift;
                        ctx.moveTo(xPos, y1);
                        ctx.lineTo(xPos, y2);
                        ctx.stroke();
                        ctx.restore();
                    });
                });
            }
        }]
    });
}

function initTaskHistoryGraph(data) {
    taskHistoryState.rawData = data;
    // Preserve any user-set date range; only reset dataMaxDate so Išvalyti recalculates correctly
    taskHistoryState.dataMaxDate = null;
    initTaskHistoryDropdown();
    initTaskHistoryDateInputs(data);
    renderTaskHistoryGraph();
}

function renderTaskHistoryDescription() {
    const box = document.getElementById('task-history-description-box');
    const content = document.getElementById('task-history-description-content');
    if (!box || !content) return;

    const task = taskHistoryCurrentTask;
    
    if (!task || !task[0]) { box.style.display = 'none'; return; }

    try {
        // task may be an array of task arrays (expandedTasks) — use the first one
        const taskArr = Array.isArray(task[0]) ? task[0] : task;

        const formatted = getOptionTextFromValues(taskArr, null, true, true);

        if (!formatted || formatted.length === 0) { box.style.display = 'none'; return; }

        const primary = formatted.filter(([_, t]) => t === 'primary').map(([v]) => v);
        const secondary = formatted.filter(([_, t]) => t === 'secondary').map(([v]) => v);
        const grammarParams = formatted.filter(([_, t]) => t === 'grammar-params').map(([v]) => Array.isArray(v) ? v.join(' | ') : v);

        const subjectColors = {
            'TURINIO KOMPONAVIMAS': '#32ac93',
            'STRUKTŪROS IŠDĖSTYMAS': '#32ac93',
            'RAŠYBA': '#F28C28',
            'default': '#286D8A',
        };
        const firstColor = subjectColors[primary[0]] || subjectColors['default'];

        let html = '';
        const allItems = [...primary, ...secondary, ...(grammarParams.length ? [`[${grammarParams.join(' | ')}]`] : [])];

        if (allItems.length > 0) {
            html += `<div style="margin-bottom:3px; opacity:0.85; font-size:0.9rem;">`;
            allItems.forEach((item, i) => {
                const color = i === 0 ? firstColor : 'inherit';
                const weight = i === 0 ? '600' : '400';
                html += `<span style="color:${color}; font-weight:${weight};">${item}</span>`;
                if (i < allItems.length - 1) html += ` <span style="opacity:0.4;">•</span> `;
            });
            html += `</div>`;
        }

        content.innerHTML = html;
        box.style.display = 'block';
    } catch (e) {
        box.style.display = 'none';
    }
}

// TASK HISTORY GRAPH END
    

    if (userData) {
        if (userData.accType === 'teacher') {
            teacherGUI.style.display = 'flex';
            fetchDataForTeachers();
            initTxtViewer();
            window.openTextBrowser = openTextBrowser;
        } else if (userData.accType === 'student') {
            studentGUI.style.display = 'flex';
            fetchDataForStudents();
        }
    }

function disableTeacherControlPannel() {
    const parentDiv = document.getElementById('student-details-for-teachers');
    const children = parentDiv.querySelectorAll('button, input, select, textarea');  // Add more form elements if needed
    children.forEach(child => child.disabled = true);
}

function enableTeacherControlPannel() {
    const parentDiv = document.getElementById('student-details-for-teachers');
    const children = parentDiv.querySelectorAll('button, input, select, textarea');
    children.forEach(child => child.disabled = false);
}

function disableNewTaskContainer() {
    const parentDiv = document.getElementById('new-task-options-container');
    const children = parentDiv.querySelectorAll('button, input, select, textarea');  // Add more form elements if needed
    children.forEach(child => child.disabled = true);
}

function enableNewTaskContainer() {
    const parentDiv = document.getElementById('new-task-options-container');
    const children = parentDiv.querySelectorAll('button, input, select, textarea');
    children.forEach(child => child.disabled = false);
}



document.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        event.preventDefault(); // Optional: prevent form submission or other default behavior
        document.getElementById("submitButton").click();
    }
});












const sidebarWrapper = document.getElementById('sidebarWrapper');
const toggleTab = document.getElementById('toggleTab');
const sidebarContent = document.getElementById('sidebarContent');

// Toggle sidebar function
function toggleSidebar() {
    // Only works on mobile
    sidebarWrapper.classList.toggle('open');
}

// Open sidebar function
function openSidebar() {
    sidebarWrapper.classList.add('open');
}

// Close sidebar function
function closeSidebar() {
    sidebarWrapper.classList.remove('open');
}

// Event listeners
toggleTab.addEventListener('click', toggleSidebar);

// Handle escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && sidebarWrapper.classList.contains('open')) {
    closeSidebar();
    }
});

// Close sidebar on window resize if it becomes desktop size
window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
    closeSidebar();
    }
});


const sidebarWrapperStudent = document.getElementById('sidebarWrapperStudent');
const toggleTabStudent = document.getElementById('toggleTabStudent');
const sidebarContentStudent = document.getElementById('sidebarContentStudent');

// Toggle sidebar function
function toggleSidebarStudent() {
    sidebarWrapperStudent.classList.toggle('open');
}

// Open sidebar function
function openSidebarStudent() {
    sidebarWrapperStudent.classList.add('open');
}

// Close sidebar function
function closeSidebarStudent() {
    sidebarWrapperStudent.classList.remove('open');
}

// Event listeners
toggleTabStudent.addEventListener('click', toggleSidebarStudent);

// Handle escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && sidebarWrapperStudent.classList.contains('open')) {
        closeSidebarStudent();
    }
});

// Close sidebar on window resize if it becomes desktop size
window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
        closeSidebarStudent();
    }
});







// Initialize button state
let currentAction = null;


function showConfirmationButtons(action) {
    currentAction = action;
    
    // Update confirm button label based on action
    const confirmLabel = document.getElementById('confirm-label');
    const cancelLabel = document.getElementById('cancel-label');

    switch(action) {
        case 'new-task':
            confirmLabel.textContent = 'Sukurti užduotį';
            cancelLabel.textContent = 'Atšaukti';
            toggleAddNewTask();
            break;
        case 'delete-task':
            confirmLabel.textContent = 'Trinti užduotis';
            cancelLabel.textContent = 'Atšaukti';
            toggleDeleteTask();
            break;
        case 'delete-student':
            confirmLabel.textContent = 'Šalinti mokinius';
            cancelLabel.textContent = 'Atšaukti';
            toggleDeleteStudent();
            break;
        case 'browse-history':
            confirmLabel.textContent = 'Ieškoti';
            cancelLabel.textContent = 'Uždaryti archyvą';
            toggleBrowseHistory();
            break;
    }
    
    document.getElementById('action-buttons-container').style.display = 'none';
    document.getElementById('confirmation-buttons-container').style.display = 'flex';
}

function hideConfirmationButtons() {
    document.getElementById('confirm-button').disabled = false;
    document.getElementById('cancel-button').disabled = false;
    document.getElementById('confirmation-buttons-container').style.display = 'none';
    document.getElementById('new-search-button').disabled = false;
    document.getElementById('new-search-button').style.display = 'none';
    document.getElementById('action-buttons-container').style.display = 'flex';
    currentAction = null;
}

function disableConfirmationButtons() {
    document.getElementById('confirm-button').disabled = true;
    document.getElementById('cancel-button').disabled = true;
    document.getElementById('new-search-button').disabled = true;
}

function enableConfirmationButtons() {
    document.getElementById('confirm-button').disabled = false;
    document.getElementById('cancel-button').disabled = false;
    document.getElementById('new-search-button').disabled = false;
}

// Set up button click handlers
document.addEventListener('DOMContentLoaded', () => {
    // Action buttons
    document.getElementById('new-task-button').addEventListener('click', () => {
        showConfirmationButtons('new-task');
    });
    
    document.getElementById('delete-task-button').addEventListener('click', () => {
        showConfirmationButtons('delete-task');
    });
    
    document.getElementById('delete-student-button').addEventListener('click', () => {
        showConfirmationButtons('delete-student');
    });

     document.getElementById('browse-task-history-button').addEventListener('click', () => {
        showConfirmationButtons('browse-history');
        loadTaskArchive();
    });
    
    // Confirmation buttons
    document.getElementById('confirm-button').addEventListener('click', () => {
        if (currentAction === 'new-task') {
            setTask();
        } else if (currentAction === 'delete-task') {
            deleteSelectedTasks();
        } else if (currentAction === 'delete-student') {
            deleteStudents();
        } else if (currentAction === 'browse-history') {
            setTaskHistoryQuery();
            openSidebar();
        }
    });
    
    document.getElementById('cancel-button').addEventListener('click', () => {
         if (currentAction === 'new-task') {
            toggleAddNewTask();
        } else if (currentAction === 'delete-task') {
            toggleDeleteTask();
        } else if (currentAction === 'delete-student') {
            toggleDeleteStudent();
        } else if (currentAction === 'browse-history') {
            toggleBrowseHistory();
        }
        hideConfirmationButtons();
    });
});

function incrementValue(inputId, min, max) {
    const input = document.getElementById(inputId);
    let value = parseInt(input.value) || min;
    if (value < max) {
        input.value = value + 1;
    }
    setLabelEndingForDuration();
    setLabelEndingForQuestionNumber();
}

function decrementValue(inputId, min, max) {
    const input = document.getElementById(inputId);
    let value = parseInt(input.value) || min;
    if (value > min) {
        input.value = value - 1;
    }
    setLabelEndingForDuration();
    setLabelEndingForQuestionNumber();
}

// Validate input on change
document.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('change', function() {
        const min = parseInt(this.min);
        const max = parseInt(this.max);
        let value = parseInt(this.value);
        
        if (isNaN(value) || value < min) {
            this.value = min;
        } else if (value > max) {
            this.value = max;
        }
    });
});

function displayFrequentMistakes () {
    generateSummaryTable('total', null, "summary-table-frequent-mistakes", "summary-table-grammar-frequent-mistakes");
    clearTaskInfoContainerForStudents();
    frequentMistakeContainerElement.style.display = "flex";
    openSidebarStudent();
}

    function displayMathSummary () {
            document.querySelector("#display-math-summary-button").classList.add("active-summary-button")
            document.querySelector("#display-grammar-summary-button").classList.remove("active-summary-button")
            document.querySelector("#summary-table-outer-div").style.display = "flex";
            document.querySelector("#summary-table-grammar-outer-div").style.display = "none";
            if (document.querySelector("#summary-table").innerHTML === "Klaidų nėra!") {
                document.querySelector("#table-container-math").style.boxShadow = "none";
                document.querySelector("#mistakes-summary-math").style.fontSize = "2rem";
                document.querySelector("#summary-table").style.height = "200px";
            }
        }

    function displayGrammarSummary () {
        document.querySelector("#display-math-summary-button").classList.remove("active-summary-button")
        document.querySelector("#display-grammar-summary-button").classList.add("active-summary-button")
        document.querySelector("#summary-table-outer-div").style.display = "none";
        document.querySelector("#summary-table-grammar-outer-div").style.display = "flex";

        if ((document.querySelector("#summary-table-grammar").innerHTML === "Klaidų nėra!")) {
                document.querySelector("#table-container-grammar").style.boxShadow = "none";
                document.querySelector("#mistakes-summary-grammar").style.fontSize = "2rem";
                document.querySelector("#summary-table-grammar").style.height = "200px";
        }
    }

function editStudentName(studentId, buttonEl) {
    const studentNameSpan = document.getElementById('student-name');

    const input = document.createElement('input');
    input.type = 'text';
    input.value = studentNameSpan.textContent;
    input.maxLength = 30;
    input.className = 'student-name-field';

    studentNameSpan.replaceWith(input);
    input.focus();

    input.addEventListener('input', () => {
        input.style.width = Math.max(input.value.length + 1.5) + 'ch';
    });

    input.dispatchEvent(new Event('input'));

    buttonEl.innerHTML = '<span class="edit-icon"><img src="../images/icons/icon-check-black.svg"></span>';
    buttonEl.setAttribute('onclick', `saveStudentName('${studentId}', this)`);
}

// Add this function to your script section in uzduotys.html

async function saveStudentName(studentId, buttonEl) {
    const input = document.querySelector('.student-name-field');
    const newName = input.value.trim();
    
    // Find the student in studentList
    const student = studentList.find(s => s.id === parseInt(studentId));
    if (!student) {
        messageToTheUser("Mokinys nerastas!");
        return;
    }
    
    const originalName = student.nickname; // Save original name
    
    // Validation
    if (newName.length === 0) {
        messageToTheUser("Vardas negali būti tuščias!");
        // Revert to edit mode
        editStudentName(studentId, buttonEl);
        return;
    }
    
    if (newName.length > 30) {
        messageToTheUser("Maksimalus vardo ilgis yra 30 simbolių.");
        return;
    }
    
    // Check if name actually changed
    if (newName === originalName) {
        // No change, just revert to display mode
        const span = document.createElement('span');
        span.id = 'student-name';
        span.textContent = newName;
        input.replaceWith(span);
        
        buttonEl.innerHTML = '<span class="edit-icon"><img src="../images/icons/icon-edit.svg"></span>';
        buttonEl.setAttribute('onclick', `editStudentName('${studentId}', this)`);
        return;
    }
    
    // Disable button during save
    buttonEl.disabled = true;
    input.disabled = true;
    
    try {
        const response = await apiFetch(apiBase + 'class/updateNickname', {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                studentId: parseInt(studentId),
                nickname: newName
            })
        });
        
        if (!response) {
            throw new Error('No response from server');
        }
        
        // First check if response is OK
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
        }
        
        // Try to parse JSON response
        const responseData = await response.json().catch(() => ({}));
        
        console.log('Server response:', responseData); // Debug log
        
        // Check for success - be more flexible with the response
        if (response.ok && responseData) {
            // Update the student in studentList
            student.nickname = newName;
            
            // Update all instances in the UI
            updateStudentNameInUI(studentId, newName);
            
            messageToTheUser("Vardas sėkmingai atnaujintas!", false);
        } else {
            throw new Error(responseData.message || 'Unexpected response format');
        }
        
    } catch (error) {
        console.error('Error updating student name:', error);

        // Revert to original name in UI
        updateStudentNameInUI(studentId, originalName);

        if (error.message === "Unauthorized") {
            clearUserData();
            window.location.href = "prisijungimas";
        } else {
            messageToTheUser('Nepavyko atnaujinti vardo. Bandykite vėl vėliau.');
        }
    } finally {
        // Revert to display mode (use current value from studentList)
        const span = document.createElement('span');
        span.id = 'student-name';
        span.textContent = student.nickname; // Use the current value from studentList
        input.replaceWith(span);
        
        buttonEl.disabled = false;
        buttonEl.innerHTML = '<span class="edit-icon"><img src="../images/icons/icon-edit.svg"></span>';
        buttonEl.setAttribute('onclick', `editStudentName('${studentId}', this)`);
    }
}

function updateStudentNameInUI(studentId, newName) {
    // Update main student list (left column)
    const studentElements = document.querySelectorAll(`.student-name[data-student-id="${studentId}"]`);

    studentElements.forEach(el => {
        const originalText = el.textContent;

        // Extract order number: "1. Name (ID: X)"
        const match = originalText.match(/^(\d+)\.\s/);
        const orderNumber = match ? match[1] : "";

        el.textContent = `${orderNumber}. ${newName} (ID: ${studentId})`;
    });

    // Update edit panel header (right side)
    const editPanelName = document.querySelector('#student-name');
    if (editPanelName) {
        editPanelName.textContent = newName;
    }
}


function updateButtonLayout() {
  const container = document.getElementById('action-buttons-container');
  const buttons = Array.from(container.querySelectorAll('.teacher-action-btn'));
  const labels = container.querySelectorAll('.btn-label');
  
  // Remove two-row class from all
  labels.forEach(label => label.classList.remove('two-rows-button-label'));
  
  // Force reflow
  container.offsetHeight;
  
  setTimeout(() => {
    // Check if ANY label has wrapped internally (height > one line)
    let anyLabelWrapped = false;
    
    labels.forEach(label => {
      const spans = label.querySelectorAll('span');
      if (spans.length >= 2) {
        const firstSpanTop = spans[0].getBoundingClientRect().top;
        const secondSpanTop = spans[1].getBoundingClientRect().top;
        
        // If spans are on different lines, this label wrapped
        if (Math.abs(secondSpanTop - firstSpanTop) > 5) {
          anyLabelWrapped = true;
        }
      }
    });
    
    // If ANY label wrapped, make ALL labels two-row
    if (anyLabelWrapped) {
      labels.forEach(label => label.classList.add('two-rows-button-label'));
    }
  }, 50);
}

window.addEventListener('load', updateButtonLayout);
window.addEventListener('resize', updateButtonLayout);

window.onload = function () {
    const savedController = localStorage.getItem('controller');
    if (savedController) {
        controller = JSON.parse(savedController);
        redirectToAppropriateLanguage(controller.language);
        resetControllerTaskSettings();
    } else {
        controller.language = "LT";
        localStorage.setItem('controller', JSON.stringify(controller));
    }
}

function addHideScrollbarForTouch() {
    // Check if device is touchscreen
    const isTouchDevice = ('ontouchstart' in window) || 
                          (navigator.maxTouchPoints > 0) || 
                          (navigator.msMaxTouchPoints > 0);

    if (!isTouchDevice) { 
        document.querySelector(".chart-container .scroll-indicator-line-horizontal.bottom").style.bottom = "36px";
        return;
    }

    if (window.matchMedia('(max-width: 578px)').matches) {
        document.querySelector(".chart-container .scroll-indicator-line-horizontal.bottom").style.bottom = "16px";
    } else {
        document.querySelector(".chart-container .scroll-indicator-line-horizontal.bottom").style.bottom = "26px";
    }

    // Select all chart-body elements
    const chartBodies = document.querySelectorAll('.chart-body');

    chartBodies.forEach(el => {
        el.classList.add('hide-scrollbar');
    });
}

window.addEventListener('load', addHideScrollbarForTouch);
window.addEventListener('resize', addHideScrollbarForTouch);


// TEXT VIEWER START
// Global variables
let prefilteredTexts = {}; // now an object keyed by id
let allTexts = [];
let selectedIds = [];
let isSelectionModeEnabled = false;
let expandedTextIds = new Set();
let isMainBrowserExpanded = false;

// Cache for pre-processed search data
let textSearchCache = new Map();

// Debounce timer
let searchDebounceTimer = null;

// Lazy loading variables
let filteredTexts = [];
let renderedItems = new Set();
let itemHeight = 60; // Approximate collapsed item height
let expandedItemHeight = 400; // Approximate expanded item height
let containerObserver = null;
let itemObservers = new Map();

async function initTxtViewer() {
    try {
        const response = await fetch('../databases/sudedu_duomenu_baze.json');
        prefilteredTexts = await response.json();

        // Apply initial filtering
        refilterTexts();

        // Attach listeners with debouncing for search
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                applyFilters();
            }, 150); // 150ms debounce
        });

        document.getElementById('mainBrowserHeader').addEventListener('click', () => toggleMainBrowser(false));
        document.getElementById('allFiltersHeader').addEventListener('click', () => toggleAllFilters(false));

        // Dropdown change triggers re-filtering only
        document.getElementById('mode_choice_9').addEventListener('change', () => {
            enforceTaskTypeFilter(); // ADD THIS LINE
            refilterTexts();
            applyFilters();
        });

        // Handle switching between grammar (C83) and text comprehension (C49)
        document.getElementById('mode_choice_8').addEventListener('change', (e) => {
            if (e.target.value === 'C83') {
                // Switched to grammar - disable selection mode
                isSelectionModeEnabled = false;
                enforceTaskTypeFilter();
                refilterTexts();
                applyFilters();
            }
        });

        document.getElementById('mode_choice_15').addEventListener('change', (e) => {
            if (e.target.value === 'C82') {
                // Switched to random texts
                isSelectionModeEnabled = false;
            } else if (e.target.value === 'C84') {
                // Switched to selected texts
                isSelectionModeEnabled = true;
            }
            enforceTaskTypeFilter();
            refilterTexts();
            applyFilters();
        });

        // Handle switching between math and language
        document.getElementById('mode_choice').addEventListener('change', (e) => {
            if (e.target.value === 'math') {
                // Switched to math - disable selection mode
                isSelectionModeEnabled = false;
                enforceTaskTypeFilter();
                refilterTexts();
                applyFilters();
            }
        });

        // Setup scroll observer for lazy loading BEFORE applying filters
        setupLazyLoading();

        updateSelectionModeVisibility();
        applyFilters();

    } catch (err) {
        console.error('Error loading texts:', err);
        document.getElementById('textsList').innerHTML =
            '<div class="txt-viewer-no-results">Klaida įkeliant tekstus</div>';
    }
}

function enforceTaskTypeFilter() {
    const strukturaCheckbox = document.getElementById('task_struktura');
    const komponavimasCheckbox = document.getElementById('task_komponavimas');
    
    if (!isSelectionModeEnabled) {
        // Restore normal behavior - enable both and check both
        strukturaCheckbox.disabled = false;
        komponavimasCheckbox.disabled = false;
        strukturaCheckbox.checked = true;
        komponavimasCheckbox.checked = true;
        return;
    }

    // Get current task type from mode_choice_9
    const taskType = document.getElementById('mode_choice_9').value;
    
    // Force check the appropriate checkbox and disable the other
    if (taskType === 'C52') {
        // Strukturos isdestymas
        strukturaCheckbox.checked = true;
        komponavimasCheckbox.checked = false;
        strukturaCheckbox.disabled = false;
        komponavimasCheckbox.disabled = true;
    } else if (taskType === 'C51') {
        // Turinio komponavimas
        strukturaCheckbox.checked = false;
        komponavimasCheckbox.checked = true;
        strukturaCheckbox.disabled = true;
        komponavimasCheckbox.disabled = false;
    }
}

function refilterTexts() {
    const textArray = Object.entries(prefilteredTexts).map(([id, entry]) => ({ ...entry, id: parseInt(id) }));

    if (!textArray.length) return;

    if (isSelectionModeEnabled) {
        enforceTaskTypeFilter();
        const mode = document.getElementById('mode_choice_9').value;

        allTexts = textArray.filter(entry => {
            const s = entry["SF"];
            if (!s) return false;
            if (mode === 'C51') return s.C51;
            if (mode === 'C52') return s.C52;
            return false;
        });

    } else {
        allTexts = textArray.filter(entry => {
            const s = entry["SF"];
            return s && (s.C51 || s.C52);
        });
    }

    // Rebuild search cache when allTexts changes
    buildSearchCache();

    selectedIds = [];
    updateSelectionModeVisibility();
    updateSelectedIdsDisplay();
    applyFilters();
}

// Pre-build searchable text for each item
function buildSearchCache() {
    textSearchCache.clear();

    allTexts.forEach(text => {
        const searchableText = [
            text.id.toString(),
            text.title,
            text.author,
            ...(text.text.start || []),
            ...(text.text.middle || []),
            ...(text.text.end || []),
            ...(text.text.distractor || [])
        ].join(' ').toLowerCase();

        textSearchCache.set(text.id, searchableText);
    });
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    const isNumericSearch = /^\d+$/.test(searchTerm);

    const classFilters = {
        'C75': document.getElementById('class_1_2').checked,
        'C76': document.getElementById('class_3_4').checked
    };

    const taskTypes = {
        'C52': document.getElementById('task_struktura').checked,
        'C51': document.getElementById('task_komponavimas').checked
    };

    const difficulties = {
        'C58': document.getElementById('diff_lengvas').checked,
        'C59': document.getElementById('diff_vidutinis').checked,
        'C60': document.getElementById('diff_sunkus').checked
    };

    filteredTexts = allTexts.filter(text => {
        if (isNumericSearch) return text.id.toString() === searchTerm;

        const textClass = text['class'][0];
        if (!classFilters[textClass]) return false;

        const strukturaDiff = text['SF']['C52'];
        const komponavimasDiff = text['SF']['C51'];

        // Check if at least one selected task type matches with its difficulty
        let hasMatch = false;
        
        if (taskTypes['C52'] && strukturaDiff && difficulties[strukturaDiff]) {
            hasMatch = true;
        }
        
        if (taskTypes['C51'] && komponavimasDiff && difficulties[komponavimasDiff]) {
            hasMatch = true;
        }

        if (!hasMatch) return false;

        if (searchTerm) {
            const searchableText = textSearchCache.get(text.id);
            if (!searchableText || !searchableText.includes(searchTerm)) return false;
        }

        return true;
    });

    renderTexts(filteredTexts);
}

function setupLazyLoading() {
    const container = document.getElementById('textsList');
    
    // Intersection Observer for the container
    const observerOptions = {
        root: null,
        rootMargin: '200px', // Load items 200px before they enter viewport
        threshold: 0
    };

    containerObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const textId = parseInt(entry.target.dataset.textId);
                if (!renderedItems.has(textId)) {
                    renderItemContent(textId);
                }
            }
        });
    }, observerOptions);
}

function renderTexts(texts) {
    const container = document.getElementById('textsList');
    
    // Clean up old observers
    itemObservers.forEach(observer => observer.disconnect());
    itemObservers.clear();
    renderedItems.clear();

    if (texts.length === 0) {
        container.innerHTML = '<div class="txt-viewer-no-results">Tekstų nerasta</div>';
        return;
    }

    // Make sure observer exists
    if (!containerObserver) {
        setupLazyLoading();
    }

    // Create placeholder items with proper height
    const fragment = document.createDocumentFragment();
    
    texts.forEach(text => {
        const placeholder = document.createElement('div');
        placeholder.className = 'txt-viewer-text-item-placeholder';
        placeholder.dataset.textId = text.id;
        placeholder.style.minHeight = expandedTextIds.has(text.id) ? `${expandedItemHeight}px` : `${itemHeight}px`;
        
        fragment.appendChild(placeholder);
        
        // Observe this placeholder
        if (containerObserver) {
            containerObserver.observe(placeholder);
        }
    });

    container.innerHTML = '';
    container.appendChild(fragment);
}

function renderItemContent(textId) {
    const text = filteredTexts.find(t => t.id === textId);
    if (!text) return;

    // IMPORTANT: Only select placeholders within the textsList container
    const container = document.getElementById('textsList');
    if (!container) return;
    
    const placeholder = container.querySelector(`[data-text-id="${textId}"]`);
    if (!placeholder || !placeholder.classList.contains('txt-viewer-text-item-placeholder')) return;

    const isExpanded = expandedTextIds.has(text.id);
    const isSelected = selectedIds.includes(text.id);

    const itemHtml = `
        <div class="txt-viewer-text-item ${isExpanded ? 'text-item-expanded' : ''}" id="text-item-${text.id}">
            <div class="txt-viewer-text-item-header">
                ${isSelectionModeEnabled ? `
                    <input type="checkbox" class="txt-viewer-text-item-checkbox" data-text-id="${text.id}" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleTextSelection(${text.id}, this.checked)">
                ` : ''}
                <div class="txt-viewer-text-item-main" onclick="toggleTextExpand(${text.id})">
                    <div class="txt-viewer-text-item-info">
                        <div class="txt-viewer-text-item-id">ID: ${text.id}</div>
                        <div class="txt-viewer-text-item-title">${text.title}</div>
                    </div>
                    <div class="txt-viewer-text-item-expand-icon ${isExpanded ? 'txt-viewer-expanded' : ''}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
                    <path d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"/>
                    </svg>
                    </div>
                </div>
            </div>
            <div class="hide-scrollbar txt-viewer-text-item-details ${isExpanded ? 'txt-viewer-expanded scroll-indicators' : ''}" id="text-details-${text.id}">
                ${isExpanded ? renderTextDetails(text) : ''}
            </div>
        </div>
    `;

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = itemHtml;
    const newItem = tempDiv.firstElementChild;

    placeholder.replaceWith(newItem);
    renderedItems.add(textId);
}

function renderTextDetails(text) {
    // Map difficulty codes to display names
    const difficultyMap = {
        'C58': 'Lengvas',
        'C59': 'Vidutinis', 
        'C60': 'Sunkus'
    };

    // Classes - cache the replace operations
    const classMap = {
        'C75': '1-2 klasė',
        'C76': '3-4 klasė'
    };

    const lowerClasses = text["class"]
        .filter(cls => cls === 'C75')
        .map(cls => classMap[cls])
        .join(', ');

    const higherClasses = text["class"]
        .filter(cls => cls === 'C76')
        .map(cls => classMap[cls])
        .join(', ');

    // Determine which sections exist
    const startEmpty = !text.text.start || text.text.start.length === 0;
    const middleEmpty = !text.text.middle || text.text.middle.length === 0;
    const endEmpty = !text.text.end || text.text.end.length === 0;

    // Build sections
    let textSections = '';

    if (!startEmpty && !middleEmpty && !endEmpty) {
        textSections += `
        <div class="text-section">
            <div class="text-section-title">Pradžia</div>
            ${text.text.start.map(p => `<div class="text-section-paragraph">${p}</div>`).join('')}
        </div>
        <div class="text-section">
            <div class="text-section-title">Įvykio raida</div>
            ${text.text.middle.map(p => `<div class="text-section-paragraph">${p}</div>`).join('')}
        </div>
        <div class="text-section">
            <div class="text-section-title">Pabaiga</div>
            ${text.text.end.map(p => `<div class="text-section-paragraph">${p}</div>`).join('')}
        </div>`;
    } else {
        const combinedText = [
            ...(text.text.start || []),
            ...(text.text.middle || []),
            ...(text.text.end || [])
        ].filter(p => p && p.trim() !== '')
         .join(' ');

        if (combinedText) {
            textSections += `
            <div class="text-section">
                <div class="text-section-title">Tekstas</div>
                <div class="text-section-paragraph">${combinedText}</div>
            </div>`;
        }
    }

    const distractorSection = (text.text.distractor && text.text.distractor.length > 0)
        ? `<div class="text-section">
               <div class="text-section-title">Distraktorius</div>
               ${text.text.distractor.map(p => `<div class="text-section-paragraph">${p}</div>`).join('')}
           </div>`
        : '';

    return `
    <div class="text-detail-row">
        <div class="text-detail-content">
            ${lowerClasses ? `<span class="badge badge-class-lower">${lowerClasses}</span>` : ''}
            ${higherClasses ? `<span class="badge badge-class-higher">${higherClasses}</span>` : ''}

            ${text['SF']["C52"] ? `<span class="badge badge-struktura">Struktūros išdėstymas: ${difficultyMap[text['SF']["C52"]]}</span>` : ''}
            ${text['SF']["C51"] ? `<span class="badge badge-komponavimas">Turinio komponavimas: ${difficultyMap[text['SF']["C51"]]}</span>` : ''}
        </div>
    </div>

    <div class="text-detail-row">
        <div class="text-detail-content">
            ${textSections}
        </div>
    </div>

    ${distractorSection ? `
    <div class="text-detail-row">
        <div class="text-detail-content">
            ${distractorSection}
        </div>
    </div>` : ''}

    <div class="text-detail-row">
        <div class="text-detail-label">Autorius</div>
        <div class="text-detail-content">${text.author}</div>
    </div>
    `;
}

function toggleMainBrowser(closeMainBrowser=false) {
    const content = document.getElementById('mainBrowserContent');
    const icon = document.getElementById('mainBrowserIcon');
    const viewer = document.querySelector(".txt-viewer-container");
    isMainBrowserExpanded = !isMainBrowserExpanded;

    if (isMainBrowserExpanded && !closeMainBrowser) {
        viewer.style.height = `${parseFloat(getComputedStyle(document.querySelector('.left-side-bar')).height)}px`;
        
        content.style.display = 'block';
        content.style.height = 'auto';
        const height = content.offsetHeight;
        content.style.height = '0px';
        
        requestAnimationFrame(() => {
            content.classList.add('expanded');
            content.style.height = height + 'px';
            icon.classList.remove('collapsed');
        });
        
        content.addEventListener('transitionend', () => {
            if (isMainBrowserExpanded) {
                content.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }
        }, { once: true });
    } else {
        content.style.height = content.scrollHeight + 'px';
        icon.classList.add('collapsed');
        
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                content.classList.remove('expanded');
                content.style.height = '0px';
            });
        });
        
        content.addEventListener('transitionend', () => {
            if (!isMainBrowserExpanded) {
                content.style.display = 'none';
            }
        }, { once: true });
        
        viewer.style.height = '';

        isMainBrowserExpanded = false;
    }
}

function toggleAllFilters(closeFilters=false) {
    const content = document.getElementById('allFiltersContent');
    const icon = document.getElementById('allFiltersIcon');
    const mainBrowser = document.getElementById('mainBrowserContent');
    const isExpanding = content.classList.contains('txt-viewer-collapsed');
    
    if (closeFilters) {
        if (!content.classList.contains('txt-viewer-collapsed')) {
            content.classList.add('txt-viewer-collapsed');
            icon.classList.add('txt-viewer-collapsed');
        } 
    } else {
        content.classList.toggle('txt-viewer-collapsed');
        icon.classList.toggle('txt-viewer-collapsed');
    }
    
    if (isExpanding) {
        content.addEventListener('transitionend', () => {
            mainBrowser.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }, { once: true });
    }
}

function updateSelectionModeVisibility() {
    const container = document.getElementById('selectedIdsContainer');
    if (isSelectionModeEnabled) {
        container.classList.add('txt-viewer-visible');
        document.querySelector(".txt-viewer-selected-ids-container-outer").style.display = "block";
        updateSelectedIdsDisplay();
    } else {
        container.classList.remove('txt-viewer-visible');
        document.querySelector(".txt-viewer-selected-ids-container-outer").style.display = "none";
    }
}

function updateSelectedIdsDisplay() {
    const list = document.getElementById('selectedIdsList');
    list.innerHTML = selectedIds.map(id => `
        <div class="txt-viewer-selected-id-chip" onclick="scrollToText(${id})">
            <span>ID: ${id}</span>
        </div>
    `).join('');
}

function removeSelectedId(id) {
    selectedIds = selectedIds.filter(selectedId => selectedId !== id);
    const checkbox = document.querySelector(`input[data-text-id="${id}"]`);
    if (checkbox) checkbox.checked = false;
    updateSelectionModeVisibility();
}

function toggleTextSelection(id, checked) {
    if (checked) {
        if (!selectedIds.includes(id)) {
            selectedIds.push(id);
        }
    } else {
        selectedIds = selectedIds.filter(selectedId => selectedId !== id);
    }
    updateSelectionModeVisibility();
}

function scrollToText(id) {
    const text = allTexts.find(t => t.id === id);
    if (!text) return;

    const classValue = text['class'][0];
    
    if (classValue === 'C75') {
        document.getElementById('class_1_2').checked = true;
    } else if (classValue === 'C76') {
        document.getElementById('class_3_4').checked = true;
    }

    document.getElementById('task_struktura').checked = true;
    document.getElementById('task_komponavimas').checked = true;
    document.getElementById('diff_lengvas').checked = true;
    document.getElementById('diff_vidutinis').checked = true;
    document.getElementById('diff_sunkus').checked = true;
    document.getElementById('searchInput').value = '';

    applyFilters();

    setTimeout(() => {
        ensureItemRendered(id, () => {
            const element = document.getElementById(`text-item-${id}`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                if (!expandedTextIds.has(id)) {
                    toggleTextExpand(id);
                }

                element.style.boxShadow = '0 0 0 3px #1976d2';
                setTimeout(() => {
                    element.style.boxShadow = '';
                }, 2000);
            }
        });
    }, 100);
}

function ensureItemRendered(textId, callback) {
    if (renderedItems.has(textId)) {
        callback();
        return;
    }

    // Force render the item
    renderItemContent(textId);
    
    // Wait a bit for DOM update
    setTimeout(callback, 50);
}

function openTextBrowser(textId) {
    if (!isMainBrowserExpanded) {
        toggleMainBrowser();
    }

    setTimeout(() => {
        document.getElementById('searchInput').value = textId.toString();
        applyFilters();

        setTimeout(() => {
            ensureItemRendered(textId, () => {
                const element = document.getElementById(`text-item-${textId}`);
                if (element) {
                    if (!element.classList.contains("text-item-expanded")) {
                        setTimeout(() => {
                            if (!expandedTextIds.has(textId)) {
                                toggleTextExpand(textId);
                            }
                        }, 100);
                    } else {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        element.style.boxShadow = '0 0 0 3px #286D8A';
                        setTimeout(() => {
                            element.style.boxShadow = '';
                        }, 2000);
                    }
                } else {
                    messageToTheUser("Tekstas nerastas!");
                }
            });
        }, 100);
    }, 300);
}

function toggleTextExpand(id) {
    if (expandedTextIds.has(id)) {
        expandedTextIds.delete(id);
    } else {
        toggleAllFilters(true);
        expandedTextIds.add(id);

        setTimeout(() => {
            ensureItemRendered(id, () => {
                const element = document.getElementById(`text-item-${id}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    element.style.boxShadow = '0 0 0 3px #286D8A';
                    setTimeout(() => {
                        element.style.boxShadow = '';
                    }, 2000);
                }
            });
        }, 100);
    }

    applyFilters();
}

function lockYearInput(instance) {
    const yearInput = instance.calendarContainer?.querySelector('.cur-year');
    if (yearInput) {
        yearInput.readOnly = true;
        yearInput.style.pointerEvents = 'none';
        yearInput.style.caretColor = 'transparent';
    }
    instance.calendarContainer?.querySelector('.flatpickr-current-month')
        .classList.add('lt-date-month-year');
}

document.addEventListener("DOMContentLoaded", function () {

    function getTwoWeeksAgo() {
        const d = new Date();
        d.setDate(d.getDate() - 14);
        return d;
    }

    const defaultDate = getTwoWeeksAgo();

    flatpickr("#archiveStartDate", {
        locale: "lt",
        disableMobile: true,
        dateFormat: "Y-m-d",
        allowInput: false,
        clickOpens: true,
        defaultDate: defaultDate,

        onChange: function(selectedDates, dateStr, instance) {
            loadTaskArchive();
        },

        onReady: function(selectedDates, dateStr, instance) {
            lockYearInput(instance);

            const todayBtn = document.createElement("button");
            todayBtn.innerText = "Šiandien";
            todayBtn.type = "button";
            todayBtn.className = "lt-date-btn lt-date-btn-today";
            todayBtn.onclick = function() {
                instance.setDate(new Date(), true);
                instance.close();
            };

            const clearBtn = document.createElement("button");
            clearBtn.innerText = "Išvalyti";
            clearBtn.type = "button";
            clearBtn.className = "lt-date-btn lt-date-btn-clear";
            clearBtn.onclick = function() {
                instance.setDate(getTwoWeeksAgo(), true);
                instance.close();
            };

            const btnRow = document.createElement("div");
            btnRow.className = "lt-date-btn-row";
            btnRow.appendChild(todayBtn);
            btnRow.appendChild(clearBtn);
            instance.calendarContainer?.appendChild(btnRow);
        }
    });

    flatpickr("#archiveEndDate", {
        locale: "lt",
        disableMobile: true,
        dateFormat: "Y-m-d",
        allowInput: false,
        clickOpens: true,
        defaultDate: new Date().toISOString().split('T')[0],
        maxDate: new Date().toISOString().split('T')[0],

        onChange: function(selectedDates, dateStr, instance) {
            loadTaskArchive();
        },

        onReady: function(selectedDates, dateStr, instance) {
            lockYearInput(instance);

            const todayBtn = document.createElement("button");
            todayBtn.innerText = "Šiandien";
            todayBtn.type = "button";
            todayBtn.className = "lt-date-btn lt-date-btn-today";
            todayBtn.onclick = function() {
                instance.setDate(new Date().toISOString().split('T')[0], true);
                loadTaskArchive();
                instance.close();
            };

            const clearBtn = document.createElement("button");
            clearBtn.innerText = "Išvalyti";
            clearBtn.type = "button";
            clearBtn.className = "lt-date-btn lt-date-btn-clear";
            clearBtn.onclick = function() {
                instance.setDate(new Date().toISOString().split('T')[0], true);
                loadTaskArchive();
                instance.close();
            };

            const btnRow = document.createElement("div");
            btnRow.className = "lt-date-btn-row";
            btnRow.appendChild(todayBtn);
            btnRow.appendChild(clearBtn);
            if (instance.calendarContainer) instance.calendarContainer.appendChild(btnRow);
        }
    });

});

	</script>
</body>

</html>