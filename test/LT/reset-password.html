<!DOCTYPE html>
<html>
<head>
	<title>Slaptažodžio atkūrimas - sudEdu</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
	<link rel="icon" href="../images/favicon.ico" type="image/x-icon">
	<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
	<link rel="stylesheet" type="text/css" href="../index.css">
	<script src="../refresh-token.js"></script>

	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-96Q83PW8XY"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());
		gtag('config', 'G-96Q83PW8XY');
	</script>

	<style>
		* {
			-webkit-user-select: none;
			-webkit-tap-highlight-color: transparent;
			user-select: none;
			box-sizing: border-box;
		}

		html {
			display: flex;
			justify-content: center;
			align-items: center;
			background-image: linear-gradient(to top, #ffbf9c, #ffbf92, #ffbf89, #ffbf7e, #ffc074);
			width: 100vw;
			height: 100svh;
			overflow: hidden;
		}

		body {
			margin: 0;
			font-family: 'SFpro', sans-serif;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			width: 100%;
			height: 100%;
			overflow: hidden;
		}

		.container {
			position: relative;
			width: calc(100% - 32px);
			max-height: calc(100% - 32px);
			max-width: 480px;
			background: rgba(255, 255, 255, 0.08);
			backdrop-filter: blur(20px);
			border-radius: 25px;
			border: 1px solid rgba(255, 255, 255, 0.1);
			box-shadow: 0 8px 40px rgba(0, 0, 0, 0.1);
			padding: 40px;
			animation: fadeIn 0.5s ease-out;
			overflow-y: auto;
			text-align: center;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(-20px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.logo-container {
			text-align: center;
			margin-bottom: 15px;
		}

		.logo-container img {
			width: 300px;
			height: auto;
		}

		h2 {
			font-size: 2rem;
			font-weight: 700;
			color: #2c3e50;
			text-align: center;
			margin: 0 0 24px 0;
		}

		.spinner-container {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			padding: 20px 0;
		}

		.spinner {
			width: 48px;
			height: 48px;
			border: 4px solid rgba(64, 201, 169, 0.2);
			border-top-color: #40c9a9;
			border-radius: 50%;
			animation: spin 0.8s linear infinite;
		}

		@keyframes spin {
			to { transform: rotate(360deg); }
		}

		.spinner-text {
			margin-top: 16px;
			color: #2c3e50;
			font-size: 1rem;
		}

		.status-message {
			padding: 16px 20px;
			border-radius: 12px;
			font-size: 1rem;
			line-height: 1.5;
			margin: 20px 0;
			background: rgba(255, 255, 255, 0.5);
			color: #2c3e50;
			border: 1px solid rgba(255, 255, 255, 0.3);
		}

		.status-message.success {
			background: rgba(46, 204, 113, 0.15);
			color: #27ae60;
			border-color: rgba(46, 204, 113, 0.3);
		}

		.status-message.error {
			background: rgba(231, 76, 60, 0.15);
			color: #c0392b;
			border-color: rgba(231, 76, 60, 0.3);
		}

		.status-message.warning {
			background: rgba(243, 156, 18, 0.15);
			color: #d68910;
			border-color: rgba(243, 156, 18, 0.3);
		}

		.form-group {
			margin-bottom: 16px;
			position: relative;
		}

		input[type="text"],
		input[type="email"],
		input[type="password"] {
			width: 100%;
			padding: 14px 16px;
			font-size: 1rem;
			font-family: 'SFpro', sans-serif;
			background: rgba(255, 255, 255, 0.85);
			border: 1px solid rgba(255, 255, 255, 0.3);
			border-radius: 15px;
			transition: all 0.3s ease;
			color: #2c3e50;
		}

		input[type="text"]:focus,
		input[type="email"]:focus,
		input[type="password"]:focus {
			outline: none;
			background: rgba(255, 255, 255, 1);
			border-color: rgba(255, 255, 255, 1);
		}

		input::placeholder {
			color: #95a5a6;
		}

		.btn {
			width: 100%;
			padding: 14px 24px;
			font-size: 1.1rem;
			font-weight: 600;
			font-family: 'SFpro', sans-serif;
			border: none;
			border-radius: 25px;
			cursor: pointer;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			position: relative;
			overflow: hidden;
		}

		.btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
            border-radius: 20px;
            pointer-events: none;
            transition: background 0.3s ease;
        }

		.btn::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 20px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

		.btn-primary {
			background: linear-gradient(135deg, #40c9a9, #32ac93);
			color: white;
		}

		.btn-primary:not(:disabled):hover::before {
		background: rgba(255, 255, 255, 0.15);
		}

		.btn-primary:active:not(:disabled) {
			transform: translateY(0);
		}

		.btn-primary:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none;
		}

		.btn-secondary {
			background: rgba(255, 255, 255, 0.9);
			color: #2c3e50;
			border: 1px solid rgba(255, 255, 255, 0.3);
			margin-top: 16px;
		}

		.btn-secondary:hover {
			background: rgba(255, 255, 255, 1);
		}

		.btn-spinner {
			width: 16px;
			height: 16px;
			border: 2px solid rgba(255, 255, 255, 0.3);
			border-top-color: white;
			border-radius: 50%;
			animation: spin 0.6s linear infinite;
		}

		.reset-form,
		.resend-section {
			animation: slideIn 0.3s ease-out;
		}

		.password-toggle {
			position: absolute;
			right: 12px;
			top: 50%;
			transform: translateY(-50%);
			background: none;
			border: none;
			cursor: pointer;
			padding: 8px;
			color: #7f8c8d;
			transition: color 0.2s;
		}

		.password-toggle svg {
			width: 20px;
			height: 20px;
			display: block;
		}

		@keyframes slideIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@media (max-width: 767px) {
			.container {
				padding: 32px 24px;
			}

			h2 {
				font-size: 1.75rem;
			}

			.logo-container img {
				width: 250px;
			}
		}

		@media (max-width: 575px) {
			.container {
				padding: 20px 20px;
			}

			h2 {
				font-size: 1.5rem;
			}

			.logo-container img {
				width: 200px;
			}
		}

		@media (min-device-width: 768px) and (max-device-width: 1200px) and (orientation: portrait) {
			h2 {
				font-size: 2.5rem;
			}

			.logo-container img {
				width: 400px;
			}

			input {
				font-size: 1.5rem;
				padding: 18px 20px;
			}

			.btn {
				font-size: 1.5rem;
				padding: 18px 28px;
			}

			.status-message {
				font-size: 1.3rem;
			}

			.spinner {
				width: 64px;
				height: 64px;
			}

			.spinner-text {
				font-size: 1.3rem;
			}
		}
	</style>
</head>

<body>
	<div class="container hide-scrollbar">
		<div class="logo-container">
			<img src="../images/sudedu_logo.png" alt="sudEdu">
		</div>

		<h2>Slaptažodžio atkūrimas</h2>

		<!-- Loading State -->
		<div id="loadingSpinner" class="spinner-container">
			<div class="spinner"></div>
			<p class="spinner-text">Tikrinama nuoroda...</p>
		</div>

		<!-- Status Message -->
		<div id="statusText" class="status-message" style="display:none;"></div>

		<!-- Reset Form -->
		<div id="resetForm" class="reset-form" style="display:none;">
			<div class="form-group">
				<input type="password" id="newPassword" placeholder="Naujas slaptažodis (6-15 simbolių)" />
				<button type="button" class="password-toggle" onclick="togglePasswordVisibility('newPassword')">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
							<path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"></path>
							<path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"></path>
						</svg>
					</button>
			</div>
			<div class="form-group">
				<input type="password" id="confirmPassword" placeholder="Pakartokite slaptažodį" />
				<button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirmPassword')">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
							<path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"></path>
							<path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"></path>
						</svg>
					</button>
			</div>
			<button class="btn btn-primary" id="resetBtn" onclick="resetPassword()">
				<span id="resetBtnText">Pakeisti slaptažodį</span>
				<div id="resetBtnSpinner" class="btn-spinner" style="display:none;"></div>
			</button>
		</div>

		<!-- Resend Section -->
		<div id="resendSection" class="resend-section" style="display:none;">
			<div class="form-group">
				<input type="email" id="emailInput" placeholder="Įveskite el. paštą" />
			</div>
			<button class="btn btn-primary" id="resendBtn" onclick="resendReset()">
				<span id="resendBtnText">Siųsti naują nuorodą</span>
				<div id="resendBtnSpinner" class="btn-spinner" style="display:none;"></div>
			</button>
		</div>

		<!-- Back Button -->
		<button class="btn btn-secondary" id="backBtn" style="display:none;" onclick="window.location.href='./prisijungimas.html'">
			Eiti į prisijungimą
		</button>
	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="../mental-arithmetic.js"></script>
	<script src="../mental-arithmetic-combinations.js"></script>

	<script>
		const MESSAGES = {
			'RESET_001': 'Slaptažodžio atkūrimo nuoroda išsiųsta el. paštu (galioja 15 minučių).',
			'RESET_002': 'Vartotojas su tokiu el. paštu nerastas.',
			'RESET_003': 'Slaptažodis sėkmingai pakeistas! Galite prisijungti.',
			'RESET_004': 'Atkūrimo nuoroda nebegalioja arba neteisinga.',
			'RESET_005': 'Nuoroda galioja. Įveskite naują slaptažodį:',
			'ERR_001': 'Serverio klaida. Bandykite vėliau.',
			'ERR_002': 'Trūksta duomenų.'
		};

		function getMsg(code) {
			return MESSAGES[code] || 'Nežinoma klaida';
		}

		const params = new URLSearchParams(window.location.search);
		const token = params.get('token');

		const loadingSpinner = document.getElementById('loadingSpinner');
		const statusText = document.getElementById('statusText');
		const resetForm = document.getElementById('resetForm');
		const backBtn = document.getElementById('backBtn');
		const resendSection = document.getElementById('resendSection');

		function showStatus(message, type = 'info') {
			statusText.textContent = message;
			statusText.className = 'status-message';
			if (type === 'success') statusText.classList.add('success');
			if (type === 'error') statusText.classList.add('error');
			if (type === 'warning') statusText.classList.add('warning');
			statusText.style.display = 'block';
		}

		async function checkToken() {
			if (!token) {
				loadingSpinner.style.display = 'none';
				showStatus(getMsg('ERR_002'), 'error');
				backBtn.style.display = 'block';
				return;
			}

			try {
				const res = await fetch(apiBase + 'auth/validate-reset?token=' + encodeURIComponent(token));
				const data = await res.json();

				loadingSpinner.style.display = 'none';

				if (data.code === 'RESET_005') {
					showStatus(getMsg(data.code), 'success');
					resetForm.style.display = 'block';
				} else if (data.code === 'RESET_004') {
					showStatus(getMsg(data.code), 'warning');
					resendSection.style.display = 'block';
					backBtn.style.display = 'block';
				} else {
					showStatus(getMsg(data.code), 'error');
					backBtn.style.display = 'block';
				}
			} catch (err) {
				loadingSpinner.style.display = 'none';
				showStatus(getMsg('ERR_001'), 'error');
				backBtn.style.display = 'block';
			}
		}

		async function resetPassword() {
			const newPass = document.getElementById('newPassword').value.trim();
			const confirmPass = document.getElementById('confirmPassword').value.trim();
			const resetBtn = document.getElementById('resetBtn');
			const resetBtnText = document.getElementById('resetBtnText');
			const resetBtnSpinner = document.getElementById('resetBtnSpinner');

			if (newPass.length < 6 || newPass.length > 15) {
				showStatus('Slaptažodis turi būti 6–15 simbolių ilgio.', 'error');
				return;
			}
			if (newPass !== confirmPass) {
				showStatus('Slaptažodžiai nesutampa.', 'error');
				return;
			}

			resetBtn.disabled = true;
			resetBtnText.textContent = 'Saugoma...';
			resetBtnSpinner.style.display = 'block';
			showStatus('Keičiamas slaptažodis...', 'info');

			try {
				const res = await fetch(apiBase + 'auth/reset-password', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ token, newPassword: newPass })
				});
				const data = await res.json();

				if (data.code === 'RESET_003') {
					showStatus(getMsg(data.code), 'success');
					resetForm.style.display = 'none';
					backBtn.style.display = 'block';
				} else if (data.code === 'RESET_004') {
					showStatus(getMsg(data.code), 'warning');
					resetForm.style.display = 'none';
					resendSection.style.display = 'block';
					backBtn.style.display = 'block';
				} else {
					showStatus(getMsg(data.code), 'error');
					resetBtn.disabled = false;
					resetBtnText.textContent = 'Atkurti slaptažodį';
					resetBtnSpinner.style.display = 'none';
				}
			} catch (err) {
				showStatus(getMsg('ERR_001'), 'error');
				resetBtn.disabled = false;
				resetBtnText.textContent = 'Atkurti slaptažodį';
				resetBtnSpinner.style.display = 'none';
			}
		}

		async function resendReset() {
			const emailVal = document.getElementById('emailInput').value.trim();
			const resendBtn = document.getElementById('resendBtn');
			const resendBtnText = document.getElementById('resendBtnText');
			const resendBtnSpinner = document.getElementById('resendBtnSpinner');

			if (!emailVal || !emailVal.includes('@')) {
				showStatus('Įveskite galiojantį el. paštą', 'error');
				return;
			}

			resendBtn.disabled = true;
			resendBtnText.textContent = 'Siunčiama...';
			resendBtnSpinner.style.display = 'block';
			showStatus('Siunčiama atkūrimo nuoroda...', 'info');

			try {
				const response = await fetch(apiBase + 'auth/forgot-password', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ username: emailVal })
				});
				const data = await response.json();
				
				if (data.code === 'RESET_001') {
					showStatus(getMsg(data.code), 'success');
					resendSection.style.display = 'none';
					backBtn.style.display = 'block';
				} else {
					showStatus(getMsg(data.code), 'error');
					resendBtn.disabled = false;
					resendBtnText.textContent = 'Siųsti naują nuorodą';
					resendBtnSpinner.style.display = 'none';
				}
			} catch (err) {
				showStatus('Nepavyko išsiųsti atkūrimo laiško.', 'error');
				resendBtn.disabled = false;
				resendBtnText.textContent = 'Siųsti naują nuorodą';
				resendBtnSpinner.style.display = 'none';
			}
		}

		function togglePasswordVisibility(elementId) {
			const input = document.getElementById(elementId);
			input.type = input.type === 'password' ? 'text' : 'password';
		}

		// Handle Enter key
		document.addEventListener('keydown', function(event) {
			if (event.key === 'Enter') {
				if (resetForm.style.display !== 'none') {
					resetPassword();
				} else if (resendSection.style.display !== 'none') {
					resendReset();
				}
			}
		});

		// Auto-check token on page load
		checkToken();
	</script>
</body>
</html>