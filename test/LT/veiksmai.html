<!DOCTYPE html>
<html>

<head>
	<title>sudedu - matematika</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
	<link rel="icon" href="../images/favicon.ico" type="image/x-icon">
	<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="stylesheet"
		href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
	<link href="https://fonts.googleapis.com/css2?family=Andika:wght@400;700&family=Josefin+Sans&display=swap"
		rel="stylesheet">
	<link rel="stylesheet" href="../main-nav-bar.css">
    <link rel="stylesheet" type="text/css" href="../index.css">
	<link id="questionsStyleSheet" rel="stylesheet" type="text/css" href="../questions-bigger.css">
	<link id="dynamicStyleSheet" rel="stylesheet" type="text/css" href="">
	<link rel="stylesheet" type="text/css" href="../summary.css">
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-96Q83PW8XY"></script>
<script>
  //window.dataLayer = window.dataLayer || [];
  //function gtag(){dataLayer.push(arguments);}
  //gtag('js', new Date());

  //gtag('config', 'G-96Q83PW8XY');
</script>
<script src="../refresh-token.js"></script>
<style>
	 * {
          -webkit-user-select: none;
          -webkit-tap-highlight-color: transparent;
          user-select: none;
          box-sizing: border-box;
          -webkit-user-drag: none;
          user-drag: none;
        }

      	html {
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: linear-gradient(to top, #ffbf9c, #ffbf92, #ffbf89, #ffbf7e, #ffc074);
            width: 100vw;
            height: 100svh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        body {
            margin: 0;
            font-family: 'SFpro', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

		textarea {
			font-family: 'SFpro', sans-serif;
			color: #212529;
		}

		.container {
			flex: 1;
			max-height: calc(100% - 80px - 16px - 16px);
			min-height: calc(100% - 80px - 16px - 16px);
			width: calc(100% - (2 * 16px));
			display: flex;
			justify-content: start;
			background: rgba(255, 255, 255, 0.08);
			margin: 16px;
			border-radius: 20px;
			border: 1px solid rgba(255, 255, 255, 0.1);
			flex-direction: column;
			padding: 20px;
			transition: min-height 0.3s ease, max-height 0.3s ease;
			box-shadow: 0 8px 40px rgba(0, 0, 0, 0.1);
		}

		.container.keyboard-open {
			max-height: 100%;
			min-height: 100%;
		}

		.trackers-row {
          display: flex;
          flex-wrap: wrap;
		  justify-content: space-between;
        }

		.tracker-timer-holder {
          padding: 0 15px;
          margin-bottom: 10px;
        }

		.timer-holder {
			display: flex;
			justify-content: center;
		}

        #mistake-tracker,
        #answer-tracker,
        #timer {
          margin: 0;
          font-weight: 600;
          font-size: 1.25rem
        }

        #answer-tracker {
          margin-bottom: 5px;
        }

        .trackers-holder,
        .timer-holder {
          align-items: center;
        }

		.middle-and-upper-lines-holder {
			display: flex;
			flex-direction: column;
			flex: 1 1 auto;
			min-height: 0;
			align-items: center;
		}

		.upper-line {
			display: flex;
			position: absolute;
			min-height: 98.5px;
			top: 0;
			justify-content: center;
			align-items: center;
			border-top-left-radius: 20px;
			border-top-right-radius: 20px;
			padding: 0 20px;
			margin-bottom: 15px;
			width: 100%;
		}

		#equation-and-symbol,
		#equation {
			max-height: 100%;
		}

		#mistakes-summary-math,
		.summary-table-frequent-mistakes-outer-div {
			height: 100%;
		}

		#summary-table-outer-div {
			height: 100%;
			display: flex;
			justify-content: center;
			align-items: center;
		}

		.table-container {
			display: flex;
			height: 80%;
		}

		#summary-table-frequent-mistakes table {
			border-radius: 20px;
		}

		#frequent-mistakes-container {
			min-width: 400px;
  			min-height: 90px;
		}


		.stop-reset-button-outer-div {
			padding-top: 15px;
			flex-shrink: 0;
			display: flex;
			justify-content: space-between;
		}

		#middle-line {
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			flex: 1;
			min-height: 0;
			backdrop-filter: blur(15px);
			-webkit-backdrop-filter: blur(15px);
			background: rgba(255, 255, 255, 0.15);
			border-radius: 20px;
			width: 100%;
		}

		#middle-line-inner {
			width: 100%;
			height: 100%;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
		}

		#content-container {
			display: flex;
		}

		textarea,
		#answer {
			border-radius: 20px;
			background: rgba(255, 255, 255, 0.6);
			border: 1px solid rgba(255, 255, 255, 0.2);
			text-align: center;
			cursor: pointer;
		}

		textarea:focus,
		textarea:active,
		#answer:focus,
		#answer:active {
			border: 1px solid rgba(255, 255, 255, 1);
			background: rgba(255, 255, 255, 0.8);
			outline: none;
		}

		.equation {
			text-align: center;
			justify-content: center;
    		align-items: center;
		}

		textarea {
			resize: none;          /* disable manual resize */
			overflow-x: auto;      /* allow horizontal scroll */
			overflow-y: hidden;    /* hide vertical scroll */
			white-space: nowrap;   /* prevent wrapping to next line */
			line-height: var(--input-size-full);
			padding-top: 0;   
			padding-bottom: 0;
			scrollbar-width: none;    /* Firefox */                 
		}

		#answer-field {
			display: flex;
			justify-content: center;
			align-items: center;
		}

		.question-submit-button,
        #stopButton,
		.summary-button {
            position: relative;
            background: linear-gradient(135deg, #3288AC, #286D8A);
            border: none;
            /* border: 1px solid #286D8A; */
            color: #F5F5F7;
            display: flex;
            align-items: center;
            padding: 12px 18px 12px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            letter-spacing: 0.01em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0;
            justify-content: center;
            min-width: 10vw;
        }

		.summary-button {
			margin-top: 15px;
		}

        #stopButton {
          width: 6vw;
          min-width: 75px;
          height: 42.5px;
          border-radius: 100px;
          font-size: 2rem;
        }

		.question-submit-button::before,
        #stopButton::before,
		.summary-button::before  {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
            border-radius: 20px;
            pointer-events: none;
            transition: background 0.3s ease;
        }

		.question-submit-button::after,
        #stopButton::after,
		.summary-button::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 20px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

		.question-submit-button:hover::before,
        #stopButton:hover::before,
		.summary-button:hover::before {
            background: rgba(255, 255, 255, 0.15);
        }

		.material-symbols-rounded {
			font-size: 2rem;
			font-weight: 300;
		}

		.previous-equation {
			margin: 0;
			padding: 10px 0;
			width: 100%;
			height: 100%;
			display: flex;
			align-items: center;   /* vertical center */
			justify-content: center; /* horizontal center */
			overflow: hidden;
			white-space: nowrap;
			text-align: center; /* optional — redundant with justify-content */
		}

	.stop-reset-button-div {
		padding: 0;
	}
	#frequent-mistakes-container {
		width: 60%;
	}

	.stulpeliu-field {
		position: relative;
	}
	
	#hidden-input {
		position: absolute; 
		left: -9999px;
	}

	@media (max-width: 1400px) {
		#frequent-mistakes-container {
			width: 60%;
		}
	}

	@media (max-width: 1200px) {
		#frequent-mistakes-container {
			width: 75%;
		}
	}

	@media (max-width: 1150px) {
        .question-submit-button,
		.summary-button {
          min-width: 15vw;
        }
	}

	@media (max-width: 992px) {
		#frequent-mistakes-container {
			width: 95%;
			min-width: 300px;
			min-height: 80px;
		}
	}

	@media (max-width: 767px) {
		.container {
			width: 100%;
			max-height: calc(100% - 80px);
			min-height: calc(100% - 80px);
			margin: 0;
			background: transparent;
			border: none;
			border-radius: 0;
			padding: 15px;
		}

		.question-submit-button,
		.summary-button {
          min-width: 25vw;
        }
	}

		@media (max-width: 576px) {
			.table-container {
				height: 90%;
			}
		}

	@media (min-device-width: 768px) and (max-device-width: 1200px) and (orientation: portrait)  {
		.stop-button {
			height: 6rem;
			width: 6rem;
		}

		.reset-button {
			height: 6rem;
			width: 6rem;	
		}

		.material-symbols-rounded {
			font-size: 3.15rem;
		}

		#stopButton {
			min-width: 100px;
			height: 54.5px;
		}

		.summary-button {
			font-size: 1.5rem;
		}

		.question-submit-button,
		.summary-button {
			font-size: 1.65rem;
		}

		h3 {
			font-size: 2rem;
		}

		#next-question-btn {
			font-size: 1.25rem;
			min-width: 25vw;
		}
		
		.container {
    		padding: 35px;
			max-height: calc(100% - 100px);
			min-height: calc(100% - 100px);
			width: 100%;
			margin: 0;
			background: transparent;
			border: none;
			box-shadow: none;
		}

		#mistake-tracker, #answer-tracker, #timer {
			font-size: 1.75rem;
		}
	}
	
</style>	

<body>
	<div id="customConfirmModal" class="modal">
    <div class="modal-content">
        <p id="customModalText"></p>
        <div class="modal-buttons">
        <button id="customConfirmYes" class="btn-confirm">Taip</button>
        <button id="customConfirmNo" class="btn-cancel">Ne</button>
        </div>
    </div>
    </div>

	<div id="object-popup" class="object-popup-overlay" style="display:none;">
    <div class="object-popup-panel">
        <button class="object-popup-close">&times;</button>
        <div class="title-subtitle-inline-button-wrapper">
        <div class="object-popup-title-subtitle-wrapper">
        <div class="object-popup-title" id="object-popup-title"></div>
        <div class="object-popup-subtitle" id="object-popup-subtitle"></div>
        </div>
        </div>
        <div class="object-popup-content" id="object-popup-content">
        <!-- Dynamic content goes here -->
        </div>
    </div>
    </div>

    <nav class="main-navbar" id="mainNavbar">
      <div class="main-nav-container">
          <!-- Logo -->
          <a href="#" class="main-nav-logo">
              <div class="main-nav-logo-icon">
                <img id="sudedu-main-nav-bar-logo" src="../images/sudedu_logo.png" alt="sudEdu">
              </div>
          </a>

			<div class="main-nav-links invisible">
				<a class="main-nav-back-btn" id="desktopBackBtn">
					<span class="main-nav-back-icon">←</span>
					<div class="main-nav-back-text">
						<span class="main-nav-back-label">Grįžti</span>
						<span class="main-nav-back-title">Atgal</span>
					</div>
				</a>
			</div>

			<!-- Mobile Navigation -->
			<div class="main-nav-mobile-btn simplified">
				<a class="main-nav-back-btn" id="mobileBackBtn">
					<span class="main-nav-back-icon">←</span>
					<div class="main-nav-back-text">
						<span class="main-nav-back-label">Grįžti</span>
						<span class="main-nav-back-title">Atgal</span>
					</div>
				</a>
			</div>
      </div>
  </nav>

	<div class="container content" id="template-container" style="" hidden>
		 <div class="tracker-timer-holder">
		<div class="trackers-row">
			<div class="trackers-holder">
				<div class="trackers">
					<div>
						<h3 id="answer-tracker"></h3>
					</div>
					<div>
						<h3 id="mistake-tracker"></h3>
					</div>
				</div>
		</div>
		<div class="timer-holder">
			<div id="timer"></div>
		</div>
		</div>
		</div>

		<div class="middle-and-upper-lines-holder">
			<div id='middle-line' class="middle-line" style="position: relative;">
				<textarea id="hidden-input" autocomplete="off" inputmode="numeric"></textarea>
				<div id="fireworks-div" class="image-containerfireworks-div"></div>
				<div class="upper-line">
					<p class="previous-equation"></p>
				</div>
				<div class="" id="invisibleRow" style="display: none; height: 0;"></div>
				<div class="" id="middle-line-inner" class="">
					<div id='content-container' class="equation-and-answer">
						<div id="equation-and-symbol">
							<div id="arithmetic-symbol"></div>
							<label id="equation" class="equation text-nowrap" for="answer-field"></label>
						</div>
						<div id="stulpeliu-div-outer">
							<div id="stulpeliu-div-inner">
							<div id="stulpeliu-div" class=""></div>

							<div class="answer-field-div">
								<div id="stulp-div-ans-and-first" class="">
								<div id="division-stulp-2">
									<div id="division-stulp-2-outer">
									<div id="division-stulp-2-inner"></div>
									</div>
								</div>
								<div id="answer-field-outer">
								<div id="answer-field" class="answer-field">
									<textarea type="text" id="answer" name="answer" class="form-control text-center answer-input"
										placeholder="" autofocus autocomplete="off" style="display: none;"></textarea>
								</div>
								</div>
							</div>

								<div id="remainder-field" class="remainder-field">
									<textarea type="text" id="remainder" name="remainder" class="form-control text-center remainder-input"
										placeholder="liek." autocomplete="off"></textarea>
								</div>


							</div>
						
							<label class="equation_2 text-nowrap" for="answer-field" style="display: none;"></label>

							<div id="division-stulp-3">
								<div id="division-stulp-3-outer">
								<div id="division-stulp-3-inner"></div>
								</div>
							</div>
							</div>
						</div>
					</div>
					<div id="restart-reset-button-row" class="" style="display: none;">
						<div class="submit-button-div">
							<div id="reset-mistake-buttons" class="">
								<div class="">
									<div class="summary-div">
										<button class="summary-button">Klaidos</button>
									</div>

								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="stop-reset-button-outer-div">



      <div class="stop-restart-button-row" id="stop-restart-button-row">
      <div class="stop-reset-button-div">
        <div class="">
          <div class="stop-button-div">
            <button id="stopButton" class="stop-button"><span id="stop-button-span" class="material-symbols-rounded">close</span></button>
          </div>
        </div>
      </div>
    </div>

    <div class="check-ans-button-holder">
				<div id="submit-button-row" class="row" style="display: none;">
					<div class="submit-button-div">
						<div class="d-flex justify-content-start align-items-center">
							<button class="question-submit-button">Tikrinti</button>
						</div>
					</div>
				</div>
  </div>





		</div>
	</div>
	<script src="../main-nav-bar.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/mobile-detect@1.4.6/dist/mobile-detect.min.js"></script>
	<script src="../mental-arithmetic.js"></script>
	<script src="../mental-arithmetic-combinations.js"></script>

	<script>
		let firstTimeChecking = true;

		const mistakesButtonElement = document.querySelector('.summary-button');
		mistakesButtonElement.addEventListener("click", () => {
			localStorage.setItem("elapsedTime", timerDisplay.textContent);
		})
		mistakesButtonElement.addEventListener("click", displaylatestMistakes);

		function displaylatestMistakes() {
			document.querySelector(".equation").style.display = "flex";
			document.querySelector(".equation").style.height = "100%";
			document.querySelector("#equation-and-symbol").style.height = "100%";
			document.querySelector(".equation").innerHTML = `
				<div id="frequent-mistakes-container" style="flex-direction: column; justify-content: space-between;">
                    <div id="mistakes-summary-math">
                    <div class="summary-table-frequent-mistakes-outer-div">
                        <div id="summary-table-outer-div" class="">
                            <div class="table-container" id="table-container-math">
                                <div id="summary-table-frequent-mistakes"></div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
			`
			generateSummaryTable('current', null, "summary-table-frequent-mistakes", null);
			document.querySelector("#restart-reset-button-row").style.display = "none";
			if (
				document.querySelector("#summary-table-frequent-mistakes") &&
				document.querySelector("#summary-table-frequent-mistakes").innerHTML === "Klaidų nėra!"
			) {
				document.getElementById('middle-line-inner').style.height = "auto";
				document.querySelector(".table-container").style.justifyContent = "center";
			} else {
				document.getElementById('middle-line-inner').style.height = "100%";
				document.querySelector(".table-container").style.justifyContent = "start";
			}
			
		}

		const resetMistakeButtonsElement = document.querySelector('#restart-reset-button-row');
		const stopButtonElement = document.querySelector('.stop-button');
		stopButtonElement.addEventListener("click", stopEquations)

		const linkElement = document.querySelector("#questionsStyleSheet");
		const dynamicStyleSheet = document.querySelector("#dynamicStyleSheet");

		const equationElement = document.querySelector(".equation");
		const equation2Element = document.querySelector(".equation_2");

		const answerFieldDivElement = document.querySelector(".answer-field-div");

		function stylePage () {
			if (controller.questionsStopped) {
				linkElement.setAttribute("href", "../questions-stopped.css");
			} else if (controller.modeChoice7 === "C48" && controller.randomSelection[2] !== 'D') {
				linkElement.setAttribute("href", "../questions-stulpeliu.css");
			} else if (controller.modeChoice7 === "C48" && controller.randomSelection[2] === 'D' && controller.modeChoice8 === "C78") {
				linkElement.setAttribute("href", "../questions-stulpeliu-div-us.css");
			} else if (controller.modeChoice7 === "C48" && controller.randomSelection[2] === 'D' && controller.modeChoice8 === "C79") {
				linkElement.setAttribute("href", "../questions-stulpeliu-div.css");
			} else if (controller.modeChoice7 === "C48") {
				linkElement.setAttribute("href", "../questions-stulpeliu.css");
			} else if (controller.withRemainder) {
							linkElement.setAttribute("href", "../questions-remainder.css");
					} else {
					if (controller.modeChoice2 === "C15" ||
							controller.modeChoice2 === "C36"
						)	{
							linkElement.setAttribute("href", "../questions-extra-small.css");
					} else if (controller.modeChoice2 === "C13" || 
							controller.modeChoice2 === "C14" || 
							controller.modeChoice2 === "C34" || 
							controller.modeChoice2 === "C35" || 
							controller.modeChoice2 === "C28" || 
							controller.modeChoice2 === "C77" ||
							controller.modeChoice2 === "C29" ||
							controller.modeChoice2 === "C20" ||
							controller.modeChoice2 === "C21" ||
							controller.modeChoice2 === "C23" ||
							controller.modeChoice2 === "C24" ||
							controller.modeChoice2 === "C25" ||
							controller.modeChoice2 === "C26" ||
							controller.modeChoice2 === "C27" ||
							controller.modeChoice2 === "C16"
						) {
							linkElement.setAttribute("href", "../questions-smaller.css");
					} else {
						linkElement.setAttribute("href", "../questions-bigger.css");
					}
			}

			if (controller.modeChoice5 === "C42") {
				dynamicStyleSheet.setAttribute("href", "../questions-unknown-number-style-supplement.css");
			} else {
				dynamicStyleSheet.setAttribute("href", "");
			}
		}

		window.onload = function () {
			if (!localStorage.getItem('controller')) {
				window.location.href = "./";
			} else {
				controller = JSON.parse(localStorage.getItem('controller')) 
				if (controller.mode !== "math" || controller.language !== "LT") {
					window.location.href = "./";
				}
			}

			document.querySelector('#template-container').removeAttribute('hidden');
			controller = JSON.parse(localStorage.getItem('controller'));
			
			if (!controller.questionsStopped) {
				if (controller.modeChoice4 === "C39") {
					countDown();
				} else if (controller.modeChoice4 === "C40") {
					startTimer();
				}
			}
			
			formEquation();
			displayEquation();
			
			if (!controller.questionsStopped) {
				answerInputElement.style.display = "flex";
				questionsSubmitButtonRowElement.style.display = "flex";
			} else {
				resetMistakeButtonsElement.style.display = "flex";
				document.querySelector('.answer-field-div').style.display = "none";
				const stopButtonSpanElement = document.querySelector('#stop-button-span');
				stopButtonSpanElement.innerHTML = "refresh";
				timerDisplay.textContent = localStorage.getItem("elapsedTime");
		}
	};

let answerInputElement = document.querySelector('#answer');
		answerInputElement.setAttribute("inputmode", "numeric");

let answerRemainderInputElement = document.querySelector('#remainder');
		answerRemainderInputElement.setAttribute("inputmode", "numeric");

		// Sanitize input field value on input event
		answerInputElement.addEventListener("input", function (event) {
			const sanitizedValue = event.target.value.replace(/[^0-9]/g, '');
			event.target.value = sanitizedValue;
		});

		answerRemainderInputElement.addEventListener("input", function (event) {
			const sanitizedValue = event.target.value.replace(/[^0-9]/g, '');
			event.target.value = sanitizedValue;
		});

		// Add event listener to checkAnswer function with condition
		let questionsSubmitButtonElement = document.querySelector('.question-submit-button')
		let questionsSubmitButtonRowElement = document.querySelector('#submit-button-row')
		questionsSubmitButtonElement.addEventListener("click", function () {
			if (answerInputElement.value.trim() !== "") {
				checkAnswer();
				clearAnswerField();
			}
			if (answerRemainderInputElement.value.trim() !== "") {
				checkAnswer();
				clearAnswerField();
			}
		});

		// Handle "Enter" key press with condition
		answerInputElement.addEventListener("keydown", function (event) {
			if (event.key === "Enter") {
				if (answerInputElement.value.trim() !== "") {
					checkAnswer();
					clearAnswerField();
				}
			}
		});
		answerRemainderInputElement.addEventListener("keydown", function (event) {
			if (event.key === "Enter") {
				if (answerRemainderInputElement.value.trim() !== "") {
					checkAnswer();
					clearAnswerField();
				}
			}
		});

		function clearAnswerField() {
			if (!isStulpeliu()) {
				answerInputElement.value = '';
				answerRemainderInputElement.value = '';
			} else if (isStulpeliu() && controller.result[0] === 'Correct') {
				answerInputElement.value = '';
				answerRemainderInputElement.value = '';
			}
		}

		function isStulpeliu() {
			if (controller.modeChoice7 === "C48") {
				return true;
			} else {
				return false;
			}
		}

	const answerTextarea = document.getElementById('answer');
	const equationsAndSymbolContainer = document.getElementById('equation-and-symbol');
	const outer = document.getElementById('stulpeliu-div-outer');

	if (answerTextarea && equationsAndSymbolContainer && outer) {
	const checkOverflow = el => el.scrollWidth > el.clientWidth || el.scrollHeight > el.clientHeight;

	answerTextarea.addEventListener('focus', () => {
		if (controller.modeChoice7 === "C48" && controller.randomSelection[2] === 'M') {
		// small delay to let mobile keyboard open
		setTimeout(() => {
			if (checkOverflow(outer)) {
			equationsAndSymbolContainer.classList.add('collapsed');
			}
		}, 150); // 150ms delay
		}
	});

	answerTextarea.addEventListener('blur', () => {
		if (controller.modeChoice7 === "C48" && controller.randomSelection[2] === 'M') {
		equationsAndSymbolContainer.classList.remove('collapsed');
		}
	});
	}

	// Function to set the margin of element2
	function setMargins() {

		if (controller.questionsStopped) {
			return
		}

		if (controller.modeChoice7 === "C48") {

			const fontSIzeFull = 3;
			const oneRem = 16;
			const inputPadding = 20;
			var digitNumber = controller.randomSelection[1].toString();

			var element1 = document.getElementById('equation');
			var element2 = document.getElementById('answer-field');
			const element2Textarea = element2.querySelector("textarea");
			var element3 = document.querySelector('#stulpeliu-0');
			var element1Rect = element1.getBoundingClientRect();
			var computedStyle = window.getComputedStyle(element1);
			var paddingRight = parseFloat(computedStyle.paddingRight);
			var viewportWidth = window.innerWidth;
			var rightMargin = viewportWidth - (element1Rect.right + paddingRight);
			var computedStyle3;
			var leftMargin3;
			var equationElement = document.getElementById('equation');
			var equationElementWidth = equationElement.offsetWidth;
			var stulpeliuInput = document.getElementsByClassName('stulpeliu-input');
			var newWidth = 0;
			var firstElementRight = 0;
			var lastElementLeft = 0;
			var firstElmenetMarginRight = 0;
			var contentContainerElement = document.getElementById('content-container');
			var newMargin = 0
			var answerDigits = 0;

		if (controller.randomSelection[2] === 'M') {
			const daugiklisLength = document.querySelector(".daugiklis").innerHTML.length;
			const antrasDaugiklisLength = document.querySelector("#antras-daugiklis").innerHTML.length;
			const newWidth = daugiklisLength + 2;
			for (var i = 0; i < stulpeliuInput.length; i++) {
				var stulpeliuInputElement = stulpeliuInput[i];
				stulpeliuInputElement.style.width = `${newWidth}ch`;
			}

			element2Textarea.style.width = `${newWidth+1+antrasDaugiklisLength-2}ch`;
			
		} else if (controller.randomSelection[2] === 'D') {
			const answerInput = document.querySelector("#answer")
			const dalinys = document.querySelector("#dalinys")
			const daliklis = document.querySelector("#daliklis")

			if (controller.modeChoice8 === "C78") {
				const daliklisValue = daliklis.innerHTML
				const daliklisDigits = daliklisValue.length;
				const dalinysLength = dalinys.innerHTML.length;
				if (dalinysLength > daliklisDigits) {
					const dalinysStart = dalinys.innerHTML.slice(0, daliklisDigits);
					if (Number(dalinysStart) >= Number(daliklisValue)) {
						answerInput.style.width = `${dalinysLength+1}ch`;
					} else {
						answerInput.style.width = `${dalinysLength}ch`;
					}
				} else {
					return
				}

			} else {
				answerInput.style.width = `${(Math.ceil(controller.randomSelection[0]/controller.randomSelection[1])).toString().length + 1.25}ch`;
				daliklis.style.width = `${(Math.ceil(controller.randomSelection[0]/controller.randomSelection[1])).toString().length + 1}ch`;
			}

			if (controller.withRemainder) {
				const elements = document.querySelectorAll('.stulpeliu-field');
				const lastElement = elements[elements.length - 1];

				if (!lastElement.querySelector(".remainder-label")) {
					const remainderElement = document.createElement("div");
					remainderElement.className = "remainder-label";
					remainderElement.innerHTML = "liek.";
					lastElement.appendChild(remainderElement);
				}
			}
			} else {

				var demAtTur = document.getElementsByClassName('demuo-turinys-ateminys');
				var didDemAtTurWidth = 0;
				var didDemAtTur;

				for (var i = 0; i < demAtTur.length; i++) {
						didDemAtTurWidth = Math.max(didDemAtTurWidth, demAtTur[i].offsetWidth);
				}

				var answerSize = 0;
				if (controller.randomSelection[2] === 'A') {
					answerSize = didDemAtTurWidth + oneRem*1.75 * 2;
				} else if (controller.randomSelection[2] === 'S') {
					answerSize = didDemAtTurWidth + oneRem*1.75;
				}

				element2Textarea.style.width = answerSize + 'px';
			}

			if (controller.withRemainder && controller.randomSelection[2] === 'D') {
				var liekElement = document.getElementById("liek");
				if (liekElement) {
					liekElement.style.visibility = "visible";
				}
			}

		} else {
			const answerElement = document.getElementById('answer');
			const requiredWidth = getCorrectAnswerLength() + 0.5;
			const currentWidthInCh = parseFloat(getComputedStyle(answerElement).width) / parseFloat(getComputedStyle(answerElement).fontSize);
			
			if (currentWidthInCh < requiredWidth) {
				answerElement.style.width = requiredWidth + 'ch';
			}
		}


  		adjustMiddleLineHeight();
		if (contentContainerElement) {
			contentContainerElement.style.visibility = 'visible';
		}
	}

function getCorrectAnswerLength() {
  const num1 = controller.randomSelection[0];
  const num2 = controller.randomSelection[1];
  const operation = controller.randomSelection[2];
  const position = controller.randomSelection[3];
  
  function flipNumber(number) {
    return Number(number.toString().split('').reverse().join(''));
  }

  let answer;
  
  if (controller.modeChoice7 === "C48") {
    if (operation === 'M') answer = flipNumber(num1 * num2);
    else if (operation === 'D') answer = Math.floor(num1 / num2);
    else if (operation === 'A') answer = flipNumber(num1 + num2);
    else if (operation === 'S') answer = flipNumber(num1 - num2);
  }
  else if (controller.modeChoice5 === "C41") {
    if (operation === 'A') answer = num1 + num2;
    else if (operation === 'S') answer = num1 - num2;
    else if (operation === 'M') answer = num1 * num2;
    else if (operation === 'D') answer = Math.floor(num1 / num2);
  }
  else if (controller.modeChoice5 === "C42") {
    if (position === "first") answer = num1;
    else if (position === "second") answer = num2;
  }
  
  return answer ? answer.toString().length : 0;
}


function adjustMiddleLineHeight() {
	const el = document.getElementById('middle-line-inner');
	const parent = el.parentElement;

  if(controller.questionsStopped) {
	el.style.height = 'auto';

	if (document.querySelector("#summary-table-frequent-mistakes")) {
		if (document.querySelector("#summary-table-frequent-mistakes").innerHTML === "Klaidų nėra!") {
			el.style.height = 'auto';
		} else {
			el.style.height = '100%';
		}
	} 
  } else {
	el.style.height = 'auto';
	el.style.maxHeight = 'none';

	el.style.height = el.scrollHeight <= parent.clientHeight ? 'auto' : '100%';
	el.style.maxHeight = '100%';
  }
}

window.addEventListener('resize', adjustMiddleLineHeight);
adjustMiddleLineHeight();

window.addEventListener("beforeunload", () => {
	if (!redirectingToAuthentication) {
		controller.task = null;
		controller.taskCompleted = false;
	}
	localStorage.setItem("controller", JSON.stringify(controller));
});

function stopQuestionsCloseActions () {
	document.querySelector(".upper-line").style.display = "none";
	arithmeticSymbol.innerHTML = '';

	if (controller.task) {
	if (controller.taskCompleted === true) {
		sendSetTaskResultsToDatabase();
	} else {
		controller.equation = '';
		if (controller.language === 'LT') {
		messageToTheUser('Užduotis nebaigta iki galo. Rezultatai neišsaugoti.')
		} else if (controller.language === 'EN') {
		messageToTheUser('Task was not completed. Results were not saved.')
		}
	}
	}
	
	controller.equation = finalMessageText();

	controller.equation2 = '';
	controller.result = ['', '', '', '', ''];
	controller.combinations = [];
	controller.randomSelection = []; 
	controller.questionsStopped = true;

	document.querySelector('#invisibleRow').style.display = "none";
	document.querySelector('.answer-field-div').style.display = "none";
	questionsSubmitButtonRowElement.style.display = "none";
	resetMistakeButtonsElement.style.display = "flex";
	localStorage.setItem('controller', JSON.stringify(controller))
	clearInterval(timerInterval);
	displayEquation()
	stopButtonSpanElement.innerHTML = "refresh";
}


function stopEquations () {
	const stopButtonSpanElement = document.querySelector('#stop-button-span');
	if (stopButtonSpanElement.innerHTML === "close") {
		showCustomConfirm("Ar tikrai nori sustabdyti užduotį?", stopQuestionsCloseActions);
	} else if (stopButtonSpanElement.innerHTML === "refresh") {
		document.querySelector(".upper-line").style.display = "flex";
		document.getElementById('middle-line-inner').style.height = "auto";
		document.querySelector("#equation-and-symbol").style.height = "auto";
		document.querySelector(".equation").style.height = "auto";
		stopButtonSpanElement.innerHTML = "close";
		restartEquations();
	}
}


function detectMobileKeyboard() {
  // Check if device is mobile
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   ('ontouchstart' in window) ||
                   (navigator.maxTouchPoints > 0);
  
  if (!isMobile) {
    return; // Don't set up listeners on desktop
  }
  
  let isKeyboardOpen = false;
  let lastHeight = window.innerHeight;
  let lastVisualHeight = window.visualViewport?.height || window.innerHeight;
  let resizeTimeout = null;
  
  // Threshold: 150px works well for most devices
  // Mobile keyboards are typically 250-350px tall
  const THRESHOLD = 150;
  
  function handleVisualViewportResize() {
    clearTimeout(resizeTimeout);
    
    resizeTimeout = setTimeout(() => {
      const currentHeight = window.visualViewport.height;
      const heightDiff = lastVisualHeight - currentHeight;
      
      // Keyboard likely opened
      if (heightDiff > THRESHOLD && !isKeyboardOpen) {
        isKeyboardOpen = true;
        if (typeof onShow === 'function') {
          onShow({
            keyboardHeight: heightDiff,
            viewportHeight: currentHeight,
            method: 'visualViewport'
          });
        }
      }
      // Keyboard likely closed
      else if (heightDiff < -THRESHOLD && isKeyboardOpen) {
        isKeyboardOpen = false;
        if (typeof onHide === 'function') {
          onHide({
            viewportHeight: currentHeight,
            method: 'visualViewport'
          });
        }
      }
      
      lastVisualHeight = currentHeight;
    }, 100);
  }
  
  function handleWindowResize() {
    clearTimeout(resizeTimeout);
    
    resizeTimeout = setTimeout(() => {
      const currentHeight = window.innerHeight;
      const heightDiff = lastHeight - currentHeight;
      
      // Only trigger if Visual Viewport API is not available
      if (!window.visualViewport) {
        if (heightDiff > THRESHOLD && !isKeyboardOpen) {
          isKeyboardOpen = true;
          if (typeof onShow === 'function') {
            onShow({
              keyboardHeight: heightDiff,
              viewportHeight: currentHeight,
              method: 'windowResize'
            });
          }
        }
        else if (heightDiff < -THRESHOLD && isKeyboardOpen) {
          isKeyboardOpen = false;
          if (typeof onHide === 'function') {
            onHide({
              viewportHeight: currentHeight,
              method: 'windowResize'
            });
          }
        }
      }
      
      lastHeight = currentHeight;
    }, 100);
  }
  
  function detectKeyboardByViewport() {
    if (window.visualViewport) {
      const heightDiff = window.innerHeight - window.visualViewport.height;
      return heightDiff > THRESHOLD;
    }
    return false;
  }
  
  function handleFocusIn(e) {
    const target = e.target;
    const isInput = target.tagName === 'INPUT' || 
                    target.tagName === 'TEXTAREA' || 
                    target.isContentEditable;
    
    if (isInput) {
      // Give keyboard time to appear
      setTimeout(() => {
        if (!isKeyboardOpen && detectKeyboardByViewport()) {
          isKeyboardOpen = true;
          if (typeof onShow === 'function') {
            onShow({
              method: 'focusIn',
              element: target
            });
          }
        }
      }, 300);
    }
  }
  
  function handleFocusOut(e) {
    const target = e.target;
    const isInput = target.tagName === 'INPUT' || 
                    target.tagName === 'TEXTAREA' || 
                    target.isContentEditable;
    
    if (isInput) {
      // Give keyboard time to disappear
      setTimeout(() => {
        // Check if another input was focused
        const activeEl = document.activeElement;
        const stillFocused = activeEl.tagName === 'INPUT' || 
                           activeEl.tagName === 'TEXTAREA' || 
                           activeEl.isContentEditable;
        
        if (!stillFocused && isKeyboardOpen && !detectKeyboardByViewport()) {
          isKeyboardOpen = false;
          if (typeof onHide === 'function') {
            onHide({
              method: 'focusOut',
              element: target
            });
          }
        }
      }, 300);
    }
  }
  
  function handleOrientationChange() {
    // Reset height references on orientation change
    setTimeout(() => {
      lastHeight = window.innerHeight;
      lastVisualHeight = window.visualViewport?.height || window.innerHeight;
      isKeyboardOpen = false;
    }, 500);
  }
  
  // Set up listeners
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', handleVisualViewportResize);
  }
  
  window.addEventListener('resize', handleWindowResize);
  document.addEventListener('focusin', handleFocusIn);
  document.addEventListener('focusout', handleFocusOut);
  
  if (window.screen?.orientation) {
    window.screen.orientation.addEventListener('change', handleOrientationChange);
  }
  
  // Return cleanup function
  return function cleanup() {
    if (window.visualViewport) {
      window.visualViewport.removeEventListener('resize', handleVisualViewportResize);
    }
    window.removeEventListener('resize', handleWindowResize);
    document.removeEventListener('focusin', handleFocusIn);
    document.removeEventListener('focusout', handleFocusOut);
    if (window.screen?.orientation) {
      window.screen.orientation.removeEventListener('change', handleOrientationChange);
    }
    clearTimeout(resizeTimeout);
  };
}

// Usage:
// 1. Define your callback functions globally or in accessible scope:
function onShow(info) {
	const navbar = document.querySelector('#mainNavbar');
	const container = document.querySelector('.container');
	container.classList.add('keyboard-open');
	navbar.classList.add('keyboard-open');
}

function onHide(info) {
  	const navbar = document.querySelector('#mainNavbar');
	const container = document.querySelector('.container');
	container.classList.remove('keyboard-open');
    navbar.classList.remove('keyboard-open');
	if (controller.modeChoice7 === "C48" && controller.randomSelection[2] === 'M') {
		equationsAndSymbolContainer.classList.remove('collapsed');
	}
}

// 2. Initialize the detector (only runs on mobile devices):
const cleanup = detectMobileKeyboard();

// 3. Optional: cleanup when needed
// if (cleanup) cleanup();

	</script>
</body>

</html>
