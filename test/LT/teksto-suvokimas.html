<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sudedu - teksto supratimas</title>

    <link rel="stylesheet"
		href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="../main-nav-bar.css">
    <link rel="stylesheet" type="text/css" href="../index.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-96Q83PW8XY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-96Q83PW8XY');
    </script>	
    <script src="../refresh-token.js"></script>
    
    <style>

        * {
          -webkit-user-select: none;
          -webkit-tap-highlight-color: transparent;
          user-select: none;
          box-sizing: border-box;
          -webkit-user-drag: none;
          user-drag: none;
        }

      	html {
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: linear-gradient(to top, #ffbf9c, #ffbf92, #ffbf89, #ffbf7e, #ffc074);
            width: 100vw;
            height: 100svh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        body {
            margin: 0;
            font-family: 'SFpro', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .main-nav-mobile-btn {
            width: auto;
            height: auto;
        }

        .container {
            flex: 1;
            max-height: calc(100% - 80px - 16px - 16px);
            min-height: calc(100% - 80px - 16px - 16px);
            width: calc(100% - (2 * 16px));
            display: flex;
            justify-content: start;
            background: rgba(255, 255, 255, 0.08);
            margin: 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.1);
            flex-direction: column;
            padding: 20px;
        }

        .trackers-row {
          display: flex;
          flex-wrap: wrap;
        }

        .trackers-holder,
        .timer-holder {
          display: flex;
          flex: 1;
          white-space: nowrap;
        }

        .timer-holder {
          justify-content: end;
        }

        .item {
          font-size: 1rem;
          color: black;;
          padding: 10px;
          margin: 5px;
          cursor: move;
          background: rgba(255, 255, 255, 0.2);
          border: 1px solid rgba(255, 255, 255, 0.2);
          backdrop-filter: blur(10px);
          border-radius: 5px;
          white-space: pre-line;
        }

        /* Ensure the drop targets fill the column */

        #title-field {
          min-height: 100px;
        }

        .tracker-timer-holder {
          padding: 0 15px;
          margin-bottom: 10px;
        }

        #mistakes-tracker,
        #question-number-tracker,
        #timer {
          margin: 0;
          font-weight: 600;
          font-size: 1.25rem
        }

        #question-number-tracker {
          margin-bottom: 5px;
        }

        .trackers-holder,
        .timer-holder {
          align-items: center;
        }

        .button-row {
          display: flex;
          margin-top: 15px;
          justify-content: space-between;
        }

        #options-field,
        #answers-field {
          display: flex;
          flex-direction: column;
        }

        #answers-field {
          margin-top: 15px;
        }

        #answers-field-start,
        #answers-field-middle,
        #answers-field-end {
          margin-top: 15px;
        }
        
        #final-message-row {
          position: relative;
          backdrop-filter: blur(15px);
          -webkit-backdrop-filter: blur(15px);
          background: rgba(255, 255, 255, 0.15);
          border-radius: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          flex: 1 1 auto;
        }

        #final-message-div {
          font-size: 2rem;
          display: flex;
        }

        #result-message {
          margin-top: 20px;
          font-weight: bold;
        }

        #author {
          margin-top: 10px;
          margin-left: 10px;
        }

        #help-btn {
          position: relative;
        }

        .field {
          padding: 10px;
          color: gray;
          background: rgba(255, 255, 255, 0.4);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 10px 10px 10px 10px;
        }

        #help-btn,
        #next-question-btn,
        #check-answer-btn,
        #stopButtonTextComp {
            position: relative;
            background: linear-gradient(135deg, #3288AC, #286D8A);
            border: none;
            /* border: 1px solid #286D8A; */
            color: #F5F5F7;
            display: flex;
            align-items: center;
            padding: 12px 18px 12px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            letter-spacing: 0.01em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0;
            justify-content: center;
            min-width: 10vw;
        }

        #stopButtonTextComp {
          width: 6vw;
          min-width: 75px;
          height: 42.5px;
          border-radius: 100px;
          font-size: 2rem;
        }

        #help-btn::before,
        #next-question-btn::before,
        #check-answer-btn::before,
        #stopButtonTextComp::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
            border-radius: 20px;
            pointer-events: none;
            transition: background 0.3s ease;
        }

        #help-btn::after,
        #next-question-btn::after,
        #check-answer-btn::after,
        #stopButtonTextComp::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 20px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        #help-btn:hover::before,
        #next-question-btn:hover::before,
        #check-answer-btn:hover::before,
        #stopButtonTextComp:hover::before {
            background: rgba(255, 255, 255, 0.15);
        }

        .help-and-check-button-holder {
          display: flex;
          gap: 10px;
        }

        #check-answer-btn {
          margin-bottom: 0;
        }

        #tries,
        #help {
          font-size: 1.25rem;
        }

        .stop-reset-button-div .col-2 {
          padding: 0;
        }

        .trackers-row,
        #stop-restart-button-row {
          padding: 0;
          margin: 0;
        }

        .material-symbols-rounded {
          font-size: 2rem;
          font-weight: 300;
        }

        .stop-button-div {
            display: flex;
            justify-content: flex-start;
            z-index: 3;
          }

        .error {
            animation: shake 0.2s ease-in-out 0s 2;
        }

        #fields-row {
          display: flex;
          flex: 1 1 auto;
          min-height: 0;
          gap: 10px;
        }

        .right-side-panel {
            flex: 1 1 50%;
            min-height: 0;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            overflow: hidden;
        }

        .right-side-panel-inner {
          height: 100%;
          overflow-y: auto;
          padding: 15px;
        }

        /* Sidebar wrapper */
        .sidebar-wrapper {
            position: relative;
            flex: 1 1 50%;
            height: 100%;
            margin-right: 10px;
        }

        /* Sidebar content */
        .sidebar {
            position: relative;
            height: 100%;
            width: 100%;
            margin-right: 15px;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            overflow: hidden;
        }

        .sidebar-content {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 15px;
        }

        /* Toggle tab - always visible */
        .toggle-tab {
            position: absolute;
            right: -34px;
            top: 0;
            border: none;
            width: 34px;
            height: 58px;
            border-radius: 0 20px 20px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            background: rgba(255, 255, 255, 0.5);
            padding: 0;
        }

        .toggle-tab svg {
            width: 24px;
            height: 24px;
            transition: transform 0.3s ease;
        }

        /* Overlay */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .overlay.active {
            display: block;
        }

        @keyframes shake {
          0% { transform: translateX(0); }
          25% { transform: translateX(0.5rem); }
          75% { transform: translateX(-0.5rem); }
          100% { transform: translateX(0); }
        }

        #fireworks-div {
          position: absolute;
          bottom: -10%;
          right: 0;
          width: 250px;
        }

        .drag-ghost {
          opacity: 0.5;
        }

        .drag-chosen {
          background-color: #faf1e6 !important;
          background: rgba(255, 255, 255, 0.2);
          border: 2px dashed #40c9a9;
        }

        .drag-dragging {
          background-color: #FAF1E6;
        }

        .item.hold-indicator {
          position: relative;
          box-shadow: 0 0 0 2px #40c9a9 inset; /* subtle glow */
          transition: box-shadow 0.2s ease;
        }

        #help-btn {
          position: relative;
          cursor: not-allowed;
          transition: background-color 0.3s, color 0.3s;
          background: #809498;
          overflow: hidden;
        }

        #help-btn.enabled {
          color: white;
          cursor: pointer;
          opacity: 1;
          background: linear-gradient(135deg, #3288AC, #286D8A);
        }

        .fill-bar {
          position: absolute;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 0%;
          background: linear-gradient(135deg, #3288AC, #286D8A);
          transition: width 0.5s ease;
          z-index: 0;
          border-radius: 20px;
        }

        #help-btn span,
        #help-btn::before {
          position: relative;
          z-index: 2;
          text-align: center;
        }



        @media (max-width: 1150px) {
        #next-question-btn,
        #check-answer-btn,
        #help-btn {
          min-width: 15vw;
        }

        #stopButtonTextComp {
          width: 8vw;
        }

        #final-message-div {
          font-size: 2.25rem;
        }
        }

        @media (min-width: 769px) {
            .toggle-tab {
                display: none;
            }
        }

        @media (max-width: 767px) {
          .container {
              width: 100%;
              max-height: calc(100% - 80px);
              min-height: calc(100% - 80px);
              margin: 0;
              background: transparent;
              border: none;
              border-radius: 0;
              padding: 15px;
          }

          .sidebar {
            border-radius: 0;
            padding: 0;
            border-bottom-right-radius: 20px;
            background: rgba(255, 255, 255, 0.5);
          }

          .sidebar-content {
              height: 100%;
              width: 100%;
              display: flex;
              flex-direction: column;
              justify-content: space-between;
              overflow-y: auto;
              padding: 15px;
          }

          #options-field {
            margin: 0;
            padding: 0;
            background-color: transparent;
            border: none;
          }

          #next-question-btn,
          #check-answer-btn,
          #help-btn {
          min-width: 25vw;
        }

        #stopButtonTextComp {
          width: 10vw;
        }

        .tracker-timer-holder {
          padding: 0 15px 0 30px;
        }

        #fireworks-div {
          width: 200px;
          bottom: -5%;
        }

        .sidebar-wrapper {
            position: fixed;
            left: 0;
            top: 95px;
            height: calc(100% - 80px - 30px);
            width: calc(100vw - 34px - 5px);
            z-index: 100;
            transition: transform 0.3s ease;
            transform: translateX(calc(-1*(100vw - 34px - 5px)));
            padding-left: 0;
        }
        
        #author {
          margin-top: 10px;
          padding-top: 10px;
          border-top: 1px solid rgba(255, 255, 255, 1);
          margin-left: 0;
          text-align: center;
          }

        .sidebar-wrapper.open {
            transform: translateX(0);
        }

        .sidebar-wrapper.open .toggle-tab svg {
            transform: rotate(180deg);
        }        
      }
        
      @media (max-width: 575px) {

      .stop-button {
        width: 4.25rem;
        height: 4.25rem;
      }

      #fireworks-div {
        width: 150px;
        bottom: 60%;
      }
    }

    @media (min-device-width: 768px) and (max-device-width: 1200px) and (orientation: portrait)  {
		  .container {
          width: 100%;
          max-height: calc(100% - 100px);
          min-height: calc(100% - 100px);
          margin: 0;
          background: transparent;
          border: none;
          border-radius: 0;
          padding: 30px;
      }

      .sidebar {
        border-radius: 0;
        padding: 0;
        border-bottom-right-radius: 20px;
        background: rgba(255, 255, 255, 0.5);
      }

      .sidebar-content {
          height: 100%;
          width: 100%;
          display: flex;
          flex-direction: column;
          justify-content: space-between;
          overflow-y: auto;
          padding: 15px;
      }

      #options-field {
        margin: 0;
        padding: 0;
        background-color: transparent;
        border: none;
      }

      .sidebar-wrapper {
            position: fixed;
            left: 0;
            top: 115px;
            height: calc(100% - 100px - 30px);
            width: calc(100vw - 34px - 5px);
            z-index: 100;
            transition: transform 0.3s ease;
            transform: translateX(calc(-1*(100vw - 34px - 5px)));
            padding-left: 0;
        }

        .toggle-tab {
            display: flex;
            height: 93px;
        }

        .tracker-timer-holder {
          padding: 0 15px 0 30px;
        }
        
        #author {
          margin-top: 10px;
          padding-top: 10px;
          border-top: 1px solid rgba(255, 255, 255, 1);
          margin-left: 0;
          text-align: center;
          }

        .sidebar-wrapper.open {
            transform: translateX(0);
        }

        .sidebar-wrapper.open .toggle-tab svg {
            transform: rotate(180deg);
        }   

        #mistakes-tracker, #question-number-tracker, #timer {
          font-size: 1.5rem;
        }
      
      body {
        font-size: 1.4rem;
      }

      #stopButtonTextComp {
          width: 10vw;
          min-width: 90px;
          height: 51.5px;
          border-radius: 100px;
          font-size: 2rem;
      }

    
      :root {
        	--font-size: 32px; /* Smaller font size for tablets */
    	}
		
		.stop-button {
			height: 6rem;
			width: 6rem;
		}

		.material-symbols-rounded {
			font-size: 2.75rem;
		}

		.summary-button {
			font-size: 1.5rem;
		}

		.question-submit-button {
			font-size: 1.5rem;
		}

		h3 {
			font-size: 2rem;
		}

		#check-answer-btn,
		#help-btn,
		#next-question-btn {
			font-size: 1.25rem;
			min-width: 25vw;
		}

    .item {
      font-size: 1.4rem;
    }
	}

  /* Draggable base styles */
.draggable-item {
  cursor: move;
  cursor: grab;
  touch-action: none;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}

.draggable-item:active {
  cursor: grabbing;
}

/* Dragging states */
.draggable-source--is-dragging {
  opacity: 0.3;
  cursor: grabbing;
}

.draggable-mirror {
  opacity: 0.9;
  cursor: grabbing;
  z-index: 9999;
  pointer-events: none;
}

.draggable--over {
  background-color: rgba(0, 123, 255, 0.1);
}

/* Container receiving drag */
.draggable-container--over {
  background-color: rgba(0, 123, 255, 0.05);
}

/* Placeholder for where item will drop */
.draggable-source--placed {
  opacity: 0.5;
}

/* Touch device feedback */
@media (hover: none) and (pointer: coarse) {
  .draggable-item {
    cursor: default;
  }
  
  .draggable-item:active {
    cursor: default;
  }
  
  /* Visual feedback during hold delay */
  .draggable-item.hold-indicator {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: transform 0.2s, box-shadow 0.2s;
  }
}

/* Swap animation */
.draggable-item {
  transition: transform 150ms ease-in-out;
}

/* Prevent text selection during drag */
.draggable-container--is-dragging {
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}

/* Empty container hint */
.draggable-container:empty::before {
  content: 'Drop items here';
  display: block;
  padding: 20px;
  text-align: center;
  color: #999;
  font-style: italic;
}

/* Ensure proper stacking */
.draggable-mirror,
.draggable-source--is-dragging {
  position: relative;
  z-index: 10000;
}

    </style>
</head>
<body>

    <div id="customConfirmModal" class="modal">
    <div class="modal-content">
        <p id="customModalText"></p>
        <div class="modal-buttons">
        <button id="customConfirmYes" class="btn-confirm">Taip</button>
        <button id="customConfirmNo" class="btn-cancel">Ne</button>
        </div>
    </div>
    </div>

    <div id="object-popup" class="object-popup-overlay" style="display:none;">
    <div class="object-popup-panel">
        <button class="object-popup-close">&times;</button>
        <div class="title-subtitle-inline-button-wrapper">
        <div class="object-popup-title-subtitle-wrapper">
        <div class="object-popup-title" id="object-popup-title"></div>
        <div class="object-popup-subtitle" id="object-popup-subtitle"></div>
        </div>
        </div>
        <div class="object-popup-content" id="object-popup-content">
        <!-- Dynamic content goes here -->
        </div>
    </div>
    </div>


    <nav class="main-navbar" id="mainNavbar">
      <div class="main-nav-container">
          <!-- Logo -->
          <a href="#" class="main-nav-logo">
              <div class="main-nav-logo-icon">
                <img id="sudedu-main-nav-bar-logo" src="../images/sudedu_logo.png" alt="sudEdu">
              </div>
          </a>

          <!-- Desktop Navigation -->
          <div class="main-nav-links invisible">
            <a class="main-nav-back-btn" id="desktopBackBtn">
              <span class="main-nav-back-icon">←</span>
              <div class="main-nav-back-text">
                <span class="main-nav-back-label">Grįžti</span>
                <span class="main-nav-back-title">Atgal</span>
              </div>
            </a>
          </div>

          <!-- Mobile Navigation -->
          <div class="main-nav-mobile-btn simplified">
            <a class="main-nav-back-btn" id="mobileBackBtn">
              <span class="main-nav-back-icon">←</span>
              <div class="main-nav-back-text">
                <span class="main-nav-back-label">Grįžti</span>
                <span class="main-nav-back-title">Atgal</span>
              </div>
            </a>
          </div>
      </div>
  </nav>

  <div class="container">
      <div class="tracker-timer-holder">
      <div class="trackers-row">
        <div class="trackers-holder">
          <div class="trackers">
              <div>
                <div id="question-number-tracker"></div>
              </div>
              <div>
                <div id="mistakes-tracker"></div>
              </div>
              <div id="help">
              </div>
          </div>
      </div>
      <div class="timer-holder">
          <div id="timer"></div>
      </div>
      </div>
    </div>
    
    
    <!-- First row: Left column empty, Right column with item -->
    <div class="" id="fields-row">

    <div class="sidebar-wrapper" id="sidebarWrapper">
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-content" id="sidebarContent">

          <div class="options-field-holder">
            <div id="options-field-div" class="col-12">
              <div id="options-field" class="field">
              </div>
              <div id="author">
              </div>
            </div>
          </div>

        </div>
      </aside>

      <button class="toggle-tab" id="toggleTab" aria-label="Toggle sidebar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M9 18l6-6-6-6"/>
          </svg>
      </button>
    </div>

      <!-- Second row: Draggable items and Bottom right -->
      <div class="right-side-panel">
        <div class="right-side-panel-inner">
        <div class="">
          <div id="title-field" class="field">
            Pavadinimas
          </div>
        </div>
        <div id="answers-field-div" class="komponavimas">
          <div id="answers-field" class="field" style="display: none;">
            Tekstas
          </div>
        </div>

        <!-- Right column with bottom-right item -->
        <div id="answers-field-start-div" class="isdestymas">
          <div id="answers-field-start" class="field" style="display: none;">
            Pradžia
          </div>
        </div>

        <div id="answers-field-middle-div" class="isdestymas">
          <div id="answers-field-middle" class="field" style="display: none;">
            Įvykio raida
          </div>
        </div>

        <div id="answers-field-end-div" class="isdestymas">
          <div id="answers-field-end" class="field" style="display: none;">
            Pabaiga
          </div>
        </div>
        </div>
      </div>
    </div>

    <div id="final-message-row" style="display: none; position: relative;">
          <div id="fireworks-div" class="image-container fireworks-div"></div>
          <div id="final-message-div"></div>
    </div>

    <div class="button-row">
      <div class="stop-restart-button-row" id="stop-restart-button-row">
      <div class="stop-reset-button-div">
        <div class="">
          <div class="stop-button-div">
            <button id="stopButtonTextComp" class="stop-button"><span id="stop-button-span"
                class="material-symbols-rounded">close</span></button>
          </div>
        </div>
      </div>
    </div>

    <div class="help-and-check-button-holder">
    <div class="help-button-holder">
        <div class="help-button-holder-inner">
        <button id="help-btn" class="help-btn" disabled>
          Pagalba
          <div class="fill-bar"></div>
        </button>
      </div>
    </div>

    <div class="check-button-holder">
      <div class="check-button-holder-inner">
        <button id="check-answer-btn" class="">Tikrinti</button>
        <div class="d-flex">
      <button id="next-question-btn" class="" style="display: none;">Kita užduotis</button>
    </div>
    </div>
  </div>
  </div>

  </div>
  
  <script src="../main-nav-bar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="../parameter_dictionary.js"></script>
  <script src="../mental-arithmetic.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@shopify/draggable@1.0.0-beta.12/lib/draggable.bundle.js"></script>

  <script>

window.onload = function () {
    if (!localStorage.getItem('controller')) {
        window.location.href = "./";
    } else {
      controller = JSON.parse(localStorage.getItem('controller')) 
      if (controller.mode !== "lang" || controller.modeChoice1 !== "C49") {
			window.location.href = "./";
		}
    }
  }

  controller = JSON.parse(localStorage.getItem('controller')) 
  let jsonFiles = [];

	// Define an array of URLs for the JSON files you want to fetch
	if (controller.classChoice === "C75") {
		jsonFile = '../databases/1_2_klase_teksto_suvokimas.json';
	} else if (controller.classChoice === "C76") {
		jsonFile = '../databases/3_4_klase_teksto_suvokimas.json';
	}

  fetch(jsonFile)
      .then(response => {
          if (!response.ok) throw new Error("Network error");
          return response.json();
      })
      .then(textDatabase => {
    var helpUsed = 0;
    var triesToHelp = 0;
    var helpTracker = 0;
    var orderedSentences;
    var distractorSentences;
    controller = JSON.parse(localStorage.getItem('controller')) 
    var drake; 
    const answersField = document.getElementById('answers-field');
    const answersFieldStart = document.getElementById('answers-field-start');
    const answersFieldMiddle = document.getElementById('answers-field-middle');
    const answersFieldEnd = document.getElementById('answers-field-end');
    const titleField = document.getElementById('title-field');
    const optionsField = document.getElementById('options-field');
    const checkAnswerBtn = document.getElementById('check-answer-btn');
    const nextQuestionBtn = document.getElementById('next-question-btn');
    const helpBtn = document.getElementById('help-btn');
    var selectedItem;
    let questionNumberTracker = document.getElementById('question-number-tracker');
    let mistakesTracker = document.getElementById('mistakes-tracker'); 
    const helpDiv = document.getElementById('help');
    let filteredTextLibrary = [];
    let currentTextId;
    let answeredTexts = [];
    let firstTimeChecking = true;
    window.mistakesSummary = {};

    function generateFilteredTextLibrary() {
    var tempTextLibrary = Array.from(textDatabase);

    if (controller.modeChoice2 === "C51") {
      filteredTextLibrary = tempTextLibrary.filter(entry =>
      entry['suitable-for']?.[parameterDictionary["C51"]["parameter"]]?.includes(parameterDictionary[controller.modeChoiceLtDifficulty]["parameter"])
    );
      answersField.style.display = "block";
    } else if (controller.modeChoice2 === "C52") {
      filteredTextLibrary = tempTextLibrary.filter(entry =>
      entry['suitable-for']?.['struktura']?.includes(parameterDictionary[controller.modeChoiceLtDifficulty]["parameter"])
    );
      answersFieldStart.style.display = "block";
      answersFieldMiddle.style.display = "block";
      answersFieldEnd.style.display = "block";
    }
    }

    helpBtn.disabled = true;

    // Function to shuffle the array of sentences
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]]; // Swap elements
      }
      return array;
    }

    function selectRandomItem() {
    // Generate a random index
    const randomIndex = Math.floor(Math.random() * filteredTextLibrary.length);
    
    // Remove the selected item from the array and return it
    const selectedItem = filteredTextLibrary.splice(randomIndex, 1)[0];
    
    return selectedItem;
    }

    function displayQuestion() {
      if (filteredTextLibrary.length === 0) {
        generateFilteredTextLibrary();
      }
      
      if (controller.randomSelection.length === 0) {
        selectedItem = selectRandomItem();
        controller.randomSelection = [selectedItem];
        localStorage.setItem("controller", JSON.stringify(controller));
      } else {
        selectedItem = controller.randomSelection[0];
      }
    
      currentTextId = selectedItem.id;
      answeredTexts.push(currentTextId);

      if (!mistakesSummary[currentTextId]) {
        mistakesSummary[currentTextId] = {};
      }

      textIncidenceCount = answeredTexts.filter(id => id === currentTextId).length;

      if (!mistakesSummary[currentTextId][`${textIncidenceCount}`]) {
        mistakesSummary[currentTextId][`${textIncidenceCount}`] = 0;
      }


      const originalTitle = selectedItem.title;
      const fullText = [...selectedItem.text.start, ...selectedItem.text.middle, ...selectedItem.text.end];
      const paragraphAuthor = selectedItem.author;
      optionsField.style.minHeight = `auto`;

      const authorDiv = document.getElementById('author');
      authorDiv.innerHTML = paragraphAuthor;

      let combinedItems = [];
      if (controller.modeChoice2 === "C51") {
        if (controller.modeChoiceLtDifficulty === "C58" || controller.modeChoiceLtDifficulty === "C59" || controller.modeChoiceLtDifficulty === "C60") {
          orderedSentences = splitParagraphToSentences(fullText);
          combinedItems = [originalTitle, ...orderedSentences];
        } else if (controller.modeChoiceLtDifficulty === "C80" || controller.modeChoiceLtDifficulty === "C81" || controller.modeChoiceLtDifficulty === "C82") {
          orderedSentences = splitParagraphToSentences(fullText);
          distractorSentences = splitParagraphToSentences(selectedItem.text.distractor);
          combinedItems = [originalTitle, ...orderedSentences, ...distractorSentences];
        }
      } else if (controller.modeChoice2 === "C52") {
        if (controller.modeChoiceLtDifficulty === "C58" || controller.modeChoiceLtDifficulty === "C59" || controller.modeChoiceLtDifficulty === "C60") {
          combinedItems = [...fullText, ...[originalTitle]];
        } else if (controller.modeChoiceLtDifficulty === "C80" || controller.modeChoiceLtDifficulty === "C81" || controller.modeChoiceLtDifficulty === "C82") {
          distractorItems = selectedItem.text.distractor;
          combinedItems = [...fullText, ...distractorItems, ...[originalTitle]];
        }
      }
      
      // Shuffle the combined items (title + sentences)
      const shuffledItems = shuffleArray(combinedItems);

      // Append shuffled items (title + sentences) as draggable items
      optionsField.innerHTML = '';  // Clear previous items before appending
      shuffledItems.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('item');
        itemDiv.textContent = item;
        optionsField.appendChild(itemDiv);
      });

      // After the items are appended, set the height of the fields to fixed
      const optionsHeight = optionsField.scrollHeight;
      const answersHeight = answersField.scrollHeight;
      const answerFieldStartHeight = answersFieldStart.scrollHeight;
      const answerFieldMiddleHeight = answersFieldMiddle.scrollHeight;
      const answerFieldEndHeight = answersFieldEnd.scrollHeight;

      optionsField.style.minHeight = `${optionsHeight}px`;
      answersField.style.minHeight = `${optionsHeight-40}px`;
      answersFieldStart.style.minHeight = `${Math.max(optionsHeight/3*0.75, 100)}px`
      answersFieldMiddle.style.minHeight = `${Math.max(optionsHeight/3*1.5, 100)}px`
      answersFieldEnd.style.minHeight = `${Math.max(optionsHeight/3*0.75, 100)}px`
      

      if (controller.modeChoice4 === "C40") {
        questionNumberTracker.innerHTML = `Atlikta: ${controller.answeredQuestionTracker}/${controller.questionNumber}`;
      } else {
        questionNumberTracker.innerHTML = `Atlikta: ${controller.answeredQuestionTracker}`;
      }
      mistakesTracker.innerHTML = `Klaidos: ${controller.mistakesTracker}`;

      //helpDiv.innerHTML = `Panaudota pagalba: ${helpTracker}`;

      resetHelpButton();
    }

    function splitParagraphToSentences(paragraph) {
        let allSentences = [];

        // Iterate through each sentence in the combined sections of the paragraph
        for (let part of paragraph) {
            // Split each sentence in the part by sentence-ending punctuation (.!?) followed by a space
            let sentences = part.split(/(?<=[.!?])\s+/);
            allSentences.push(...sentences); // Add each sentence to the allSentences array
        }

        return allSentences;
    }

    updateSortables();

    checkAnswerBtn.addEventListener('click', function () {
      const titleAnswerItems = titleField.querySelectorAll('.item');
      const titleAnswer = Array.from(titleAnswerItems).map(item => item.textContent);

      const titleItems = titleField.querySelectorAll('.item');
      const titleList = Array.from(titleItems).map(item => item.textContent);

      const paragraphAnswerItems = answersField.querySelectorAll('.item');
      const paragraphAnswerOrder = Array.from(paragraphAnswerItems).map(item => item.textContent);

      const paragraphAnswerStartItems = answersFieldStart.querySelectorAll('.item');
      const paragraphAnswerStartOrder = Array.from(paragraphAnswerStartItems).map(item => item.textContent);

      const paragraphAnswerMiddleItems = answersFieldMiddle.querySelectorAll('.item');
      const paragraphAnswerMiddleOrder = Array.from(paragraphAnswerMiddleItems).map(item => item.textContent);

      const paragraphAnswerEndItems = answersFieldEnd.querySelectorAll('.item');
      const paragraphAnswerEndOrder = Array.from(paragraphAnswerEndItems).map(item => item.textContent);

      function errorIndicator (field) {
        field.classList.add('error')
          var timeoutReference = setTimeout(function() {
            field.classList.remove('error'); 
        }, 500);
        }

      function arraysAreEqual(items, arr1, arr2, field) {
      var answerCorrect = true;
      
      // Check for length mismatch
      if (arr1.length !== arr2.length) {
        answerCorrect = false;
      }

      const minLength = Math.min(arr1.length, arr2.length);
      
      // Compare items up to the shortest length
      for (let i = 0; i < minLength; i++) {
        if (arr1[i].trim() !== arr2[i].trim()) {
          answerCorrect = false;
          items[i].style.backgroundColor = '#D57E7C';
        } else {
          items[i].style.backgroundColor = 'rgb(182, 200, 103)';
        }
      }

      // Handle extra items in arr1 if it's longer than arr2
      if (arr1.length > arr2.length) {
        answerCorrect = false;
        for (let i = minLength; i < arr1.length; i++) {
          items[i].style.backgroundColor = '#D57E7C';
    }
  }

    // Trigger error indicator if arrays are not equal
    if (!answerCorrect) {
      errorIndicator(field);
    }

    return answerCorrect;
}


      function titlesAreEqual(items, answer, title) {
        var answerCorrect = true;
        if (answer.length !== title.length) {
          answerCorrect = false;
        } 

        for (let i = 0; i < answer.length; i++) {
          if (answer[i].trim() !== title[0].trim()) {
            answerCorrect = false;
            items[i].style.backgroundColor = '#D57E7C'
          } else if (answer[i].trim() === title[0].trim()) {
            items[i].style.backgroundColor = 'rgb(182, 200, 103)'
          }
        }
        if (!answerCorrect) {
          errorIndicator(titleField);
        }
        return answerCorrect;
      }

      allFieldsCorrect = false;

      const titleIsCorrect = titlesAreEqual(titleItems, titleAnswer, [selectedItem.title]);
      if (controller.modeChoice2 === "C51") {
          if (titleAnswer.length === 0 && paragraphAnswerOrder.length === 0) {
          return
        } else {
          const sentenceOrderIsCorrect = arraysAreEqual(paragraphAnswerItems, paragraphAnswerOrder, orderedSentences, answersField);
          if (titleIsCorrect && sentenceOrderIsCorrect) {
            allFieldsCorrect = true;
          }
        }
      } else if (controller.modeChoice2 === "C52") {
          if (titleAnswer.length === 0 && paragraphAnswerStartOrder.length === 0 && paragraphAnswerMiddleOrder.length === 0 && paragraphAnswerEndOrder.length === 0) {
          return
        } else {
          const sentenceOrderStartIsCorrect = arraysAreEqual(paragraphAnswerStartItems, paragraphAnswerStartOrder, selectedItem.text.start, answersFieldStart);
          const sentenceOrderMiddleIsCorrect = arraysAreEqual(paragraphAnswerMiddleItems, paragraphAnswerMiddleOrder, selectedItem.text.middle, answersFieldMiddle);
          const sentenceOrderEndIsCorrect = arraysAreEqual(paragraphAnswerEndItems, paragraphAnswerEndOrder, selectedItem.text.end, answersFieldEnd);
          if (titleIsCorrect && sentenceOrderStartIsCorrect && sentenceOrderMiddleIsCorrect && sentenceOrderEndIsCorrect) {
            allFieldsCorrect = true;
          }
        }
      }

      if (allFieldsCorrect) {
        controller.answeredQuestionTracker++;

        if (firstTimeChecking) {
          controller.correctAnswersTracker++;
        }

        firstTimeChecking = true;
      
        localStorage.setItem('controller', JSON.stringify(controller));
        if (controller.modeChoice4 === "C40") {
        questionNumberTracker.innerHTML = `Atlikta: ${controller.answeredQuestionTracker}/${controller.questionNumber}`;
        } else {
          questionNumberTracker.innerHTML = `Atlikta: ${controller.answeredQuestionTracker}`;
        }
        updateSortables()
        nextQuestionBtn.style.display = 'flex';
        checkAnswerBtn.style.display = "none";
        checkAnswerBtn.disabled = true;
        controller.randomSelection = [];
        localStorage.setItem("controller", JSON.stringify(controller));
      } else {
        trackHelpButtonCounter();
        controller.mistakesTracker++;

        firstTimeChecking = false;

        recordTextComprehensionMistake()
        localStorage.setItem('controller', JSON.stringify(controller));
        mistakesTracker.innerHTML = `Klaidos: ${controller.mistakesTracker}`;
    }
    });

    function recordTextComprehensionMistake() {
      mistakesSummary[currentTextId][`${textIncidenceCount}`]+=1
    }

    const fillBar = helpBtn.querySelector('.fill-bar');
    let anserAttemptsSinceLastHelp = 0;
    const maxAttempts = 3;

    function trackHelpButtonCounter() {
      anserAttemptsSinceLastHelp++;

      // Calculate progress (in thirds)
      const progress = Math.min((anserAttemptsSinceLastHelp / maxAttempts) * 100, 100);
      fillBar.style.width = `${progress * 1.15}%`;

      // When all three tries are used
      if (anserAttemptsSinceLastHelp >= maxAttempts) {
          setTimeout(() => {
            helpBtn.disabled = false;
            helpBtn.classList.add('enabled');
            fillBar.style.opacity = 0;
          }, 300); // 300 milliseconds = 0.3 seconds
      }
    }

    // Example reset system
    function resetHelpButton() {
      anserAttemptsSinceLastHelp = 0;
      fillBar.style.width = '0%';
      helpBtn.disabled = true;
      helpBtn.classList.remove('enabled');
      fillBar.style.opacity = 0.3;
    }

    helpBtn.addEventListener('click', function () {
      helpTracker++;
      //helpDiv.innerHTML = `Panaudota pagalba: ${helpTracker}`;


      if (controller.modeChoice2 === "C51") {
        if (helpTracker === 1) {
        answersField.innerHTML = 'Tekstas';
        titleField.innerHTML = 'Pavadinimas';
        optionsField.innerHTML = '';
  
        const splitIndex = Math.floor(orderedSentences.length / 3);
        let orderedSentencesfirstPart = orderedSentences.slice(0, splitIndex);
        let orderedSentencessecondPart = orderedSentences.slice(splitIndex);

        const correctTitle = document.createElement('div');
        correctTitle.classList.add('item');
        correctTitle.textContent = selectedItem.title;
        titleField.appendChild(correctTitle);

        orderedSentencesfirstPart.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('item');
        itemDiv.textContent = item;
        answersField.appendChild(itemDiv);
        });

        if (controller.modeChoiceLtDifficulty === "C80" || controller.modeChoiceLtDifficulty === "C81" || controller.modeChoiceLtDifficulty === "C82") {
          orderedSentencessecondPart = [...orderedSentencessecondPart, ...distractorSentences]
        }

        shuffleArray(orderedSentencessecondPart).forEach(item => {
          const itemDiv = document.createElement('div');
          itemDiv.classList.add('item');
          itemDiv.textContent = item;
          optionsField.appendChild(itemDiv);
        });
      } else if (helpTracker === 2) {
        answersField.innerHTML = 'Tekstas';
        titleField.innerHTML = 'Pavadinimas';
        optionsField.innerHTML = '';
  
        const splitIndex = Math.floor(orderedSentences.length / 3 * 2);
        let orderedSentencesfirstPart = orderedSentences.slice(0, splitIndex);
        let orderedSentencessecondPart = orderedSentences.slice(splitIndex);

        const correctTitle = document.createElement('div');
        correctTitle.classList.add('item');
        correctTitle.textContent = selectedItem.title;
        titleField.appendChild(correctTitle);

        orderedSentencesfirstPart.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('item');
        itemDiv.textContent = item;
        answersField.appendChild(itemDiv);
        });

        if (controller.modeChoiceLtDifficulty === "C80" || controller.modeChoiceLtDifficulty === "C81" || controller.modeChoiceLtDifficulty === "C82") {
          orderedSentencessecondPart = [...orderedSentencessecondPart, ...distractorSentences]
        }

        shuffleArray(orderedSentencessecondPart).forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('item');
        itemDiv.textContent = item;
        optionsField.appendChild(itemDiv);
        });
      } else if (helpTracker >= 3) {
        answersField.innerHTML = 'Tekstas';
        titleField.innerHTML = 'Pavadinimas';
        optionsField.innerHTML = '';
  
        const correctTitle = document.createElement('div');
        correctTitle.classList.add('item');
        correctTitle.textContent = selectedItem.title;
        titleField.appendChild(correctTitle);

        orderedSentences.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('item');
        itemDiv.textContent = item;
        answersField.appendChild(itemDiv);
        });

        if (controller.modeChoiceLtDifficulty === "C80" || controller.modeChoiceLtDifficulty === "C81" || controller.modeChoiceLtDifficulty === "C82") {
        distractorSentences.forEach(item => {
          const itemDiv = document.createElement('div');
          itemDiv.classList.add('item');
          itemDiv.textContent = item;
          optionsField.appendChild(itemDiv);
        });
      }
      }
      } else if (controller.modeChoice2 === "C52") {
        if (helpTracker === 1) {
        answersFieldStart.innerHTML = 'Pradžia';
        answersFieldMiddle.innerHTML = 'Įvykio raida';
        answersFieldEnd.innerHTML = 'Pabaiga';
        titleField.innerHTML = 'Pavadinimas';
        optionsField.innerHTML = '';
  
        const correctTitle = document.createElement('div');
        correctTitle.classList.add('item');
        correctTitle.textContent = selectedItem.title;
        titleField.appendChild(correctTitle);

        selectedItem.text.start.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('item');
        itemDiv.textContent = item;
        answersFieldStart.appendChild(itemDiv);
        });

        let remainingText = [...selectedItem.text.middle, ...selectedItem.text.end]
        if (controller.modeChoiceLtDifficulty === "C80" || controller.modeChoiceLtDifficulty === "C81" || controller.modeChoiceLtDifficulty === "C82") {
          remainingText = [...remainingText, ...selectedItem.text.distractor]
        }

        shuffleArray(remainingText).forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('item');
        itemDiv.textContent = item;
        optionsField.appendChild(itemDiv);
        });
      } else if (helpTracker === 2) {
        answersFieldStart.innerHTML = 'Pradžia';
        answersFieldMiddle.innerHTML = 'Įvykio raida';
        answersFieldEnd.innerHTML = 'Pabaiga';
        titleField.innerHTML = 'Pavadinimas';
        optionsField.innerHTML = '';
  
        const splitIndex = Math.ceil(selectedItem.text.middle.length / 2);
        const middleOptionsFirstPart = selectedItem.text.middle.slice(0, splitIndex);
        const middleOptionsSecondPart = selectedItem.text.middle.slice(splitIndex);

        const correctTitle = document.createElement('div');
        correctTitle.classList.add('item');
        correctTitle.textContent = selectedItem.title;
        titleField.appendChild(correctTitle);

        selectedItem.text.start.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('item');
        itemDiv.textContent = item;
        answersFieldStart.appendChild(itemDiv);
        });

        middleOptionsFirstPart.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('item');
        itemDiv.textContent = item;
        answersFieldMiddle.appendChild(itemDiv);
        });

        let remainingText = [...middleOptionsSecondPart, ...selectedItem.text.end]
        if (controller.modeChoiceLtDifficulty === "C80" || controller.modeChoiceLtDifficulty === "C81" || controller.modeChoiceLtDifficulty === "C82") {
          remainingText = [...remainingText, ...selectedItem.text.distractor]
        }

        shuffleArray(remainingText).forEach(item => {
          const itemDiv = document.createElement('div');
          itemDiv.classList.add('item');
          itemDiv.textContent = item;
          optionsField.appendChild(itemDiv);
        });
      } else if (helpTracker >= 3) {
        answersFieldStart.innerHTML = 'Pradžia';
        answersFieldMiddle.innerHTML = 'Įvykio raida';
        answersFieldEnd.innerHTML = 'Pabaiga';
        titleField.innerHTML = 'Pavadinimas';
        optionsField.innerHTML = '';
  
        const correctTitle = document.createElement('div');
        correctTitle.classList.add('item');
        correctTitle.textContent = selectedItem.title;
        titleField.appendChild(correctTitle);

        selectedItem.text.start.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('item');
        itemDiv.textContent = item;
        answersFieldStart.appendChild(itemDiv);
        });

        selectedItem.text.middle.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('item');
        itemDiv.textContent = item;
        answersFieldMiddle.appendChild(itemDiv);
        });

        selectedItem.text.end.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('item');
        itemDiv.textContent = item;
        answersFieldEnd.appendChild(itemDiv);
        });

        if (controller.modeChoiceLtDifficulty === "C80" || controller.modeChoiceLtDifficulty === "C81" || controller.modeChoiceLtDifficulty === "C82") {
          shuffleArray(selectedItem.text.distractor).forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('item');
            itemDiv.textContent = item;
            optionsField.appendChild(itemDiv);
          });
        }
      }
      }
      
      resetHelpButton()
    });

    function initiateTheProgram() {
        clearInputFields()
        displayQuestion();

    if (!controller.questionsStopped) {
        if (controller.modeChoice4 === "C39") {
          countDown();
        } else if (controller.modeChoice4 === "C40") {
          startTimer();
        }
    } else {
	    if (controller.questionsStopped) {
        if (localStorage.getItem("elapsedTime") !== null) {
          timerDisplay.textContent = localStorage.getItem("elapsedTime");
        } else {
          timerDisplay.textContent = "00:00:00";
        }
      }
      formatFinalMessageForTextcomprehension();
    }

    if (controller.modeChoice4 === "C40") {
    questionNumberTracker.innerHTML = `Atlikta: ${controller.answeredQuestionTracker}/${controller.questionNumber}`;
    } else {
      questionNumberTracker.innerHTML = `Atlikta: ${controller.answeredQuestionTracker}`;
    }
    mistakesTracker.innerHTML = `Klaidos: ${controller.mistakesTracker}`;
    }

    function clearInputFields() {
      answersField.innerHTML = 'Tekstas';
      answersFieldStart.innerHTML = 'Pradžia';
      answersFieldMiddle.innerHTML = 'Įvykio raida';
      answersFieldEnd.innerHTML = 'Pabaiga';
      titleField.innerHTML = 'Pavadinimas';
      optionsField.innerHTML = '';
      nextQuestionBtn.style.display = 'none';
      checkAnswerBtn.style.display = "flex"
      helpBtn.disabled = true;
      checkAnswerBtn.disabled = false;
    }

    nextQuestionBtn.addEventListener('click', function () {
      helpTracker = 0;
      clearInputFields()
      if (controller.modeChoice4 === "C40") {
          if (controller.answeredQuestionTracker === controller.questionNumber) {
            controller.taskCompleted = true;
            localStorage.setItem("elapsedTime", timerDisplay.textContent);
            formatFinalMessageForTextcomprehension();
            controller.questionsStopped = true;
					  localStorage.setItem('controller', JSON.stringify(controller));
          } else {
            displayQuestion();
          }
			  } else {
           displayQuestion();
        }
    });

    const stopButtonElement = document.querySelector('.stop-button');
    let stopButtonSpanElement = document.querySelector('#stop-button-span');


    
    window.stopQuestionsCloseActions = function () {
      controller.questionsStopped = true;
      clearInterval(timerInterval);
      stopButtonSpanElement.innerHTML = "refresh";
      checkAnswerBtn.disabled = true;
      helpBtn.disabled = true;
      nextQuestionBtn.disabled = true;
      updateSortables()
      controller.questionsStopped = true;
      localStorage.setItem("elapsedTime", timerDisplay.textContent);
      localStorage.setItem('controller', JSON.stringify(controller));
      document.querySelector(".tracker-timer-holder").style.paddingLeft = "15px";
      initiateTheProgram() 
      document.querySelector(".help-and-check-button-holder").style.display = "none"
    }

    function stopQuestions() {
				if (stopButtonSpanElement.innerHTML === "close") {
          showCustomConfirm("Ar tikrai nori sustabdyti užduotį?", stopQuestionsCloseActions);
				} else if (stopButtonSpanElement.innerHTML === "refresh") {
          controller.questionsStopped = false;
					stopButtonSpanElement.innerHTML = "close";
          if (localStorage.getItem("startTime")) {
            localStorage.removeItem("startTime");
          };
          if (localStorage.getItem("remainingTime")) {
            localStorage.removeItem("remainingTime");
          };
          checkAnswerBtn.disabled = false;
          nextQuestionBtn.disabled = false;

          if (window.matchMedia("(max-width: 767px), (min-device-width: 768px) and (max-device-width: 1200px) and (orientation: portrait)").matches) {
            document.querySelector(".tracker-timer-holder").style.paddingLeft = "30px";
          } else {
            document.querySelector(".tracker-timer-holder").style.paddingLeft = "15px";
          }

          controller.randomSelection = [];
          helpTracker = 0;
          controller.mistakesTracker = 0;
					controller.answeredQuestionTracker = 0;
          controller.correctAnswersTracker = 0;
          firstTimeChecking = true;

          answeredTexts = [];
          mistakesSummary = {};

          if (controller.modeChoice4 === "C40") {
            questionNumberTracker.innerHTML = `Atlikta: ${controller.answeredQuestionTracker}/${controller.questionNumber}`;
          } else {
            questionNumberTracker.innerHTML = `Atlikta: ${controller.answeredQuestionTracker}`;
          }
          mistakesTracker.innerHTML = `Klaidos: ${controller.mistakesTracker}`;
          //helpDiv.innerHTML = `Panaudota pagalba: ${helpTracker}`;

          document.getElementById("fields-row").style.display = "flex";
          document.getElementById("final-message-row").style.display = "none";
          document.querySelector(".help-and-check-button-holder").style.display = "flex"

          controller.tempTracking = true;
          localStorage.setItem('controller', JSON.stringify(controller));
          initiateTheProgram();
				}
			}

      if (controller.questionsStopped) {
        stopButtonSpanElement.innerHTML === "close"
      }

      stopButtonElement.addEventListener("click", stopQuestions)

    initiateTheProgram();

    window.addEventListener("beforeunload", () => {
        if (!redirectingToAuthentication) {
          controller.task = null;
          controller.taskCompleted = false;
        }
        localStorage.setItem("controller", JSON.stringify(controller));
        localStorage.setItem("elapsedTime", timerDisplay.textContent);
        localStorage.setItem("elapsedTime", timerDisplay.textContent);
      });
    })
    .catch(error => console.error('Error:', error));





    // Sidebar functionality
const sidebarWrapper = document.getElementById('sidebarWrapper');
const toggleTab = document.getElementById('toggleTab');
const sidebarOverlay = document.getElementById('sidebarOverlay');

// Toggle sidebar function
function toggleSidebar() {
  sidebarWrapper.classList.toggle('open');
}

// Open sidebar function
function openSidebar() {
  sidebarWrapper.classList.add('open');
}

// Close sidebar function
function closeSidebar() {
    sidebarWrapper.classList.remove('open');
}

// Event listeners
if (toggleTab) {
    toggleTab.addEventListener('click', toggleSidebar);
}

// Close sidebar on window resize if it becomes desktop size
window.addEventListener('resize', () => {
    if (window.matchMedia("(max-width: 767px), (min-device-width: 768px) and (max-device-width: 1200px) and (orientation: portrait)").matches) {
      document.querySelector(".tracker-timer-holder").style.paddingLeft = "30px";
    } else {
      document.querySelector(".tracker-timer-holder").style.paddingLeft = "15px";
    }
    if (window.innerWidth > 768) {
        closeSidebar();
    }
});
// Simple vanilla JS drag and drop implementation
// No external dependencies needed!

let sortableInstances = [];
let isOverValidContainer = false;
let currentDraggedItem = null;
let draggedClone = null;
let touchHoldTimer = null;
let isDragging = false;
let startX = 0;
let startY = 0;
let currentX = 0;
let currentY = 0;
let offsetX = 0;
let offsetY = 0;

function initializeDragDrop() {
  // Clean up previous instances
  cleanupDragDrop();

  const containers = [
    'title-field',
    'answers-field',
    'answers-field-start',
    'answers-field-middle',
    'answers-field-end'
  ];

  // On desktop, also include options-field
  if (window.innerWidth > 768) {
    containers.push('options-field');
  }

  containers.forEach(containerId => {
    const container = document.getElementById(containerId);
    if (!container) return;

    makeContainerDroppable(container);
    
    // Make existing items draggable
    const items = container.querySelectorAll('.item');
    items.forEach(item => {
      makeDraggable(item);
    });
    
    // Watch for new items being added
    observeContainer(container);
  });
}

// MutationObserver to watch for dynamically added items
function observeContainer(container) {
  // First, make any existing items draggable
  const existingItems = container.querySelectorAll('.item');
  existingItems.forEach(item => {
    if (!item.dataset.draggableInitialized) {
      makeDraggable(item);
      item.dataset.draggableInitialized = 'true';
    }
  });
  
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      mutation.addedNodes.forEach((node) => {
        if (node.nodeType === 1 && node.classList.contains('item')) {
          if (!node.dataset.draggableInitialized) {
            makeDraggable(node);
            node.dataset.draggableInitialized = 'true';
          }
        }
      });
    });
  });
  
  observer.observe(container, {
    childList: true,
    subtree: false
  });
  
  // Store observer for cleanup
  if (!window.dragDropObservers) {
    window.dragDropObservers = [];
  }
  window.dragDropObservers.push(observer);
}

function makeDraggable(element) {
  // Skip if already initialized
  if (element.dataset.draggableInitialized === 'true') {
    return;
  }
  
  // Remove any existing listeners first to prevent duplicates
  element.removeEventListener('mousedown', handleDragStart);
  element.removeEventListener('touchstart', handleTouchStart);
  
  // Always add mouse events for desktop/laptop
  element.addEventListener('mousedown', handleDragStart);
  
  // Also add touch events for touch-capable devices
  element.addEventListener('touchstart', handleTouchStart, { passive: false });
  
  element.style.cursor = 'grab';
  if (!element.classList.contains('item')) {
    element.classList.add('item');
  }
  
  // Mark as initialized
  element.dataset.draggableInitialized = 'true';
}

function handleTouchStart(e) {
  const element = e.currentTarget;
  const touch = e.touches[0];
  
  startX = touch.clientX;
  startY = touch.clientY;
  
  // Visual feedback
  element.classList.add('hold-indicator');
  
  // Prevent any scrolling during hold
  let holdStarted = false;
  
  // 300ms hold delay for touch devices
  touchHoldTimer = setTimeout(() => {
    holdStarted = true;
    e.preventDefault(); // Prevent scrolling once hold is confirmed
    startDrag(element, touch.clientX, touch.clientY);
    
    // Add touch move and end listeners
    document.addEventListener('touchmove', handleTouchMove, { passive: false });
    document.addEventListener('touchend', handleTouchEnd);
    document.addEventListener('touchcancel', handleTouchEnd);
  }, 300);
  
  // Cancel if touch moves too much during hold
  const cancelHold = (cancelEvent) => {
    if (!cancelEvent.touches || cancelEvent.touches.length === 0) {
      clearTimeout(touchHoldTimer);
      element.classList.remove('hold-indicator');
      document.removeEventListener('touchmove', cancelHold);
      return;
    }
    
    const touch = cancelEvent.touches[0];
    const moveThreshold = 10;
    
    if (Math.abs(touch.clientX - startX) > moveThreshold || 
        Math.abs(touch.clientY - startY) > moveThreshold) {
      if (!holdStarted) {
        clearTimeout(touchHoldTimer);
        element.classList.remove('hold-indicator');
        document.removeEventListener('touchmove', cancelHold);
      }
    }
  };
  
  document.addEventListener('touchmove', cancelHold, { passive: true });
  
  setTimeout(() => {
    document.removeEventListener('touchmove', cancelHold);
  }, 320);
}

function handleTouchMove(e) {
  if (!isDragging) return;
  
  e.preventDefault();
  const touch = e.touches[0];
  updateDragPosition(touch.clientX, touch.clientY);
}

function handleTouchEnd(e) {
  clearTimeout(touchHoldTimer);
  document.removeEventListener('touchmove', handleTouchMove);
  document.removeEventListener('touchend', handleTouchEnd);
  document.removeEventListener('touchcancel', handleTouchEnd);
  
  if (isDragging) {
    endDrag();
  }
  
  if (currentDraggedItem) {
    currentDraggedItem.classList.remove('hold-indicator');
  }
}

function handleDragStart(e) {
  if (e.button !== 0) return; // Only left mouse button
  
  e.preventDefault();
  const element = e.currentTarget;
  
  startDrag(element, e.clientX, e.clientY);
  
  document.addEventListener('mousemove', handleMouseMove);
  document.addEventListener('mouseup', handleMouseUp);
}

function handleMouseMove(e) {
  if (!isDragging) return;
  updateDragPosition(e.clientX, e.clientY);
}

function handleMouseUp(e) {
  document.removeEventListener('mousemove', handleMouseMove);
  document.removeEventListener('mouseup', handleMouseUp);
  
  if (isDragging) {
    endDrag();
  }
}

function startDrag(element, clientX, clientY) {
  currentDraggedItem = element;
  isDragging = true;
  isOverValidContainer = true;
  
  // Reset background color when drag starts
  element.style.backgroundColor = '';
  
  // Prevent body scrolling during drag
  document.body.style.overflow = 'hidden';
  document.body.style.touchAction = 'none';
  
  // Close sidebar when drag starts
  if (typeof sidebarWrapper !== 'undefined' && sidebarWrapper.classList.contains('open')) {
    if (typeof closeSidebar === 'function') {
      closeSidebar();
    }
  }
  
  // Get element position
  const rect = element.getBoundingClientRect();
  offsetX = clientX - rect.left;
  offsetY = clientY - rect.top;
  
  // Create clone for dragging
  draggedClone = element.cloneNode(true);
  draggedClone.classList.add('dragging-clone');
  draggedClone.style.position = 'fixed';
  draggedClone.style.width = rect.width + 'px';
  draggedClone.style.height = rect.height + 'px';
  draggedClone.style.zIndex = '9999';
  draggedClone.style.pointerEvents = 'none';
  draggedClone.style.opacity = '0.9';
  draggedClone.style.cursor = 'grabbing';
  draggedClone.style.touchAction = 'none';
  document.body.appendChild(draggedClone);
  
  // Make original semi-transparent
  element.style.opacity = '0.3';
  
  updateDragPosition(clientX, clientY);
}

function updateDragPosition(clientX, clientY) {
  if (!draggedClone) return;
  
  currentX = clientX - offsetX;
  currentY = clientY - offsetY;
  
  draggedClone.style.left = currentX + 'px';
  draggedClone.style.top = currentY + 'px';
  
  // Check what's under the cursor
  draggedClone.style.pointerEvents = 'none';
  const elementBelow = document.elementFromPoint(clientX, clientY);
  draggedClone.style.pointerEvents = 'none';
  
  checkDropTarget(elementBelow, clientX, clientY);
}

function checkDropTarget(element, clientX, clientY) {
  const validContainers = [
    'title-field',
    'answers-field',
    'answers-field-start',
    'answers-field-middle',
    'answers-field-end',
    'options-field'
  ];
  
  isOverValidContainer = false;
  
  // Traverse up to find valid container
  let current = element;
  while (current && current !== document.body) {
    if (validContainers.includes(current.id)) {
      isOverValidContainer = true;
      
      // Find insertion point
      const container = current;
      const items = Array.from(container.children).filter(child => 
        child.classList.contains('item') && child !== currentDraggedItem
      );
      
      let insertBefore = null;
      for (let item of items) {
        const rect = item.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        
        if (clientY < midY) {
          insertBefore = item;
          break;
        }
      }
      
      if (insertBefore) {
        container.insertBefore(currentDraggedItem, insertBefore);
      } else {
        container.appendChild(currentDraggedItem);
      }
      
      break;
    }
    current = current.parentElement;
  }
}

function endDrag() {
  if (!currentDraggedItem) return;
  
  // Re-enable body scrolling
  document.body.style.overflow = '';
  document.body.style.touchAction = '';
  
  // Remove clone
  if (draggedClone && draggedClone.parentNode) {
    draggedClone.remove();
  }
  draggedClone = null;
  
  // Restore original opacity
  currentDraggedItem.style.opacity = '';
  currentDraggedItem.classList.remove('hold-indicator');
  
  // If not over valid container, return to options-field
  if (!isOverValidContainer) {
    const optionsField = document.getElementById('options-field');
    if (optionsField) {
      optionsField.appendChild(currentDraggedItem);
    }
  }
  
  isDragging = false;
  currentDraggedItem = null;
  isOverValidContainer = false;
}

function makeContainerDroppable(container) {
  container.classList.add('drop-container');
}

function cleanupDragDrop() {
  document.removeEventListener('mousemove', handleMouseMove);
  document.removeEventListener('mouseup', handleMouseUp);
  document.removeEventListener('touchmove', handleTouchMove);
  document.removeEventListener('touchend', handleTouchEnd);
  clearTimeout(touchHoldTimer);
  
  if (draggedClone && draggedClone.parentNode) {
    draggedClone.remove();
  }
  
  // Disconnect all observers
  if (window.dragDropObservers) {
    window.dragDropObservers.forEach(observer => observer.disconnect());
    window.dragDropObservers = [];
  }
  
  isDragging = false;
  currentDraggedItem = null;
  draggedClone = null;
}

function initializeOptionsFieldDragDrop() {
  const optionsField = document.getElementById('options-field');
  if (!optionsField) return;
  
  makeContainerDroppable(optionsField);
  
  const items = optionsField.querySelectorAll('.item');
  items.forEach(item => {
    makeDraggable(item);
  });
  
  // Watch for new items
  observeContainer(optionsField);
}

function isTouchDevice() {
  return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
}

function updateDragDropInstances() {
  initializeDragDrop();
  
  const touchDevice = isTouchDevice();
  
  if (window.innerWidth <= 768 && touchDevice) {
    initializeOptionsFieldDragDrop();
  } else {
    const optionsField = document.getElementById('options-field');
    if (optionsField) {
      makeContainerDroppable(optionsField);
      const items = optionsField.querySelectorAll('.item');
      items.forEach(item => {
        makeDraggable(item);
      });
      observeContainer(optionsField);
    }
  }
}

// Alias for backward compatibility
function updateSortables() {
  updateDragDropInstances();
}

// Function to manually reinitialize all items (useful after dynamic content loads)
function reinitializeAllItems() {
  const allContainers = [
    'title-field',
    'answers-field',
    'answers-field-start',
    'answers-field-middle',
    'answers-field-end',
    'options-field'
  ];
  
  allContainers.forEach(containerId => {
    const container = document.getElementById(containerId);
    if (container) {
      const items = container.querySelectorAll('.item');
      items.forEach(item => {
        // Reset initialization flag
        delete item.dataset.draggableInitialized;
        makeDraggable(item);
      });
    }
  });
}

// Initialize on load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', updateDragDropInstances);
} else {
  updateDragDropInstances();
}

// Also try initializing after a short delay to catch any dynamically loaded content
setTimeout(() => {
  reinitializeAllItems();
}, 500);

window.addEventListener('resize', updateDragDropInstances);

// Clean up on page unload
window.addEventListener('beforeunload', cleanupDragDrop);

  </script>

</body>
</html>
